<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comprehensive Inventory Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <!-- Chart.js for dashboard -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            font-size: 16px;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .sidebar-link.active {
            background-color: #4f46e5;
            color: white;
        }

        .sidebar-link.active svg {
            color: white;
        }

        .modal {
            display: none;
        }

        .modal.flex {
            display: flex;
        }

        .tab-button.active {
            border-color: #4f46e5;
            color: #4f46e5;
        }

        /* Custom styling for note icon */
        .note-icon {
            cursor: pointer;
            color: #6B7280;
            /* Default gray */
            margin-left: 4px;
            vertical-align: middle;
        }

        .note-icon.has-notes {
            color: #3B82F6;
            /* Blue if notes exist */
        }

        /* Toast Notification */
        #toast-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px 40px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            z-index: 10000;
            display: none;
            min-width: 300px;
            text-align: center;
            animation: slideIn 0.3s ease;
        }

        #toast-notification.show {
            display: block;
        }

        @keyframes slideIn {
            from {
                transform: translate(-50%, -60%);
                opacity: 0;
            }

            to {
                transform: translate(-50%, -50%);
                opacity: 1;
            }
        }

        /* ROLE BASED ACCESS CONTROL */
        /* By default, everything is visible. We hide based on restriction classes. */

        /* Viewer Role Restrictions */
        body[data-role="viewer"] .role-admin,
        body[data-role="viewer"] .role-store,
        body[data-role="viewer"] .role-production,
        body[data-role="viewer"] button:not(.sidebar-link):not([onclick^="closeModal"]):not([onclick^="openModal"]):not([onclick^="showView"]):not([onclick="loginAs('viewer')"]):not([onclick="loginAs('store')"]):not([onclick="loginAs('production')"]):not([onclick="loginAs('admin')"]):not([onclick^="export"]):not(.tab-button):not(.expiry-tab-button):not(.always-visible) {
            display: none !important;
        }

        /* Specific override for modal close buttons or navigation if needed, but the :not above handles most */
        body[data-role="viewer"] .always-visible {
            display: inline-block !important;
            /* Force show specific buttons like export/nav */
        }

        /* Store Role Restrictions */
        body[data-role="store"] .role-admin {
            /* Store cannot do admin tasks (delete items, manage users) */
            display: none !important;
        }

        body[data-role="store"] .role-production {
            /* Store cannot do production planning */
            display: none !important;
        }

        /* Production Role Restrictions */
        body[data-role="production"] .role-admin {
            display: none !important;
        }

        /* Production has access to store functions implicitly usually, or explicitly granted */
    </style>
</head>

<script>
    // CRITICAL: Modal utilities must be defined BEFORE any HTML elements use them
    window.openModal = function (modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        } else {
            console.error('Modal not found:', modalId);
        }
    };

    window.closeModal = function (modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }
    };

    // Login as different role
    window.loginAs = function (role) {
        document.body.setAttribute('data-role', role);
        localStorage.setItem('app-role', role);
        closeModal('loginModal');
        if (typeof showAlert === 'function') {
            showAlert('Logged in as ' + role.charAt(0).toUpperCase() + role.slice(1));
        }
        // Refresh views if available
        if (typeof renderCurrentView === 'function') {
            renderCurrentView();
        }
    };
</script>

<body class="bg-gray-100">
    <!-- Restored Default Data Backup (Consolidated below in script section) -->
    <div id="toast-notification"></div>
    <div class="flex h-screen">
        <aside class="w-64 bg-gray-800 text-white sidebar">
            <div class="flex flex-col min-h-0 flex-grow">
                <div class="p-4 border-b border-gray-700">
                    <h1 class="text-xl font-bold">MIKLENS INVENTORY</h1>
                    <span class="text-sm text-gray-400">MANAGEMENT</span>
                </div>
                <nav class="flex-grow overflow-y-auto">
                    <a href="#" data-view="dashboard" class="sidebar-link flex items-center p-4 hover:bg-gray-700">
                        <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 2 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6">
                            </path>
                        </svg>
                        Dashboard
                    </a>
                    <a href="#" data-view="alerts" class="sidebar-link flex items-center p-4 hover:bg-gray-700">
                        <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9">
                            </path>
                        </svg>
                        <span class="flex-1">Alerts</span>
                        <span id="alert-badge"
                            class="ml-auto bg-red-600 text-white px-2 py-1 rounded-full text-xs font-bold hidden">0</span>
                    </a>
                    <a href="#" data-view="raw-materials" class="sidebar-link flex items-center p-4 hover:bg-gray-700">
                        <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                        </svg>
                        Raw Materials
                    </a>
                    <a href="#" data-view="packing-materials"
                        class="sidebar-link flex items-center p-4 hover:bg-gray-700">
                        <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 6a2 2 0 012-2h12a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V6z"></path>
                        </svg>
                        Packing Materials
                    </a>
                    <a href="#" data-view="labels" class="sidebar-link flex items-center p-4 hover:bg-gray-700">
                        <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A2 2 0 013 8v-5z">
                            </path>
                        </svg>
                        Labels
                    </a>
                    <a href="#" data-view="finished-goods" class="sidebar-link flex items-center p-4 hover:bg-gray-700">
                        <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4">
                            </path>
                        </svg>
                        Finished Goods
                    </a>
                    <a href="#" data-view="expiry-tracking"
                        class="sidebar-link flex items-center p-4 hover:bg-gray-700">
                        <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z">
                            </path>
                        </svg>
                        Expiry Tracking
                    </a>

                    <div class="my-2 border-t border-gray-700 mx-4"></div>
                    <div class="px-4 py-2 text-xs font-semibold text-gray-500 uppercase tracking-wider">Commercial</div>

                    <a href="#" data-view="suppliers" class="sidebar-link flex items-center p-4 hover:bg-gray-700">
                        <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4">
                            </path>
                        </svg>
                        Suppliers
                    </a>
                    <a href="#" data-view="customers" class="sidebar-link flex items-center p-4 hover:bg-gray-700">
                        <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z">
                            </path>
                        </svg>
                        Customers
                    </a>
                    <a href="#" data-view="sales-dispatch" class="sidebar-link flex items-center p-4 hover:bg-gray-700">
                        <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                            </path>
                        </svg>
                        Sales & Dispatch
                    </a>
                    <a href="#" data-view="requisition" class="sidebar-link flex items-center p-4 hover:bg-gray-700">
                        <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                            </path>
                        </svg>
                        Material Requisition
                    </a>
                    <div class="my-2 border-t border-gray-700 mx-4"></div>
                    <a href="#" data-view="reorder-assistant"
                        class="sidebar-link flex items-center p-4 hover:bg-gray-700">
                        <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01">
                            </path>
                        </svg>
                        Reorder Assistant
                    </a>
                    <a href="#" data-view="stock-take" class="sidebar-link flex items-center p-4 hover:bg-gray-700">
                        <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 14l6-6m-6 6l-6-6m6 6v6m0-6V8m0 6h6m-6 0H8m6 0h6"></path>
                        </svg>
                        Stock-Take
                    </a>
                    <a href="#" data-view="formulations" class="sidebar-link flex items-center p-4 hover:bg-gray-700">
                        <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547a2 2 0 00-.547 1.806l.477 2.387a6 6 0 00.517 3.86l.158.318a6 6 0 003.86.517l2.387.477a2 2 0 001.806-.547a2 2 0 00.547-1.806l-.477-2.387a6 6 0 00-.517-3.86l-.158-.318a6 6 0 01-.517-3.86l2.387-.477a2 2 0 001.022-.547z">
                            </path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 8a2.5 2.5 0 110-5 2.5 2.5 0 010 5z"></path>
                        </svg>
                        Formulation
                    </a>
                    <a href="#" data-view="production-wip" class="sidebar-link flex items-center p-4 hover:bg-gray-700">
                        <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547a2 2 0 00-.547 1.806l.477 2.387a6 6 0 00.517 3.86l.158.318a6 6 0 003.86.517l2.387.477a2 2 0 001.806-.547a2 2 0 00.547-1.806l-.477-2.387a6 6 0 00-.517-3.86l-.158-.318a6 6 0 01-.517-3.86l2.387-.477a2 2 0 001.022-.547z">
                            </path>
                        </svg>
                        Orders / Production (WIP)
                    </a>
                    <a href="#" data-view="daily-report" class="sidebar-link flex items-center p-4 hover:bg-gray-700">
                        <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z">
                            </path>
                        </svg>
                        Reports
                    </a>
                    <a href="#" data-view="stock-aging" class="sidebar-link flex items-center p-4 hover:bg-gray-700">
                        <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        ⏳ Stock Aging
                    </a>
                    <a href="#" onclick="openModal('dataManagementModal')"
                        class="sidebar-link flex items-center p-4 hover:bg-gray-700">
                        <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4">
                            </path>
                        </svg>
                        Data Management
                    </a>
                    <a href="#" data-view="calculator" class="sidebar-link flex items-center p-4 hover:bg-gray-700">
                        <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z">
                            </path>
                        </svg>
                        Cost Calculator
                    </a>

                    <a href="#" onclick="openModal('cloudSettingsModal')"
                        class="sidebar-link flex items-center p-4 hover:bg-gray-700 text-yellow-400">
                        <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z">
                            </path>
                        </svg>
                        Cloud Settings
                    </a>
                </nav>
            </div>
            <div class="p-4 border-t border-gray-700">
                <div id="sync-status" class="text-xs text-gray-400 mb-2 flex items-center justify-between">
                    <div class="flex items-center">
                        <span class="w-2 h-2 rounded-full bg-gray-500 mr-2" id="sync-indicator"></span>
                        <span id="sync-text">Offline Mode</span>
                    </div>
                    <button onclick="refreshFromCloud()" class="text-blue-400 hover:text-blue-300"
                        title="Refresh from cloud">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                            </path>
                        </svg>
                    </button>
                </div>
                <div class="flex items-center justify-between mb-2">
                    <label class="text-xs text-gray-400 flex items-center cursor-pointer">
                        <input type="checkbox" id="auto-sync-toggle" class="mr-2"
                            onclick="return checkPermission('admin') ? true : false">
                        Auto-Sync
                    </label>
                    <button onclick="if(checkPermission('admin')) manualSync()" id="manual-sync-btn"
                        class="text-xs px-2 py-1 bg-blue-600 text-white rounded">Sync Now</button>
                </div>
                <div class="flex items-center justify-between mb-2">
                    <label class="text-xs text-gray-400 flex items-center cursor-pointer">
                        <input type="checkbox" id="auto-refresh-toggle" class="mr-2">
                        Auto-Refresh (30s)
                    </label>
                </div>
                <div class="text-center text-xs text-gray-400">Developer: Pavan.R</div>
                <div class="mt-4 pt-4 border-t border-gray-700 flex justify-between items-center">
                    <div class="flex flex-col">
                        <span id="current-user-role" class="text-xs font-bold text-yellow-400 uppercase">VIEWER</span>
                        <span id="current-user-name" class="text-xs text-gray-400">Guest</span>
                    </div>
                    <button onclick="openModal('loginModal')"
                        class="text-xs bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded">Switch User</button>
                </div>
            </div>
        </aside>

        <div class="flex-1 flex flex-col overflow-hidden">
            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100">
                <div id="views-container" class="p-8">
                    <div id="dashboard-view" class="view"></div>
                    <div id="alerts-view" class="view"></div>
                    <div id="raw-materials-view" class="view"></div>
                    <div id="packing-materials-view" class="view"></div>
                    <div id="labels-view" class="view"></div>
                    <div id="finished-goods-view" class="view"></div>
                    <div id="expiry-tracking-view" class="view"></div>
                    <div id="reorder-assistant-view" class="view"></div>
                    <div id="stock-take-view" class="view"></div>
                    <div id="daily-report-view" class="view"></div>
                    <div id="monthly-report-view" class="view"></div>
                    <div id="formulations-view" class="view"></div>
                    <div id="production-wip-view" class="view"></div>
                    <div id="suppliers-view" class="view"></div>
                    <div id="customers-view" class="view"></div>
                    <div id="sales-dispatch-view" class="view"></div>

                    <div id="data-management-view" class="view"></div>
                    <div id="calculator-view" class="view"></div>

                    <div id="product-trace-view" class="view"></div>
                    <div id="stock-aging-view" class="view"></div>
                    <div id="requisition-view" class="view"></div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modals -->
    <div id="addItemModal" class="modal fixed inset-0 bg-black bg-opacity-50 justify-center items-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 id="item-modal-title" class="text-xl font-bold">Add New Item</h3>
                <button onclick="closeModal('addItemModal')" class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <form id="item-form">
                <input type="hidden" id="edit-item-id">
                <input type="hidden" id="edit-item-category-field">
                <div class="mb-4">
                    <label for="item-category" class="block text-sm font-medium">Category</label>
                    <select id="item-category" class="w-full p-2 border rounded-md">
                        <option value="rawMaterials">Raw Materials</option>
                        <option value="packingMaterials">Packing Materials</option>
                        <option value="labels">Labels</option>
                        <option value="finishedGoods">Finished Goods</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label for="item-name" class="block text-sm font-medium">Item Name</label>
                    <input type="text" id="item-name" class="w-full p-2 border rounded-md">
                </div>
                <div class="mb-4">
                    <label for="item-unit" class="block text-sm font-medium">Unit</label>
                    <input type="text" id="item-unit" class="w-full p-2 border rounded-md">
                </div>
                <div class="mb-4">
                    <label for="item-price" class="block text-sm font-medium">Price/Unit</label>
                    <input type="number" id="item-price" step="0.01" class="w-full p-2 border rounded-md">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="mb-4">
                        <label for="item-stock" class="block text-sm font-medium">Opening Stock</label>
                        <input type="number" id="item-stock" step="0.001" class="w-full p-2 border rounded-md">
                    </div>
                    <div class="mb-4">
                        <label for="item-stock-date" class="block text-sm font-medium">As of Date</label>
                        <input type="date" id="item-stock-date" class="w-full p-2 border rounded-md">
                    </div>
                </div>
                <div id="expiry-date-container" class="mb-4 hidden">
                    <label for="item-expiry-date" class="block text-sm font-medium">Expiry Date</label>
                    <input type="date" id="item-expiry-date" class="w-full p-2 border rounded-md">
                </div>
                <!-- New: Minimum Stock Level for Reorder Assistant -->
                <div class="mb-4">
                    <label for="item-min-stock-level" class="block text-sm font-medium">Minimum Stock Level</label>
                    <input type="number" id="item-min-stock-level" step="0.001" class="w-full p-2 border rounded-md"
                        value="0">
                </div>
                <div class="flex justify-between items-center">
                    <button type="button" id="delete-item-btn"
                        class="px-4 py-2 bg-red-600 text-white rounded-lg hidden">Delete Item</button>
                    <div class="flex justify-end gap-4 flex-grow">
                        <button type="button" onclick="closeModal('addItemModal')"
                            class="px-4 py-2 bg-gray-300 rounded-lg">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg">Save Item</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div id="stockTxModal" class="modal fixed inset-0 bg-black bg-opacity-50 justify-center items-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 id="stock-tx-modal-title" class="text-xl font-bold">Update Stock</h3>
                <button onclick="closeModal('stockTxModal')" class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <form id="stock-tx-form">
                <input type="hidden" id="tx-item-id">
                <input type="hidden" id="tx-item-category">
                <input type="hidden" id="tx-type">

                <!-- Subtype selection for Consume -->
                <div id="tx-subtype-container" class="mb-4 hidden">
                    <label class="block text-sm font-medium text-red-600">Consumption Reason</label>
                    <select id="tx-subtype" class="w-full p-2 border rounded-md border-red-300 bg-red-50">
                        <option value="regular">Regular Production/Consumption</option>
                        <option value="process_loss">Process Loss</option>
                        <option value="spillage">Spillage/Wastage</option>
                        <option value="expired">Expired/Destruction</option>
                        <option value="qc_rejection">QC Rejection</option>
                        <option value="cleaning">Cleaning/Maintenance</option>
                    </select>
                </div>

                <p class="mb-2 text-sm">Item: <span id="tx-item-name" class="font-semibold"></span></p>
                <div class="mb-4">
                    <label class="block text-sm font-medium">Date of Movement</label>
                    <input type="date" id="tx-date" class="w-full p-2 border rounded-md">
                </div>
                <div id="purchase-price-field" class="mb-4 hidden">
                    <label class="block text-sm font-medium">Purchase Price per Unit</label>
                    <input type="number" id="tx-purchase-price" step="0.01" class="w-full p-2 border rounded-md"
                        placeholder="Enter actual purchase price">
                    <p class="text-xs text-gray-500 mt-1">Leave blank to use standard price: <span
                            id="standard-price-display"></span></p>
                </div>

                <!-- ERP FIELDS: RECEIVE -->
                <div id="erp-receive-fields"
                    class="hidden border-l-4 border-green-500 pl-4 mb-4 bg-green-50 p-2 rounded">
                    <h4 class="font-bold text-sm text-green-800 mb-2">Purchase Details (Optional)</h4>
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <div>
                            <label class="block text-xs font-medium">Supplier</label>
                            <div class="flex gap-1">
                                <select id="tx-supplier" class="w-full p-1 border rounded text-sm"></select>
                                <button type="button" onclick="openSupplierModal()"
                                    class="bg-green-600 text-white px-2 rounded font-bold"
                                    title="Add New Supplier">+</button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-medium">PO Number</label>
                            <input type="text" id="tx-po-no" class="w-full p-1 border rounded text-sm">
                        </div>
                    </div>
                    <div class="mb-2">
                        <label class="block text-xs font-medium">Invoice Number</label>
                        <input type="text" id="tx-invoice-no" class="w-full p-1 border rounded text-sm">
                    </div>
                    <div class="mb-2">
                        <label class="block text-xs font-medium">Batch Number</label>
                        <input type="text" id="tx-batch-no" class="w-full p-1 border rounded text-sm font-mono">
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-xs font-medium">Mfg Date</label>
                            <input type="date" id="tx-mfg-date" class="w-full p-1 border rounded text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-medium">Exp Date</label>
                            <input type="date" id="tx-exp-date" class="w-full p-1 border rounded text-sm">
                        </div>
                    </div>
                </div>

                <!-- ERP FIELDS: CONSUME -->
                <div id="erp-consume-fields" class="hidden border-l-4 border-red-500 pl-4 mb-4 bg-red-50 p-2 rounded">
                    <h4 class="font-bold text-sm text-red-800 mb-2">Batch Selection (Optional)</h4>
                    <label class="block text-xs font-medium">Select Batch to Consume From</label>
                    <select id="tx-consume-batch" class="w-full p-1 border rounded text-sm mb-2">
                        <option value="">FIFO / Unspecified</option>
                    </select>
                    <p class="text-xs text-gray-500">If unspecified, system consumes based on FIFO.</p>
                </div>
                <div id="consumption-calculator" class="hidden">
                    <label class="block text-sm font-medium">Add Individual Consumption Entries</label>
                    <div class="flex gap-2">
                        <input type="number" id="consumption-input" class="w-full p-2 border rounded-md"
                            placeholder="Enter quantity">
                        <button type="button" id="add-consumption-btn"
                            class="px-4 bg-blue-500 text-white rounded-md">Add</button>
                    </div>
                    <div id="consumption-list" class="mt-2 text-sm max-h-24 overflow-y-auto border p-2 rounded-md">
                    </div>
                    <button type="button" id="clear-consumption-btn" class="text-xs text-red-500 mt-1">Clear
                        Entries</button>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium">Total Quantity</label>
                    <input type="number" id="tx-quantity" step="0.001" class="w-full p-2 border rounded-md bg-gray-100">
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" onclick="closeModal('stockTxModal')"
                        class="px-4 py-2 bg-gray-300 rounded-lg">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-lg">Record</button>
                </div>
            </form>
        </div>
    </div>

    <div id="editTxModal" class="modal fixed inset-0 bg-black bg-opacity-50 justify-center items-center z-[60]">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Edit Transaction</h3>
                <button onclick="closeModal('editTxModal')" class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <form id="edit-tx-form">
                <input type="hidden" id="edit-tx-id">
                <div class="mb-4">
                    <label class="block text-sm font-medium">Item</label>
                    <select id="edit-tx-item" class="w-full p-2 border rounded-md"></select>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium">Quantity (enter 0 to delete)</label>
                    <input type="number" id="edit-tx-quantity" step="0.001" class="w-full p-2 border rounded-md">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium">Date</label>
                    <input type="date" id="edit-tx-date" class="w-full p-2 border rounded-md">
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" onclick="closeModal('editTxModal')"
                        class="px-4 py-2 bg-gray-300 rounded-lg">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- dataManagementModal defined below in proper section -->

    <div id="formulaModal"
        class="modal fixed inset-0 bg-black bg-opacity-50 justify-center items-center z-50 overflow-y-auto py-10">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-3xl">
            <div class="flex justify-between items-center mb-4">
                <h3 id="formula-modal-title" class="text-xl font-bold">Add New Product Formula</h3>
                <button onclick="closeModal('formulaModal')" class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <form id="formula-form" class="space-y-4">
                <input type="hidden" id="edit-formula-id">
                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium">Product Name</label>
                        <input type="text" id="formula-name" class="mt-1 w-full p-2 border rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Output Quantity</label>
                        <input type="number" id="formula-output-qty" step="any"
                            class="mt-1 w-full p-2 border rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Output Unit</label>
                        <input type="text" id="formula-output-unit" class="mt-1 w-full p-2 border rounded-md">
                    </div>
                </div>
                <div id="ingredients-container">
                    <h4 class="font-medium text-gray-800 mt-4">Raw Materials</h4>
                </div>
                <button type="button" onclick="addIngredientInput()" class="text-sm text-blue-600 hover:text-blue-800">+
                    Add Ingredient</button>

                <div id="packing-container">
                    <h4 class="font-medium text-gray-800 mt-4">Packing Materials</h4>
                </div>
                <button type="button" onclick="addPackingInput()" class="text-sm text-blue-600 hover:text-blue-800">+
                    Add Packing Material</button>

                <div id="labels-container">
                    <h4 class="font-medium text-gray-800 mt-4">Labels</h4>
                </div>
                <button type="button" onclick="addLabelInput()" class="text-sm text-blue-600 hover:text-blue-800">+
                    Add Label</button>

                <div class="flex justify-end gap-4 pt-4">
                    <button type="button" onclick="closeModal('formulaModal')"
                        class="px-4 py-2 bg-gray-300 rounded-lg">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg">Save Formula</button>
                </div>
            </form>
        </div>
    </div>

    <div id="productionNeedsModal"
        class="modal fixed inset-0 bg-black bg-opacity-50 justify-center items-center z-50 overflow-y-auto py-10">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-4xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Production Material Needs</h3>
                <button onclick="closeModal('productionNeedsModal')"
                    class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div id="production-needs-content"></div>
            <div class="flex justify-end gap-4 mt-6">
                <button type="button" onclick="closeModal('productionNeedsModal')"
                    class="px-4 py-2 bg-gray-300 rounded-lg">Close</button>
                <button id="execute-production-btn" class="px-4 py-2 bg-green-600 text-white rounded-lg">Execute
                    Production</button>
                <button id="export-pdf-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg">Export to PDF</button>
            </div>
        </div>
    </div>

    <!-- COMPLETE BATCH MODAL -->
    <div id="completeBatchModal" class="modal fixed inset-0 bg-black bg-opacity-50 justify-center items-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 id="comp-batch-title" class="text-xl font-bold text-green-700">Complete Production</h3>
                <button onclick="closeModal('completeBatchModal')"
                    class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>

            <div class="bg-green-50 p-4 rounded-lg mb-4">
                <p class="text-sm text-gray-600">Product:</p>
                <p id="comp-prod-name" class="text-lg font-bold text-green-800">-</p>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Target Quantity</label>
                    <input type="number" id="comp-target-qty" class="w-full p-2 border rounded bg-gray-100" readonly>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Actual Produced Qty*</label>
                    <input type="number" id="comp-actual-qty" step="0.001"
                        class="w-full p-2 border rounded border-green-400 bg-green-50" required>
                </div>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Expiry Date (Optional)</label>
                <input type="date" id="comp-expiry-date" class="w-full p-2 border rounded">
            </div>

            <div class="mb-4">
                <h4 class="font-bold text-gray-700 mb-2">Ingredient Consumption</h4>
                <p class="text-xs text-gray-500 mb-2">Adjust actual consumed quantities if different from reserved. Add
                    wastage if applicable.</p>
                <table class="w-full text-sm border">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="p-2 text-left">Material</th>
                            <th class="p-2 text-right">Reserved</th>
                            <th class="p-2 text-right">Actual Used</th>
                            <th class="p-2 text-right">Wastage</th>
                        </tr>
                    </thead>
                    <tbody id="comp-ing-rows">
                        <!-- Rows added dynamically -->
                    </tbody>
                </table>
            </div>

            <div class="flex justify-end gap-4 mt-6">
                <button onclick="closeModal('completeBatchModal')"
                    class="px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">Cancel</button>
                <button onclick="confirmCompleteBatch()"
                    class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-bold">✅ Confirm
                    Completion</button>
            </div>
        </div>
    </div>

    <div id="passwordModal" class="modal fixed inset-0 bg-black bg-opacity-50 justify-center items-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold mb-4">Enter Password</h3>
                <button onclick="closeModal('passwordModal')" class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <form id="password-form">
                <div class="mb-4">
                    <label for="password-input" class="block text-sm font-medium">Password</label>
                    <input type="password" id="password-input" class="w-full p-2 border rounded-md">
                </div>
                <p id="password-error" class="text-red-500 text-sm mb-4 hidden">Incorrect password.</p>
                <div class="flex justify-end gap-4">
                    <button type="button" onclick="closeModal('passwordModal')"
                        class="px-4 py-2 bg-gray-300 rounded-lg">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg">Unlock</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Generic Message/Confirmation Modal -->
    <div id="genericMessageModal" class="modal fixed inset-0 bg-black bg-opacity-50 justify-center items-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 id="generic-modal-title" class="text-xl font-bold"></h3>
                <button onclick="closeModal('genericMessageModal')"
                    class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <p id="generic-modal-message" class="mb-6 text-gray-700"></p>
            <div id="generic-message-content" class="mb-6"></div>
            <div class="flex justify-end gap-4">
                <button id="generic-modal-cancel" onclick="closeModal('genericMessageModal')"
                    class="px-4 py-2 bg-gray-300 rounded-lg hidden">Cancel</button>
                <button id="generic-modal-confirm"
                    onclick="this.closest('.modal').classList.add('hidden'); this.closest('.modal').classList.remove('flex');"
                    class="px-4 py-2 bg-blue-600 text-white rounded-lg">OK</button>
            </div>
        </div>
    </div>

    <!-- Batch Entry Confirmation Modal -->
    <div id="batchConfirmModal" class="modal fixed inset-0 bg-black bg-opacity-50 justify-center items-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Confirm Batch Entry</h3>
                <button onclick="closeModal('batchConfirmModal')"
                    class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <p class="mb-4 text-gray-700">Please review the parsed items before proceeding:</p>
            <div id="batch-confirm-list" class="max-h-64 overflow-y-auto border p-4 rounded-md mb-6 text-sm"></div>
            <p id="batch-confirm-errors" class="text-red-600 text-sm mb-4"></p>
            <div class="flex justify-end gap-4">
                <button onclick="closeModal('batchConfirmModal')"
                    class="px-4 py-2 bg-gray-300 rounded-lg">Cancel</button>
                <button id="batch-confirm-proceed" class="px-4 py-2 bg-green-600 text-white rounded-lg">Proceed</button>
            </div>
        </div>
    </div>

    <div id="itemNotesModal" class="modal fixed inset-0 bg-black bg-opacity-50 justify-center items-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 id="notes-modal-title" class="text-xl font-bold">Notes for <span id="notes-item-name"
                        class="font-semibold"></span></h3>
                <button onclick="closeModal('itemNotesModal')"
                    class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <input type="hidden" id="notes-item-id">
            <input type="hidden" id="notes-item-category">
            <div id="notes-list" class="max-h-64 overflow-y-auto border p-4 rounded-md mb-4">
                <!-- Notes will be loaded here -->
            </div>
            <div class="flex gap-2">
                <input type="text" id="new-note-input" class="flex-grow p-2 border rounded-md"
                    placeholder="Add a new note...">
                <button onclick="addNote()" class="px-4 py-2 bg-blue-600 text-white rounded-lg">Add Note</button>
            </div>
        </div>
    </div>

    <!-- Cloud Settings Modal -->
    <div id="cloudSettingsModal" class="modal fixed inset-0 bg-black bg-opacity-50 justify-center items-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Cloud Connection Setup</h3>
                <button onclick="closeModal('cloudSettingsModal')"
                    class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <p class="text-sm text-gray-600 mb-4">Connect to Google Sheets to enable multi-user access.</p>

            <div class="mb-4">
                <label class="block text-sm font-medium mb-1">Google Apps Script Web App URL</label>
                <input type="text" id="cloud-api-url" class="w-full p-2 border rounded-md"
                    placeholder="https://script.google.com/macros/s/...">
            </div>

            <div class="flex justify-end gap-4">
                <button type="button" id="test-conn-btn" onclick="testConnection()"
                    class="px-4 py-2 bg-yellow-500 text-white rounded-lg always-visible">Test Connection</button>
                <button onclick="closeModal('cloudSettingsModal')"
                    class="px-4 py-2 bg-gray-300 rounded-lg always-visible">Cancel</button>
                <button onclick="saveCloudSettings()"
                    class="px-4 py-2 bg-blue-600 text-white rounded-lg always-visible">Connect &
                    Sync</button>
            </div>
        </div>
    </div>

    <!-- Customer Modal -->
    <div id="customerModal" class="modal fixed inset-0 bg-black bg-opacity-50 justify-center items-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Add/Edit Customer</h3>
                <button onclick="closeModal('customerModal')" class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <form id="customer-form">
                <input type="hidden" id="edit-customer-id">
                <div class="mb-4">
                    <label class="block text-sm font-medium">Customer Name</label>
                    <input type="text" id="customer-name" class="w-full p-2 border rounded-md" required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium">GST Number</label>
                    <input type="text" id="customer-gst" class="w-full p-2 border rounded-md">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium">Location/Address</label>
                    <input type="text" id="customer-location" class="w-full p-2 border rounded-md">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium">Type</label>
                    <select id="customer-type" class="w-full p-2 border rounded-md">
                        <option value="Dealer">Dealer</option>
                        <option value="Farmer">Farmer</option>
                        <option value="Demo">Demo</option>
                        <option value="Institution">Institution</option>
                        <option value="Client">Client</option>
                        <option value="Testing">Testing</option>
                        <option value="Sample">Sample</option>
                        <option value="Buyer">Buyer</option>
                        <option value="Estate">Estate</option>
                    </select>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" onclick="closeModal('customerModal')"
                        class="px-4 py-2 bg-gray-300 rounded-lg">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg">Save Customer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Price History Modal -->
    <div id="priceHistoryModal" class="modal fixed inset-0 bg-black bg-opacity-50 justify-center items-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-2xl">
            <div class="flex justify-between items-center mb-4">
                <h3 id="price-history-title" class="text-xl font-bold">Price History</h3>
                <button onclick="closeModal('priceHistoryModal')"
                    class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div id="price-history-chart-container" class="mb-4 h-64">
                <canvas id="priceHistoryChart"></canvas>
            </div>
            <div class="overflow-y-auto max-h-64">
                <table class="min-w-full bg-white border text-sm">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="p-2 border">Date</th>
                            <th class="p-2 border">Supplier</th>
                            <th class="p-2 border">Price</th>
                            <th class="p-2 border">Qty</th>
                        </tr>
                    </thead>
                    <tbody id="price-history-table-body"></tbody>
                </table>
            </div>
            <div class="mt-4 p-4 bg-green-50 rounded border border-green-200">
                <h4 class="font-bold text-green-800 text-sm">Recommendation</h4>
                <p id="price-history-recommendation" class="text-sm text-green-900"></p>
            </div>
        </div>
    </div>

    <div id="loginModal" class="modal fixed inset-0 bg-black bg-opacity-50 justify-center items-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4">User Login</h3>
            <div class="mb-4">
                <label class="block text-sm font-medium mb-1">Your Name</label>
                <input type="text" id="login-username" class="w-full p-2 border rounded" placeholder="Enter your name">
            </div>
            <div class="space-y-4">
                <button onclick="loginAs('admin')"
                    class="w-full p-4 bg-purple-600 text-white rounded-lg font-bold hover:bg-purple-700 text-left flex justify-between">
                    <div>
                        <div>Admin / Manager</div>
                        <div class="text-xs font-normal opacity-75">Full Access</div>
                    </div>
                </button>
                <button onclick="loginAs('store')"
                    class="w-full p-4 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 text-left flex justify-between">
                    <div>
                        <div>Store Keeper</div>
                        <div class="text-xs font-normal opacity-75">Manage Inventory</div>
                    </div>
                </button>
                <button onclick="loginAs('production')"
                    class="w-full p-4 bg-yellow-600 text-white rounded-lg font-bold hover:bg-yellow-700 text-left flex justify-between">
                    <div>
                        <div>Production Manager</div>
                        <div class="text-xs font-normal opacity-75">Formulas & Consumptions</div>
                    </div>
                </button>
                <button onclick="loginAs('viewer')"
                    class="w-full p-4 bg-gray-500 text-white rounded-lg font-bold hover:bg-gray-600 text-left flex justify-between">
                    <div>
                        <div>Viewer / Audit</div>
                        <div class="text-xs font-normal opacity-75">Read Only</div>
                    </div>
                </button>
            </div>
            <div class="mt-4 text-center">
                <button onclick="closeModal('loginModal')" class="text-gray-500 text-sm hover:underline">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Data Management Modal -->
    <div id="dataManagementModal"
        class="modal hidden fixed inset-0 bg-black bg-opacity-50 justify-center items-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold">Data Management</h3>
                <button onclick="closeModal('dataManagementModal')"
                    class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>

            <!-- Import Data (CSV) Section -->
            <div class="mb-8">
                <h4 class="text-lg font-bold mb-2">Import Data (CSV)</h4>
                <p class="text-sm text-gray-600 mb-3">Paste data to import/update items. Format: Name,Unit,Price,Stock
                </p>
                <div class="flex gap-2 mb-2">
                    <select id="import-category" class="flex-1 p-2 border rounded-md">
                        <option value="rawMaterials">Raw Materials</option>
                        <option value="packingMaterials">Packing Materials</option>
                        <option value="labels">Labels</option>
                        <option value="finishedGoods">Finished Goods</option>
                    </select>
                    <button onclick="importCSVData()"
                        class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 font-bold">Import
                        Data</button>
                </div>
                <textarea id="import-csv-data" class="w-full p-3 border rounded-md font-mono text-sm" rows="5"
                    placeholder="Paste data here..."></textarea>
            </div>

            <!-- Full Backup Section -->
            <div class="mb-8">
                <h4 class="text-lg font-bold mb-2">Full Backup</h4>
                <p class="text-sm text-gray-600 mb-3">Export or import the entire application state.</p>
                <button onclick="exportFullBackupJSON()"
                    class="w-full px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 font-bold text-sm mb-2">Export
                    Backup (JSON)</button>
                <button onclick="document.getElementById('import-json-file').click()"
                    class="w-full px-4 py-2 bg-gray-700 text-white rounded-md hover:bg-gray-800 font-bold text-sm mb-2">Import
                    Backup (JSON)</button>
                <button onclick="exportSelfContainedHTML()"
                    class="w-full px-4 py-3 bg-teal-600 text-white rounded-md hover:bg-teal-700 font-bold mb-2">Export
                    Self-Contained HTML File</button>
                <button onclick="forceUploadToCloud()"
                    class="w-full px-4 py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 font-bold">Force Upload
                    All Data to Cloud</button>
                <input type="file" id="import-json-file" accept=".json" style="display: none;"
                    onchange="importFullBackupJSON(event)">
            </div>

            <!-- Danger Zone Section -->
            <div class="mb-4 border-2 border-red-500 rounded-lg p-4 bg-red-50">
                <h4 class="text-lg font-bold text-red-700 mb-2">Danger Zone</h4>
                <p class="text-sm text-red-600 mb-3">This will erase all saved progress and reset the application to its
                    original state. This cannot be undone.</p>
                <button onclick="clearAllDataAndReset()"
                    class="w-full px-4 py-3 bg-red-600 text-white rounded-md hover:bg-red-700 font-bold">Clear All Data
                    & Reset</button>
            </div>
        </div>
    </div>

    <!-- WIP Consumption Slip Modal -->
    <div id="wipConsumptionModal"
        class="modal fixed inset-0 bg-black bg-opacity-50 justify-center items-center z-50 overflow-y-auto py-6">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-2xl mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 id="wip-slip-title" class="text-xl font-bold">📝 Log Consumption Slip</h3>
                <button onclick="closeModal('wipConsumptionModal')"
                    class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <input type="hidden" id="wip-slip-batch-id">

            <!-- Entry Mode Toggle -->
            <div class="flex gap-2 mb-4 p-2 bg-gray-100 rounded-lg">
                <button type="button" id="wip-mode-auto" onclick="setWipSlipMode('auto')"
                    class="flex-1 py-2 rounded font-bold bg-blue-600 text-white">🤖 Auto Mode</button>
                <button type="button" id="wip-mode-manual" onclick="setWipSlipMode('manual')"
                    class="flex-1 py-2 rounded font-bold bg-gray-300 text-gray-700">✍️ Manual Mode</button>
            </div>

            <!-- AUTO MODE Section -->
            <div id="wip-auto-section" class="border-2 border-blue-200 rounded-lg p-4 mb-4 bg-blue-50">
                <h4 class="font-bold text-blue-800 mb-2">🤖 Automatic Calculation</h4>
                <p class="text-sm text-gray-600 mb-3">Enter units produced - system will auto-calculate materials
                    consumed based on formula.</p>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Units Produced This Session</label>
                        <input type="number" id="wip-auto-units" step="0.001"
                            class="w-full p-3 border-2 border-blue-300 rounded-lg text-lg font-bold"
                            placeholder="Enter qty" oninput="previewAutoConsumption()">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Target Qty</label>
                        <input type="text" id="wip-auto-target" class="w-full p-3 border rounded-lg bg-gray-100"
                            readonly>
                    </div>
                </div>
                <div id="wip-auto-preview" class="mt-4 text-sm text-gray-600 hidden">
                    <p class="font-bold">Materials to be consumed:</p>
                    <div id="wip-auto-preview-list" class="mt-2"></div>
                </div>
            </div>

            <!-- MANUAL MODE Section -->
            <div id="wip-manual-section" class="border-2 border-yellow-200 rounded-lg p-4 mb-4 bg-yellow-50 hidden">
                <h4 class="font-bold text-yellow-800 mb-2">✍️ Manual Entry</h4>
                <p class="text-sm text-gray-600 mb-3">Enter exact quantities consumed. Use for corrections, wastage, or
                    non-standard situations.</p>
                <div class="overflow-x-auto max-h-64">
                    <table class="min-w-full text-sm">
                        <thead class="bg-gray-100 sticky top-0">
                            <tr>
                                <th class="p-2 text-left">Material</th>
                                <th class="p-2 text-right">Reserved</th>
                                <th class="p-2 text-right">Already Used</th>
                                <th class="p-2 text-right">Remaining</th>
                                <th class="p-2 text-right w-28">Use Now</th>
                            </tr>
                        </thead>
                        <tbody id="wip-manual-rows"></tbody>
                    </table>
                </div>
            </div>

            <!-- Common Fields -->
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Slip Type</label>
                    <select id="wip-slip-type" class="w-full p-2 border rounded-lg">
                        <option value="regular">Regular Consumption</option>
                        <option value="wastage">Wastage / Spillage</option>
                        <option value="adjustment">Adjustment (+/-)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Date</label>
                    <input type="date" id="wip-slip-date" class="w-full p-2 border rounded-lg">
                </div>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium mb-1">Notes (Optional)</label>
                <textarea id="wip-slip-notes" class="w-full p-2 border rounded-lg" rows="2"
                    placeholder="Add notes about this consumption..."></textarea>
            </div>

            <div class="flex justify-end gap-4">
                <button type="button" onclick="closeModal('wipConsumptionModal')"
                    class="px-4 py-2 bg-gray-300 rounded-lg">Cancel</button>
                <button type="button" onclick="saveConsumptionSlip()"
                    class="px-6 py-2 bg-green-600 text-white rounded-lg font-bold hover:bg-green-700">Save
                    Consumption</button>
            </div>
        </div>
    </div>

    <!-- WIP Pause Production Modal -->
    <div id="wipPauseModal" class="modal fixed inset-0 bg-black bg-opacity-50 justify-center items-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">⏸️ Pause Production</h3>
                <button onclick="closeModal('wipPauseModal')"
                    class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <input type="hidden" id="wip-pause-batch-id">

            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">Reason for Pause</label>
                <div class="space-y-2">
                    <label class="flex items-center p-2 border rounded hover:bg-gray-50 cursor-pointer">
                        <input type="radio" name="pause-reason" value="Machine Breakdown" class="mr-3"> Machine
                        Breakdown
                    </label>
                    <label class="flex items-center p-2 border rounded hover:bg-gray-50 cursor-pointer">
                        <input type="radio" name="pause-reason" value="Power Failure" class="mr-3"> Power Failure
                    </label>
                    <label class="flex items-center p-2 border rounded hover:bg-gray-50 cursor-pointer">
                        <input type="radio" name="pause-reason" value="Material Shortage" class="mr-3"> Material
                        Shortage
                    </label>
                    <label class="flex items-center p-2 border rounded hover:bg-gray-50 cursor-pointer">
                        <input type="radio" name="pause-reason" value="Quality Issue" class="mr-3"> Quality Issue
                    </label>
                    <label class="flex items-center p-2 border rounded hover:bg-gray-50 cursor-pointer">
                        <input type="radio" name="pause-reason" value="Other" class="mr-3"> Other
                    </label>
                </div>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium mb-1">Expected Resume Date (Optional)</label>
                <input type="date" id="wip-pause-resume-date" class="w-full p-2 border rounded-lg">
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium mb-1">Additional Notes</label>
                <textarea id="wip-pause-notes" class="w-full p-2 border rounded-lg" rows="2"
                    placeholder="Details about the pause..."></textarea>
            </div>

            <div class="flex justify-end gap-4">
                <button type="button" onclick="closeModal('wipPauseModal')"
                    class="px-4 py-2 bg-gray-300 rounded-lg">Cancel</button>
                <button type="button" onclick="confirmPauseProduction()"
                    class="px-6 py-2 bg-yellow-600 text-white rounded-lg font-bold hover:bg-yellow-700">Pause
                    Order</button>
            </div>
        </div>
    </div>

    <!-- WIP Order Detail Modal -->
    <div id="wipDetailModal"
        class="modal fixed inset-0 bg-black bg-opacity-50 justify-center items-center z-50 overflow-y-auto py-6">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-4xl mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 id="wip-detail-title" class="text-xl font-bold">📋 Order Details</h3>
                <button onclick="closeModal('wipDetailModal')"
                    class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <input type="hidden" id="wip-detail-batch-id">

            <!-- Order Summary -->
            <div id="wip-detail-summary" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6 p-4 bg-gray-50 rounded-lg">
            </div>

            <!-- Material Progress -->
            <div class="mb-6">
                <h4 class="font-bold text-lg mb-2 flex items-center gap-2">
                    📊 Material Progress
                    <span id="wip-detail-progress-percent" class="text-sm font-normal text-gray-500"></span>
                </h4>
                <div class="overflow-x-auto">
                    <table class="min-w-full text-sm border">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-2 text-left border">Material</th>
                                <th class="p-2 text-right border">Reserved</th>
                                <th class="p-2 text-right border">Consumed</th>
                                <th class="p-2 text-right border">Remaining</th>
                                <th class="p-2 text-center border">Progress</th>
                            </tr>
                        </thead>
                        <tbody id="wip-detail-materials"></tbody>
                    </table>
                </div>
            </div>

            <!-- Consumption Slips -->
            <div class="mb-6">
                <h4 class="font-bold text-lg mb-2">📋 Consumption Slips</h4>
                <div id="wip-detail-slips" class="space-y-2 max-h-48 overflow-y-auto"></div>
            </div>

            <!-- Status History -->
            <div class="mb-6">
                <h4 class="font-bold text-lg mb-2">📜 Status History</h4>
                <div id="wip-detail-history" class="space-y-1 text-sm max-h-32 overflow-y-auto"></div>
            </div>

            <!-- Actions -->
            <div id="wip-detail-actions" class="flex flex-wrap gap-2 border-t pt-4"></div>
        </div>
    </div>

    <script id="app-data" type="application/json">
    {
        "inventory": {
            "rawMaterials": [],
            "packingMaterials": [],
            "labels": [],
            "finishedGoods": []
        },
        "transactions": [],
        "formulas": [],
        "requisitionBooks": []
    </script>

    <script>
        // --- APPLICATION STATE & INITIALIZATION ---
        let appState = {};
        let currentView = 'dashboard';
        let selectedDate = new Date().toISOString().split('T')[0];
        let activeCategoryContext = null;
        let isFormulaUnlocked = false;

        // Chart.js instances to destroy and recreate
        let inventoryValueChart = null;
        let monthlyConsumptionChart = null;
        let topValuableItemsChart = null;
        let historicalStockChart = null;


        // Cache for generated item ledgers to improve performance
        let itemLedgerCache = {};

        document.addEventListener('DOMContentLoaded', () => {
            loadInitialData();
            setupEventListeners();
            showView(currentView);
            // Initialize weighted average costing migration
            migrateDataForWeightedCosting();
        });

        // --- CLOUD SYNC & STATE MANAGEMENT ---
        let cloudApiUrl = localStorage.getItem('inventoryCloudUrl') || '';
        let saveTimeout = null;
        let isSyncing = false;
        let autoSyncEnabled = localStorage.getItem('autoSyncEnabled') === 'true'; // Default: DISABLED for safety
        let autoRefreshEnabled = localStorage.getItem('autoRefreshEnabled') === 'true'; // Default: DISABLED
        let refreshInterval = null;

        // Initialize Auto-Sync and Auto-Refresh Toggles
        document.addEventListener('DOMContentLoaded', () => {
            const syncToggle = document.getElementById('auto-sync-toggle');
            const refreshToggle = document.getElementById('auto-refresh-toggle');
            const manualBtn = document.getElementById('manual-sync-btn');

            syncToggle.checked = autoSyncEnabled;
            refreshToggle.checked = autoRefreshEnabled;
            manualBtn.classList.toggle('hidden', autoSyncEnabled);

            // Auto-Sync Toggle
            syncToggle.addEventListener('change', (e) => {
                autoSyncEnabled = e.target.checked;
                localStorage.setItem('autoSyncEnabled', autoSyncEnabled);
                manualBtn.classList.toggle('hidden', autoSyncEnabled);

                if (autoSyncEnabled) {
                    updateSyncStatus('pending', 'Auto-sync enabled');
                } else {
                    updateSyncStatus('pending', 'Auto-sync disabled');
                }
            });

            // Auto-Refresh Toggle
            refreshToggle.addEventListener('change', (e) => {
                autoRefreshEnabled = e.target.checked;
                localStorage.setItem('autoRefreshEnabled', autoRefreshEnabled);

                if (autoRefreshEnabled) {
                    startAutoRefresh();
                } else {
                    stopAutoRefresh();
                }
            });

            // Start auto-refresh if enabled
            if (autoRefreshEnabled && cloudApiUrl) {
                startAutoRefresh();
            }
        });

        function startAutoRefresh() {
            if (refreshInterval) clearInterval(refreshInterval);
            refreshInterval = setInterval(() => {
                if (cloudApiUrl && !isSyncing) {
                    console.log("Auto-refreshing from cloud...");
                    fetchFromCloud();
                }
            }, 30000); // Every 30 seconds
            updateSyncStatus('pending', 'Auto-refresh active (30s)');
        }

        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
            updateSyncStatus('pending', 'Auto-refresh disabled');
        }

        function refreshFromCloud() {
            if (!cloudApiUrl) {
                alert('Please connect to cloud first!');
                return;
            }
            fetchFromCloud();
        }

        // DOMContentLoaded listener for auto-sync toggle defined above (line ~1002)


        function manualSync() {
            if (!cloudApiUrl) {
                alert('Please connect to cloud first!');
                return;
            }
            syncToCloud();
        }

        function saveState() {
            // 1. Save locally immediately for redundancy
            try {
                localStorage.setItem('inventoryAppState', JSON.stringify(appState));
                itemLedgerCache = {};
            } catch (error) {
                console.error("Local save failed", error);
            }

            // 2. Trigger Cloud Sync ONLY if auto-sync is enabled
            if (cloudApiUrl && autoSyncEnabled) {
                updateSyncStatus('pending', 'Waiting to sync...');
                if (saveTimeout) clearTimeout(saveTimeout);
                saveTimeout = setTimeout(syncToCloud, 2000); // Wait 2 seconds of inactivity
            } else if (cloudApiUrl && !autoSyncEnabled) {
                updateSyncStatus('pending', 'Saved locally (Auto-sync OFF)');
            }
        }

        async function syncToCloud() {
            if (!cloudApiUrl) return;

            updateSyncStatus('syncing', 'Syncing to cloud...');
            isSyncing = true;

            try {
                // Using URLSearchParams sends data as application/x-www-form-urlencoded
                // This is generally compatible with Google Apps Script without complex CORS preflights
                const formData = new URLSearchParams();
                formData.append('data', JSON.stringify(appState));

                const response = await fetch(cloudApiUrl, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: formData
                });

                // With no-cors, we can't check status, but if promise resolves, we assume sent.
                console.log("Sync request sent");
                updateSyncStatus('success', 'Saved (Sent)');

            } catch (error) {
                console.error("Cloud sync failed", error);
                updateSyncStatus('error', 'Sync Failed');
            } finally {
                isSyncing = false;
            }
        }

        async function testConnection() {
            const url = document.getElementById('cloud-api-url').value.trim();
            if (!url) { alert("Please enter a URL"); return; }

            const btn = document.getElementById('test-conn-btn');
            const origText = btn.textContent;
            btn.textContent = "Testing...";
            btn.disabled = true;

            try {
                // GET request to check connectivity
                const response = await fetch(url);
                const data = await response.json();
                if (data.status === 'success') {
                    alert("Connection Successful! Database found.");
                } else {
                    alert("Connected, but script returned error: " + (data.message || "Unknown"));
                }
            } catch (e) {
                alert("Connection Failed. Checking URL... \nError: " + e.message + "\n\nMake sure the URL is correct and you have internet.");
            } finally {
                btn.textContent = origText;
                btn.disabled = false;
            }
        }



        // fetchFromCloud function: Using more robust version below (line ~1325) with enhanced error handling


        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast-notification');
            if (!toast) return;

            toast.textContent = message;
            toast.className = 'show'; // Reset classes

            // Set color based on type
            if (type === 'success') {
                toast.style.color = '#155724';
                toast.style.backgroundColor = '#d4edda';
                toast.style.border = '1px solid #c3e6cb';
            } else if (type === 'error') {
                toast.style.color = '#721c24';
                toast.style.backgroundColor = '#f8d7da';
                toast.style.border = '1px solid #f5c6cb';
            } else {
                toast.style.color = '#004085';
                toast.style.backgroundColor = '#cce5ff';
                toast.style.border = '1px solid #b8daff';
            }

            // Hide after 3 seconds
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function updateSyncStatus(status, text) {
            const indicator = document.getElementById('sync-indicator');
            const textEl = document.getElementById('sync-text');

            if (textEl) textEl.textContent = text;
            if (indicator) {
                indicator.className = "w-2 h-2 rounded-full mr-2 ";
                if (status === 'syncing') indicator.classList.add('bg-blue-500', 'animate-pulse');
                else if (status === 'success') indicator.classList.add('bg-green-500');
                else if (status === 'error') indicator.classList.add('bg-red-500');
                else if (status === 'pending') indicator.classList.add('bg-yellow-500');
                else indicator.classList.add('bg-gray-500');
            }

            // Show toast for key events
            if (status === 'success' || status === 'error' || status === 'syncing') {
                showToast(text, status === 'syncing' ? 'info' : status);
            }
        }

        function saveCloudSettings() {
            const url = document.getElementById('cloud-api-url').value.trim();
            if (url) {
                cloudApiUrl = url;
                localStorage.setItem('inventoryCloudUrl', url);
                closeModal('cloudSettingsModal');
                fetchFromCloud(); // Trigger initial pull (DOWNLOAD ONLY, no upload)
            }
        }

        function loadInitialData() {
            // ALWAYS load local data first so the user sees something immediately
            loadLocalData();

            // Then, if connected, DOWNLOAD from cloud (but never auto-upload on startup)
            if (cloudApiUrl) {
                fetchFromCloud(); // This only DOWNLOADS, never uploads
                startAutoRefresh(); // Start generic auto-refresh loop
            } else {
                // Prompt user if no URL setup
                // CHANGED: Removed annoying startup popup (Duplicate fix)
                /*
                setTimeout(() => {
                    if (!cloudApiUrl) openModal('cloudSettingsModal');
                }, 1000);
                */
            }
            // NOTE: We never auto-upload on startup to prevent accidental overwrites from cached data
        }

        // DOMContentLoaded listener for auto-sync toggle defined above (line ~1002)


        // manualSync function defined above (line ~1089)


        // saveState function defined above (line ~1097)


        // syncToCloud function defined above (line ~1117)


        // testConnection function defined above (line ~1148)


        // Explicit 'pull' for initial load or manual refresh
        async function fetchFromCloud() {
            if (!cloudApiUrl) {
                loadLocalData();
                return;
            }

            updateSyncStatus('syncing', 'Downloading data...');
            try {
                // Ensure URL is valid
                if (!cloudApiUrl.startsWith('http')) {
                    throw new Error("Invalid Cloud URL");
                }

                const response = await fetch(cloudApiUrl, {
                    method: 'GET',
                    redirect: 'follow'
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const text = await response.text();
                let result;
                try {
                    result = JSON.parse(text);
                } catch (e) {
                    console.error("Failed to parse cloud response as JSON:", text.substring(0, 100));
                    throw new Error("Invalid JSON response from Cloud");
                }

                if (result.status === 'success' && result.data) {
                    const cloudData = result.data;
                    if (!cloudData.inventory || !cloudData.transactions) {
                        console.error("Cloud data missing critical fields", cloudData);
                        throw new Error("Cloud data is incomplete or corrupted.");
                    }

                    // Sanitize Inventory Keys (normalize to camelCase)
                    const standardKeys = {
                        'rawmaterials': 'rawMaterials',
                        'packingmaterials': 'packingMaterials',
                        'labels': 'labels',
                        'finishedgoods': 'finishedGoods',
                        'raw_materials': 'rawMaterials',
                        'packing_materials': 'packingMaterials',
                        'finished_goods': 'finishedGoods'
                    };

                    const newInventory = {};
                    Object.keys(cloudData.inventory).forEach(key => {
                        const lowerKey = key.toLowerCase().replace(/[^a-z0-9]/g, '');
                        const standardKey = standardKeys[lowerKey] || key;
                        newInventory[standardKey] = cloudData.inventory[key];
                    });
                    cloudData.inventory = newInventory;

                    appState = cloudData;
                    // --- INTELLIGENT MERGE FOR UPGRADE SAFETY ---
                    // If cloud data is missing ERP fields (because it's from before the update), 
                    // but we have local data for them, PRESERVE the local data.
                    if (!cloudData.suppliers && appState.suppliers && appState.suppliers.length > 0) {
                        console.log("Preserving local suppliers during sync");
                        cloudData.suppliers = appState.suppliers;
                    } else if (!cloudData.suppliers) {
                        cloudData.suppliers = [];
                    }

                    if (!cloudData.customers && appState.customers && appState.customers.length > 0) {
                        console.log("Preserving local customers during sync");
                        cloudData.customers = appState.customers;
                    } else if (!cloudData.customers) {
                        cloudData.customers = [];
                    }

                    appState = cloudData;

                    // Ensure migration of new fields
                    Object.keys(appState.inventory).forEach(cat => {
                        if (appState.inventory[cat]) {
                            appState.inventory[cat].forEach(item => {
                                if (item.minStockLevel === undefined) item.minStockLevel = 0;
                                if (item.notes === undefined) item.notes = [];
                            });
                        }
                    });

                    // Save this fresh cloud data to local as well
                    localStorage.setItem('inventoryAppState', JSON.stringify(appState));
                    updateSyncStatus('success', 'Data loaded');
                    renderCurrentView();
                } else {
                    console.warn("Cloud returned no data or error", result);
                    loadLocalData(); // Fallback
                }
            } catch (error) {
                console.error("Fetch failed", error);
                updateSyncStatus('error', 'Download Failed');
                loadLocalData(); // Fallback
            }
        }

        // updateSyncStatus function defined above (line ~1241) - version with null checks and toast


        // saveCloudSettings function defined above (line ~1260)


        function loadInitialData() {
            // ALWAYS load local data first so the user sees something immediately
            loadLocalData();

            // Then, if connected, try to sync/update from cloud in background
            if (cloudApiUrl) {
                fetchFromCloud();
            } else {
                // CHANGED: Removed annoying startup popup for cloud settings
                // Only open if explicitly requested by user via sidebar or sync button
                /*
                setTimeout(() => {
                    if (!cloudApiUrl) openModal('cloudSettingsModal');
                }, 1000);
                */
            }
        }

        function loadLocalData() {
            const savedStateJSON = localStorage.getItem('inventoryAppState');
            if (savedStateJSON) {
                try {
                    const savedState = JSON.parse(savedStateJSON);
                    if (savedState && savedState.inventory) {
                        appState = savedState;
                        // Ensure new fields
                        Object.keys(appState.inventory).forEach(cat => {
                            if (appState.inventory[cat]) {
                                appState.inventory[cat].forEach(item => {
                                    if (item.minStockLevel === undefined) item.minStockLevel = 0;
                                    if (item.notes === undefined) item.notes = [];
                                });
                            }
                        });

                        // Initialize ERP Arrays if missing
                        if (!appState.transactions) appState.transactions = [];
                        if (!appState.formulas) appState.formulas = [];
                        if (!appState.suppliers) appState.suppliers = [];
                        if (!appState.customers) appState.customers = [];
                        if (!appState.activeProduction) appState.activeProduction = [];
                        // FIX: Ensure saved calculations array exists
                        if (!appState.savedCalculations) appState.savedCalculations = [];

                        // Render immediately after loading local data
                        renderCurrentView();
                        return;
                    }
                } catch (e) {
                    console.error(e);
                }
            }
            // Fallback if local storage empty or failed
            FALLBACK_INIT();
            renderCurrentView();
        }

        function FALLBACK_INIT() {
            try {
                const dataScript = document.getElementById('app-data');
                if (!dataScript) throw new Error("Default data script not found");

                const parsedData = JSON.parse(dataScript.textContent);
                appState.inventory = parsedData.inventory || { rawMaterials: [], packingMaterials: [], labels: [], finishedGoods: [] };
                appState.transactions = parsedData.transactions || [];
                appState.formulas = parsedData.formulas || [];
            } catch (error) {
                console.warn("Fallback Init Failed (Using empty state):", error);
                appState = { inventory: { rawMaterials: [], packingMaterials: [], labels: [], finishedGoods: [] }, transactions: [], formulas: [], savedCalculations: [] };
            }
            // Ensure savedCalculations exists even on successful parse if missing
            if (appState && !appState.savedCalculations) appState.savedCalculations = [];
        }

        function setupEventListeners() {
            document.querySelectorAll('.sidebar-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const viewId = e.currentTarget.getAttribute('data-view');

                    if (viewId === 'formulations' && !isFormulaUnlocked) {
                        openModal('passwordModal');
                        return;
                    }
                    if (viewId === 'data-management') {
                        openModal('dataManagementModal');
                        return;
                    }
                    showView(viewId);
                });
            });
            document.getElementById('item-form').addEventListener('submit', handleItemFormSubmit);
            document.getElementById('stock-tx-form').addEventListener('submit', handleStockTxFormSubmit);
            document.getElementById('edit-tx-form').addEventListener('submit', handleEditTxFormSubmit);
            document.getElementById('formula-form').addEventListener('submit', handleFormulaFormSubmit);
            document.getElementById('password-form').addEventListener('submit', handlePasswordSubmit);
            document.getElementById('adjust-stock-form').addEventListener('submit', handleStockAdjustment);
            document.getElementById('item-category').addEventListener('change', toggleExpiryDateField);
        }

        // --- UTILITY FUNCTIONS ---
        const getToday = () => new Date().toISOString().split('T')[0];
        const getStartOfDay = (dateStr) => {
            if (!dateStr) return new Date();
            try {
                const parts = dateStr.includes('T') ? dateStr.split('T')[0] : dateStr;
                const [year, month, day] = parts.split('-').map(Number);
                if (isNaN(year) || isNaN(month) || isNaN(day)) return new Date();
                return new Date(Date.UTC(year, month - 1, day));
            } catch (e) { return new Date(); }
        };

        function findItem(category, id) {
            if (!appState.inventory[category]) return null;
            // ROBUST LOOKUP: Check strict match first, then loose match (string vs number)
            return appState.inventory[category].find(item => item.id === id || item.id == id);
        }

        function parseFlexibleDate(dateString) {
            if (!dateString) return null;
            let parts;
            let day, month, year;

            if (dateString.includes('-') || dateString.includes('/')) {
                parts = dateString.split(/[-/]/);
                if (parts.length === 3) {
                    day = parseInt(parts[0], 10);
                    month = parseInt(parts[1], 10);
                    year = parseInt(parts[2], 10);
                    if (year < 100) year += (year > 50 ? 1900 : 2000);
                }
            } else {
                parts = dateString.split(' ');
                if (parts.length === 3) {
                    day = parseInt(parts[0], 10);
                    month = parseInt(parts[1], 10);
                    year = parseInt(parts[2], 10);
                    if (year < 100) year += (year > 50 ? 1900 : 2000);
                }
            }

            if (day > 0 && day <= 31 && month > 0 && month <= 12 && year >= 1900 && year <= 2100) {
                const d = new Date(year, month - 1, day);
                if (d.getFullYear() === year && d.getMonth() === month - 1 && d.getDate() === day) {
                    return `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                }
            }
            return null;
        }

        function levenshteinDistance(a, b) {
            const an = a.length;
            const bn = b.length;
            if (an === 0) return bn;
            if (bn === 0) return an;
            const matrix = Array.from({ length: an + 1 }, () => Array(bn + 1).fill(0));
            for (let i = 0; i <= an; i++) matrix[i][0] = i;
            for (let j = 1; j <= bn; j++) matrix[0][j] = j;
            for (let i = 1; i <= an; i++) {
                for (let j = 1; j <= bn; j++) {
                    const cost = a[i - 1] === b[j - 1] ? 0 : 1;
                    matrix[i][j] = Math.min(matrix[i - 1][j] + 1, matrix[i][j - 1] + 1, matrix[i - 1][j - 1] + cost);
                }
            }
            return matrix[an][bn];
        }

        function getFuzzyMatch(inputName, category) {
            const lowerInputName = inputName.toLowerCase();
            let bestMatch = null;
            let bestScore = Infinity;
            const items = appState.inventory[category] || [];
            for (const item of items) {
                const lowerItemName = item.name.toLowerCase();
                const distance = levenshteinDistance(lowerInputName, lowerItemName);
                if (distance === 0) return { item, score: 0 };
                const maxAllowedDistance = Math.floor(Math.max(lowerInputName.length, lowerItemName.length) / 4) + 1;
                if (distance <= maxAllowedDistance && distance < bestScore) {
                    bestScore = distance;
                    bestMatch = item;
                }
            }
            return bestMatch ? { item: bestMatch, score: bestScore } : null;
        }

        // --- CORE STOCK CALCULATION LOGIC ---
        function calculateStock(item, category, targetDateStr) {
            if (!item || !item.openingStockDate) return { openingStock: 0, received: 0, consumed: 0, closingStock: 0 };

            const targetDate = getStartOfDay(targetDateStr);
            const itemOpeningDate = getStartOfDay(item.openingStockDate);

            const transactionsOnTargetDate = appState.transactions.filter(tx =>
                tx.category === category && tx.itemId == item.id && getStartOfDay(tx.date).getTime() === targetDate.getTime()
            );
            const received = transactionsOnTargetDate.filter(t => t.type === 'receive' || t.type === 'stock-take-adj-in' || t.type === 'production-add').reduce((sum, t) => sum + t.quantity, 0);
            const consumed = transactionsOnTargetDate.filter(t => t.type === 'consume' || t.type === 'stock-take-adj-out' || t.type === 'production-consume' || t.type === 'dispatch').reduce((sum, t) => sum + t.quantity, 0);

            if (targetDate < itemOpeningDate) {
                return { openingStock: 0, received, consumed, closingStock: received - consumed };
            }

            let openingStock = item.openingStock;
            const transactionsBeforeTarget = appState.transactions.filter(tx => {
                const txDate = getStartOfDay(tx.date);
                return tx.category === category && tx.itemId == item.id && txDate >= itemOpeningDate && txDate < targetDate;
            });

            transactionsBeforeTarget.forEach(tx => {
                if (tx.type === 'receive' || tx.type === 'stock-take-adj-in' || tx.type === 'production-add') {
                    openingStock += tx.quantity;
                } else if (tx.type === 'consume' || tx.type === 'stock-take-adj-out' || tx.type === 'production-consume' || tx.type === 'dispatch') {
                    openingStock -= tx.quantity;
                }
            });

            const closingStock = openingStock + received - consumed;

            return { openingStock, received, consumed, closingStock };
        }

        function generateItemLedger(item, category, reportEndDateStr) {
            const cacheKey = `${category}-${item.id}-${reportEndDateStr}`;
            if (itemLedgerCache[cacheKey]) {
                return itemLedgerCache[cacheKey];
            }

            const ledger = new Map();
            if (!item || !item.openingStockDate) return ledger;

            const startDate = getStartOfDay(item.openingStockDate);
            const endDate = getStartOfDay(reportEndDateStr);

            if (endDate < startDate) return ledger;

            const transactionsByDate = {};
            appState.transactions
                .filter(tx => tx.category === category && tx.itemId === item.id)
                .forEach(tx => {
                    const txDateStr = tx.date.split('T')[0];
                    if (!transactionsByDate[txDateStr]) {
                        transactionsByDate[txDateStr] = [];
                    }
                    transactionsByDate[txDateStr].push(tx);
                });

            let currentStock = item.openingStock;

            const openingDayStr = item.openingStockDate;
            const openingDayTxs = transactionsByDate[openingDayStr] || [];
            const openingDayReceived = openingDayTxs.filter(t => t.type === 'receive' || t.type === 'stock-take-adj-in' || t.type === 'production-add').reduce((sum, t) => sum + t.quantity, 0);
            const openingDayConsumed = openingDayTxs.filter(t => t.type === 'consume' || t.type === 'stock-take-adj-out' || t.type === 'production-consume').reduce((sum, t) => sum + t.quantity, 0);
            const openingDayClosing = item.openingStock + openingDayReceived - openingDayConsumed;

            ledger.set(openingDayStr, {
                opening: item.openingStock,
                received: openingDayReceived,
                consumed: openingDayConsumed,
                closing: openingDayClosing,
                transactions: openingDayTxs // Include actual transactions for the day
            });
            currentStock = openingDayClosing;

            for (let d = new Date(startDate.getTime() + 86400000); d <= endDate; d.setUTCDate(d.getUTCDate() + 1)) {
                const currentDateStr = d.toISOString().split('T')[0];
                const openingStockForDay = currentStock; // This is the closing stock of the previous day

                const dailyTxs = transactionsByDate[currentDateStr] || [];
                const received = dailyTxs.filter(t => t.type === 'receive' || t.type === 'stock-take-adj-in' || t.type === 'production-add').reduce((sum, t) => sum + t.quantity, 0);
                const consumed = dailyTxs.filter(t => t.type === 'consume' || t.type === 'stock-take-adj-out' || t.type === 'production-consume').reduce((sum, t) => sum + t.quantity, 0);

                const closingStockForDay = openingStockForDay + received - consumed;

                ledger.set(currentDateStr, {
                    opening: openingStockForDay,
                    received: received,
                    consumed: consumed,
                    closing: closingStockForDay,
                    transactions: dailyTxs // Include actual transactions for the day
                });
                currentStock = closingStockForDay;
            }

            itemLedgerCache[cacheKey] = ledger;
            return ledger;
        }

        // --- VIEW RENDERING ---
        // --- AUDIT LOGGING ---
        function logActivity(action, details) {
            return;
            if (!appState.activityLog) appState.activityLog = [];

            const logEntry = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                user: currentUserRole || 'viewer',
                userName: currentUserName || 'Guest',
                action: action,
                details: details
            };

            appState.activityLog.push(logEntry);

            // Limit log size to last 1000 entries
            if (appState.activityLog.length > 1000) {
                appState.activityLog = appState.activityLog.slice(-1000);
            }

            // Add Undo Button to Toast if recent action
            // We can't easily "Undo" any action generically without complex state history,
            // but we can allow "Voiding" via the log. The user asked for "Undo" in buttons.
            // A simple "Undo" for the Last transaction is possible if we track it.
            lastTransactionId = logEntry.id;
        }

        let lastTransactionId = null;

        function undoLastAction() {
            showAlert("Action history is disabled.");
        }

        // renderActivityLogView REMOVED

        // revertAction REMOVED

        // --- BATCH HELPERS ---
        // --- BATCH HELPERS ---
        window.showBatchDetails = function (itemId, category) {
            const item = findItem(category, parseFloat(itemId));
            if (!item) {
                console.error("Item not found for batch details:", itemId, category);
                showAlert("Error: Item not found.");
                return;
            }

            // Calculate Stock by Batch
            const batchStock = {};

            appState.transactions.forEach(tx => {
                if (tx.itemId === itemId && tx.category === category) {
                    const batch = tx.batchNo || 'Unassigned';
                    if (!batchStock[batch]) batchStock[batch] = 0;

                    if (['receive', 'produce', 'stock-take-adj-in', 'production-add'].includes(tx.type)) {
                        batchStock[batch] += tx.quantity;
                    } else if (['consume', 'dispatch', 'stock-take-adj-out', 'production-consume'].includes(tx.type)) {
                        batchStock[batch] -= tx.quantity;
                    }
                }
            });

            const activeBatches = Object.entries(batchStock)
                .filter(([batch, qty]) => qty > 0.001) // Filter out zero/near-zero
                .sort((a, b) => b[1] - a[1]); // Sort by qty desc

            const content = `
                <div class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center" id="batchDetailsModal">
                    <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-lg relative">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold">Batch Details: ${item.name}</h3>
                            <button onclick="document.getElementById('batchDetailsModal').remove()" class="text-gray-500 hover:text-gray-800 text-2xl absolute top-4 right-4">&times;</button>
                        </div>
                        <div class="overflow-y-auto max-h-96">
                            <table class="min-w-full text-sm">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="p-2 text-left">Batch Number</th>
                                        <th class="p-2 text-right">Current Stock</th>
                                        <th class="p-2 text-left">Expiry</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${activeBatches.length > 0 ? activeBatches.map(([batch, qty]) => {
                // Try to find expiry for this batch from receive transactions
                const receiveTx = appState.transactions.find(t => t.batchNo === batch && t.expiryDate);
                const expiry = receiveTx ? receiveTx.expiryDate : '-';
                return `
                                        <tr class="border-b">
                                            <td class="p-2 font-mono break-all">${batch}</td>
                                            <td class="p-2 text-right font-bold">${qty.toFixed(3)} ${item.unit}</td>
                                            <td class="p-2 ${expiry !== '-' && new Date(expiry) < new Date() ? 'text-red-500 font-bold' : ''}">${expiry}</td>
                                        </tr>`;
            }).join('') : '<tr><td colspan="3" class="p-4 text-center text-gray-500">No active batches found.</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                         <div class="mt-4 text-xs text-gray-500 text-right">
                            * Calculated from transaction history.
                        </div>
                        <div class="mt-4 flex justify-end">
                            <button onclick="document.getElementById('batchDetailsModal').remove()" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">Close</button>
                        </div>
                    </div>
                </div>
            `;
            // Remove existing if any
            const existing = document.getElementById('batchDetailsModal');
            if (existing) existing.remove();

            document.body.insertAdjacentHTML('beforeend', content);
        };


        // --- VIEW RENDERING ---
        function showView(viewId) {
            const categoryMap = { "raw-materials": "rawMaterials", "packing-materials": "packingMaterials", "labels": "labels", "finished-goods": "finishedGoods" };
            activeCategoryContext = categoryMap[viewId] || null;
            document.querySelectorAll('.view').forEach(view => { view.innerHTML = ''; view.classList.add('hidden'); });
            const viewContainer = document.getElementById(`${viewId}-view`);
            if (viewContainer) viewContainer.classList.remove('hidden');
            document.querySelectorAll('.sidebar-link').forEach(link => link.classList.remove('active'));
            const activeLink = document.querySelector(`.sidebar-link[data-view="${viewId}"]`);
            if (activeLink) activeLink.classList.add('active');
            currentView = viewId;
            renderCurrentView();
        }

        function renderCurrentView() {
            // Destroy existing charts before rendering a new view
            if (inventoryValueChart) inventoryValueChart.destroy();
            if (monthlyConsumptionChart) monthlyConsumptionChart.destroy();
            if (topValuableItemsChart) topValuableItemsChart.destroy();
            if (historicalStockChart) historicalStockChart.destroy();

            const categoryMap = { "raw-materials": "rawMaterials", "packing-materials": "packingMaterials", "labels": "labels", "finished-goods": "finishedGoods" };
            if (categoryMap[currentView]) {
                renderInventoryView(categoryMap[currentView]);
            } else if (currentView === 'dashboard') {
                renderDashboard();
            } else if (currentView === 'daily-report') {
                renderReportsView();
            } else if (currentView === 'formulations') {
                renderFormulationsView();
            } else if (currentView === 'expiry-tracking') {
                renderExpiryTrackingView();
            } else if (currentView === 'reorder-assistant') {
                renderReorderAssistantView();
            } else if (currentView === 'stock-take') {
                renderStockTakeView();
            } else if (currentView === 'suppliers') {
                renderSuppliersView();
            } else if (currentView === 'customers') {
                renderCustomersView();
            } else if (currentView === 'sales-dispatch') {
                renderSalesDispatchView();

            } else if (currentView === 'production-wip') {
                renderProductionWIPView();
            } else if (currentView === 'data-management') {
                renderDataManagementView();
            } else if (currentView === 'calculator') {
                renderCalculatorView();
            }
        }

        // --- CALCULATOR VIEW ---
        function renderCalculatorView() {
            const container = document.getElementById('calculator-view');
            if (!container) return;

            // Prep ingredients list
            const ingredients = [
                ...(appState.inventory.rawMaterials || []),
                ...(appState.inventory.packingMaterials || []),
                ...(appState.inventory.labels || [])
            ].map(i => ({
                id: i.id,
                name: i.name,
                price: i.currentAverageCost || i.price,
                unit: i.unit,
                category: i.category // implicit
            })).sort((a, b) => a.name.localeCompare(b.name));

            container.innerHTML = `
                <div class="h-full flex flex-col p-6">
                    <h2 class="text-3xl font-bold mb-6 text-gray-800 flex items-center gap-2">
                        <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                        Advanced Production Cost Calculator
                    </h2>
                    
                    <div class="flex flex-col lg:flex-row gap-6 h-full">
                        <!-- Left: Builder -->
                        <div class="flex-1 bg-white rounded-lg shadow p-6 flex flex-col">
                            <div class="mb-4">
                                <label class="block text-sm font-bold mb-1">Product Name (for Report)</label>
                                <input type="text" id="calc-product-name" class="w-full p-2 border rounded font-bold text-gray-800" placeholder="Enter Product Name">
                            </div>

                            <div class="flex justify-between items-center mb-4 border-b pb-2">
                                <h3 class="text-lg font-bold">Ingredients & Materials</h3>
                                <div class="flex gap-2">
                                    <button onclick="importFormulaToCalculator()" class="px-2 py-1 bg-purple-600 text-white rounded hover:bg-purple-700 text-xs font-bold">Import Formula</button>
                                    <select id="calc-load-select" class="text-xs border p-1 rounded" onchange="loadCalculatorProduct(this.value)">
                                        <option value="">Load Saved...</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="overflow-y-auto flex-1 mb-4 max-h-[400px]">
                                <table class="min-w-full text-sm">
                                    <thead class="bg-gray-50 sticky top-0">
                                        <tr>
                                            <th class="p-2 text-left">Item</th>
                                            <th class="p-2 text-right">Cost/Unit</th>
                                            <th class="p-2 text-right w-32">Quantity</th>
                                            <th class="p-2 text-right">Total</th>
                                            <th class="p-2"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="calc-rows">
                                        <!-- Rows go here -->
                                    </tbody>
                                </table>
                            </div>
                            
                            <button onclick="addCalculatorRow()" class="w-full py-2 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 hover:border-blue-500 hover:text-blue-500 font-bold mb-4">+ Add Ingredient</button>
                            
                            <h4 class="font-bold text-sm text-gray-700 mb-2">Additional Costs (Optional)</h4>
                            <div class="grid grid-cols-2 lg:grid-cols-3 gap-4 border-t pt-4">
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase">Labour</label>
                                    <input type="number" id="calc-labour" value="0" class="w-full p-2 border rounded font-mono" oninput="recalcCalculator()">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase">Other Exp</label>
                                    <input type="number" id="calc-expenses" value="0" class="w-full p-2 border rounded font-mono" oninput="recalcCalculator()">
                                </div>
                                 <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase">Packaging/Bottles</label>
                                    <input type="number" id="calc-packaging" value="0" class="w-full p-2 border rounded font-mono" oninput="recalcCalculator()">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase">Freight</label>
                                    <input type="number" id="calc-freight" value="0" class="w-full p-2 border rounded font-mono" oninput="recalcCalculator()">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase">Export Tariff</label>
                                    <input type="number" id="calc-tariff" value="0" class="w-full p-2 border rounded font-mono" oninput="recalcCalculator()">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase">Margin (%)</label>
                                    <input type="number" id="calc-margin" value="20" class="w-full p-2 border rounded font-mono" oninput="recalcCalculator()">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Right: Summary -->
                        <div class="w-full lg:w-96 bg-gray-800 text-white rounded-lg shadow p-6 flex flex-col sticky top-6 h-fit">
                            <h3 class="text-xl font-bold mb-6 text-gray-200">Cost Breakdown</h3>
                            
                            <div class="space-y-4 mb-8 flex-grow">
                                <div class="flex justify-between items-end">
                                    <span class="text-gray-400 text-sm">Raw Material Cost</span>
                                    <span class="text-lg font-mono" id="summary-material-cost">Rs. 0.00</span>
                                </div>
                                <div class="border-t border-gray-600 my-2"></div>
                                <div class="flex justify-between items-end">
                                    <span class="text-gray-300 font-bold">Total Production Cost</span>
                                    <span class="text-xl font-mono font-bold text-yellow-400" id="summary-total-cost">Rs. 0.00</span>
                                </div>
                                <div class="flex justify-between items-end">
                                    <span class="text-green-400 text-sm">Margin Amount</span>
                                    <span class="text-lg font-mono text-green-400" id="summary-margin-amt">Rs. 0.00</span>
                                </div>
                            </div>
                            
                            <div class="bg-gray-700 p-4 rounded-lg">
                                <p class="text-xs text-gray-400 uppercase mb-1">Recommended Selling Price</p>
                                <p class="text-3xl font-mono font-bold text-white" id="summary-final-price">Rs. 0.00</p>
                            </div>
                            
                                <button onclick="saveCalculatorProduct()" class="flex-1 py-2 bg-blue-600 hover:bg-blue-500 rounded text-sm">Save</button>
                                <button onclick="exportCalculatorPDF()" class="flex-1 py-3 bg-gray-600 hover:bg-gray-500 rounded text-xs font-bold">Simple PDF</button>
                                <button onclick="exportCalculatorExcel()" class="flex-1 py-3 bg-green-600 hover:bg-green-500 rounded text-xs font-bold">Detailed Excel</button>
                            </div>
                            <div class="mt-2 text-center">
                                <button onclick="exportCalculatorDetailedPDF()" class="w-full py-2 bg-indigo-600 hover:bg-indigo-500 rounded text-xs font-bold text-white">Download Detailed PDF Report</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Store ingredients in window for row generation
            window.calcIngredients = ingredients;
            renderCalculatorSavedList();
            addCalculatorRow(); // Add first empty row
        }

        function importFormulaToCalculator() {
            if (!window.isFormulaUnlocked) {
                // Reuse existing password modal logic if possible, or simple prompt
                // Assuming handlePasswordSubmit sets isFormulaUnlocked = true
                // If not exposed, we'll try to trigger the modal.
                // Let's use a custom prompt for now to be safe and simple.
                const password = prompt("Enter Formula Password:");
                if (password !== "MIKLENS2016") { // Same password as formulation
                    showAlert("Incorrect Password");
                    return;
                }
                window.isFormulaUnlocked = true;
            }

            // Show Formula Selection
            const formulas = appState.formulas || [];
            if (formulas.length === 0) { showAlert("No formulas found."); return; }

            // Create temporary modal
            const modalHtml = `
                <div id="importFormulaModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
                    <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
                        <h3 class="text-lg font-bold mb-4">Select Formula</h3>
                        <div class="mb-4 max-h-60 overflow-y-auto">
                            ${formulas.map(f => `<button onclick="loadFormulaIntoCalc(${f.id})" class="w-full text-left p-2 hover:bg-gray-100 border-b">${f.name}</button>`).join('')}
                        </div>
                        <button onclick="document.getElementById('importFormulaModal').remove()" class="w-full py-2 bg-gray-300 rounded">Cancel</button>
                    </div>
                </div>
             `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        window.loadFormulaIntoCalc = function (formulaId) {
            const formula = appState.formulas.find(f => f.id === formulaId);
            if (formula) {
                document.getElementById('importFormulaModal').remove();
                document.getElementById('calc-product-name').value = formula.name;

                const tbody = document.getElementById('calc-rows');
                tbody.innerHTML = '';

                formula.ingredients.forEach(ing => {
                    const row = document.createElement('tr');
                    const item = findItem('rawMaterials', ing.itemId) || findItem('packingMaterials', ing.itemId) || findItem('finishedGoods', ing.itemId);
                    // Helper to find item across categories

                    // If helper not robust, we might fallback. But assume findItem works with generic if updated, otherwise loop.
                    // Re-implementing specific find for safety:
                    let foundItem = null;
                    ['rawMaterials', 'packingMaterials', 'labels'].forEach(cat => {
                        if (foundItem) return;
                        const i = (appState.inventory[cat] || []).find(x => x.id === ing.itemId);
                        if (i) foundItem = i;
                    });

                    if (foundItem) {
                        const price = foundItem.currentAverageCost || foundItem.price;
                        row.innerHTML = `
                            <td class="p-2">
                                <select class="w-full p-1 border rounded text-sm" onchange="updateCalcRow(this)">
                                    <option value="${foundItem.id}">${foundItem.name}</option>
                                </select>
                            </td>
                            <td class="p-2 text-right text-gray-600 font-mono text-xs">Rs. ${price.toFixed(2)}</td>
                            <td class="p-2"><input type="number" step="0.001" value="${ing.quantity}" class="w-full p-1 border rounded text-right font-mono" oninput="recalcCalculator()"></td>
                            <td class="p-2 text-right font-bold text-gray-800 font-mono total-cell">Rs. ${(price * ing.quantity).toFixed(2)}</td>
                            <td class="p-2 text-center"><button onclick="this.closest('tr').remove(); recalcCalculator()" class="text-red-500 hover:text-red-700">&times;</button></td>
                        `;
                        tbody.appendChild(row);
                    }
                });
                if (tbody.children.length === 0) addCalculatorRow();
                // Trigger recalculation to update costs
                setTimeout(() => recalcCalculator(), 100);
                showAlert("Formula imported successfully.");
            }
        };

        window.addCalculatorRow = function () {
            const tbody = document.getElementById('calc-rows');
            if (!tbody) return;
            const rowId = 'row-' + Date.now();
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="p-2">
                    <select class="w-full p-1 border rounded text-sm" onchange="updateCalcRow('${rowId}', this)">
                        <option value="">Select Ingredient...</option>
                        ${window.calcIngredients.map(i => `<option value="${i.id}" data-price="${i.currentAverageCost || i.price}" data-unit="${i.unit}">${i.name} (Rs. ${(i.currentAverageCost || i.price).toFixed(2)}/${i.unit})</option>`).join('')}
                    </select>
                </td>
                <td class="p-2 text-right font-mono text-xs" id="${rowId}-price">-</td>
                <td class="p-2 text-right">
                    <input type="number" class="w-24 p-1 border rounded text-right text-sm" placeholder="Qty" oninput="recalcCalculator()" id="${rowId}-qty">
                 </td>
                <td class="p-2 text-right font-mono font-bold text-sm" id="${rowId}-total">Rs. 0.00</td>
                <td class="p-2 text-center">
                    <button onclick="this.closest('tr').remove(); recalcCalculator();" class="text-red-400 hover:text-red-600">&times;</button>
                </td>
            `;
            tbody.appendChild(row);
        };

        window.updateCalcRow = function (rowId, select) {
            const option = select.options[select.selectedIndex];
            const price = parseFloat(option.dataset.price) || 0;
            document.getElementById(`${rowId}-price`).textContent = `Rs. ${price.toFixed(2)}`;
            recalcCalculator();
        };

        window.recalcCalculator = function () {
            let materialCost = 0;
            const rows = document.querySelectorAll('#calc-rows tr');
            rows.forEach(row => {
                const select = row.querySelector('select');
                const qtyInput = row.querySelector('input[type="number"]');
                if (select && qtyInput) {
                    let price = 0;
                    // Check if select has data-price attribute
                    if (select.selectedIndex > 0 && select.options[select.selectedIndex].dataset.price) {
                        price = parseFloat(select.options[select.selectedIndex].dataset.price) || 0;
                    } else {
                        // For imported formulas, read from the price cell
                        const priceCell = row.querySelector('td:nth-child(2)');
                        if (priceCell) {
                            const priceText = priceCell.textContent.replace('Rs.', '').replace(',', '').trim();
                            price = parseFloat(priceText) || 0;
                        }
                    }
                    const qty = parseFloat(qtyInput.value) || 0;
                    const total = price * qty;
                    const totalCell = row.querySelector('td:nth-child(4)') || row.querySelector('.total-cell');
                    if (totalCell) {
                        totalCell.textContent = `Rs. ${total.toFixed(2)}`;
                    }
                    materialCost += total;
                }
            });

            const labour = parseFloat(document.getElementById('calc-labour').value) || 0;
            const expenses = parseFloat(document.getElementById('calc-expenses').value) || 0;
            const packaging = parseFloat(document.getElementById('calc-packaging').value) || 0;
            const freight = parseFloat(document.getElementById('calc-freight').value) || 0;
            const tariff = parseFloat(document.getElementById('calc-tariff').value) || 0;

            const totalCost = materialCost + labour + expenses + packaging + freight + tariff;

            const marginPercent = parseFloat(document.getElementById('calc-margin').value) || 0;
            const marginAmt = totalCost * (marginPercent / 100);
            const finalPrice = totalCost + marginAmt;

            document.getElementById('summary-material-cost').textContent = `Rs. ${materialCost.toFixed(2)}`;
            document.getElementById('summary-total-cost').textContent = `Rs. ${totalCost.toFixed(2)}`;
            document.getElementById('summary-margin-amt').textContent = `Rs. ${marginAmt.toFixed(2)}`;
            document.getElementById('summary-final-price').textContent = `Rs. ${finalPrice.toFixed(2)}`;
        };

        window.saveCalculatorProduct = function () {
            const name = prompt("Enter Product Name to Save Calculation:");
            if (!name) return;

            if (!appState.savedCalculations) appState.savedCalculations = {};

            const rows = [];
            document.querySelectorAll('#calc-rows tr').forEach(row => {
                const select = row.querySelector('select');
                const qty = row.querySelector('input').value;
                if (select && select.value) {
                    rows.push({ id: select.value, qty: qty });
                }
            });

            const data = {
                rows: rows,
                labour: document.getElementById('calc-labour').value,
                expenses: document.getElementById('calc-expenses').value,
                packaging: document.getElementById('calc-packaging').value,
                freight: document.getElementById('calc-freight').value,
                tariff: document.getElementById('calc-tariff').value,
                margin: document.getElementById('calc-margin').value
            };

            appState.savedCalculations[name] = data;
            saveState();
            showAlert(`Calculation for ${name} saved!`);
            renderCalculatorSavedList();
        };

        function renderCalculatorSavedList() {
            const select = document.getElementById('calc-load-select');
            if (!select) return;

            const saved = appState.savedCalculations || {};
            select.innerHTML = '<option value="">Load Saved Calculation...</option>' +
                Object.keys(saved).map(name => `<option value="${name}">${name}</option>`).join('');
        }

        window.loadCalculatorProduct = function (name) {
            if (!name) return;
            const data = appState.savedCalculations[name];
            if (!data) return;

            document.getElementById('calc-rows').innerHTML = '';
            data.rows.forEach(r => {
                window.addCalculatorRow();
                const rows = document.querySelectorAll('#calc-rows tr');
                const lastRow = rows[rows.length - 1];
                const select = lastRow.querySelector('select');
                const qtyInput = lastRow.querySelector('input');
                select.value = r.id;
                qtyInput.value = r.qty;

                // Trigger update manually
                const rowId = lastRow.querySelector('select').getAttribute('onchange').match(/'([^']+)'/)[1];
                window.updateCalcRow(rowId, select);
            });

            document.getElementById('calc-labour').value = data.labour || 0;
            document.getElementById('calc-expenses').value = data.expenses || 0;
            document.getElementById('calc-packaging').value = data.packaging || 0;
            document.getElementById('calc-freight').value = data.freight || 0;
            document.getElementById('calc-tariff').value = data.tariff || 0;
            document.getElementById('calc-margin').value = data.margin || 20;

            recalcCalculator();
        };

        window.exportCalculatorPDF = function () {
            const doc = new jspdf.jsPDF();

            doc.setFontSize(18);
            doc.text("Production Cost Sheet", 14, 20);
            doc.setFontSize(10);
            doc.text(`Date: ${new Date().toLocaleDateString()}`, 14, 28);

            const rows = [];
            document.querySelectorAll('#calc-rows tr').forEach(row => {
                const select = row.querySelector('select');
                const qty = row.querySelector('input').value;
                const price = row.querySelector('td:nth-child(2)').textContent;
                const total = row.querySelector('td:nth-child(4)').textContent;

                if (select && select.selectedIndex > 0) {
                    const name = select.options[select.selectedIndex].text.split('(')[0].trim();
                    rows.push([name, price, qty, total]);
                }
            });

            doc.autoTable({
                startY: 35,
                head: [['Item', 'Cost/Unit', 'Qty', 'Total']],
                body: rows,
            });

            let finalY = doc.lastAutoTable.finalY + 10;

            const addSummaryLine = (label, val) => {
                doc.text(label, 14, finalY);
                doc.text(val, 150, finalY, { align: 'right' });
                finalY += 7;
            };

            addSummaryLine("Raw Material Cost:", document.getElementById('summary-material-cost').textContent);
            addSummaryLine("Labour Cost:", "Rs. " + document.getElementById('calc-labour').value);
            addSummaryLine("Other Expenses:", "Rs. " + document.getElementById('calc-expenses').value);
            addSummaryLine("Packaging Cost:", "Rs. " + document.getElementById('calc-packaging').value);
            addSummaryLine("Freight:", "Rs. " + document.getElementById('calc-freight').value);
            addSummaryLine("Tariff/Duty:", "Rs. " + document.getElementById('calc-tariff').value);

            finalY += 3;
            doc.setFont(undefined, 'bold');
            addSummaryLine("Total Production Cost:", document.getElementById('summary-total-cost').textContent);

            doc.setFont(undefined, 'normal');
            addSummaryLine(`Margin (${document.getElementById('calc-margin').value}%):`, document.getElementById('summary-margin-amt').textContent);

            doc.setFont(undefined, 'bold');
            doc.setFontSize(14);
            finalY += 5;
            addSummaryLine("Final Selling Price:", document.getElementById('summary-final-price').textContent);

            doc.save("Production_Cost_Sheet.pdf");
        };

        window.exportCalculatorExcel = function () {
            try {
                if (typeof XLSX === 'undefined') {
                    showAlert("Excel library (XLSX) is not loaded. Please check your internet connection and reload.");
                    return;
                }

                const wb = XLSX.utils.book_new();
                const ws_data = [];

                // Header
                ws_data.push(["Miklens Bio - Detailed Production Cost Sheet"]);
                ws_data.push(["Generated On", new Date().toLocaleString()]);
                ws_data.push([]);

                const nameInput = document.getElementById('calc-product-name');
                const qtyInput = document.getElementById('calc-quantity');
                const unitInput = document.getElementById('calc-unit');

                const productName = (nameInput && nameInput.value) ? nameInput.value : "Cost Calculation";
                const targetQty = (qtyInput && qtyInput.value) ? parseFloat(qtyInput.value) : 100;
                const targetUnit = (unitInput && unitInput.value) ? unitInput.value : "Ltr";

                ws_data.push(["Product Name", productName]);
                ws_data.push(["Target Quantity", `${targetQty} ${targetUnit}`]);
                ws_data.push([]);

                // Collect Data
                const categorizedRows = {
                    'Raw Materials': [],
                    'Packing Materials': [],
                    'Labels': [],
                    'Other': []
                };

                let totalRawMaterialCost = 0;
                let totalPackingCost = 0;

                const tableRows = document.querySelectorAll('#calc-rows tr');
                tableRows.forEach(row => {
                    const select = row.querySelector('select');
                    const rowQtyInput = row.querySelector('input'); // Rename to avoid conflict
                    if (!select || !rowQtyInput || select.selectedIndex <= 0) return;

                    const qty = parseFloat(rowQtyInput.value) || 0;
                    const itemText = select.options[select.selectedIndex].text;
                    const name = itemText.split('(')[0].trim();
                    const unitMatch = itemText.match(/\(([^)]+)\)/);
                    const unit = unitMatch ? unitMatch[1] : '';

                    const priceCell = row.querySelector('td:nth-child(2)');
                    const totalCell = row.querySelector('td:nth-child(4)') || row.querySelector('.total-cell');

                    const unitCostText = priceCell ? priceCell.textContent.replace('Rs.', '').replace(',', '').trim() : "0";
                    const totalCostText = totalCell ? totalCell.textContent.replace('Rs.', '').replace(',', '').trim() : "0";

                    const unitCost = parseFloat(unitCostText) || 0;
                    const totalCost = parseFloat(totalCostText) || 0;

                    const itemId = select.value;
                    let category = 'Other';

                    if (itemId) {
                        const idNum = parseFloat(itemId);
                        // Safe access with optional chaining and fallback to empty array
                        const rm = appState.inventory.rawMaterials || [];
                        const pm = appState.inventory.packingMaterials || [];
                        const lbl = appState.inventory.labels || [];

                        // Loose equality check (==) to catch string vs number ID mismatches
                        if (rm.some(i => i.id == idNum)) category = 'Raw Materials';
                        else if (pm.some(i => i.id == idNum)) category = 'Packing Materials';
                        else if (lbl.some(i => i.id == idNum)) category = 'Labels';
                    }

                    categorizedRows[category].push({ name, qty, unit, unitCost, totalCost });

                    if (category === 'Raw Materials') totalRawMaterialCost += totalCost;
                    else if (category === 'Packing Materials' || category === 'Labels') totalPackingCost += totalCost;
                });

                // Raw Materials Section
                if (categorizedRows['Raw Materials'].length > 0) {
                    ws_data.push(["Raw Materials"]);
                    ws_data.push(["Item Name", "Required Qty", "Unit", "Unit Cost", "Total Cost"]);
                    categorizedRows['Raw Materials'].forEach(item => {
                        ws_data.push([item.name, item.qty, item.unit, item.unitCost, item.totalCost]);
                    });
                    ws_data.push(["", "", "", "Total RM Cost", totalRawMaterialCost]);
                    ws_data.push([]);
                }

                // Packing & Labels Section
                const packingLabelRows = [
                    ...categorizedRows['Packing Materials'],
                    ...categorizedRows['Labels']
                ];

                if (packingLabelRows.length > 0) {
                    ws_data.push(["Packing & Labels"]);
                    ws_data.push(["Item Name", "Required Qty", "Unit", "Unit Cost", "Total Cost"]);
                    packingLabelRows.forEach(item => {
                        ws_data.push([item.name, item.qty, item.unit, item.unitCost, item.totalCost]);
                    });
                    ws_data.push(["", "", "", "Total Packing Cost", totalPackingCost]);
                    ws_data.push([]);
                }

                // Other Items (if any)
                if (categorizedRows['Other'].length > 0) {
                    ws_data.push(["Other Items"]);
                    ws_data.push(["Item Name", "Required Qty", "Unit", "Unit Cost", "Total Cost"]);
                    categorizedRows['Other'].forEach(item => {
                        ws_data.push([item.name, item.qty, item.unit, item.unitCost, item.totalCost]);
                    });
                    ws_data.push([]);
                }

                // Summary - Use textContent for resilience
                const getTextVal = (id) => {
                    const el = document.getElementById(id);
                    return el ? parseFloat(el.textContent.replace('Rs.', '').replace(',', '').trim()) || 0 : 0;
                };

                const totalProductionCost = getTextVal('summary-total-cost');
                const costPerUnit = targetQty > 0 ? totalProductionCost / targetQty : 0;

                ws_data.push(["SUMMARY"]);
                ws_data.push(["Total Production Cost", totalProductionCost]);
                ws_data.push(["Cost Per Unit", costPerUnit]);

                const ws = XLSX.utils.aoa_to_sheet(ws_data);
                XLSX.utils.book_append_sheet(wb, ws, "Cost Sheet");
                const safeName = productName.replace(/[^a-z0-9]/gi, '_');
                XLSX.writeFile(wb, `Cost_Sheet_${safeName}.xlsx`);

            } catch (err) {
                console.error("Export failed:", err);
                showAlert("Failed to export Excel: " + err.message);
            }
        };

        window.exportCalculatorDetailedPDF = function () {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Header
            doc.setFontSize(18);
            doc.setTextColor(44, 62, 80);
            doc.text("Miklens Bio - Detailed Production Cost Sheet", 14, 20);

            doc.setFontSize(10);
            doc.setTextColor(100);
            doc.text(`Generated on: ${new Date().toLocaleString()}`, 14, 28);

            const prodName = document.getElementById('calc-product-name').value || "Cost Calculation";
            const targetQty = parseFloat(document.getElementById('calc-quantity').value) || 100;
            const targetUnit = document.getElementById('calc-unit').value || "Ltr";

            doc.setFontSize(12);
            doc.setTextColor(0);
            doc.text(`Product Name: ${prodName}`, 14, 38);
            doc.text(`Target Quantity: ${targetQty} ${targetUnit}`, 14, 45);

            // Collect and categorize data
            const categorizedRows = {
                'Raw Materials': [],
                'Packing Materials': [],
                'Labels': []
            };

            let totalRawMaterialCost = 0;
            let totalPackingCost = 0;

            document.querySelectorAll('#calc-rows tr').forEach(row => {
                const select = row.querySelector('select');
                const qtyInput = row.querySelector('input');
                if (!select || !qtyInput || select.selectedIndex <= 0) return;

                const qty = parseFloat(qtyInput.value) || 0;
                const itemText = select.options[select.selectedIndex].text;
                const name = itemText.split('(')[0].trim();
                const unit = itemText.match(/\(([^)]+)\)/)?.[1] || '';

                const priceCell = row.querySelector('td:nth-child(2)');
                const totalCell = row.querySelector('td:nth-child(4)');

                const unitCost = parseFloat(priceCell.textContent.replace('Rs. ', '').replace(',', '')) || 0;
                const totalCost = parseFloat(totalCell.textContent.replace('Rs. ', '').replace(',', '')) || 0;

                const itemId = select.value;
                let category = null;

                if (itemId) {
                    const idNum = parseFloat(itemId);
                    if (appState.inventory.rawMaterials.some(i => i.id === idNum)) category = 'Raw Materials';
                    else if (appState.inventory.packingMaterials.some(i => i.id === idNum)) category = 'Packing Materials';
                    else if (appState.inventory.labels.some(i => i.id === idNum)) category = 'Labels';
                }

                if (category) {
                    categorizedRows[category].push([name, `${qty} ${unit}`, `Rs. ${unitCost.toFixed(2)}`, `Rs. ${totalCost.toFixed(2)}`]);

                    if (category === 'Raw Materials') totalRawMaterialCost += totalCost;
                    else totalPackingCost += totalCost;
                }
            });

            let currentY = 55;

            // Raw Materials Table
            if (categorizedRows['Raw Materials'].length > 0) {
                doc.setFontSize(14);
                doc.setTextColor(0);
                doc.text("Raw Materials", 14, currentY);
                currentY += 5;

                doc.autoTable({
                    startY: currentY,
                    head: [['Item Name', 'Quantity Required', 'Unit Cost (Avg)', 'Total Cost']],
                    body: categorizedRows['Raw Materials'],
                    theme: 'striped',
                    headStyles: { fillColor: [52, 152, 219], textColor: 255 },
                    foot: [['', '', 'Total RM Cost:', `Rs. ${totalRawMaterialCost.toFixed(2)}`]],
                    footStyles: { fontStyle: 'bold', fillColor: [230, 230, 230] }
                });
                currentY = doc.lastAutoTable.finalY + 10;
            }

            // Packing & Labels Table
            const packingLabelRows = [
                ...categorizedRows['Packing Materials'],
                ...categorizedRows['Labels']
            ];

            if (packingLabelRows.length > 0) {
                doc.setFontSize(14);
                doc.text("Packing / Label", 14, currentY);
                currentY += 5;

                doc.autoTable({
                    startY: currentY,
                    head: [['Item Name', 'Quantity', 'Unit Cost', 'Total Cost']],
                    body: packingLabelRows,
                    theme: 'striped',
                    headStyles: { fillColor: [46, 204, 113], textColor: 255 },
                    foot: [['', '', 'Total Packing Cost:', `Rs. ${totalPackingCost.toFixed(2)}`]],
                    footStyles: { fontStyle: 'bold', fillColor: [230, 230, 230] }
                });
                currentY = doc.lastAutoTable.finalY + 15;
            }

            // Cost Summary
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text("Cost Summary", 14, currentY);
            currentY += 10;

            const totalProductionCost = parseFloat(document.getElementById('summary-total-cost').textContent.replace('Rs. ', '').replace(',', '')) || 0;
            const costPerUnit = totalProductionCost / targetQty;

            doc.setFontSize(11);
            doc.setFont(undefined, 'normal');
            doc.text(`Total Production Cost:`, 14, currentY);
            doc.text(`INR ${totalProductionCost.toFixed(2)}`, 180, currentY, { align: 'right' });
            currentY += 7;

            doc.text(`Cost Per Unit (${targetUnit}):`, 14, currentY);
            doc.text(`INR ${costPerUnit.toFixed(2)}`, 180, currentY, { align: 'right' });

            doc.save(`Cost_Sheet_${prodName.replace(/ /g, '_')}.pdf`);
        };

        // Helper to export CSVs
        window.exportCustomersCSV = function () {
            const data = appState.customers || [];
            if (data.length === 0) { showAlert("No customers to export"); return; }
            const csv = "Name,Type,Location,GST\n" + data.map(c => `"${c.name}","${c.type || 'Standard'}","${c.location || ''}","${c.gst || ''}"`).join("\n");
            downloadCSV(csv, "customers.csv");
        };

        window.exportSuppliersCSV = function () {
            const data = appState.suppliers || [];
            if (data.length === 0) { showAlert("No suppliers to export"); return; }
            const csv = "Name,Contact,Phone,Email,Approved\n" + data.map(s => `"${s.name}","${s.contact || ''}","${s.phone || ''}","${s.email || ''}","${s.approved ? 'Yes' : 'No'}"`).join("\n");
            downloadCSV(csv, "suppliers.csv");
        };

        window.exportSalesCSV = function () {
            // Simplified export
            const data = appState.transactions.filter(t => t.type === 'dispatch');
            if (data.length === 0) { showAlert("No sales to export"); return; }
            const csv = "Date,Customer,Item,Qty,Batch,Invoice,Subtype\n" +
                data.map(t => {
                    const cName = appState.customers.find(c => c.id == t.customerId)?.name || 'Unknown';
                    const iName = findItem('finishedGoods', t.itemId)?.name || 'Unknown';
                    return `${t.date},"${cName}","${iName}",${t.quantity},"${t.batchNo}","${t.invoiceNo}","${t.subtype}"`;
                }).join("\n");
            downloadCSV(csv, "sales_report.csv");
        };

        window.undoLastItemAction = function (category, itemId, type) {
            // Find last transaction of this type for this item
            // This is a "best effort" undo that reverses the transaction effect
            const txIndex = appState.transactions.slice().reverse().findIndex(t => t.itemId === itemId && t.category === category && t.type === type);
            if (txIndex === -1) { showAlert("No recent action found to undo."); return; }

            // Actual index in main array
            const actualIndex = appState.transactions.length - 1 - txIndex;
            const tx = appState.transactions[actualIndex];

            // Remove it
            appState.transactions.splice(actualIndex, 1);
            saveState();
            logActivity('Undo', `Undid ${type} for item ${itemId} (Qty: ${tx.quantity})`);
            showAlert(`Undid last ${type} successfully.`);
            renderInventoryView(category);
            // Also refresh batch details if open
            if (document.getElementById('batchDetailsModal')) showBatchDetails(itemId, category);
        };
        function renderDataManagementView() {
            const container = document.getElementById('data-management-view');
            if (!container) return;
            container.innerHTML = `
                <div class="p-6">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800">Data Management</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-lg shadow hover:shadow-md transition-shadow">
                            <h3 class="text-xl font-bold mb-4 text-blue-600">Audit & Logs</h3>
                            <p class="text-gray-600 mb-4">View detailed records of all system activities, including stock changes and user logins.</p>

                        </div>
                        <div class="bg-white p-6 rounded-lg shadow hover:shadow-md transition-shadow">
                            <h3 class="text-xl font-bold mb-4 text-green-600">Data Backup</h3>
                            <p class="text-gray-600 mb-4">Manually sync your data to the cloud or export a local backup.</p>
                            <button onclick="forceFullSync()" class="w-full py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 font-semibold mb-2">Force Cloud Sync</button>
                        </div>
                         <div class="bg-white p-6 rounded-lg shadow hover:shadow-md transition-shadow">
                            <h3 class="text-xl font-bold mb-4 text-purple-600">Bulk Operations</h3>
                            <p class="text-gray-600 mb-4">Batch operations for inventory management.</p>
                             <button onclick="showView('raw-materials')" class="w-full py-2 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 font-semibold">Go to Bulk Entry</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderDashboard() {
            const container = document.getElementById('dashboard-view');
            let stockAlerts = [];
            let expiryAlerts = [];
            let categoryTotals = {};
            let expiryRiskValue = 0;
            const today = getStartOfDay(getToday());
            const thirtyDaysFromNow = new Date(today);
            thirtyDaysFromNow.setUTCDate(today.getUTCDate() + 30);

            // 1. Calculate Summary Metrics
            Object.keys(appState.inventory).forEach(cat => {
                let total = 0;
                appState.inventory[cat].forEach(item => {
                    const { closingStock } = calculateStock(item, cat, selectedDate);
                    // Stock Alerts
                    if (item.minStockLevel !== undefined && closingStock < item.minStockLevel) {
                        stockAlerts.push({ item, category: cat, closingStock });
                    }

                    const itemValue = (closingStock > 0 ? closingStock : 0) * (item.currentAverageCost || item.price);
                    total += itemValue;

                    // Expiry Analysis
                    if ((cat === 'rawMaterials' || cat === 'finishedGoods') && item.expiryDate) {
                        const expiryDate = getStartOfDay(item.expiryDate);
                        if (expiryDate <= thirtyDaysFromNow) {
                            const diffTime = expiryDate - today;
                            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                            expiryAlerts.push({ item, diffDays });
                            expiryRiskValue += itemValue;
                        }
                    }
                });
                categoryTotals[cat] = total;
            });

            expiryAlerts.sort((a, b) => a.diffDays - b.diffDays);
            const recentTransactions = [...appState.transactions].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 5);

            // 2. Calculate Wastage Stats
            let totalConsumption = 0;
            let totalWastage = 0;
            const currentMonthStart = new Date(today.getFullYear(), today.getMonth(), 1);

            appState.transactions.forEach(tx => {
                const txDate = new Date(tx.date);
                if (txDate >= currentMonthStart && tx.type === 'consume') {
                    const item = findItem(tx.category, tx.itemId);
                    if (item) {
                        const value = tx.quantity * (item.currentAverageCost || item.price);
                        totalConsumption += value;
                        // Check subtypes for wastage
                        if (['process_loss', 'spillage', 'expired', 'qc_rejection'].includes(tx.subtype)) {
                            totalWastage += value;
                        }
                    }
                }
            });
            const wastagePercentage = totalConsumption > 0 ? (totalWastage / totalConsumption) * 100 : 0;

            // 3. Render HTML
            container.innerHTML = `
            <h2 class="text-3xl font-bold mb-6">Executive Dashboard</h2>
            
            <!-- KPI Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                ${Object.keys(categoryTotals).map(cat => `
                    <div class="bg-white p-6 rounded-lg shadow border-l-4 border-blue-500">
                        <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider">${cat.replace(/([A-Z])/g, ' $1')}</h3>
                        <p class="text-2xl font-bold text-gray-800">₹ ${categoryTotals[cat].toLocaleString('en-IN', { maximumFractionDigits: 0 })}</p>
                    </div>`).join('')}
                
                 <div class="bg-white p-6 rounded-lg shadow border-l-4 border-red-500">
                    <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider">Expiry Risk Value</h3>
                    <p class="text-2xl font-bold text-red-600">₹ ${expiryRiskValue.toLocaleString('en-IN', { maximumFractionDigits: 0 })}</p>
                    <p class="text-xs text-gray-400">Items expiring in 30 days</p>
                </div>
                 <div class="bg-white p-6 rounded-lg shadow border-l-4 border-orange-500">
                    <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider">Monthly Wastage</h3>
                    <p class="text-2xl font-bold text-orange-600">${wastagePercentage.toFixed(1)}%</p>
                    <p class="text-xs text-gray-400">Of total consumption (₹${totalWastage.toFixed(0)})</p>
                </div>
            </div>

            <!-- Main Charts Row -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                <!-- Stock Alerts -->
                <div class="bg-white p-6 rounded-lg shadow lg:col-span-1">
                    <h3 class="text-lg font-bold mb-4 flex items-center">
                        <span class="w-2 h-2 bg-red-500 rounded-full mr-2"></span> Stock Alerts
                    </h3>
                    <div class="max-h-64 overflow-y-auto">
                        ${stockAlerts.length > 0 ? stockAlerts.map(alert => `
                            <div class="p-3 border-b border-gray-100 flex justify-between items-center hover:bg-gray-50">
                                <div>
                                    <div class="font-semibold text-sm">${alert.item.name}</div>
                                    <div class="text-xs text-gray-500">Min: ${alert.item.minStockLevel}</div>
                                </div>
                                <span class="px-2 py-1 text-xs font-bold rounded bg-red-100 text-red-700">
                                    ${alert.closingStock.toFixed(2)} ${alert.item.unit}
                                </span>
                            </div>`).join('') : '<p class="text-gray-400 text-center py-4">All stocks healthy.</p>'}
                    </div>
                </div>

                <!-- Inventory Value Breakdown -->
                <div class="bg-white p-6 rounded-lg shadow lg:col-span-1">
                    <h3 class="text-lg font-bold mb-4">Value Distribution</h3>
                    <canvas id="inventoryValuePieChart" height="200"></canvas>
                </div>

                <!-- Monthly Trend -->
                 <div class="bg-white p-6 rounded-lg shadow lg:col-span-1">
                    <h3 class="text-lg font-bold mb-4">Consumption Trend</h3>
                    <canvas id="monthlyConsumptionBarChart" height="200"></canvas>
                </div>
            </div>
            
            <!-- Secondary Charts & Recent Tx -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                 <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-lg font-bold mb-4">Top 10 Consumed Items (This Month)</h3>
                    <canvas id="topValuableItemsBarChart"></canvas>
                </div>
                
                 <div class="bg-white p-6 rounded-lg shadow">
                     <h3 class="text-lg font-bold mb-4">Recent Transactions</h3>
                     <div class="overflow-y-auto max-h-80">
                         <table class="min-w-full text-xs text-left">
                            <thead class="bg-gray-50 font-semibold text-gray-600">
                                <tr>
                                    <th class="p-2">Date</th>
                                    <th class="p-2">Item</th>
                                    <th class="p-2">Action</th>
                                    <th class="p-2 text-right">Qty</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${recentTransactions.map(tx => {
                const item = findItem(tx.category, tx.itemId);
                let color = tx.type.includes('receive') ? 'text-green-600' : 'text-red-600';
                return `
                                    <tr class="border-b border-gray-100 hover:bg-gray-50">
                                        <td class="p-2 text-gray-500">${tx.date.split('T')[0]}</td>
                                        <td class="p-2 font-medium">${item ? item.name : 'Unknown'}</td>
                                        <td class="p-2 capitalize ${color}">${tx.type} <span class="text-xs text-gray-400 ml-1">${tx.subtype ? `(${tx.subtype})` : ''}</span></td>
                                        <td class="p-2 text-right font-mono">${tx.quantity.toFixed(2)}</td>
                                    </tr>`;
            }).join('')}
                            </tbody>
                         </table>
                         ${recentTransactions.length === 0 ? '<p class="text-center text-gray-400 py-4">No recent activity.</p>' : ''}
                     </div>
                </div>
            </div>

            <!-- Historical Analysis Section -->
            <div class="bg-white p-6 rounded-lg shadow mb-8">
                <div class="flex flex-col md:flex-row justify-between items-center mb-4">
                     <h3 class="text-lg font-bold">Historical Stock Analysis</h3>
                     <div class="w-full md:w-64 mt-2 md:mt-0">
                        <select id="historical-item-select" class="w-full p-2 border rounded-md text-sm">
                            <option value="">-- Select Item to Analyze --</option>
                            ${Object.keys(appState.inventory).flatMap(cat =>
                appState.inventory[cat].map(item => `<option value="${cat}-${item.id}">${item.name}</option>`)
            ).join('')}
                        </select>
                     </div>
                </div>
                <div class="h-64">
                    <canvas id="historicalStockLineChart"></canvas>
                </div>
            </div>
            `;

            renderCharts();

            document.getElementById('historical-item-select').addEventListener('change', (e) => {
                const [category, itemId] = e.target.value.split('-');
                if (category && itemId) {
                    renderHistoricalStockChart(category, parseFloat(itemId));
                } else {
                    if (historicalStockChart) historicalStockChart.destroy();
                }
            });
        }

        function renderCharts() {
            // 1. Value Breakdown
            const inventoryValueData = Object.keys(appState.inventory).map(cat => ({
                label: cat.replace(/([A-Z])/g, ' $1'),
                value: appState.inventory[cat].reduce((sum, item) => sum + (calculateStock(item, cat, selectedDate).closingStock > 0 ? calculateStock(item, cat, selectedDate).closingStock : 0) * (item.currentAverageCost || item.price), 0)
            })).filter(d => d.value > 0);

            const inventoryValueCtx = document.getElementById('inventoryValuePieChart').getContext('2d');
            if (inventoryValueChart) inventoryValueChart.destroy();
            inventoryValueChart = new Chart(inventoryValueCtx, {
                type: 'doughnut',
                data: {
                    labels: inventoryValueData.map(d => d.label),
                    datasets: [{
                        data: inventoryValueData.map(d => d.value),
                        backgroundColor: ['#3B82F6', '#10B981', '#F59E0B', '#EF4444'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    cutout: '60%',
                    plugins: { legend: { position: 'bottom', labels: { boxWidth: 12 } } }
                }
            });

            // 2. Monthly Consumption
            const monthlyConsumptionData = getMonthlyConsumptionData();
            const monthlyConsumptionCtx = document.getElementById('monthlyConsumptionBarChart').getContext('2d');
            if (monthlyConsumptionChart) monthlyConsumptionChart.destroy();
            monthlyConsumptionChart = new Chart(monthlyConsumptionCtx, {
                type: 'bar',
                data: {
                    labels: monthlyConsumptionData.map(d => d.month),
                    datasets: [{
                        label: 'Consumption (₹)',
                        data: monthlyConsumptionData.map(d => d.value),
                        backgroundColor: '#6366F1',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    scales: { y: { beginAtZero: true, grid: { display: false } }, x: { grid: { display: false } } },
                    plugins: { legend: { display: false } }
                }
            });

            // 3. Top Consumed Items (Reusing Top Valuation logic but filtering for consumption)
            const topConsumedData = getTopConsumedItemsData();
            const topValuableItemsCtx = document.getElementById('topValuableItemsBarChart').getContext('2d');
            if (topValuableItemsChart) topValuableItemsChart.destroy();
            topValuableItemsChart = new Chart(topValuableItemsCtx, {
                type: 'bar',
                data: {
                    labels: topConsumedData.map(d => d.name),
                    datasets: [{
                        label: 'Consumption Qty',
                        data: topConsumedData.map(d => d.quantity),
                        backgroundColor: '#EC4899',
                        borderRadius: 4
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    plugins: { legend: { display: false } }
                }
            });
        }

        function getTopConsumedItemsData() {
            // Aggregate consumption for current month
            const usageMap = {};
            const today = getStartOfDay(getToday());
            const currentMonthStart = new Date(today.getFullYear(), today.getMonth(), 1);

            appState.transactions.forEach(tx => {
                if (new Date(tx.date) >= currentMonthStart && (tx.type === 'consume' || tx.type === 'production-consume')) {
                    const key = `${tx.category}-${tx.itemId}`;
                    if (!usageMap[key]) {
                        const item = findItem(tx.category, tx.itemId);
                        if (item) {
                            usageMap[key] = { name: item.name, quantity: 0 };
                        }
                    }
                    if (usageMap[key]) usageMap[key].quantity += tx.quantity;
                }
            });

            return Object.values(usageMap).sort((a, b) => b.quantity - a.quantity).slice(0, 10);
        }

        // Helper placeholders for existing functions to maintain file integrity
        function getMonthlyConsumptionData() {
            const consumptionByMonth = {};
            const today = new Date();
            for (let i = 0; i < 6; i++) {
                const d = new Date(today.getFullYear(), today.getMonth() - i, 1);
                const monthKey = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                consumptionByMonth[monthKey] = 0;
            }

            appState.transactions.forEach(tx => {
                if (tx.type === 'consume' || tx.type === 'production-consume') {
                    const txDate = new Date(tx.date);
                    const monthKey = `${txDate.getFullYear()}-${String(txDate.getMonth() + 1).padStart(2, '0')}`;
                    if (consumptionByMonth.hasOwnProperty(monthKey)) {
                        const item = findItem(tx.category, tx.itemId);
                        if (item) {
                            consumptionByMonth[monthKey] += tx.quantity * item.price;
                        }
                    }
                }
            });

            return Object.keys(consumptionByMonth).sort().map(month => ({
                month: new Date(month).toLocaleString('default', { month: 'short', year: '2-digit' }),
                value: consumptionByMonth[month]
            }));
        }

        function getTopValuableItemsData() { // Kept for compatibility if called elsewhere, though replaced in chart
            let allItemsValue = [];
            Object.keys(appState.inventory).forEach(cat => {
                appState.inventory[cat].forEach(item => {
                    const { closingStock } = calculateStock(item, cat, selectedDate);
                    const value = (closingStock > 0 ? closingStock : 0) * item.price;
                    if (value > 0) {
                        allItemsValue.push({ name: item.name, value: value });
                    }
                });
            });
            return allItemsValue.sort((a, b) => b.value - a.value).slice(0, 5);
        }

        function renderHistoricalStockChart(category, itemId) {
            const item = findItem(category, itemId);
            if (!item) return;

            const today = getStartOfDay(getToday());
            const ninetyDaysAgo = new Date(today);
            ninetyDaysAgo.setUTCDate(today.getUTCDate() - 90);

            const labels = [];
            const data = [];
            let currentDate = new Date(ninetyDaysAgo);

            while (currentDate <= today) {
                const dateStr = currentDate.toISOString().split('T')[0];
                const { closingStock } = calculateStock(item, category, dateStr);
                labels.push(new Date(currentDate).toLocaleDateString());
                data.push(closingStock);
                currentDate.setUTCDate(currentDate.getUTCDate() + 1);
            }

            const historicalStockCtx = document.getElementById('historicalStockLineChart').getContext('2d');
            if (historicalStockChart) historicalStockChart.destroy();
            historicalStockChart = new Chart(historicalStockCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `Stock Level (${item.unit})`,
                        data: data,
                        borderColor: '#3B82F6',
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: true, text: `Historical Stock Level for ${item.name}` }
                    },
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Stock Quantity' } },
                        x: { title: { display: true, text: 'Date' } }
                    }
                }
            });
        }


        async function forceFullSync() {
            if (!cloudApiUrl) { alert("Please connect to cloud first."); return; }
            updateSyncStatus('syncing', 'Uploading full database...');

            try {
                const formData = new URLSearchParams();
                formData.append('data', JSON.stringify(appState));

                await fetch(cloudApiUrl, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: formData
                });

                alert("Full database uploaded successfully! All users can now access this data.");
                updateSyncStatus('success', 'Full Sync Complete');

            } catch (e) {
                alert("Upload failed: " + e.message);
                updateSyncStatus('error', 'Upload Failed');
            }
        }

        // --- SORTING STATE ---
        let currentSortColumn = null;
        let currentSortOrder = 'asc';

        function toggleSort(column) {
            if (currentSortColumn === column) {
                currentSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortColumn = column;
                currentSortOrder = 'asc';
            }
            renderTableBody(currentView.replace('-view', '')); // Refresh current category table
        }

        function getFuzzyMatch(inputName, category) {
            const items = appState.inventory[category] || [];
            if (!items) return null;
            const normalizedInput = inputName.toLowerCase().trim();

            // 1. Exact Match
            const exact = items.find(i => i.name.toLowerCase() === normalizedInput);
            if (exact) return { item: exact, score: 1.0 };

            // 2. Starts With
            const startsWith = items.find(i => i.name.toLowerCase().startsWith(normalizedInput));
            if (startsWith) return { item: startsWith, score: 0.8 };

            // 3. Includes
            const includes = items.find(i => i.name.toLowerCase().includes(normalizedInput));
            if (includes) return { item: includes, score: 0.5 };

            return null;
        }

        let isReorderMode = false;

        function toggleReorderMode(category) {
            if (!checkPermission()) return;
            isReorderMode = !isReorderMode;
            renderInventoryView(category);
            const btn = document.getElementById(`${category}-reorder-btn`);
            if (isReorderMode) {
                showAlert("Reorder Mode Active. Drag and drop items to re-arrange. Filters are disabled in this mode.", "Reorder Mode");
            }
        }

        function handleDragStart(e, index) {
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', index);
            e.currentTarget.classList.add('bg-gray-200');
        }

        function handleDragOver(e) {
            if (e.preventDefault) e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDrop(e, targetIndex, category) {
            if (e.stopPropagation) e.stopPropagation();
            const sourceIndex = parseInt(e.dataTransfer.getData('text/plain'));
            const rows = appState.inventory[category];

            if (sourceIndex !== targetIndex) {
                const item = rows[sourceIndex];
                rows.splice(sourceIndex, 1);
                rows.splice(targetIndex, 0, item);
                saveState();
                renderTableBody(category);
            }
            return false;
        }

        function renderInventoryView(category) {
            const viewId = currentView + '-view';
            const container = document.getElementById(viewId);
            const categoryName = category.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());

            let batchEntryHtml = '';
            if (category === 'rawMaterials' || category === 'packingMaterials' || category === 'labels') {
                batchEntryHtml = `
            <div class="mt-8 pt-6 border-t">
                <h3 class="text-xl font-bold mb-4">Quick Batch Entry</h3>
                <div class="flex items-center gap-4 mb-2">
                    <label for="batch-entry-date" class="text-sm font-medium">Date for All Entries:</label>
                    <input type="date" id="batch-entry-date" value="${selectedDate}" class="p-2 border rounded-md">
                </div>
                <p class="text-sm text-gray-600 mb-2">Enter multiple transactions at once. Format per line: <code class="bg-gray-200 p-1 rounded">Item Name Quantity</code>. The date selected above will be used for all entries.</p>
                <textarea id="batch-entry-textarea" class="w-full h-32 p-2 border rounded-md" placeholder="Acetic Acid 50\nLABEL MIKRAKSHA 250 ML 500..."></textarea>
                <div class="flex gap-4 mt-2">
                    <button onclick="handleBatchEntry('receive', '${category}')" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg">Record as Received</button>
                    <button onclick="handleBatchEntry('consume', '${category}')" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg">Record as Consumed</button>
                </div>
            </div>`;
            }

            container.innerHTML = `
            <h2 class="text-3xl font-bold mb-6">${categoryName} Stock Overview</h2>
            <div class="bg-white p-6 rounded-lg shadow">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4 items-end">
                    <div><label class="text-sm font-medium">Select Date:</label><input type="date" id="${category}-date-filter" value="${selectedDate}" class="w-full p-2 border rounded-md"></div>
                    <div class="md:col-span-2"><label class="text-sm font-medium">Search Item:</label><input type="text" id="${category}-search-filter" placeholder="Search by name..." class="w-full p-2 border rounded-md"></div>
                    <div class="flex gap-2">
                        <button onclick="openAddItemModal('${category}')" class="px-4 py-2 bg-green-600 text-white rounded-md w-full">Add New Item</button>
                        <button onclick="toggleReorderMode('${category}')" id="${category}-reorder-btn" class="px-4 py-2 ${isReorderMode ? 'bg-green-600' : 'bg-purple-600'} text-white rounded-md w-full">${isReorderMode ? 'Done Reordering' : 'Reorder Items'}</button>
                    </div>
                </div>
                <div class="flex items-center space-x-4 mb-4">
                    <div class="flex items-center"><input type="checkbox" id="${category}-show-out-of-stock" class="h-4 w-4"><label for="${category}-show-out-of-stock" class="ml-2 text-sm">Show Out of Stock Only</label></div>
                    <div class="flex items-center"><input type="checkbox" id="${category}-show-negative-stock" class="h-4 w-4"><label for="${category}-show-negative-stock" class="ml-2 text-sm">Show Negative Stock Only</label></div>
                    <div class="flex items-center"><input type="checkbox" id="${category}-show-below-min" class="h-4 w-4"><label for="${category}-show-below-min" class="ml-2 text-sm">Show Below Min Stock Only</label></div>
                </div>
                <div class="overflow-x-auto max-h-[70vh] overflow-y-auto relative">
                    <table class="min-w-full bg-white border">
                        <thead class="bg-gray-200 sticky top-0 z-10 shadow-sm">
                            <tr>
                                <th class="p-2 border-b">S.No</th>
                                <th class="p-2 border-b text-left">Item Name</th>
                                <th class="p-2 border-b">Unit</th>
                                <th class="p-2 border-b">Price</th>
                                <th class="p-2 border-b">Avg Cost</th>
                                <th class="p-2 border-b">Min Stock</th>
                                <th class="p-2 border-b">Opening</th>
                                <th class="p-2 border-b">Received</th>
                                <th class="p-2 border-b">Consumed</th>
                                <th class="p-2 border-b">Closing</th>
                                <th class="p-2 border-b">Value</th>
                                <th class="p-2 border-b">Notes</th>
                                <th class="p-2 border-b">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="${category}-table-body"></tbody>
                    </table>
                </div>
                ${batchEntryHtml}
            </div>`;
            document.getElementById(`${category}-date-filter`).addEventListener('change', (e) => { selectedDate = e.target.value; renderInventoryView(category); });
            document.getElementById(`${category}-search-filter`).addEventListener('input', () => renderTableBody(category));
            document.getElementById(`${category}-show-out-of-stock`).addEventListener('change', () => renderTableBody(category));
            document.getElementById(`${category}-show-negative-stock`).addEventListener('change', () => renderTableBody(category));
            document.getElementById(`${category}-show-below-min`).addEventListener('change', () => renderTableBody(category));
            renderTableBody(category);
        }

        function renderTableBody(category) {
            const tableBody = document.getElementById(`${category}-table-body`);
            if (!tableBody) return;
            const searchInput = document.getElementById(`${category}-search-filter`);
            const searchFilter = searchInput ? searchInput.value.toLowerCase() : '';

            const outOfStockCheckbox = document.getElementById(`${category}-show-out-of-stock`);
            const showOutOfStock = outOfStockCheckbox ? outOfStockCheckbox.checked : false;

            const negativeStockCheckbox = document.getElementById(`${category}-show-negative-stock`);
            const showNegativeStock = negativeStockCheckbox ? negativeStockCheckbox.checked : false;

            const belowMinCheckbox = document.getElementById(`${category}-show-below-min`);
            const showBelowMin = belowMinCheckbox ? belowMinCheckbox.checked : false;

            let items = appState.inventory[category] || [];
            let itemCalculations = [];

            try {
                itemCalculations = items.map(item => {
                    try {
                        return { item, ...calculateStock(item, category, selectedDate) };
                    } catch (e) {
                        console.error("Error calculating stock for item", item, e);
                        return { item, openingStock: 0, received: 0, consumed: 0, closingStock: 0 };
                    }
                });
            } catch (err) {
                console.error("Critical error in mapping items", err);
                tableBody.innerHTML = `<tr><td colspan="12" class="text-center py-4 text-red-500">Error loading data. Please check console or reset data.</td></tr>`;
                return;
            }

            let filteredItems = itemCalculations.filter(({ item, closingStock }) => {
                if (isReorderMode) return true; // Show all in reorder mode
                try {
                    const name = item.name ? item.name.toLowerCase() : '';
                    if (searchFilter && !name.includes(searchFilter)) return false;
                    if (showNegativeStock && closingStock >= 0) return false;
                    if (showOutOfStock && !showNegativeStock && closingStock !== 0) return false;
                    if (showBelowMin && closingStock >= (item.minStockLevel || 0)) return false;
                    return true;
                } catch (e) { return false; }
            });

            // Sorting Logic - Skip if in reorder mode or no column selected
            if (!isReorderMode && currentSortColumn) {
                filteredItems.sort((a, b) => {
                    let valA, valB;
                    switch (currentSortColumn) {
                        case 'name': valA = a.item.name.toLowerCase(); valB = b.item.name.toLowerCase(); break;
                        case 'opening': valA = a.openingStock; valB = b.openingStock; break;
                        case 'received': valA = a.received; valB = b.received; break;
                        case 'consumed': valA = a.consumed; valB = b.consumed; break;
                        case 'closing': valA = a.closingStock; valB = b.closingStock; break;
                        case 'value': valA = a.closingStock * (a.item.currentAverageCost || a.item.price); valB = b.closingStock * (b.item.currentAverageCost || b.item.price); break;
                        case 'id': valA = appState.inventory[category].findIndex(i => i.id === a.item.id); valB = appState.inventory[category].findIndex(i => i.id === b.item.id); break;
                        default: return 0;
                    }

                    if (valA < valB) return currentSortOrder === 'asc' ? -1 : 1;
                    if (valA > valB) return currentSortOrder === 'asc' ? 1 : -1;
                    return 0;
                });
            } else {
                // Ensure order matches appState default (which is index order) if not already
                // But filteredItems was mapped from items which is appState.inventory[category], so it's already in order.
            }

            if (filteredItems.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="12" class="text-center py-4">No items found matching criteria.</td></tr>`;
                return;
            }
            tableBody.innerHTML = filteredItems.map(({ item, openingStock, received, consumed, closingStock }, index) => {
                const closingValue = (closingStock > 0 ? closingStock : 0) * (item.currentAverageCost || item.price);
                const noteIconClass = item.notes && item.notes.length > 0 ? 'has-notes' : '';
                const draggingAttrs = isReorderMode ?
                    `draggable="true" style="cursor: move; border: 2px dashed #a855f7;" ondragstart="handleDragStart(event, ${appState.inventory[category].findIndex(i => i.id === item.id)})" ondragover="handleDragOver(event)" ondrop="handleDrop(event, ${appState.inventory[category].findIndex(i => i.id === item.id)}, '${category}')"` : '';

                return `
                <tr id="row-${category}-${item.id}" data-item-id="${item.id}" ${draggingAttrs} class="hover:bg-gray-50 text-center text-sm ${isReorderMode ? 'bg-purple-50' : ''}">

                    <td class="p-2 border-b text-gray-500">${appState.inventory[category].findIndex(i => i.id === item.id) + 1}</td>
                    <td class="p-2 border-b text-left">${item.name}</td>
                    <td class="p-2 border-b">${item.unit}</td>
                    <td class="p-2 border-b">${item.price.toFixed(2)}</td>
                    <td class="p-2 border-b font-semibold text-blue-600">
                        ₹${(item.currentAverageCost || item.price).toFixed(2)}
                        <button onclick="showPriceHistory('${item.id}', '${category}')" class="ml-1 text-xs text-blue-400 hover:text-blue-700" title="View Price History">📊</button>
                    </td>
                    <td class="p-2 border-b">
                         ${(item.minStockLevel || 0).toFixed(3)}
                         <button onclick="showBatchDetails('${item.id}', '${category}')" class="block text-xs text-purple-600 hover:text-purple-800 underline mt-1">View Batches</button>
                    </td>
                    <td class="p-2 border-b font-extrabold text-blue-900 bg-blue-50/50">${openingStock.toFixed(3)}</td>
                    <td class="p-2 border-b ${received > 0 ? 'font-bold' : ''}">${received.toFixed(3)}</td>
                    <td class="p-2 border-b ${consumed > 0 ? 'font-bold' : ''}">${consumed.toFixed(3)}</td>
                    <td class="p-2 border-b font-semibold">${closingStock.toFixed(3)}</td>
                    <td class="p-2 border-b">${closingValue.toFixed(2)}</td>
                    <td class="p-2 border-b">
                        <span class="note-icon ${noteIconClass}" onclick="openNotesModal('${category}', '${item.id}')">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M18 8H2V6h16v2zm0 4H2v-2h16v2zm-2 4H4v-2h12v2z" clip-rule="evenodd" />
                            </svg>
                        </span>
                    </td>
                    <td class="p-3 border text-center">
                        <div class="flex gap-1 justify-center items-center">
                            <button onclick="openStockTxModal('${category}', '${item.id}', 'receive')" class="px-2 py-1 bg-green-500 text-white text-xs rounded hover:bg-green-600 font-bold" title="Receive Stock">Receive</button>
                            <button onclick="openStockTxModal('${category}', '${item.id}', 'consume')" class="px-2 py-1 bg-red-500 text-white text-xs rounded hover:bg-red-600 font-bold" title="Consume Stock">Consume</button>
                            <button onclick="openItemHistoryModal('${category}', '${item.id}')" class="px-2 py-1 bg-gray-600 text-white text-xs rounded hover:bg-gray-700 font-bold" title="History & Undo">History/Undo</button>
                            <button onclick="openEditItemModal('${category}', '${item.id}')" class="px-2 py-1 bg-yellow-500 text-white text-xs rounded hover:bg-yellow-600 font-bold" title="Edit Item">Edit</button>
                            <button onclick="openAdjustStockModal('${category}', '${item.id}')" class="p-1 text-gray-600 hover:text-gray-800" title="Adjust Physical Stock">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                            </button>
                            ${category === 'finishedGoods' ? `<button onclick="openProductTrace('${item.id}')" class="px-2 py-1 bg-purple-500 text-white text-xs rounded hover:bg-purple-600 font-bold mr-1" title="Trace Product">Track</button><button onclick="updateItemCostFromFormula('${item.id}')" class="px-2 py-1 bg-indigo-500 text-white text-xs rounded hover:bg-indigo-600 font-bold" title="Auto-Fetch Cost from Formula">Fetch Cost</button>` : ''}
                        </div>
                    </td>
                </tr>`;
            }).join('');
        }

        function renderReorderAssistantView() {
            const container = document.getElementById('reorder-assistant-view');
            const today = getToday();
            let itemsToReorder = [];

            Object.keys(appState.inventory).forEach(cat => {
                appState.inventory[cat].forEach(item => {
                    if (item.minStockLevel !== undefined && item.minStockLevel > 0) {
                        const { closingStock } = calculateStock(item, cat, today);
                        if (closingStock < item.minStockLevel) {
                            itemsToReorder.push({
                                category: cat,
                                item: item,
                                currentStock: closingStock,
                                needed: item.minStockLevel - closingStock
                            });
                        }
                    }
                });
            });

            itemsToReorder.sort((a, b) => a.item.name.localeCompare(b.item.name));

            container.innerHTML = `
            <h2 class="text-3xl font-bold mb-6">Reorder Assistant</h2>
            <div class="bg-white p-6 rounded-lg shadow">
                <p class="text-gray-700 mb-4">Items listed below are currently below their set minimum stock levels.</p>
                <div class="flex justify-end mb-4">
                    <button onclick="exportPurchaseListCSV()" class="px-4 py-2 bg-blue-600 text-white rounded-lg">Export Purchase List (CSV)</button>
                </div>
                <div class="overflow-x-auto max-h-96">
                    <table class="min-w-full bg-white border">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="p-2 border-b text-left">Item Name</th>
                                <th class="p-2 border-b">Category</th>
                                <th class="p-2 border-b">Current Stock</th>
                                <th class="p-2 border-b">Min Level</th>
                                <th class="p-2 border-b">Quantity Needed</th>
                                <th class="p-2 border-b">Unit</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemsToReorder.length === 0 ? `<tr><td colspan="6" class="text-center py-4">No items currently need reordering.</td></tr>` :
                    itemsToReorder.map(data => `
                                    <tr class="hover:bg-gray-50 text-center text-sm">
                                        <td class="p-2 border-b text-left">${data.item.name}</td>
                                        <td class="p-2 border-b">${data.category.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())}</td>
                                        <td class="p-2 border-b">${data.currentStock.toFixed(3)}</td>
                                        <td class="p-2 border-b">${data.item.minStockLevel.toFixed(3)}</td>
                                        <td class="p-2 border-b font-semibold text-red-600">${data.needed.toFixed(3)}</td>
                                        <td class="p-2 border-b">${data.item.unit}</td>
                                    </tr>
                                `).join('')
                }
                        </tbody>
                    </table>
                </div>
            </div>
        `;
        }

        function exportPurchaseListCSV() {
            const today = getToday();
            let itemsToReorder = [];

            Object.keys(appState.inventory).forEach(cat => {
                appState.inventory[cat].forEach(item => {
                    if (item.minStockLevel !== undefined && item.minStockLevel > 0) {
                        const { closingStock } = calculateStock(item, cat, today);
                        if (closingStock < item.minStockLevel) {
                            itemsToReorder.push({
                                category: cat,
                                name: item.name,
                                unit: item.unit,
                                currentStock: closingStock,
                                minLevel: item.minStockLevel,
                                needed: item.minStockLevel - closingStock,
                                price: item.price
                            });
                        }
                    }
                });
            });

            if (itemsToReorder.length === 0) {
                showAlert("No items to reorder.");
                return;
            }

            let csvContent = "Category,Item Name,Unit,Current Stock,Minimum Level,Quantity Needed,Estimated Cost\n";
            itemsToReorder.forEach(item => {
                const estimatedCost = item.needed * item.price;
                csvContent += [
                    `"${item.category}"`,
                    `"${item.name.replace(/"/g, '""')}"`,
                    `"${item.unit}"`,
                    item.currentStock.toFixed(3),
                    item.minLevel.toFixed(3),
                    item.needed.toFixed(3),
                    estimatedCost.toFixed(2)
                ].join(',') + "\n";
            });

            downloadFile(`purchase_list_${getToday()}.csv`, csvContent, 'text/csv;charset=utf-8;');
        }

        let stockTakeData = {}; // Stores the physical counts during a stock-take session

        function renderStockTakeView() {
            const container = document.getElementById('stock-take-view');
            container.innerHTML = `
            <h2 class="text-3xl font-bold mb-6">Guided Stock-Take & Variance Analysis</h2>
            <div class="bg-white p-6 rounded-lg shadow">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold">Start New Stock Count</h3>
                    <button onclick="startNewStockTake()" class="px-4 py-2 bg-green-600 text-white rounded-lg">New Count</button>
                </div>
                <div id="stock-take-input-area" class="hidden">
                    <p class="text-gray-700 mb-4">Enter the physical quantities counted for each item. Leave blank for items not counted or zero.</p>
                    <div class="mb-4">
                        <label for="stock-take-date" class="block text-sm font-medium">Stock-Take Date:</label>
                        <input type="date" id="stock-take-date" value="${getToday()}" class="w-full p-2 border rounded-md">
                    </div>
                    <div class="overflow-y-auto max-h-96 border p-4 rounded-md mb-4">
                        <table class="min-w-full bg-white">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="p-2 border-b text-left">Item Name</th>
                                    <th class="p-2 border-b">Unit</th>
                                    <th class="p-2 border-b">System Stock</th>
                                    <th class="p-2 border-b">Physical Count</th>
                                </tr>
                            </thead>
                            <tbody id="stock-take-table-body">
                                <!-- Items will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                    <div class="flex justify-end gap-4">
                        <button onclick="analyzeStockTake()" class="px-4 py-2 bg-blue-600 text-white rounded-lg">Analyze Variance</button>
                    </div>
                </div>

                <div id="stock-take-variance-report" class="hidden mt-8 pt-6 border-t">
                    <h3 class="text-xl font-bold mb-4">Variance Report</h3>
                    <div class="overflow-y-auto max-h-96 border p-4 rounded-md mb-4">
                        <table class="min-w-full bg-white">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="p-2 border-b text-left">Item Name</th>
                                    <th class="p-2 border-b">Unit</th>
                                    <th class="p-2 border-b">System Stock</th>
                                    <th class="p-2 border-b">Physical Count</th>
                                    <th class="p-2 border-b">Variance (Qty)</th>
                                    <th class="p-2 border-b">Variance (Value)</th>
                                </tr>
                            </thead>
                            <tbody id="variance-report-table-body">
                                <!-- Variance data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                    <div class="flex justify-end gap-4">
                        <button onclick="finalizeStockTake()" class="px-4 py-2 bg-green-600 text-white rounded-lg">Finalize & Adjust Stock</button>
                    </div>
                </div>
            </div>
        `;
        }

        function startNewStockTake() {
            stockTakeData = {}; // Clear previous data
            document.getElementById('stock-take-input-area').classList.remove('hidden');
            document.getElementById('stock-take-variance-report').classList.add('hidden');
            document.getElementById('stock-take-date').value = getToday();

            const tableBody = document.getElementById('stock-take-table-body');
            let allItems = [];
            Object.keys(appState.inventory).forEach(cat => {
                appState.inventory[cat].forEach(item => {
                    allItems.push({ ...item, category: cat });
                });
            });

            tableBody.innerHTML = allItems.map(item => {
                const { closingStock } = calculateStock(item, item.category, getToday());
                return `
                <tr class="text-sm">
                    <td class="p-2 border-b text-left">${item.name}</td>
                    <td class="p-2 border-b">${item.unit}</td>
                    <td class="p-2 border-b">${closingStock.toFixed(3)}</td>
                    <td class="p-2 border-b">
                        <input type="number" step="0.001" class="w-24 p-1 border rounded-md text-right stock-take-input"
                               data-item-id="${item.id}" data-item-category="${item.category}"
                               placeholder="Count">
                    </td>
                </tr>
            `;
            }).join('');
        }

        function analyzeStockTake() {
            const stockTakeDate = document.getElementById('stock-take-date').value;
            if (!stockTakeDate) {
                showAlert("Please select a date for the stock-take.");
                return;
            }

            // Collect physical counts
            document.querySelectorAll('.stock-take-input').forEach(input => {
                const itemId = parseFloat(input.dataset.itemId);
                const category = input.dataset.itemCategory;
                const physicalCount = parseFloat(input.value);
                if (!isNaN(physicalCount)) {
                    stockTakeData[`${category}-${itemId}`] = physicalCount;
                } else {
                    // If not entered, assume 0 for variance calculation or skip if not counted
                    // For now, we'll assume 0 if not entered for items that exist in the system.
                    // Or, if not entered, it means no change from system. Let's make it explicit.
                    // If input is empty, it means "not counted", so we don't include it in variance unless it's a discrepancy.
                    // For simplicity, if input is empty, we treat it as 0 for items that exist in the system.
                    // A better approach would be to only process entered values and assume others are correct.
                    // Let's go with: if input is empty, it's not part of the explicit count for variance.
                }
            });

            const varianceReportBody = document.getElementById('variance-report-table-body');
            let varianceHtml = '';
            let totalVarianceValue = 0;

            let allItems = [];
            Object.keys(appState.inventory).forEach(cat => {
                appState.inventory[cat].forEach(item => {
                    allItems.push({ ...item, category: cat });
                });
            });

            allItems.forEach(item => {
                const systemStock = calculateStock(item, item.category, stockTakeDate).closingStock;
                const physicalCount = stockTakeData[`${item.category}-${item.id}`] !== undefined ? stockTakeData[`${item.category}-${item.id}`] : systemStock; // If not counted, assume system stock

                const varianceQty = physicalCount - systemStock;
                const varianceValue = varianceQty * item.price;

                if (varianceQty !== 0) { // Only show items with variance
                    totalVarianceValue += varianceValue;
                    let varianceClass = varianceQty > 0 ? 'text-green-600' : 'text-red-600';
                    varianceHtml += `
                    <tr class="text-sm">
                        <td class="p-2 border-b text-left">${item.name}</td>
                        <td class="p-2 border-b">${item.unit}</td>
                        <td class="p-2 border-b">${systemStock.toFixed(3)}</td>
                        <td class="p-2 border-b">${physicalCount.toFixed(3)}</td>
                        <td class="p-2 border-b ${varianceClass}">${varianceQty.toFixed(3)}</td>
                        <td class="p-2 border-b ${varianceClass}">₹ ${varianceValue.toFixed(2)}</td>
                    </tr>
                `;
                }
            });

            if (varianceHtml === '') {
                varianceHtml = `<tr><td colspan="6" class="text-center py-4">No variances found. System stock matches physical count.</td></tr>`;
            } else {
                varianceHtml += `
                <tr class="font-bold">
                    <td colspan="5" class="p-2 border-b text-right">Total Variance Value:</td>
                    <td class="p-2 border-b ${totalVarianceValue < 0 ? 'text-red-600' : 'text-green-600'}">₹ ${totalVarianceValue.toFixed(2)}</td>
                </tr>
            `;
            }

            varianceReportBody.innerHTML = varianceHtml;
            document.getElementById('stock-take-variance-report').classList.remove('hidden');
        }

        function finalizeStockTake() {
            const stockTakeDate = document.getElementById('stock-take-date').value;
            if (!stockTakeDate) {
                showAlert("Please select a date for the stock-take.");
                return;
            }

            showConfirm("Are you sure you want to finalize the stock-take and adjust inventory? This will create new transactions.", () => {
                let adjustmentsMade = 0;
                let allItems = [];
                Object.keys(appState.inventory).forEach(cat => {
                    appState.inventory[cat].forEach(item => {
                        allItems.push({ ...item, category: cat });
                    });
                });

                allItems.forEach(item => {
                    const systemStock = calculateStock(item, item.category, stockTakeDate).closingStock;
                    const physicalCount = stockTakeData[`${item.category}-${item.id}`] !== undefined ? stockTakeData[`${item.category}-${item.id}`] : systemStock;

                    const varianceQty = physicalCount - systemStock;

                    if (varianceQty !== 0) {
                        const type = varianceQty > 0 ? 'stock-take-adj-in' : 'stock-take-adj-out';
                        const newTx = {
                            id: Date.now() + Math.random(),
                            itemId: item.id,
                            category: item.category,
                            type: type,
                            quantity: Math.abs(varianceQty),
                            date: stockTakeDate + 'T00:00:00.000Z'
                        };
                        appState.transactions.push(newTx);
                        adjustmentsMade++;
                    }
                });
                saveState();
                showAlert(`Stock-take finalized. ${adjustmentsMade} adjustments made.`, "Stock-Take Complete");
                stockTakeData = {}; // Clear session data
                showView('stock-take'); // Re-render the stock-take view
            }, "Confirm Finalize Stock-Take");
        }

        function renderReportsView() {
            const container = document.getElementById('daily-report-view');
            container.innerHTML = `
            <div class="bg-white p-6 rounded-lg shadow">
                <div class="flex mb-4 border-b">
                    <button class="px-4 py-2 text-lg font-semibold border-b-2 tab-button" data-tab="daily">Daily Report</button>
                    <button class="px-4 py-2 text-lg font-semibold border-b-2 tab-button" data-tab="monthly">Monthly Report</button>
                    <button class="px-4 py-2 text-lg font-semibold border-b-2 tab-button" data-tab="item-ledger">Item-wise Ledger</button>
                </div>
                <div id="daily-report-tab" class="tab-content"></div>
                <div id="monthly-report-tab" class="tab-content hidden"></div>
                <div id="item-ledger-report-tab" class="tab-content hidden"></div>
            </div>`;
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
                    e.target.classList.add('active');
                    const tabId = e.target.dataset.tab;
                    document.getElementById(`${tabId}-report-tab`).classList.remove('hidden');
                    if (tabId === 'daily') {
                        renderDailyReportContent();
                    } else if (tabId === 'monthly') {
                        renderMonthlyReportContent();
                    } else if (tabId === 'item-ledger') {
                        renderItemLedgerReportContent();
                    }
                });
            });
            document.querySelector('.tab-button[data-tab="daily"]').click();
        }

        function renderDailyReportContent() {
            const container = document.getElementById('daily-report-tab');
            let reportDate = selectedDate;
            const render = () => {
                const targetDate = getStartOfDay(reportDate);
                let allItems = [];
                Object.keys(appState.inventory).forEach(cat => { allItems = allItems.concat(appState.inventory[cat].map(i => ({ ...i, category: cat }))) });
                const transactionsOnDate = appState.transactions.filter(tx => getStartOfDay(tx.date).getTime() === targetDate.getTime());
                container.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <div><h4 class="text-xl font-bold">Daily Stock Summary for ${reportDate}</h4></div>
                    <div><label class="text-sm font-medium">Select Date:</label><input type="date" id="daily-report-date-filter" value="${reportDate}" class="p-2 border rounded-md"></div>
                </div>
                <div class="flex flex-wrap gap-2 mb-4 border-b pb-4">
                    <h5 class="w-full font-semibold text-gray-700 text-sm mb-2">Export Daily Summary (CSV)</h5>
                    <button onclick="exportDailyReportCSV('rawMaterials')" class="px-3 py-1 bg-blue-100 text-blue-800 rounded-lg text-sm">Raw Materials</button>
                    <button onclick="exportDailyReportCSV('packingMaterials')" class="px-3 py-1 bg-blue-100 text-blue-800 rounded-lg text-sm">Packing Materials</button>
                    <button onclick="exportDailyReportCSV('labels')" class="px-3 py-1 bg-blue-100 text-blue-800 rounded-lg text-sm">Labels</button>
                    <button onclick="exportDailyReportCSV('finishedGoods')" class="px-3 py-1 bg-blue-100 text-blue-800 rounded-lg text-sm">Finished Goods</button>
                    <button onclick="exportDailyReportCSV('all')" class="px-4 py-2 bg-green-800 text-white rounded-lg text-sm">Export All</button>
                </div>
                <div class="overflow-x-auto mb-8 max-h-96"><table class="min-w-full bg-white border"><thead class="bg-gray-200"><tr><th class="p-2 border-b text-left">Category</th><th class="p-2 border-b text-left">Item</th><th class="p-2 border-b text-right">Opening</th><th class="p-2 border-b text-right">Received</th><th class="p-2 border-b text-right">Consumed</th><th class="p-2 border-b text-right">Closing</th><th class="p-2 border-b text-right">Closing Value</th></tr></thead><tbody>
                    ${allItems.map(item => {
                    const { openingStock, received, consumed, closingStock } = calculateStock(item, item.category, reportDate);
                    const cost = item.currentAverageCost || item.price;
                    const closingValue = closingStock * cost;
                    return `<tr><td class="p-2 border-b">${item.category.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())}</td><td class="p-2 border-b">${item.name}</td><td class="p-2 border-b text-right font-bold">${openingStock.toFixed(3)}</td><td class="p-2 border-b text-right ${received > 0 ? 'font-bold' : ''}">${received.toFixed(3)}</td><td class="p-2 border-b text-right ${consumed > 0 ? 'font-bold' : ''}">${consumed.toFixed(3)}</td><td class="p-2 border-b text-right font-semibold">${closingStock.toFixed(3)}</td><td class="p-2 border-b text-right text-blue-800 font-bold">₹${closingValue.toFixed(2)}</td></tr>`;
                }).join('')}
                </tbody></table></div>
                <h4 class="text-xl font-bold mb-4">Daily Transactions</h4>
                <div class="overflow-x-auto max-h-96"><table class="min-w-full bg-white border"><thead class="bg-gray-200"><tr><th class="p-2 border-b text-left">Item</th><th class="p-2 border-b text-left">Type</th><th class="p-2 border-b text-right">Quantity</th><th class="p-2 border-b">Actions</th></tr></thead><tbody>
                    ${transactionsOnDate.length === 0 ? `<tr><td colspan="4" class="text-center py-4">No transactions.</td></tr>` : transactionsOnDate.map(tx => {
                    const item = findItem(tx.category, tx.itemId);
                    let typeDisplay = tx.type;
                    if (tx.type === 'stock-take-adj-in' || tx.type === 'stock-take-adj-out') typeDisplay = 'Stock-Take Adj.';
                    else if (tx.type === 'production-add') typeDisplay = 'Production (Add)';
                    else if (tx.type === 'production-consume') typeDisplay = 'Production (Consume)';
                    return `<tr class="hover:bg-gray-50"><td class="p-2 border-b">${item ? item.name : 'Unknown'}</td><td class="p-2 border-b"><span class="px-2 inline-flex text-xs font-semibold rounded-full ${tx.type.includes('receive') || tx.type.includes('add') ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${typeDisplay.toUpperCase()}</span></td><td class="p-2 border-b text-right">${tx.quantity.toFixed(3)}</td><td class="p-2 border-b text-center"><button onclick="openEditTxModal(${tx.id})" class="text-blue-500 hover:text-blue-700 text-xs">Edit</button></td></tr>`;
                }).join('')}
                </tbody></table></div>`;
                document.getElementById('daily-report-date-filter').addEventListener('change', (e) => { reportDate = e.target.value; selectedDate = e.target.value; render(); });
            };
            render();
        }

        function renderMonthlyReportContent() {
            const container = document.getElementById('monthly-report-tab');
            let currentMonth = new Date().toISOString().substring(0, 7);
            let startDateFilter = '';
            let endDateFilter = '';

            const generateMonthOptions = () => {
                let options = '';
                const today = new Date();
                for (let i = 0; i < 12; i++) {
                    const date = new Date(today.getFullYear(), today.getMonth() - i, 1);
                    const monthValue = date.toISOString().substring(0, 7);
                    const monthName = date.toLocaleString('default', { month: 'long', year: 'numeric' });
                    options += `<option value="${monthValue}" ${monthValue === currentMonth ? 'selected' : ''}>${monthName}</option>`;
                }
                return options;
            };

            const render = () => {
                let itemsToReport = [];
                Object.keys(appState.inventory).forEach(cat => {
                    itemsToReport = itemsToReport.concat(appState.inventory[cat].map(i => ({ ...i, category: cat })));
                });

                let reportStartDate, reportEndDate;
                if (startDateFilter && endDateFilter) {
                    reportStartDate = getStartOfDay(startDateFilter);
                    reportEndDate = getStartOfDay(endDateFilter);
                } else {
                    const [year, month] = currentMonth.split('-').map(Number);
                    reportStartDate = getStartOfDay(new Date(year, month - 1, 1).toISOString().split('T')[0]);
                    reportEndDate = getStartOfDay(new Date(year, month, 0).toISOString().split('T')[0]);
                }

                const reportStartDateStr = reportStartDate.toISOString().split('T')[0];
                const reportEndDateStr = reportEndDate.toISOString().split('T')[0];

                let monthlyData = [];
                itemsToReport.forEach(item => {
                    if (!item.openingStockDate || getStartOfDay(item.openingStockDate) > reportEndDate) {
                        return;
                    }

                    const itemLedger = generateItemLedger(item, item.category, reportEndDateStr);
                    if (itemLedger.size === 0) return;

                    const firstDayOfMonthData = itemLedger.get(reportStartDateStr);
                    const openingStock = firstDayOfMonthData ? firstDayOfMonthData.opening : 0;

                    let totalReceived = 0;
                    let totalConsumed = 0;

                    for (let d = new Date(reportStartDate); d <= reportEndDate; d.setUTCDate(d.getUTCDate() + 1)) {
                        const dayData = itemLedger.get(d.toISOString().split('T')[0]);
                        if (dayData) {
                            totalReceived += dayData.received;
                            totalConsumed += dayData.consumed;
                        }
                    }

                    const lastDayOfMonthData = itemLedger.get(reportEndDateStr);
                    const closingStock = lastDayOfMonthData ? lastDayOfMonthData.closing : openingStock + totalReceived - totalConsumed;

                    monthlyData.push({
                        ...item,
                        openingStock,
                        totalReceived,
                        totalConsumed,
                        closingStock
                    });
                });

                container.innerHTML = `
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <h4 class="text-xl font-bold">Monthly/Period Stock Summary</h4>
                    <div class="flex flex-col md:flex-row gap-4 w-full md:w-auto">
                        <div class="flex-1"><label class="block text-sm font-medium">Select Month:</label><select id="month-selector" class="w-full p-2 border rounded-md">${generateMonthOptions()}</select></div>
                        <div class="flex-1"><label class="block text-sm font-medium">Start Date:</label><input type="date" id="monthly-start-date" value="${startDateFilter}" class="w-full p-2 border rounded-md"></div>
                        <div class="flex-1"><label class="block text-sm font-medium">End Date:</label><input type="date" id="monthly-end-date" value="${endDateFilter}" class="w-full p-2 border rounded-md"></div>
                    </div>
                </div>
                <div class="flex flex-wrap gap-2 mb-2 border-b pb-4">
                    <h5 class="w-full font-semibold text-gray-700 text-sm mb-2">Export Monthly Summary (CSV)</h5>
                    <button onclick="exportMonthlyReportCSV('rawMaterials')" class="px-3 py-1 bg-blue-100 text-blue-800 rounded-lg text-sm">Raw Materials</button>
                    <button onclick="exportMonthlyReportCSV('packingMaterials')" class="px-3 py-1 bg-blue-100 text-blue-800 rounded-lg text-sm">Packing Materials</button>
                    <button onclick="exportMonthlyReportCSV('labels')" class="px-3 py-1 bg-blue-100 text-blue-800 rounded-lg text-sm">Labels</button>
                    <button onclick="exportMonthlyReportCSV('finishedGoods')" class="px-3 py-1 bg-blue-100 text-blue-800 rounded-lg text-sm">Finished Goods</button>
                    <button onclick="exportMonthlyReportCSV('all')" class="px-4 py-2 bg-blue-800 text-white rounded-lg text-sm">Export All</button>
                </div>
                <div class="flex flex-wrap gap-2 mb-4 border-b pb-4">
                    <h5 class="w-full font-semibold text-gray-700 text-sm mb-2">Export Day-wise Data (Excel)</h5>
                    <button onclick="exportMonthlyDayWiseXLSX('rawMaterials')" class="px-3 py-1 bg-green-100 text-green-800 rounded-lg text-sm">Raw Materials</button>
                    <button onclick="exportMonthlyDayWiseXLSX('packingMaterials')" class="px-3 py-1 bg-green-100 text-green-800 rounded-lg text-sm">Packing Materials</button>
                    <button onclick="exportMonthlyDayWiseXLSX('labels')" class="px-3 py-1 bg-green-100 text-green-800 rounded-lg text-sm">Labels</button>
                    <button onclick="exportMonthlyDayWiseXLSX('finishedGoods')" class="px-3 py-1 bg-green-100 text-green-800 rounded-lg text-sm">Finished Goods</button>
                    <button onclick="exportMonthlyDayWiseXLSX('all')" class="px-4 py-2 bg-green-800 text-white rounded-lg text-sm">Export All</button>
                </div>
                <div class="overflow-x-auto max-h-96"><table class="min-w-full bg-white border"><thead class="bg-gray-200"><tr><th class="p-2 border-b text-left">Category</th><th class="p-2 border-b text-left">Item</th><th class="p-2 border-b text-right">Opening Stock</th><th class="p-2 border-b text-right">Total Received</th><th class="p-2 border-b text-right">Total Consumed</th><th class="p-2 border-b text-right">Closing Stock</th><th class="p-2 border-b text-right">Closing Value</th></tr></thead><tbody>
                    ${monthlyData.map(item => {
                    const closingValue = item.closingStock * (item.currentAverageCost || item.price);
                    return `<tr><td class="p-2 border-b">${item.category.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())}</td><td class="p-2 border-b">${item.name}</td><td class="p-2 border-b text-right font-bold">${item.openingStock.toFixed(3)}</td><td class="p-2 border-b text-right ${item.totalReceived > 0 ? 'font-bold' : ''}">${item.totalReceived.toFixed(3)}</td><td class="p-2 border-b text-right ${item.totalConsumed > 0 ? 'font-bold' : ''}">${item.totalConsumed.toFixed(3)}</td><td class="p-2 border-b text-right font-semibold">${item.closingStock.toFixed(3)}</td><td class="p-2 border-b text-right text-blue-800 font-bold">₹${closingValue.toFixed(2)}</td></tr>`;
                }).join('')}
                </tbody></table></div>`;
                document.getElementById('month-selector').addEventListener('change', (e) => { currentMonth = e.target.value; startDateFilter = ''; endDateFilter = ''; render(); });
                document.getElementById('monthly-start-date').addEventListener('change', (e) => { startDateFilter = e.target.value; if (startDateFilter && endDateFilter) { document.getElementById('month-selector').value = ''; } render(); });
                document.getElementById('monthly-end-date').addEventListener('change', (e) => { endDateFilter = e.target.value; if (startDateFilter && endDateFilter) { document.getElementById('month-selector').value = ''; } render(); });
            };
            render();
        }

        // New state variable to hold the selected item for the ledger
        let selectedItemForLedger = '';
        let ledgerStartDate = '';
        let ledgerEndDate = getToday();

        function renderItemLedgerReportContent() {
            const container = document.getElementById('item-ledger-report-tab');

            const allItemsFlat = [];
            Object.keys(appState.inventory).forEach(cat => {
                appState.inventory[cat].forEach(item => {
                    allItemsFlat.push({ ...item, category: cat });
                });
            });

            const render = () => {
                // Generate itemOptions dynamically inside render to reflect current selection state
                const itemOptions = allItemsFlat.map(item => {
                    const value = `${item.category}-${item.id}`;
                    const isSelected = value === selectedItemForLedger ? 'selected' : '';
                    return `<option value="${value}" ${isSelected}>${item.name} (${item.category.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())})</option>`;
                }).join('');

                let ledgerHtml = '<p class="text-gray-500">Select an item and date range to view its ledger.</p>';
                if (selectedItemForLedger) {
                    const [category, itemId] = selectedItemForLedger.split('-');
                    const item = findItem(category, parseFloat(itemId));
                    if (item) {
                        const ledger = generateItemLedger(item, category, ledgerEndDate);
                        let filteredLedgerEntries = [];
                        let currentOpeningStock = 0;

                        // Find the opening stock for the first day in the report range
                        const firstReportDate = getStartOfDay(ledgerStartDate);
                        if (firstReportDate) {
                            const previousDay = new Date(firstReportDate);
                            previousDay.setUTCDate(previousDay.getUTCDate() - 1);
                            const previousDayData = ledger.get(previousDay.toISOString().split('T')[0]);
                            currentOpeningStock = previousDayData ? previousDayData.closing : item.openingStock; // Fallback to item's opening stock if no prior ledger data
                        } else {
                            currentOpeningStock = item.openingStock; // If no start date, use item's opening stock
                        }


                        for (let d = new Date(getStartOfDay(ledgerStartDate || item.openingStockDate)); d <= getStartOfDay(ledgerEndDate); d.setUTCDate(d.getUTCDate() + 1)) {
                            const dateStr = d.toISOString().split('T')[0];
                            const dayData = ledger.get(dateStr);
                            if (dayData) {
                                // If it's the very first day in the ledger or the first day of the report range, set its opening stock
                                if (dateStr === item.openingStockDate || dateStr === ledgerStartDate) {
                                    dayData.opening = currentOpeningStock;
                                } else {
                                    // For subsequent days, opening stock is previous day's closing stock
                                    const prevDay = new Date(d);
                                    prevDay.setUTCDate(prevDay.getUTCDate() - 1);
                                    const prevDayData = ledger.get(prevDay.toISOString().split('T')[0]);
                                    dayData.opening = prevDayData ? prevDayData.closing : dayData.opening; // Use previous day's closing or default
                                }
                                filteredLedgerEntries.push({ date: dateStr, ...dayData });
                                currentOpeningStock = dayData.closing; // Update for next iteration
                            } else {
                                // If no transactions on a day, opening = closing of previous day, received/consumed = 0
                                filteredLedgerEntries.push({
                                    date: dateStr,
                                    opening: currentOpeningStock,
                                    received: 0,
                                    consumed: 0,
                                    closing: currentOpeningStock,
                                    transactions: []
                                });
                            }
                        }

                        if (filteredLedgerEntries.length > 0) {
                            ledgerHtml = `
                            <div class="flex items-center justify-between mb-2">
                                <h4 class="text-lg font-bold">Ledger for ${item.name} (${item.unit})</h4>
                                ${category === 'finishedGoods' ? `<button onclick="openProductTrace('${item.id}')" class="px-2 py-1 bg-purple-500 text-white text-xs rounded hover:bg-purple-600 font-bold" title="Trace Product">Track</button>` : ''}
                            </div>
                            <div class="overflow-x-auto max-h-96">
                                <table class="min-w-full bg-white border">
                                    <thead class="bg-gray-200">
                                        <tr>
                                            <th class="p-2 border-b">Date</th>
                                            <th class="p-2 border-b">Opening</th>
                                            <th class="p-2 border-b">Received</th>
                                            <th class="p-2 border-b">Consumed</th>
                                            <th class="p-2 border-b">Closing</th>
                                            <th class="p-2 border-b">Closing Value</th>
                                            <th class="p-2 border-b">Transactions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${filteredLedgerEntries.map(entry => {
                                const txDetails = entry.transactions.map(tx => {
                                    let typeDisplay = tx.type;
                                    if (tx.type === 'stock-take-adj-in' || tx.type === 'stock-take-adj-out') typeDisplay = 'Stock-Take Adj.';
                                    else if (tx.type === 'production-add') typeDisplay = 'Production (Add)';
                                    else if (tx.type === 'production-consume') typeDisplay = 'Production (Consume)';
                                    else if (tx.type === 'dispatch') typeDisplay = 'Sale/Dispatch';
                                    return `<span class="px-2 inline-flex text-xs font-semibold rounded-full ${tx.type.includes('receive') || tx.type.includes('add') || (tx.type.includes('adj') && tx.type.includes('in')) ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${typeDisplay.toUpperCase()} ${tx.quantity.toFixed(3)}</span>`;
                                }).join(' ');
                                return `
                                                <tr class="text-center text-sm">
                                                    <td class="p-2 border-b">${entry.date}</td>
                                                    <td class="p-2 border-b">${entry.opening.toFixed(3)}</td>
                                                    <td class="p-2 border-b ${entry.received > 0 ? 'font-bold' : ''}">${entry.received.toFixed(3)}</td>
                                                    <td class="p-2 border-b ${entry.consumed > 0 ? 'font-bold' : ''}">${entry.consumed.toFixed(3)}</td>
                                                    <td class="p-2 border-b font-semibold">${entry.closing.toFixed(3)}</td>
                                                    <td class="p-2 border-b text-blue-800 font-bold">₹${(entry.closing * (item.currentAverageCost || item.price)).toFixed(2)}</td>
                                                    <td class="p-2 border-b text-left">${txDetails || 'No transactions'}</td>
                                                </tr>
                                            `;
                            }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `;
                        } else {
                            ledgerHtml = `<p class="text-gray-500">No ledger data found for the selected item and date range.</p>`;
                        }
                    } else {
                        ledgerHtml = `<p class="text-gray-500">Selected item not found.</p>`;
                    }
                }

                container.innerHTML = `
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <h4 class="text-xl font-bold">Item-wise Ledger Report</h4>
                    <div class="flex flex-col md:flex-row gap-4 w-full md:w-auto">
                        <div class="flex-1">
                            <label class="block text-sm font-medium">Select Item:</label>
                            <select id="item-ledger-select" class="w-full p-2 border rounded-md max-w-xs">
                                <option value="">-- Select Item --</option>
                                ${itemOptions}
                            </select>
                        </div>
                        <div class="flex-1">
                            <label class="block text-sm font-medium">Start Date:</label>
                            <input type="date" id="ledger-start-date" value="${ledgerStartDate}" class="w-full p-2 border rounded-md">
                        </div>
                        <div class="flex-1">
                            <label class="block text-sm font-medium">End Date:</label>
                            <input type="date" id="ledger-end-date" value="${ledgerEndDate}" class="w-full p-2 border rounded-md">
                        </div>
                    </div>
                </div>
                <div class="flex justify-end mb-4 gap-2">
                    <button onclick="exportItemFullTransactionCSV()" class="px-4 py-2 bg-purple-600 text-white rounded-lg">Export Raw Transactions (CSV)</button>
                    <button onclick="exportItemLedgerCSV()" class="px-4 py-2 bg-blue-600 text-white rounded-lg">Export Ledger Summary (CSV)</button>
                </div>
                <div id="item-ledger-content">
                    ${ledgerHtml}
                </div>
            `;

                // Inject Export All Button
                const header = container.querySelector('.flex.justify-between');
                if (header) {
                    const btn = document.createElement('button');
                    btn.className = "px-4 py-2 bg-purple-600 text-white rounded-lg ml-4";
                    btn.textContent = "Export Full Transaction Log";
                    btn.onclick = exportTransactionReportCSV;
                    header.appendChild(btn);
                }

                // FORCE UPDATE SELECT VALUE TO MATCH STATE
                // This fixes the issue where the dropdown visually resets despite state being correct
                const selectEl = document.getElementById('item-ledger-select');
                if (selectEl && selectedItemForLedger) {
                    selectEl.value = selectedItemForLedger;
                }

                selectEl.addEventListener('change', (e) => {
                    selectedItemForLedger = e.target.value;
                    render();
                });
                document.getElementById('ledger-start-date').addEventListener('change', (e) => {
                    ledgerStartDate = e.target.value;
                    render();
                });
                document.getElementById('ledger-end-date').addEventListener('change', (e) => {
                    ledgerEndDate = e.target.value;
                    render();
                });
            };
            render();
        }

        function exportItemLedgerCSV() {
            const selectedItemForLedger = document.getElementById('item-ledger-select').value;
            const ledgerStartDate = document.getElementById('ledger-start-date').value;
            const ledgerEndDate = document.getElementById('ledger-end-date').value;

            if (!selectedItemForLedger) {
                showAlert("Please select an item to export its ledger.");
                return;
            }

            const [category, itemId] = selectedItemForLedger.split('-');
            const item = findItem(category, parseFloat(itemId));

            if (!item) {
                showAlert("Selected item not found.");
                return;
            }

            const ledger = generateItemLedger(item, category, ledgerEndDate);
            let csvContent = "Date,Opening Stock,Received,Consumed,Closing Stock,Transaction Details\n";
            let currentOpeningStock = 0;

            const firstReportDate = getStartOfDay(ledgerStartDate);
            if (firstReportDate) {
                const previousDay = new Date(firstReportDate);
                previousDay.setUTCDate(previousDay.getUTCDate() - 1);
                const previousDayData = ledger.get(previousDay.toISOString().split('T')[0]);
                currentOpeningStock = previousDayData ? previousDayData.closing : item.openingStock;
            } else {
                currentOpeningStock = item.openingStock;
            }

            for (let d = new Date(getStartOfDay(ledgerStartDate || item.openingStockDate)); d <= getStartOfDay(ledgerEndDate); d.setUTCDate(d.getUTCDate() + 1)) {
                const dateStr = d.toISOString().split('T')[0];
                const dayData = ledger.get(dateStr);

                let opening = currentOpeningStock;
                let received = 0;
                let consumed = 0;
                let closing = currentOpeningStock;
                let txDetails = '';

                if (dayData) {
                    opening = dayData.opening; // This will be the true opening from ledger
                    received = dayData.received;
                    consumed = dayData.consumed;
                    closing = dayData.closing;
                    txDetails = dayData.transactions.map(tx => {
                        let typeDisplay = tx.type;
                        if (tx.type === 'stock-take-adj-in' || tx.type === 'stock-take-adj-out') typeDisplay = 'Stock-Take Adj.';
                        else if (tx.type === 'production-add') typeDisplay = 'Production (Add)';
                        else if (tx.type === 'production-consume') typeDisplay = 'Production (Consume)';
                        return `${typeDisplay.toUpperCase()} ${tx.quantity.toFixed(3)}`;
                    }).join('; ');
                }

                csvContent += [
                    `"${dateStr}"`,
                    opening.toFixed(3),
                    received.toFixed(3),
                    consumed.toFixed(3),
                    closing.toFixed(3),
                    `"${txDetails.replace(/"/g, '""')}"`
                ].join(',') + "\n";
                currentOpeningStock = closing; // Update for next iteration
            }

            downloadFile(`item_ledger_${item.name.replace(/ /g, '_')}_${ledgerStartDate}_to_${ledgerEndDate}.csv`, csvContent, 'text/csv;charset=utf-8;');
        }

        function exportItemFullTransactionCSV() {
            const selectedItemForLedger = document.getElementById('item-ledger-select').value;
            if (!selectedItemForLedger) { showAlert("Please select an item first."); return; }

            const [category, itemId] = selectedItemForLedger.split('-');
            const item = findItem(category, parseFloat(itemId));
            if (!item) return;

            let csvContent = "Date,Type,Quantity,Batch No,Supplier/Customer,Ref/Invoice,Price/Cost,Expiry Date\n";

            const txs = appState.transactions
                .filter(tx => tx.category === category && tx.itemId == item.id)
                .sort((a, b) => new Date(b.date) - new Date(a.date));

            txs.forEach(tx => {
                const dateStr = tx.date.split('T')[0];
                let party = '';
                if (tx.supplierId) {
                    const s = appState.suppliers?.find(sup => sup.id == tx.supplierId);
                    party = s ? s.name : '';
                } else if (tx.customerName) {
                    party = tx.customerName;
                } else if (tx.supplier) {
                    party = tx.supplier;
                }

                // Fallbacks
                if (!party) {
                    if (tx.type === 'receive') party = 'Purchase';
                    else if (tx.type === 'dispatch') party = 'Sale';
                    else if (tx.type === 'production-consume') party = 'Production Consumed';
                    else if (tx.type === 'production-add') party = 'Production Output';
                    else if (tx.type.includes('adj')) party = 'Stock Adjustment';
                }

                let ref = '';
                if (tx.poNo) ref += `PO:${tx.poNo} `;
                if (tx.invoiceNo) ref += `Inv:${tx.invoiceNo} `;

                csvContent += [
                    `"${dateStr}"`,
                    `"${tx.type}"`,
                    tx.quantity,
                    `"${tx.batchNo || ''}"`,
                    `"${party.replace(/"/g, '""')}"`,
                    `"${ref.replace(/"/g, '""')}"`,
                    tx.purchasePrice || '',
                    `"${tx.expDate || ''}"`
                ].join(',') + "\n";
            });

            downloadFile(`item_transactions_${item.name.replace(/ /g, '_')}.csv`, csvContent, 'text/csv;charset=utf-8;');
        }

        // --- COMPREHENSIVE TRANSACTION REPORT ---
        function exportTransactionReportCSV() {
            let csvContent = "Date,Type,Item Name,Category,Quantity,Unit,Batch No,Supplier/Customer,Ref/Invoice,Price/Cost,Expiry Date\n";

            // Sort all transactions by date
            const allTxs = [...appState.transactions].sort((a, b) => new Date(b.date) - new Date(a.date));

            allTxs.forEach(tx => {
                const item = findItem(tx.category, tx.itemId);
                const itemName = item ? item.name.replace(/"/g, '""') : 'Unknown Item';
                const unit = item ? item.unit : '';
                const dateStr = tx.date.split('T')[0];

                let party = '';
                if (tx.supplierId) {
                    const s = appState.suppliers?.find(sup => sup.id == tx.supplierId); // Loose eq for string/number match
                    party = s ? s.name : 'Unknown Supplier ID:' + tx.supplierId;
                } else if (tx.customerName) {
                    party = tx.customerName;
                } else if (tx.supplier) {
                    party = tx.supplier; // Legacy fallback
                }

                if (!party) {
                    if (tx.type === 'receive') party = 'Purchase';
                    if (tx.type === 'dispatch') party = 'Sale';
                    if (tx.type === 'production-consume') party = 'Production Consumed';
                    if (tx.type === 'production-add') party = 'Production Output';
                    if (tx.type.includes('adj')) party = 'Stock Adjustment';
                }

                let ref = '';
                if (tx.poNo) ref += `PO:${tx.poNo} `;
                if (tx.invoiceNo) ref += `Inv:${tx.invoiceNo} `;

                csvContent += [
                    `"${dateStr}"`,
                    `"${tx.type}"`,
                    `"${itemName}"`,
                    `"${tx.category}"`,
                    tx.quantity,
                    `"${unit}"`,
                    `"${tx.batchNo || ''}"`,
                    `"${party.replace(/"/g, '""')}"`,
                    `"${ref.replace(/"/g, '""')}"`,
                    tx.purchasePrice ? tx.purchasePrice : '',
                    `"${tx.expDate || ''}"`
                ].join(',') + "\n";
            });

            downloadFile(`full_transaction_report_${getToday()}.csv`, csvContent, 'text/csv;charset=utf-8;');
        }


        function renderFormulationsView() {
            const container = document.getElementById('formulations-view');
            const formulas = appState.formulas || [];
            const productsOptions = formulas.map(f => `<option value="${f.id}">${f.name}</option>`).join('');
            container.innerHTML = `
            <h2 class="text-3xl font-bold mb-6">Formulations & Production</h2>
            <div class="bg-white p-6 rounded-lg shadow mb-8">
                <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">Manage Formulas</h3><button onclick="openFormulaModal()" class="px-4 py-2 bg-green-600 text-white rounded-lg">Add New Formula</button></div>
                <div class="mb-4"><label class="text-sm font-medium">Search Product:</label><input type="text" id="formula-search-filter" placeholder="Search by product name..." class="w-full p-2 border rounded-md"></div>
                <div class="overflow-x-auto max-h-96"><table class="min-w-full bg-white border"><thead class="bg-gray-200"><tr><th class="p-2 border-b">S.No</th><th class="p-2 border-b text-left">Product</th><th class="p-2 border-b">Output</th><th class="p-2 border-b text-left">Ingredients</th><th class="p-2 border-b">Actions</th></tr></thead><tbody id="formulas-table-body"></tbody></table></div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow">
                <h3 class="text-xl font-bold mb-4">Production Planning</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-end">
                    <div><label class="block text-sm font-medium">Product</label><select id="production-product" class="mt-1 w-full p-2 border rounded-md"><option value="">-- Select --</option>${productsOptions}</select></div>
                    <div><label class="block text-sm font-medium">Quantity to Produce</label><input type="number" id="production-qty" class="mt-1 w-full p-2 border rounded-md" placeholder="0"></div>
                    <div><label class="block text-sm font-medium">Packing Material</label><select id="production-packing-material" class="mt-1 w-full p-2 border rounded-md"></select></div>
                    <div><label class="block text-sm font-medium">Label</label><select id="production-label" class="mt-1 w-full p-2 border rounded-md"></select></div>
                </div>
                 <div class="mt-6"><button onclick="calculateNeeds()" class="w-full px-4 py-3 bg-blue-600 text-white rounded-lg font-semibold">Calculate Needs</button></div>
            </div>`;
            const packingSelect = document.getElementById('production-packing-material');
            packingSelect.innerHTML = '<option value="na">Not Applicable</option>' + appState.inventory.packingMaterials.map(i => `<option value="${i.id}">${i.name}</option>`).join('');
            const labelSelect = document.getElementById('production-label');
            labelSelect.innerHTML = '<option value="na">Not Applicable</option>' + appState.inventory.labels.map(i => `<option value="${i.id}">${i.name}</option>`).join('');
            document.getElementById('formula-search-filter').addEventListener('input', renderFormulasTable);
            renderFormulasTable();

            // CHECK PENDING ACTION (Auto-Created from 'Fetch Cost')
            if (window.pendingFormulaCreateName) {
                setTimeout(() => {
                    openFormulaModal();
                    const nameInput = document.getElementById('formula-name');
                    if (nameInput) {
                        nameInput.value = window.pendingFormulaCreateName;
                        // Optional: Highlight it
                        nameInput.style.backgroundColor = "#fef08a"; // yellow
                    }
                    window.pendingFormulaCreateName = null; // Clear flag
                }, 300);
            }
        }

        function renderFormulasTable() {
            const tableBody = document.getElementById('formulas-table-body');
            if (!tableBody) return;
            const searchFilter = document.getElementById('formula-search-filter').value.toLowerCase();
            let formulas = appState.formulas || [];
            const filteredFormulas = formulas.filter(formula => formula.name.toLowerCase().includes(searchFilter));

            // NOTE: This view strictly uses Master Data (findItem)
            // Calculator overrides are intentionally IGNORED here to preserve data integrity.
            tableBody.innerHTML = filteredFormulas.map((formula, index) => `<tr><td class="p-2 border-b text-center">${index + 1}</td><td class="p-2 border-b">${formula.name}</td><td class="p-2 border-b text-center">${formula.outputQty} ${formula.outputUnit}</td><td class="p-2 border-b text-sm text-left">${formula.ingredients.map(ing => { const item = findItem(ing.category, ing.itemId); return `<div>${ing.quantity.toFixed(4)} ${item?.unit || ''} ${item?.name || 'Unknown'}</div>`; }).join('')}</td><td class="p-2 border-b text-center"><div class="flex gap-1 justify-center"><button onclick="openFormulaModal(${formula.id})" class="px-2 py-1 text-xs bg-yellow-500 text-white rounded">Edit</button><button onclick="deleteFormula(${formula.id})" class="px-2 py-1 text-xs bg-gray-700 text-white rounded">Delete</button></div></td></tr>`).join('') || `<tr><td colspan="5" class="text-center py-4">No formulas added or found.</td></tr>`;
        }

        function renderExpiryTrackingView() {
            const container = document.getElementById('expiry-tracking-view');
            container.innerHTML = `
            <h2 class="text-3xl font-bold mb-6">Expiry Tracking</h2>
            <div class="bg-white p-6 rounded-lg shadow">
                <div class="flex mb-4 border-b">
                    <button class="px-4 py-2 text-lg font-semibold border-b-2 expiry-tab-button" data-tab="rawMaterials">Raw Materials</button>
                    <button class="px-4 py-2 text-lg font-semibold border-b-2 expiry-tab-button" data-tab="finishedGoods">Finished Goods</button>
                </div>
                <div id="rawMaterials-expiry-tab" class="expiry-tab-content"></div>
                <div id="finishedGoods-expiry-tab" class="expiry-tab-content hidden"></div>
            </div>`;

            document.querySelectorAll('.expiry-tab-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    if (e.target.classList.contains('active')) return;
                    document.querySelectorAll('.expiry-tab-button').forEach(btn => {
                        btn.classList.remove('active');
                        btn.classList.remove('text-blue-600');
                        btn.classList.remove('border-blue-600');
                        btn.classList.add('text-gray-400'); // Default inactive
                        btn.classList.add('border-transparent');
                    });

                    e.target.classList.add('active');
                    e.target.classList.remove('text-gray-400');
                    e.target.classList.remove('border-transparent');
                    e.target.classList.add('text-blue-600');
                    e.target.classList.add('border-blue-600');

                    document.querySelectorAll('.expiry-tab-content').forEach(content => content.classList.add('hidden'));
                    const tabId = e.target.dataset.tab;
                    document.getElementById(`${tabId}-expiry-tab`).classList.remove('hidden');
                    renderExpiryTable(tabId);
                });
            });

            // Initial Style Set
            document.querySelectorAll('.expiry-tab-button').forEach(btn => {
                if (!btn.classList.contains('active')) {
                    btn.classList.add('text-gray-400');
                    btn.classList.add('border-transparent');
                } else {
                    btn.classList.add('text-blue-600');
                    btn.classList.add('border-blue-600');
                }
            });

            document.querySelector('.expiry-tab-button[data-tab="rawMaterials"]').click();
        }

        function renderExpiryTable(category) {
            const container = document.getElementById(`${category}-expiry-tab`);
            const items = appState.inventory[category] || [];
            const today = getStartOfDay(getToday());

            const itemsWithExpiry = items.filter(item => item.expiryDate).map(item => {
                const expiryDate = getStartOfDay(item.expiryDate);
                const diffTime = expiryDate - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                let status = 'Safe';
                if (diffDays <= 0) status = 'Expired';
                else if (diffDays <= 30) status = 'Expiring Soon';
                return { ...item, diffDays, status };
            }).sort((a, b) => a.diffDays - b.diffDays);

            if (itemsWithExpiry.length === 0) {
                container.innerHTML = `<p class="text-gray-500">No items with expiry dates in this category.</p>`;
                return;
            }

            container.innerHTML = `
            <div class="overflow-x-auto"><table class="min-w-full bg-white border"><thead class="bg-gray-200"><tr><th class="p-2 border-b text-left">Item Name</th><th class="p-2 border-b">Expiry Date</th><th class="p-2 border-b">Days Remaining</th><th class="p-2 border-b">Status</th></tr></thead><tbody>
            ${itemsWithExpiry.map(item => {
                let statusClass = '';
                if (item.status === 'Expired') statusClass = 'bg-red-100 text-red-800';
                else if (item.status === 'Expiring Soon') statusClass = 'bg-orange-100 text-orange-800';
                else if (item.status === 'Safe') statusClass = 'bg-green-100 text-green-800';

                return `<tr class="text-center text-sm">
                    <td class="p-2 border-b text-left">${item.name}</td>
                    <td class="p-2 border-b">${item.expiryDate || 'N/A'}</td>
                    <td class="p-2 border-b">${item.diffDays !== null ? item.diffDays : 'N/A'}</td>
                    <td class="p-2 border-b"><span class="px-3 py-1 font-semibold rounded-full ${statusClass}">${item.status}</span></td>
                </tr>`
            }).join('')}
            </tbody></table></div>`;
        }


        function renderSuppliersView() {
            const container = document.getElementById('suppliers-view');
            container.innerHTML = `
            <div class="h-full flex flex-col p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold">Supplier Management</h2>
                    <div class="flex gap-2">
                         <button onclick="exportSuppliersCSV()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Export CSV</button>
                         <button onclick="openSupplierModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Add Supplier</button>
                    </div>
                </div>
                <div class="overflow-x-auto bg-white rounded-lg shadow">
                    <table class="min-w-full bg-white border">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-3 border text-left">Supplier Name</th>
                                <th class="p-3 border text-left">Contact Person</th>
                                <th class="p-3 border text-left">Phone/Email</th>
                                <th class="p-3 border text-center">Status</th>
                                <th class="p-3 border text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="suppliers-table-body">
                            ${(appState.suppliers || []).map(s => `
                                <tr id="row-suppliers-${s.id}" data-item-id="${s.id}">
                                    <td class="p-3 border font-medium">
                                        <span class="cursor-pointer text-blue-600 hover:underline font-bold" onclick="viewSupplierHistory(${s.id})">${s.name}</span>
                                    </td>
                                    <td class="p-3 border">${s.contactPerson || '-'}</td>
                                    <td class="p-3 border text-sm">${s.phone}<br>${s.email}</td>
                                    <td class="p-3 border text-center">
                                        <span class="px-2 py-1 rounded-full text-xs ${s.approved ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                            ${s.approved ? 'Approved' : 'Pending'}
                                        </span>
                                    </td>
                                    <td class="p-3 border text-center">
                                        <button onclick="editSupplier(${s.id})" class="text-blue-600 hover:text-blue-800 text-sm">Edit</button>
                                    </td>
                                </tr>
                            `).join('') || '<tr><td colspan="5" class="p-4 text-center text-gray-500">No suppliers added yet.</td></tr>'}
                        </tbody>
                    </table>
                </div>
            </div>`;
        }

        // Helper to ensure modal functions exist
        if (typeof window.openModal !== 'function') {
            window.openModal = function (id) {
                const el = document.getElementById(id);
                if (el) {
                    el.classList.remove('hidden');
                    el.style.display = 'flex';
                }
            };
        }
        if (typeof window.closeModal !== 'function') {
            window.closeModal = function (id) {
                const el = document.getElementById(id);
                if (el) {
                    el.classList.add('hidden');
                    el.style.display = 'none';
                }
            };
        }

        window.viewSupplierHistory = function (supplierId) {
            const supplier = appState.suppliers.find(s => s.id === supplierId);
            if (!supplier) return;

            const txs = appState.transactions.filter(t =>
                (t.type === 'receive' || t.type === 'po') &&
                (
                    (t.supplierId && t.supplierId == supplierId) ||
                    (t.party && t.party.toLowerCase().includes(supplier.name.toLowerCase())) ||
                    (t.supplier && t.supplier.toLowerCase() === supplier.name.toLowerCase())
                )
            ).sort((a, b) => new Date(b.date) - new Date(a.date));

            // Create unique modal to avoid conflicts
            const modalId = 'supplierHistoryModal';
            let modal = document.getElementById(modalId);
            if (modal) modal.remove(); // Re-create to ensure clean state

            const htmlContent = `
             <div class="p-2">
                 <h3 class="text-xl font-bold mb-4">History for: <span class="text-blue-600">${supplier.name}</span></h3>
                 <div class="overflow-x-auto max-h-[60vh]">
                    <table class="min-w-full text-sm text-left border">
                        <thead class="bg-gray-100 sticky top-0">
                            <tr>
                                <th class="p-2 border">Date</th>
                                <th class="p-2 border">Type</th>
                                <th class="p-2 border">Item</th>
                                <th class="p-2 border text-right">Qty</th>
                                <th class="p-2 border text-right">Price</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${txs.length > 0 ? txs.map(t => {
                const item = findItem(t.category, t.itemId);
                return `
                                <tr class="border-b hover:bg-gray-50">
                                    <td class="p-2 border">${t.date.split('T')[0]}</td>
                                    <td class="p-2 border capitalize">${t.type}</td>
                                    <td class="p-2 border">${item ? item.name : 'Unknown'}</td>
                                    <td class="p-2 border text-right font-mono">${t.quantity}</td>
                                    <td class="p-2 border text-right font-mono">Rs. ${t.purchasePrice || '-'}</td>
                                </tr>`;
            }).join('') : '<tr><td colspan="5" class="p-4 text-center text-gray-500">No transactions found.</td></tr>'}
                        </tbody>
                    </table>
                 </div>
                 <div class="mt-6 flex justify-end">
                    <button onclick="document.getElementById('${modalId}').remove()" class="px-6 py-2 bg-gray-800 text-white rounded hover:bg-gray-700">Close Window</button>
                 </div>
             </div>
             `;

            const modalHtml = `
             <div id="${modalId}" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-[100]" style="display: flex;">
                 <div class="bg-white p-6 rounded-lg shadow-2xl w-full max-w-4xl relative">
                    <button onclick="document.getElementById('${modalId}').remove()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-800 text-2xl font-bold">&times;</button>
                    ${htmlContent}
                 </div>
             </div>
             `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        };

        function renderSalesDispatchView() {
            const container = document.getElementById('sales-dispatch-view');
            // Get all dispatch transactions
            const dispatches = appState.transactions.filter(t => t.type === 'dispatch').sort((a, b) => new Date(b.date) - new Date(a.date));

            container.innerHTML = `
            <h2 class="text-3xl font-bold mb-6">Sales & Dispatch</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-blue-50 p-6 rounded-lg border border-blue-100">
                    <h3 class="font-bold text-blue-800 mb-2">Total Dispatches</h3>
                    <p class="text-3xl font-bold text-blue-900">${dispatches.length}</p>
                </div>
                <div class="bg-green-50 p-6 rounded-lg border border-green-100">
                    <h3 class="font-bold text-green-800 mb-2">Active Customers</h3>
                    <p class="text-3xl font-bold text-green-900">${(appState.customers || []).length}</p>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow mb-8">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold">Sales & Dispatch Log <span class="text-sm text-gray-500">(Serial-wise Tracking)</span></h3>
                    <div class="flex gap-2">
                        <input type="text" id="dispatch-search" placeholder="Search Dispatch..." class="px-3 py-2 border rounded text-sm" onkeyup="filterDispatchTable()">
                        <button onclick="openCustomerModal()" class="px-3 py-2 bg-gray-600 text-white rounded text-sm">Manage Customers</button>
                        <button onclick="exportCSV()" class="px-3 py-2 bg-green-600 text-white rounded text-sm">Export CSV</button>
                        <button onclick="openDispatchModal()" class="px-4 py-2 bg-blue-600 text-white rounded font-bold">+ New Dispatch</button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white border text-sm">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-2 border text-center bg-gray-200">#</th>
                                <th class="p-2 border text-left">Date</th>
                                <th class="p-2 border text-left">Customer</th>
                                <th class="p-2 border text-left">Type</th>
                                <th class="p-2 border text-left">Item</th>
                                <th class="p-2 border text-right">Qty</th>
                                <th class="p-2 border text-left">Batch</th>
                                <th class="p-2 border text-left">Inv/DC No</th>
                                <th class="p-2 border text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${dispatches.map((d, index) => {
                const item = findItem(d.category, d.itemId);
                return `
                                <tr>
                                    <td class="p-2 border text-center font-bold text-gray-700 bg-gray-50">${index + 1}</td>
                                    <td class="p-2 border">${d.date.split('T')[0]}</td>
                                    <td class="p-2 border font-medium">
                                        ${d.customerId ? `<span class="cursor-pointer text-blue-600 hover:underline" onclick="viewCustomerHistory(${d.customerId})">${d.customerName}</span>` : d.customerName}
                                    </td>
                                    <td class="p-2 border capitalize">${d.dispatchPurpose || 'Sale'}</td>
                                    <td class="p-2 border">${item ? item.name : 'Unknown Item'}</td>
                                    <td class="p-2 border text-right font-bold">${d.quantity} ${item?.unit}</td>
                                    <td class="p-2 border text-xs font-mono">${d.batchNo || '-'}</td>
                                    <td class="p-2 border">${d.invoiceNo || '-'}</td>
                                    <td class="p-2 border text-center">
                                        <button onclick="openProductTrace('${d.itemId}')" class="p-1 text-blue-600 hover:text-blue-800" title="Trace Product">🔍</button>
                                    </td>
                                </tr>
                            `}).join('') || '<tr><td colspan="8" class="p-4 text-center text-gray-500">No dispatches recorded.</td></tr>'}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
        }
        // Filter dispatch table by search term
        window.filterDispatchTable = function () {
            const searchTerm = document.getElementById('dispatch-search').value.toLowerCase();
            const table = document.querySelector('#sales-dispatch-view table tbody');
            const rows = table.getElementsByTagName('tr');

            for (let row of rows) {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            }
        };

        // Export dispatch data to CSV 
        window.exportDispatchCSV = function () {
            const dispatches = appState.transactions.filter(t => t.type === 'dispatch').sort((a, b) => new Date(b.date) - new Date(a.date));

            let csv = 'Serial,Date,Customer,Type,Item,Quantity,Unit,Batch,Invoice No\n';
            dispatches.forEach((d, index) => {
                const item = findItem(d.category, d.itemId);
                const row = [
                    index + 1,
                    d.date.split('T')[0],
                    d.customerName || 'Unknown',
                    d.dispatchPurpose || 'Sale',
                    item ? item.name : 'Unknown',
                    d.quantity,
                    item?.unit || '',
                    d.batchNo || '-',
                    d.invoiceNo || '-'
                ].map(v => `"${v}"`).join(',');
                csv += row + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `dispatch_log_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        };

        // INSTRUCTIONS:
        // Copy these two functions and paste them right after the renderSalesDispatchView function
        // (after line 4695 in the INVENTORY APP CODE.txt file)

        // --- MODAL HANDLING & FORMS ---
        function openModal(modalId) {
            const el = document.getElementById(modalId);
            el.classList.remove('hidden');
            el.classList.add('flex');
        }
        function closeModal(modalId) {
            const el = document.getElementById(modalId);
            el.classList.remove('flex');
            el.classList.add('hidden'); // Ensure hidden is added back
        }

        function showAlert(message, title = "Alert") {
            document.getElementById('generic-modal-title').textContent = title;
            document.getElementById('generic-modal-message').textContent = message;
            document.getElementById('generic-modal-cancel').classList.add('hidden');
            document.getElementById('generic-modal-confirm').textContent = 'OK';
            document.getElementById('generic-modal-confirm').onclick = () => closeModal('genericMessageModal');
            const modal = document.getElementById('genericMessageModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            modal.style.zIndex = '9999';
        }


        function showConfirm(message, onConfirm, title = "Confirm") {
            document.getElementById('generic-modal-title').textContent = title;
            document.getElementById('generic-modal-message').textContent = message;
            document.getElementById('generic-modal-cancel').classList.remove('hidden');
            document.getElementById('generic-modal-confirm').textContent = 'Proceed';
            document.getElementById('generic-modal-confirm').onclick = () => {
                closeModal('genericMessageModal');
                onConfirm();
            };
            document.getElementById('generic-modal-cancel').onclick = () => closeModal('genericMessageModal');
            openModal('genericMessageModal');
        }

        function toggleExpiryDateField() {
            const category = document.getElementById('item-category').value;
            const expiryContainer = document.getElementById('expiry-date-container');
            if (category === 'rawMaterials' || category === 'finishedGoods') {
                expiryContainer.classList.remove('hidden');
            } else {
                expiryContainer.classList.add('hidden');
            }
        }

        function openAddItemModal(category = 'rawMaterials') {
            if (!checkPermission()) return;
            document.getElementById('item-form').reset();
            document.getElementById('item-modal-title').textContent = 'Add New Item';
            document.getElementById('edit-item-id').value = '';
            document.getElementById('item-category').value = category;
            document.getElementById('item-stock-date').value = getToday();
            document.getElementById('item-min-stock-level').value = 0; // Default for new items
            document.getElementById('delete-item-btn').classList.add('hidden');
            toggleExpiryDateField();
            openModal('addItemModal');
        }

        function openEditItemModal(category, id) {
            if (!checkPermission()) return;
            const item = findItem(category, id);
            if (!item) return;
            document.getElementById('item-form').reset();
            document.getElementById('item-modal-title').textContent = 'Edit Item';
            document.getElementById('edit-item-id').value = item.id;
            document.getElementById('edit-item-category-field').value = category;
            document.getElementById('item-category').value = category;
            document.getElementById('item-name').value = item.name;
            document.getElementById('item-unit').value = item.unit;
            document.getElementById('item-price').value = item.price;
            document.getElementById('item-stock').value = item.openingStock;
            document.getElementById('item-stock-date').value = item.openingStockDate;
            document.getElementById('item-expiry-date').value = item.expiryDate || '';
            document.getElementById('item-min-stock-level').value = item.minStockLevel !== undefined ? item.minStockLevel : 0; // Load existing min stock level

            const deleteBtn = document.getElementById('delete-item-btn');
            deleteBtn.classList.remove('hidden');
            deleteBtn.onclick = () => handleDeleteItem();

            toggleExpiryDateField();
            openModal('addItemModal');
        }

        let consumptionEntries = [];
        function openStockTxModal(category, id, type, initialSubtype = null) {
            if (!checkPermission()) return;
            const item = findItem(category, id);
            if (!item) return;
            consumptionEntries = [];
            document.getElementById('stock-tx-form').reset();

            document.getElementById('tx-item-id').value = id;
            document.getElementById('tx-item-category').value = category;
            document.getElementById('tx-type').value = type;
            document.getElementById('tx-item-name').textContent = item.name;
            document.getElementById('tx-date').value = selectedDate;
            document.getElementById('tx-quantity').value = '';
            document.getElementById('tx-purchase-price').value = '';

            // Show/hide purchase price field based on transaction type
            const purchasePriceField = document.getElementById('purchase-price-field');
            const standardPriceDisplay = document.getElementById('standard-price-display');
            const titleEl = document.getElementById('stock-tx-modal-title');

            if (type === 'receive') {
                titleEl.textContent = `Receive: ${item.name}`;
                purchasePriceField.classList.remove('hidden');
                standardPriceDisplay.textContent = `₹${item.price}/${item.unit}`;
                // Pre-fill with current average cost as suggestion
                document.getElementById('tx-purchase-price').value = item.currentAverageCost || item.price;

                // Show ERP Fields for Receiving
                document.getElementById('erp-receive-fields').classList.remove('hidden');
                populateSupplierSelect();

                // Specific Logic for Finished Goods Receive
                if (category === 'finishedGoods') {
                    // Check if 'Miklens Bio' exists, if not add it temp or find it
                    let miklens = appState.suppliers.find(s => s.name.toLowerCase().includes('miklens'));
                    if (!miklens) {
                        // Auto-create defaults if missing (just in memory for now or prompt? Better to just select if exists)
                        // For now, let's try to set the select value by text if possible, or just add an option
                        const select = document.getElementById('tx-supplier');
                        const opt = document.createElement('option');
                        opt.value = 'Miklens Bio Default';
                        opt.textContent = 'Miklens Bio (Internal)';
                        opt.selected = true;
                        select.appendChild(opt);
                    } else {
                        const select = document.getElementById('tx-supplier');
                        select.value = miklens.id;
                    }
                }
            } else {
                titleEl.textContent = `Consume: ${item.name}`;
                purchasePriceField.classList.add('hidden');
                document.getElementById('erp-receive-fields').classList.add('hidden');
            }

            const calculator = document.getElementById('consumption-calculator');
            const quantityInput = document.getElementById('tx-quantity');
            if (type === 'consume') {
                calculator.classList.remove('hidden');
                quantityInput.readOnly = false;
                document.getElementById('add-consumption-btn').onclick = addConsumptionEntry;
                document.getElementById('clear-consumption-btn').onclick = clearConsumptionEntries;

                // Show Batch Selection for Consumption
                document.getElementById('erp-consume-fields').classList.remove('hidden');
                populateBatchSelect(item, category);

                // Force refresh of Wastage Options to ensure they appear
                let subtypeContainer = document.getElementById('tx-subtype-container');
                if (!subtypeContainer) {
                    const div = document.createElement('div');
                    div.id = 'tx-subtype-container';
                    div.className = 'mt-4 border-t pt-2';
                    // Inject into erp-consume-fields so it toggles with consumption view
                    const container = document.getElementById('erp-consume-fields');
                    if (container) {
                        container.appendChild(div);
                        subtypeContainer = div;
                    }
                }

                if (subtypeContainer) {
                    subtypeContainer.innerHTML = `
                        <label class="block text-sm font-medium mb-2">Consumption Type / Reason:</label>
                        <div class="grid grid-cols-2 gap-2">
                            <label class="flex items-center"><input type="radio" name="tx-subtype" value="regular" checked class="mr-2"> Regular Production</label>
                            <label class="flex items-center"><input type="radio" name="tx-subtype" value="wastage" class="mr-2"> Wastage / Spillage</label>
                            <label class="flex items-center"><input type="radio" name="tx-subtype" value="expired" class="mr-2"> Expired / Destroyed</label>
                            <label class="flex items-center"><input type="radio" name="tx-subtype" value="unusable" class="mr-2"> Unusable (QC Failed)</label>
                            <label class="flex items-center"><input type="radio" name="tx-subtype" value="other" class="mr-2"> Other</label>
                        </div>
                    `;
                }

                // Select subtype if provided
                if (initialSubtype) {
                    const rb = document.querySelector(`input[name="tx-subtype"][value="${initialSubtype}"]`);
                    if (rb) rb.checked = true;
                }

                // Add "Quick Sell" button for Finished Goods
                if (category === 'finishedGoods') {
                    // Check if button already exists to avoid dupes
                    if (!document.getElementById('fg-quick-sell-btn')) {
                        const btn = document.createElement('button');
                        btn.id = 'fg-quick-sell-btn';
                        btn.className = 'mt-4 w-full bg-blue-600 text-white py-2 rounded-lg font-bold hover:bg-blue-700';
                        btn.textContent = 'Go to New Sale / Dispatch';
                        btn.onclick = (e) => {
                            e.preventDefault();
                            closeModal('stockTxModal');
                            openDispatchModal(item.id);
                        };
                        const container = document.getElementById('erp-consume-fields');
                        if (container) {
                            // Check if button already exists to avoid dupes (though logic above tries)
                            if (!document.getElementById('fg-quick-sell-btn')) container.appendChild(btn);
                        }
                    }
                }
            } else {
                calculator.classList.add('hidden');
                document.getElementById('erp-consume-fields').classList.add('hidden');
                quantityInput.readOnly = false;
            }
            renderConsumptionList();
            openModal('stockTxModal');
        }

        function populateSupplierSelect() {
            const select = document.getElementById('tx-supplier');
            select.innerHTML = '<option value="">-- Select Supplier --</option>';
            // Add "Unknown/Adjustment" option
            select.innerHTML += '<option value="adjustment">Opening Bal / Adjustment</option>';

            if (appState.suppliers) {
                appState.suppliers.forEach(s => {
                    if (s.approved) {
                        const option = document.createElement('option');
                        option.value = s.id;
                        option.textContent = s.name;
                        select.appendChild(option);
                    }
                });
            }
        }

        function populateBatchSelect(item, category) {
            const select = document.getElementById('tx-consume-batch');
            select.innerHTML = '<option value="">FIFO / Unspecified</option>';

            // Find all unique batches for this item with positive balance
            // This requires calculating stock per batch.
            // For now, we just list batches that have ever been received.
            // A more advanced calc would filter out exhausted batches.

            const batches = {};
            appState.transactions.forEach(tx => {
                if (tx.category === category && tx.itemId === item.id && tx.batchNo) {
                    if (!batches[tx.batchNo]) batches[tx.batchNo] = 0;
                    if (tx.type === 'receive') batches[tx.batchNo] += tx.quantity;
                    else if (tx.type === 'consume') batches[tx.batchNo] -= tx.quantity;
                }
            });

            Object.keys(batches).forEach(batchNo => {
                if (batches[batchNo] > 0) {
                    const option = document.createElement('option');
                    option.value = batchNo;
                    option.textContent = `${batchNo} (Approx: ${batches[batchNo].toFixed(2)} ${item.unit})`;
                    select.appendChild(option);
                }
            });
        }

        function addConsumptionEntry() {
            const input = document.getElementById('consumption-input');
            const value = parseFloat(input.value);
            if (value > 0) {
                consumptionEntries.push(value);
                input.value = '';
                renderConsumptionList();
            }
            input.focus();
        }

        function clearConsumptionEntries() {
            consumptionEntries = [];
            renderConsumptionList();
        }

        function renderConsumptionList() {
            const list = document.getElementById('consumption-list');
            const total = consumptionEntries.reduce((sum, val) => sum + val, 0);
            document.getElementById('tx-quantity').value = total;
            list.innerHTML = consumptionEntries.length > 0 ? consumptionEntries.join(' + ') : '<span class="text-gray-400">No entries yet.</span>';
        }

        function openEditTxModal(txId) {
            if (!checkPermission()) return;
            const tx = appState.transactions.find(t => t.id == txId);
            if (!tx) return;
            document.getElementById('edit-tx-id').value = tx.id;
            document.getElementById('edit-tx-quantity').value = tx.quantity;
            document.getElementById('edit-tx-date').value = tx.date.split('T')[0];
            const itemSelect = document.getElementById('edit-tx-item');
            itemSelect.innerHTML = '';
            Object.keys(appState.inventory).forEach(cat => {
                const optgroup = document.createElement('optgroup');
                optgroup.label = cat.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                appState.inventory[cat].forEach(item => {
                    const option = document.createElement('option');
                    option.value = `${cat}-${item.id}`;
                    option.textContent = item.name;
                    if (item.id == tx.itemId && cat === tx.category) option.selected = true;
                    optgroup.appendChild(option);
                });
                itemSelect.appendChild(optgroup);
            });
            openModal('editTxModal');
        }

        function openFormulaModal(formulaId = null) {
            if (!checkPermission()) return;
            const form = document.getElementById('formula-form');
            form.reset();
            document.getElementById('ingredients-container').innerHTML = '<h4 class="font-medium text-gray-800 mt-4">Raw Materials</h4>';
            document.getElementById('packing-container').innerHTML = '<h4 class="font-medium text-gray-800 mt-4">Packing Materials</h4>';
            document.getElementById('labels-container').innerHTML = '<h4 class="font-medium text-gray-800 mt-4">Labels</h4>';
            if (formulaId) {
                const formula = appState.formulas.find(f => f.id == formulaId);
                if (!formula) return;
                document.getElementById('formula-modal-title').textContent = 'Edit Product Formula';
                document.getElementById('edit-formula-id').value = formula.id;
                document.getElementById('formula-name').value = formula.name;
                document.getElementById('formula-output-qty').value = formula.outputQty;
                document.getElementById('formula-output-unit').value = formula.outputUnit;
                formula.ingredients.forEach(ing => addIngredientInput(ing));
                if (formula.packingMaterials) formula.packingMaterials.forEach(pm => addPackingInput(pm));
                if (formula.labels) formula.labels.forEach(l => addLabelInput(l));
            } else {
                document.getElementById('formula-modal-title').textContent = 'Add New Product Formula';
                document.getElementById('edit-formula-id').value = '';
                addIngredientInput();
                addPackingInput();
                addLabelInput();
            }
            openModal('formulaModal');
        }

        function handleItemFormSubmit(e) {
            e.preventDefault();
            if (!checkPermission()) return;
            const id = document.getElementById('edit-item-id').value;
            const category = document.getElementById('item-category').value;
            const itemData = {
                name: document.getElementById('item-name').value,
                unit: document.getElementById('item-unit').value,
                price: parseFloat(document.getElementById('item-price').value) || 0,
                openingStock: parseFloat(document.getElementById('item-stock').value) || 0,
                openingStockDate: document.getElementById('item-stock-date').value || getToday(),
                minStockLevel: parseFloat(document.getElementById('item-min-stock-level').value) || 0, // Save min stock level
                notes: [] // Initialize notes array for new items
            };
            if (category === 'rawMaterials' || category === 'finishedGoods') {
                itemData.expiryDate = document.getElementById('item-expiry-date').value || null;
            }

            if (id) {
                const itemIndex = appState.inventory[category].findIndex(i => i.id == id);
                if (itemIndex > -1) {
                    // Preserve existing notes if editing
                    const existingNotes = appState.inventory[category][itemIndex].notes || [];
                    appState.inventory[category][itemIndex] = { ...appState.inventory[category][itemIndex], ...itemData, notes: existingNotes };
                }
            } else {
                itemData.id = Date.now() + Math.random();
                if (!appState.inventory[category]) appState.inventory[category] = [];
                appState.inventory[category].push(itemData);
            }

            saveState();
            logActivity(id ? 'Edit Item' : 'Add Item', `${id ? 'Updated' : 'Created'} item ${itemData.name} in ${category}`);
            closeModal('addItemModal');
            showView(currentView);
        }

        function handleDeleteItem() {
            if (!checkPermission()) return;
            const id = document.getElementById('edit-item-id').value;
            const category = document.getElementById('edit-item-category-field').value;
            const item = findItem(category, id);

            if (!item) return;

            showConfirm(`Are you sure you want to permanently delete "${item.name}"? This will also remove all of its transaction history and cannot be undone.`, () => {
                appState.inventory[category] = appState.inventory[category].filter(i => i.id != id);
                appState.transactions = appState.transactions.filter(tx => !(tx.category === category && tx.itemId == id));
                saveState();
                closeModal('addItemModal');
                showView(currentView);
            }, "Confirm Delete");
        }

        function handleStockTxFormSubmit(e) {
            e.preventDefault();
            if (!checkPermission()) return;
            const txDate = document.getElementById('tx-date').value;
            const quantity = parseFloat(document.getElementById('tx-quantity').value);
            const purchasePrice = parseFloat(document.getElementById('tx-purchase-price').value) || 0;
            const itemId = parseFloat(document.getElementById('tx-item-id').value);
            const category = document.getElementById('tx-item-category').value;
            const type = document.getElementById('tx-type').value;

            // --- AUTO ALLOCATION LOGIC ---
            // If type is Consume or Dispatch, and NO specific batch is selected, we auto-allocate.
            // For Manual Entry (this form), 'consume' can have a batch selection.

            const selectedBatch = document.getElementById('tx-consume-batch').value;
            let finalTransactions = [];

            // 1. Prepare Base Transaction Object
            const baseTx = {
                id: Date.now() + Math.random(),
                itemId: itemId,
                category: category,
                type: type,
                date: txDate + 'T00:00:00.000Z',
                userName: currentUserName || 'Guest'
            };

            // 2. Handle Allocation
            if ((type === 'consume' || type === 'dispatch') && !selectedBatch) {
                // Auto-Allocate using helper
                // Determine Mode: FIFO for Consume/Raw, FEFO for Dispatch/FG
                const itemData = findItem(category, itemId);
                const mode = (category === 'finishedGoods' || type === 'dispatch') ? 'FEFO' : 'FIFO';

                // For this form, 'dispatch' allows batch selection too? 
                // Wait, this form handles 'receive' and 'consume'. Dispatch is via openDispatchModal.
                // BUT 'consume' is here.

                const allocation = allocateStock(itemData, category, quantity, mode);

                allocation.forEach((alloc, idx) => {
                    const splitTx = { ...baseTx };
                    splitTx.id = Date.now() + Math.random() + idx; // Ensure unique IDs
                    splitTx.quantity = alloc.quantity;
                    splitTx.batchNo = alloc.batchNo;
                    if (type === 'consume') {
                        const subtypeEl = document.querySelector('input[name="tx-subtype"]:checked');
                        if (subtypeEl) splitTx.subtype = subtypeEl.value;
                    }
                    finalTransactions.push(splitTx);
                });

                if (finalTransactions.length === 0) {
                    // Fallback if allocation returns empty (shouldn't happen with null fallback)
                    baseTx.quantity = quantity;
                    finalTransactions.push(baseTx);
                }

                logActivity('Auto-Allocation', `Auto-allocated ${quantity} of ${itemData.name} across ${finalTransactions.length} batches (${mode}).`);

            } else {
                // Standard Single Transaction (Receive, or Consume with specific batch)
                baseTx.quantity = quantity;

                if (type === 'receive') {
                    if (purchasePrice > 0) {
                        baseTx.purchasePrice = purchasePrice;
                        const item = findItem(category, itemId);
                        if (item) updateWeightedAverageCost(item, category, quantity, purchasePrice, txDate);
                    }
                    const rawSuppId = document.getElementById('tx-supplier').value;
                    baseTx.supplierId = rawSuppId ? parseFloat(rawSuppId) : null;
                    baseTx.poNo = document.getElementById('tx-po-no').value || null;
                    baseTx.invoiceNo = document.getElementById('tx-invoice-no').value || null;
                    baseTx.batchNo = document.getElementById('tx-batch-no').value || null;
                    baseTx.mfgDate = document.getElementById('tx-mfg-date').value || null;
                    const expDate = document.getElementById('tx-exp-date').value || null;
                    baseTx.expDate = expDate;

                    if (expDate) {
                        const item = findItem(category, itemId);
                        if (item && (!item.expiryDate || new Date(expDate) < new Date(item.expiryDate))) {
                            const idx = appState.inventory[category].findIndex(i => i.id == itemId);
                            if (idx > -1) appState.inventory[category][idx].expiryDate = expDate;
                        }
                    }
                }

                if (type === 'consume') {
                    if (selectedBatch) baseTx.batchNo = selectedBatch;
                    const subtypeEl = document.querySelector('input[name="tx-subtype"]:checked');
                    if (subtypeEl) baseTx.subtype = subtypeEl.value;
                }

                finalTransactions.push(baseTx);
            }

            // 3. Push All Transactions
            finalTransactions.forEach(tx => appState.transactions.push(tx));

            saveState();
            const itemData = findItem(category, itemId);
            logActivity('Stock Transaction', `${type.toUpperCase()}: ${quantity} ${itemData?.unit || ''} of ${itemData?.name || 'Item ' + itemId}`, {
                category: category,
                itemId: itemId,
                itemName: itemData?.name,
                newValue: `${quantity} ${itemData?.unit || ''}`
            });
            closeModal('stockTxModal');
            showView(currentView);
        }

        function handleEditTxFormSubmit(e) {
            e.preventDefault();
            if (!checkPermission()) return;
            const txId = document.getElementById('edit-tx-id').value;
            const newQuantity = parseFloat(document.getElementById('edit-tx-quantity').value);
            const newDate = document.getElementById('edit-tx-date').value;
            if (newQuantity === 0) {
                showConfirm("Setting quantity to 0 will delete this transaction. Proceed?", () => {
                    appState.transactions = appState.transactions.filter(t => t.id != txId);
                    saveState();
                    closeModal('editTxModal');
                    showView(currentView);
                }, "Confirm Deletion");
            } else {
                const txIndex = appState.transactions.findIndex(t => t.id == txId);
                if (txIndex === -1) return;
                const [category, itemId] = document.getElementById('edit-tx-item').value.split('-');
                const pItem = parseFloat(itemId);

                appState.transactions[txIndex].category = category;
                appState.transactions[txIndex].itemId = pItem;
                appState.transactions[txIndex].quantity = newQuantity;
                appState.transactions[txIndex].date = newDate + 'T00:00:00.000Z';
                saveState();
                closeModal('editTxModal');
                showView(currentView);

                // Refresh History Modal if open (Fix for real-time update issue)
                const historyModal = document.getElementById('itemHistoryModal');
                if (historyModal && !historyModal.classList.contains('hidden')) {
                    openItemHistoryModal(category, pItem);
                }
            }
        }

        function handlePasswordSubmit(e) {
            e.preventDefault();
            const password = document.getElementById('password-input').value;
            const errorEl = document.getElementById('password-error');
            if (password === 'MIKLENS2016') {
                isFormulaUnlocked = true;
                errorEl.classList.add('hidden');
                document.getElementById('password-input').value = '';
                closeModal('passwordModal');
                showView('formulations');
            } else {
                errorEl.classList.remove('hidden');
            }
        }

        function undoLastTransaction(category, itemId, type) {
            if (!checkPermission()) return;
            // Filter out specific transaction types for undo. Stock-take and production are not directly undone here.
            const allowedUndoTypes = ['receive', 'consume'];
            if (!allowedUndoTypes.includes(type)) {
                showAlert(`Undo is only available for 'receive' and 'consume' transactions.`);
                return;
            }

            const itemTransactions = appState.transactions.filter(tx => tx.category === category && tx.itemId == itemId && tx.type === type).sort((a, b) => new Date(b.date) - new Date(a.date));
            if (itemTransactions.length > 0) {
                const lastTx = itemTransactions[0];
                showConfirm(`Undo last ${lastTx.type} of ${lastTx.quantity.toFixed(3)} for ${findItem(category, itemId).name}?`, () => {
                    appState.transactions = appState.transactions.filter(tx => tx.id !== lastTx.id);
                    saveState();
                    showView(currentView);
                }, "Confirm Undo");
            } else {
                showAlert(`No recent '${type}' transaction found for this item.`);
            }
        }

        function addIngredientInput(ingredient = null) {
            const container = document.getElementById('ingredients-container');
            const ingredientDiv = document.createElement('div');
            ingredientDiv.className = 'grid grid-cols-12 gap-2 items-center mb-2';
            const allItems = appState.inventory.rawMaterials.map(i => ({ ...i, category: 'rawMaterials' }));
            const options = allItems.map(item => `<option value="${item.category}-${item.id}" ${ingredient && ingredient.category === item.category && ingredient.itemId == item.id ? 'selected' : ''}>${item.name}</option>`).join('');
            ingredientDiv.innerHTML = `<div class="col-span-7"><select class="ingredient-item w-full p-2 border rounded-md text-sm"><option value="">Select Ingredient</option>${options}</select></div><div class="col-span-4"><input type="number" step="any" class="ingredient-quantity w-full p-2 border rounded-md" placeholder="Qty" value="${ingredient ? ingredient.quantity : ''}"></div><div class="col-span-1"><button type="button" onclick="this.parentElement.parentElement.remove()" class="text-red-500 hover:text-red-700">&times;</button></div>`;
            container.appendChild(ingredientDiv);
        }

        function addPackingInput(item = null) {
            const container = document.getElementById('packing-container');
            const div = document.createElement('div');
            div.className = 'grid grid-cols-12 gap-2 items-center mb-2';
            const allItems = appState.inventory.packingMaterials.map(i => ({ ...i, category: 'packingMaterials' }));
            const options = allItems.map(i => `<option value="${i.category}-${i.id}" ${item && item.category === i.category && item.itemId == i.id ? 'selected' : ''}>${i.name}</option>`).join('');
            div.innerHTML = `<div class="col-span-7"><select class="packing-item w-full p-2 border rounded-md text-sm"><option value="">Select Packing Material</option>${options}</select></div><div class="col-span-4"><input type="number" step="any" class="packing-quantity w-full p-2 border rounded-md" placeholder="Qty" value="${item ? item.quantity : ''}"></div><div class="col-span-1"><button type="button" onclick="this.parentElement.parentElement.remove()" class="text-red-500 hover:text-red-700">&times;</button></div>`;
            container.appendChild(div);
        }

        function addLabelInput(item = null) {
            const container = document.getElementById('labels-container');
            const div = document.createElement('div');
            div.className = 'grid grid-cols-12 gap-2 items-center mb-2';
            const allItems = appState.inventory.labels.map(i => ({ ...i, category: 'labels' }));
            const options = allItems.map(i => `<option value="${i.category}-${i.id}" ${item && item.category === i.category && item.itemId == i.id ? 'selected' : ''}>${i.name}</option>`).join('');
            div.innerHTML = `<div class="col-span-7"><select class="label-item w-full p-2 border rounded-md text-sm"><option value="">Select Label</option>${options}</select></div><div class="col-span-4"><input type="number" step="any" class="label-quantity w-full p-2 border rounded-md" placeholder="Qty" value="${item ? item.quantity : ''}"></div><div class="col-span-1"><button type="button" onclick="this.parentElement.parentElement.remove()" class="text-red-500 hover:text-red-700">&times;</button></div>`;
            container.appendChild(div);
        }

        function handleFormulaFormSubmit(e) {
            e.preventDefault();
            if (!checkPermission()) return;
            const id = document.getElementById('edit-formula-id').value;

            const ingredients = [];
            document.querySelectorAll('#ingredients-container .grid').forEach(div => {
                const select = div.querySelector('.ingredient-item');
                const [category, itemId] = select.value.split('-');
                const quantity = parseFloat(div.querySelector('.ingredient-quantity').value);
                if (category && itemId && quantity > 0) ingredients.push({ category, itemId: parseFloat(itemId), quantity });
            });

            const packingMaterials = [];
            document.querySelectorAll('#packing-container .grid').forEach(div => {
                const select = div.querySelector('.packing-item');
                const [category, itemId] = select.value.split('-');
                const quantity = parseFloat(div.querySelector('.packing-quantity').value);
                if (category && itemId && quantity > 0) packingMaterials.push({ category, itemId: parseFloat(itemId), quantity });
            });

            const labels = [];
            document.querySelectorAll('#labels-container .grid').forEach(div => {
                const select = div.querySelector('.label-item');
                const [category, itemId] = select.value.split('-');
                const quantity = parseFloat(div.querySelector('.label-quantity').value);
                if (category && itemId && quantity > 0) labels.push({ category, itemId: parseFloat(itemId), quantity });
            });

            const newFormulaData = {
                name: document.getElementById('formula-name').value,
                outputQty: parseFloat(document.getElementById('formula-output-qty').value),
                outputUnit: document.getElementById('formula-output-unit').value,
                ingredients,
                packingMaterials,
                labels
            };

            if (id) {
                const index = appState.formulas.findIndex(f => f.id == id);
                if (index > -1) appState.formulas[index] = { ...appState.formulas[index], ...newFormulaData };
            } else {
                newFormulaData.id = Date.now() + Math.random();
                appState.formulas.push(newFormulaData);
            }
            saveState();
            closeModal('formulaModal');
            renderFormulationsView();
        }

        function deleteFormula(id) {
            if (!checkPermission()) return;
            showConfirm('Are you sure you want to delete this formula?', () => {
                appState.formulas = appState.formulas.filter(f => f.id != id);
                saveState();
                renderFormulationsView();
            }, "Confirm Delete");
        }

        let currentProductionPlan = {}; // To store the calculated needs for execution

        function calculateNeeds() {
            if (!checkPermission()) return;
            const formulaId = document.getElementById('production-product').value;
            const produceQty = parseFloat(document.getElementById('production-qty').value);
            if (!formulaId || !produceQty || produceQty <= 0) { showAlert('Please select a product and enter a valid quantity.'); return; }
            const formula = appState.formulas.find(f => f.id == formulaId);
            if (!formula) { showAlert('Selected formula could not be found.'); return; }

            // Find or create the corresponding finished good item
            let finishedGoodItem = appState.inventory.finishedGoods.find(item => item.name.toLowerCase() === formula.name.toLowerCase());
            if (!finishedGoodItem) {
                // If the item doesn't exist, create it. This addresses the user's request.
                const newId = Date.now() + Math.random();
                finishedGoodItem = {
                    id: newId,
                    name: formula.name,
                    unit: formula.outputUnit,
                    price: 0, // Price needs to be set manually later by the user if desired
                    openingStock: 0,
                    openingStockDate: getToday(),
                    minStockLevel: 0,
                    notes: []
                };
                appState.inventory.finishedGoods.push(finishedGoodItem);
                saveState(); // Save the new item to the state
                showAlert(`New finished good "${finishedGoodItem.name}" has been created in the inventory.`, "Item Created");
            }

            const factor = produceQty / formula.outputQty;
            const needsContent = document.getElementById('production-needs-content');

            let totalRawMaterialCost = 0;
            let rawMaterialContent = '<div><h4 class="text-lg font-semibold mb-2">Raw Materials</h4><table class="min-w-full text-sm"><thead><tr class="text-left"><th class="p-1 border-b">Material</th><th class="p-1 border-b">Required</th><th class="p-1 border-b">Available</th><th class="p-1 border-b">Difference</th><th class="p-1 border-b">Unit</th><th class="p-1 border-b">Cost</th></tr></thead><tbody>';

            currentProductionPlan.rawMaterials = [];
            formula.ingredients.forEach(ing => {
                const item = findItem(ing.category, ing.itemId);
                if (!item) {
                    rawMaterialContent += `<tr><td colspan="6" class="p-1 border-b text-red-600">Error: Ingredient ID ${ing.itemId} not found in ${ing.category}.</td></tr>`;
                    return;
                }
                const neededQty = ing.quantity * factor;
                const stock = calculateStock(item, ing.category, selectedDate);
                const available = stock.closingStock;
                const difference = available - neededQty;
                const cost = neededQty * (item.currentAverageCost || item.price);
                totalRawMaterialCost += cost;
                rawMaterialContent += `<tr><td class="p-1 border-b">${item.name}</td><td class="p-1 border-b">${neededQty.toFixed(3)}</td><td class="p-1 border-b">${available.toFixed(3)}</td><td class="p-1 border-b ${difference < 0 ? 'text-red-600' : 'text-green-600'}">${difference.toFixed(3)}</td><td class="p-1 border-b">${item.unit}</td><td class="p-1 border-b">${cost.toFixed(2)}</td></tr>`;
                currentProductionPlan.rawMaterials.push({ item, neededQty, available, difference, cost });
            });
            rawMaterialContent += `</tbody></table><div class="text-right font-bold mt-2">Total Raw Material Cost: ${totalRawMaterialCost.toFixed(2)}</div></div>`;

            let totalPackingAndLabelCost = 0;
            let packingContent = '';
            currentProductionPlan.packingMaterials = [];
            currentProductionPlan.labels = [];

            const packingMaterialId = document.getElementById('production-packing-material').value;
            const labelId = document.getElementById('production-label').value;
            if (packingMaterialId !== 'na' || labelId !== 'na') {
                packingContent = '<div class="mt-6"><h4 class="text-lg font-semibold mb-2">Packing & Labels</h4><table class="min-w-full text-sm"><thead><tr class="text-left"><th class="p-1 border-b">Item</th><th class="p-1 border-b">Required</th><th class="p-1 border-b">Available</th><th class="p-1 border-b">Difference</th><th class="p-1 border-b">Cost</th></tr></thead><tbody>';
                if (packingMaterialId !== 'na') {
                    const item = findItem('packingMaterials', packingMaterialId);
                    const neededQty = Math.ceil(produceQty);
                    const stock = calculateStock(item, 'packingMaterials', selectedDate);
                    const cost = neededQty * (item.currentAverageCost || item.price);
                    totalPackingAndLabelCost += cost;
                    packingContent += `<tr><td class="p-1 border-b">${item.name}</td><td class="p-1 border-b">${neededQty}</td><td class="p-1 border-b">${stock.closingStock}</td><td class="p-1 border-b ${stock.closingStock - neededQty < 0 ? 'text-red-600' : 'text-green-600'}">${(stock.closingStock - neededQty).toFixed(3)}</td><td class="p-1 border-b">${item.unit}</td><td class="p-1 border-b">${cost.toFixed(2)}</td></tr>`;
                    currentProductionPlan.packingMaterials.push({ item, neededQty, available: stock.closingStock, difference: stock.closingStock - neededQty, cost });
                }
                if (labelId !== 'na') {
                    const item = findItem('labels', labelId);
                    const neededQty = Math.ceil(produceQty);
                    const stock = calculateStock(item, 'labels', selectedDate);
                    const cost = neededQty * (item.currentAverageCost || item.price);
                    totalPackingAndLabelCost += cost;
                    packingContent += `<tr><td class="p-1 border-b">${item.name}</td><td class="p-1 border-b">${neededQty}</td><td class="p-1 border-b">${stock.closingStock}</td><td class="p-1 border-b ${stock.closingStock - neededQty < 0 ? 'text-red-600' : 'text-green-600'}">${(stock.closingStock - neededQty).toFixed(3)}</td><td class="p-1 border-b">${item.unit}</td><td class="p-1 border-b">${cost.toFixed(2)}</td></tr>`;
                    currentProductionPlan.labels.push({ item, neededQty, available: stock.closingStock, difference: stock.closingStock - neededQty, cost });
                }
                packingContent += `</tbody></table><div class="text-right font-bold mt-2">Total Packing & Label Cost: ${totalPackingAndLabelCost.toFixed(2)}</div></div>`;
            }

            needsContent.innerHTML = rawMaterialContent + packingContent;

            currentProductionPlan.formula = formula;
            currentProductionPlan.produceQty = produceQty;
            currentProductionPlan.finishedGoodItem = finishedGoodItem;
            currentProductionPlan.totalRawMaterialCost = totalRawMaterialCost;
            currentProductionPlan.totalPackingAndLabelCost = totalPackingAndLabelCost;

            document.getElementById('export-pdf-btn').onclick = () => exportProductionPlanPDF(currentProductionPlan);

            // Add Detailed Export Button
            if (!document.getElementById('export-detailed-btn')) {
                const btn = document.createElement('button');
                btn.id = 'export-detailed-btn';
                btn.className = 'ml-2 px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700';
                btn.textContent = 'Detailed Export (PDF & Excel)';
                btn.onclick = () => {
                    exportProductionPlanDetailedPDF(currentProductionPlan);
                    exportProductionPlanExcel(currentProductionPlan);
                };
                document.getElementById('export-pdf-btn').parentNode.appendChild(btn);
            }
            document.getElementById('execute-production-btn').onclick = () => executeProduction(currentProductionPlan);
            openModal('productionNeedsModal');
        }



        function viewCustomerHistory(id) {
            const customer = appState.customers.find(c => c.id === id);
            if (!customer) return;

            // Filter transactions (Dispatches linked to customer)
            const txs = appState.transactions.filter(t => t.customerId == id && t.type === 'dispatch').sort((a, b) => new Date(b.date) - new Date(a.date));

            let content = `<h3 class="font-bold text-lg mb-4">Sales/Dispatch History: ${customer.name}</h3>`;
            content += `<div class="overflow-x-auto"><table class="min-w-full text-sm text-left">
                <thead class="bg-gray-100"><tr><th class="p-2">Date</th><th class="p-2">Item</th><th class="p-2">Qty</th><th class="p-2">Docket No</th><th class="p-2">Destination</th></tr></thead><tbody>`;

            if (txs.length === 0) content += `<tr><td colspan="5" class="p-4 text-center text-gray-500">No transactions found.</td></tr>`;

            txs.forEach(tx => {
                const item = findItem(tx.category, tx.itemId);
                // Get customer location
                const cust = appState.customers.find(c => c.id == tx.customerId);
                const destination = cust ? (cust.location || '-') : '-';

                content += `<tr>
                    <td class="p-2 border-b">${new Date(tx.date).toLocaleDateString()}</td>
                    <td class="p-2 border-b">${item ? item.name : 'Unknown Item'}</td>
                    <td class="p-2 border-b">${tx.quantity}</td>
                     <td class="p-2 border-b">${tx.invoiceNo || '-'}</td>
                    <td class="p-2 border-b">${destination}</td>
                </tr>`;
            });
            content += `</tbody></table></div>`;

            const modal = document.createElement('div');
            modal.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center" id="historyModal">
                    <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-4xl max-h-[80vh] overflow-y-auto relative">
                        <button onclick="this.closest('#historyModal').remove()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 font-bold text-xl">&times;</button>
                        ${content}
                    </div>
                </div>`;
            document.body.appendChild(modal);
        }

        function executeProduction(plan) {
            if (!checkPermission()) return;
            if (!plan || !plan.formula || !plan.produceQty || !plan.finishedGoodItem) {
                showAlert("Invalid production plan. Please recalculate needs.");
                return;
            }

            // Check if there are any shortfalls
            const hasShortfall = plan.rawMaterials.some(rm => rm.difference < 0) ||
                plan.packingMaterials.some(pm => pm.difference < 0) ||
                plan.labels.some(l => l.difference < 0);

            if (hasShortfall) {
                showConfirm("There are shortfalls in required materials. Do you want to proceed with production anyway? (This will result in negative stock for short items)", () => {
                    proceedExecuteProduction(plan);
                }, "Material Shortfall Warning");
            } else {
                showConfirm("Are you sure you want to execute this production run? This will consume materials and add finished goods.", () => {
                    proceedExecuteProduction(plan);
                }, "Confirm Production Execution");
            }
        }

        function proceedExecuteProduction(plan) {
            const productionDate = getToday(); // Use today's date for production transactions

            // 1. Consume Raw Materials
            plan.rawMaterials.forEach(rm => {
                const consumeTx = {
                    id: Date.now() + Math.random(),
                    itemId: rm.item.id,
                    category: 'rawMaterials',
                    type: 'production-consume',
                    quantity: rm.neededQty,
                    date: productionDate + 'T00:00:00.000Z'
                };
                appState.transactions.push(consumeTx);
            });

            // 2. Consume Packing Materials
            plan.packingMaterials.forEach(pm => {
                const consumeTx = {
                    id: Date.now() + Math.random(),
                    itemId: pm.item.id,
                    category: 'packingMaterials',
                    type: 'production-consume',
                    quantity: pm.neededQty,
                    date: productionDate + 'T00:00:00.000Z'
                };
                appState.transactions.push(consumeTx);
            });

            // 3. Consume Labels
            plan.labels.forEach(l => {
                const consumeTx = {
                    id: Date.now() + Math.random(),
                    itemId: l.item.id,
                    category: 'labels',
                    type: 'production-consume',
                    quantity: l.neededQty,
                    date: productionDate + 'T00:00:00.000Z'
                };
                appState.transactions.push(consumeTx);
            });

            // 4. Add Finished Goods
            const addFinishedGoodTx = {
                id: Date.now() + Math.random(),
                itemId: plan.finishedGoodItem.id,
                category: 'finishedGoods',
                type: 'production-add', // New transaction type
                quantity: plan.produceQty,
                date: productionDate + 'T00:00:00.000Z'
            };
            appState.transactions.push(addFinishedGoodTx);

            saveState();
            logActivity('Production Execution', `Executed production of ${plan.produceQty} ${plan.formula.outputUnit} of ${plan.formula.name}`);
            closeModal('productionNeedsModal');
            showAlert(`Production of ${plan.produceQty.toFixed(3)} ${plan.formula.outputUnit} of ${plan.formula.name} completed successfully!`, "Production Executed");
            showView('formulations'); // Refresh the formulations view or dashboard
        }


        function exportProductionPlanDetailedPDF(plan) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            if (!plan || !plan.formula || !plan.produceQty) return;

            doc.setFontSize(22); doc.setTextColor(44, 62, 80); doc.text("Miklens Bio - Detailed Production Cost Sheet", 14, 20);
            doc.setFontSize(10); doc.setTextColor(100); doc.text(`Generated on: ${new Date().toLocaleString()}`, 14, 28);

            doc.setDrawColor(200); doc.line(14, 32, 196, 32);

            doc.setFontSize(12); doc.setTextColor(0);
            doc.text(`Product Name: ${plan.formula.name}`, 14, 40);
            doc.text(`Target Quantity: ${plan.produceQty.toFixed(3)} ${plan.formula.outputUnit}`, 14, 48);

            // Raw Materials
            const rmBody = plan.rawMaterials.map(rm => [
                rm.item.name,
                rm.neededQty.toFixed(3) + ' ' + rm.item.unit,
                (rm.item.currentAverageCost || rm.item.price).toFixed(2),
                rm.cost.toFixed(2)
            ]);

            doc.autoTable({
                startY: 55,
                head: [['Raw Material', 'Quantity Required', 'Unit Cost (Avg)', 'Total Cost']],
                body: rmBody,
                theme: 'grid',
                headStyles: { fillColor: [41, 128, 185], textColor: 255 },
                foot: [['', '', 'Total RM Cost:', plan.totalRawMaterialCost.toFixed(2)]],
                footStyles: { fillColor: [240, 240, 240], textColor: 0, fontStyle: 'bold' }
            });

            // Packing
            const pmBody = [
                ...plan.packingMaterials.map(pm => [pm.item.name, pm.neededQty, (pm.item.currentAverageCost || pm.item.price).toFixed(2), pm.cost.toFixed(2)]),
                ...plan.labels.map(l => [l.item.name, l.neededQty, (l.item.currentAverageCost || l.item.price).toFixed(2), l.cost.toFixed(2)])
            ];

            if (pmBody.length > 0) {
                doc.autoTable({
                    startY: doc.lastAutoTable.finalY + 10,
                    head: [['Packing / Label', 'Quantity', 'Unit Cost', 'Total Cost']],
                    body: pmBody,
                    theme: 'grid',
                    headStyles: { fillColor: [39, 174, 96], textColor: 255 },
                    foot: [['', '', 'Total Packing Cost:', plan.totalPackingAndLabelCost.toFixed(2)]],
                    footStyles: { fillColor: [240, 240, 240], textColor: 0, fontStyle: 'bold' }
                });
            }

            // Summary
            const finalY = doc.lastAutoTable.finalY + 15;
            const totalCost = plan.totalRawMaterialCost + plan.totalPackingAndLabelCost;
            const costPerUnit = totalCost / plan.produceQty;

            doc.setFillColor(245, 247, 250); doc.rect(14, finalY, 180, 40, 'F');
            doc.setFontSize(14); doc.text("Cost Summary", 20, finalY + 10);
            doc.setFontSize(12);
            doc.text(`Total Production Cost:    INR ${totalCost.toFixed(2)}`, 20, finalY + 20);
            doc.text(`Cost Per Unit (${plan.formula.outputUnit}):      INR ${costPerUnit.toFixed(2)}`, 20, finalY + 30);

            doc.save(`Detailed_Cost_Sheet_${plan.formula.name}_${getToday()}.pdf`);
        }

        function exportProductionPlanExcel(plan) {
            const wb = XLSX.utils.book_new();
            const ws_data = [
                ["Miklens Bio - Detailed Production Cost Sheet"],
                ["Generated On", new Date().toLocaleString()],
                [],
                ["Product Name", plan.formula.name],
                ["Target Quantity", plan.produceQty, plan.formula.outputUnit],
                [],
                ["Raw Materials"],
                ["Item Name", "Required Qty", "Unit", "Unit Cost", "Total Cost"]
            ];

            plan.rawMaterials.forEach(rm => {
                ws_data.push([rm.item.name, rm.neededQty, rm.item.unit, (rm.item.currentAverageCost || rm.item.price), rm.cost]);
            });
            ws_data.push(["", "", "", "Total RM Cost", plan.totalRawMaterialCost]);
            ws_data.push([]);

            if (plan.packingMaterials.length > 0 || plan.labels.length > 0) {
                ws_data.push(["Packing & Labels"]);
                ws_data.push(["Item Name", "Required Qty", "Unit", "Unit Cost", "Total Cost"]);
                plan.packingMaterials.forEach(pm => ws_data.push([pm.item.name, pm.neededQty, pm.item.unit, (pm.item.currentAverageCost || pm.item.price), pm.cost]));
                plan.labels.forEach(l => ws_data.push([l.item.name, l.neededQty, l.item.unit, (l.item.currentAverageCost || l.item.price), l.cost]));
                ws_data.push(["", "", "", "Total Packing Cost", plan.totalPackingAndLabelCost]);
                ws_data.push([]);
            }

            const totalCost = plan.totalRawMaterialCost + plan.totalPackingAndLabelCost;
            ws_data.push(["SUMMARY"]);
            ws_data.push(["Total Production Cost", totalCost]);
            ws_data.push(["Cost Per Unit", totalCost / plan.produceQty]);

            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            XLSX.utils.book_append_sheet(wb, ws, "Cost Sheet");
            XLSX.writeFile(wb, `Cost_Sheet_${plan.formula.name}.xlsx`);
        }

        function exportProductionPlanPDF(plan) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            if (!plan || !plan.formula || !plan.produceQty) return;

            doc.setFontSize(18); doc.text("Production Plan Report", 14, 22);
            doc.setFontSize(11); doc.text(`Product: ${plan.formula.name}`, 14, 32); doc.text(`Quantity to Produce: ${plan.produceQty.toFixed(3)} ${plan.formula.outputUnit}`, 14, 38); doc.text(`Report Date: ${selectedDate}`, 14, 44);

            const rawMaterialTableBody = plan.rawMaterials.map(rm => [
                rm.item.name,
                rm.neededQty.toFixed(3),
                rm.available.toFixed(3),
                rm.difference.toFixed(3),
                rm.item.unit,
                rm.cost.toFixed(2)
            ]);
            doc.autoTable({ startY: 55, head: [['Raw Material', 'Required', 'Available', 'Difference', 'Unit', 'Cost']], body: rawMaterialTableBody, theme: 'striped', headStyles: { fillColor: [44, 62, 80] } });
            let finalY = doc.lastAutoTable.finalY;
            doc.text(`Total Raw Material Cost: ${plan.totalRawMaterialCost.toFixed(2)}`, 14, finalY + 10);

            const packingTableBody = [];
            plan.packingMaterials.forEach(pm => packingTableBody.push([
                pm.item.name,
                pm.neededQty.toFixed(3),
                pm.available.toFixed(3),
                pm.difference.toFixed(3),
                pm.cost.toFixed(2)
            ]));
            plan.labels.forEach(l => packingTableBody.push([
                l.item.name,
                l.neededQty.toFixed(3),
                l.available.toFixed(3),
                l.difference.toFixed(3),
                l.cost.toFixed(2)
            ]));

            if (packingTableBody.length > 0) {
                doc.autoTable({ startY: finalY + 20, head: [['Packing/Label', 'Required', 'Available', 'Difference', 'Cost']], body: packingTableBody, theme: 'striped', headStyles: { fillColor: [44, 62, 80] } });
                finalY = doc.lastAutoTable.finalY;
                doc.text(`Total Packing & Label Cost: ${plan.totalPackingAndLabelCost.toFixed(2)}`, 14, finalY + 10);
            }
            doc.save(`production_plan_${plan.formula.name.replace(/ /g, '_')}_${getToday()}.pdf`);
        }

        // --- DATA EXPORT/IMPORT ---
        function downloadFile(filename, content, mimeType) { const blob = new Blob([content], { type: mimeType }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename; document.body.appendChild(a); a.click(); document.body.removeChild(a); }
        function exportDailyReportCSV(filterCategory) {
            let csvContent = "Category,Item Name,Unit,Opening Stock,Received,Consumed,Closing Stock,Closing Value (INR)\n";
            const reportDate = document.getElementById('daily-report-date-filter')?.value || selectedDate;
            const categoriesToReport = filterCategory === 'all' ? Object.keys(appState.inventory) : [filterCategory];
            categoriesToReport.forEach(category => {
                (appState.inventory[category] || []).forEach(item => {
                    const { openingStock, received, consumed, closingStock } = calculateStock(item, category, reportDate);
                    const value = closingStock * (item.currentAverageCost || item.price);
                    csvContent += [`"${category}"`, `"${item.name.replace(/"/g, '""')}"`, `"${item.unit}"`, openingStock.toFixed(3), received.toFixed(3), consumed.toFixed(3), closingStock.toFixed(3), value.toFixed(2)].join(',') + "\n";
                });
            });
            downloadFile(`daily_summary_${filterCategory}_${reportDate}.csv`, csvContent, 'text/csv;charset=utf-8;');
        }

        function exportMonthlyReportCSV(filterCategory) {
            const monthValue = document.getElementById('month-selector')?.value;
            const startDateStr = document.getElementById('monthly-start-date').value;
            const endDateStr = document.getElementById('monthly-end-date').value;
            let reportStartDate, reportEndDate, filenameSuffix;

            if (startDateStr && endDateStr) {
                reportStartDate = getStartOfDay(startDateStr);
                reportEndDate = getStartOfDay(endDateStr);
                filenameSuffix = `${startDateStr}_to_${endDateStr}`;
            } else if (monthValue) {
                const [year, month] = monthValue.split('-').map(Number);
                reportStartDate = getStartOfDay(new Date(year, month - 1, 1).toISOString().split('T')[0]);
                reportEndDate = getStartOfDay(new Date(year, month, 0).toISOString().split('T')[0]);
                filenameSuffix = `${year}-${String(month).padStart(2, '0')}`;
            } else { showAlert("Please select a month or a date range."); return; }

            const reportStartDateString = reportStartDate.toISOString().split('T')[0];
            const reportEndDateString = reportEndDate.toISOString().split('T')[0];

            let csvContent = "Category,Item Name,Unit,Unit Price,Opening Stock,Total Received,Total Consumed,Closing Stock,Closing Value Rs\n";
            const categoriesToReport = filterCategory === 'all' ? Object.keys(appState.inventory) : [filterCategory];

            categoriesToReport.forEach(category => {
                (appState.inventory[category] || []).forEach(item => {
                    if (!item.openingStockDate || getStartOfDay(item.openingStockDate) > reportEndDate) {
                        return;
                    }

                    const itemLedger = generateItemLedger(item, category, reportEndDateString);
                    if (itemLedger.size === 0) return;

                    const firstDayOfMonthData = itemLedger.get(reportStartDateString);
                    const openingStock = firstDayOfMonthData ? firstDayOfMonthData.opening : 0;

                    let totalReceived = 0;
                    let totalConsumed = 0;

                    for (let d = new Date(reportStartDate); d <= reportEndDate; d.setUTCDate(d.getUTCDate() + 1)) {
                        const dayData = itemLedger.get(d.toISOString().split('T')[0]);
                        if (dayData) {
                            totalReceived += dayData.received;
                            totalConsumed += dayData.consumed;
                        }
                    }

                    const closingStock = openingStock + totalReceived - totalConsumed;
                    const value = closingStock * (item.currentAverageCost || item.price);

                    csvContent += [
                        `"${category}"`,
                        `"${item.name.replace(/"/g, '""')}"`,
                        `"${item.unit}"`,
                        (item.currentAverageCost || item.price).toFixed(2),
                        openingStock.toFixed(3),
                        totalReceived.toFixed(3),
                        totalConsumed.toFixed(3),
                        closingStock.toFixed(3),
                        value.toFixed(2)
                    ].join(',') + "\n";
                });
            });
            downloadFile(`monthly_summary_${filterCategory}_${filenameSuffix}.csv`, csvContent, 'text/csv;charset=utf-8;');
        }

        function exportItemLedgerCSV() {
            const selectedItemForLedger = document.getElementById('item-ledger-select').value;
            const ledgerStartDate = document.getElementById('ledger-start-date').value;
            const ledgerEndDate = document.getElementById('ledger-end-date').value;

            if (!selectedItemForLedger) {
                showAlert("Please select an item to export its ledger.");
                return;
            }

            const [category, itemId] = selectedItemForLedger.split('-');
            const item = findItem(category, parseFloat(itemId));

            if (!item) {
                showAlert("Selected item not found.");
                return;
            }

            const ledger = generateItemLedger(item, category, ledgerEndDate);
            let csvContent = "Date,Opening Stock,Received,Consumed,Closing Stock,Closing Value (₹),Transaction Details\n";
            let currentOpeningStock = 0;

            const firstReportDate = getStartOfDay(ledgerStartDate);
            if (firstReportDate) {
                const previousDay = new Date(firstReportDate);
                previousDay.setUTCDate(previousDay.getUTCDate() - 1);
                const previousDayData = ledger.get(previousDay.toISOString().split('T')[0]);
                currentOpeningStock = previousDayData ? previousDayData.closing : item.openingStock;
            } else {
                currentOpeningStock = item.openingStock;
            }

            for (let d = new Date(getStartOfDay(ledgerStartDate || item.openingStockDate)); d <= getStartOfDay(ledgerEndDate); d.setUTCDate(d.getUTCDate() + 1)) {
                const dateStr = d.toISOString().split('T')[0];
                const dayData = ledger.get(dateStr);
                let open = 0, rec = 0, cons = 0, close = 0, txDetails = "";

                if (dayData) {
                    if (dateStr === item.openingStockDate || dateStr === ledgerStartDate) {
                        dayData.opening = currentOpeningStock;
                    } else {
                        const prevDay = new Date(d);
                        prevDay.setUTCDate(prevDay.getUTCDate() - 1);
                        const prevDayData = ledger.get(prevDay.toISOString().split('T')[0]);
                        dayData.opening = prevDayData ? prevDayData.closing : dayData.opening;
                    }
                    open = dayData.opening;
                    rec = dayData.received;
                    cons = dayData.consumed;
                    close = dayData.closing;
                    currentOpeningStock = dayData.closing;

                    txDetails = dayData.transactions.map(t => `${t.type.toUpperCase()} ${t.quantity}`).join('; ');
                } else {
                    open = currentOpeningStock;
                    close = currentOpeningStock;
                }

                const value = close * (item.currentAverageCost || item.price);

                csvContent += [`"${dateStr}"`, open.toFixed(3), rec.toFixed(3), cons.toFixed(3), close.toFixed(3), value.toFixed(2), `"${txDetails}"`].join(',') + "\n";
            }
            downloadFile(`item_ledger_${item.name.replace(/ /g, '_')}_${ledgerStartDate}_to_${ledgerEndDate}.csv`, csvContent, 'text/csv;charset=utf-8;');
        }

        function exportMonthlyDayWiseXLSX(filterCategory) {
            const monthValue = document.getElementById('month-selector')?.value;
            const startDateFilter = document.getElementById('monthly-start-date').value;
            const endDateFilter = document.getElementById('monthly-end-date').value;
            let reportStartDate, reportEndDate, filenameSuffix;

            if (startDateFilter && endDateFilter) {
                reportStartDate = getStartOfDay(startDateFilter);
                reportEndDate = getStartOfDay(endDateFilter);
                filenameSuffix = `${startDateFilter}_to_${endDateFilter}`;
            } else if (monthValue) {
                const [year, month] = monthValue.split('-').map(Number);
                reportStartDate = getStartOfDay(new Date(year, month - 1, 1).toISOString().split('T')[0]);
                reportEndDate = getStartOfDay(new Date(year, month, 0).toISOString().split('T')[0]);
                filenameSuffix = `${year}-${String(month).padStart(2, '0')}`;
            } else { showAlert("Please select a month or a date range."); return; }

            const reportEndDateString = reportEndDate.toISOString().split('T')[0];
            const workbook = XLSX.utils.book_new();
            const categoriesToReport = filterCategory === 'all' ? Object.keys(appState.inventory) : [filterCategory];

            const allLedgers = {};
            categoriesToReport.forEach(category => {
                (appState.inventory[category] || []).forEach(item => {
                    if (!item.openingStockDate || getStartOfDay(item.openingStockDate) > reportEndDate) {
                        return;
                    }
                    const ledgerKey = `${category}-${item.id}`;
                    allLedgers[ledgerKey] = {
                        item: item,
                        category: category,
                        ledger: generateItemLedger(item, category, reportEndDateString)
                    };
                });
            });

            for (let d = new Date(reportStartDate); d <= reportEndDate; d.setUTCDate(d.getUTCDate() + 1)) {
                const currentDateStr = d.toISOString().split('T')[0];
                const dailyData = [["Category", "Item Name", "Unit", "Opening Stock", "Received", "Consumed", "Closing Stock"]];

                for (const key in allLedgers) {
                    const { item, category, ledger } = allLedgers[key];

                    if (getStartOfDay(item.openingStockDate) > d) {
                        continue;
                    }

                    const dayData = ledger.get(currentDateStr);
                    if (dayData) {
                        dailyData.push([
                            category,
                            item.name,
                            item.unit,
                            dayData.opening.toFixed(3),
                            dayData.received.toFixed(3),
                            dayData.consumed.toFixed(3),
                            dayData.closing.toFixed(3)
                        ]);
                    }
                }

                if (dailyData.length > 1) {
                    const worksheet = XLSX.utils.aoa_to_sheet(dailyData);
                    const sheetName = currentDateStr.replace(/\//g, '-');
                    XLSX.utils.book_append_sheet(workbook, worksheet, sheetName);
                }
            }

            if (workbook.SheetNames.length === 0) {
                showAlert("No data found for the selected period to generate a day-wise report.");
                return;
            }
            XLSX.writeFile(workbook, `daywise_summary_${filterCategory}_${filenameSuffix}.xlsx`);
        }

        function exportFullBackupJSON() { downloadFile(`inventory_backup_${getToday()}.json`, JSON.stringify(appState, null, 2), 'application/json'); }

        function importFullBackupJSON(event) {
            if (!checkPermission()) return;
            const file = event.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const importedState = JSON.parse(e.target.result);
                    showConfirm("This will overwrite all current data. Are you sure?", () => {
                        appState = importedState;
                        // Ensure new fields like minStockLevel and notes exist for imported items
                        Object.keys(appState.inventory).forEach(cat => {
                            appState.inventory[cat].forEach(item => {
                                if (item.minStockLevel === undefined) item.minStockLevel = 0;
                                if (item.notes === undefined) item.notes = [];
                            });
                        });
                        saveState();
                        showAlert("Data imported successfully.");
                        showView('dashboard');
                    }, "Confirm Overwrite");
                } catch (error) {
                    showAlert("Error importing file. It may be corrupted.");
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function exportFullBackupHTML() {
            const pageHTML = document.documentElement.outerHTML;
            const parser = new DOMParser();
            const doc = parser.parseFromString(pageHTML, 'text/html');
            const dataScriptTag = doc.getElementById('app-data');
            if (dataScriptTag) {
                dataScriptTag.textContent = "\n" + JSON.stringify(appState, null, 2) + "\n    ";
            } else { showAlert("Error: Could not find data script tag."); return; }
            downloadFile(`inventory_manager_${getToday()}.html`, `<!DOCTYPE html>${doc.documentElement.outerHTML}`, 'text/html');
        }

        function resetApplicationData() {
            if (!checkPermission()) return;
            showConfirm("DANGER: Are you absolutely sure you want to delete all saved data? This action cannot be undone.", () => {
                showConfirm("Final confirmation: This will erase everything. Proceed?", () => {
                    localStorage.removeItem('inventoryAppState');
                    showAlert("All data has been cleared. The application will now reload to its default state.", "Data Cleared");
                    location.reload();
                }, "Final Confirmation");
            }, "Confirm Reset");
        }

        async function handleBatchEntry(type, category) {
            if (!checkPermission()) return;
            const textarea = document.getElementById('batch-entry-textarea');
            const lines = textarea.value.trim().split('\n').filter(line => line.trim() !== '');

            const entryDateInput = document.getElementById('batch-entry-date');
            const entryDate = entryDateInput.value;

            if (lines.length === 0) {
                showAlert("Please enter data in the batch entry text area.");
                return;
            }
            if (!entryDate) {
                showAlert("Please select a valid date for the batch entries.");
                return;
            }

            const parsedEntries = [];
            const errors = [];

            const batchEntryRegex = /^(.*?)\s+(\d+(?:\.\d+)?)$/;

            for (const line of lines) {
                const match = line.match(batchEntryRegex);

                if (!match) {
                    errors.push(`Invalid format: "${line}". Expected "Item Name Quantity".`);
                    continue;
                }

                const inputName = match[1].trim();
                const quantityStr = match[2];
                const quantity = parseFloat(quantityStr);

                if (isNaN(quantity) || quantity <= 0) {
                    errors.push(`Invalid quantity "${quantityStr}" for item "${inputName}".`);
                    continue;
                }

                const itemMatch = getFuzzyMatch(inputName, category);

                if (itemMatch) {
                    parsedEntries.push({
                        originalLine: line,
                        inputName: inputName,
                        matchedItem: itemMatch.item,
                        quantity: quantity,
                        date: entryDate,
                        type: type,
                        category: category,
                        isFuzzyMatch: itemMatch.score > 0
                    });
                } else {
                    errors.push(`No match found for "${inputName}" in category "${category}".`);
                }
            }

            if (parsedEntries.length === 0 && errors.length > 0) {
                showAlert(`Errors found in batch entry:\n${errors.join('\n')}`, "Batch Entry Errors");
                return;
            }

            let confirmListHtml = '';
            if (parsedEntries.length > 0) {
                confirmListHtml += `<p class="font-semibold mb-2">Entries will be recorded for date: ${entryDate}</p>`;
                confirmListHtml += '<ul class="list-disc pl-5">';
                parsedEntries.forEach(entry => {
                    const status = entry.isFuzzyMatch ? `<span class="text-orange-600">(Fuzzy match: "${entry.matchedItem.name}")</span>` : '';
                    confirmListHtml += `<li>${entry.matchedItem.name}: ${entry.quantity.toFixed(3)} ${entry.matchedItem.unit} ${status}</li>`;
                });
                confirmListHtml += '</ul>';
            }

            document.getElementById('batch-confirm-list').innerHTML = confirmListHtml;
            document.getElementById('batch-confirm-errors').textContent = errors.join('\n');

            openModal('batchConfirmModal');

            const confirmed = await new Promise(resolve => {
                const proceedBtn = document.getElementById('batch-confirm-proceed');
                const cancelBtn = document.getElementById('batchConfirmModal').querySelector('button[onclick*="closeModal"]');
                const handleProceed = () => {
                    proceedBtn.removeEventListener('click', handleProceed);
                    cancelBtn.removeEventListener('click', handleCancel);
                    resolve(true);
                };
                const handleCancel = () => {
                    proceedBtn.removeEventListener('click', handleProceed);
                    cancelBtn.removeEventListener('click', handleCancel);
                    resolve(false);
                };
                proceedBtn.addEventListener('click', handleProceed);
                cancelBtn.addEventListener('click', handleCancel);
            });

            closeModal('batchConfirmModal');

            if (confirmed) {
                let processedCount = 0;
                for (const entry of parsedEntries) {
                    const newTx = {
                        id: Date.now() + Math.random(),
                        itemId: entry.matchedItem.id,
                        category: entry.category,
                        type: type,
                        quantity: entry.quantity,
                        date: entry.date + 'T00:00:00.000Z'
                    };
                    appState.transactions.push(newTx);
                    processedCount++;
                }
                saveState();
                showAlert(`Batch entry complete. Processed ${processedCount} transactions. ${errors.length > 0 ? `Errors: ${errors.length}` : ''}`, "Batch Entry Result");
                textarea.value = '';
                showView(currentView);
            } else {
                showAlert("Batch entry cancelled.");
            }
        }

        // --- Notes & Annotations Functions ---
        function openNotesModal(category, itemId) {
            if (!checkPermission()) return;
            const item = findItem(category, itemId);
            if (!item) return;

            document.getElementById('notes-modal-title').innerHTML = `Notes for <span class="font-semibold">${item.name}</span>`;
            document.getElementById('notes-item-id').value = itemId;
            document.getElementById('notes-item-category').value = category;
            document.getElementById('new-note-input').value = '';
            renderNotesList(item);
            openModal('itemNotesModal');
        }

        function renderNotesList(item) {
            const notesListDiv = document.getElementById('notes-list');
            if (!item.notes || item.notes.length === 0) {
                notesListDiv.innerHTML = '<p class="text-gray-500">No notes for this item yet.</p>';
                return;
            }
            notesListDiv.innerHTML = item.notes.map((note, index) => `
            <div class="flex justify-between items-center p-2 border-b last:border-b-0">
                <span class="text-gray-800">${note}</span>
                <button onclick="deleteNote(${index})" class="text-red-500 hover:text-red-700 text-sm ml-4">&times;</button>
            </div>
        `).join('');
        }

        function addNote() {
            if (!checkPermission()) return;
            const itemId = parseFloat(document.getElementById('notes-item-id').value);
            const category = document.getElementById('notes-item-category').value;
            const newNoteText = document.getElementById('new-note-input').value.trim();

            if (!newNoteText) {
                showAlert("Please enter a note to add.");
                return;
            }

            const item = findItem(category, itemId);
            if (item) {
                if (!item.notes) item.notes = []; // Ensure notes array exists
                item.notes.push(newNoteText);
                saveState();
                document.getElementById('new-note-input').value = '';
                renderNotesList(item);
                renderTableBody(category); // Refresh inventory table to update note icon
            }
        }

        function deleteNote(noteIndex) {
            if (!checkPermission()) return;
            const itemId = parseFloat(document.getElementById('notes-item-id').value);
            const category = document.getElementById('notes-item-category').value;
            const item = findItem(category, itemId);

            if (item && item.notes && item.notes.length > noteIndex) {
                showConfirm("Are you sure you want to delete this note?", () => {
                    item.notes.splice(noteIndex, 1);
                    saveState();
                    renderNotesList(item);
                    renderTableBody(category); // Refresh inventory table to update note icon
                }, "Confirm Delete Note");
            }
        }


        // ============================================
        // WEIGHTED AVERAGE COSTING SYSTEM ADDITIONS
        // ============================================

        function migrateDataForWeightedCosting() {
            let migrated = false;
            Object.keys(appState.inventory).forEach(category => {
                appState.inventory[category].forEach(item => {
                    if (item.currentAverageCost === undefined) {
                        item.currentAverageCost = item.price || 0;
                        migrated = true;
                    }
                    if (!item.priceHistory) {
                        item.priceHistory = [];
                        migrated = true;
                    }
                });
            });
            if (migrated) {
                saveState();
                console.log("Data migrated for weighted average costing");
            }
        }


        function updateWeightedAverageCost(item, category, quantityReceived, purchasePrice, txDate) {
            const currentStock = getCurrentStockLevel(item, category, txDate);
            const currentValue = currentStock * (item.currentAverageCost || item.price);
            const newValue = quantityReceived * purchasePrice;
            const newTotalStock = currentStock + quantityReceived;
            const newTotalValue = currentValue + newValue;

            // Only update if we have stock to average against
            if (newTotalStock > 0) {
                item.currentAverageCost = newTotalValue / newTotalStock;
            }

            if (!item.priceHistory) item.priceHistory = [];
            item.priceHistory.push({
                date: txDate,
                quantity: quantityReceived,
                purchasePrice: purchasePrice,
                totalCost: newValue,
                newAverageCost: item.currentAverageCost
            });

            if (item.priceHistory.length > 50) {
                item.priceHistory = item.priceHistory.slice(-50);
            }
        }

        function getCurrentStockLevel(item, category, date) {
            // If no date provided, fallback to today, but simpler date handling
            const targetDate = date ? date.split('T')[0] : new Date().toISOString().split('T')[0];
            const stock = calculateStock(item, category, targetDate);
            return stock.closingStock || 0;
        }

        function showPriceHistory(itemId, category) {
            const item = findItem(category, itemId);
            if (!item || !item.priceHistory || item.priceHistory.length === 0) {
                alert('No price history available for this item');
                return;
            }

            const historyHTML = `
        <div class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
            <div class="bg-white p-6 rounded-lg shadow-xl max-w-2xl w-full max-h-96 overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold">Price History: ${item.name}</h3>
                    <button onclick="this.closest('div.fixed').remove()" class="text-gray-500 hover:text-gray-800">&times;</button>
                </div>
                <p class="mb-2"><strong>Current Average Cost:</strong> ₹${item.currentAverageCost.toFixed(2)}/${item.unit}</p>
                <p class="mb-4"><strong>Standard Price:</strong> ₹${item.price}/${item.unit}</p>
                <table class="w-full border">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="p-2 border text-left">Date</th>
                            <th class="p-2 border text-right">Qty</th>
                            <th class="p-2 border text-right">Purchase Price</th>
                            <th class="p-2 border text-right">Total Cost</th>
                            <th class="p-2 border text-right">New Avg Cost</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${item.priceHistory.slice().reverse().map(h => `
                            <tr>
                                <td class="p-2 border">${h.date}</td>
                                <td class="p-2 border text-right">${h.quantity.toFixed(3)}</td>
                                <td class="p-2 border text-right">₹${h.purchasePrice.toFixed(2)}</td>
                                <td class="p-2 border text-right">₹${h.totalCost.toFixed(2)}</td>
                                <td class="p-2 border text-right font-bold">₹${h.newAverageCost.toFixed(2)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;
            document.body.insertAdjacentHTML('beforeend', historyHTML);
        }

        // --- ERP HELPER FUNCTIONS ---

        // --- BATCH MANAGEMENT ---

        function showBatchDetails(itemId, category) {
            // Fix: Parsed ID to ensure type matches (Number vs String)
            itemId = parseFloat(itemId);
            const item = findItem(category, itemId);
            if (!item) return;

            // Calculate Stock by Batch
            const batchStock = {};

            // Initialize with Opening Stock if it exists
            const openingStockVal = parseFloat(item.openingStock);
            if (!isNaN(openingStockVal) && openingStockVal > 0) {
                batchStock['Unassigned (Opening)'] = openingStockVal;
            }

            let totalbatchStockSum = 0;

            appState.transactions.forEach(tx => {
                if (tx.itemId == itemId && tx.category === category) {
                    const batch = tx.batchNo || 'Unassigned';
                    if (!batchStock[batch]) batchStock[batch] = 0;

                    // Simple addition/subtraction based on type
                    if (['receive', 'produce', 'stock-take-adj-in', 'production-add'].includes(tx.type)) {
                        batchStock[batch] += tx.quantity;
                    } else if (['consume', 'dispatch', 'stock-take-adj-out', 'production-consume'].includes(tx.type)) {
                        batchStock[batch] -= tx.quantity;
                    }
                }
            });

            // Filter out near-zero batches
            let activeBatches = Object.entries(batchStock)
                .filter(([batch, qty]) => Math.abs(qty) > 0.001)
                .map(([batch, qty]) => {
                    totalbatchStockSum += qty;
                    return [batch, qty];
                })
                .sort((a, b) => b[1] - a[1]);

            // Robust Fallback: Compare with System Stock
            const currentStockVal = getCurrentStockLevel(item, category);

            // If there's a significant difference between batch sum and distinct stock calculation,
            // or if no batches exist but stock > 0, show the system correction.
            const difference = currentStockVal - totalbatchStockSum;

            if (currentStockVal > 0.001 && (activeBatches.length === 0 || Math.abs(difference) > 0.001)) {
                activeBatches.push(['System Stock / Unassigned', difference]);
            }

            // If somehow we still have 0 batches and 0 stock, but the user clicked view, show message.
            // But activeBatches is what we render.

            const content = `
                <div class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center" id="batchDetailsModal">
                    <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-lg">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold">Batch Details: ${item.name}</h3>
                            <button onclick="document.getElementById('batchDetailsModal').remove()" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
                        </div>
                        <div class="overflow-y-auto max-h-96">
                            <table class="min-w-full text-sm">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="p-2 text-left">Batch Number</th>
                                        <th class="p-2 text-right">Current Stock</th>
                                        <th class="p-2 text-left">Expiry</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${activeBatches.length > 0 ? activeBatches.map(([batch, qty]) => {
                // Try to find expiry for this batch from receive transactions
                const receiveTx = appState.transactions.find(t => t.batchNo === batch && t.expiryDate);
                const expiry = receiveTx ? receiveTx.expiryDate : '-';
                return `
                                        <tr class="border-b">
                                            <td class="p-2 font-mono break-all">${batch}</td>
                                            <td class="p-2 text-right font-bold">${qty.toFixed(3)} ${item.unit}</td>
                                            <td class="p-2 ${expiry !== '-' && new Date(expiry) < new Date() ? 'text-red-500 font-bold' : ''}">${expiry}</td>
                                        </tr>`;
            }).join('') : '<tr><td colspan="3" class="p-4 text-center text-gray-500">No active batches found. System Balance is 0.</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                         <div class="mt-4 text-xs text-gray-500 text-right">
                            * Calculated from transaction history. <br>
                            System Total: ${currentStockVal.toFixed(3)} ${item.unit}
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', content);
        }

        // --- AUDIT LOG SYSTEM REMOVED ---
        function exportActivityLogCSV() { showAlert("Export disabled."); }
        function clearActivityLog() { showAlert("Clear disabled."); }


        function renderCustomersView() {
            const container = document.getElementById('customers-view');
            if (!container) return;

            const customers = appState.customers || [];

            container.innerHTML = `
            <div class="h-full flex flex-col p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold">Customer Management</h2>
                    <div class="flex gap-2">
                        <button onclick="exportCustomersCSV()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Export CSV</button>
                        <button onclick="openCustomerModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Add Customer</button>
                    </div>
                </div>
                    <div class="overflow-x-auto bg-white rounded-lg shadow">
                        <table class="min-w-full text-sm text-left text-gray-500">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3">Customer Name</th>
                                    <th class="px-6 py-3">GST Number</th>
                                    <th class="px-6 py-3">Location</th>
                                    <th class="px-6 py-3">Type</th>
                                    <th class="px-6 py-3 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${customers.length > 0 ? customers.map(c => `
                                    <tr id="row-customers-${c.id}" data-item-id="${c.id}" class="bg-white border-b hover:bg-gray-50">
                                        <td class="px-6 py-4 font-medium text-gray-900">
                                             <button onclick="viewCustomerHistory(${c.id})" class="text-blue-600 hover:underline text-left">${c.name}</button>
                                        </td>
                                        <td class="px-6 py-4">${c.gst || '-'}</td>
                                        <td class="px-6 py-4">${c.location || '-'}</td>
                                        <td class="px-6 py-4 flex items-center">
                                            <span class="px-2 py-1 rounded-full text-xs font-semibold ${getCustomerTypeColor(c.type)}">
                                                ${c.type || 'Standard'}
                                            </span>
                                        </td>
                                        <td class="px-6 py-4 text-right">
                                            <button onclick="editCustomer(${c.id})" class="font-medium text-blue-600 hover:underline mr-3">Edit</button>
                                            <button onclick="deleteCustomer(${c.id})" class="font-medium text-red-600 hover:underline">Delete</button>
                                        </td>
                                    </tr>
                                `).join('') : '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-400">No customers found. Add your first customer!</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function openSupplierModal(id = null) {
            if (!checkPermission()) return;
            const form = document.getElementById('supplier-form');
            if (form) form.reset();
            const modalTitle = document.getElementById('supplier-modal-title');

            if (id) {
                const supplier = appState.suppliers.find(s => s.id === id);
                if (supplier) {
                    modalTitle.textContent = 'Edit Supplier';
                    document.getElementById('supplier-id').value = supplier.id;
                    document.getElementById('supplier-name').value = supplier.name;
                    document.getElementById('supplier-contact').value = supplier.contact || '';
                    document.getElementById('supplier-phone').value = supplier.phone || '';
                    document.getElementById('supplier-email').value = supplier.email || '';
                    document.getElementById('supplier-approved').checked = supplier.approved !== false;
                }
            } else {
                modalTitle.textContent = 'Add Supplier';
                document.getElementById('supplier-id').value = '';
            }
            openModal('supplierModal');
        }

        function deleteSupplier(id) {
            if (!checkPermission()) return;
            showConfirm("Are you sure you want to delete this supplier?", () => {
                appState.suppliers = appState.suppliers.filter(s => s.id !== id);
                saveState();
                renderSuppliersView();
                showAlert("Supplier deleted.");
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            const supplierForm = document.getElementById('supplier-form');
            if (supplierForm) {
                supplierForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    if (!checkPermission()) return;
                    const id = document.getElementById('supplier-id').value;
                    const name = document.getElementById('supplier-name').value;
                    const contact = document.getElementById('supplier-contact').value;
                    const phone = document.getElementById('supplier-phone').value;
                    const email = document.getElementById('supplier-email').value;
                    const approved = document.getElementById('supplier-approved').checked;

                    if (!appState.suppliers) appState.suppliers = [];

                    if (id) {
                        const idx = appState.suppliers.findIndex(s => s.id == id);
                        if (idx > -1) {
                            appState.suppliers[idx] = { ...appState.suppliers[idx], name, contact, phone, email, approved };
                            showAlert("Supplier updated.");
                        }
                    } else {
                        appState.suppliers.push({
                            id: Date.now(),
                            name,
                            contact,
                            phone,
                            email,
                            approved
                        });
                        showAlert("Supplier added.");
                    }
                    saveState();
                    closeModal('supplierModal');
                    // Refresh view if currently on suppliers view
                    if (currentView === 'suppliers') renderSuppliersView();
                    // Or if triggered from transaction modal, maybe refresh dropdown? 
                    // But usually we just proceed.
                    // Refresh dropdown in StockTxModal if it's open
                    const stockTxModal = document.getElementById('stockTxModal');
                    if (stockTxModal && !stockTxModal.classList.contains('hidden') && stockTxModal.classList.contains('flex')) {
                        if (typeof populateSupplierSelect === 'function') populateSupplierSelect();
                    }
                });
            }
        });

        // --- ERP & CUSTOMER MANAGEMENT ---

        function getCustomerTypeColor(type) {
            switch (type) {
                case 'Dealer': return 'bg-purple-100 text-purple-800';
                case 'Farmer': return 'bg-green-100 text-green-800';
                case 'Institution': return 'bg-blue-100 text-blue-800';
                case 'Client': return 'bg-indigo-100 text-indigo-800';
                case 'Testing': return 'bg-yellow-100 text-yellow-800';
                case 'Sample': return 'bg-teal-100 text-teal-800';
                case 'Buyer': return 'bg-cyan-100 text-cyan-800';
                case 'Estate': return 'bg-amber-100 text-amber-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function openCustomerModal(id = null) {
            if (!checkPermission()) return;
            document.getElementById('customer-form').reset();
            const modalTitle = document.querySelector('#customerModal h3');

            if (id) {
                const customer = appState.customers.find(c => c.id === id);
                if (customer) {
                    modalTitle.textContent = 'Edit Customer';
                    document.getElementById('edit-customer-id').value = customer.id;
                    document.getElementById('customer-name').value = customer.name;
                    document.getElementById('customer-gst').value = customer.gst || '';
                    document.getElementById('customer-location').value = customer.location || '';
                    document.getElementById('customer-type').value = customer.type || 'Dealer';
                }
            } else {
                modalTitle.textContent = 'Add New Customer';
                document.getElementById('edit-customer-id').value = '';
            }
            openModal('customerModal');

            // Force z-index to ensure it's on top
            setTimeout(() => {
                const modal = document.getElementById('customerModal');
                if (modal) {
                    modal.style.zIndex = '9999';
                    console.log('CustomerModal z-index set to:', window.getComputedStyle(modal).zIndex);
                }
            }, 10);
        }

        function editCustomer(id) {
            if (!checkPermission()) return;
            openCustomerModal(id);
        }

        // Initialize Customer Form Listener
        document.addEventListener('DOMContentLoaded', () => {
            const customerForm = document.getElementById('customer-form');
            if (customerForm) {
                customerForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    if (!checkPermission()) return;
                    const id = document.getElementById('edit-customer-id').value;
                    const name = document.getElementById('customer-name').value;
                    const gst = document.getElementById('customer-gst').value;
                    const location = document.getElementById('customer-location').value;
                    const type = document.getElementById('customer-type').value;

                    if (!appState.customers) appState.customers = [];

                    if (id) {
                        const idx = appState.customers.findIndex(c => c.id == id);
                        if (idx > -1) {
                            appState.customers[idx] = { ...appState.customers[idx], name, gst, location, type };
                            showAlert("Customer updated successfully.");
                        }
                    } else {
                        appState.customers.push({
                            id: Date.now(),
                            name,
                            gst,
                            location,
                            type
                        });
                        showAlert("Customer added successfully.");
                    }
                    saveState();
                    closeModal('customerModal');

                    // Intelligent View Refresh
                    // If Dispatch Modal is open, refresh its dropdown instead of changing view
                    const dispatchModal = document.getElementById('dispatchModal');
                    if (dispatchModal && !dispatchModal.classList.contains('hidden') && dispatchModal.classList.contains('flex')) {
                        // Refresh Dropdown
                        const custSelect = document.getElementById('dispatch-customer');
                        if (custSelect) {
                            const selectedId = custSelect.value;
                            custSelect.innerHTML = '<option value="">Select Customer</option>' +
                                (appState.customers || []).map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                            // Add "Add Customer" button again if lost (though innerHTML replaces options only usually if structure is maintained, but here we replace all)
                            // Re-inject helper button
                            if (!document.getElementById('btn-add-cust-helper')) {
                                const btn = document.createElement('button');
                                btn.id = 'btn-add-cust-helper';
                                btn.type = 'button';
                                btn.textContent = '+ New';
                                btn.className = 'ml-2 px-2 py-1 bg-green-600 text-white rounded text-xs';
                                btn.onclick = () => openCustomerModal();
                                custSelect.parentNode.insertBefore(btn, custSelect.nextSibling);
                            }
                            // Select the new customer if it was an add action
                            if (!id) { // New customer was just added (last one in array)
                                const newCust = appState.customers[appState.customers.length - 1];
                                if (newCust) custSelect.value = newCust.id;
                            } else {
                                custSelect.value = selectedId; // Keep previous selection if edit
                            }
                        }
                    } else {
                        // Only render customer view if we are actually ON that view
                        if (currentView === 'customers') renderCustomersView();
                    }
                });
            }
        });

        function deleteCustomer(id) {
            if (!checkPermission()) return;
            showConfirm("Are you sure you want to delete this customer?", () => {
                appState.customers = appState.customers.filter(c => c.id !== id);
                saveState();
                renderCustomersView();
                showAlert("Customer deleted.");
            });
        }

        // --- SUPPLIER COST HISTORY & ANALYSIS ---

        function openPriceHistoryModal(itemId, category) {
            const item = findItem(category, itemId);
            if (!item) return;

            document.getElementById('price-history-title').textContent = `Price History: ${item.name}`;

            // Filter transactions for this item that have a price (Receive, etc)
            const history = appState.transactions
                .filter(t => t.itemId == itemId && t.category === category && (t.type === 'receive' || t.purchasePrice))
                .sort((a, b) => new Date(b.date) - new Date(a.date));

            const tableBody = document.getElementById('price-history-table-body');
            tableBody.innerHTML = history.length > 0 ? history.map(h => {
                const supplier = appState.suppliers?.find(s => s.id == h.supplierId)?.name || 'Unknown';
                return `
                    <tr class="hover:bg-gray-50">
                         <td class="p-2 border">${h.date.split('T')[0]}</td>
                         <td class="p-2 border">${supplier}</td>
                         <td class="p-2 border font-mono">₹${(h.purchasePrice || 0).toFixed(2)}</td>
                         <td class="p-2 border font-mono">${h.quantity}</td>
                    </tr>
                `;
            }).join('') : '<tr><td colspan="4" class="p-4 text-center text-gray-500">No purchase history found.</td></tr>';

            // Chart Logic
            const ctx = document.getElementById('priceHistoryChart').getContext('2d');
            if (window.priceHistoryChartInstance) window.priceHistoryChartInstance.destroy();

            // Prepare data for chart (Chronological)
            const chartData = [...history].reverse();

            window.priceHistoryChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.map(d => d.date.split('T')[0]),
                    datasets: [{
                        label: 'Purchase Price (₹)',
                        data: chartData.map(d => d.purchasePrice || 0),
                        borderColor: '#2563EB',
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });

            // Recommendations
            const recommendationEl = document.getElementById('price-history-recommendation');
            if (history.length > 1) {
                const latestPrice = history[0].purchasePrice || 0;
                const avgPrice = history.reduce((sum, h) => sum + (h.purchasePrice || 0), 0) / history.length;
                let text = `Average Price: ₹${avgPrice.toFixed(2)}. Latest Price: ₹${latestPrice.toFixed(2)}. `;

                // Find cheapest supplier
                const supplierPrices = {};
                history.forEach(h => {
                    const sId = h.supplierId || 'unknown';
                    if (!supplierPrices[sId]) supplierPrices[sId] = [];
                    supplierPrices[sId].push(h.purchasePrice || 0);
                });

                let bestSupplierId = null;
                let bestAvg = Infinity;

                Object.entries(supplierPrices).forEach(([sId, prices]) => {
                    const sAvg = prices.reduce((a, b) => a + b, 0) / prices.length;
                    if (sAvg < bestAvg) { bestAvg = sAvg; bestSupplierId = sId; }
                });

                if (bestSupplierId && bestSupplierId !== 'unknown') {
                    const bestSupName = appState.suppliers?.find(s => s.id == bestSupplierId)?.name || 'Unknown';
                    text += `<br><strong>Tip:</strong> ${bestSupName} has the best average price of ₹${bestAvg.toFixed(2)}.`;
                }

                recommendationEl.innerHTML = text;
            } else {
                recommendationEl.textContent = "Not enough data for recommendations.";
            }

            openModal('priceHistoryModal');
        }

        // --- USER ROLE MANAGEMENT ---

        // --- USER ROLE MANAGEMENT ---

        let currentUserRole = 'viewer';
        let currentUserName = 'Guest';

        function loginAs(role, silent = false) {
            // Get Name
            if (!silent) {
                const nameInput = document.getElementById('login-username');
                if (!nameInput || nameInput.value.trim() === "") {
                    showAlert("Please enter your name to proceed.");
                    return;
                }
                currentUserName = nameInput.value.trim();
            }

            currentUserRole = role;
            document.getElementById('current-user-role').textContent = role;
            document.getElementById('current-user-name').textContent = currentUserName;

            const body = document.body;
            body.setAttribute('data-role', role);

            if (!silent) {
                closeModal('loginModal');
                logActivity('Login', `Switched to ${role.toUpperCase()} role.`);
                showAlert(`Switched to ${role.toUpperCase()} role.`);
            }
            showView(currentView);
        }

        function checkAccess(requiredRole) {
            const roles = ['viewer', 'production', 'store', 'admin'];
            const userLevel = roles.indexOf(currentUserRole);
            const reqLevel = roles.indexOf(requiredRole);
            return userLevel >= reqLevel;
        }

        // --- STOCK ADJUSTMENT LOGIC (Restored) ---
        function openAdjustStockModal(category, id) {
            if (!checkPermission()) return;
            const item = findItem(category, id);
            if (!item) return;

            document.getElementById('adjust-stock-form').reset();
            document.getElementById('adjust-item-id').value = id;
            document.getElementById('adjust-item-category').value = category;
            document.getElementById('adjust-item-name').textContent = item.name;
            document.getElementById('adjust-date').value = getToday();

            // Calculate current system stock
            const stock = calculateStock(item, category, getToday());
            document.getElementById('adjust-system-stock').value = stock.closingStock.toFixed(3);
            document.getElementById('adjust-actual-stock').value = '';

            openModal('adjustStockModal');
        }

        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('adjust-stock-form');
            if (form) {
                // Remove old listener if any to prevent duplicates by cloning 
                const newForm = form.cloneNode(true);
                form.parentNode.replaceChild(newForm, form);

                newForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const id = parseFloat(document.getElementById('adjust-item-id').value);
                    const category = document.getElementById('adjust-item-category').value;
                    const actualStock = parseFloat(document.getElementById('adjust-actual-stock').value);
                    const systemStock = parseFloat(document.getElementById('adjust-system-stock').value);
                    const date = document.getElementById('adjust-date').value;
                    const reason = document.getElementById('adjust-reason').value;

                    if (isNaN(actualStock)) { showAlert("Please enter valid physical stock."); return; }

                    const difference = actualStock - systemStock;
                    if (difference === 0) { showAlert("No adjustment needed. Stocks match."); return; }

                    const type = difference > 0 ? 'stock-take-adj-in' : 'stock-take-adj-out';
                    const quantity = Math.abs(difference);

                    const newTx = {
                        id: Date.now(),
                        itemId: id,
                        category: category,
                        type: type,
                        quantity: quantity,
                        date: date + 'T00:00:00.000Z',
                        notes: reason || "Manual Stock Adjustment"
                    };

                    appState.transactions.push(newTx);
                    saveState();
                    logActivity('Stock Adjustment', `Adjusted ${category} item ${id} by ${type === 'stock-take-adj-in' ? '+' : '-'}${quantity.toFixed(3)}. Reason: ${reason}`);
                    closeModal('adjustStockModal');
                    showAlert(`Stock adjusted successfully. ${type === 'stock-take-adj-in' ? 'Added' : 'Removed'} ${quantity.toFixed(3)} units.`, "Adjustment Posted");
                    showView(currentView);
                });
            }
        });

        // --- SALES & DISPATCH ---


        function renderSalesDispatchView() {
            const container = document.getElementById('sales-dispatch-view');
            if (!container) return;

            // Search Filter Logic
            const searchTerm = document.getElementById('sales-search-input') ? document.getElementById('sales-search-input').value.toLowerCase() : '';

            // Get all dispatch transactions
            let sales = appState.transactions
                .filter(t => t.type === 'dispatch')
                .sort((a, b) => new Date(b.date) - new Date(a.date));

            if (searchTerm) {
                sales = sales.filter(s => {
                    const item = findItem(s.category, s.itemId);
                    const itemName = item ? item.name.toLowerCase() : '';
                    const customer = appState.customers?.find(c => c.id === s.customerId)?.name.toLowerCase() || '';
                    const batch = (s.batchNo || '').toLowerCase();
                    const invoice = (s.invoiceNo || '').toLowerCase();
                    const notes = (s.notes || '').toLowerCase();
                    const type = (s.subtype || '').toLowerCase();

                    return itemName.includes(searchTerm) ||
                        customer.includes(searchTerm) ||
                        batch.includes(searchTerm) ||
                        invoice.includes(searchTerm) ||
                        notes.includes(searchTerm) ||
                        type.includes(searchTerm);
                });
            }

            container.innerHTML = `
                <div class="h-full flex flex-col p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-gray-800">Sales & Dispatch Log</h2>
                        <div class="flex gap-2">
                             <input type="text" id="sales-search-input" value="${searchTerm}" placeholder="Search Dispatch..." class="p-2 border rounded-lg w-64 text-sm" oninput="renderSalesDispatchView()">
                             <button onclick="exportSalesCSV()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Export CSV</button>
                             <button onclick="openDispatchModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">+ New Dispatch</button>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto bg-white rounded-lg shadow">
                         <table class="min-w-full text-sm text-left text-gray-500">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3">Date</th>
                                    <th class="px-6 py-3">Customer</th>
                                    <th class="px-6 py-3">Item</th>
                                    <th class="px-6 py-3 text-right">Qty</th>
                                    <th class="px-6 py-3">Batch/Ref</th>
                                    <th class="px-6 py-3">Purpose</th>
                                    <th class="px-6 py-3">Notes</th>
                                    <th class="px-6 py-3 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sales.length > 0 ? sales.map(s => {
                const item = findItem(s.category, s.itemId);
                const customer = appState.customers?.find(c => c.id === s.customerId)?.name || 'Unknown';

                return `
                                    <tr class="bg-white border-b hover:bg-gray-50">
                                        <td class="px-6 py-4">${s.date.split('T')[0]}</td>
                                        <td class="px-6 py-4 font-medium">${customer}</td>
                                        <td class="px-6 py-4 flex items-center gap-2">
                                            ${item ? item.name : 'Unknown'}
                                            ${item && s.category === 'finishedGoods' ? `<button onclick="openProductTrace('${item.id}')" class="text-xs bg-purple-100 text-purple-700 px-1 rounded border border-purple-200 hover:bg-purple-200" title="Trace">🔍</button>` : ''}
                                        </td>
                                        <td class="px-6 py-4 text-right font-mono">${s.quantity.toFixed(3)}</td>
                                        <td class="px-6 py-4">${s.batchNo || s.invoiceNo || '-'}</td>
                                        <td class="px-6 py-4"><span class="px-2 py-1 bg-gray-100 rounded text-xs">${s.subtype || 'Sale'}</span></td>
                                        <td class="px-6 py-4 text-xs italic text-gray-500 max-w-xs truncate" title="${s.notes || ''}">${s.notes || '-'}</td>
                                        <td class="px-6 py-4 text-right">
                                             <button onclick="undoSalesDispatch(${s.id})" class="text-orange-600 hover:text-orange-800 text-xs font-bold mr-2">Undo</button>
                                             <button onclick="deleteDispatch(${s.id})" class="text-red-600 hover:text-red-800 text-xs font-bold">Delete</button>
                                        </td>
                                    </tr>`;
            }).join('') : '<tr><td colspan="8" class="px-6 py-4 text-center text-gray-400">No dispatch records found.</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            // Maintain focus
            const input = document.getElementById('sales-search-input');
            if (input) {
                input.focus();
                var val = input.value;
                input.value = '';
                input.value = val;
            }
        }

        window.undoSalesDispatch = function (txId) {
            showConfirm("Undo this dispatch? Stock will be returned to inventory.", () => {
                const idx = appState.transactions.findIndex(t => t.id === txId);
                if (idx > -1) {
                    const tx = appState.transactions[idx];
                    appState.transactions.splice(idx, 1);
                    saveState();
                    logActivity('Sales Undo', `Undid dispatch of ${tx.quantity} units for Item ${tx.itemId}`);
                    showAlert("Dispatch undone. Stock restored.");
                    renderSalesDispatchView();
                }
            });
        };

        window.deleteDispatch = function (txId) {
            showConfirm("Delete this record permanently? Stock will be returned.", () => {
                const idx = appState.transactions.findIndex(t => t.id === txId);
                if (idx > -1) {
                    const tx = appState.transactions[idx];
                    appState.transactions.splice(idx, 1);
                    saveState();
                    logActivity('Sales Delete', `Deleted dispatch record ${txId}`);
                    showAlert("Record deleted.");
                    renderSalesDispatchView();
                }
            });
        };


        // --- HELPER FUNCTIONS ---

        // CRITICAL: Modal Utility Functions
        window.openModal = function (modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            } else {
                console.error('Modal not found:', modalId);
            }
        };

        window.closeModal = function (modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        };

        function checkPermission(minRole = 'production') {
            // Roles: viewer < store < production < admin  (Simplified for this logic)
            // Actually, let's just deny viewers from ANY write action
            if (currentUserRole === 'viewer') {
                showAlert("Access Denied: You do not have permission to perform this action.");
                return false;
            }
            // Add more granular checks if needed
            return true;
        }

        // New Item History & Undo Logic
        window.openItemHistoryModal = function (category, itemId) {
            if (!checkPermission()) return;
            // Fix: Ensure itemId is a number for consistent comparison
            itemId = parseFloat(itemId);
            const container = document.getElementById('item-history-rows');
            const item = findItem(category, itemId);
            if (!item || !container) return;

            // Get last 20 transactions for this item
            const txs = appState.transactions
                .filter(t => t.category === category && t.itemId === itemId)
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 20);

            container.innerHTML = txs.length ? txs.map(t => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-3">${t.date.split('T')[0]}</td>
                    <td class="p-3 uppercase font-bold text-xs ${t.type === 'receive' ? 'text-green-600' : 'text-red-600'}">${t.type}</td>
                    <td class="p-3 text-right text-mono font-bold">${t.quantity}</td>
                    <td class="p-3 text-xs text-gray-500">${t.batchNo || t.invoiceNo || '-'}</td>
                    <td class="p-3 text-xs italic text-blue-600">${t.notes || t.subtype || '-'}</td>
                    <td class="p-3 text-xs italic">${t.userName || 'Unknown'}</td>
                    <td class="p-3 text-center">
                        <button onclick="openEditTxModal(${t.id})" class="px-2 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200 text-xs font-bold border border-blue-200 mr-1">Edit</button>
                    </td>
                    <td class="p-3 text-center">
                        <button onclick="undoTransaction(${t.id}, '${category}')" class="px-2 py-1 bg-orange-100 text-orange-700 rounded hover:bg-orange-200 text-xs font-bold border border-orange-200">Undo</button>
                    </td>
                </tr>
            `).join('') : '<tr><td colspan="8" class="p-4 text-center text-gray-400">No transactions found.</td></tr>';

            openModal('itemHistoryModal');
        };

        window.undoTransaction = function (txId, category) {
            if (!checkPermission()) return; // Protect Undo

            const idx = appState.transactions.findIndex(t => t.id === txId);
            if (idx === -1) { showAlert("Transaction not found."); return; }
            const tx = appState.transactions[idx];

            // Cascading Undo Logic for Production
            // We check for 'production-consume' or 'production-add' and strict existence of batchNo
            if ((tx.type === 'production-consume' || tx.type === 'production-add') && tx.batchNo) {
                // Find related transactions (linked by batchNo)
                // We filter for types to ensure we don't accidentally delete unrelated things if batchNos are reused loosely, 
                // though typical usage implies unique batchNo per run.
                const relatedTxs = appState.transactions.filter(t =>
                    t.batchNo === tx.batchNo &&
                    (t.type === 'production-consume' || t.type === 'production-add' || t.type === 'production-release')
                );

                // Summarize impact for user confirmation
                const fgItems = relatedTxs.filter(t => t.type === 'production-add');
                const matItems = relatedTxs.filter(t => t.type === 'production-consume');

                let confirmMsg = `⚠️ LINKED PRODUCTION DATA DETECTED ⚠️\n\nThis transaction is part of Production Batch "${tx.batchNo}".\n\nInventory Integrity Rule: You cannot undo just one part of a production run (e.g., consumed material) without also undoing the finished good created, and vice versa.\n\nThis action will REVERSE the ENTIRE batch:\n• Remove ${fgItems.length} Finished Good entries\n• Restore ${matItems.length} Raw/Packing Material entries\n\nAre you sure you want to completely UNDO Batch ${tx.batchNo}?`;

                if (confirm(confirmMsg)) {
                    // Remove all related transactions
                    const initialCount = appState.transactions.length;
                    appState.transactions = appState.transactions.filter(t =>
                        !(t.batchNo === tx.batchNo && (t.type === 'production-consume' || t.type === 'production-add' || t.type === 'production-release'))
                    );
                    const removedCount = initialCount - appState.transactions.length;

                    saveState();
                    logActivity('Batch Undo', `Undid entire production batch ${tx.batchNo}. Reversed ${removedCount} transactions. Initiated from Item ${tx.itemId}.`);
                    showAlert(`Success: Batch ${tx.batchNo} fully reversed. ${removedCount} records removed.`);

                    // Refresh
                    openItemHistoryModal(category, tx.itemId);
                    renderInventoryView(category);
                    return;
                } else {
                    return; // User cancelled
                }
            }

            // Standard Undo for non-linked transactions
            if (confirm("Are you sure you want to undo this transaction? Stocks will be reversed.")) {
                appState.transactions.splice(idx, 1);
                saveState();
                logActivity('Undo', `Undid transaction #${txId} (${tx.type}) for Item ${tx.itemId} by user ${currentUserName}`);
                showAlert("Transaction reversed successfully.");

                // Refresh
                openItemHistoryModal(category, tx.itemId);
                renderInventoryView(category);
            }
        };

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // Overwrite loginAs to ensure it works correctly and updates UI
        window.loginAs = function (role, silent = false) {
            // Get Name
            if (!silent) {
                const nameInput = document.getElementById('login-username');
                if (!nameInput || nameInput.value.trim() === "") {
                    showAlert("Please enter your name to proceed.");
                    return;
                }
                currentUserName = nameInput.value.trim();
            }

            currentUserRole = role;
            document.body.className = `role-${role}`;
            document.body.setAttribute('data-role', role); // Critical for CSS selectors

            // Update Sidebar Display
            const roleDisplay = document.getElementById('current-user-role');
            const nameDisplay = document.getElementById('current-user-name');
            if (roleDisplay) roleDisplay.textContent = role.toUpperCase();
            if (nameDisplay) nameDisplay.textContent = currentUserName || 'Guest';

            // Log Login
            if (!silent) {
                logActivity('Login', `User logged in as ${role}`);
                closeModal('loginModal');
                showAlert(`Welcome, ${currentUserName}! Logged in as ${role.toUpperCase()}`, "Login Successful");
            }

            renderDashboard(); // Default view
        };

        window.undoLastItemAction = function (category, itemId, type) {
            // Find last transaction of this type for this item
            // Using String conversion for ID comparison to be safe against number/string mismatches
            const txIndex = appState.transactions.slice().reverse().findIndex(t => String(t.itemId) === String(itemId) && t.category === category && t.type === type);
            if (txIndex === -1) { showAlert("No recent action found to undo."); return; }

            // Actual index in main array
            const actualIndex = appState.transactions.length - 1 - txIndex;
            const tx = appState.transactions[actualIndex];

            // Remove it
            appState.transactions.splice(actualIndex, 1);
            saveState();
            logActivity('Undo', `Undid ${type} for item ${itemId} (Qty: ${tx.quantity})`);
            showAlert(`Undid last ${type} successfully.`);
            renderInventoryView(category);
            // Also refresh batch details if open
            if (document.getElementById('batchDetailsModal')) showBatchDetails(itemId, category);
        };

        window.saveCalculatorProduct = function () {
            document.getElementById('save-calc-name').value = '';
            openModal('saveCalculationModal');
        };

        window.confirmSaveCalculator = function () {
            const name = document.getElementById('save-calc-name').value.trim();
            if (!name) { showAlert("Please enter a name."); return; }

            if (!appState.savedCalculations) appState.savedCalculations = {};

            const rows = [];
            document.querySelectorAll('#calc-rows tr').forEach(row => {
                const select = row.querySelector('select');
                const qty = row.querySelector('input').value;
                if (select && select.value) {
                    rows.push({ id: select.value, qty: qty });
                }
            });

            const data = {
                rows: rows,
                labour: document.getElementById('calc-labour').value,
                expenses: document.getElementById('calc-expenses').value,
                packaging: document.getElementById('calc-packaging').value,
                freight: document.getElementById('calc-freight').value,
                tariff: document.getElementById('calc-tariff').value,
                margin: document.getElementById('calc-margin').value
            };

            appState.savedCalculations[name] = data;
            saveState();
            closeModal('saveCalculationModal');
            showAlert(`Calculation for ${name} saved!`);
            renderCalculatorSavedList();
        };

        window.renderSuppliersView = function () {
            const container = document.getElementById('suppliers-view');
            container.innerHTML = `
            <div class="h-full flex flex-col p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold">Supplier Management</h2>
                    <div class="flex gap-2">
                         <button onclick="exportSuppliersCSV()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Export CSV</button>
                         <button onclick="openSupplierModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Add Supplier</button>
                    </div>
                </div>
                <div class="overflow-x-auto bg-white rounded-lg shadow">
                    <table class="min-w-full bg-white border">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-3 border text-left">Supplier Name</th>
                                <th class="p-3 border text-left">Contact</th>
                                <th class="p-3 border text-left">Phone</th>
                                <th class="p-3 border text-center">Status</th>
                                <th class="p-3 border text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${(appState.suppliers || []).map(s => `
                                <tr id="row-suppliers-${s.id}" data-item-id="${s.id}" class="hover:bg-gray-50 border-b">
                                    <td class="p-3 border font-semibold">
                                        <button onclick="viewSupplierHistory(${s.id})" class="text-blue-600 hover:underline text-left">${s.name}</button>
                                    </td>
                                    <td class="p-3 border">${s.contact || '-'}</td>
                                    <td class="p-3 border">${s.phone || '-'}</td>
                                    <td class="p-3 border text-center">
                                         <span class="px-2 py-1 rounded-full text-xs font-semibold ${s.approved ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                                ${s.approved ? 'Approved' : 'Pending'}
                                         </span>
                                    </td>
                                    <td class="p-3 border text-right">
                                         <button onclick="openSupplierModal(${s.id})" class="text-blue-600 hover:underline mr-2">Edit</button>
                                         <button onclick="deleteSupplier(${s.id})" class="text-red-600 hover:underline">Delete</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>`;
        };

        window.viewSupplierHistory = function (supplierId) {
            const supplier = (appState.suppliers || []).find(s => s.id === supplierId);
            if (!supplier) return;

            const txs = appState.transactions.filter(t =>
                t.supplierId == supplierId || t.supplier == supplier.name
            ).sort((a, b) => new Date(b.date) - new Date(a.date));

            let html = `
                <div class="p-4">
                    <h3 class="font-bold text-xl mb-4">History for: ${supplier.name}</h3>
                    ${txs.length === 0 ? '<p class="text-gray-500">No transactions found</p>' : `
                        <table class="min-w-full text-sm">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="p-2 text-left">Date</th>
                                    <th class="p-2 text-left">Type</th>
                                    <th class="p-2 text-left">Item</th>
                                    <th class="p-2 text-right">Qty</th>
                                    <th class="p-2 text-right">Price</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${txs.map(t => {
                const item = findItem(t.category, t.itemId);
                return `
                                        <tr class="border-b hover:bg-gray-50">
                                            <td class="p-2">${t.date.split('T')[0]}</td>
                                            <td class="p-2">${t.type}</td>
                                            <td class="p-2">${item ? item.name : 'Unknown'}</td>
                                            <td class="p-2 text-right">${t.quantity}</td>
                                            <td class="p-2 text-right">${t.purchasePrice || '-'}</td>
                                        </tr>
                                    `;
            }).join('')}
                            </tbody>
                        </table>
                    `}
                    <button onclick="closeModal('genericMessageModal')" class="mt-4 px-4 py-2 bg-gray-600 text-white rounded-lg">Close Window</button>
                </div>
            `;

            document.getElementById('generic-message-title').textContent = 'Supplier History';
            document.getElementById('generic-message-content').innerHTML = html;
            document.getElementById('generic-modal-cancel').classList.add('hidden');
            document.getElementById('generic-modal-confirm').classList.add('hidden');
            const modal = document.getElementById('genericMessageModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        };


        function openDispatchModal(preItemId = null, preBatchNo = null) {
            document.getElementById('dispatch-form').reset();
            document.getElementById('dispatch-date').value = getToday();

            // Populate Customers
            const custSelect = document.getElementById('dispatch-customer');
            custSelect.innerHTML = '<option value="">Select Customer</option>' +
                (appState.customers || []).map(c => `<option value="${c.id}">${c.name}</option>`).join('');

            // Add "Add Customer" Button helper if not present
            if (!document.getElementById('btn-add-cust-helper')) {
                const btn = document.createElement('button');
                btn.id = 'btn-add-cust-helper';
                btn.type = 'button';
                btn.textContent = '+ New';
                btn.className = 'ml-2 px-2 py-1 bg-green-600 text-white rounded text-xs';
                btn.onclick = () => openCustomerModal(); // Use openCustomerModal logic
                custSelect.parentNode.insertBefore(btn, custSelect.nextSibling);
            }

            // Populate FG Items
            const itemSelect = document.getElementById('dispatch-item');
            const fgItems = appState.inventory.finishedGoods || [];
            itemSelect.innerHTML = '<option value="">Select Item</option>' +
                fgItems.map(i => `<option value="${i.id}">${i.name}</option>`).join('');

            document.getElementById('dispatch-batch').innerHTML = '<option value="">Any/FIFO</option>';

            // Ensure Dispatch Purpose Options
            const purposeSelect = document.getElementById('dispatch-purpose');
            if (purposeSelect) {
                const purposes = ['Sale', 'Dealer', 'Farmer', 'Sales Demo', 'Client', 'Sample', 'Testing', 'Transfer', 'Buyer', 'Estate'];
                purposeSelect.innerHTML = purposes.map(p => `<option value="${p}">${p}</option>`).join('');
            }

            openModal('dispatchModal');

            // Pre-select if provided - AFTER modal opens and DOM updates
            if (preItemId) {
                // Force check if item exists in list, if not add it (rare case but safety)
                // Actually, just wait a tick to ensure options are rendered
                setTimeout(() => {
                    // Fix: Handle string/number mismatch
                    let valToSet = preItemId;
                    const option = Array.from(itemSelect.options).find(o => o.value == preItemId);
                    if (option) valToSet = option.value;

                    itemSelect.value = valToSet;
                    populateDispatchBatchSelect();

                    if (preBatchNo) {
                        setTimeout(() => {
                            document.getElementById('dispatch-batch').value = preBatchNo;
                        }, 50);
                    }
                }, 100);
            }
        }

        function populateDispatchBatchSelect() {
            const itemId = parseFloat(document.getElementById('dispatch-item').value);
            const batchSelect = document.getElementById('dispatch-batch');
            batchSelect.innerHTML = '<option value="">Any/FIFO</option>';

            if (!itemId) return;

            // Find batches for this item from transactions
            const batches = new Set();
            appState.transactions.forEach(t => {
                if (t.category === 'finishedGoods' && t.itemId === itemId && t.batchNo) {
                    batches.add(t.batchNo);
                }
            });

            const batchArray = Array.from(batches);

            if (batchArray.length === 0) {
                batchSelect.innerHTML = '<option value="">Any/FIFO (No Batches Found)</option>';
                return;
            }

            // Calculate stock for each batch
            batchArray.forEach(b => {
                let qty = 0;
                appState.transactions.forEach(t => {
                    if (t.category === 'finishedGoods' && t.itemId === itemId && t.batchNo === b) {
                        if (['receive', 'produce', 'stock-take-adj-in', 'production-add'].includes(t.type)) qty += t.quantity;
                        else if (['consume', 'dispatch', 'stock-take-adj-out', 'production-consume'].includes(t.type)) qty -= t.quantity;
                    }
                });

                if (qty > 0.001) { // Only show batches with stock or negative? User might want to adj negative. Show All.
                    const opt = document.createElement('option');
                    opt.value = b;
                    opt.textContent = `${b} (Stock: ${qty.toFixed(3)})`;
                    opt.dataset.qty = qty;
                    batchSelect.appendChild(opt);
                }
            });

            // Re-append "Any/FIFO" at top if needed, or leave as default. 
            // The default is already populated above.
        }

        function openBatchAdjustmentModal() {
            const itemId = parseFloat(document.getElementById('dispatch-item').value);
            const batchNo = document.getElementById('dispatch-batch').value;
            const category = 'finishedGoods';

            if (!itemId) { showAlert("Please select an item first."); return; }
            if (!batchNo) { showAlert("Please select a specific batch to edit."); return; }

            const item = findItem(category, itemId);
            if (!item) return;

            // Use the existing Adjust Stock modal but pre-fill batch note
            document.getElementById('adjust-stock-form').reset();
            document.getElementById('adjust-item-id').value = itemId;
            document.getElementById('adjust-item-category').value = category;
            document.getElementById('adjust-item-name').textContent = `${item.name} (Batch: ${batchNo})`;
            document.getElementById('adjust-date').value = getToday();

            // Calculate CURRENT BATCH STOCK
            let batchStock = 0;
            appState.transactions.forEach(t => {
                if (t.category === category && t.itemId === itemId && t.batchNo === batchNo) {
                    if (['receive', 'produce', 'stock-take-adj-in', 'production-add'].includes(t.type)) batchStock += t.quantity;
                    else if (['consume', 'dispatch', 'stock-take-adj-out', 'production-consume'].includes(t.type)) batchStock -= t.quantity;
                }
            });

            document.getElementById('adjust-system-stock').value = batchStock.toFixed(3);
            document.getElementById('adjust-actual-stock').value = '';
            document.getElementById('adjust-reason').value = `Correction for Batch ${batchNo}`;

            // WE NEED TO PASS THE BATCH NO TO THE SUBMIT HANDLER
            // We can store it in a hidden field or data attribute on the form
            // Let's create a hidden input if it doesn't exist
            let batchInput = document.getElementById('adjust-batch-hidden');
            if (!batchInput) {
                batchInput = document.createElement('input');
                batchInput.type = 'hidden';
                batchInput.id = 'adjust-batch-hidden';
                document.getElementById('adjust-stock-form').appendChild(batchInput);
            }
            batchInput.value = batchNo;

            // Slightly obscure logic: The main adjust form handler doesn't know about batches by default.
            // We need to modify handleStockAdjustment or ensure it reads this hidden field.

            const modal = document.getElementById('adjustStockModal');
            if (modal) {
                // Ensure Z-index is higher than dispatch modal (55)
                modal.style.zIndex = '60';
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }
        }

        function handleStockAdjustment(e) {
            e.preventDefault();
            if (!checkPermission()) return;

            const itemId = parseFloat(document.getElementById('adjust-item-id').value);
            const category = document.getElementById('adjust-item-category').value;
            const date = document.getElementById('adjust-date').value;
            const systemStock = parseFloat(document.getElementById('adjust-system-stock').value);
            const actualStock = parseFloat(document.getElementById('adjust-actual-stock').value);
            const reason = document.getElementById('adjust-reason').value;

            const batchNo = document.getElementById('adjust-batch-hidden') ? document.getElementById('adjust-batch-hidden').value : null;

            if (isNaN(actualStock) || actualStock < 0) {
                showAlert("Please enter a valid actual stock quantity.");
                return;
            }

            const diff = actualStock - systemStock;

            if (diff === 0) {
                showAlert("No difference between system and actual stock.");
                return;
            }

            const item = findItem(category, itemId);
            if (!item) return;

            const type = diff > 0 ? 'stock-take-adj-in' : 'stock-take-adj-out';
            const quantity = Math.abs(diff);

            const tx = {
                id: Date.now(),
                itemId: item.id,
                category: category,
                type: type,
                quantity: quantity,
                date: date + 'T00:00:00.000Z',
                notes: reason || "Stock Adjustment",
                updatedBy: currentUserName || 'System',
                batchNo: batchNo || null
            };

            if (document.getElementById('adjust-batch-hidden')) {
                document.getElementById('adjust-batch-hidden').value = '';
            }

            appState.transactions.push(tx);
            saveState();

            closeModal('adjustStockModal');

            if (!document.getElementById('dispatchModal').classList.contains('hidden')) {
                populateDispatchBatchSelect();
            }

            showAlert(`Stock updated successfully. Adjustment recorded: ${diff > 0 ? '+' : ''}${diff} ${item.unit}`);
            showView(currentView);
        }


        // === DATA MANAGEMENT FUNCTIONS ===

        function importCSVData() {
            const category = document.getElementById('import-category').value;
            const csvData = document.getElementById('import-csv-data').value.trim();

            if (!csvData) {
                showAlert("Please paste CSV data to import.");
                return;
            }

            const lines = csvData.split('\n').map(l => l.trim()).filter(l => l);
            if (lines.length === 0) {
                showAlert("No data to import.");
                return;
            }

            let imported = 0;
            let errors = [];

            lines.forEach((line, idx) => {
                const parts = line.split(',').map(p => p.trim());
                if (parts.length < 3) {
                    errors.push(`Line ${idx + 1}: Invalid format (expected Name,Unit,Price,Stock)`);
                    return;
                }

                const [name, unit, priceStr, stockStr] = parts;
                const price = parseFloat(priceStr) || 0;
                const stock = parseFloat(stockStr) || 0;

                if (!name || !unit) {
                    errors.push(`Line ${idx + 1}: Name and Unit are required`);
                    return;
                }

                // Check if item exists
                const existing = appState.inventory[category].find(i => i.name.toLowerCase() === name.toLowerCase());

                if (existing) {
                    // Update price
                    existing.price = price;
                } else {
                    // Add new item
                    const newItem = {
                        id: Date.now() + idx,
                        name,
                        unit,
                        price,
                        openingStock: stock,
                        openingStockDate: getToday()
                    };
                    appState.inventory[category].push(newItem);
                }

                imported++;
            });

            saveState();
            document.getElementById('import-csv-data').value = '';

            let message = `Successfully imported/updated ${imported} items.`;
            if (errors.length > 0) {
                message += `\n\nErrors:\n${errors.join('\n')}`;
            }

            showAlert(message);
            showView(currentView); // Refresh
        }

        function exportFullBackupJSON() {
            const backup = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                data: appState
            };

            const json = JSON.stringify(backup, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `inventory_backup_${getToday()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showAlert("Backup exported successfully!");
        }

        function importFullBackupJSON(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const backup = JSON.parse(e.target.result);

                    // Handle both new format (with wrapper) and old format (raw appState)
                    let dataToRestore;
                    if (backup.data) {
                        // New format with version and wrapper
                        dataToRestore = backup.data;
                    } else if (backup.inventory && backup.transactions) {
                        // Old format - raw appState
                        dataToRestore = backup;
                    } else {
                        showAlert("Invalid backup file format.");
                        return;
                    }

                    showConfirm("This will replace ALL current data. Continue?", () => {
                        appState = dataToRestore;
                        saveState();
                        location.reload();
                    });
                } catch (err) {
                    showAlert("Error reading backup file: " + err.message);
                }
            };
            reader.readAsText(file);

            // Reset file input
            event.target.value = '';
        }

        function exportSelfContainedHTML() {
            // Get current HTML
            let html = document.documentElement.outerHTML;

            // Replace the app-data script content with current state
            const stateJSON = JSON.stringify(appState, null, 2);
            const scriptRegex = /(<script id="app-data" type="application\/json">)([\s\S]*?)(<\/script>)/;
            html = html.replace(scriptRegex, `$1\n${stateJSON}\n$3`);

            // Create download
            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `inventory_app_${getToday()}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showAlert("Self-contained HTML file exported successfully!");
        }

        function forceUploadToCloud() {
            if (!cloudApiUrl) {
                showAlert("Cloud connection not configured. Please set up cloud connection first.");
                return;
            }

            showConfirm("Force upload all local data to cloud?", () => {
                pushToCloud();
            });
        }

        function clearAllDataAndReset() {
            showConfirm("⚠️ WARNING: This will DELETE ALL DATA and cannot be undone!\n\nAre you absolutely sure?", () => {
                showConfirm("Final confirmation: Really delete everything?", () => {
                    localStorage.clear();
                    sessionStorage.clear();
                    location.reload();
                });
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            const dispatchForm = document.getElementById('dispatch-form');
            if (dispatchForm) {
                dispatchForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const date = document.getElementById('dispatch-date').value;
                    const customerId = parseFloat(document.getElementById('dispatch-customer').value);
                    const itemId = parseFloat(document.getElementById('dispatch-item').value);
                    const batchNo = document.getElementById('dispatch-batch').value;
                    const qty = parseFloat(document.getElementById('dispatch-qty').value);
                    const invoiceNo = document.getElementById('dispatch-invoice').value;

                    const purpose = document.getElementById('dispatch-purpose').value;
                    const notes = document.getElementById('dispatch-notes').value;

                    if (qty <= 0) { showAlert("Quantity must be positive."); return; }
                    if (isNaN(customerId)) { showAlert("Please select a customer."); return; }

                    const item = findItem('finishedGoods', itemId);
                    if (!item) { showAlert("Invalid Item."); return; }

                    // Check total stock availability first
                    const stock = calculateStock(item, 'finishedGoods', getToday());
                    if (stock.closingStock < qty) {
                        showAlert(`Insufficient stock! Current stock: ${stock.closingStock.toFixed(3)} ${item.unit}`);
                        return;
                    }

                    let finalTransactions = [];
                    const baseTx = {
                        id: Date.now(),
                        itemId: itemId,
                        category: 'finishedGoods',
                        type: 'dispatch',
                        subtype: purpose,
                        date: date + 'T00:00:00.000Z',
                        customerId: customerId,
                        invoiceNo: invoiceNo || null,
                        notes: notes || ''
                    };

                    if (batchNo) {
                        // Manual Batch Selection
                        baseTx.quantity = qty;
                        baseTx.batchNo = batchNo;
                        finalTransactions.push(baseTx);
                    } else {
                        // Auto-Allocation (FEFO)
                        const allocation = allocateStock(item, 'finishedGoods', qty, 'FEFO');
                        allocation.forEach((alloc, idx) => {
                            const splitTx = { ...baseTx };
                            splitTx.id = Date.now() + idx; // unique IDs
                            splitTx.quantity = alloc.quantity;
                            splitTx.batchNo = alloc.batchNo;
                            finalTransactions.push(splitTx);
                        });

                        if (finalTransactions.length === 0) {
                            baseTx.quantity = qty;
                            finalTransactions.push(baseTx);
                        }
                    }

                    // Push all transactions
                    finalTransactions.forEach(tx => appState.transactions.push(tx));

                    saveState();
                    logActivity('Dispatch', `Dispatched ${qty} of item ${itemId} to customer ${customerId}. Purpose: ${purpose} (${finalTransactions.length} batches)`);
                    closeModal('dispatchModal');
                    showAlert("Dispatch recorded.");
                    showView(currentView);
                });
            }
        });

        // Initialize Role
        document.addEventListener('DOMContentLoaded', () => {
            loginAs('viewer', true);
        });


        // Ensure functions are globally accessible
        window.openAdjustStockModal = function (category, id) {
            // Redefinition to ensure robustness
            const item = findItem(category, id);
            if (!item) { console.error("Item not found"); return; }

            document.getElementById('adjust-stock-form').reset();
            document.getElementById('adjust-item-id').value = id;
            document.getElementById('adjust-item-category').value = category;
            document.getElementById('adjust-item-name').textContent = item.name;
            document.getElementById('adjust-date').value = getToday();

            const stock = calculateStock(item, category, getToday());

            document.getElementById('adjust-system-stock').value = stock.closingStock.toFixed(3);
            document.getElementById('adjust-actual-stock').value = '';

            const modal = document.getElementById('adjustStockModal');
            if (modal) modal.classList.remove('hidden');
            openModal('adjustStockModal');
        };

        // --- OVERRIDES FOR ROBUSTNESS ---

        // 1. Calculate Stock Override to ensure Dispatches are subtracted and Daily View is correct
        // 1. Calculate Stock Override (Robust & Uncached for Real-time accuracy)
        window.calculateStock = function (item, category, date) {
            const targetDate = date ? new Date(date) : new Date();
            // Set to end of day to include all transactions of that day
            const limit = new Date(targetDate);
            limit.setHours(23, 59, 59, 999);

            let openingStock = item.openingStock || 0;
            let received = 0;
            let consumed = 0;
            let closingStock = openingStock;

            // Filter relevant transactions up to limit
            const txs = appState.transactions.filter(t =>
                (t.category === category || (category === 'rawMaterials' && t.category === 'raw_materials')) &&
                t.itemId == item.id &&
                new Date(t.date) <= limit
            );

            txs.forEach(t => {
                const qty = parseFloat(t.quantity) || 0;
                // Additions
                if (['receive', 'produce', 'stock-take-adj-in', 'production-add'].includes(t.type)) {
                    received += qty;
                    closingStock += qty;
                }
                // Reductions
                else if (['consume', 'dispatch', 'stock-take-adj-out', 'production-consume'].includes(t.type)) {
                    consumed += qty;
                    closingStock -= qty;
                }
            });

            // Helper for "Daily View" specific logic (Received/Consumed ON the specific date)
            // If date argument was provided, we might want specifically what happened THAT day.
            // But the return object structure implies "Cumulative Closing" but "Period Received/Consumed"?
            // The Daily Report uses this function. It expects 'received' and 'consumed' to be FOR THE REPORT DATE.

            if (date) {
                // Reset received/consumed to be only for the specific date
                received = 0;
                consumed = 0;
                const dayStart = new Date(targetDate); dayStart.setHours(0, 0, 0, 0);
                const dayEnd = new Date(targetDate); dayEnd.setHours(23, 59, 59, 999);

                txs.forEach(t => {
                    const tDate = new Date(t.date);
                    if (tDate >= dayStart && tDate <= dayEnd) {
                        const qty = parseFloat(t.quantity) || 0;
                        if (['receive', 'produce', 'stock-take-adj-in', 'production-add'].includes(t.type)) received += qty;
                        else if (['consume', 'dispatch', 'stock-take-adj-out', 'production-consume'].includes(t.type)) consumed += qty;
                    }
                });

                // Recalculate opening for this specific day
                openingStock = closingStock - received + consumed;
            }

            return { openingStock, received, consumed, closingStock };
        };

        // 2. FG Cost Update Helper (SAFE MODE)
        window.updateItemCostFromFormula = function (itemId) {
            try {
                console.log("ANTIGRAVITY: updateItemCostFromFormula called for ID:", itemId);
                let id = itemId;
                // Parse ID safely
                if (typeof itemId === 'string') {
                    const parsed = parseFloat(itemId);
                    if (!isNaN(parsed)) id = parsed;
                }

                // 1. Find Item safe check
                if (typeof findItem !== 'function') throw new Error("findItem function missing");
                const item = findItem('finishedGoods', id);

                if (!item) {
                    if (window.showAlert) showAlert("Item not found!");
                    else alert("Item not found!");
                    return;
                }

                // 2. Prepare Formulas
                if (!appState.formulas) appState.formulas = [];

                // 3. Find Formula (Defensive against bad data)
                const cleanItemName = (item.name || '').trim().toLowerCase();
                if (!cleanItemName) throw new Error("Item has no valid name.");

                const formula = appState.formulas.find(f => (f.name || '').trim().toLowerCase() === cleanItemName);

                // 4. Handle Missing Formula
                if (!formula) {
                    const msg = `Formula for "${item.name}" not found in Formulation section.\n\nDo you want to create a new formula now?`;

                    const handleConfirm = () => {
                        try {
                            if (window.isFormulaUnlocked) {
                                window.pendingFormulaCreateName = item.name;
                                if (window.showView) showView('formulations');
                            } else {
                                // SAFE MODE: Just tell the user to unlock manually.
                                alert("⚠️ Action Required:\n\nPlease go to the 'Formulations' section manually and UNLOCK it first (Password: MIKLENS2016).\n\nThen try 'Fetch Cost' again.");
                            }
                        } catch (e) {
                            alert("Navigation Error: " + e.message);
                        }
                    };

                    if (window.showConfirm) {
                        showConfirm(msg, handleConfirm, "Formula Not Found");
                    } else {
                        if (confirm(msg)) handleConfirm();
                    }
                    return;
                }

                // 5. Calculation Logic (Defensive)
                let totalCost = 0;
                let missingIngredients = [];

                if (!Array.isArray(formula.ingredients)) throw new Error("Formula ingredients list is malformed.");

                formula.ingredients.forEach(ing => {
                    if (!ing.itemId) return;
                    const ingItem = findItem(ing.category, ing.itemId);
                    if (ingItem) {
                        const cost = (ingItem.currentAverageCost || ingItem.price || 0);
                        totalCost += (ing.quantity || 0) * cost;
                    } else {
                        missingIngredients.push(ing.itemId);
                    }
                });

                if (missingIngredients.length > 0) {
                    const err = "Cannot calculate. Missing ingredients IDs: " + missingIngredients.join(', ');
                    if (window.showAlert) showAlert(err); else alert(err);
                    return;
                }

                // Packing Materials
                if (formula.packingMaterials && Array.isArray(formula.packingMaterials)) {
                    formula.packingMaterials.forEach(pm => {
                        if (!pm.itemId) return;
                        const pmItem = findItem('packingMaterials', pm.itemId);
                        if (pmItem) {
                            const cost = (pmItem.currentAverageCost || pmItem.price || 0);
                            totalCost += (pm.quantity || 0) * cost;
                        }
                    });
                }

                const outputQty = parseFloat(formula.outputQty) || 1;
                const unitCost = totalCost / outputQty;

                if (unitCost <= 0) {
                    const msg = "Calculated cost is 0. Check raw material prices.";
                    if (window.showAlert) showAlert(msg); else alert(msg);
                    return;
                }

                // 6. Update Prompt
                const confirmMsg = `Calculated Cost for ${item.name}: ₹${unitCost.toFixed(2)}/${item.unit}.\n(Based on ${outputQty} unit output)\n\nUpdate Item Cost?`;
                const onUpdate = () => {
                    item.currentAverageCost = unitCost;
                    if (item.price === 0) item.price = unitCost; // Set standard price if 0
                    saveState();
                    if (window.renderInventoryView) renderInventoryView('finishedGoods');
                    if (window.showAlert) showAlert(`Cost updated to ₹${unitCost.toFixed(2)}`); else alert("Cost updated.");
                };

                if (window.showConfirm) showConfirm(confirmMsg, onUpdate, "Update Cost");
                else if (confirm(confirmMsg)) onUpdate();

            } catch (err) {
                console.error(err);
                // Heavy-handed Alert Fallback to ensure user sees the crash reason
                alert("CRITICAL ERROR in Cost Calc: " + err.message);
            }
        };

        window.openDispatcherModal = openDispatchModal;
        window.showBatchDetails = showBatchDetails;
        window.openModal = openModal;
        window.closeModal = closeModal;


        // --- DRAG AND DROP HANDLERS ---
        window.handleDragStart = function (e, index) {
            if (!window.isReorderMode) return;
            e.dataTransfer.setData('text/plain', index);
            e.dataTransfer.effectAllowed = 'move';
        };

        window.handleDragOver = function (e) {
            if (!window.isReorderMode) return;
            e.preventDefault();
        };



        window.handleDrop = function (e, targetIndex, category) {
            if (!window.isReorderMode) return;
            e.preventDefault();
            const sourceIndex = parseInt(e.dataTransfer.getData('text/plain'));
            if (sourceIndex === targetIndex) return;

            const items = appState.inventory[category];
            // Move item in array
            const [movedItem] = items.splice(sourceIndex, 1);
            items.splice(targetIndex, 0, movedItem);

            saveState(); // Save the new order
            renderInventoryView(category);
        };

        // --- AUTO REFRESH & REORDER UTILITIES ---

        function startAutoRefresh() {
            // Refresh every 30 seconds if auto-sync is enabled
            if (window.autoRefreshInterval) clearInterval(window.autoRefreshInterval);
            window.autoRefreshInterval = setInterval(() => {
                if (autoSyncEnabled && cloudApiUrl && !document.hidden) {
                    console.log("Auto-refreshing data...");
                    fetchFromCloud();
                }
            }, 30000);
        }



        // REDEFINED renderInventoryView REMOVED/DISABLED to restore original interface
        window._disabled_renderInventoryView = function (category) {
            const containerId = category === 'rawMaterials' ? 'raw-materials-view' :
                category === 'packingMaterials' ? 'packing-materials-view' :
                    category === 'finishedGoods' ? 'finished-goods-view' :
                        category === 'labels' ? 'labels-view' : null;

            const container = document.getElementById(containerId);
            if (!container) return;

            const titleMap = {
                rawMaterials: "Raw Materials",
                packingMaterials: "Packing Materials",
                labels: "Labels",
                finishedGoods: "Finished Goods"
            };

            let items = appState.inventory[category] || [];

            // Search Filter
            const searchEl = document.getElementById(`${category}-search`);
            const searchTerm = (searchEl?.value || '').toLowerCase();
            const filteredItems = items.filter(i => i.name.toLowerCase().includes(searchTerm));

            container.innerHTML = `
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-3">
                            ${titleMap[category]} Stock
                            <span class="text-xs bg-gray-200 text-gray-600 px-2 py-1 rounded-full">Total: ${items.length}</span>
                        </h2>
                        <div class="flex gap-2">
                             ${window.isReorderMode ?
                    `<button onclick="toggleReorderMode('${category}')" class="px-4 py-2 bg-green-600 text-white rounded shadow font-bold hover:bg-green-700 transition">Done Reordering</button>` :
                    `<button onclick="toggleReorderMode('${category}')" class="px-4 py-2 bg-indigo-100 text-indigo-700 rounded hover:bg-indigo-200 font-semibold transition flex items-center gap-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg> Reorder Items</button>`
                }
                             <button onclick="openAddItemModal('${category}')" class="px-4 py-2 bg-blue-600 text-white rounded shadow hover:bg-blue-700 font-semibold transition flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg> 
                                Add Item
                             </button>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow overflow-hidden border border-gray-100">
                        <div class="p-4 border-b bg-gray-50 flex justify-between items-center">
                            <div class="relative">
                                <span class="absolute inset-y-0 left-0 flex items-center pl-2">
                                    <svg class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                                </span>
                                <input type="text" id="${category}-search" value="${searchTerm}" 
                                   oninput="renderInventoryView('${category}')" 
                                   placeholder="Search ${titleMap[category]}..." 
                                   class="pl-10 w-64 p-2 border rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm">
                            </div>
                            <div class="text-sm text-gray-500">
                                ${window.isReorderMode ? '<span class="text-orange-600 font-bold animate-pulse">Drag rows to reorder</span>' : 'Manage your inventory'}
                            </div>
                        </div>
                        
                        <div class="overflow-x-auto max-h-[70vh]">
                            <table class="min-w-full text-sm text-left text-gray-500">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-100 sticky top-0 shadow-sm z-10">
                                    <tr>
                                        <th class="px-6 py-3 w-16 text-center">S.No</th>
                                        <th class="px-6 py-3">Item Name</th>
                                        <th class="px-6 py-3">Unit</th>
                                        <th class="px-6 py-3 text-right">Stock</th>
                                        <th class="px-6 py-3 text-right">Avg Cost</th>
                                        <th class="px-6 py-3 text-right">Value</th>
                                        <th class="px-6 py-3 text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${filteredItems.length > 0 ? filteredItems.map((item, index) => {
                    const stock = calculateStock(item, category, getToday());
                    const value = stock.closingStock * (item.currentAverageCost || item.price);
                    const isLowStock = item.minStockLevel && stock.closingStock < item.minStockLevel;
                    const realIndex = items.indexOf(item);

                    return `
                                            <tr class="bg-white border-b hover:bg-gray-50 transition-colors ${window.isReorderMode ? 'cursor-move hover:bg-orange-50' : ''}"
                                                ${window.isReorderMode ? `draggable="true" ondragstart="handleDragStart(event, ${realIndex})" ondragover="handleDragOver(event)" ondrop="handleDrop(event, ${realIndex}, '${category}')"` : ''}>
                                                <td class="px-6 py-4 text-center text-gray-400 font-mono text-xs">
                                                    ${window.isReorderMode ? ':::' + (index + 1) : index + 1}
                                                </td>
                                                <td class="px-6 py-4 font-medium text-gray-900">
                                                    <div class="flex items-center">
                                                        ${item.name}
                                                        ${isLowStock ? '<span class="ml-2 px-2 py-0.5 rounded-full bg-red-100 text-red-800 text-[10px] font-bold uppercase tracking-wide">Low Stock</span>' : ''}
                                                    </div>
                                                </td>
                                                <td class="px-6 py-4">${item.unit}</td>
                                                <td class="px-6 py-4 text-right font-bold ${stock.closingStock < 0 ? 'text-red-600' : 'text-gray-900'}">
                                                    ${stock.closingStock.toFixed(3)}
                                                </td>
                                                <td class="px-6 py-4 text-right text-xs">₹${(item.currentAverageCost || item.price).toFixed(2)}</td>
                                                <td class="px-6 py-4 text-right font-mono text-gray-600 font-semibold">₹${value.toFixed(2)}</td>
                                                <td class="px-6 py-4 text-center">
                                                    <div class="flex justify-center gap-1 group">
                                                        <button onclick="openStockTxModal('${category}', ${item.id}, 'receive')" class="px-2 py-1 bg-green-50 text-green-700 border border-green-200 rounded hover:bg-green-100 text-xs font-semibold" title="Receive Stock">Rx</button>
                                                        <button onclick="openStockTxModal('${category}', ${item.id}, 'consume')" class="px-2 py-1 bg-red-50 text-red-700 border border-red-200 rounded hover:bg-red-100 text-xs font-semibold" title="Consume Stock">Tx</button>
                                                        <button onclick="openEditItemModal('${category}', ${item.id})" class="px-2 py-1 bg-gray-50 text-gray-600 border border-gray-200 rounded hover:bg-gray-100 text-xs font-semibold" title="Edit Item">Edit</button>
                                                        
                                                        <button onclick="openItemHistoryModal('${category}', ${item.id})" class="px-2 py-1 text-gray-400 hover:text-gray-600" title="View History">
                                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                                        </button>
                                                        <button onclick="openAdjustStockModal('${category}', ${item.id})" class="px-2 py-1 text-orange-300 hover:text-orange-500" title="Adjust Stock">
                                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        `;
                }).join('') : '<tr><td colspan="7" class="px-6 py-8 text-center text-gray-500 italic">No items found in this section. Click "Add Item" to start.</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;

            // Focus upkeep
            const newSearchBox = document.getElementById(`${category}-search`);
            if (newSearchBox && searchTerm) {
                newSearchBox.focus();
                var val = newSearchBox.value;
                newSearchBox.value = '';
                newSearchBox.value = val;
            }
        };

        window.clearAllDataAndReset = function () {
            showConfirm("DANGER: This will wipe ALL data from this browser (Local & Cache). Cloud data will remain if not overwritten. Are you sure?", () => {
                showConfirm("Double Check: This cannot be undone. Confirm wipe?", () => {
                    // Clear LocalStorage
                    localStorage.removeItem('inventoryAppState');
                    localStorage.removeItem('inventoryCloudUrl');
                    localStorage.removeItem('autoSyncEnabled');

                    alert("Application has been completely reset to factory settings. Reloading...");
                    window.location.reload();
                }, "FINAL WARNING");
            }, "DANGER ZONE");
        };

        // --- PRODUCTION & WIP LOGIC ---

        window.getReservedStock = function (item, category) {
            if (!appState.activeProduction) return 0;
            let reserved = 0;
            appState.activeProduction.forEach(batch => {
                const s = (batch.status || '').toLowerCase();
                // Include 'In Progress', 'Started', and 'Paused'
                if ((s === 'started' || s === 'paused' || s === 'in progress') && batch.reservedData) {
                    const arrays = [
                        { list: batch.reservedData.rawMaterials, cat: 'rawMaterials' },
                        { list: batch.reservedData.packingMaterials, cat: 'packingMaterials' },
                        { list: batch.reservedData.labels, cat: 'labels' }
                    ];
                    arrays.forEach(group => {
                        if (group.cat === category && group.list) {
                            const match = group.list.find(r => r.itemId == item.id || r.id == item.id);
                            if (match) reserved += (parseFloat(match.quantity) || 0);
                        }
                    });
                }
            });
            return reserved;
        };

        // OLD VERSION - DISABLED (V34 version is at the end of file with Requisition App linking)
        window.renderProductionWIPView_OLD = function () {
            const container = document.getElementById('production-wip-view');

            const activeBatches = appState.activeProduction || [];
            // Sort by date desc
            activeBatches.sort((a, b) => new Date(b.startDate) - new Date(a.startDate));

            const formulas = appState.formulas || [];

            container.innerHTML = `
                <div class="p-6">
                     <h2 class="text-2xl font-bold mb-6 text-gray-800">Orders & Production (WIP)</h2>
                     
                     <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Left: Create New Batch -->
                        <div class="bg-white p-6 rounded-lg shadow h-fit">
                            <h3 class="text-xl font-bold mb-4 text-blue-600">Start New Production</h3>
                            <form id="create-batch-form" onsubmit="handleCreateBatch(event)">
                                <div class="mb-4">
                                    <label class="block text-sm font-medium mb-1">Batch ID / Order Ref</label>
                                    <input type="text" id="new-batch-id" class="w-full p-2 border rounded font-mono" placeholder="e.g. B-2023-001" required>
                                </div>
                                <div class="mb-4">
                                    <label class="block text-sm font-medium mb-1">Product Formula</label>
                                    <select id="new-batch-formula" class="w-full p-2 border rounded" required>
                                        <option value="">-- Select Product --</option>
                                        ${formulas.map(f => `<option value="${f.id}">${f.name} (${f.outputQty} ${f.outputUnit})</option>`).join('')}
                                    </select>
                                </div>
                                <div class="mb-4">
                                    <label class="block text-sm font-medium mb-1">Target Quantity</label>
                                    <input type="number" id="new-batch-qty" step="any" class="w-full p-2 border rounded" placeholder="Qty to produce" required>
                                </div>
                                <button type="submit" class="w-full py-2 bg-blue-600 text-white rounded font-bold hover:bg-blue-700">Create Order</button>
                            </form>
                        </div>

                        <!-- Right: Active Batches List -->
                        <div class="lg:col-span-2 space-y-4">
                            ${activeBatches.length === 0 ? '<div class="bg-white p-8 rounded-lg shadow text-center text-gray-500">No active production orders.</div>' :
                    activeBatches.map(batch => {
                        const formula = formulas.find(f => f.id == batch.formulaId);
                        const formulaName = formula ? formula.name : 'Unknown Product';
                        const statusColors = {
                            'draft': 'bg-gray-100 text-gray-800',
                            'started': 'bg-blue-100 text-blue-800',
                            'paused': 'bg-yellow-100 text-yellow-800',
                            'completed': 'bg-green-100 text-green-800',
                            'cancelled': 'bg-red-100 text-red-800'
                        };
                        const borderColors = {
                            'draft': 'border-gray-300',
                            'started': 'border-blue-500',
                            'paused': 'border-yellow-500',
                            'completed': 'border-green-500'
                        };
                        const shortageAlert = batch.shortageOverride ?
                            '<div class="mt-2 bg-red-50 text-red-700 px-3 py-2 rounded text-xs font-bold border border-red-200 flex items-center"><svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>Started with SHORTAGE OVERRIDE</div>' : '';

                        // Calculate days since pause
                        const daysPaused = batch.pausedDate ? Math.floor((new Date() - new Date(batch.pausedDate)) / (1000 * 60 * 60 * 24)) : 0;
                        const pauseAlert = batch.status === 'paused' ?
                            '<div class="mt-2 bg-yellow-50 text-yellow-700 px-3 py-2 rounded text-xs font-bold border border-yellow-200 flex items-center">⏸️ PAUSED for ' + daysPaused + ' day(s) - ' + (batch.pauseReason || 'Unknown') + (batch.expectedResumeDate ? ' (Expected: ' + batch.expectedResumeDate + ')' : '') + '</div>' : '';

                        // Calculate slips count and produced qty
                        const slipsCount = (batch.consumptionSlips || []).length;
                        const producedQty = batch.producedQty || 0;

                        // Build buttons based on status
                        let actionButtons = '';
                        if (batch.status === 'draft') {
                            actionButtons = '<button onclick="startBatch(' + batch.id + ')" class="text-sm px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">▶️ Start Production</button>' +
                                '<button onclick="deleteBatch(' + batch.id + ')" class="text-sm px-4 py-2 bg-red-100 text-red-600 rounded hover:bg-red-200">Delete</button>';
                        } else if (batch.status === 'started') {
                            actionButtons = '<button onclick="openConsumptionSlipModal(' + batch.id + ')" class="text-sm px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">📝 Log Slip</button>' +
                                '<button onclick="openPauseModal(' + batch.id + ')" class="text-sm px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600">⏸️ Pause</button>' +
                                '<button onclick="completeBatch(' + batch.id + ')" class="text-sm px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">✅ Complete</button>' +
                                '<button onclick="cancelBatch(' + batch.id + ')" class="text-sm px-4 py-2 bg-red-100 text-red-600 rounded hover:bg-red-200">Cancel</button>';
                        } else if (batch.status === 'paused') {
                            actionButtons = '<button onclick="openConsumptionSlipModal(' + batch.id + ')" class="text-sm px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">📝 Log Slip</button>' +
                                '<button onclick="resumeProduction(' + batch.id + ')" class="text-sm px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">▶️ Resume</button>' +
                                '<button onclick="cancelBatch(' + batch.id + ')" class="text-sm px-4 py-2 bg-red-100 text-red-600 rounded hover:bg-red-200">Cancel</button>';
                        }

                        return '<div class="bg-white p-6 rounded-lg shadow border-l-4 ' + (borderColors[batch.status] || 'border-gray-300') + ' cursor-pointer hover:shadow-lg transition-shadow" onclick="openWipDetailModal(' + batch.id + ')">' +
                            '<div class="flex justify-between items-start mb-4">' +
                            '<div>' +
                            '<h4 class="text-lg font-bold">' + formulaName + '</h4>' +
                            '<p class="text-sm text-gray-500 font-mono">Batch: ' + batch.batchNo + '</p>' +
                            '</div>' +
                            '<span class="px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide ' + (statusColors[batch.status] || 'bg-gray-100') + '">' + batch.status + '</span>' +
                            '</div>' +
                            '<div class="grid grid-cols-2 md:grid-cols-5 gap-4 text-sm mb-4">' +
                            '<div><p class="text-gray-500">Target Qty</p><p class="font-bold">' + batch.targetQty + '</p></div>' +
                            '<div><p class="text-gray-500">Produced</p><p class="font-bold text-green-600">' + producedQty + '</p></div>' +
                            '<div><p class="text-gray-500">Slips</p><p>' + slipsCount + '</p></div>' +
                            '<div><p class="text-gray-500">Date</p><p>' + new Date(batch.startDate).toLocaleDateString() + '</p></div>' +
                            '<div><p class="text-gray-500">Materials</p><p>' + (batch.reservedData ? batch.reservedData.rawMaterials.length : 0) + ' items</p></div>' +
                            '</div>' +
                            shortageAlert +
                            pauseAlert +
                            '<div class="flex flex-wrap gap-2 border-t pt-4 mt-2" onclick="event.stopPropagation()">' + actionButtons + '</div>' +
                            '</div>';
                    }).join('')}
                        </div>
                     </div>
                </div>
            `;
        }

        window.handleCreateBatch = function (e) {
            e.preventDefault();
            const batchNo = document.getElementById('new-batch-id').value;
            const formulaId = document.getElementById('new-batch-formula').value;
            const qty = parseFloat(document.getElementById('new-batch-qty').value);

            if (!batchNo || !formulaId || !qty) { showAlert("Please fill all fields"); return; }

            const formula = appState.formulas.find(f => f.id == formulaId);
            if (!formula) return;

            // Calculate requirements for reservation
            const scalingFactor = qty / formula.outputQty;
            const reservedData = {
                rawMaterials: formula.ingredients.map(i => ({ itemId: i.itemId, quantity: i.quantity * scalingFactor })),
                packingMaterials: (formula.packingMaterials || []).map(i => ({ itemId: i.itemId, quantity: i.quantity * scalingFactor })),
                labels: (formula.labels || []).map(i => ({ itemId: i.itemId, quantity: i.quantity * scalingFactor }))
            };

            const newBatch = {
                id: Date.now(),
                batchNo: batchNo,
                formulaId: parseInt(formulaId),
                targetQty: qty,
                startDate: new Date().toISOString(),
                status: 'draft',
                reservedData: reservedData,
                // NEW: Slip-based tracking fields
                consumptionSlips: [],
                statusHistory: [{ date: new Date().toISOString(), status: 'draft', reason: 'Order created' }],
                producedQty: 0
            };

            if (!appState.activeProduction) appState.activeProduction = [];
            appState.activeProduction.push(newBatch);
            saveState();
            renderProductionWIPView();
            showAlert(`Batch ${batchNo} created as Draft.Click 'Start Production' to reserve stock.`);
        };


        window.startBatch = function (batchId) {
            const batch = appState.activeProduction.find(b => b.id == batchId);
            if (!batch) return;

            // 1. SHORTAGE CHECK
            const missing = [];
            let forceStart = false;

            const checkAvailability = (list, cat) => {
                if (!list) return;
                list.forEach(req => {
                    const item = findItem(cat, req.itemId);
                    if (item) {
                        const stock = calculateStock(item, cat, getToday());
                        const reserved = getReservedStock(item, cat); // This gets reserved from OTHER started batches
                        const available = stock.closingStock - reserved;

                        // Check if we have enough
                        if (available < req.quantity) {
                            missing.push(`• ${item.name} (${cat === 'rawMaterials' ? 'Raw' : cat === 'packingMaterials' ? 'Pkg' : 'Lbl'}): Need ${req.quantity.toFixed(2)}, Available ${available.toFixed(2)} ${item.unit} `);
                        }
                    }
                });
            };

            if (batch.reservedData) {
                checkAvailability(batch.reservedData.rawMaterials, 'rawMaterials');
                checkAvailability(batch.reservedData.packingMaterials, 'packingMaterials');
                checkAvailability(batch.reservedData.labels, 'labels');
            }

            if (missing.length > 0) {
                // Show Alert but allow override
                if (!confirm(`⚠️ SHORTAGE ALERT! ⚠️\n\nThe following items have insufficient Available Stock: \n\n${missing.join('\n')} \n\nDo you want to FORCE START this production anyway ? (Available stock will become negative)`)) {
                    return;
                }
                forceStart = true;
            }

            // 2. Start (Reserve)
            batch.status = 'started';
            if (forceStart) batch.shortageOverride = true;

            // Update status history
            if (!batch.statusHistory) batch.statusHistory = [];
            batch.statusHistory.push({ date: new Date().toISOString(), status: 'started', reason: forceStart ? 'Production started (shortage override)' : 'Production started' });

            // AUDIT LOGGING: Log reservation transactions
            const date = new Date().toISOString();
            const logReserve = (list, cat) => {
                (list || []).forEach(item => {
                    appState.transactions.push({
                        id: Date.now() + Math.random(),
                        itemId: item.itemId,
                        category: cat,
                        type: 'production-reserve', // NEW TYPE
                        quantity: item.quantity,
                        date: date,
                        batchNo: batch.batchNo,
                        notes: "WIP Reservation"
                    });
                });
            };
            logReserve(batch.reservedData.rawMaterials, 'rawMaterials');
            logReserve(batch.reservedData.packingMaterials, 'packingMaterials');
            logReserve(batch.reservedData.labels, 'labels');

            saveState();
            renderProductionWIPView();
            showAlert(`Production Started.Stock has been RESERVED.${forceStart ? ' (Shortage Override Logged)' : ''} `);
        };

        window.cancelBatch = function (batchId) {
            if (!confirm("Are you sure you want to cancel this production? Reserved stock will be released.")) return;
            const batchIndex = appState.activeProduction.findIndex(b => b.id == batchId);
            if (batchIndex > -1) {
                const batch = appState.activeProduction[batchIndex];

                // AUDIT LOGGING: Log release transactions
                const date = new Date().toISOString();
                const logRelease = (list, cat) => {
                    (list || []).forEach(item => {
                        appState.transactions.push({
                            id: Date.now() + Math.random(),
                            itemId: item.itemId,
                            category: cat,
                            type: 'production-release', // NEW TYPE
                            quantity: item.quantity,
                            date: date,
                            batchNo: batch.batchNo,
                            notes: "Reservation Cancelled/Released"
                        });
                    });
                };
                if ((batch.status === 'started' || batch.status === 'paused') && batch.reservedData) {
                    logRelease(batch.reservedData.rawMaterials, 'rawMaterials');
                    logRelease(batch.reservedData.packingMaterials, 'packingMaterials');
                    logRelease(batch.reservedData.labels, 'labels');
                }

                appState.activeProduction.splice(batchIndex, 1);
                saveState();
                renderProductionWIPView();
            }
        };
        window.deleteBatch = window.cancelBatch;

        // ============================================
        // SLIP-BASED WIP TRACKER FUNCTIONS
        // ============================================

        let currentWipSlipMode = 'auto';
        let currentWipBatchData = null;

        // Toggle between Auto and Manual mode in consumption slip modal
        window.setWipSlipMode = function (mode) {
            currentWipSlipMode = mode;
            const autoBtn = document.getElementById('wip-mode-auto');
            const manualBtn = document.getElementById('wip-mode-manual');
            const autoSection = document.getElementById('wip-auto-section');
            const manualSection = document.getElementById('wip-manual-section');

            if (mode === 'auto') {
                autoBtn.classList.add('bg-blue-600', 'text-white');
                autoBtn.classList.remove('bg-gray-300', 'text-gray-700');
                manualBtn.classList.remove('bg-yellow-600', 'text-white');
                manualBtn.classList.add('bg-gray-300', 'text-gray-700');
                autoSection.classList.remove('hidden');
                manualSection.classList.add('hidden');
            } else {
                manualBtn.classList.add('bg-yellow-600', 'text-white');
                manualBtn.classList.remove('bg-gray-300', 'text-gray-700');
                autoBtn.classList.remove('bg-blue-600', 'text-white');
                autoBtn.classList.add('bg-gray-300', 'text-gray-700');
                manualSection.classList.remove('hidden');
                autoSection.classList.add('hidden');
            }
        };

        // Calculate already consumed qty for a material in a batch
        function getConsumedQtyForMaterial(batch, itemId, category) {
            if (!batch.consumptionSlips) return 0;
            let total = 0;
            batch.consumptionSlips.forEach(slip => {
                (slip.items || []).forEach(item => {
                    if (item.itemId == itemId && item.category === category) {
                        total += item.qtyUsed || 0;
                    }
                });
            });
            return total;
        }

        // Open Consumption Slip Modal
        window.openConsumptionSlipModal = function (batchId) {
            const batch = appState.activeProduction?.find(b => b.id == batchId) || appState.productionQueue?.find(b => b.id == batchId);
            if (!batch) return;
            currentWipBatchData = batch;

            const formula = appState.formulas.find(f => f.id == batch.formulaId);

            document.getElementById('wip-slip-batch-id').value = batchId;
            document.getElementById('wip-slip-title').textContent = `📝 Log Consumption Slip - ${batch.batchNo} `;
            document.getElementById('wip-auto-target').value = `${batch.targetQty} (Produced: ${batch.producedQty || 0
                })`;
            document.getElementById('wip-auto-units').value = '';
            document.getElementById('wip-slip-date').value = getToday();
            document.getElementById('wip-slip-notes').value = '';
            document.getElementById('wip-slip-type').value = 'regular';
            document.getElementById('wip-auto-preview').classList.add('hidden');

            // Populate Manual Mode table
            const tbody = document.getElementById('wip-manual-rows');
            tbody.innerHTML = '';

            const addMaterialRow = (itemId, reserved, category) => {
                const item = findItem(category, itemId);
                if (!item) return;
                const consumed = getConsumedQtyForMaterial(batch, itemId, category);
                const remaining = reserved - consumed;
                tbody.innerHTML += `
            < tr class="border-b" >
                        <td class="p-2">${item.name} <span class="text-xs text-gray-400">(${category === 'rawMaterials' ? 'Raw' : category === 'packingMaterials' ? 'Pkg' : 'Lbl'})</span></td>
                        <td class="p-2 text-right">${reserved.toFixed(3)} ${item.unit}</td>
                        <td class="p-2 text-right">${consumed.toFixed(3)}</td>
                        <td class="p-2 text-right font-bold ${remaining < 0.01 ? 'text-green-600' : ''}">${remaining.toFixed(3)}</td>
                        <td class="p-2"><input type="number" step="0.001" class="wip-manual-input w-full p-1 border rounded text-right" data-item-id="${itemId}" data-category="${category}" placeholder="0"></td>
                    </tr >
            `;
            };

            if (batch.reservedData) {
                (batch.reservedData.rawMaterials || []).forEach(r => addMaterialRow(r.itemId, r.quantity, 'rawMaterials'));
                (batch.reservedData.packingMaterials || []).forEach(r => addMaterialRow(r.itemId, r.quantity, 'packingMaterials'));
                (batch.reservedData.labels || []).forEach(r => addMaterialRow(r.itemId, r.quantity, 'labels'));
            }

            setWipSlipMode('auto');
            openModal('wipConsumptionModal');
        };

        // Preview auto consumption calculation
        window.previewAutoConsumption = function () {
            const units = parseFloat(document.getElementById('wip-auto-units').value) || 0;
            const previewDiv = document.getElementById('wip-auto-preview');
            const previewList = document.getElementById('wip-auto-preview-list');

            if (units <= 0 || !currentWipBatchData) {
                previewDiv.classList.add('hidden');
                return;
            }

            const batch = currentWipBatchData;
            const formula = appState.formulas.find(f => f.id == batch.formulaId);
            if (!formula) return;

            const scalingFactor = units / formula.outputQty;
            let previewHtml = '<ul class="list-disc pl-5">';

            formula.ingredients.forEach(ing => {
                const item = findItem(ing.category, ing.itemId);
                if (item) {
                    const qty = ing.quantity * scalingFactor;
                    previewHtml += `< li > ${item.name}: ${qty.toFixed(3)} ${item.unit}</li > `;
                }
            });

            (formula.packingMaterials || []).forEach(pm => {
                const item = findItem('packingMaterials', pm.itemId);
                if (item) {
                    const qty = pm.quantity * scalingFactor;
                    previewHtml += `< li > ${item.name}: ${qty.toFixed(3)} ${item.unit}</li > `;
                }
            });

            (formula.labels || []).forEach(lb => {
                const item = findItem('labels', lb.itemId);
                if (item) {
                    const qty = lb.quantity * scalingFactor;
                    previewHtml += `< li > ${item.name}: ${qty.toFixed(3)} ${item.unit}</li > `;
                }
            });

            previewHtml += '</ul>';
            previewList.innerHTML = previewHtml;
            previewDiv.classList.remove('hidden');
        };

        // Save Consumption Slip
        window.saveConsumptionSlip = function () {
            const batchId = document.getElementById('wip-slip-batch-id').value;
            const batch = appState.activeProduction?.find(b => b.id == batchId) || appState.productionQueue?.find(b => b.id == batchId);
            if (!batch) { showAlert('Batch not found'); return; }

            const slipDate = document.getElementById('wip-slip-date').value;
            const slipType = document.getElementById('wip-slip-type').value;
            const notes = document.getElementById('wip-slip-notes').value;

            const slip = {
                slipId: 'SLIP-' + Date.now(),
                date: slipDate + 'T' + new Date().toTimeString().slice(0, 8) + '.000Z',
                type: slipType,
                mode: currentWipSlipMode,
                items: [],
                enteredBy: currentUserName || currentUserRole,
                notes: notes,
                unitsProduced: 0
            };

            const formula = appState.formulas.find(f => f.id == batch.formulaId);

            if (currentWipSlipMode === 'auto') {
                const units = parseFloat(document.getElementById('wip-auto-units').value) || 0;
                if (units <= 0) { showAlert('Please enter units produced'); return; }

                slip.unitsProduced = units;
                const scalingFactor = units / formula.outputQty;

                formula.ingredients.forEach(ing => {
                    slip.items.push({
                        itemId: ing.itemId,
                        category: ing.category || 'rawMaterials',
                        qtyUsed: ing.quantity * scalingFactor
                    });
                });

                (formula.packingMaterials || []).forEach(pm => {
                    slip.items.push({
                        itemId: pm.itemId,
                        category: 'packingMaterials',
                        qtyUsed: pm.quantity * scalingFactor
                    });
                });

                (formula.labels || []).forEach(lb => {
                    slip.items.push({
                        itemId: lb.itemId,
                        category: 'labels',
                        qtyUsed: lb.quantity * scalingFactor
                    });
                });

                batch.producedQty = (batch.producedQty || 0) + units;

            } else {
                // Manual mode
                document.querySelectorAll('.wip-manual-input').forEach(input => {
                    const qty = parseFloat(input.value) || 0;
                    if (qty > 0) {
                        slip.items.push({
                            itemId: parseFloat(input.dataset.itemId),
                            category: input.dataset.category,
                            qtyUsed: qty
                        });
                    }
                });

                if (slip.items.length === 0) { showAlert('Please enter at least one material quantity'); return; }
            }

            // Add slip to batch
            if (!batch.consumptionSlips) batch.consumptionSlips = [];
            batch.consumptionSlips.push(slip);

            // Create actual consumption transactions
            const txDate = new Date().toISOString();
            slip.items.forEach(item => {
                appState.transactions.push({
                    id: Date.now() + Math.random(),
                    itemId: item.itemId,
                    category: item.category,
                    type: 'wip-consume',
                    quantity: item.qtyUsed,
                    date: txDate,
                    batchNo: batch.batchNo,
                    slipId: slip.slipId,
                    notes: `WIP Slip: ${slipType} `
                });
            });

            saveState();
            closeModal('wipConsumptionModal');
            renderProductionWIPView();
            showAlert(`Consumption Slip ${slip.slipId} saved successfully!`);
        };

        // Open Pause Production Modal
        window.openPauseModal = function (batchId) {
            document.getElementById('wip-pause-batch-id').value = batchId;
            document.querySelectorAll('input[name="pause-reason"]').forEach(r => r.checked = false);
            document.getElementById('wip-pause-resume-date').value = '';
            document.getElementById('wip-pause-notes').value = '';
            openModal('wipPauseModal');
        };

        // Confirm Pause Production
        window.confirmPauseProduction = function () {
            const batchId = document.getElementById('wip-pause-batch-id').value;
            const batch = appState.activeProduction?.find(b => b.id == batchId) || appState.productionQueue?.find(b => b.id == batchId);
            if (!batch) return;

            const reasonRadio = document.querySelector('input[name="pause-reason"]:checked');
            if (!reasonRadio) { showAlert('Please select a reason for pause'); return; }

            const reason = reasonRadio.value;
            const resumeDate = document.getElementById('wip-pause-resume-date').value;
            const notes = document.getElementById('wip-pause-notes').value;

            batch.status = 'paused';
            batch.pausedDate = new Date().toISOString();
            batch.pauseReason = reason;
            batch.expectedResumeDate = resumeDate || null;

            if (!batch.statusHistory) batch.statusHistory = [];
            batch.statusHistory.push({
                date: new Date().toISOString(),
                status: 'paused',
                reason: reason + (notes ? ` - ${notes} ` : '')
            });

            saveState();
            closeModal('wipPauseModal');
            renderProductionWIPView();
            showAlert(`Production PAUSED.Reason: ${reason} `);
        };

        // Resume Production
        window.resumeProduction = function (batchId) {
            const batch = appState.activeProduction?.find(b => b.id == batchId) || appState.productionQueue?.find(b => b.id == batchId);
            if (!batch) return;

            batch.status = 'started';
            batch.pausedDate = null;
            batch.pauseReason = null;

            if (!batch.statusHistory) batch.statusHistory = [];
            batch.statusHistory.push({
                date: new Date().toISOString(),
                status: 'started',
                reason: 'Production resumed'
            });

            saveState();
            renderProductionWIPView();
            showAlert('Production RESUMED!');
        };


        // Toggle Pause/Resume for a batch (wrapper for button compatibility)
        window.togglePauseBatch = function (idxOrId) {
            // Check if this is an index into productionQueue or an actual id
            let batch = null;

            // Try as direct ID first
            batch = appState.activeProduction?.find(b => b.id == idxOrId) || appState.productionQueue?.find(b => b.id == idxOrId);

            // If not found, try as array index
            if (!batch && !isNaN(parseInt(idxOrId))) {
                const idx = parseInt(idxOrId);
                batch = (appState.productionQueue && appState.productionQueue[idx]) || (appState.activeProduction && appState.activeProduction[idx]);
            }

            if (!batch) {
                alert(`DEBUG: togglePauseBatch could not find batch for: ${idxOrId}`);
                return;
            }

            // If currently paused, resume. Otherwise, open pause modal (or simple pause).
            if (batch.status === 'paused' || batch.status === 'Paused') {
                // Resume
                batch.status = 'started';
                batch.pausedDate = null;
                batch.pauseReason = null;
                if (!batch.statusHistory) batch.statusHistory = [];
                batch.statusHistory.push({ date: new Date().toISOString(), status: 'started', reason: 'Production resumed' });
                saveState();
                renderProductionWIPView();
                showAlert('Production RESUMED!');
            } else {
                // Pause (simple version - could open modal if wipPauseModal exists)
                if (document.getElementById('wipPauseModal')) {
                    window.openPauseModal ? openPauseModal(batch.id) : simplePause();
                } else {
                    simplePause();
                }

                function simplePause() {
                    batch.status = 'paused';
                    batch.pausedDate = new Date().toISOString();
                    batch.pauseReason = 'Manually paused';
                    if (!batch.statusHistory) batch.statusHistory = [];
                    batch.statusHistory.push({ date: new Date().toISOString(), status: 'paused', reason: 'Manually paused' });
                    saveState();
                    renderProductionWIPView();
                    showAlert('Production PAUSED.');
                }
            }
        };

        // Cancel Production
        window.cancelBatch = function (batchId) {
            alert('DEBUG: cancelBatch clicked! ID=' + batchId);
            console.log("Cancelling Batch ID:", batchId);
            // Support both data structures
            const batch = appState.activeProduction?.find(b => b.id == batchId) || appState.productionQueue?.find(b => b.id == batchId);

            if (!batch) {
                alert(`DEBUG ERROR: Cancel failed. Batch ID ${batchId} not found.`);
                return;
            }

            if (!confirm(`Are you sure you want to CANCEL Batch ${batch.batchNo || batch.batchNumber}? \nThis will release all reserved stock.`)) return;

            const date = new Date().toISOString();

            // 1. Release Reservations
            const logRelease = (list, cat) => {
                (list || []).forEach(item => {
                    appState.transactions.push({
                        id: Date.now() + Math.random(),
                        itemId: item.itemId,
                        category: cat,
                        type: 'production-release',
                        quantity: item.quantity,
                        date: date,
                        batchNo: batch.batchNo || batch.batchNumber,
                        notes: "Batch Cancelled - Reservation Released"
                    });
                });
            };

            if (batch.reservedData) {
                logRelease(batch.reservedData.rawMaterials, 'rawMaterials');
                logRelease(batch.reservedData.packingMaterials, 'packingMaterials');
                logRelease(batch.reservedData.labels, 'labels');
            }

            // 2. Archive
            batch.status = 'cancelled';
            batch.cancelledDate = date;

            if (!appState.productionHistory) appState.productionHistory = [];
            appState.productionHistory.push(batch);

            // 3. Remove
            appState.activeProduction = appState.activeProduction.filter(b => b.id != batchId);
            saveState();
            renderProductionWIPView();
            showAlert(`Batch ${batch.batchNo || batch.batchNumber} Cancelled & Moved to History.`);
        };


        // --- MISSING FEATURE: BATCH BOM / RESERVED MATERIALS MODAL ---
        window.openBatchBOMModal = function (batchId) {
            alert('DEBUG: openBatchBOMModal clicked! ID=' + batchId);
            console.log("Opening BOM for ID:", batchId);
            // Support both data structures
            const batch = appState.activeProduction?.find(b => b.id == batchId) || appState.productionQueue?.find(b => b.id == batchId);

            if (!batch) {
                alert(`DEBUG ERROR: Batch ID ${batchId} not found in Active Production or Queue!`);
                console.error("Batch not found", appState.activeProduction, appState.productionQueue);
                return;
            }

            // Check Data
            if (!batch.reservedData) {
                alert(`DEBUG WARN: Batch ${batch.batchNo} has NO reserved data linked. formulaId: ${batch.formulaId}`);
            }

            currentWipBatchData = batch; // Re-use this global

            // 1. Populate Header
            const formula = appState.formulas.find(f => f.id == batch.formulaId);
            const formulaName = formula ? formula.name : "Unknown Product";

            document.getElementById('bom-modal-title').textContent = `Manage Reserved Materials - ${batch.batchNo || batch.batchNumber}`;
            document.getElementById('bom-modal-subtitle').textContent = `Product: ${formulaName}`;

            // 2. Populate List
            renderBomList(batch);

            // 3. Populate Add Dropdowns
            updateBomItemSelect();

            openModal('viewBatchBOMModal');
        };

        window.renderBomList = function (batch) {
            const tbody = document.getElementById('bom-list-rows');
            if (!tbody) return;
            tbody.innerHTML = '';

            const addRows = (list, cat) => {
                if (!list) return;
                list.forEach((entry, idx) => {
                    const item = findItem(cat, entry.itemId);
                    const name = item ? item.name : 'Unknown Item';
                    const unit = item ? item.unit : '';

                    tbody.innerHTML += `
                        <tr class="border-b">
                            <td class="p-2 text-left">${name} <span class="text-xs text-gray-400">(${cat})</span></td>
                            <td class="p-2 text-center text-xs uppercase">${cat === 'rawMaterials' ? 'Raw' : (cat === 'packingMaterials' ? 'Pkg' : 'Lbl')}</td>
                            <td class="p-2 text-right font-bold">${entry.quantity} ${unit}</td>
                            <td class="p-2 text-center">
                                <button onclick="removeBatchMaterial(${batch.id}, '${cat}', ${idx})" class="text-red-500 hover:text-red-700 font-bold">&times;</button>
                            </td>
                        </tr>
                      `;
                });
            };

            if (batch.reservedData) {
                addRows(batch.reservedData.rawMaterials, 'rawMaterials');
                addRows(batch.reservedData.packingMaterials, 'packingMaterials');
                addRows(batch.reservedData.labels, 'labels');
            }
        };

        window.updateBomItemSelect = function () {
            const cat = document.getElementById('bom-add-cat').value;
            const sel = document.getElementById('bom-add-item');
            sel.innerHTML = '<option value="">Select Item</option>';

            if (appState.inventory[cat]) {
                appState.inventory[cat].forEach(item => {
                    const opt = document.createElement('option');
                    opt.value = item.id;
                    opt.text = item.name + ` (Stock: ${item.closingStock})`;
                    sel.appendChild(opt);
                });
            }
        };

        window.addBatchMaterial = function () {
            if (!currentWipBatchData) return;
            const cat = document.getElementById('bom-add-cat').value;
            const itemId = document.getElementById('bom-add-item').value;
            const qty = parseFloat(document.getElementById('bom-add-qty').value);

            if (!itemId || !qty || qty <= 0) { alert("Please select item and valid quantity."); return; }

            // 1. Check Stock
            const item = findItem(cat, itemId);
            if (item.closingStock < qty) {
                if (!confirm(`Warning: Stock (${item.closingStock}) is less than requested (${qty}). Proceed anyway?`)) return;
            }

            // 2. Add to batch.reservedData
            if (!currentWipBatchData.reservedData) currentWipBatchData.reservedData = {};
            if (!currentWipBatchData.reservedData[cat]) currentWipBatchData.reservedData[cat] = [];

            // Check if already exists? Merge or Add? Let's add new entry for simplicity
            currentWipBatchData.reservedData[cat].push({
                itemId: itemId,
                quantity: qty
            });

            // 3. Deduct Stock immediately? Or is it just "Reserved"?
            // Standard logic: Deduct Closing, Add to Reserved.
            // Here we just mark it as reserved in structure. The "Complete" logic will handle actual deduction logic if it looks at reserved data.
            // BUT: The main "Start Batch" logic deducts stock. So we should probably deduct strictly here too to match.

            // STRICT DEDUCTION:
            // item.closingStock -= qty;
            // But let's keeping it simple: Just add to list. 
            // EDIT: User wants robust "Reserved" management. We should simulate reservation transaction.

            // Create Transaction
            appState.transactions.push({
                id: Date.now(),
                date: new Date().toISOString(),
                type: 'production-reserve',
                category: cat,
                itemId: itemId,
                quantity: qty,
                itemName: item.name,
                batchNo: currentWipBatchData.batchNo,
                details: "Manual Addition to Batch Reservation"
            });

            // Update Stock (In-Memory for now, relies on Recalculate usually, but let's be safe)
            // calculateStock function usually handles this based on tx history. 

            saveState();
            renderBomList(currentWipBatchData);
            renderProductionWIPView(); // Update main card count
            document.getElementById('bom-add-qty').value = '';
            showAlert("Material Added to Reservation.");
        };

        window.removeBatchMaterial = function (batchId, cat, idx) {
            const batch = appState.activeProduction.find(b => b.id == batchId);
            if (!batch) return;

            // Allow removal
            if (confirm("Remove this reserved item? This will release the stock.")) {
                const entry = batch.reservedData[cat][idx];

                // Release Tx
                appState.transactions.push({
                    id: Date.now(),
                    date: new Date().toISOString(),
                    type: 'production-release',
                    category: cat,
                    itemId: entry.itemId,
                    quantity: entry.quantity, // Release original reserved qty
                    batchNo: batch.batchNo,
                    details: "Manual Removal from Batch Reservation"
                });

                batch.reservedData[cat].splice(idx, 1);
                saveState();
                renderBomList(batch);
                renderProductionWIPView();
            }
        };

        // --- PARTIAL / SMART COMPLETION ---
        // DUPLICATE REMOVED - Using version at end of file
        // let currentCompletingBatchId = null;

        window.completeBatch_OLD = function (batchId) {
            alert('DEBUG: completeBatch clicked! ID=' + batchId);
            // Replaces old direct completion. Now opens modal.
            const batch = appState.activeProduction?.find(b => b.id == batchId) || appState.productionQueue?.find(b => b.id == batchId);
            if (!batch) {
                alert('DEBUG ERROR: completeBatch - batch not found for ID: ' + batchId);
                return;
            }
            currentCompletingBatchId = batchId;

            // Populate Modal
            const formula = appState.formulas.find(f => f.id == batch.formulaId);
            const formulaName = formula ? formula.name : "Unknown Product";

            document.getElementById('comp-batch-title').textContent = `Complete Production: ${batch.batchNo || batch.batchNumber} `;
            document.getElementById('comp-prod-name').textContent = formulaName;

            // Target vs Actual Produce
            document.getElementById('comp-target-qty').value = batch.targetQty;
            document.getElementById('comp-actual-qty').value = batch.targetQty; // Default to target

            // Ingredients Table
            const tbody = document.getElementById('comp-ing-rows');
            tbody.innerHTML = '';

            const addRow = (itemData, cat) => {
                const item = findItem(cat, itemData.itemId);
                if (!item) return;
                tbody.innerHTML += `
                    <tr class="border-b" data-cat="${cat}" data-id="${item.id}">
                        <td class="p-2 text-sm">${item.name} <span class="text-xs text-gray-400">(${cat === 'rawMaterials' ? 'RM' : 'PM'})</span></td>
                        <td class="p-2 text-right text-sm text-gray-500">${itemData.quantity.toFixed(3)}</td>
                        <td class="p-2"><input type="number" step="any" value="${itemData.quantity}" class="comp-consume-input w-full p-1 border rounded text-right bg-blue-50"></td>
                        <td class="p-2"><input type="number" step="any" value="0" class="comp-waste-input w-full p-1 border rounded text-right text-gray-400 placeholder-gray-300" placeholder="0"></td>
                    </tr>
                `;
            };

            if (batch.reservedData) {
                (batch.reservedData.rawMaterials || []).forEach(i => addRow(i, 'rawMaterials'));
                (batch.reservedData.packingMaterials || []).forEach(i => addRow(i, 'packingMaterials'));
                (batch.reservedData.labels || []).forEach(i => addRow(i, 'labels'));
            }

            openModal('completeBatchModal');
        };

        window.confirmCompleteBatch_OLD = function () {
            if (!currentCompletingBatchId) return;
            const batch = appState.activeProduction?.find(b => b.id == currentCompletingBatchId) || appState.productionQueue?.find(b => b.id == currentCompletingBatchId);
            if (!batch) return;

            const actualProduceQty = parseFloat(document.getElementById('comp-actual-qty').value) || 0;
            const expiryDate = document.getElementById('comp-expiry-date')?.value;

            if (actualProduceQty <= 0) { showAlert("Produced Quantity must be greater than 0"); return; }

            // Collect Consumed Data
            const rows = document.querySelectorAll('#comp-ing-rows tr');
            const actualConsumptions = [];

            rows.forEach(row => {
                const cat = row.dataset.cat;
                const itemId = parseFloat(row.dataset.id);
                const consumedQty = parseFloat(row.querySelector('.comp-consume-input').value) || 0;
                const wasteQty = parseFloat(row.querySelector('.comp-waste-input').value) || 0;

                if (consumedQty > 0 || wasteQty > 0) {
                    actualConsumptions.push({ cat, itemId, qty: consumedQty, waste: wasteQty });
                }
            });

            // Execute Transactions
            const date = new Date().toISOString();
            const batchNo = batch.batchNo || batch.batchNumber;

            // 1. Release Reservations (Close Audit Loop)
            const logRelease = (list, cat) => {
                (list || []).forEach(item => {
                    appState.transactions.push({
                        id: Date.now() + Math.random(),
                        itemId: item.itemId,
                        category: cat,
                        type: 'production-release',
                        quantity: item.quantity,
                        date: date,
                        batchNo: batchNo,
                        notes: "Reservation Converted to Consumption"
                    });
                });
            };
            if ((batch.status === 'started' || batch.status === 'In Progress') && batch.reservedData) {
                logRelease(batch.reservedData.rawMaterials, 'rawMaterials');
                logRelease(batch.reservedData.packingMaterials, 'packingMaterials');
                logRelease(batch.reservedData.labels, 'labels');
            }

            // 2. Consumptions (Actuals)
            actualConsumptions.forEach(c => {
                appState.transactions.push({
                    id: Date.now() + Math.random(),
                    itemId: c.itemId,
                    category: c.cat,
                    type: 'production-consume',
                    quantity: c.qty,
                    date: date,
                    batchNo: batchNo,
                    subtype: c.waste > 0 ? 'includes-wastage' : 'standard',
                    notes: `Used for Production (Batch ${batchNo})${c.waste > 0 ? ' [Waste: ' + c.waste + ']' : ''} `
                });
            });

            // 3. Production Add (Finished Good)
            const formula = appState.formulas.find(f => f.id == batch.formulaId);
            if (formula) {
                const fgItem = appState.inventory.finishedGoods.find(i => i.name === formula.name);
                if (fgItem) {
                    appState.transactions.push({
                        id: Date.now() + Math.random(),
                        itemId: fgItem.id,
                        category: 'finishedGoods',
                        type: 'production-add',
                        quantity: actualProduceQty,
                        date: date,
                        batchNo: batchNo,
                        mfgDate: date,
                        expiryDate: expiryDate
                    });
                } else {
                    showAlert("Warning: FG Item not found for " + formula.name);
                }
            }

            // 4. Close & Cleanup
            appState.activeProduction = (appState.activeProduction || []).filter(b => b.id != currentCompletingBatchId);
            appState.productionQueue = (appState.productionQueue || []).filter(b => b.id != currentCompletingBatchId);
            saveState();
            closeModal('completeBatchModal');
            renderProductionWIPView();
            showAlert(`Batch ${batchNo} Completed.\nProduced: ${actualProduceQty} \nStock Consumed, Reservation Released & FG Added.`);
        };

        // Open Order Detail Modal
        window.openWipDetailModal = function (batchId) {
            const batch = appState.activeProduction.find(b => b.id == batchId);
            if (!batch) return;

            const formula = appState.formulas.find(f => f.id == batch.formulaId);
            const formulaName = formula ? formula.name : 'Unknown Product';

            document.getElementById('wip-detail-batch-id').value = batchId;
            document.getElementById('wip-detail-title').textContent = `📋 Order Details: ${batch.batchNo} `;

            // Summary
            const daysActive = batch.startDate ? Math.floor((new Date() - new Date(batch.startDate)) / (1000 * 60 * 60 * 24)) : 0;
            const statusColors = {
                'draft': 'bg-gray-100 text-gray-800',
                'started': 'bg-blue-100 text-blue-800',
                'paused': 'bg-yellow-100 text-yellow-800',
                'completed': 'bg-green-100 text-green-800'
            };

            document.getElementById('wip-detail-summary').innerHTML = `
            < div ><p class="text-gray-500 text-sm">Product</p><p class="font-bold">${formulaName}</p></div >
                <div><p class="text-gray-500 text-sm">Target Qty</p><p class="font-bold">${batch.targetQty}</p></div>
                <div><p class="text-gray-500 text-sm">Produced</p><p class="font-bold text-green-600">${batch.producedQty || 0}</p></div>
                <div><p class="text-gray-500 text-sm">Status</p><span class="px-2 py-1 rounded text-xs font-bold ${statusColors[batch.status] || ''}">${batch.status.toUpperCase()}</span></div>
                <div><p class="text-gray-500 text-sm">Started</p><p>${new Date(batch.startDate).toLocaleDateString()}</p></div>
                <div><p class="text-gray-500 text-sm">Days Active</p><p>${daysActive} days</p></div>
                <div><p class="text-gray-500 text-sm">Slips</p><p>${(batch.consumptionSlips || []).length}</p></div>
                ${batch.status === 'paused' ? `<div><p class="text-gray-500 text-sm">Pause Reason</p><p class="text-yellow-600">${batch.pauseReason || '-'}</p></div>` : ''}
        `;

            // Material Progress
            const materialsBody = document.getElementById('wip-detail-materials');
            materialsBody.innerHTML = '';
            let totalReserved = 0, totalConsumed = 0;

            const addMaterialProgress = (itemId, reserved, category) => {
                const item = findItem(category, itemId);
                if (!item) return;
                const consumed = getConsumedQtyForMaterial(batch, itemId, category);
                const remaining = reserved - consumed;
                const progress = reserved > 0 ? Math.min(100, (consumed / reserved) * 100) : 0;
                totalReserved += reserved;
                totalConsumed += consumed;

                materialsBody.innerHTML += `
            < tr class="border-b" >
                        <td class="p-2 border">${item.name}</td>
                        <td class="p-2 text-right border">${reserved.toFixed(3)} ${item.unit}</td>
                        <td class="p-2 text-right border">${consumed.toFixed(3)}</td>
                        <td class="p-2 text-right border font-bold ${remaining < 0.01 ? 'text-green-600' : 'text-orange-600'}">${remaining.toFixed(3)}</td>
                        <td class="p-2 border">
                            <div class="w-full bg-gray-200 rounded h-4">
                                <div class="bg-blue-500 h-4 rounded" style="width: ${progress}%"></div>
                            </div>
                        </td>
                    </tr >
            `;
            };

            if (batch.reservedData) {
                (batch.reservedData.rawMaterials || []).forEach(r => addMaterialProgress(r.itemId, r.quantity, 'rawMaterials'));
                (batch.reservedData.packingMaterials || []).forEach(r => addMaterialProgress(r.itemId, r.quantity, 'packingMaterials'));
                (batch.reservedData.labels || []).forEach(r => addMaterialProgress(r.itemId, r.quantity, 'labels'));
            }

            const overallProgress = totalReserved > 0 ? ((totalConsumed / totalReserved) * 100).toFixed(1) : 0;
            document.getElementById('wip-detail-progress-percent').textContent = `(${overallProgress} % consumed)`;

            // Consumption Slips
            const slipsDiv = document.getElementById('wip-detail-slips');
            if (!batch.consumptionSlips || batch.consumptionSlips.length === 0) {
                slipsDiv.innerHTML = '<p class="text-gray-400 italic">No consumption slips logged yet.</p>';
            } else {
                slipsDiv.innerHTML = batch.consumptionSlips.map(slip => {
                    const itemSummary = slip.items.map(i => {
                        const item = findItem(i.category, i.itemId);
                        return item ? `${item.name}: ${i.qtyUsed.toFixed(2)} ` : '';
                    }).filter(x => x).join(', ');

                    return `
            < div class="p-2 bg-gray-50 rounded border flex justify-between items-center" >
                            <div>
                                <span class="font-mono text-sm font-bold">${slip.slipId}</span>
                                <span class="text-gray-500 text-xs ml-2">${new Date(slip.date).toLocaleString()}</span>
                                <span class="ml-2 px-1 py-0.5 rounded text-xs ${slip.type === 'wastage' ? 'bg-red-100 text-red-600' : slip.type === 'adjustment' ? 'bg-purple-100 text-purple-600' : 'bg-green-100 text-green-600'}">${slip.type}</span>
                                ${slip.unitsProduced ? `<span class="ml-2 text-xs text-blue-600">(+${slip.unitsProduced} units)</span>` : ''}
                            </div>
                            <div class="text-xs text-gray-500 max-w-xs truncate">${itemSummary}</div>
                        </div >
            `;
                }).join('');
            }

            // Status History
            const historyDiv = document.getElementById('wip-detail-history');
            if (!batch.statusHistory || batch.statusHistory.length === 0) {
                historyDiv.innerHTML = '<p class="text-gray-400 italic">No history.</p>';
            } else {
                historyDiv.innerHTML = batch.statusHistory.map(h => {
                    const statusIcon = h.status === 'started' ? '▶️' : h.status === 'paused' ? '⏸️' : h.status === 'completed' ? '✅' : '📝';
                    return `< p > ${statusIcon} <span class="text-gray-500">${new Date(h.date).toLocaleString()}</span> - <span class="font-semibold">${h.status.toUpperCase()}</span> ${h.reason ? `(${h.reason})` : ''}</p > `;
                }).join('');
            }

            // Actions
            const actionsDiv = document.getElementById('wip-detail-actions');
            let actionsHtml = '';

            if (batch.status === 'started' || batch.status === 'paused') {
                actionsHtml += `< button onclick = "openConsumptionSlipModal(${batch.id})" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700" >📝 Log Consumption</button > `;
            }

            if (batch.status === 'started') {
                actionsHtml += `< button onclick = "closeModal('wipDetailModal'); openPauseModal(${batch.id})" class="px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600" >⏸️ Pause</button > `;
                actionsHtml += `< button onclick = "closeModal('wipDetailModal'); completeBatch(${batch.id})" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700" >✅ Complete</button > `;
            }

            if (batch.status === 'paused') {
                actionsHtml += `< button onclick = "closeModal('wipDetailModal'); resumeProduction(${batch.id})" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600" >▶️ Resume</button > `;
            }

            actionsHtml += `< button onclick = "closeModal('wipDetailModal')" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400" > Close</button > `;
            actionsDiv.innerHTML = actionsHtml;

            openModal('wipDetailModal');
        };

        // Calculate days since pause
        function getDaysSincePause(batch) {
            if (!batch.pausedDate) return 0;
            return Math.floor((new Date() - new Date(batch.pausedDate)) / (1000 * 60 * 60 * 24));
        }


        window.exportProductionHistory = function () {
            if (!window.XLSX) { alert("XLSX lib not loaded"); return; }
            if (!appState.productionHistory || appState.productionHistory.length === 0) {
                alert("No completed production history available related to the newly implemented system. (Old completed batches may not be tracked yet).");
                return;
            }

            const data = appState.productionHistory.map(b => {
                const formula = appState.formulas.find(f => f.id == b.formulaId);
                const prodName = formula ? formula.name : 'Unknown';

                // Ingredients Summary
                let ingSummary = "";
                if (b.actualConsumptions) {
                    b.actualConsumptions.forEach(c => {
                        const item = findItem(c.cat, c.itemId);
                        const name = item ? item.name : 'ID:' + c.itemId;
                        ingSummary += `${name}: ${c.qty} (Waste: ${c.waste}); `;
                    });
                }

                return {
                    'Batch No': b.batchNo,
                    'Product': prodName,
                    'Start Date': new Date(b.startDate).toLocaleDateString(),
                    'Completed Date': b.completedDate ? new Date(b.completedDate).toLocaleDateString() : '-',
                    'Target Qty': b.targetQty,
                    'Produced Qty': b.actualProduceQty || 0,
                    'Ingredients Used': ingSummary,
                    'Status': b.status
                };
            });

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, "Production History");
            XLSX.writeFile(wb, `Production_History_${new Date().toISOString().split('T')[0]}.xlsx`);
        };

        // --- UPDATED INVENTORY TABLE RENDER ---
        // --- UPDATED INVENTORY TABLE RENDER (RESTORED FEATURES + ERP COLUMNS) ---
        // --- HELPER: Ensure getToday exists ---
        if (typeof window.getToday !== 'function') {
            window.getToday = function () {
                return new Date().toISOString().split('T')[0];
            };
        }

        // --- NEW FUNCTIONS FOR "OLD APP" RESTORATION ---

        window.renderReorderAssistant = function () {
            showView('reorder-assistant');
        };

        window.openItemNotesModal = function (category, itemId) {
            const item = appState.inventory[category].find(i => i.id == itemId);
            if (!item) return;

            document.getElementById('notes-item-id').value = item.id;
            document.getElementById('notes-item-category').value = category;
            document.getElementById('notes-item-name').textContent = item.name;
            document.getElementById('note-modal-title').textContent = (category === 'finishedGoods') ? 'Batch Notes / Remarks' : 'Item Notes';

            renderNotesList(item);
            openModal('itemNotesModal');
        };

        function renderNotesList(item) {
            const container = document.getElementById('notes-list');
            container.innerHTML = '';
            const notes = item.notes || [];

            if (notes.length === 0) {
                container.innerHTML = '<p class="text-gray-500 italic text-sm">No notes added yet.</p>';
                return;
            }

            notes.forEach((note, index) => {
                const div = document.createElement('div');
                div.className = "bg-gray-50 p-2 rounded mb-2 border border-gray-200 flex justify-between items-start";
                div.innerHTML = `
            < div >
                        <p class="text-sm text-gray-800">${note.text}</p>
                        <p class="text-[10px] text-gray-400 mt-1">${new Date(note.date).toLocaleString()} - ${note.user || 'User'}</p>
                    </div >
            `;
                container.appendChild(div);
            });
        }

        window.addNote = function () {
            const text = document.getElementById('new-note-input').value.trim();
            if (!text) return;

            const itemId = document.getElementById('notes-item-id').value;
            const category = document.getElementById('notes-item-category').value;

            const item = appState.inventory[category].find(i => i.id == itemId);
            if (item) {
                if (!item.notes) item.notes = [];
                item.notes.push({
                    text: text,
                    date: new Date().toISOString(),
                    user: currentUserName || 'Guest'
                });

                // Save locally
                localStorage.setItem('inventoryAppState', JSON.stringify(appState));

                document.getElementById('new-note-input').value = '';
                renderNotesList(item);

                // If cloud on, sync
                if (window.cloudApiUrl) saveToCloud();
            }
        };

        window.calculateItemCost = function (itemId) {
            // Find item first
            const item = appState.inventory.finishedGoods.find(i => i.id == itemId);
            if (!item) {
                showAlert("Error: Item not found.");
                return;
            }

            // Find formula
            const formula = (appState.formulas || []).find(f => f.name === item.name);

            if (!formula) {
                // Fallback to average cost if no formula
                showAlert(`No specific formula found for "${item.name}".\nCurrent Average Cost: ₹${(item.currentAverageCost || 0).toFixed(2)} `);
                return;
            }

            // Redirect to calculator with this formula
            showView('calculator');
            // Allow view to render then load
            setTimeout(() => {
                if (typeof loadFormulaIntoCalc === 'function') {
                    loadFormulaIntoCalc(formula.id);
                } else {
                    console.error("loadFormulaIntoCalc function missing");
                }
            }, 500);
        };

        window.openDispatchModal = function (itemId) {
            // Open Sales/Dispatch Modal directly
            const modal = document.getElementById('dispatchModal');
            if (modal) {
                // Populate Items
                const select = document.getElementById('dispatch-item');
                select.innerHTML = '<option value="">Select Finished Good</option>';
                (appState.inventory.finishedGoods || []).forEach(fg => {
                    const opt = document.createElement('option');
                    opt.value = fg.id;
                    opt.textContent = fg.name;
                    select.appendChild(opt);
                });

                // Populate Customers
                const custSelect = document.getElementById('dispatch-customer');
                custSelect.innerHTML = '<option value="">Select Customer</option>';
                (appState.customers || []).forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.id;
                    opt.textContent = c.name;
                    custSelect.appendChild(opt);
                });

                // Set Default Date
                document.getElementById('dispatch-date').value = getToday();

                // Set Selected Item
                select.value = itemId;

                // Trigger Batch Select if function exists
                if (typeof window.populateDispatchBatchSelect === 'function') {
                    window.populateDispatchBatchSelect();
                } else if (typeof populateDispatchBatchSelect === 'function') {
                    populateDispatchBatchSelect();
                }

                openModal('dispatchModal');
            } else {
                showView('sales-dispatch');
            }
        };

        // --- UPDATED INVENTORY TABLE RENDER (FIXED) ---
        window.renderInventoryView = function (category) {
            // Safety Helper
            const safeFixed = (val, digits = 3) => {
                const num = parseFloat(val);
                return (isNaN(num) ? 0 : num).toFixed(digits);
            };

            try {
                const containerId = category === 'rawMaterials' ? 'raw-materials-view' :
                    category === 'packingMaterials' ? 'packing-materials-view' :
                        category === 'finishedGoods' ? 'finished-goods-view' :
                            category === 'labels' ? 'labels-view' : null;

                const container = document.getElementById(containerId);
                if (!container) {
                    console.error("Container not found for", category);
                    return;
                }

                const titleMap = {
                    rawMaterials: "Raw Materials",
                    packingMaterials: "Packing Materials",
                    labels: "Labels",
                    finishedGoods: "Finished Goods"
                };

                let items = appState.inventory[category] || [];

                // PRESERVE FILTERS STATE
                const existingDateEl = document.getElementById(`${category} -date`);
                const selectedDate = existingDateEl ? existingDateEl.value : getToday();

                const existingSearchEl = document.getElementById(`${category} -search`);
                const searchTerm = (existingSearchEl ? existingSearchEl.value : '').toLowerCase();

                const showOutOfStock = document.getElementById(`${category} -filter - oos`)?.checked || false;
                const showNegative = document.getElementById(`${category} -filter - neg`)?.checked || false;
                const showMinStock = document.getElementById(`${category} -filter - min`)?.checked || false;

                // Filter Process
                const filteredItems = items.filter(i => {
                    if (searchTerm && !i.name.toLowerCase().includes(searchTerm)) return false;
                    return true;
                });

                container.innerHTML = `
            < div class="p-6" >
                        < !--HEADER & BUTTONS-- >
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-3">
                                ${titleMap[category]} Stock Overview
                            </h2>
                            <div class="flex gap-2">
                                 <button onclick="openAddItemModal('${category}')" class="px-4 py-2 bg-green-600 text-white rounded shadow hover:bg-green-700 font-bold uppercase text-sm tracking-wide flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg> 
                                    Add New Item
                                 </button>
                                 <button onclick="renderReorderAssistant()" class="px-4 py-2 bg-purple-600 text-white rounded shadow hover:bg-purple-700 font-bold uppercase text-sm tracking-wide flex items-center gap-2">
                                    Reorder Items
                                 </button>
                            </div>
                        </div>

                        <!--FILTERS BAR-- >
                        <div class="bg-white p-4 rounded-lg shadow mb-6 border border-gray-200">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-1">Select Date:</label>
                                    <input type="date" id="${category}-date" value="${selectedDate}" 
                                        onchange="renderInventoryView('${category}')" 
                                        class="p-2 border rounded shadow-sm font-medium">
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-1">Search Item:</label>
                                    <input type="text" id="${category}-search" value="${searchTerm}" 
                                        oninput="renderInventoryView('${category}')" 
                                        placeholder="Search by name..." 
                                        class="w-full p-2 border rounded shadow-sm">
                                </div>
                            </div>
                            <div class="flex gap-4 text-sm text-gray-700 flex-wrap font-medium">
                                <label class="flex items-center"><input type="checkbox" id="${category}-filter-oos" ${showOutOfStock ? 'checked' : ''} onchange="renderInventoryView('${category}')" class="mr-2"> Show Out of Stock Only</label>
                                <label class="flex items-center"><input type="checkbox" id="${category}-filter-neg" ${showNegative ? 'checked' : ''} onchange="renderInventoryView('${category}')" class="mr-2"> Show Negative Stock Only</label>
                                <label class="flex items-center"><input type="checkbox" id="${category}-filter-min" ${showMinStock ? 'checked' : ''} onchange="renderInventoryView('${category}')" class="mr-2"> Show Below Min Stock Only</label>
                            </div>
                        </div>

                        <!--DATA TABLE-- >
            <div class="bg-white rounded-lg shadow overflow-hidden overflow-x-auto border border-gray-100">
                <table class="min-w-full text-sm text-left text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-100 sticky top-0 shadow-sm z-10 font-bold tracking-wider">
                        <tr>
                            <th class="px-3 py-3 text-center bg-gray-200">S.No</th>
                            <th class="px-3 py-3 w-48 bg-gray-200">Item Name</th>
                            <th class="px-3 py-3 bg-gray-200">Unit</th>
                            <th class="px-3 py-3 text-right bg-gray-200">Price</th>
                            <th class="px-3 py-3 text-right text-blue-900 bg-gray-200">Avg Cost</th>
                            <th class="px-3 py-3 text-center bg-gray-200">Min Stock</th>

                            <th class="px-3 py-3 text-right bg-gray-200">Opening</th>
                            <th class="px-3 py-3 text-right bg-gray-200">Received</th>
                            <th class="px-3 py-3 text-right bg-gray-200">Consumed</th>

                            <th class="px-3 py-3 text-right bg-blue-100 border-l border-blue-200 text-blue-900">Closing (Phy)</th>
                            <th class="px-3 py-3 text-right bg-yellow-100 text-yellow-900 border-l border-yellow-200">Rsrvd (WIP)</th>
                            <th class="px-3 py-3 text-right bg-green-100 text-green-900 border-l border-green-200">Available</th>

                            <th class="px-3 py-3 text-right bg-gray-200">Value</th>
                            <th class="px-3 py-3 text-center bg-gray-200">Notes</th>
                            <th class="px-3 py-3 text-center w-56 bg-gray-200">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredItems.map((item, index) => {
                    // 1. Get Stock Calculation Safely
                    let stockRaw = null;
                    if (typeof calculateStock === 'function') {
                        stockRaw = calculateStock(item, category, selectedDate);
                    }

                    // 2. Normalize Stock Object (FIXED MAPPING)
                    const stock = {
                        openingStock: parseFloat(stockRaw?.openingStock) || 0,
                        received: parseFloat(stockRaw?.received) || 0,
                        consumed: parseFloat(stockRaw?.consumed) || 0,
                        closingStock: parseFloat(stockRaw?.closingStock) || 0
                    };

                    // 3. Get Reserved Stock Safely
                    let reserved = 0;
                    if (typeof getReservedStock === 'function') {
                        reserved = getReservedStock(item, category) || 0;
                    }

                    // 4. Derived Values
                    const available = stock.closingStock - reserved;
                    const valCurrentAvgCost = parseFloat(item.currentAverageCost) || parseFloat(item.price) || 0;
                    const valPrice = parseFloat(item.price) || 0;
                    const valMinStock = parseFloat(item.minStockLevel) || 0;
                    const totalValue = stock.closingStock * valCurrentAvgCost;

                    // Apply Filters
                    if (showOutOfStock && stock.closingStock > 0) return '';
                    if (showNegative && stock.closingStock >= 0) return '';
                    if (showMinStock && available >= valMinStock) return '';

                    const isLow = valMinStock > 0 && available < valMinStock;

                    return `
                                            <tr id="row-${category}-${item.id}" data-item-id="${item.id}" class="bg-white border-b hover:bg-gray-50 transition-colors">
                                                <td class="px-3 py-4 text-center text-gray-400 font-mono text-xs">${index + 1}</td>
                                                <td class="px-3 py-4 font-medium text-gray-900 border-r">
                                                    ${item.name || 'Unknown'}
                                                    ${isLow ? '<br><span class="px-1.5 py-0.5 rounded-full bg-red-100 text-red-800 text-[10px] font-bold uppercase">Low Stock</span>' : ''}
                                                </td>
                                                <td class="px-3 py-4">${item.unit || '-'}</td>
                                                <td class="px-3 py-4 text-right">${safeFixed(valPrice, 2)}</td>
                                                <td class="px-3 py-4 text-right text-blue-700 font-bold">₹${safeFixed(valCurrentAvgCost, 2)}</td>
                                                <td class="px-3 py-4 text-center border-r">
                                                    ${valMinStock}<br>
                                                    <a href="#" onclick="showView('expiry-tracking')" class="text-[10px] text-purple-600 hover:underline">View Batches</a>
                                                </td>
                                                
                                                <td class="px-3 py-4 text-right text-gray-500">${safeFixed(stock.openingStock, 3)}</td>
                                                <td class="px-3 py-4 text-right ${stock.received > 0 ? 'text-green-700 font-bold' : 'text-gray-400'}">${safeFixed(stock.received, 3)}</td>
                                                <td class="px-3 py-4 text-right ${stock.consumed > 0 ? 'text-red-700 font-bold' : 'text-gray-400'}">${safeFixed(stock.consumed, 3)}</td>
                                                
                                                <td class="px-3 py-4 text-right font-bold bg-blue-50 border-l border-blue-100 text-blue-900">${safeFixed(stock.closingStock, 3)}</td>
                                                <td class="px-3 py-4 text-right font-bold text-yellow-700 bg-yellow-50 border-l border-yellow-100">${safeFixed(reserved, 3)}</td>
                                                <td class="px-3 py-4 text-right font-bold ${available < 0 ? 'text-red-600' : 'text-green-700'} bg-green-50 border-l border-green-100">${safeFixed(available, 3)}</td>
                                                
                                                <td class="px-3 py-4 text-right font-mono text-xs">₹${safeFixed(totalValue, 0)}</td>
                                                <td class="px-3 py-4 text-center">
                                                     <button onclick="openItemNotesModal('${category}', ${item.id})" class="text-gray-400 hover:text-blue-600 transition-colors" title="View/Add Notes">
                                                        <svg class="w-5 h-5 mx-auto ${item.notes && item.notes.length > 0 ? 'text-blue-500 fill-current' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                                     </button>
                                                </td>
                                                <td class="px-3 py-4 text-center">
                                                    <div class="flex justify-center flex-wrap gap-1">
                                                        <button onclick="openStockTxModal('${category}', ${item.id}, 'receive')" class="px-2 py-1 bg-green-600 text-white rounded text-xs hover:bg-green-700 shadow-sm font-bold uppercase transition">Receive</button>
                                                        ${category === 'finishedGoods'
                            ? `<button onclick="openDispatchModal(${item.id})" class="px-2 py-1 bg-indigo-600 text-white rounded text-xs hover:bg-indigo-700 shadow-sm font-bold uppercase transition">Dispatch</button>`
                            : `<button onclick="openStockTxModal('${category}', ${item.id}, 'consume')" class="px-2 py-1 bg-red-600 text-white rounded text-xs hover:bg-red-700 shadow-sm font-bold uppercase transition">Consume</button>`
                        }
                                                        
                                                        <button onclick="openItemHistoryModal('${category}', ${item.id})" class="px-2 py-1 bg-gray-800 text-white rounded text-xs hover:bg-gray-900 shadow-sm font-bold uppercase transition" title="History & Undo">History</button>
                                                        <button onclick="openEditItemModal('${category}', ${item.id})" class="px-2 py-1 bg-yellow-500 text-white rounded text-xs hover:bg-yellow-600 shadow-sm font-bold uppercase transition">Edit</button>
                                                        ${category === 'finishedGoods' ? `<button onclick="calculateItemCost(${item.id})" class="mt-1 w-full px-2 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700 shadow-sm font-bold">Fetch Cost</button>` : ''}
                                                    </div>
                                                </td>
                                            </tr>
                                        `;
                }).join('')}
                        ${filteredItems.length === 0 ? '<tr><td colspan="15" class="px-6 py-8 text-center text-gray-500 italic">No items found matching criteria.</td></tr>' : ''}
                    </tbody>
                </table>
            </div>
                    </div >
            `;
                // Focus upkeep
                const newSearchBox = document.getElementById(`${category} -search`);
                if (newSearchBox && searchTerm) {
                    newSearchBox.focus();
                    var val = newSearchBox.value;
                    newSearchBox.value = '';
                    newSearchBox.value = val;
                }
            } catch (err) {
                console.error("Render Error:", err);
                alert("CRITICAL ERROR Rendering View: " + err.message);
            }
        }



    </script>



    <!-- ERP MODALS -->
    <div id="supplierModal" class="modal fixed inset-0 bg-black bg-opacity-50 justify-center items-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h3 class="text-xl font-bold mb-4" id="supplier-modal-title">Add Supplier</h3>
            <form id="supplier-form">
                <input type="hidden" id="supplier-id">
                <div class="mb-2"><label class="text-sm font-bold">Supplier Name</label><input type="text"
                        id="supplier-name" class="w-full p-2 border rounded" required></div>
                <div class="mb-2"><label class="text-sm">Contact Person</label><input type="text" id="supplier-contact"
                        class="w-full p-2 border rounded"></div>
                <div class="mb-2"><label class="text-sm">Phone</label><input type="text" id="supplier-phone"
                        class="w-full p-2 border rounded"></div>
                <div class="mb-2"><label class="text-sm">Email</label><input type="email" id="supplier-email"
                        class="w-full p-2 border rounded"></div>
                <div class="mb-4"><label class="flex items-center"><input type="checkbox" id="supplier-approved"
                            class="mr-2" checked> <span class="text-sm">Approved Supplier</span></label></div>
                <div class="flex justify-end gap-2">
                    <button type="button" onclick="closeModal('supplierModal')"
                        class="px-4 py-2 bg-gray-300 rounded">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">Save Supplier</button>
                </div>
            </form>
        </div>
    </div>

    <div id="customerModal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 justify-center items-center"
        style="z-index: 9999 !important; pointer-events: auto;">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Add/Edit Customer</h3>
                <button onclick="closeModal('customerModal')" class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <form id="customer-form">
                <input type="hidden" id="edit-customer-id">
                <div class="mb-4">
                    <label class="block text-sm font-medium">Customer Name</label>
                    <input type="text" id="customer-name" class="w-full p-2 border rounded-md" required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium">GST Number</label>
                    <input type="text" id="customer-gst" class="w-full p-2 border rounded-md">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium">Location</label>
                    <input type="text" id="customer-location" class="w-full p-2 border rounded-md">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium">Type</label>
                    <select id="customer-type" class="w-full p-2 border rounded-md">
                        <option value="Dealer">Dealer</option>
                        <option value="Farmer">Farmer</option>
                        <option value="Institution">Institution</option>
                        <option value="Demo">Demo</option>
                        <option value="Client">Client</option>
                        <option value="Testing">Testing</option>
                        <option value="Sample">Sample</option>
                        <option value="Buyer">Buyer</option>
                        <option value="Estate">Estate</option>
                    </select>
                </div>
                <div class="flex justify-end gap-2">
                    <button type="button" onclick="closeModal('customerModal')"
                        class="px-4 py-2 bg-gray-300 rounded-lg">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg">Save Customer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Stock Adjustment Modal -->
    <div id="adjustStockModal"
        class="modal fixed inset-0 bg-black bg-opacity-50 justify-center items-center z-50 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h3 class="text-xl font-bold mb-4">Adjust Physical Stock</h3>
            <form id="adjust-stock-form">
                <input type="hidden" id="adjust-item-id">
                <input type="hidden" id="adjust-item-category">
                <p class="mb-4">Item: <span id="adjust-item-name" class="font-bold"></span></p>
                <div class="mb-4">
                    <label class="block text-sm font-medium">Date</label>
                    <input type="date" id="adjust-date" class="w-full p-2 border rounded-md" required>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium">System Stock</label>
                        <input type="number" id="adjust-system-stock" class="w-full p-2 border rounded-md bg-gray-100"
                            readonly>
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Actual Stock</label>
                        <input type="number" id="adjust-actual-stock" step="0.001"
                            class="w-full p-2 border rounded-md border-blue-500" required>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium">Reason / Note</label>
                    <input type="text" id="adjust-reason" class="w-full p-2 border rounded-md"
                        placeholder="e.g., Spillage, Theft, Found">
                </div>
                <div class="flex justify-end gap-2">
                    <button type="button" onclick="closeModal('adjustStockModal')"
                        class="px-4 py-2 bg-gray-300 rounded-lg">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg">Update Stock</button>
                </div>
            </form>
        </div>
    </div>

    <div id="dispatchModal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 justify-center items-center"
        style="z-index: 55;">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h3 class="text-xl font-bold mb-4">New Sales / Dispatch</h3>
            <form id="dispatch-form">
                <div class="mb-2"><label class="text-sm font-bold">Date</label><input type="date" id="dispatch-date"
                        class="w-full p-2 border rounded" required></div>
                <div class="mb-2"><label class="text-sm font-bold">Customer</label><select id="dispatch-customer"
                        class="w-full p-2 border rounded"></select></div>
                <div class="mb-2"><label class="text-sm font-bold">Item (Finished Goods)</label><select
                        id="dispatch-item" class="w-full p-2 border rounded" required
                        onchange="populateDispatchBatchSelect()"></select></div>
                <div class="mb-2"><label class="text-sm">Batch (Optional)</label>
                    <div class="flex gap-2">
                        <select id="dispatch-batch" class="w-full p-2 border rounded"></select>
                        <button type="button" onclick="openBatchAdjustmentModal()"
                            class="px-2 py-1 bg-yellow-500 text-white rounded font-bold text-xs hover:bg-yellow-600"
                            title="Edit Batch Stock">Edit</button>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <div><label class="text-sm font-bold">Quantity</label><input type="number" id="dispatch-qty"
                            step="0.001" class="w-full p-2 border rounded" required></div>
                    <div><label class="text-sm">Invoice/DC No</label><input type="text" id="dispatch-invoice"
                            class="w-full p-2 border rounded"></div>
                </div>
                <div class="mb-4"><label class="text-sm">Purpose</label>
                    <select id="dispatch-purpose" class="w-full p-2 border rounded">
                        <option value="Sale">Sale</option>
                        <option value="Sample">Sample</option>
                        <option value="Demo">Demo</option>
                        <option value="Return">Return</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="text-sm font-bold">Notes / Remarks</label>
                    <textarea id="dispatch-notes" class="w-full p-2 border rounded" rows="2"
                        placeholder="Optional remarks..."></textarea>
                </div>
                <div class="flex justify-end gap-2">
                    <button type="button" onclick="closeModal('dispatchModal')"
                        class="px-4 py-2 bg-gray-300 rounded">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">Record Dispatch</button>
                </div>
            </form>
        </div>
    </div>

    <div id="saveCalculationModal" class="modal fixed inset-0 bg-black bg-opacity-50 justify-center items-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4">Save Calculation</h3>
            <div class="mb-4">
                <label class="block text-sm font-medium mb-1">Product Name</label>
                <input type="text" id="save-calc-name" class="w-full p-2 border rounded"
                    placeholder="e.g. Tomato Sauce 200g">
            </div>
            <div class="flex justify-end gap-2">
                <button onclick="closeModal('saveCalculationModal')"
                    class="px-4 py-2 bg-gray-300 rounded">Cancel</button>
                <button onclick="confirmSaveCalculator()" class="px-4 py-2 bg-blue-600 text-white rounded">Save</button>
            </div>
        </div>
    </div>
    <div id="itemHistoryModal" class="modal fixed inset-0 bg-black bg-opacity-50 justify-center items-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-4xl h-3/4 flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Item Transaction History</h3>
                <button onclick="closeModal('itemHistoryModal')"
                    class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <div class="overflow-y-auto flex-1">
                <table class="min-w-full text-sm">
                    <thead class="bg-gray-100 sticky top-0">
                        <tr>
                            <th class="p-3 text-left">Date</th>
                            <th class="p-3 text-left">Type</th>
                            <th class="p-3 text-right">Qty</th>
                            <th class="p-3 text-left">Batch/Ref</th>
                            <th class="p-3 text-left">Reason/Notes</th>
                            <th class="p-3 text-left">User</th>
                            <th class="p-3 text-center">Action</th>
                        </tr>
                    </thead>
                    <tbody id="item-history-rows"></tbody>
                </table>
            </div>
        </div>
    </div>
    <div id="completeBatchModal"
        class="modal fixed inset-0 bg-black bg-opacity-50 justify-center items-center z-50 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-4xl h-3/4 flex flex-col">
            <h3 class="text-xl font-bold mb-4" id="comp-batch-title">Complete Production</h3>

            <div class="grid grid-cols-2 gap-6 mb-4 bg-gray-50 p-4 rounded">
                <div>
                    <label class="block text-sm font-bold text-gray-500">Product</label>
                    <p class="text-xl font-bold text-blue-800" id="comp-prod-name">-</p>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-500">Target Qty</label>
                        <input type="number" id="comp-target-qty"
                            class="w-full p-2 border rounded bg-gray-100 font-mono" readonly>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700">Actual Produced</label>
                        <input type="number" id="comp-actual-qty" step="0.001"
                            class="w-full p-2 border-2 border-green-500 rounded font-bold font-mono text-green-700">
                    </div>
                </div>
                <div class="col-span-2">
                    <label class="block text-sm font-bold text-gray-700">Expiry Date (Batch/Lot)</label>
                    <input type="date" id="comp-expiry-date" class="w-full p-2 border rounded">
                </div>
            </div>

            <h4 class="font-bold text-gray-700 mb-2">Material Consumption & Wastage</h4>
            <div class="overflow-y-auto flex-1 mb-4 border rounded">
                <table class="min-w-full text-sm">
                    <thead class="bg-gray-100 sticky top-0">
                        <tr>
                            <th class="p-2 text-left">Item</th>
                            <th class="p-2 text-right">Plan Qty</th>
                            <th class="p-2 text-right w-32">Actual Consumed</th>
                            <th class="p-2 text-right w-32">Wastage / Loss</th>
                        </tr>
                    </thead>
                    <tbody id="comp-ing-rows">
                        <!-- Rows injected by JS -->
                    </tbody>
                </table>
            </div>

            <div class="flex justify-end gap-2 pt-4 border-t">
                <button
                    onclick="this.closest('.modal').classList.add('hidden'); this.closest('.modal').classList.remove('flex');"
                    class="px-6 py-2 bg-gray-300 text-gray-800 font-bold rounded hover:bg-gray-400">Cancel</button>
                <button onclick="confirmCompleteBatch()"
                    class="px-6 py-2 bg-green-600 text-white rounded font-bold hover:bg-green-700 shadow-lg">Confirm
                    Completion</button>
            </div>
        </div>
    </div>
    <!-- Item Notes Modal (Missing previously) -->
    <div id="itemNotesModal" class="modal fixed inset-0 bg-black bg-opacity-50 justify-center items-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md h-3/4 flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold" id="note-modal-title">Item Notes</h3>
                <button onclick="closeModal('itemNotesModal')"
                    class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <p class="mb-4 font-bold text-gray-700" id="notes-item-name">Item Name</p>
            <input type="hidden" id="notes-item-id">
            <input type="hidden" id="notes-item-category">

            <div id="notes-list" class="flex-1 overflow-y-auto mb-4 border p-2 rounded bg-gray-50">
                <!-- Notes injected here -->
            </div>

            <div class="mt-auto">
                <textarea id="new-note-input" class="w-full p-2 border rounded mb-2" rows="3"
                    placeholder="Add a note..."></textarea>
                <button onclick="addNote()"
                    class="w-full py-2 bg-blue-600 text-white rounded font-bold hover:bg-blue-700">Add Note</button>
            </div>
        </div>
    </div>

    <!-- Batch BOM Modal (View/Edit Reserved Materials) -->
    <div id="viewBatchBOMModal"
        class="modal fixed inset-0 bg-black bg-opacity-50 justify-center items-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-2xl h-3/4 flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Batch Reserved Materials</h3>
                <button onclick="closeModal('viewBatchBOMModal')"
                    class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <div class="mb-4 bg-blue-50 p-3 rounded">
                <p class="font-bold text-blue-900" id="bom-batch-info">Batch Info</p>
                <input type="hidden" id="bom-batch-id">
            </div>

            <div class="flex-1 overflow-y-auto mb-4 border rounded">
                <table class="min-w-full text-sm">
                    <thead class="bg-gray-100 sticky top-0">
                        <tr>
                            <th class="p-2 text-left">Item Name</th>
                            <th class="p-2 text-center">Type</th>
                            <th class="p-2 text-right">Reserved Qty</th>
                            <th class="p-2 text-center">Action</th>
                        </tr>
                    </thead>
                    <tbody id="bom-list-rows"></tbody>
                </table>
            </div>

            <div class="border-t pt-4">
                <h4 class="font-bold text-sm mb-2">Manually Add Material</h4>
                <div class="flex gap-2">
                    <select id="bom-add-cat" class="border rounded p-2 text-sm" onchange="updateBomItemSelect()">
                        <option value="rawMaterials">Raw Material</option>
                        <option value="packingMaterials">Packing Material</option>
                        <option value="labels">Label</option>
                    </select>
                    <select id="bom-add-item" class="border rounded p-2 flex-1 text-sm">
                        <option value="">Select Item</option>
                    </select>
                    <input type="number" id="bom-add-qty" class="border rounded p-2 w-24 text-sm" placeholder="Qty">
                    <button onclick="addBatchMaterial()"
                        class="bg-green-600 text-white px-4 py-2 rounded font-bold text-sm hover:bg-green-700">Add</button>
                </div>
            </div>
        </div>
    </div>

    <!-- UPDATED SCRIPTS FOR NEW FEATURES -->
    <script>
        // 1. IMPROVED FETCH COST (In-Place, No Redirect)
        window.calculateItemCost = function (itemId) {
            const finishedGood = appState.inventory.finishedGoods.find(i => i.id == itemId);
            if (!finishedGood) return;

            // Find formula by name matching
            const formula = (appState.formulas || []).find(f => f.name === finishedGood.name);

            if (!formula) {
                if (confirm(`Formula for "${finishedGood.name}" not found in Formulation section.\n\nDo you want to create a new formula now ? `)) {
                    showView('formulas');
                }
                return;
            }

            // Calculate Cost Programmatically
            let totalCost = 0;
            let details = [];

            const calculateComponentCost = (list, cat) => {
                (list || []).forEach(comp => {
                    const item = appState.inventory[cat].find(i => i.id == comp.itemId);
                    if (item) {
                        const cost = (parseFloat(item.currentAverageCost) || parseFloat(item.price) || 0) * comp.quantity;
                        totalCost += cost;
                        details.push(`${item.name}: ${comp.quantity} x ${cost.toFixed(2)} `);
                    }
                });
            };

            calculateComponentCost(formula.ingredients, 'rawMaterials');
            calculateComponentCost(formula.packingMaterials, 'packingMaterials');
            calculateComponentCost(formula.labels, 'labels');

            const perUnitCost = totalCost / (formula.outputQty || 1);

            // Show Result interactively
            const message = `Calculated Cost Breakdown for ${formula.outputQty} ${formula.outputUnit}: \n` +
                `Total Batch Cost: ₹${totalCost.toFixed(2)} \n` +
                `--------------------------------\n` +
                `COST PER UNIT: ₹${perUnitCost.toFixed(2)} \n\n` +
                `Current System Cost: ₹${(finishedGood.currentAverageCost || 0).toFixed(2)} \n\n` +
                `Do you want to update the item's Avg Cost to ₹${perUnitCost.toFixed(2)}?`;

            if (confirm(message)) {
                finishedGood.currentAverageCost = perUnitCost;

                // Also update Price if 0? Optional.
                if (!finishedGood.price || finishedGood.price == 0) {
                    finishedGood.price = (perUnitCost * 1.2).toFixed(2); // Default 20% margin
                }

                saveState();
                renderInventoryView('finishedGoods');
                showAlert("Item Cost Updated Successfully!");
            }
        };

        // 2. PRODUCTION VIEW BOM MANAGEMENT

        window.renderProductionWIPView = function () {
            const container = document.getElementById('production-wip-view');

            const activeBatches = appState.activeProduction || [];
            activeBatches.sort((a, b) => new Date(b.startDate) - new Date(a.startDate)); // Desc

            const formulas = appState.formulas || [];

            container.innerHTML = `
                <div class="p-6">
                     <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Orders & Production (WIP)</h2>
                        <button onclick="exportProductionHistory()" class="px-4 py-2 bg-green-600 text-white rounded shadow hover:bg-green-700 font-bold flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                            Download History
                        </button>
                     </div>
                     
                     <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Left: Create New Batch -->
                        <div class="bg-white p-6 rounded-lg shadow h-fit">
                            <h3 class="text-xl font-bold mb-4 text-blue-600">Start New Production</h3>
                            <form id="create-batch-form" onsubmit="handleCreateBatch(event)">
                                <div class="mb-4">
                                    <label class="block text-sm font-medium mb-1">Batch ID / Order Ref</label>
                                    <input type="text" id="new-batch-id" class="w-full p-2 border rounded font-mono" placeholder="e.g. B-2023-001" required>
                                </div>
                                <div class="mb-4">
                                    <label class="block text-sm font-medium mb-1">Product Formula</label>
                                    <select id="new-batch-formula" class="w-full p-2 border rounded" required>
                                        <option value="">-- Select Product --</option>
                                        ${formulas.map(f => `<option value="${f.id}">${f.name} (${f.outputQty} ${f.outputUnit})</option>`).join('')}
                                    </select>
                                </div>
                                <div class="mb-4">
                                    <label class="block text-sm font-medium mb-1">Target Quantity</label>
                                    <input type="number" id="new-batch-qty" step="any" class="w-full p-2 border rounded" placeholder="Qty to produce" required>
                                </div>
                                <button type="submit" class="w-full py-2 bg-blue-600 text-white rounded font-bold hover:bg-blue-700">Create Order</button>
                            </form>
                        </div>

                        <!-- Right: Active Batches List -->
                        <div class="lg:col-span-2 space-y-4">
                            ${activeBatches.length === 0 ? '<div class="bg-white p-8 rounded-lg shadow text-center text-gray-500">No active production orders.</div>' :
                    activeBatches.map(batch => {
                        const formula = formulas.find(f => f.id == batch.formulaId);
                        const formulaName = formula ? formula.name : 'Unknown Product';

                        // Count items
                        let reservedCount = 0;
                        if (batch.reservedData) {
                            reservedCount += (batch.reservedData.rawMaterials?.length || 0);
                            reservedCount += (batch.reservedData.packingMaterials?.length || 0);
                            reservedCount += (batch.reservedData.labels?.length || 0);
                        }

                        return `
                                <div class="bg-white p-6 rounded-lg shadow border-l-4 ${batch.status === 'started' ? 'border-blue-500' : 'border-gray-300'}">
                                    <div class="flex justify-between items-start mb-4">
                                        <div>
                                            <h4 class="text-lg font-bold text-gray-800">${formulaName}</h4>
                                            <p class="text-sm text-gray-500 font-mono">Batch: ${batch.batchNo}</p>
                                        </div>
                                        <div class="text-right">
                                            <span class="px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide ${batch.status === 'started' ? 'bg-blue-100 text-blue-800' : 'bg-gray-100'}">${batch.status}</span>
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-3 gap-4 text-sm mb-4 bg-gray-50 p-3 rounded">
                                        <div><p class="text-gray-500 text-xs uppercase">Target Qty</p><p class="font-bold text-lg">${batch.targetQty}</p></div>
                                        <div><p class="text-gray-500 text-xs uppercase">Start Date</p><p class="font-bold">${new Date(batch.startDate).toLocaleDateString()}</p></div>
                                        <div><p class="text-gray-500 text-xs uppercase">Reserved Items</p><p class="font-bold text-blue-600">${reservedCount} Items</p></div>
                                    </div>
                                    
                                    ${batch.shortageOverride ? '<p class="text-xs text-red-600 font-bold mb-2">⚠️ Started with Shortage Override</p>' : ''}

                                    <div class="flex flex-wrap gap-2 border-t pt-4">
                                        ${batch.status === 'draft' ?
                                `<button onclick="startBatch(${batch.id})" class="px-3 py-1 bg-green-600 text-white rounded text-sm font-bold hover:bg-green-700">Start (Reserve)</button>
                                             <button onclick="deleteBatch(${batch.id})" class="px-3 py-1 bg-red-100 text-red-600 rounded text-sm font-bold hover:bg-red-200">Delete</button>`
                                : ''}
                                        
                                        ${batch.status === 'started' ?
                                `<button onclick="completeBatch(${batch.id})" class="px-3 py-1 bg-indigo-600 text-white rounded text-sm font-bold hover:bg-indigo-700">Complete</button>
                                             <button onclick="openBatchBOMModal(${batch.id})" class="px-3 py-1 bg-purple-600 text-white rounded text-sm font-bold hover:bg-purple-700 flex items-center gap-1">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                                                Reserved
                                             </button>
                                             <button onclick="openConsumptionSlipModal(${batch.id})" class="px-3 py-1 bg-blue-600 text-white rounded text-sm font-bold hover:bg-blue-700 flex items-center gap-1">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                                Log Slip
                                             </button>
                                             <button onclick="openPauseModal(${batch.id})" class="px-3 py-1 bg-yellow-500 text-white rounded text-sm font-bold hover:bg-yellow-600">Pause</button>
                                             <button onclick="cancelBatch(${batch.id})" class="px-3 py-1 bg-red-100 text-red-600 rounded text-sm font-bold hover:bg-red-200">Cancel</button>`
                                : ''}
                                        
                                        ${batch.status === 'paused' ?
                                `<button onclick="resumeProduction(${batch.id})" class="px-3 py-1 bg-green-500 text-white rounded text-sm font-bold hover:bg-green-600">Resume</button>
                                             <button onclick="openConsumptionSlipModal(${batch.id})" class="px-3 py-1 bg-blue-600 text-white rounded text-sm font-bold hover:bg-blue-700">Log Slip</button>`
                                : ''}
                                    </div>
                                </div>
                                `;
                    }).join('')}
                        </div>
                     </div>
                </div>
            `;
        };

        window.openBatchBOMModal = function (batchId) {
            const batch = appState.activeProduction.find(b => b.id == batchId);
            if (!batch) return;

            document.getElementById('bom-batch-id').value = batch.id;
            document.getElementById('bom-batch-info').textContent = `Ref: ${batch.batchNo} | Target: ${batch.targetQty}`;

            updateBomItemSelect();
            renderBomList(batch);
            openModal('viewBatchBOMModal');
        };

        function renderBomList(batch) {
            const tbody = document.getElementById('bom-list-rows');
            tbody.innerHTML = '';

            if (!batch.reservedData) return;

            const addRows = (list, cat, typeLabel) => {
                (list || []).forEach((item, idx) => {
                    const invItem = appState.inventory[cat].find(i => i.id == item.itemId);
                    const tr = document.createElement('tr');
                    tr.className = 'border-b hover:bg-gray-50';
                    tr.innerHTML = `
                        <td class="p-2">${invItem ? invItem.name : 'Unknown Item'}</td>
                        <td class="p-2 text-center text-xs uppercase text-gray-500">${typeLabel}</td>
                        <td class="p-2 text-right font-mono font-bold">${item.quantity.toFixed(3)}</td>
                        <td class="p-2 text-center">
                            <!-- Cannot delete easily without un-reserving transaction logic, so maybe just show -->
                            <span class="text-xs text-gray-400">Reserved</span>
                        </td>
                     `;
                    tbody.appendChild(tr);
                });
            };

            addRows(batch.reservedData.rawMaterials, 'rawMaterials', 'Raw');
            addRows(batch.reservedData.packingMaterials, 'packingMaterials', 'Pkg');
            addRows(batch.reservedData.labels, 'labels', 'Label');
        }

        window.updateBomItemSelect = function () {
            const cat = document.getElementById('bom-add-cat').value;
            const select = document.getElementById('bom-add-item');
            select.innerHTML = '<option value="">Select Item</option>';

            (appState.inventory[cat] || []).forEach(item => {
                const opt = document.createElement('option');
                opt.value = item.id;
                opt.textContent = `${item.name} (Avl: ${calculateAvailable(item, cat)})`;
                select.appendChild(opt);
            });
        };

        // Helper to check avail
        function calculateAvailable(item, cat) {
            let stock = 0;
            if (typeof calculateStock === 'function') stock = calculateStock(item, cat, getToday()).closingStock;
            if (typeof getReservedStock === 'function') stock -= getReservedStock(item, cat);
            return stock.toFixed(2);
        }

        window.addBatchMaterial = function () {
            const batchId = document.getElementById('bom-batch-id').value;
            const cat = document.getElementById('bom-add-cat').value;
            const itemId = document.getElementById('bom-add-item').value;
            const qty = parseFloat(document.getElementById('bom-add-qty').value);

            if (!batchId || !itemId || !qty || qty <= 0) { showAlert("Invalid Input"); return; }

            const batch = appState.activeProduction.find(b => b.id == batchId);
            if (!batch) return;

            // Log Transaction
            appState.transactions.push({
                id: Date.now(),
                type: 'production-reserve',
                category: cat,
                itemId: parseInt(itemId),
                quantity: qty,
                date: new Date().toISOString(),
                batchNo: batch.batchNo,
                notes: "Manual Addition to WIP"
            });

            // Update Batch Data
            if (!batch.reservedData) batch.reservedData = { rawMaterials: [], packingMaterials: [], labels: [] };
            if (!batch.reservedData[cat]) batch.reservedData[cat] = [];

            // Check if exists, aggregate? or just push? Pushing is safer for tracking.
            const existing = batch.reservedData[cat].find(i => i.itemId == itemId);
            if (existing) {
                existing.quantity += qty;
            } else {
                batch.reservedData[cat].push({ itemId: parseInt(itemId), quantity: qty });
            }

            saveState();
            renderBomList(batch);
            showAlert("Material Added & Reserved Successfully");

            // Refresh Inventory view if open in background?
            renderProductionWIPView();
        };

        // ============================================
        // PRODUCT TRACEABILITY VIEW & LOGIC
        // ============================================

        window.openProductTrace = function (productId) {
            if (!checkPermission()) return;
            // Ensure ID type
            const id = parseFloat(productId);
            const item = findItem('finishedGoods', id);

            if (!item) {
                showAlert("Product not found or not a Finished Good.");
                return;
            }

            showView('product-trace');
            renderProductTraceView(item);
        };

        function renderProductTraceView(item) {
            const container = document.getElementById('product-trace-view');

            // 1. Calculate Summary Stats
            const stock = calculateStock(item, 'finishedGoods', getToday());
            const totalProduced = appState.transactions
                .filter(t => t.itemId == item.id && t.category === 'finishedGoods' && t.type === 'production-add')
                .reduce((acc, t) => acc + t.quantity, 0);

            const totalDispatched = appState.transactions
                .filter(t => t.itemId == item.id && t.category === 'finishedGoods' && t.type === 'dispatch')
                .reduce((acc, t) => acc + t.quantity, 0);

            // 2. Group Batches
            // Find all unique batches for this product from 'production-add' or manually entered batches
            const batchMap = new Map();

            // Initialize with all transactions to capture every batch involved
            appState.transactions
                .filter(t => t.itemId == item.id && t.category === 'finishedGoods')
                .forEach(t => {
                    const batchKey = t.batchNo || 'OPENING_STOCK';

                    if (!batchMap.has(batchKey)) {
                        batchMap.set(batchKey, {
                            id: batchKey,
                            mfg: batchKey === 'OPENING_STOCK' ? 'N/A' : 'N/A',
                            exp: 'N/A',
                            produced: batchKey === 'OPENING_STOCK' ? (item.openingStock || 0) : 0,
                            dispatched: 0,
                            balance: batchKey === 'OPENING_STOCK' ? (item.openingStock || 0) : 0,
                            firstDate: batchKey === 'OPENING_STOCK' ? (item.openingStockDate || t.date) : t.date
                        });
                    }
                    const batch = batchMap.get(batchKey);

                    if (t.type === 'production-add' || t.type === 'receive') {
                        if (batchKey !== 'OPENING_STOCK') {
                            batch.produced += t.quantity;
                        }
                        if (t.mfgDate) batch.mfg = t.mfgDate;
                        if (t.expDate || t.expiryDate) batch.exp = t.expDate || t.expiryDate;
                        if (new Date(t.date) < new Date(batch.firstDate)) batch.firstDate = t.date;
                    } else if (t.type === 'dispatch') {
                        batch.dispatched += t.quantity;
                    }

                    // Simple balance calc based on specific batch moves? 
                    // No, let's just sum +/- for this batch
                    if (['production-add', 'receive', 'stock-take-adj-in'].includes(t.type)) {
                        if (batchKey !== 'OPENING_STOCK') {
                            batch.balance += t.quantity;
                        }
                    } else if (['dispatch', 'consume', 'stock-take-adj-out', 'production-consume'].includes(t.type)) {
                        batch.balance -= t.quantity;
                    }
                });

            const batches = Array.from(batchMap.values()).sort((a, b) => new Date(b.firstDate) - new Date(a.firstDate));

            container.innerHTML = `
                <div class="h-full flex flex-col">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center gap-4">
                            <button onclick="showView('finishedGoods')" class="text-gray-500 hover:text-gray-800">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                            </button>
                            <h2 class="text-3xl font-bold flex items-center gap-2">
                                Traceability: <span class="text-blue-600">${item.name}</span>
                            </h2>
                        </div>
                        <div class="text-sm font-mono bg-gray-100 p-2 rounded">Product ID: ${item.id}</div>
                    </div>

                    <!-- Summary Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <div class="bg-blue-50 p-6 rounded-lg border border-blue-100">
                            <h3 class="font-bold text-blue-800 mb-1">Current Stock</h3>
                            <p class="text-3xl font-bold text-blue-900">${stock.closingStock.toFixed(3)} <span class="text-sm text-blue-600">${item.unit}</span></p>
                        </div>
                         <div class="bg-green-50 p-6 rounded-lg border border-green-100">
                            <h3 class="font-bold text-green-800 mb-1">Total Produced</h3>
                            <p class="text-3xl font-bold text-green-900">${totalProduced.toFixed(3)}</p>
                        </div>
                        <div class="bg-purple-50 p-6 rounded-lg border border-purple-100">
                            <h3 class="font-bold text-purple-800 mb-1">Total Dispatched</h3>
                            <p class="text-3xl font-bold text-purple-900">${totalDispatched.toFixed(3)}</p>
                        </div>
                         <div class="bg-yellow-50 p-6 rounded-lg border border-yellow-100">
                             <h3 class="font-bold text-yellow-800 mb-1">Batches Tracked</h3>
                             <p class="text-3xl font-bold text-yellow-900">${batches.length}</p>
                         </div>
                    </div>

                    <div class="flex flex-col md:flex-row gap-6 h-full">
                        <!-- Batch Timeline (Left) -->
                        <div class="w-full md:w-1/3 bg-white rounded-lg shadow overflow-hidden flex flex-col">
                            <div class="p-4 bg-gray-50 border-b">
                                <h3 class="font-bold text-lg">Batch Timeline</h3>
                                <p class="text-xs text-gray-500">Select a batch to view detailed trace</p>
                            </div>
                            <div class="overflow-y-auto flex-1 h-[600px]">
                                <table class="min-w-full text-sm">
                                    <thead class="bg-white sticky top-0 z-10 shadow-sm">
                                        <tr>
                                            <th class="p-3 text-left">Batch ID</th>
                                            <th class="p-3 text-right">Produced</th>
                                            <th class="p-3 text-right">Balance</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${batches.map(b => `
                                            <tr class="hover:bg-blue-50 cursor-pointer border-b transition-colors" onclick="renderBatchTraceDetails('${item.id}', '${b.id}')">
                                                <td class="p-3">
                                                    <div class="font-bold font-mono text-blue-600">${b.id}</div>
                                                    <div class="text-xs text-gray-500">MFG: ${b.mfg || '-'}</div>
                                                </td>
                                                <td class="p-3 text-right font-medium">${b.produced.toFixed(3)}</td>
                                                <td class="p-3 text-right font-bold ${b.balance > 0 ? 'text-green-600' : 'text-gray-400'}">${b.balance.toFixed(3)}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Detailed Trace (Right) -->
                        <div class="w-full md:w-2/3 bg-white rounded-lg shadow overflow-hidden flex flex-col" id="batch-trace-detail-container">
                            <div class="flex flex-col items-center justify-center h-full text-gray-400 p-10">
                                <svg class="w-16 h-16 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                                <p class="text-lg font-medium">Select a batch from the timeline to view full traceability details.</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        window.renderBatchTraceDetails = function (itemIdStr, batchId) {
            const container = document.getElementById('batch-trace-detail-container');
            const itemId = parseFloat(itemIdStr);

            const productionTxs = appState.transactions.filter(t => t.category === 'finishedGoods' && t.itemId == itemId && (t.batchNo === batchId || (batchId === 'OPENING_STOCK' && !t.batchNo)) && t.type === 'production-add');
            const dispatchTxs = appState.transactions.filter(t => t.category === 'finishedGoods' && t.itemId == itemId && (t.batchNo === batchId || (batchId === 'OPENING_STOCK' && !t.batchNo)) && t.type === 'dispatch');

            // Search for linked consumption: either straight 'consume' of ANY item that links to this FG Batch, 
            // OR 'production-consume' that links to this batch.
            const consumptionTxs = appState.transactions.filter(t =>
                (t.type === 'production-consume' || t.type === 'consume') &&
                (t.relatedBatchId === batchId || t.fgBatchId === batchId)
            );

            container.innerHTML = `
                <div class="h-full flex flex-col bg-gray-50">
                    <div class="p-4 bg-white border-b shadow-sm flex justify-between items-center">
                        <h3 class="font-bold text-xl text-gray-800">Batch Details: <span class="text-blue-600 font-mono">${batchId}</span></h3>
                        <div class="text-xs text-gray-500">
                            Produced: ${productionTxs.reduce((a, t) => a + t.quantity, 0).toFixed(3)} |
                            Dispatched: ${dispatchTxs.reduce((a, t) => a + t.quantity, 0).toFixed(3)}
                        </div>
                    </div>
                    
                    <div class="flex-1 overflow-y-auto p-6 space-y-6">
                        
                        <!-- 1. Production / Inflow -->
                        <div class="bg-white rounded-lg shadow p-4 border-l-4 border-green-500">
                             <h4 class="font-bold text-gray-700 mb-3 flex items-center">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                Production / Receipt
                             </h4>
                             <table class="min-w-full text-sm">
                                <thead class="bg-gray-50 text-xs uppercase"><tr><th class="p-2 text-left">Date</th><th class="p-2 text-right">Qty</th><th class="p-2 text-left">MFG / EXP</th><th class="p-2 text-left">Notes</th></tr></thead>
                                <tbody>
                                    ${productionTxs.length ? productionTxs.map(t => `
                                        <tr class="border-b">
                                            <td class="p-2">${t.date.split('T')[0]}</td>
                                            <td class="p-2 text-right font-bold text-green-600">+${t.quantity}</td>
                                            <td class="p-2 text-xs">${t.mfgDate || '-'} / ${t.expDate || t.expiryDate || '-'}</td>
                                            <td class="p-2 text-xs text-gray-500">${t.notes || '-'}</td>
                                        </tr>
                                    `).join('') : '<tr><td colspan="4" class="p-2 text-gray-400 italic">No production record found (Manual batch?)</td></tr>'}
                                </tbody>
                             </table>
                        </div>

                        <!-- 2. Consumption (Ingredients) -->
                        <div class="bg-white rounded-lg shadow p-4 border-l-4 border-yellow-500">
                             <h4 class="font-bold text-gray-700 mb-3 flex items-center">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
                                Ingredients Consumed
                             </h4>
                             ${consumptionTxs.length === 0 ?
                    `<div class="p-4 bg-yellow-50 text-yellow-800 text-sm rounded">
                                    No linked material consumption found. <br>
                                    <span class="text-xs">Note: Basic stock transactions may not link ingredients to FG Batches unless recorded via Production execution.</span>
                                </div>` :
                    `<table class="min-w-full text-sm">
                                    <thead class="bg-gray-50 text-xs uppercase"><tr><th class="p-2 text-left">Item</th><th class="p-2 text-right">Qty</th><th class="p-2 text-left">Source Batch</th><th class="p-2 text-left">Wastage</th></tr></thead>
                                    <tbody>
                                        ${consumptionTxs.map(t => {
                        const item = findItem(t.category, t.itemId);
                        return `<tr class="border-b">
                                                <td class="p-2">${item ? item.name : 'Unknown'}</td>
                                                <td class="p-2 text-right font-bold text-red-600">${t.quantity}</td>
                                                <td class="p-2 text-xs font-mono">${t.batchNo || 'FIFO'}</td>
                                                <td class="p-2 text-xs">${t.wastage || 0}</td>
                                            </tr>`;
                    }).join('')}
                                    </tbody>
                                </table>`
                }
                        </div>

                        <!-- 3. Dispatch / Customers -->
                         <div class="bg-white rounded-lg shadow p-4 border-l-4 border-purple-500">
                             <h4 class="font-bold text-gray-700 mb-3 flex items-center">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                Dispatched To
                             </h4>
                             <table class="min-w-full text-sm">
                                <thead class="bg-gray-50 text-xs uppercase"><tr><th class="p-2 text-left">Date</th><th class="p-2 text-left">Customer</th><th class="p-2 text-right">Qty</th><th class="p-2 text-left">Invoice</th></tr></thead>
                                <tbody>
                                    ${dispatchTxs.length ? dispatchTxs.map(t => {
                    const cust = (appState.customers || []).find(c => c.id == t.customerId);
                    return `
                                        <tr class="border-b">
                                            <td class="p-2">${t.date.split('T')[0]}</td>
                                            <td class="p-2 font-medium">${cust ? cust.name : 'Unknown'}</td>
                                            <td class="p-2 text-right font-bold text-purple-600">-${t.quantity}</td>
                                            <td class="p-2 text-xs">${t.invoiceNo || '-'}</td>
                                        </tr>`;
                }).join('') : '<tr><td colspan="4" class="p-2 text-gray-400 italic">No dispatches yet.</td></tr>'}
                                </tbody>
                             </table>
                        </div>
                    </div>
                </div>
            `;
        };

        // AUTO ALLOCATION HELPER (FIFO / FEFO)
        // Returns array of objects: { batchNo, quantity, expiryDate? }
        window.allocateStock = function (item, category, quantityNeeded, mode = 'FIFO') {
            const batchStock = {};
            const batchMeta = {};

            appState.transactions.filter(t => t.itemId == item.id && t.category === category).forEach(t => {
                const batch = t.batchNo || 'Unassigned';
                if (!batchStock[batch]) {
                    batchStock[batch] = 0;
                    batchMeta[batch] = { firstDate: t.date, expiry: null };
                }

                if (['receive', 'produce', 'stock-take-adj-in', 'production-add'].includes(t.type)) {
                    batchStock[batch] += t.quantity;
                    if (t.expDate || t.expiryDate) batchMeta[batch].expiry = t.expDate || t.expiryDate;
                } else if (['consume', 'dispatch', 'stock-take-adj-out', 'production-consume'].includes(t.type)) {
                    batchStock[batch] -= t.quantity;
                }
            });

            let availableBatches = Object.keys(batchStock)
                .map(b => ({
                    batchNo: b,
                    quantity: batchStock[b],
                    expiry: batchMeta[b]?.expiry,
                    firstDate: batchMeta[b]?.firstDate
                }))
                .filter(b => b.quantity > 0.0001);

            if (mode === 'FEFO') {
                availableBatches.sort((a, b) => {
                    if (a.expiry && b.expiry) return new Date(a.expiry) - new Date(b.expiry);
                    if (a.expiry && !b.expiry) return -1;
                    if (!a.expiry && b.expiry) return 1;
                    return new Date(a.firstDate) - new Date(b.firstDate);
                });
            } else {
                availableBatches.sort((a, b) => new Date(a.firstDate) - new Date(b.firstDate));
            }

            const allocation = [];
            let remaining = quantityNeeded;

            for (const batch of availableBatches) {
                if (remaining <= 0) break;
                const take = Math.min(remaining, batch.quantity);
                allocation.push({
                    batchNo: batch.batchNo === 'Unassigned' ? null : batch.batchNo,
                    quantity: take
                });
                remaining -= take;
            }

            if (remaining > 0.0001) {
                allocation.push({ batchNo: null, quantity: remaining });
            }

            return allocation;
        };

    </script>

    <!-- ============================================ -->
    <!-- ALL IMPROVEMENTS EMBEDDED - SINGLE FILE     -->
    <!-- ============================================ -->
    <script>
        // ALL INVENTORY IMPROVEMENTS - EMBEDDED IN ONE FILE
        // Export, Return, FEFO, Search, Batch PDF + Auto-initialization

        // ========================================
        // 1. EXPORT FUNCTIONS
        // ========================================

        function exportCustomerWiseData() {
            if (!window.XLSX) { alert('XLSX library not loaded!'); return; }
            const customers = appState.customers || [];
            const transactions = appState.transactions || [];
            const wb = XLSX.utils.book_new();
            const customerData = customers.map(customer => {
                const customerTransactions = transactions.filter(t => t.customerId === customer.id || t.customerName === customer.name);
                const dispatches = customerTransactions.filter(t => t.type === 'dispatch');
                const returns = customerTransactions.filter(t => t.type === 'sales-return');
                const totalDispatched = dispatches.reduce((sum, t) => sum + (parseFloat(t.quantity) || 0), 0);
                const totalReturned = returns.reduce((sum, t) => sum + (parseFloat(t.quantity) || 0), 0);
                return {
                    'Customer Name': customer.name || 'N/A', 'Type': customer.type || 'N/A', 'Contact': customer.contact || 'N/A',
                    'Email': customer.email || 'N/A', 'Address': customer.address || 'N/A', 'Total Dispatches': dispatches.length,
                    'Total Returns': returns.length, 'Total Qty Dispatched': totalDispatched.toFixed(2),
                    'Total Qty Returned': totalReturned.toFixed(2), 'Net Qty': (totalDispatched - totalReturned).toFixed(2)
                };
            });
            const ws1 = XLSX.utils.json_to_sheet(customerData);
            XLSX.utils.book_append_sheet(wb, ws1, 'Customer Summary');
            customers.forEach((customer, index) => {
                if (index >= 30) return;
                const customerTransactions = transactions.filter(t => t.customerId === customer.id || t.customerName === customer.name);
                const detailedData = customerTransactions.map(t => {
                    const item = findItem(t.category, t.itemId);
                    return {
                        'Date': t.date ? t.date.split('T')[0] : 'N/A', 'Type': t.type || 'N/A',
                        'Item': item ? item.name : 'Unknown', 'Quantity': t.quantity || 0, 'Unit': item ? item.unit : '',
                        'Batch No': t.batchNo || '-', 'Invoice No': t.invoiceNo || '-',
                        'Purpose': t.dispatchPurpose || t.returnReason || '-', 'Notes': t.notes || '-'
                    };
                });
                if (detailedData.length > 0) {
                    const ws = XLSX.utils.json_to_sheet(detailedData);
                    const sheetName = customer.name.substring(0, 30).replace(/[:\\/?*\[\]]/g, '');
                    XLSX.utils.book_append_sheet(wb, ws, sheetName);
                }
            });
            const fileName = `Customer_Wise_Data_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            showToast('Customer-wise data exported successfully!', 'success');
        }

        function exportSupplierWiseData() {
            if (!window.XLSX) { alert('XLSX library not loaded!'); return; }
            const suppliers = appState.suppliers || [];
            const transactions = appState.transactions || [];
            const wb = XLSX.utils.book_new();
            const supplierData = suppliers.map(supplier => {
                const supplierTransactions = transactions.filter(t => t.supplierId === supplier.id || t.supplierName === supplier.name);
                const purchases = supplierTransactions.filter(t => t.type === 'receive');
                const totalReceived = purchases.reduce((sum, t) => sum + (parseFloat(t.quantity) || 0), 0);
                const totalValue = purchases.reduce((sum, t) => {
                    const qty = parseFloat(t.quantity) || 0;
                    const price = parseFloat(t.purchasePrice) || parseFloat(t.price) || 0;
                    return sum + (qty * price);
                }, 0);
                return {
                    'Supplier Name': supplier.name || 'N/A', 'Contact': supplier.contact || 'N/A',
                    'Email': supplier.email || 'N/A', 'Address': supplier.address || 'N/A',
                    'Total Purchases': purchases.length, 'Total Qty Received': totalReceived.toFixed(2),
                    'Total Value': totalValue.toFixed(2)
                };
            });
            const ws1 = XLSX.utils.json_to_sheet(supplierData);
            XLSX.utils.book_append_sheet(wb, ws1, 'Supplier Summary');
            suppliers.forEach((supplier, index) => {
                if (index >= 30) return;
                const supplierTransactions = transactions.filter(t => t.supplierId === supplier.id || t.supplierName === supplier.name);
                const detailedData = supplierTransactions.map(t => {
                    const item = findItem(t.category, t.itemId);
                    const price = parseFloat(t.purchasePrice) || parseFloat(t.price) || 0;
                    const qty = parseFloat(t.quantity) || 0;
                    return {
                        'Date': t.date ? t.date.split('T')[0] : 'N/A', 'Type': t.type || 'N/A',
                        'Item': item ? item.name : 'Unknown', 'Quantity': qty, 'Unit': item ? item.unit : '',
                        'Price/Unit': price.toFixed(2), 'Total Value': (qty * price).toFixed(2),
                        'Batch No': t.batchNo || '-', 'Invoice No': t.invoiceNo || '-', 'PO No': t.poNo || '-'
                    };
                });
                if (detailedData.length > 0) {
                    const ws = XLSX.utils.json_to_sheet(detailedData);
                    const sheetName = supplier.name.substring(0, 30).replace(/[:\\/?*\[\]]/g, '');
                    XLSX.utils.book_append_sheet(wb, ws, sheetName);
                }
            });
            const fileName = `Supplier_Wise_Data_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            showToast('Supplier-wise data exported successfully!', 'success');
        }

        function exportSalesDataCustomerWise() {
            if (!window.XLSX) { alert('XLSX library not loaded!'); return; }
            const transactions = appState.transactions || [];
            const dispatches = transactions.filter(t => t.type === 'dispatch');
            const returns = transactions.filter(t => t.type === 'sales-return');
            const customerSales = {};
            dispatches.forEach(d => {
                const customerKey = d.customerName || 'Unknown Customer';
                if (!customerSales[customerKey]) {
                    customerSales[customerKey] = { dispatches: [], returns: [], totalQty: 0, returnedQty: 0, netQty: 0 };
                }
                const item = findItem(d.category, d.itemId);
                customerSales[customerKey].dispatches.push({ ...d, itemName: item ? item.name : 'Unknown', unit: item ? item.unit : '' });
                customerSales[customerKey].totalQty += parseFloat(d.quantity) || 0;
            });
            returns.forEach(r => {
                const customerKey = r.customerName || 'Unknown Customer';
                if (!customerSales[customerKey]) {
                    customerSales[customerKey] = { dispatches: [], returns: [], totalQty: 0, returnedQty: 0, netQty: 0 };
                }
                const item = findItem(r.category, r.itemId);
                customerSales[customerKey].returns.push({ ...r, itemName: item ? item.name : 'Unknown', unit: item ? item.unit : '' });
                customerSales[customerKey].returnedQty += parseFloat(r.quantity) || 0;
            });
            Object.keys(customerSales).forEach(key => {
                customerSales[key].netQty = customerSales[key].totalQty - customerSales[key].returnedQty;
            });
            const wb = XLSX.utils.book_new();
            const summaryData = Object.keys(customerSales).map(customerName => ({
                'Customer': customerName, 'Total Dispatches': customerSales[customerName].dispatches.length,
                'Total Returns': customerSales[customerName].returns.length,
                'Total Qty Dispatched': customerSales[customerName].totalQty.toFixed(2),
                'Total Qty Returned': customerSales[customerName].returnedQty.toFixed(2),
                'Net Qty': customerSales[customerName].netQty.toFixed(2)
            }));
            const wsSummary = XLSX.utils.json_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, wsSummary, 'Sales Summary');
            Object.keys(customerSales).slice(0, 30).forEach(customerName => {
                const data = customerSales[customerName];
                const allTransactions = [];
                data.dispatches.forEach(d => {
                    allTransactions.push({
                        'Date': d.date ? d.date.split('T')[0] : 'N/A', 'Type': 'Dispatch', 'Item': d.itemName,
                        'Quantity': d.quantity, 'Unit': d.unit, 'Batch No': d.batchNo || '-',
                        'Invoice No': d.invoiceNo || '-', 'Purpose': d.dispatchPurpose || '-'
                    });
                });
                data.returns.forEach(r => {
                    allTransactions.push({
                        'Date': r.date ? r.date.split('T')[0] : 'N/A', 'Type': 'Return', 'Item': r.itemName,
                        'Quantity': r.quantity, 'Unit': r.unit, 'Batch No': r.batchNo || '-',
                        'Invoice No': r.invoiceNo || '-', 'Reason': r.returnReason || '-'
                    });
                });
                if (allTransactions.length > 0) {
                    const ws = XLSX.utils.json_to_sheet(allTransactions);
                    const sheetName = customerName.substring(0, 30).replace(/[:\\/?*\[\]]/g, '');
                    XLSX.utils.book_append_sheet(wb, ws, sheetName);
                }
            });
            const fileName = `Sales_Data_Customer_Wise_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            showToast('Sales data (customer-wise) exported successfully!', 'success');
        }

        function exportSalesDataProductWise() {
            if (!window.XLSX) { alert('XLSX library not loaded!'); return; }
            const transactions = appState.transactions || [];
            const dispatches = transactions.filter(t => t.type === 'dispatch');
            const returns = transactions.filter(t => t.type === 'sales-return');
            const productSales = {};
            dispatches.forEach(d => {
                const item = findItem(d.category, d.itemId);
                const productKey = item ? item.name : 'Unknown Product';
                if (!productSales[productKey]) {
                    productSales[productKey] = {
                        category: d.category || 'N/A', unit: item ? item.unit : '',
                        dispatches: [], returns: [], totalQty: 0, returnedQty: 0, netQty: 0
                    };
                }
                productSales[productKey].dispatches.push(d);
                productSales[productKey].totalQty += parseFloat(d.quantity) || 0;
            });
            returns.forEach(r => {
                const item = findItem(r.category, r.itemId);
                const productKey = item ? item.name : 'Unknown Product';
                if (!productSales[productKey]) {
                    productSales[productKey] = {
                        category: r.category || 'N/A', unit: item ? item.unit : '',
                        dispatches: [], returns: [], totalQty: 0, returnedQty: 0, netQty: 0
                    };
                }
                productSales[productKey].returns.push(r);
                productSales[productKey].returnedQty += parseFloat(r.quantity) || 0;
            });
            Object.keys(productSales).forEach(key => {
                productSales[key].netQty = productSales[key].totalQty - productSales[key].returnedQty;
            });
            const wb = XLSX.utils.book_new();
            const summaryData = Object.keys(productSales).map(productName => ({
                'Product': productName, 'Category': productSales[productName].category,
                'Unit': productSales[productName].unit, 'Total Dispatches': productSales[productName].dispatches.length,
                'Total Returns': productSales[productName].returns.length,
                'Total Qty Dispatched': productSales[productName].totalQty.toFixed(2),
                'Total Qty Returned': productSales[productName].returnedQty.toFixed(2),
                'Net Qty': productSales[productName].netQty.toFixed(2)
            }));
            const wsSummary = XLSX.utils.json_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, wsSummary, 'Product Sales Summary');
            Object.keys(productSales).slice(0, 30).forEach(productName => {
                const data = productSales[productName];
                const allTransactions = [];
                data.dispatches.forEach(d => {
                    allTransactions.push({
                        'Date': d.date ? d.date.split('T')[0] : 'N/A', 'Type': 'Dispatch',
                        'Customer': d.customerName || 'Unknown', 'Quantity': d.quantity, 'Unit': data.unit,
                        'Batch No': d.batchNo || '-', 'Invoice No': d.invoiceNo || '-', 'Purpose': d.dispatchPurpose || '-'
                    });
                });
                data.returns.forEach(r => {
                    allTransactions.push({
                        'Date': r.date ? r.date.split('T')[0] : 'N/A', 'Type': 'Return',
                        'Customer': r.customerName || 'Unknown', 'Quantity': r.quantity, 'Unit': data.unit,
                        'Batch No': r.batchNo || '-', 'Invoice No': r.invoiceNo || '-', 'Reason': r.returnReason || '-'
                    });
                });
                if (allTransactions.length > 0) {
                    const ws = XLSX.utils.json_to_sheet(allTransactions);
                    const sheetName = productName.substring(0, 30).replace(/[:\\/?*\[\]]/g, '');
                    XLSX.utils.book_append_sheet(wb, ws, sheetName);
                }
            });
            const fileName = `Sales_Data_Product_Wise_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            showToast('Sales data (product-wise) exported successfully!', 'success');
        }

        function exportAllDataAtOnce() {
            if (!window.XLSX) { alert('XLSX library not loaded!'); return; }
            const wb = XLSX.utils.book_new();
            const categories = ['rawMaterials', 'packingMaterials', 'labels', 'finishedGoods'];
            const categoryNames = {
                'rawMaterials': 'Raw Materials', 'packingMaterials': 'Packing Materials',
                'labels': 'Labels', 'finishedGoods': 'Finished Goods'
            };
            categories.forEach(cat => {
                const items = appState.inventory[cat] || [];
                const data = items.map(item => ({
                    'ID': item.id, 'Name': item.name, 'Unit': item.unit, 'Price': item.price,
                    'Opening Stock': item.openingStock, 'Opening Date': item.openingStockDate,
                    'Current Stock': calculateCurrentStock(cat, item.id), 'Min Stock Level': item.minStockLevel || 0,
                    'Expiry Date': item.expiryDate || '-', 'Notes': (item.notes || []).join('; ')
                }));
                if (data.length > 0) {
                    const ws = XLSX.utils.json_to_sheet(data);
                    XLSX.utils.book_append_sheet(wb, ws, categoryNames[cat]);
                }
            });
            const transactions = appState.transactions || [];
            const txData = transactions.map(t => {
                const item = findItem(t.category, t.itemId);
                return {
                    'ID': t.id, 'Date': t.date ? t.date.split('T')[0] : 'N/A', 'Type': t.type,
                    'Category': t.category, 'Item': item ? item.name : 'Unknown', 'Quantity': t.quantity,
                    'Batch No': t.batchNo || '-', 'Supplier': t.supplierName || '-', 'Customer': t.customerName || '-',
                    'Invoice No': t.invoiceNo || '-', 'PO No': t.poNo || '-',
                    'Purpose': t.dispatchPurpose || t.returnReason || t.subtype || '-', 'Notes': t.notes || '-'
                };
            });
            if (txData.length > 0) {
                const wsTx = XLSX.utils.json_to_sheet(txData);
                XLSX.utils.book_append_sheet(wb, wsTx, 'All Transactions');
            }
            const customers = appState.customers || [];
            if (customers.length > 0) {
                const custData = customers.map(c => ({
                    'ID': c.id, 'Name': c.name, 'Type': c.type || '-', 'Contact': c.contact || '-',
                    'Email': c.email || '-', 'Address': c.address || '-', 'Notes': c.notes || '-'
                }));
                const wsCust = XLSX.utils.json_to_sheet(custData);
                XLSX.utils.book_append_sheet(wb, wsCust, 'Customers');
            }
            const suppliers = appState.suppliers || [];
            if (suppliers.length > 0) {
                const suppData = suppliers.map(s => ({
                    'ID': s.id, 'Name': s.name, 'Contact': s.contact || '-', 'Email': s.email || '-',
                    'Address': s.address || '-', 'Notes': s.notes || '-'
                }));
                const wsSupp = XLSX.utils.json_to_sheet(suppData);
                XLSX.utils.book_append_sheet(wb, wsSupp, 'Suppliers');
            }
            const formulas = appState.formulas || [];
            if (formulas.length > 0) {
                const formData = formulas.map(f => ({
                    'ID': f.id, 'Product Name': f.name, 'Output Qty': f.outputQty, 'Output Unit': f.outputUnit,
                    'Ingredients': JSON.stringify(f.ingredients || []), 'Packing': JSON.stringify(f.packing || []),
                    'Labels': JSON.stringify(f.labels || [])
                }));
                const wsForm = XLSX.utils.json_to_sheet(formData);
                XLSX.utils.book_append_sheet(wb, wsForm, 'Formulas');
            }
            const fileName = `Complete_Database_Export_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            showToast('Complete database exported successfully!', 'success');
        }

        if (typeof showToast === 'undefined') {
            window.showToast = function (message, type = 'info') {
                const toast = document.getElementById('toast-notification');
                if (!toast) return;
                toast.textContent = message;
                toast.className = 'show';
                if (type === 'success') {
                    toast.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                } else if (type === 'error') {
                    toast.style.background = 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)';
                } else {
                    toast.style.background = 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)';
                }
                setTimeout(() => toast.classList.remove('show'), 3000);
            };
        }


        // ========================================
        // 2. RETURN/REPLACEMENT SYSTEM
        // ========================================

        function openReturnModal(dispatchId = null, customerId = null, customerName = null) {
            if (!checkPermission || !checkPermission()) return;
            const modal = document.getElementById('returnModal');
            if (!modal) { console.error('Return modal not found!'); return; }
            document.getElementById('return-form').reset();
            document.getElementById('return-dispatch-id').value = dispatchId || '';
            document.getElementById('return-customer-id').value = customerId || '';
            if (dispatchId) {
                const dispatch = appState.transactions.find(t => t.id === dispatchId);
                if (dispatch) {
                    const item = findItem(dispatch.category, dispatch.itemId);
                    document.getElementById('return-item-name').textContent = item ? item.name : 'Unknown';
                    document.getElementById('return-customer-name').value = dispatch.customerName || '';
                    document.getElementById('return-max-qty').textContent = dispatch.quantity;
                    document.getElementById('return-max-qty-value').value = dispatch.quantity;
                    document.getElementById('return-batch-no').value = dispatch.batchNo || '';
                    document.getElementById('return-invoice-no').value = dispatch.invoiceNo || '';
                    document.getElementById('return-category').value = dispatch.category;
                    document.getElementById('return-item-id').value = dispatch.itemId;
                }
            } else if (customerName) {
                document.getElementById('return-customer-name').value = customerName;
            }
            document.getElementById('return-date').value = new Date().toISOString().split('T')[0];
            openModal('returnModal');
        }

        function processReturn(event) {
            event.preventDefault();
            if (!checkPermission || !checkPermission()) return;
            const dispatchId = document.getElementById('return-dispatch-id').value;
            const customerId = document.getElementById('return-customer-id').value;
            const customerName = document.getElementById('return-customer-name').value;
            const category = document.getElementById('return-category').value;
            const itemId = document.getElementById('return-item-id').value;
            const quantity = parseFloat(document.getElementById('return-quantity').value);
            const maxQty = parseFloat(document.getElementById('return-max-qty-value').value);
            const date = document.getElementById('return-date').value;
            const reason = document.getElementById('return-reason').value;
            const batchNo = document.getElementById('return-batch-no').value;
            const invoiceNo = document.getElementById('return-invoice-no').value;
            const notes = document.getElementById('return-notes').value;
            if (!quantity || quantity <= 0) { alert('Please enter a valid quantity'); return; }
            if (maxQty && quantity > maxQty) { alert(`Return quantity cannot exceed dispatched quantity (${maxQty})`); return; }
            if (!customerName) { alert('Customer name is required'); return; }
            if (!category || !itemId) { alert('Item information is missing'); return; }
            const returnTransaction = {
                id: generateId(), type: 'sales-return', date: date, category: category, itemId: itemId,
                quantity: quantity, batchNo: batchNo || null, customerId: customerId || null, customerName: customerName,
                originalDispatchId: dispatchId || null, returnReason: reason, invoiceNo: invoiceNo || null, notes: notes || ''
            };
            appState.transactions.push(returnTransaction);
            const item = findItem(category, itemId);
            if (item && batchNo) {
                if (!item.batchStock) item.batchStock = {};
                if (!item.batchStock[batchNo]) item.batchStock[batchNo] = 0;
                item.batchStock[batchNo] += quantity;
            }
            saveData();
            if (typeof logActivity === 'function') {
                logActivity(`Return processed: ${quantity} ${item ? item.unit : ''} of ${item ? item.name : 'item'} from ${customerName} (Reason: ${reason})`);
            }
            closeModal('returnModal');
            showToast(`Return processed successfully! Stock increased by ${quantity}`, 'success');
            if (currentView) showView(currentView);
        }

        // ========================================
        // 3. FEFO EXPIRY SYSTEM  
        // ========================================

        function isBatchExpired(expiryDate) {
            if (!expiryDate) return false;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const expiry = new Date(expiryDate);
            return expiry < today;
        }

        function isBatchNearExpiry(expiryDate, daysThreshold = 30) {
            if (!expiryDate) return false;
            const today = new Date();
            const expiry = new Date(expiryDate);
            const daysUntilExpiry = Math.ceil((expiry - today) / (1000 * 60 * 60 * 24));
            return daysUntilExpiry > 0 && daysUntilExpiry <= daysThreshold;
        }

        function getBatchExpiryStatus(expiryDate) {
            if (!expiryDate) return { status: 'none', label: '', color: '' };
            if (isBatchExpired(expiryDate)) {
                return { status: 'expired', label: 'EXPIRED', color: 'red', bgColor: 'bg-red-100', textColor: 'text-red-800', borderColor: 'border-red-500' };
            }
            if (isBatchNearExpiry(expiryDate, 7)) {
                return { status: 'critical', label: 'EXPIRES IN 7 DAYS', color: 'red', bgColor: 'bg-red-50', textColor: 'text-red-700', borderColor: 'border-red-400' };
            }
            if (isBatchNearExpiry(expiryDate, 30)) {
                return { status: 'warning', label: 'EXPIRES SOON', color: 'orange', bgColor: 'bg-orange-50', textColor: 'text-orange-700', borderColor: 'border-orange-400' };
            }
            return { status: 'good', label: 'Good', color: 'green', bgColor: 'bg-green-50', textColor: 'text-green-700', borderColor: 'border-green-400' };
        }

        // ========================================
        // 4. GLOBAL SEARCH
        // ========================================

        function globalSearch(query) {
            if (!query || query.trim().length === 0) {
                return { items: [], suppliers: [], customers: [], batches: [], invoices: [] };
            }
            query = query.toLowerCase().trim();
            const results = { items: [], suppliers: [], customers: [], batches: [], invoices: [] };
            const categories = ['rawMaterials', 'packingMaterials', 'labels', 'finishedGoods'];
            const categoryNames = { 'rawMaterials': 'Raw Materials', 'packingMaterials': 'Packing Materials', 'labels': 'Labels', 'finishedGoods': 'Finished Goods' };
            categories.forEach(cat => {
                const items = appState.inventory[cat] || [];
                items.forEach(item => {
                    if (item.name.toLowerCase().includes(query) || (item.id && String(item.id).toLowerCase().includes(query))) {
                        const stockData = calculateStock ? calculateStock(item, cat, getToday()) : { closingStock: 0 };
                        results.items.push({ id: item.id, name: item.name, category: cat, categoryName: categoryNames[cat], unit: item.unit, stock: stockData.closingStock || 0, type: 'item' });
                    }
                });
            });
            const suppliers = appState.suppliers || [];
            suppliers.forEach(supplier => {
                if (supplier.name.toLowerCase().includes(query) || (supplier.contact && String(supplier.contact).toLowerCase().includes(query)) || (supplier.email && String(supplier.email).toLowerCase().includes(query))) {
                    results.suppliers.push({ id: supplier.id, name: supplier.name, contact: supplier.contact || '-', email: supplier.email || '-', type: 'supplier' });
                }
            });
            const customers = appState.customers || [];
            customers.forEach(customer => {
                if (customer.name.toLowerCase().includes(query) || (customer.contact && String(customer.contact).toLowerCase().includes(query)) || (customer.email && String(customer.email).toLowerCase().includes(query))) {
                    results.customers.push({ id: customer.id, name: customer.name, type: customer.type || '-', contact: customer.contact || '-', type: 'customer' });
                }
            });
            return results;
        }

        function renderGlobalSearchResults(results) {
            const container = document.getElementById('global-search-results');
            if (!container) return;
            const totalResults = results.items.length + results.suppliers.length + results.customers.length;
            if (totalResults === 0) {
                container.innerHTML = '<div class="p-4 text-center text-gray-500">No results found</div>';
                container.classList.remove('hidden');
                return;
            }
            let html = '<div class="max-h-96 overflow-y-auto">';
            if (results.items.length > 0) {
                html += `<div class="border-b"><div class="bg-blue-50 p-2 font-bold text-sm text-blue-800">Items (${results.items.length})</div>`;
                results.items.slice(0, 5).forEach(item => {
                    html += `<div class="p-3 hover:bg-gray-50 cursor-pointer border-b" onclick="navigateToItem('${item.category}', '${item.id}')">
                <div class="font-semibold">${item.name}</div>
                <div class="text-xs text-gray-600">${item.categoryName} • Stock: ${item.stock} ${item.unit}</div>
            </div>`;
                });
                if (results.items.length > 5) html += `<div class="p-2 text-xs text-center text-gray-500">+${results.items.length - 5} more</div>`;
                html += '</div>';
            }
            if (results.suppliers.length > 0) {
                html += `<div class="border-b"><div class="bg-green-50 p-2 font-bold text-sm text-green-800">Suppliers (${results.suppliers.length})</div>`;
                results.suppliers.slice(0, 5).forEach(supplier => {
                    html += `<div class="p-3 hover:bg-gray-50 cursor-pointer border-b" onclick="navigateToSupplier('${supplier.id}')">
                <div class="font-semibold">${supplier.name}</div>
                <div class="text-xs text-gray-600">${supplier.contact} • ${supplier.email}</div>
            </div>`;
                });
                if (results.suppliers.length > 5) html += `<div class="p-2 text-xs text-center text-gray-500">+${results.suppliers.length - 5} more</div>`;
                html += '</div>';
            }
            if (results.customers.length > 0) {
                html += `<div class="border-b"><div class="bg-purple-50 p-2 font-bold text-sm text-purple-800">Customers (${results.customers.length})</div>`;
                results.customers.slice(0, 5).forEach(customer => {
                    html += `<div class="p-3 hover:bg-gray-50 cursor-pointer border-b" onclick="navigateToCustomer('${customer.id}')">
                <div class="font-semibold">${customer.name}</div>
                <div class="text-xs text-gray-600">${customer.type || 'Customer'} • ${customer.contact}</div>
            </div>`;
                });
                if (results.customers.length > 5) html += `<div class="p-2 text-xs text-center text-gray-500">+${results.customers.length - 5} more</div>`;
                html += '</div>';
            }
            html += '</div>';
            container.innerHTML = html;
            container.classList.remove('hidden');
        }

        function navigateToItem(category, itemId) {
            closeGlobalSearch();
            const viewMap = { 'rawMaterials': 'raw-materials', 'packingMaterials': 'packing-materials', 'labels': 'labels', 'finishedGoods': 'finished-goods' };
            const view = viewMap[category];
            if (view && typeof showView === 'function') showView(view);
        }

        function navigateToSupplier(supplierId) {
            closeGlobalSearch();
            if (typeof showView === 'function') showView('suppliers');
        }

        function navigateToCustomer(customerId) {
            closeGlobalSearch();
            if (typeof showView === 'function') showView('customers');
        }

        function closeGlobalSearch() {
            const input = document.getElementById('global-search-input');
            const resultsContainer = document.getElementById('global-search-results');
            if (input) input.value = '';
            if (resultsContainer) resultsContainer.classList.add('hidden');
        }

        function initializeGlobalSearch() {
            const input = document.getElementById('global-search-input');
            if (!input) return;
            let searchTimeout;
            input.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    const query = input.value;
                    if (query.trim().length === 0) {
                        const resultsContainer = document.getElementById('global-search-results');
                        if (resultsContainer) resultsContainer.classList.add('hidden');
                        return;
                    }
                    const results = globalSearch(query);
                    renderGlobalSearchResults(results);
                }, 300);
            });
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') closeGlobalSearch();
            });
        }

        // ========================================
        // 5. BATCH TRACEABILITY PDF
        // ========================================

        function getBatchTraceabilityData(category, itemId, batchNo) {
            const item = findItem(category, itemId);
            if (!item) return null;
            const transactions = appState.transactions || [];
            const batchTransactions = transactions.filter(t => t.category === category && t.itemId === itemId && t.batchNo === batchNo);
            const produced = batchTransactions.filter(t => t.type === 'receive' || t.type === 'produce');
            const dispatched = batchTransactions.filter(t => t.type === 'dispatch');
            const wastage = batchTransactions.filter(t => t.type === 'consume' && (t.subtype === 'spillage' || t.subtype === 'expired' || t.subtype === 'qc_rejection'));
            const returns = batchTransactions.filter(t => t.type === 'sales-return');
            const totalProduced = produced.reduce((sum, t) => sum + (parseFloat(t.quantity) || 0), 0);
            const totalDispatched = dispatched.reduce((sum, t) => sum + (parseFloat(t.quantity) || 0), 0);
            const totalWastage = wastage.reduce((sum, t) => sum + (parseFloat(t.quantity) || 0), 0);
            const totalReturned = returns.reduce((sum, t) => sum + (parseFloat(t.quantity) || 0), 0);
            const remainingStock = item.batchStock && item.batchStock[batchNo] ? item.batchStock[batchNo] : 0;
            const customerSet = new Set();
            dispatched.forEach(d => { if (d.customerName) customerSet.add(d.customerName); });
            const customers = Array.from(customerSet);
            const batchMeta = item.batchMeta && item.batchMeta[batchNo] ? item.batchMeta[batchNo] : {};
            return {
                item: { name: item.name, unit: item.unit, category: category },
                batchNo: batchNo, batchMeta: batchMeta,
                produced: { transactions: produced, total: totalProduced },
                dispatched: { transactions: dispatched, total: totalDispatched },
                wastage: { transactions: wastage, total: totalWastage },
                returns: { transactions: returns, total: totalReturned },
                customers: customers, remainingStock: remainingStock
            };
        }

        async function generateBatchTraceabilityPDF(category, itemId, batchNo) {
            if (!window.jspdf || !window.jspdf.jsPDF) { alert('jsPDF library not loaded!'); return; }
            const data = getBatchTraceabilityData(category, itemId, batchNo);
            if (!data) { alert('Batch data not found!'); return; }
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            const margin = 15;
            let yPos = margin;
            doc.setFillColor(79, 70, 229);
            doc.rect(0, 0, pageWidth, 35, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(20);
            doc.setFont('helvetica', 'bold');
            doc.text('BATCH TRACEABILITY REPORT', pageWidth / 2, 15, { align: 'center' });
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text('MIKLENS INVENTORY MANAGEMENT', pageWidth / 2, 25, { align: 'center' });
            yPos = 45;
            doc.setTextColor(0, 0, 0);
            doc.text(`Generated: ${new Date().toLocaleString()}`, margin, yPos);
            yPos += 10;
            doc.setFillColor(240, 240, 255);
            doc.roundedRect(margin, yPos, pageWidth - 2 * margin, 35, 3, 3, 'F');
            yPos += 8;
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('Batch Information', margin + 5, yPos);
            yPos += 7;
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text(`Item: ${data.item.name}`, margin + 5, yPos);
            yPos += 6;
            doc.text(`Batch Number: ${data.batchNo}`, margin + 5, yPos);
            yPos += 6;
            doc.text(`Category: ${data.item.category}`, margin + 5, yPos);
            yPos += 6;
            if (data.batchMeta.expiry) { doc.text(`Expiry Date: ${data.batchMeta.expiry}`, margin + 5, yPos); }
            yPos += 12;
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(14);
            doc.text('Summary', margin, yPos);
            yPos += 8;
            const summaryData = [
                ['Total Produced/Received', `${data.produced.total.toFixed(2)} ${data.item.unit}`],
                ['Total Dispatched', `${data.dispatched.total.toFixed(2)} ${data.item.unit}`],
                ['Total Wastage', `${data.wastage.total.toFixed(2)} ${data.item.unit}`],
                ['Total Returned', `${data.returns.total.toFixed(2)} ${data.item.unit}`],
                ['Remaining Stock', `${data.remainingStock.toFixed(2)} ${data.item.unit}`]
            ];
            doc.autoTable({
                startY: yPos,
                head: [['Description', 'Quantity']],
                body: summaryData,
                theme: 'grid',
                headStyles: { fillColor: [79, 70, 229], textColor: [255, 255, 255] },
                margin: { left: margin, right: margin },
                styles: { fontSize: 10 }
            });
            const fileName = `Batch_Trace_${data.batchNo}_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(fileName);
            showToast('Batch traceability report generated successfully!', 'success');
        }

        function renderProductTraceView() {
            const container = document.getElementById('product-trace-view');
            if (!container) return;
            const categories = ['rawMaterials', 'packingMaterials', 'labels', 'finishedGoods'];
            const itemsWithBatches = [];
            categories.forEach(cat => {
                const items = appState.inventory[cat] || [];
                items.forEach(item => {
                    if (item.batchStock) {
                        Object.keys(item.batchStock).forEach(batchNo => {
                            if (item.batchStock[batchNo] > 0 || true) {
                                itemsWithBatches.push({
                                    category: cat, itemId: item.id, itemName: item.name, unit: item.unit,
                                    batchNo: batchNo, quantity: item.batchStock[batchNo] || 0,
                                    expiry: item.batchMeta && item.batchMeta[batchNo] ? item.batchMeta[batchNo].expiry : null
                                });
                            }
                        });
                    }
                });
            });
            container.innerHTML = `
        <h2 class="text-3xl font-bold mb-6">Product Trace & Batch Traceability</h2>
        <div class="bg-white p-6 rounded-lg shadow mb-6">
            <h3 class="text-xl font-bold mb-4">Select Batch for Traceability Report</h3>
            <p class="text-sm text-gray-600 mb-4">Choose a batch to generate a comprehensive traceability report (PDF)</p>
            ${itemsWithBatches.length === 0 ? `<div class="text-center p-8 text-gray-500"><p class="text-lg">No batches found</p></div>` : `
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white border text-sm">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-2 border text-left">Item Name</th>
                                <th class="p-2 border text-left">Batch Number</th>
                                <th class="p-2 border text-right">Current Stock</th>
                                <th class="p-2 border text-left">Expiry Date</th>
                                <th class="p-2 border text-center">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemsWithBatches.map(b => {
                const expiryStatus = getBatchExpiryStatus(b.expiry);
                return `<tr class="hover:bg-gray-50">
                                    <td class="p-2 border font-semibold">${b.itemName}</td>
                                    <td class="p-2 border font-mono text-xs">${b.batchNo}</td>
                                    <td class="p-2 border text-right font-bold">${b.quantity.toFixed(2)} ${b.unit}</td>
                                    <td class="p-2 border">${b.expiry ? `<span class="px-2 py-1 rounded text-xs font-bold ${expiryStatus.bgColor} ${expiryStatus.textColor}">${b.expiry} ${expiryStatus.label}</span>` : '-'}</td>
                                    <td class="p-2 border text-center">
                                        <button onclick="generateBatchTraceabilityPDF('${b.category}', '${b.itemId}', '${b.batchNo}')" class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 text-sm font-bold">Generate PDF</button>
                                    </td>
                                </tr>`;
            }).join('')}
                        </tbody>
                    </table>
                </div>
            `}
        </div>
    `;
        };
        // ============================================
        // IMPORTED FEATURES FROM TEST 2.HTML
        // (Product Traceability, BOM View, Auto-Allocation)
        // ============================================

        window.openBatchBOMModal = function (batchId) {
            const batch = appState.activeProduction.find(b => b.id == batchId);
            if (!batch) return;

            // Check if modal exists, if not create it dynamically (missing in some versions)
            if (!document.getElementById('viewBatchBOMModal')) {
                const modalHTML = `
                < div id = "viewBatchBOMModal" class="modal fixed inset-0 bg-black bg-opacity-50 justify-center items-center z-50" >
                    <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-2xl">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold">Batch BOM & Reservations</h3>
                            <button onclick="closeModal('viewBatchBOMModal')" class="text-gray-500 hover:text-gray-800">&times;</button>
                        </div>
                        <div class="mb-4 bg-gray-50 p-3 rounded border">
                            <p class="font-bold text-lg" id="bom-batch-info"></p>
                            <input type="hidden" id="bom-batch-id">
                        </div>

                        <div class="flex gap-2 mb-4 p-4 bg-blue-50 rounded border border-blue-100">
                            <div class="flex-1">
                                <label class="block text-xs font-bold text-gray-700 uppercase">Category</label>
                                <select id="bom-add-cat" class="w-full p-1 border rounded" onchange="updateBomItemSelect()">
                                    <option value="rawMaterials">Raw Materials</option>
                                    <option value="packingMaterials">Packing Materials</option>
                                    <option value="labels">Labels</option>
                                </select>
                            </div>
                            <div class="flex-[2]">
                                <label class="block text-xs font-bold text-gray-700 uppercase">Item</label>
                                <select id="bom-add-item" class="w-full p-1 border rounded"></select>
                            </div>
                            <div class="w-24">
                                <label class="block text-xs font-bold text-gray-700 uppercase">Qty</label>
                                <input type="number" id="bom-add-qty" class="w-full p-1 border rounded" step="any">
                            </div>
                            <div class="flex items-end">
                                <button onclick="addBatchMaterial()" class="px-3 py-1 bg-blue-600 text-white rounded font-bold hover:bg-blue-700">Add</button>
                            </div>
                        </div>

                        <div class="overflow-y-auto max-h-64">
                            <table class="min-w-full text-sm">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="p-2 text-left">Item</th>
                                        <th class="p-2 text-center">Type</th>
                                        <th class="p-2 text-right">Reserved Qty</th>
                                        <th class="p-2 text-center">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="bom-list-rows"></tbody>
                            </table>
                        </div>
                    </div>
        </div > `;
                document.body.insertAdjacentHTML('beforeend', modalHTML);
            }

            document.getElementById('bom-batch-id').value = batch.id;
            document.getElementById('bom-batch-info').textContent = `Ref: ${batch.batchNo} | Target: ${batch.targetQty} `;

            updateBomItemSelect();
            renderBomList(batch);
            openModal('viewBatchBOMModal');
        };

        function renderBomList(batch) {
            const tbody = document.getElementById('bom-list-rows');
            if (!tbody) return;
            tbody.innerHTML = '';

            if (!batch.reservedData) return;

            const addRows = (list, cat, typeLabel) => {
                (list || []).forEach((item, idx) => {
                    const invItem = appState.inventory[cat].find(i => i.id == item.itemId);
                    const tr = document.createElement('tr');
                    tr.className = 'border-b hover:bg-gray-50';
                    tr.innerHTML = `
                <td class="p-2">${invItem ? invItem.name : 'Unknown Item'}</td>
                <td class="p-2 text-center text-xs uppercase text-gray-500">${typeLabel}</td>
                <td class="p-2 text-right font-mono font-bold">${item.quantity.toFixed(3)}</td>
                <td class="p-2 text-center">
                    <span class="text-xs text-gray-400">Reserved</span>
                </td>
            `;
                    tbody.appendChild(tr);
                });
            };

            addRows(batch.reservedData.rawMaterials, 'rawMaterials', 'Raw');
            addRows(batch.reservedData.packingMaterials, 'packingMaterials', 'Pkg');
            addRows(batch.reservedData.labels, 'labels', 'Label');
        }

        window.updateBomItemSelect = function () {
            const catEl = document.getElementById('bom-add-cat');
            const select = document.getElementById('bom-add-item');
            if (!catEl || !select) return;

            const cat = catEl.value;
            select.innerHTML = '<option value="">Select Item</option>';

            (appState.inventory[cat] || []).forEach(item => {
                const opt = document.createElement('option');
                opt.value = item.id;
                opt.textContent = `${item.name} (Avl: ${calculateAvailable(item, cat)
                    })`;
                select.appendChild(opt);
            });
        };

        function calculateAvailable(item, cat) {
            let stock = 0;
            // Check if calculateStock exists, otherwise use basic stock
            if (typeof calculateStock === 'function') {
                stock = calculateStock(item, cat, getToday()).closingStock;
            } else {
                stock = item.stock || 0; // Fallback
            }

            if (typeof getReservedStock === 'function') stock -= getReservedStock(item, cat);
            return stock.toFixed(2);
        }

        window.addBatchMaterial = function () {
            const batchId = document.getElementById('bom-batch-id').value;
            const cat = document.getElementById('bom-add-cat').value;
            const itemId = document.getElementById('bom-add-item').value;
            const qty = parseFloat(document.getElementById('bom-add-qty').value);

            if (!batchId || !itemId || !qty || qty <= 0) { alert("Invalid Input"); return; }

            const batch = appState.activeProduction.find(b => b.id == batchId);
            if (!batch) return;

            // Log Transaction
            appState.transactions.push({
                id: Date.now(),
                type: 'production-reserve',
                category: cat,
                itemId: parseInt(itemId),
                quantity: qty,
                date: new Date().toISOString(),
                batchNo: batch.batchNo,
                notes: "Manual Addition to WIP"
            });

            // Update Batch Data
            if (!batch.reservedData) batch.reservedData = { rawMaterials: [], packingMaterials: [], labels: [] };
            if (!batch.reservedData[cat]) batch.reservedData[cat] = [];

            const existing = batch.reservedData[cat].find(i => i.itemId == itemId);
            if (existing) {
                existing.quantity += qty;
            } else {
                batch.reservedData[cat].push({ itemId: parseInt(itemId), quantity: qty });
            }

            if (window.saveState) window.saveState();
            renderBomList(batch);
            alert("Material Added & Reserved Successfully");

            if (window.renderProductionWIPView) renderProductionWIPView();
        };

        // ============================================
        // PRODUCT TRACEABILITY VIEW & LOGIC (From TEST 2)
        // ============================================

        window.openProductTrace = function (productId) {
            // Permission check if exists
            if (typeof checkPermission === 'function' && !checkPermission()) return;

            // Ensure ID type
            const id = parseFloat(productId);

            // Helper to find item if findItem not globally available
            const findItemFn = window.findItem || ((cat, id) => appState.inventory[cat].find(i => i.id == id));

            const item = findItemFn('finishedGoods', id);

            if (!item) {
                alert("Product not found or not a Finished Good.");
                return;
            }

            // Make sure we switch to trace view
            if (window.showView) {
                window.showView('product-trace');
            } else {
                console.error("showView function missing");
            }

            renderProductTraceView(item);
        };

        window.renderProductTraceView = function (item) {
            const container = document.getElementById('product-trace-view');
            if (container) container.innerHTML = '<div class="p-8 text-center text-gray-500">Product trace is disabled.</div>';
            return;
        };
        window.original_renderProductTraceView_V7 = function (item) {

            // 1. Calculate Summary Stats
            let stock = { closingStock: 0 };
            if (typeof calculateStock === 'function') {
                stock = calculateStock(item, 'finishedGoods', getToday());
            } else {
                stock.closingStock = item.stock || 0;
            }

            const totalProduced = appState.transactions
                .filter(t => t.itemId == item.id && t.category === 'finishedGoods' && t.type === 'production-add')
                .reduce((acc, t) => acc + t.quantity, 0);

            const totalDispatched = appState.transactions
                .filter(t => t.itemId == item.id && t.category === 'finishedGoods' && t.type === 'dispatch')
                .reduce((acc, t) => acc + t.quantity, 0);

            // 2. Group Batches
            const batchMap = new Map();

            appState.transactions
                .filter(t => t.itemId == item.id && t.category === 'finishedGoods')
                .forEach(t => {
                    const batchKey = t.batchNo || 'OPENING_STOCK';

                    if (!batchMap.has(batchKey)) {
                        batchMap.set(batchKey, {
                            id: batchKey,
                            mfg: batchKey === 'OPENING_STOCK' ? 'N/A' : 'N/A',
                            exp: 'N/A',
                            produced: batchKey === 'OPENING_STOCK' ? (item.openingStock || 0) : 0,
                            dispatched: 0,
                            balance: batchKey === 'OPENING_STOCK' ? (item.openingStock || 0) : 0,
                            firstDate: batchKey === 'OPENING_STOCK' ? (item.openingStockDate || t.date) : t.date
                        });
                    }
                    const batch = batchMap.get(batchKey);

                    if (t.type === 'production-add' || t.type === 'receive') {
                        if (batchKey !== 'OPENING_STOCK') {
                            batch.produced += t.quantity;
                        }
                        if (t.mfgDate) batch.mfg = t.mfgDate;
                        if (t.expDate || t.expiryDate) batch.exp = t.expDate || t.expiryDate;
                        if (new Date(t.date) < new Date(batch.firstDate)) batch.firstDate = t.date;
                    } else if (t.type === 'dispatch') {
                        batch.dispatched += t.quantity;
                    }

                    if (['production-add', 'receive', 'stock-take-adj-in'].includes(t.type)) {
                        if (batchKey !== 'OPENING_STOCK') {
                            batch.balance += t.quantity;
                        }
                    } else if (['dispatch', 'consume', 'stock-take-adj-out', 'production-consume'].includes(t.type)) {
                        batch.balance -= t.quantity;
                    }
                });

            const batches = Array.from(batchMap.values()).sort((a, b) => new Date(b.firstDate) - new Date(a.firstDate));

            container.innerHTML = `
            < div class="h-full flex flex-col" >
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-4">
                    <button onclick="showView('finishedGoods')" class="text-gray-500 hover:text-gray-800">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                    </button>
                    <h2 class="text-3xl font-bold flex items-center gap-2">
                        Traceability: <span class="text-blue-600">${item.name}</span>
                    </h2>
                </div>
                <div class="text-sm font-mono bg-gray-100 p-2 rounded">Product ID: ${item.id}</div>
            </div>

            <!-- Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-blue-50 p-6 rounded-lg border border-blue-100">
                    <h3 class="font-bold text-blue-800 mb-1">Current Stock</h3>
                    <p class="text-3xl font-bold text-blue-900">${stock.closingStock.toFixed(3)} <span class="text-sm text-blue-600">${item.unit}</span></p>
                </div>
                 <div class="bg-green-50 p-6 rounded-lg border border-green-100">
                    <h3 class="font-bold text-green-800 mb-1">Total Produced</h3>
                    <p class="text-3xl font-bold text-green-900">${totalProduced.toFixed(3)}</p>
                </div>
                <div class="bg-purple-50 p-6 rounded-lg border border-purple-100">
                    <h3 class="font-bold text-purple-800 mb-1">Total Dispatched</h3>
                    <p class="text-3xl font-bold text-purple-900">${totalDispatched.toFixed(3)}</p>
                </div>
                 <div class="bg-yellow-50 p-6 rounded-lg border border-yellow-100">
                     <h3 class="font-bold text-yellow-800 mb-1">Batches Tracked</h3>
                     <p class="text-3xl font-bold text-yellow-900">${batches.length}</p>
                 </div>
            </div>

            <div class="flex flex-col md:flex-row gap-6 h-full">
                <!-- Batch Timeline (Left) -->
                <div class="w-full md:w-1/3 bg-white rounded-lg shadow overflow-hidden flex flex-col">
                    <div class="p-4 bg-gray-50 border-b">
                        <h3 class="font-bold text-lg">Batch Timeline</h3>
                        <p class="text-xs text-gray-500">Select a batch to view detailed trace</p>
                    </div>
                    <div class="overflow-y-auto flex-1 h-[600px]">
                        <table class="min-w-full text-sm">
                            <thead class="bg-white sticky top-0 z-10 shadow-sm">
                                <tr>
                                    <th class="p-3 text-left">Batch ID</th>
                                    <th class="p-3 text-right">Produced</th>
                                    <th class="p-3 text-right">Balance</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${batches.map(b => `
                                    <tr class="hover:bg-blue-50 cursor-pointer border-b transition-colors" onclick="renderBatchTraceDetails('${item.id}', '${b.id}')">
                                        <td class="p-3">
                                            <div class="font-bold font-mono text-blue-600">${b.id}</div>
                                            <div class="text-xs text-gray-500">MFG: ${b.mfg || '-'}</div>
                                        </td>
                                        <td class="p-3 text-right font-medium">${b.produced.toFixed(3)}</td>
                                        <td class="p-3 text-right font-bold ${b.balance > 0 ? 'text-green-600' : 'text-gray-400'}">${b.balance.toFixed(3)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Detailed Trace (Right) -->
                <div class="w-full md:w-2/3 bg-white rounded-lg shadow overflow-hidden flex flex-col" id="batch-trace-detail-container">
                    <div class="flex flex-col items-center justify-center h-full text-gray-400 p-10">
                        <p class="text-lg font-medium">Select a batch from the timeline to view full traceability details.</p>
                    </div>
                </div>
            </div>
        </div >
            `;
        };

        window.renderBatchTraceDetails = function (itemIdStr, batchId) {
            const container = document.getElementById('batch-trace-detail-container');
            const itemId = parseFloat(itemIdStr);

            // Safely get transactions
            const txs = appState.transactions || [];

            // Helper to find item safely
            const findItemFn = window.findItem || ((cat, id) => appState.inventory[cat].find(i => i.id == id));

            const productionTxs = txs.filter(t => t.category === 'finishedGoods' && t.itemId == itemId && (t.batchNo === batchId || (batchId === 'OPENING_STOCK' && !t.batchNo)) && t.type === 'production-add');
            const dispatchTxs = txs.filter(t => t.category === 'finishedGoods' && t.itemId == itemId && (t.batchNo === batchId || (batchId === 'OPENING_STOCK' && !t.batchNo)) && t.type === 'dispatch');

            const consumptionTxs = txs.filter(t =>
                (t.type === 'production-consume' || t.type === 'consume') &&
                (t.relatedBatchId === batchId || t.fgBatchId === batchId)
            );

            container.innerHTML = `
            < div class="h-full flex flex-col bg-gray-50" >
            <div class="p-4 bg-white border-b shadow-sm flex justify-between items-center">
                <h3 class="font-bold text-xl text-gray-800">Batch Details: <span class="text-blue-600 font-mono">${batchId}</span></h3>
                <div class="text-xs text-gray-500">
                    Produced: ${productionTxs.reduce((a, t) => a + t.quantity, 0).toFixed(3)} |
                    Dispatched: ${dispatchTxs.reduce((a, t) => a + t.quantity, 0).toFixed(3)}
                </div>
            </div>
            
            <div class="flex-1 overflow-y-auto p-6 space-y-6">
                <!-- 1. Production / Inflow -->
                <div class="bg-white rounded-lg shadow p-4 border-l-4 border-green-500">
                     <h4 class="font-bold text-gray-700 mb-3">Production / Receipt</h4>
                     <table class="min-w-full text-sm">
                        <thead class="bg-gray-50 text-xs uppercase"><tr><th class="p-2 text-left">Date</th><th class="p-2 text-right">Qty</th><th class="p-2 text-left">MFG / EXP</th><th class="p-2 text-left">Notes</th></tr></thead>
                        <tbody>
                            ${productionTxs.length ? productionTxs.map(t => `
                                <tr class="border-b">
                                    <td class="p-2">${t.date.split('T')[0]}</td>
                                    <td class="p-2 text-right font-bold text-green-600">+${t.quantity}</td>
                                    <td class="p-2 text-xs">${t.mfgDate || '-'} / ${t.expDate || t.expiryDate || '-'}</td>
                                    <td class="p-2 text-xs text-gray-500">${t.notes || '-'}</td>
                                </tr>
                            `).join('') : '<tr><td colspan="4" class="p-2 text-gray-400 italic">No production record found</td></tr>'}
                        </tbody>
                     </table>
                </div>

                <!-- 2. Consumption (Ingredients) -->
                <div class="bg-white rounded-lg shadow p-4 border-l-4 border-yellow-500">
                     <h4 class="font-bold text-gray-700 mb-3">Ingredients Consumed</h4>
                     ${consumptionTxs.length === 0 ?
                    `<div class="p-4 bg-yellow-50 text-yellow-800 text-sm rounded">No linked material consumption found.</div>` :
                    `<table class="min-w-full text-sm">
                            <thead class="bg-gray-50 text-xs uppercase"><tr><th class="p-2 text-left">Item</th><th class="p-2 text-right">Qty</th><th class="p-2 text-left">Source Batch</th><th class="p-2 text-left">Wastage</th></tr></thead>
                            <tbody>
                                ${consumptionTxs.map(t => {
                        const item = findItemFn(t.category, t.itemId);
                        return `<tr class="border-b">
                                        <td class="p-2">${item ? item.name : 'Unknown'}</td>
                                        <td class="p-2 text-right font-bold text-red-600">${t.quantity}</td>
                                        <td class="p-2 text-xs font-mono">${t.batchNo || 'FIFO'}</td>
                                        <td class="p-2 text-xs">${t.wastage || 0}</td>
                                    </tr>`;
                    }).join('')}
                            </tbody>
                        </table>`
                }
                </div>

                <!-- 3. Dispatch / Customers -->
                 <div class="bg-white rounded-lg shadow p-4 border-l-4 border-purple-500">
                     <h4 class="font-bold text-gray-700 mb-3">Dispatched To</h4>
                     <table class="min-w-full text-sm">
                        <thead class="bg-gray-50 text-xs uppercase"><tr><th class="p-2 text-left">Date</th><th class="p-2 text-left">Customer</th><th class="p-2 text-right">Qty</th><th class="p-2 text-left">Invoice</th></tr></thead>
                        <tbody>
                            ${dispatchTxs.length ? dispatchTxs.map(t => {
                    const cust = (appState.customers || []).find(c => c.id == t.customerId);
                    return `<tr class="border-b">
                                    <td class="p-2">${t.date.split('T')[0]}</td>
                                    <td class="p-2 font-medium">${cust ? cust.name : 'Unknown'}</td>
                                    <td class="p-2 text-right font-bold text-purple-600">-${t.quantity}</td>
                                    <td class="p-2 text-xs">${t.invoiceNo || '-'}</td>
                                </tr>`;
                }).join('') : '<tr><td colspan="4" class="p-2 text-gray-400 italic">No dispatches yet.</td></tr>'}
                        </tbody>
                     </table>
                </div>
            </div>
        </div >
            `;
        };

        // AUTO ALLOCATION HELPER (FIFO / FEFO)
        window.allocateStock = function (item, category, quantityNeeded, mode = 'FIFO') {
            const batchStock = {};
            const batchMeta = {};

            appState.transactions.filter(t => t.itemId == item.id && t.category === category).forEach(t => {
                const batch = t.batchNo || 'Unassigned';
                if (!batchStock[batch]) {
                    batchStock[batch] = 0;
                    batchMeta[batch] = { firstDate: t.date, expiry: null };
                }

                if (['receive', 'produce', 'stock-take-adj-in', 'production-add'].includes(t.type)) {
                    batchStock[batch] += t.quantity;
                    if (t.expDate || t.expiryDate) batchMeta[batch].expiry = t.expDate || t.expiryDate;
                } else if (['consume', 'dispatch', 'stock-take-adj-out', 'production-consume'].includes(t.type)) {
                    batchStock[batch] -= t.quantity;
                }
            });

            let availableBatches = Object.keys(batchStock)
                .map(b => ({
                    batchNo: b,
                    quantity: batchStock[b],
                    expiry: batchMeta[b]?.expiry,
                    firstDate: batchMeta[b]?.firstDate
                }))
                .filter(b => b.quantity > 0.0001);

            if (mode === 'FEFO') {
                availableBatches.sort((a, b) => {
                    if (a.expiry && b.expiry) return new Date(a.expiry) - new Date(b.expiry);
                    if (a.expiry && !b.expiry) return -1;
                    if (!a.expiry && b.expiry) return 1;
                    return new Date(a.firstDate) - new Date(b.firstDate);
                });
            } else {
                availableBatches.sort((a, b) => new Date(a.firstDate) - new Date(b.firstDate));
            }

            const allocation = [];
            let remaining = quantityNeeded;

            for (const batch of availableBatches) {
                if (remaining <= 0) break;
                const take = Math.min(remaining, batch.quantity);
                allocation.push({
                    batchNo: batch.batchNo === 'Unassigned' ? null : batch.batchNo,
                    quantity: take
                });
                remaining -= take;
            }

            if (remaining > 0.0001) {
                allocation.push({ batchNo: null, quantity: remaining });
            }

            return allocation;
        };

        // ============================================
        // MISSING FEATURE RESTORATION (Calculator, Selects)
        // ============================================

        window.populateDispatchBatchSelect = function () {
            const itemSelect = document.getElementById('dispatch-item');
            const batchSelect = document.getElementById('dispatch-batch');
            if (!itemSelect || !batchSelect) return;

            const itemId = itemSelect.value;
            batchSelect.innerHTML = '<option value="">Auto-Assign (FIFO)</option>';

            if (!itemId) return;

            // Find batches with stock
            const item = (window.findItem && window.findItem('finishedGoods', itemId)) ||
                (appState.inventory.finishedGoods || []).find(i => i.id == itemId);

            if (!item || !item.batchStock) return;

            Object.keys(item.batchStock).forEach(batchNo => {
                const qty = item.batchStock[batchNo];
                if (qty > 0) {
                    const expiry = item.batchMeta && item.batchMeta[batchNo] ? item.batchMeta[batchNo].expiry : null;
                    const opt = document.createElement('option');
                    opt.value = batchNo;
                    opt.textContent = `${batchNo} (Qty: ${qty}) ${expiry ? '- Exp: ' + expiry : ''} `;
                    batchSelect.appendChild(opt);
                }
            });
        };

        window.renderCalculatorView = function () {
            const container = document.getElementById('calculator-view');
            if (!container) return;

            // Initialize overrides if not present
            if (!window.calculatorOverrides) window.calculatorOverrides = {};

            container.innerHTML = `
            <div class="p-6 max-w-4xl mx-auto">
            <h2 class="text-3xl font-bold mb-6 text-gray-800">Cost Calculator</h2>
            <div class="bg-white p-6 rounded-lg shadow border-t-4 border-blue-600">
                <p class="mb-4 text-gray-600">Quickly estimate production costs for a specific quantity.</p>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                         <label class="block text-sm font-bold text-gray-700 mb-1">Select Formulation</label>
                         <select id="calc-formulation-select" class="w-full p-2 border rounded" onchange="calculateCostEstimate()">
                            <option value="">-- Select Product --</option>
                            ${(appState.formulas || []).map(f => `<option value="${f.id}">${f.name}</option>`).join('')}
                         </select>
                    </div>
                    <div>
                         <label class="block text-sm font-bold text-gray-700 mb-1">Target Quantity</label>
                         <div class="flex">
                             <input type="number" id="calc-qty" class="w-full p-2 border rounded-l" value="1000" oninput="calculateCostEstimate()">
                             <span class="p-2 bg-gray-100 border border-l-0 rounded-r font-bold text-gray-500" id="calc-unit-display">L/Kg</span>
                         </div>
                    </div>
                </div>
                
                <div id="calc-result-area" class="hidden animate-fade-in">
                    <div class="bg-blue-50 p-4 rounded mb-4">
                        <div class="grid grid-cols-3 gap-4 text-center">
                             <div>
                                <div class="text-xs text-blue-500 uppercase font-bold">Total Cost</div>
                                <div class="text-2xl font-bold text-blue-900" id="calc-total-cost">₹0.00</div>
                             </div>
                             <div>
                                <div class="text-xs text-blue-500 uppercase font-bold">Cost Per Unit</div>
                                <div class="text-2xl font-bold text-blue-900" id="calc-unit-cost">₹0.00</div>
                             </div>
                             <div>
                                <div class="text-xs text-blue-500 uppercase font-bold">Material Cost</div>
                                <div class="text-xl font-bold text-gray-700" id="calc-material-cost">₹0.00</div>
                             </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="font-bold text-sm text-gray-500 uppercase">Breakdown</h4>
                        <button onclick="downloadCostCalculation()" class="text-sm bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700 flex items-center gap-2">
                             <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                             Download Detailed Plan
                        </button>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="min-w-full text-sm">
                            <thead class="bg-gray-100"><tr><th class="p-2 text-left">Item</th><th class="p-2 text-right">Required</th><th class="p-2 text-right">Rate</th><th class="p-2 text-right">Cost</th></tr></thead>
                            <tbody id="calc-details-body"></tbody>
                        </table>
                    </div>
                    <p class="text-xs text-gray-400 mt-2 italic">* Rates customized in this view do not affect main inventory prices.</p>
                </div>
            </div>
        </div>
            `;
        };

        window.calculateCostEstimate = function () {
            const formId = document.getElementById('calc-formulation-select').value;
            const qty = parseFloat(document.getElementById('calc-qty').value) || 0;
            const resultArea = document.getElementById('calc-result-area');

            // Ensure overrides object exists for this formula
            if (!window.calculatorOverrides) window.calculatorOverrides = {};
            if (!window.calculatorOverrides[formId]) window.calculatorOverrides[formId] = {};

            if (!formId || qty <= 0) {
                resultArea.classList.add('hidden');
                return;
            }

            const formula = appState.formulas.find(f => f.id == formId);
            if (!formula) return;

            document.getElementById('calc-unit-display').textContent = formula.outputUnit;

            // Scale factor
            const scale = qty / formula.baseQuantity; // Assuming baseQuantity is outputQty
            // Or if outputQty is the base, use that. Let's start with outputQty if baseQuantity undefined?
            const baseQty = formula.baseQuantity || formula.outputQty || 1;
            const finalScale = qty / baseQty;

            let totalMaterialCost = 0;
            let rows = '';

            const findItemFn = window.findItem || ((cat, id) => appState.inventory[cat].find(i => i.id == id));

            // Calculate RM Cost
            if (formula.ingredients) {
                formula.ingredients.forEach(ing => {
                    const item = findItemFn('rawMaterials', ing.itemId);
                    if (item) {
                        const req = ing.quantity * finalScale;

                        // CHECK FOR OVERRIDE
                        let rate = parseFloat(item.currentAverageCost) || parseFloat(item.price) || 0;
                        let isOverridden = false;
                        if (window.calculatorOverrides[formId][ing.itemId] !== undefined) {
                            rate = window.calculatorOverrides[formId][ing.itemId];
                            isOverridden = true;
                        }

                        const cost = req * rate;
                        totalMaterialCost += cost;

                        rows += `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="p-2">${item.name}</td>
                        <td class="p-2 text-right">${req.toFixed(3)} ${item.unit}</td>
                        <td class="p-2 text-right flex items-center justify-end gap-2">
                            <span class="${isOverridden ? 'font-bold text-blue-600 bg-blue-50 px-1 rounded' : ''}">
                                ${rate.toFixed(2)}
                            </span>
                            <button onclick="editCalcCost('${formId}', '${ing.itemId}', ${rate})" 
                                class="text-gray-500 hover:text-blue-600 p-1 rounded hover:bg-gray-100" title="Edit Rate">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                            </button>
                        </td>
                        <td class="p-2 text-right font-bold">₹${cost.toFixed(2)}</td>
                    </tr>`;
                    }
                });
            }

            // Add Packing Materials loop if present in logic (usually good practice to be consistent with main cost calc)
            // NOTE: Original code only had ingredients in `calculateCostEstimate`, so sticking to that for now unless user asked otherwise 
            // or if I see it in `calculateItemCost`. `calculateItemCost` DOES use packingMaterials. 
            // I should add packing/labels to be consistent with `calculateItemCost` for ACCURACY.

            ['packingMaterials', 'labels'].forEach(cat => {
                if (formula[cat]) {
                    formula[cat].forEach(comp => {
                        const item = findItemFn(cat, comp.itemId);
                        if (item) {
                            const req = comp.quantity * finalScale;

                            let rate = parseFloat(item.currentAverageCost) || parseFloat(item.price) || 0;
                            let isOverridden = false;
                            if (window.calculatorOverrides[formId][comp.itemId] !== undefined) {
                                rate = window.calculatorOverrides[formId][comp.itemId];
                                isOverridden = true;
                            }

                            const cost = req * rate;
                            totalMaterialCost += cost;

                            rows += `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="p-2">${item.name} <span class="text-xs text-gray-400">(${cat === 'packingMaterials' ? 'PM' : 'LBL'})</span></td>
                        <td class="p-2 text-right">${req.toFixed(3)} ${item.unit}</td>
                        <td class="p-2 text-right flex items-center justify-end gap-2">
                             <span class="${isOverridden ? 'font-bold text-blue-600 bg-blue-50 px-1 rounded' : ''}">
                                ${rate.toFixed(2)}
                            </span>
                             <button onclick="editCalcCost('${formId}', '${comp.itemId}', ${rate})" 
                                class="text-gray-500 hover:text-blue-600 p-1 rounded hover:bg-gray-100" title="Edit Rate">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                            </button>
                        </td>
                        <td class="p-2 text-right font-bold">₹${cost.toFixed(2)}</td>
                    </tr>`;
                        }
                    });
                }
            });

            document.getElementById('calc-total-cost').textContent = '₹' + totalMaterialCost.toFixed(2);
            document.getElementById('calc-unit-cost').textContent = '₹' + (qty > 0 ? (totalMaterialCost / qty).toFixed(2) : '0.00');
            document.getElementById('calc-material-cost').textContent = '₹' + totalMaterialCost.toFixed(2);
            document.getElementById('calc-details-body').innerHTML = rows;

            resultArea.classList.remove('hidden');
        };

        window.editCalcCost = function (formId, itemId, currentRate) {
            const newRate = prompt("Enter manual realistic cost per unit for this calculation:", currentRate);
            if (newRate !== null) {
                const parsed = parseFloat(newRate);
                if (!isNaN(parsed) && parsed >= 0) {
                    // Save to overrides
                    if (!window.calculatorOverrides) window.calculatorOverrides = {};
                    if (!window.calculatorOverrides[formId]) window.calculatorOverrides[formId] = {};
                    window.calculatorOverrides[formId][itemId] = parsed;

                    // Re-calc
                    calculateCostEstimate();
                } else {
                    alert("Invalid price!");
                }
            }
        };

        window.downloadCostCalculation = function () {
            if (!window.XLSX) { alert("XLSX lib not found"); return; }

            const formId = document.getElementById('calc-formulation-select').value;
            const qty = parseFloat(document.getElementById('calc-qty').value) || 0;
            const formula = appState.formulas.find(f => f.id == formId);
            if (!formula) return;

            // Extract data from the TABLE itself to be sure we get what is shown (including overrides)
            const rows = document.querySelectorAll('#calc-details-body tr');
            const data = [];

            rows.forEach(r => {
                const cells = r.querySelectorAll('td');
                if (cells.length > 3) {
                    data.push({
                        'Item Name': cells[0].innerText.trim(),
                        'Quantity': cells[1].innerText.trim(),
                        'Rate': cells[2].innerText.trim(), // Will contain the value shown
                        'Cost': cells[3].innerText.trim()
                    });
                }
            });

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(data);

            // Add header info? maybe simple append
            XLSX.utils.book_append_sheet(wb, ws, "CostPlan");

            XLSX.writeFile(wb, `${formula.name}_ProductionPlan_${qty}${formula.outputUnit}.xlsx`);
        };

        window.loadFormulaIntoCalc = function (formulaId) {
            const select = document.getElementById('calc-formulation-select');
            if (select) {
                select.value = formulaId;
                calculateCostEstimate();
            }
        };

        function restoreMissingDropdowns() {
            // 1. Dispatch Purpose
            const dispatchPurpose = document.getElementById('dispatch-purpose');
            if (dispatchPurpose) {
                const options = ['Sale', 'Sample', 'Demo', 'Return'];
                options.forEach(opt => {
                    if (!Array.from(dispatchPurpose.options).some(o => o.value === opt)) {
                        const el = document.createElement('option');
                        el.value = opt;
                        el.textContent = opt;
                        dispatchPurpose.appendChild(el);
                    }
                });
            }

            // 2. Customer Types
            const custType = document.getElementById('customer-type');
            if (custType) {
                const types = ['Dealer', 'Farmer', 'Institution', 'Demo', 'Client', 'Testing', 'Sample', 'Buyer', 'Estate'];
                types.forEach(t => {
                    if (!Array.from(custType.options).some(o => o.value === t)) {
                        const el = document.createElement('option');
                        el.value = t;
                        el.textContent = t;
                        custType.appendChild(el);
                    }
                });
            }
        }

        // Override Init to include these
        const originalInit = window.initializeInventoryImprovements;
        window.initializeInventoryImprovements = function () {
            if (originalInit) originalInit();

            // Restore features
            restoreMissingDropdowns();

            // If showView is called for calculator, it will now work because renderCalculatorView is defined

            console.log("Restored Missing Features (Calc, Dropdowns)");
        };

        // ========================================
        // 6. MANUAL INITIALIZATION (DO NOT AUTO-RUN!)
        // ========================================
        // 
        // TO USE THE IMPROVEMENTS:
        // Open browser console (F12) and run:
        // initializeInventoryImprovements();
        //
        // This ensures original app loads first!

        window.initializeInventoryImprovements = function () {
            console.log('Loading improvements...');
            try {
                // Combined setup function (CSS, Sidebar, View containers)
                setupFeaturePackV3Fixes();

                // Modals & Search
                addReturnModal();
                addGlobalSearchBar(); // Ensure search bar is added

                // Initialize Logic
                if (window.initializeGlobalSearch) initializeGlobalSearch();

                console.log('✅ Improvements loaded! Export functions ready.');
            } catch (error) {
                console.error('Error loading improvements:', error);
            }
        };

        // Export functions are available immediately (they don't need init)
        console.log('📊 Export functions ready. Type initializeInventoryImprovements() to load UI improvements.');


        function setupFeaturePackV3Fixes() {
            if (document.querySelector('a[data-view="product-trace"]')) return;
            // 8. ADDITIONAL CSS
            const style = document.createElement('style');
            style.textContent = `#global-search-results .hover\\:bg-gray-50:hover { background-color: #f9fafb; } .expiry-alert-critical { animation: pulse-red 2s infinite; } @keyframes pulse-red { 0%, 100% { background-color: #fee2e2; } 50% { background-color: #fecaca; } } #returnModal { backdrop-filter: blur(4px); }`;
            document.head.appendChild(style);

            // 9. SIDEBAR LINK INJECTION REMOVED (Keeping only static link)
            // Create View Container if missing
            if (!document.getElementById('product-trace-view')) {
                const viewsContainer = document.getElementById('views-container');
                const productTraceView = document.createElement('div');
                productTraceView.id = 'product-trace-view';
                productTraceView.className = 'view';
                viewsContainer.appendChild(productTraceView);
            }
        }

        function addGlobalSearchBar() {
            const main = document.querySelector('main.flex-1');
            if (!main) return;
            const searchBar = document.createElement('div');
            searchBar.className = 'bg-white border-b p-4 shadow-sm';
            searchBar.innerHTML = `<div id="global-search-container" class="relative w-full max-w-2xl mx-auto"><div class="relative"><input type="text" id="global-search-input" placeholder="🔍 Search: Items | Customers | Suppliers..." class="w-full px-4 py-3 pr-10 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none text-lg"><button onclick="closeGlobalSearch()" class="absolute right-3 top-3 text-gray-400 hover:text-gray-600 text-xl font-bold">✕</button></div><div id="global-search-results" class="hidden absolute top-full left-0 right-0 mt-2 bg-white border-2 border-gray-300 rounded-lg shadow-2xl z-50"></div></div>`;
            main.insertBefore(searchBar, main.firstChild);
        }

        // Call it immediately - REMOVED to prevent duplicates
        // addGlobalSearchBar(); 
        // if (window.initializeGlobalSearch) window.initializeGlobalSearch();

        function addReturnModal() {
            const returnModalHTML = `<div id="returnModal" class="modal fixed inset-0 bg-black bg-opacity-50 justify-center items-center z-50"><div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md max-h-[90vh] overflow-y-auto"><div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold text-orange-700">Process Return / Replacement</h3><button onclick="closeModal('returnModal')" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button></div><form id="return-form" onsubmit="processReturn(event)"><input type="hidden" id="return-dispatch-id"><input type="hidden" id="return-customer-id"><input type="hidden" id="return-category"><input type="hidden" id="return-item-id"><input type="hidden" id="return-max-qty-value"><div class="mb-4"><label class="block text-sm font-medium mb-1">Return Date</label><input type="date" id="return-date" class="w-full p-2 border rounded-md" required></div><div class="mb-4"><label class="block text-sm font-medium mb-1">Customer Name</label><input type="text" id="return-customer-name" class="w-full p-2 border rounded-md" required></div><div class="mb-4"><label class="block text-sm font-medium mb-1">Item</label><p id="return-item-name" class="p-2 bg-gray-100 rounded-md font-semibold">-</p></div><div class="mb-4"><label class="block text-sm font-medium mb-1">Return Quantity</label><input type="number" id="return-quantity" step="any" class="w-full p-2 border rounded-md" required><p class="text-xs text-gray-500 mt-1">Max dispatched: <span id="return-max-qty" class="font-bold">-</span></p></div><div class="mb-4"><label class="block text-sm font-medium mb-1">Return Reason</label><select id="return-reason" class="w-full p-2 border rounded-md" required><option value="">Select reason...</option><option value="damage">Damage</option><option value="expiry">Expiry</option><option value="wrong_delivery">Wrong Delivery</option><option value="quality_issue">Quality Issue</option><option value="excess_quantity">Excess Quantity</option><option value="other">Other</option></select></div><div class="mb-4"><label class="block text-sm font-medium mb-1">Batch Number</label><input type="text" id="return-batch-no" class="w-full p-2 border rounded-md font-mono text-sm"></div><div class="mb-4"><label class="block text-sm font-medium mb-1">Invoice Number</label><input type="text" id="return-invoice-no" class="w-full p-2 border rounded-md"></div><div class="mb-4"><label class="block text-sm font-medium mb-1">Notes</label><textarea id="return-notes" class="w-full p-2 border rounded-md" rows="3"></textarea></div><div class="flex justify-end gap-4"><button type="button" onclick="closeModal('returnModal')" class="px-4 py-2 bg-gray-300 rounded-lg">Cancel</button><button type="submit" class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700">Process Return</button></div></form></div></div>`;
            document.body.insertAdjacentHTML('beforeend', returnModalHTML);
        }

        // DISABLED: This function overrides original rendering and breaks dialogs
        // Use manually if needed: addExportButtonsManually()
        function addExportButtonsManually() {
            const container = document.getElementById('sales-dispatch-view');
            if (!container) { console.error('Sales dispatch view not found'); return; }
            const header = container.querySelector('h2');
            if (header && !document.getElementById('export-buttons-added')) {
                const exportButtons = document.createElement('div');
                exportButtons.id = 'export-buttons-added';
                exportButtons.className = 'bg-white p-4 rounded-lg shadow mb-4';
                exportButtons.innerHTML = `<h4 class="font-bold mb-2">📊 Export Options</h4><div class="flex flex-wrap gap-2"><button onclick="exportCustomerWiseData()" class="px-3 py-2 bg-blue-600 text-white rounded text-sm hover:bg-blue-700">Customer-Wise</button><button onclick="exportSupplierWiseData()" class="px-3 py-2 bg-green-600 text-white rounded text-sm hover:bg-green-700">Supplier-Wise</button><button onclick="exportSalesDataCustomerWise()" class="px-3 py-2 bg-purple-600 text-white rounded text-sm hover:bg-purple-700">Sales by Customer</button><button onclick="exportSalesDataProductWise()" class="px-3 py-2 bg-orange-600 text-white rounded text-sm hover:bg-orange-700">Sales by Product</button><button onclick="exportAllDataAtOnce()" class="px-3 py-2 bg-red-600 text-white rounded text-sm hover:bg-red-700">Export All Data</button></div>`;
                header.parentNode.insertBefore(exportButtons, header.nextSibling);
                console.log('✅ Export buttons added!');
            }
        }

        // DISABLED: Breaks dispatch table rendering
        // function addReturnButtonsToDispatchTable() {... }


        // DISABLED: Overrides showView and may break navigation
        // function enhanceShowViewFunction() {... }




    </script>
    <script>
        // DEBUG: PROVE NEW CODE IS RUNNING
        console.log("ANTIGRAVITY: Update Loaded (V8 - Diagnostic & Syntax Safety)");
        // ALERT REMOVED: User reported persistent popup.
        // alert("UPDATE SUCCESSFUL: Fix V8 Active.\n- Added Quote Escaping for Batch/Item IDs (fixes Syntax Error).\n- Enhanced Finished Good matching with DIAGNOSTIC logs.\n- Open Console (F12) if issues persist.");

        // ==========================================
        // PRODUCTION WIP & COMPLETION FIX (FINAL v8 - Diagnostic)
        // ==========================================

        // 1. RESTORED DUAL-COLUMN LAYOUT (Safe Attributes)
        window.renderProductionWIPView = function () {
            const container = document.getElementById('production-wip-view');
            if (!container) return;

            const activeBatches = appState.activeProduction || [];
            activeBatches.sort((a, b) => new Date(b.startDate) - new Date(a.startDate));

            const completedBatches = appState.completedBatches || [];
            completedBatches.sort((a, b) => new Date(b.completionDate) - new Date(a.completionDate));

            container.innerHTML = `
        <div class="h-full flex flex-col p-6 overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Orders & Production (WIP)</h2>
                ${activeBatches.length > 0 ? `<div class="bg-yellow-100 text-yellow-800 px-3 py-2 rounded border border-yellow-200 text-xs font-bold">Active: ${activeBatches.length}</div>` : ''}
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                 <!-- LEFT: CREATE FORM -->
                <div class="bg-white p-6 rounded-lg shadow h-fit">
                    <h3 class="text-xl font-bold mb-4 text-blue-600">Start New Production</h3>
                    <form id="create-batch-form" onsubmit="handleCreateBatch(event)">
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-1">Batch ID / Order Ref</label>
                            <input type="text" id="new-batch-id" class="w-full p-2 border rounded font-mono" placeholder="e.g. B-2023-001" required>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-1">Product Formula</label>
                            <select id="new-batch-formula" class="w-full p-2 border rounded" required>
                                <option value="">-- Select Product --</option>
                                ${(appState.formulas || []).map(f => `<option value="${f.id}">${f.name} (${f.outputQty} ${f.outputUnit})</option>`).join('')}
                            </select>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-1">Manufacturing Date</label>
                            <input type="date" id="new-batch-date" class="w-full p-2 border rounded" required>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-1">Target Quantity</label>
                            <input type="number" id="new-batch-qty" step="any" class="w-full p-2 border rounded" placeholder="Qty to produce" required>
                        </div>
                        <button type="submit" class="w-full py-2 bg-blue-600 text-white rounded font-bold hover:bg-blue-700">Create Order</button>
                    </form>
                </div>

                <!-- RIGHT: ACTIVE BATCH LIST -->
                <div class="lg:col-span-2 space-y-4">
                    <h3 class="font-bold text-gray-700">Active Production</h3>
                    ${activeBatches.length === 0 ?
                    `<div class="bg-white p-8 rounded-lg shadow text-center text-gray-500">No active production orders.</div>` :
                    activeBatches.map(batch => {
                        const formula = (appState.formulas || []).find(f => f.id == batch.formulaId);
                        const formulaName = formula ? formula.name : (batch.formulaName || 'Unknown Product');

                        let reservedCount = 0;
                        if (batch.reservedData) {
                            ['rawMaterials', 'packingMaterials', 'labels'].forEach(cat => {
                                reservedCount += (batch.reservedData[cat] || []).length;
                            });
                        }
                        // SAFE ID HANDLING
                        const bIdSafe = String(batch.id).replace(/'/g, "\\'");

                        return `
                                <div class="bg-white p-6 rounded-lg shadow border-l-4 ${batch.status === 'started' ? 'border-blue-500' : 'border-gray-300'}">
                                    <div class="flex justify-between items-start mb-4">
                                        <div>
                                            <h4 class="text-lg font-bold text-gray-800">${formulaName}</h4>
                                            <div class="flex items-center gap-3 text-sm text-gray-500 mt-1">
                                                 <span class="font-mono bg-gray-100 px-2 rounded">Batch: ${batch.batchNo}</span>
                                                 <span>${batch.startDate ? batch.startDate.split('T')[0] : ''}</span>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <span class="px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide ${batch.status === 'started' ? 'bg-blue-100 text-blue-800' : 'bg-gray-100'}">${batch.status || 'Draft'}</span>
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-3 gap-4 text-sm mb-4 bg-gray-50 p-3 rounded">
                                        <div><p class="text-gray-500 text-xs uppercase">Target Qty</p><p class="font-bold text-lg">${batch.targetQty}</p></div>
                                        <div><p class="text-gray-500 text-xs uppercase">Produced</p><p class="font-bold text-lg text-green-600">${batch.producedQty || 0}</p></div>
                                        <div><p class="text-gray-500 text-xs uppercase">Slips</p><p class="font-bold text-blue-600">${(batch.consumptionSlips || []).length}</p></div>
                                    </div>
                                    
                                    ${batch.status === 'paused' ? '<div class="mb-2 bg-yellow-50 text-yellow-700 px-3 py-2 rounded text-xs font-bold border border-yellow-200">⏸️ PAUSED - ' + (batch.pauseReason || 'No reason') + '</div>' : ''}
                                    
                                    <div class="flex flex-wrap gap-2 border-t pt-4">
                                        ${(!batch.status || batch.status === 'draft') ?
                                `<button onclick="startBatch('${bIdSafe}')" class="px-3 py-1 bg-green-600 text-white rounded text-sm font-bold hover:bg-green-700">Start (Reserve)</button>
                                             <button onclick="deleteBatch('${bIdSafe}')" class="px-3 py-1 bg-red-100 text-red-600 rounded text-sm font-bold hover:bg-red-200">Delete</button>`
                                : ''}
                                        
                                        ${batch.status === 'started' ?
                                `<button onclick="openConsumptionSlipModal('${bIdSafe}')" class="px-3 py-1 bg-blue-600 text-white rounded text-sm font-bold hover:bg-blue-700">📝 Log Slip</button>
                                             <button onclick="openPauseModal('${bIdSafe}')" class="px-3 py-1 bg-yellow-500 text-white rounded text-sm font-bold hover:bg-yellow-600">⏸️ Pause</button>
                                             <button onclick="openCompleteProductionModal('${bIdSafe}')" class="px-3 py-1 bg-green-600 text-white rounded text-sm font-bold hover:bg-green-700 shadow">✅ Complete</button>
                                             <button onclick="if(window.openBatchBOMModal) openBatchBOMModal('${bIdSafe}')" class="px-3 py-1 bg-purple-600 text-white rounded text-sm font-bold hover:bg-purple-700">📦 Reserved</button>
                                             <button onclick="cancelBatch('${bIdSafe}')" class="px-3 py-1 bg-red-100 text-red-600 rounded text-sm font-bold hover:bg-red-200">Cancel</button>`
                                : ''}
                                        
                                        ${batch.status === 'paused' ?
                                `<button onclick="openConsumptionSlipModal('${bIdSafe}')" class="px-3 py-1 bg-blue-600 text-white rounded text-sm font-bold hover:bg-blue-700">📝 Log Slip</button>
                                             <button onclick="resumeProduction('${bIdSafe}')" class="px-3 py-1 bg-green-500 text-white rounded text-sm font-bold hover:bg-green-600">▶️ Resume</button>
                                             <button onclick="cancelBatch('${bIdSafe}')" class="px-3 py-1 bg-red-100 text-red-600 rounded text-sm font-bold hover:bg-red-200">Cancel</button>`
                                : ''}
                                    </div>
                                </div>
                             `;
                    }).join('')}
                </div>
            </div>

            <!-- COMPLETED BATCHES HISTORY -->
            <div class="mt-8 border-t pt-8">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800">Completed Production History</h3>
                    <button onclick="exportProductionHistoryCSV()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 shadow font-bold flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        Export History
                    </button>
                </div>
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <table class="min-w-full text-sm text-left">
                        <thead class="bg-gray-100 text-gray-700 uppercase font-bold text-xs">
                            <tr>
                                <th class="p-3">Completion Date</th>
                                <th class="p-3">Batch No</th>
                                <th class="p-3">Product</th>
                                <th class="p-3 text-right">Produced Qty</th>
                                <th class="p-3">Unit</th>
                                <th class="p-3">Status</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y">
                            ${completedBatches.length > 0 ? completedBatches.map(b => `
                                 <tr class="hover:bg-gray-50">
                                     <td class="p-3">${b.completionDate ? b.completionDate.split('T')[0] : '-'}</td>
                                     <td class="p-3 font-mono text-blue-600 font-bold">${b.batchNo}</td>
                                     <td class="p-3 font-medium">${b.formulaName}</td>
                                     <td class="p-3 text-right font-bold text-green-700">${b.actualQty}</td>
                                     <td class="p-3">${b.unit}</td>
                                     <td class="p-3"><span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-bold">Completed</span></td>
                                 </tr>
                             `).join('') : `<tr><td colspan="6" class="p-6 text-center text-gray-400">No history available</td></tr>`}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        `;

            setTimeout(() => {
                const dateInput = document.getElementById('new-batch-date');
                if (dateInput && !dateInput.value) {
                    dateInput.value = new Date().toISOString().split('T')[0];
                }
            }, 100);
        };

        // 2. HELPER FUNCTIONS
        window.handleCreateBatch = function (event) {
            if (event) event.preventDefault();
            const batchNo = document.getElementById('new-batch-id').value;
            const formulaId = document.getElementById('new-batch-formula').value;
            const targetQty = parseFloat(document.getElementById('new-batch-qty').value);
            const dateVal = document.getElementById('new-batch-date').value;

            if (!batchNo || !formulaId || !targetQty) { alert("Please fill all fields"); return; }

            if ((appState.activeProduction || []).some(b => b.batchNo === batchNo)) {
                alert("Batch ID already exists!");
                return;
            }

            const formula = appState.formulas.find(f => f.id == formulaId);
            let startDate = new Date().toISOString();
            if (dateVal) {
                startDate = new Date(dateVal).toISOString();
            }

            const newBatch = {
                id: Date.now(),
                batchNo: batchNo,
                formulaId: formula ? formula.id : formulaId,
                formulaName: formula ? formula.name : '',
                unit: formula ? formula.outputUnit : 'Units',
                targetQty: targetQty,
                startDate: startDate,
                status: 'draft',
                reservedData: { rawMaterials: [], packingMaterials: [], labels: [] }
            };

            if (!appState.activeProduction) appState.activeProduction = [];
            appState.activeProduction.push(newBatch);
            saveState();
            renderProductionWIPView();
            document.getElementById('create-batch-form').reset();
            document.getElementById('new-batch-date').value = new Date().toISOString().split('T')[0];
            if (window.showAlert) showAlert("New Batch Created (Draft)");
        };

        window.exportProductionHistoryCSV = function () {
            const completedBatches = appState.completedBatches || [];
            if (completedBatches.length === 0) { alert("No history to export."); return; }

            const rows = [['Completion Date', 'Batch No', 'Product Name', 'Produced Qty', 'Unit', 'Start Date', 'Target Qty']];
            completedBatches.forEach(b => {
                rows.push([
                    b.completionDate ? b.completionDate.split('T')[0] : '',
                    b.batchNo || '',
                    b.formulaName || '',
                    b.actualQty || 0,
                    b.unit || '',
                    b.startDate ? b.startDate.split('T')[0] : '',
                    b.targetQty || 0
                ]);
            });

            const csvContent = rows.map(e => e.join(",")).join("\n");
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "Production_History.csv";
            link.click();
        };

        window.startBatch = function (batchId) {
            const batch = appState.activeProduction.find(b => b.id == batchId);
            if (!batch) return;

            var formula = appState.formulas.find(f => f.id == batch.formulaId);

            // FALLBACK: Match by Name (Fixes ID mismatches)
            if (!formula && batch.formulaName) {
                formula = appState.formulas.find(f => f.name === batch.formulaName);
                if (formula) {
                    console.log("ANTIGRAVITY: Repaired Formula Link for " + batch.batchNo);
                    batch.formulaId = formula.id;
                    saveState();
                }
            }

            if (!formula) { alert("Formula not found! Please check if the product still exists."); return; }

            // 1. Calculate reservedData
            const scale = batch.targetQty / (formula.outputQty || 1);

            const processList = (list, cat) => {
                if (!list) return [];
                return list.map(item => ({
                    itemId: item.itemId,
                    quantity: item.quantity * scale,
                    category: cat
                }));
            };

            // Ensure reservedData structure exists
            batch.reservedData = {
                rawMaterials: processList(formula.ingredients, 'rawMaterials'),
                packingMaterials: processList(formula.packingMaterials, 'packingMaterials'),
                labels: processList(formula.labels, 'labels')
            };

            // 2. Create Transactions (CRITICAL FOR RESERVATION)
            const date = new Date().toISOString();
            const logTx = (list, cat) => {
                if (!list) return;
                list.forEach(item => {
                    appState.transactions.push({
                        id: Date.now() + Math.random(),
                        itemId: item.itemId,
                        category: cat,
                        type: 'production-reserve',
                        quantity: item.quantity,
                        date: date,
                        batchNo: batch.batchNo,
                        notes: "Production Reservation"
                    });
                });
            };

            logTx(batch.reservedData.rawMaterials, 'rawMaterials');
            logTx(batch.reservedData.packingMaterials, 'packingMaterials');
            logTx(batch.reservedData.labels, 'labels');

            // 3. Update Status
            batch.status = 'started';
            saveState();
            renderProductionWIPView();
            if (window.showAlert) showAlert("Batch Started. Stock Reserved Successfully.");
        };

        window.deleteBatch = function (batchId) {
            if (!confirm("Delete this draft batch?")) return;
            const idx = appState.activeProduction.findIndex(b => b.id == batchId);
            if (idx > -1) {
                appState.activeProduction.splice(idx, 1);
                saveState();
                renderProductionWIPView();
            }
        };

        window.cancelBatch = function (batchId) {
            if (!confirm("Cancel active batch?")) return;
            const idx = appState.activeProduction.findIndex(b => b.id == batchId);
            if (idx > -1) {
                appState.activeProduction.splice(idx, 1);
                saveState();
                renderProductionWIPView();
            }
        };


        // 3. COMPLETION MODAL & LOGIC (Robust & Diagnostic)
        window.openCompleteProductionModal = function (batchId) {
            const batch = appState.activeProduction.find(b => b.id == batchId);
            if (!batch) return;

            if (!document.getElementById('completeProductionModal')) {
                const html = `
        <div id="completeProductionModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 hidden">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto transform transition-all">
                <div class="p-6 border-b flex justify-between items-center bg-gray-50">
                    <h3 class="text-xl font-bold text-gray-800" id="cp-modal-title">Complete Production</h3>
                    <button onclick="closeModal('completeProductionModal')" class="text-gray-400 hover:text-gray-800 text-3xl font-light">&times;</button>
                </div>
                <div class="p-6">
                    <input type="hidden" id="cp-batch-id">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6 bg-blue-50 p-5 rounded-lg border border-blue-100">
                            <div><label class="block text-xs font-bold text-blue-600 uppercase mb-1">Product</label><div class="text-lg font-bold text-gray-900 leading-tight" id="cp-product-name">-</div></div>
                            <div><label class="block text-xs font-bold text-blue-600 uppercase mb-1">Target Qty</label><div class="text-lg font-bold text-gray-900" id="cp-target-qty">0</div></div>
                            <div><label class="block text-xs font-bold text-green-700 uppercase mb-1">Actual Produced</label><input type="number" id="cp-actual-qty" class="w-full p-2 border-2 text-right border-green-200 rounded bg-white text-green-800 font-bold text-lg focus:outline-none focus:border-green-500 placeholder-green-200" placeholder="0.00"></div>
                        </div>
                        <div class="mb-8"><label class="block text-sm font-bold text-gray-700 mb-1">Expiry Date (Batch/Lot)</label><input type="date" id="cp-expiry-date" class="w-full p-2 border rounded shadow-sm"><p class="text-xs text-gray-500 mt-1">Set the expiry date for the Finished Goods created.</p></div>
                        <div class="mb-6"><h4 class="font-bold text-gray-800 mb-2 flex items-center justify-between">Material Consumption & Wastage <span class="text-xs font-normal text-gray-500">Confirm actuals used</span></h4><div class="overflow-hidden border rounded-lg shadow-sm"><table class="min-w-full text-sm"><thead class="bg-gray-100 text-gray-700"><tr><th class="p-3 text-left">Item</th><th class="p-3 text-right">Plan Qty</th><th class="p-3 text-right bg-blue-50 text-blue-900 border-l border-blue-100">Actual Consumed</th><th class="p-3 text-right bg-red-50 text-red-900 border-l border-red-100">Wastage / Loss</th></tr></thead><tbody id="cp-materials-body" class="bg-white"></tbody></table></div></div>
                        <div class="flex justify-end gap-3 pt-4 border-t">
                            <button onclick="closeModal('completeProductionModal')" class="px-5 py-2.5 bg-white text-gray-700 rounded-lg font-bold border border-gray-300 hover:bg-gray-50">Cancel</button>
                            <button onclick="confirmProductionCompletion()" class="px-6 py-2.5 bg-green-600 text-white rounded-lg font-bold hover:bg-green-700 shadow-lg flex items-center gap-2"><span>Confirm Completion</span><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></button>
                        </div>
                </div>
            </div>
        </div>`;
                document.body.insertAdjacentHTML('beforeend', html);
            }

            document.getElementById('cp-batch-id').value = batch.id;
            document.getElementById('cp-modal-title').innerHTML = `Complete Production <span class="text-gray-400 font-normal ml-2">#${batch.batchNo}</span>`;
            document.getElementById('cp-product-name').textContent = batch.formulaName || 'Product';
            document.getElementById('cp-target-qty').textContent = batch.targetQty + ' ' + (batch.unit || '');
            document.getElementById('cp-actual-qty').value = batch.targetQty;

            const today = new Date();
            today.setFullYear(today.getFullYear() + 1);
            document.getElementById('cp-expiry-date').value = today.toISOString().split('T')[0];

            const tbody = document.getElementById('cp-materials-body');
            tbody.innerHTML = '';
            const materials = [];
            ['rawMaterials', 'packingMaterials', 'labels'].forEach(cat => {
                if (batch.reservedData && batch.reservedData[cat]) {
                    batch.reservedData[cat].forEach(item => {
                        materials.push({ ...item, category: cat });
                    });
                }
            });

            const findItemHelper = (cat, id) => {
                if (window.findItem) return window.findItem(cat, id);
                return (appState.inventory[cat] || []).find(i => i.id == id);
            };

            materials.forEach((m, idx) => {
                const itemDef = findItemHelper(m.category, m.itemId);
                const tr = document.createElement('tr');
                tr.className = 'border-b hover:bg-gray-50 last:border-0';
                tr.innerHTML = `
        <td class="p-3"><div class="font-bold text-gray-800">${itemDef ? itemDef.name : 'Unknown Item'}</div></td>
        <td class="p-3 text-right font-mono text-gray-600">${m.quantity.toFixed(3)}</td>
        <td class="p-3 text-right bg-blue-50 border-l border-blue-100"><input type="number" class="w-28 p-1 border border-blue-200 rounded text-right cp-consumed-input font-bold text-blue-900 bg-white" data-idx="${idx}" value="${m.quantity.toFixed(3)}"></td>
        <td class="p-3 text-right bg-red-50 border-l border-red-100"><input type="number" class="w-24 p-1 border border-red-200 rounded text-right cp-wastage-input text-red-900 bg-white" data-idx="${idx}" value="0"></td>
        `;
                tbody.appendChild(tr);
            });
            const modal = document.getElementById('completeProductionModal');
            modal.classList.remove('hidden'); modal.classList.add('flex');
        };

        window.confirmProductionCompletion = function () {
            try {
                console.log("ANTIGRAVITY: Starting Production Completion...");
                const batchId = document.getElementById('cp-batch-id').value;
                const actualQty = parseFloat(document.getElementById('cp-actual-qty').value);
                const expiryDate = document.getElementById('cp-expiry-date').value;

                if (!batchId || isNaN(actualQty) || actualQty < 0) { alert("Invalid Produced Quantity"); return; }
                if (!expiryDate) { alert("Please select an expiry date"); return; }

                const batchIndex = appState.activeProduction.findIndex(b => b.id == batchId);
                if (batchIndex === -1) { alert("Batch not found!"); return; }
                const batch = appState.activeProduction[batchIndex];

                console.log("ANTIGRAVITY: Batch Found:", batch);

                // 1. Consume
                const consumedInputs = document.querySelectorAll('.cp-consumed-input');
                const wastageInputs = document.querySelectorAll('.cp-wastage-input');
                const materials = [];
                ['rawMaterials', 'packingMaterials', 'labels'].forEach(cat => {
                    if (batch.reservedData && batch.reservedData[cat]) {
                        batch.reservedData[cat].forEach(item => materials.push({ ...item, category: cat }));
                    }
                });

                const pName = batch.formulaName || 'Prd';
                const bNo = batch.batchNo || 'Unknown';

                materials.forEach((m, i) => {
                    const consumed = parseFloat(consumedInputs[i].value) || 0;
                    const wastage = parseFloat(wastageInputs[i].value) || 0;
                    const totalByItem = consumed + wastage;

                    var noteText = `Prd: ${pName} (${bNo})`;
                    if (wastage > 0) noteText += ` (Wastage: ${wastage})`;

                    if (totalByItem > 0) {
                        appState.transactions.push({
                            id: Date.now() + i,
                            type: 'production-consume',
                            category: m.category,
                            itemId: m.itemId,
                            quantity: totalByItem,
                            date: new Date().toISOString(),
                            batchNo: batch.batchNo,
                            relatedBatchId: batch.batchNo,
                            fgBatchId: batch.batchNo,
                            notes: noteText
                        });
                    }
                });

                console.log(`ANTIGRAVITY: Material consumption recorded. Now resolving Finished Good.`);

                // 2. Add FG (Validated)
                let fgItemId = batch.itemId; // First try stored ID

                // Second try: Lookup by ID from Formula
                if (!fgItemId && batch.formulaId) {
                    const f = appState.formulas.find(f => f.id == batch.formulaId);
                    if (f) fgItemId = f.finishedGoodItemId || f.itemId;
                }

                // VALIDATION STEP: Check if fgItemId actually exists in inventory
                if (fgItemId) {
                    const validItem = (appState.inventory.finishedGoods || []).find(i => i.id == fgItemId);
                    if (!validItem) {
                        console.warn(`ANTIGRAVITY: ID ${fgItemId} found in formula/batch but NOT in inventory. Resetting.`);
                        fgItemId = null; // Reset if invalid
                    } else {
                        console.log(`ANTIGRAVITY: ID ${fgItemId} is valid. Matched: ${validItem.name}`);
                    }
                }

                // Third try: Strict Name Match (Existing Item) - Normalize for matching
                if (!fgItemId && batch.formulaName) {
                    const cleanName = batch.formulaName.trim().toLowerCase().replace(/\s+/g, ' ');
                    const existingItem = (appState.inventory.finishedGoods || []).find(i =>
                        (i.name || '').trim().toLowerCase().replace(/\s+/g, ' ') === cleanName
                    );
                    if (existingItem) {
                        fgItemId = existingItem.id;
                        console.log(`ANTIGRAVITY: Matched by Name '${batch.formulaName}' -> ID: ${fgItemId}`);
                    } else {
                        console.log(`ANTIGRAVITY: Name match failed for '${cleanName}'.`);
                    }
                }

                let finalItemName = batch.formulaName;

                // Final fallback: Create New Item
                if (!fgItemId && batch.formulaName) {
                    console.log("ANTIGRAVITY: Creating NEW Finished Good Item.");
                    const newId = Date.now() + 999;
                    const fg = { id: newId, name: batch.formulaName, type: 'finishedGoods', unit: batch.unit || 'Unit', currentAverageCost: 0, minStock: 0, description: 'Auto-created' };
                    if (!appState.inventory.finishedGoods) appState.inventory.finishedGoods = [];
                    appState.inventory.finishedGoods.push(fg);

                    if (batch.formulaId) {
                        const f = appState.formulas.find(f => f.id == batch.formulaId);
                        if (f) f.finishedGoodItemId = newId;
                    }
                    fgItemId = fg.id;
                    finalItemName = fg.name;
                } else if (fgItemId) {
                    const i = (appState.inventory.finishedGoods || []).find(x => x.id == fgItemId);
                    if (i) finalItemName = i.name;
                }

                if (fgItemId) {
                    console.log(`ANTIGRAVITY: Adding stock to Item ID: ${fgItemId} (${finalItemName})`);
                    appState.transactions.push({
                        id: Date.now() + 5000,
                        type: 'production-add',
                        category: 'finishedGoods',
                        itemId: fgItemId, // Removed parseInt to ensure type consistency if IDs are strings or numbers
                        quantity: actualQty,
                        date: new Date().toISOString(),
                        batchNo: batch.batchNo,
                        relatedBatchId: batch.batchNo,
                        batchMeta: { expiry: expiryDate },
                        mfgDate: new Date().toISOString().split('T')[0],
                        expDate: expiryDate,
                        notes: "Production Completed"
                    });
                } else {
                    alert("CRITICAL ERROR: Could not determine distinct Finished Good Item. Please check console logs.");
                    return;
                }

                // 3. Archive
                appState.activeProduction.splice(batchIndex, 1);
                if (!appState.completedBatches) appState.completedBatches = [];
                batch.status = 'completed';
                batch.completionDate = new Date().toISOString();
                batch.actualQty = actualQty;
                appState.completedBatches.push(batch);

                saveState();
                document.getElementById('completeProductionModal').classList.add('hidden');
                document.getElementById('completeProductionModal').classList.remove('flex');

                console.log("ANTIGRAVITY: Production Completion Finished. Refreshing View.");
                if (window.showAlert) showAlert(`Production Completed!\nAdded ${actualQty} to '${finalItemName}'\n(ID: ${fgItemId})`, "Success");
                else alert(`Production Completed!\nAdded ${actualQty} to '${finalItemName}'`);

                if (window.renderProductionWIPView) renderProductionWIPView();

            } catch (err) {
                console.error("ANTIGRAVITY ERROR:", err);
                alert("Error during completion: " + err.message);
            }
        };

        window.confirmCompleteBatch = window.confirmProductionCompletion;
        window.completeBatch = window.openCompleteProductionModal;


        // ==========================================
        // FIX BACK BUTTON & EXPORT DATE & QUOTE SAFETY
        // ==========================================

        window.openProductTrace = function (productId) {
            // Save where we came from
            window.lastTraceSourceView = (window.appState && appState.currentView) ? appState.currentView : 'finishedGoods';

            // Check permission (mock)
            if (window.checkPermission && !checkPermission()) return;

            const id = parseFloat(productId);
            const item = (window.findItem) ? findItem('finishedGoods', id) : null;

            if (!item) {
                if (window.showAlert) showAlert("Product not found or not a Finished Good.");
                return;
            }

            if (window.showView) showView('product-trace');
            if (window.renderProductTraceView) renderProductTraceView(item);
        };

        window.renderProductTraceView = function (item) {
            const container = document.getElementById('product-trace-view');
            if (container) container.innerHTML = '<div class="p-8 text-center text-gray-500">Product trace is disabled.</div>';
            return;
        };
        window.original_renderProductTraceView_V12 = function (item) {
            const stock = window.calculateStock ? calculateStock(item, 'finishedGoods', new Date().toISOString().split('T')[0]) : { closingStock: 0 };
            const totalProduced = appState.transactions.filter(t => t.itemId == item.id && t.category === 'finishedGoods' && t.type === 'production-add').reduce((a, t) => a + t.quantity, 0);
            const totalDispatched = appState.transactions.filter(t => t.itemId == item.id && t.category === 'finishedGoods' && t.type === 'dispatch').reduce((a, t) => a + t.quantity, 0);

            const batchMap = new Map();
            appState.transactions.filter(t => t.itemId == item.id && t.category === 'finishedGoods').forEach(t => {
                const batchKey = t.batchNo || 'OPENING_STOCK';
                if (!batchMap.has(batchKey)) {
                    batchMap.set(batchKey, { id: batchKey, produced: 0, balance: 0, mfg: 'N/A' });
                }
                const b = batchMap.get(batchKey);
                if (t.type === 'production-add') b.produced += t.quantity;
                if (['production-add', 'receive', 'stock-take-adj-in'].includes(t.type)) b.balance += t.quantity;
                if (['dispatch', 'consume', 'stock-take-adj-out', 'production-consume'].includes(t.type)) b.balance -= t.quantity;
            });
            const batches = Array.from(batchMap.values());

            // THE FIX: Back Button Logic
            const backTarget = window.lastTraceSourceView || 'finishedGoods';

            // SAFE QUOTING FOR ATTRIBUTES
            const safeItemId = String(item.id).replace(/'/g, "\\'");

            container.innerHTML = `
        <div class="h-full flex flex-col">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-4">
                    <button onclick="showView('${backTarget}')" class="text-gray-500 hover:text-gray-800 border p-1 rounded hover:bg-gray-100">
                        <span class="text-xl font-bold">← Back to ${backTarget === 'sales-dispatch' ? 'Sales' : 'List'}</span>
                    </button>
                    <h2 class="text-3xl font-bold flex items-center gap-2">
                        Traceability: <span class="text-blue-600">${item.name}</span>
                    </h2>
                </div>
                <div class="text-sm font-mono bg-gray-100 p-2 rounded">Product ID: ${item.id}</div>
            </div>

            <!-- Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-blue-50 p-6 rounded-lg border border-blue-100">
                    <h3 class="font-bold text-blue-800 mb-1">Current Stock</h3>
                    <p class="text-3xl font-bold text-blue-900">${stock.closingStock.toFixed(3)} ${item.unit}</p>
                </div>
                <div class="bg-green-50 p-6 rounded-lg border border-green-100">
                    <h3 class="font-bold text-green-800 mb-1">Total Produced</h3>
                    <p class="text-3xl font-bold text-green-900">${totalProduced.toFixed(3)}</p>
                </div>
                <div class="bg-purple-50 p-6 rounded-lg border border-purple-100">
                    <h3 class="font-bold text-purple-800 mb-1">Total Dispatched</h3>
                    <p class="text-3xl font-bold text-purple-900">${totalDispatched.toFixed(3)}</p>
                </div>
            </div>

            <div class="flex flex-col md:flex-row gap-6 h-full">
                <!-- Batch Timeline -->
                <div class="w-full md:w-1/3 bg-white rounded-lg shadow overflow-hidden flex flex-col">
                    <div class="p-4 bg-gray-50 border-b"><h3 class="font-bold text-lg">Batch Timeline</h3></div>
                    <div class="overflow-y-auto flex-1 h-[600px]">
                        <table class="min-w-full text-sm">
                            <thead class="bg-white sticky top-0 z-10 shadow-sm"><tr><th class="p-3 text-left">Batch ID</th><th class="p-3 text-right">Balance</th></tr></thead>
                            <tbody>
                                ${batches.map(b => {
                // SAFE BATCH ID FOR CLICK
                const safeBatchId = String(b.id).replace(/'/g, "\\'");
                return `
                                    <tr class="hover:bg-blue-50 cursor-pointer border-b transition-colors" onclick="renderBatchTraceDetails('${safeItemId}', '${safeBatchId}')">
                                        <td class="p-3"><div class="font-bold font-mono text-blue-600">${b.id}</div></td>
                                        <td class="p-3 text-right font-bold">${b.balance.toFixed(3)}</td>
                                    </tr>`;
            }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Detailed Trace Placeholder -->
                <div class="w-full md:w-2/3 bg-white rounded-lg shadow overflow-hidden flex flex-col" id="batch-trace-detail-container">
                    <div class="flex flex-col items-center justify-center h-full text-gray-400 p-10">
                        <p class="text-lg font-medium">Select a batch from the timeline to view details.</p>
                    </div>
                </div>
            </div>
        </div>
    `;
        };

        window.exportSalesCSV = function () {
            const rows = [['Date', 'Customer', 'Item', 'Qty', 'Batch', 'Invoice', 'Subtype', 'Notes']];
            const txs = appState.transactions.filter(t => t.type === 'dispatch');

            txs.forEach(t => {
                const item = (window.findItem) ? findItem(t.category, t.itemId) : null;
                const cust = (appState.customers || []).find(c => c.id == t.customerId);
                // FIX: Format Date YYYY-MM-DD
                const dateStr = t.date ? t.date.split('T')[0] : '';

                rows.push([
                    dateStr,
                    cust ? cust.name : 'Unknown',
                    item ? item.name : 'Unknown',
                    t.quantity,
                    t.batchNo || '',
                    t.invoiceNo || '',
                    t.subtype || '',
                    t.notes || ''
                ]);
            });

            const csvContent = rows.map(e => e.join(",")).join("\n");
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "Sales_Dispatch_Log.csv";
            link.click();
            if (window.showAlert) showAlert("Exported successfully");
        };

        console.log("ANTIGRAVITY: All Requested Logic Fixes Applied (V8)");
    </script>
    <div id="genericMessageModal"
        class="modal fixed inset-0 bg-black bg-opacity-50 justify-center items-center z-50 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 id="generic-message-title" class="text-xl font-bold">Information</h3>
                <button onclick="closeModal('genericMessageModal')"
                    class="text-gray-400 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <div id="generic-message-content" class="mb-6"></div>
            <div class="flex justify-end">
                <button
                    onclick="this.closest('.modal').classList.add('hidden'); this.closest('.modal').classList.remove('flex');"
                    class="px-6 py-2 bg-blue-600 text-white font-bold rounded hover:bg-blue-700">OK</button>
            </div>
        </div>
    </div>

    <script>
        // ================================================================
        // FEATURE PACK: EXPORTS, RETURNS, FEFO, SEARCH, PDF
        // Antigravity AI - V1.0
        // ================================================================

        console.log("ANTIGRAVITY: Loading Feature Pack (V1)...");

        // ----------------------------------------------------------------
        // 1. ENHANCED EXPORT SYSTEM
        // ----------------------------------------------------------------

        // Helper for CSV export
        function downloadCSV(csvContent, fileName) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = fileName;
            link.click();
        }

        // 1.1 Customer-wise Data
        window.exportCustomerWiseData = function () {
            const rows = [['Customer Name', 'Type', 'Phone', 'Email', 'Address', 'Status']];
            (appState.customers || []).forEach(c => {
                rows.push([c.name, c.type, c.phone || '', c.email || '', c.address || '', c.status || 'Active']);
            });
            downloadCSV(rows.map(e => e.join(",")).join("\n"), "Customers_List.csv");
        };

        // 1.2 Supplier-wise Data
        window.exportSupplierWiseData = function () {
            const rows = [['Supplier Name', 'Contact', 'Phone', 'Email', 'Status']];
            (appState.suppliers || []).forEach(s => {
                rows.push([s.name, s.contactPerson || '', s.phone || '', s.email || '', s.status || 'Active']);
            });
            downloadCSV(rows.map(e => e.join(",")).join("\n"), "Suppliers_List.csv");
        };

        // 1.3 Sales - Customer Wise
        window.exportSalesDataCustomerWise = function () {
            const rows = [['Date', 'Customer', 'Product', 'Batch', 'Qty', 'Unit', 'Invoice']];
            const sales = appState.transactions.filter(t => t.type === 'dispatch');
            sales.sort((a, b) => a.customerId - b.customerId);

            sales.forEach(t => {
                const cust = (appState.customers || []).find(c => c.id == t.customerId);
                const item = (window.findItem) ? findItem('finishedGoods', t.itemId) : null;
                rows.push([
                    t.date.split('T')[0],
                    cust ? cust.name : 'Unknown',
                    item ? item.name : 'Unknown',
                    t.batchNo || '-',
                    t.quantity,
                    item ? item.unit : '',
                    t.invoiceNo || ''
                ]);
            });
            downloadCSV(rows.map(e => e.join(",")).join("\n"), "Sales_by_Customer.csv");
        };

        // 1.4 Sales - Product Wise
        window.exportSalesDataProductWise = function () {
            const rows = [['Product', 'Date', 'Customer', 'Batch', 'Qty', 'Unit', 'Invoice']];
            const sales = appState.transactions.filter(t => t.type === 'dispatch');
            sales.sort((a, b) => a.itemId - b.itemId);

            sales.forEach(t => {
                const cust = (appState.customers || []).find(c => c.id == t.customerId);
                const item = (window.findItem) ? findItem('finishedGoods', t.itemId) : null;
                rows.push([
                    item ? item.name : 'Unknown',
                    t.date.split('T')[0],
                    cust ? cust.name : 'Unknown',
                    t.batchNo || '-',
                    t.quantity,
                    item ? item.unit : '',
                    t.invoiceNo || ''
                ]);
            });
            downloadCSV(rows.map(e => e.join(",")).join("\n"), "Sales_by_Product.csv");
        };

        // 1.5 Export All Data
        window.exportAllDataAtOnce = function () {
            // Basic implementation: Export Transactions Log
            const rows = [['ID', 'Type', 'Date', 'Category', 'Item ID', 'Qty', 'Batch', 'Notes']];
            appState.transactions.forEach(t => {
                rows.push([t.id, t.type, t.date, t.category, t.itemId, t.quantity, t.batchNo || '', (t.notes || '').replace(/,/g, ' ')]);
            });
            downloadCSV(rows.map(e => e.join(",")).join("\n"), "Full_Transaction_Log.csv");
        };


        // ----------------------------------------------------------------
        // 2. RETURN / REPLACEMENT SYSTEM
        // ----------------------------------------------------------------

        window.openReturnModal = function () {
            const modal = document.getElementById('returnModal');
            if (modal) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                document.getElementById('return-date').value = new Date().toISOString().split('T')[0];
            } else {
                alert("Return modal structure missing. Reload page.");
            }
        };

        window.processReturn = function (event) {
            event.preventDefault();
            const customerName = document.getElementById('return-customer-name').value;
            const date = document.getElementById('return-date').value;
            const qty = parseFloat(document.getElementById('return-quantity').value);
            const reason = document.getElementById('return-reason').value;
            const notes = document.getElementById('return-notes').value;
            const batchNo = document.getElementById('return-batch-no').value;

            // Attempt to find customer and item... simplified for "Generic Return" if IDs hidden fields are empty
            // Ideally we link this to a specific dispatch, but standalone return is flexible

            const hiddenDispatchId = document.getElementById('return-dispatch-id').value;

            // We need to know WHAT is being returned. 
            // If opened from a Dispatch entry, we update that. If generic, we need item selection.
            // For now assuming generic logic or linked via UI we haven't fully seen.

            // FALLBACK: Simple Sales Return Transaction
            const newItemId = document.getElementById('return-item-id').value; // hidden field

            if (!newItemId || !qty) { alert("Item and Quantity required"); return; }

            appState.transactions.push({
                id: Date.now(),
                type: 'sales-return',
                category: 'finishedGoods',
                itemId: parseInt(newItemId), // or parseFloat/String based on your id types
                quantity: qty, // Adds to stock (since return)
                date: new Date(date).toISOString(),
                batchNo: batchNo || 'RETURN',
                notes: `Returned from ${customerName}. Reason: ${reason}. ${notes}`
            });

            saveState();
            closeModal('returnModal');
            if (window.showAlert) showAlert("Return Processed & Stock Updated");
            else alert("Return Processed");

            // Refresh view
            if (window.showView && appState.currentView) showView(appState.currentView);
        };


        // ----------------------------------------------------------------
        // 3. FEFO & EXPIRY ALERTS (Dispatcher Override)
        // ----------------------------------------------------------------

        window.populateDispatchBatchSelect = function () {
            const itemId = parseFloat(document.getElementById('dispatch-item').value);
            const batchSelect = document.getElementById('dispatch-batch');
            batchSelect.innerHTML = '<option value="">-- Select Batch (FEFO) --</option>';

            if (!itemId) return;

            // 1. Gather Batches & Expiry Dates
            const batchMap = new Map(); // batchNo -> {qty, expiry}

            appState.transactions.forEach(t => {
                if (t.category === 'finishedGoods' && t.itemId === itemId && t.batchNo) {
                    if (!batchMap.has(t.batchNo)) {
                        // Try to find expiry in 'production-add' or 'receive'
                        let exp = null;
                        // Look for creation tx
                        const creationTx = appState.transactions.find(x =>
                            x.batchNo === t.batchNo &&
                            x.itemId === itemId &&
                            (x.type === 'production-add' || x.type === 'receive')
                        );
                        if (creationTx) {
                            if (creationTx.expDate) exp = creationTx.expDate;
                            else if (creationTx.batchMeta && creationTx.batchMeta.expiry) exp = creationTx.batchMeta.expiry;
                        }
                        batchMap.set(t.batchNo, { qty: 0, expiry: exp });
                    }

                    // Calc Stock
                    const b = batchMap.get(t.batchNo);
                    if (['receive', 'produce', 'stock-take-adj-in', 'production-add', 'sales-return'].includes(t.type)) b.qty += t.quantity;
                    else if (['consume', 'dispatch', 'stock-take-adj-out', 'production-consume'].includes(t.type)) b.qty -= t.quantity;
                }
            });

            // 2. Filter & Sort by FEFO
            let batches = Array.from(batchMap.entries()).map(([no, data]) => ({ no, ...data }));
            batches = batches.filter(b => b.qty > 0.001); // Only positive stock

            // Sort: Earliest expiry first. Null expiry last.
            batches.sort((a, b) => {
                if (!a.expiry) return 1;
                if (!b.expiry) return -1;
                return new Date(a.expiry) - new Date(b.expiry);
            });

            // 3. Populate Select with Visual Alerts
            const today = new Date().toISOString().split('T')[0];

            batches.forEach(b => {
                const opt = document.createElement('option');
                opt.value = b.no;

                let label = `${b.no} (Qty: ${b.qty.toFixed(2)})`;
                let isExpired = false;

                if (b.expiry) {
                    label += ` [Exp: ${b.expiry}]`;
                    if (b.expiry < today) {
                        isExpired = true;
                        label += " ⛔ EXPIRED";
                    } else if (b.expiry < new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]) {
                        label += " ⚠️ EXPIRING SOON";
                    }
                }

                opt.textContent = label;
                if (isExpired) {
                    opt.style.color = 'red';
                    opt.style.fontWeight = 'bold';
                    // Optional: Disable selection of expired
                    // opt.disabled = true; 
                }

                batchSelect.appendChild(opt);
            });

            // Add change listener for blocking
            batchSelect.onchange = function () {
                const txt = this.options[this.selectedIndex].text;
                if (txt.includes('⛔')) {
                    alert("WARNING: Selected batch is EXPIRED! You should strictly not dispatch this.");
                    document.getElementById('dispatch-batch-alert').classList.remove('hidden');
                } else {
                    document.getElementById('dispatch-batch-alert').classList.add('hidden');
                }
            };
        };

        // ----------------------------------------------------------------
        // 4. GLOBAL SEARCH
        // ----------------------------------------------------------------

        window.initializeGlobalSearch = function () {
            const input = document.getElementById('global-search-input');
            const resultsDiv = document.getElementById('global-search-results');

            if (!input || !resultsDiv) return;

            input.addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase().trim();
                if (query.length < 2) {
                    resultsDiv.classList.add('hidden');
                    return;
                }

                // Search Logic
                let results = [];
                const MAX_RESULTS = 15;

                // 1. Customers
                (appState.customers || []).forEach(c => {
                    if (c.name.toLowerCase().includes(query) || (c.phone && c.phone.includes(query))) {
                        results.push({ type: 'Customer', text: c.name, id: c.id, view: 'customer-history', category: 'customer' });
                    }
                });

                // 2. Suppliers (ADDED)
                (appState.suppliers || []).forEach(s => {
                    if (s.name.toLowerCase().includes(query)) {
                        results.push({ type: 'Supplier', text: s.name, id: s.id, view: 'supplier-history', category: 'supplier' });
                    }
                });

                // 3. Finished Goods (CHANGED to List View for safety)
                (appState.inventory.finishedGoods || []).forEach(i => {
                    if (i.name.toLowerCase().includes(query)) {
                        results.push({ type: 'Finished Good', text: i.name, id: i.id, view: 'finishedGoods', category: 'finishedGoods' });
                    }
                });

                // 4. Raw Materials
                (appState.inventory.rawMaterials || []).forEach(i => {
                    if (i.name.toLowerCase().includes(query)) {
                        results.push({ type: 'Raw Material', text: i.name, id: i.id, view: 'raw-materials', category: 'rawMaterials' });
                    }
                });

                // 5. Packing Materials
                (appState.inventory.packingMaterials || []).forEach(i => {
                    if (i.name.toLowerCase().includes(query)) {
                        results.push({ type: 'Packing Material', text: i.name, id: i.id, view: 'packing-materials', category: 'packingMaterials' });
                    }
                });

                // 6. Labels
                (appState.inventory.labels || []).forEach(i => {
                    if (i.name.toLowerCase().includes(query)) {
                        results.push({ type: 'Label', text: i.name, id: i.id, view: 'labels', category: 'labels' });
                    }
                });

                // 7. Batches
                const seenBatches = new Set();
                (appState.transactions || []).forEach(t => {
                    if (t.batchNo && t.batchNo.toLowerCase().includes(query) && !seenBatches.has(t.batchNo)) {
                        seenBatches.add(t.batchNo);
                        results.push({ type: 'Batch', text: t.batchNo, id: t.itemId, view: 'batch-trace', category: 'batch' });
                    }
                });

                // Limit Results
                results = results.slice(0, MAX_RESULTS);

                // Render
                resultsDiv.innerHTML = results.map(r => `
                <div onclick="navigateToResult('${r.view}', '${r.id}', '${r.category}')" class="p-3 border-b hover:bg-blue-50 cursor-pointer flex justify-between items-center group transition-colors">
                    <div class="flex flex-col">
                        <span class="font-bold text-gray-700 group-hover:text-blue-700">${r.text}</span>
                        <span class="text-xs text-gray-400">ID: ${r.id}</span>
                    </div>
                    <span class="text-xs uppercase bg-gray-100 text-gray-600 px-2 py-1 rounded border border-gray-200 group-hover:bg-blue-200 group-hover:border-blue-300 group-hover:text-blue-800">${r.type}</span>
                </div>
                `).join('');

                if (results.length === 0) {
                    resultsDiv.innerHTML = `<div class="p-4 text-gray-500 text-center italic">No matching items found</div>`;
                }

                resultsDiv.classList.remove('hidden');
            });

            // Close on click outside
            document.addEventListener('click', (e) => {
                if (!input.contains(e.target) && !resultsDiv.contains(e.target)) {
                    resultsDiv.classList.add('hidden');
                }
            });
        };

        window.navigateToResult = function (view, id, category) {
            console.log(`Navigating to result: View=${view}, ID=${id}, Category=${category}`);

            try {
                // 1. Hide Search
                const searchUI = document.getElementById('global-search-results');
                const searchInput = document.getElementById('global-search-input');
                if (searchUI) searchUI.classList.add('hidden');
                if (searchInput) searchInput.value = '';

                // 2. Special Views Logic
                if (view === 'batch-trace') {
                    if (window.openProductTrace) window.openProductTrace(id);
                }
                else if (view === 'product-trace') {
                    if (window.openProductTrace) window.openProductTrace(id);
                }
                else if (view === 'customer-history') {
                    if (window.viewCustomerHistory) window.viewCustomerHistory(id);
                    else if (window.showView) window.showView('customers');
                    // Wait for render then click header or scroll
                }
                else if (view === 'supplier-history') {
                    if (window.viewSupplierHistory) window.viewSupplierHistory(id);
                    else if (window.showView) window.showView('suppliers');
                }
                else {
                    // 3. Standard Inventory Views
                    if (window.showView) {
                        // Map finishedGoods to finished-goods for showView compatibility
                        let targetView = view;
                        if (targetView === 'finishedGoods') targetView = 'finished-goods';

                        window.showView(targetView);

                        // 4. Highlight Logic
                        setTimeout(() => {
                            // Try finding by ID first (robust)
                            let row = document.getElementById(`item-${id}`);
                            // Fallback to data attribute query
                            if (!row) row = document.querySelector(`tr[data-item-id="${id}"]`);

                            if (row) {
                                row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                // Flash Effect
                                const originalBg = row.style.backgroundColor;
                                row.style.transition = "background-color 0.5s";
                                row.style.backgroundColor = "#fef08a"; // intense yellow
                                setTimeout(() => {
                                    row.style.backgroundColor = ""; // reset
                                }, 2000);
                            } else {
                                console.warn("Could not find row for highlighting ID:", id);
                            }
                        }, 600); // Increased delay slightly to ensure render completes
                    }
                }
            } catch (err) {
                console.error("Navigation Error:", err);
                alert("Could not load result. Check console.");
            }
        };

        // --- OVERRIDE renderTableBody to add IDs for Highlighting ---
        // (We must re-declare this helper here or ensure the original is updated. 
        //  Since we can't edit the middle of the file easily without context, 
        //  we will hook into the existing one or rely on the user to approve the specific edit in the middle of file previously planned.
        //  Actually, I will inject a wrapper or re-define it here if it's safe. 
        //  Re-defining 'renderTableBody' in this script block overrides the previous one because it's loaded later/executes later? 
        //  No, HTML parses sequentially. This block is at the END of the file (feature pack V3 loop). 
        //  So redefining it here is PERFECT.)

        const originalRenderTableBody = window.renderTableBody;

        // We need to fully replace it to inject the ID. Wrapping isn't enough for inner HTML.
        // So I will COPY the function body here with the FIX.

        window.renderTableBody = function (category) {
            const tableBody = document.getElementById(`${category}-table-body`);
            if (!tableBody) return;
            const searchInput = document.getElementById(`${category}-search-filter`);
            const searchFilter = searchInput ? searchInput.value.toLowerCase() : '';

            const outOfStockCheckbox = document.getElementById(`${category}-show-out-of-stock`);
            const showOutOfStock = outOfStockCheckbox ? outOfStockCheckbox.checked : false;

            const negativeStockCheckbox = document.getElementById(`${category}-show-negative-stock`);
            const showNegativeStock = negativeStockCheckbox ? negativeStockCheckbox.checked : false;

            const belowMinCheckbox = document.getElementById(`${category}-show-below-min`);
            const showBelowMin = belowMinCheckbox ? belowMinCheckbox.checked : false;

            let items = appState.inventory[category] || [];
            let itemCalculations = [];

            try {
                itemCalculations = items.map(item => {
                    try {
                        return { item, ...calculateStock(item, category, selectedDate) };
                    } catch (e) {
                        return { item, openingStock: 0, received: 0, consumed: 0, closingStock: 0 };
                    }
                });
            } catch (err) {
                tableBody.innerHTML = `<tr><td colspan="12" class="text-center py-4 text-red-500">Error loading data.</td></tr>`;
                return;
            }

            let filteredItems = itemCalculations.filter(({ item, closingStock }) => {
                if (window.isReorderMode) return true;
                try {
                    const name = item.name ? item.name.toLowerCase() : '';
                    if (searchFilter && !name.includes(searchFilter)) return false;
                    if (showNegativeStock && closingStock >= 0) return false;
                    if (showOutOfStock && !showNegativeStock && closingStock !== 0) return false;
                    if (showBelowMin && closingStock >= (item.minStockLevel || 0)) return false;
                    return true;
                } catch (e) { return false; }
            });

            // Re-use existing sort global
            if (!window.isReorderMode && window.currentSortColumn) {
                filteredItems.sort((a, b) => {
                    let valA = a.item[window.currentSortColumn];
                    let valB = b.item[window.currentSortColumn];
                    if (window.currentSortColumn === 'name') { valA = a.item.name.toLowerCase(); valB = b.item.name.toLowerCase(); }
                    if (window.currentSortColumn === 'closing') { valA = a.closingStock; valB = b.closingStock; }
                    if (valA < valB) return window.currentSortOrder === 'asc' ? -1 : 1;
                    if (valA > valB) return window.currentSortOrder === 'asc' ? 1 : -1;
                    return 0;
                });
            } else if (!window.isReorderMode) {
                // If no sort column, do not sort (Preserve insertion order)
            }

            if (filteredItems.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="12" class="text-center py-4">No items found.</td></tr>`;
                return;
            }

            tableBody.innerHTML = filteredItems.map(({ item, openingStock, received, consumed, closingStock }, index) => {
                const closingValue = (closingStock > 0 ? closingStock : 0) * (item.currentAverageCost || item.price);
                const noteIconClass = item.notes && item.notes.length > 0 ? 'has-notes' : '';
                // Assume Reorder Mode variables are global
                const draggingAttrs = window.isReorderMode ?
                    `draggable="true" style="cursor: move; border: 2px dashed #a855f7;" ondragstart="handleDragStart(event, ${appState.inventory[category].findIndex(i => i.id === item.id)})" ondragover="handleDragOver(event)" ondrop="handleDrop(event, ${appState.inventory[category].findIndex(i => i.id === item.id)}, '${category}')"` : '';

                // --- THE FIX: ADD ID ATTRIBUTE ---
                return `
                <tr id="item-${item.id}" data-item-id="${item.id}" ${draggingAttrs} class="hover:bg-gray-50 text-center text-sm ${window.isReorderMode ? 'bg-purple-50' : ''}">

                    <td class="p-2 border-b text-gray-500">${index + 1}</td>
                    <td class="p-2 border-b text-left font-bold text-gray-700">${item.name}</td>
                    <td class="p-2 border-b">${item.unit}</td>
                    <td class="p-2 border-b">${item.price.toFixed(2)}</td>
                    <td class="p-2 border-b text-blue-600">₹${(item.currentAverageCost || item.price).toFixed(2)}</td>
                    <td class="p-2 border-b">${(item.minStockLevel || 0).toFixed(3)}</td>
                    <td class="p-2 border-b font-extrabold text-blue-900 bg-blue-50/30">${openingStock.toFixed(3)}</td>
                    <td class="p-2 border-b">${received.toFixed(3)}</td>
                    <td class="p-2 border-b">${consumed.toFixed(3)}</td>
                    <td class="p-2 border-b font-bold">${closingStock.toFixed(3)}</td>
                    <td class="p-2 border-b">₹${closingValue.toFixed(2)}</td>
                    <td class="p-2 border-b"><span class="${noteIconClass}" onclick="openNotesModal('${category}', '${item.id}')">📝</span></td>
                    <td class="p-3 border text-center">
                        <div class="flex gap-1 justify-center items-center">
                            <button onclick="openStockTxModal('${category}', '${item.id}', 'receive')" class="px-2 py-1 bg-green-500 text-white text-xs rounded hover:bg-green-600" title="Receive">Recv</button>
                            <button onclick="openStockTxModal('${category}', '${item.id}', 'consume')" class="px-2 py-1 bg-red-500 text-white text-xs rounded hover:bg-red-600" title="Consume">Cons</button>
                             <button onclick="openEditItemModal('${category}', '${item.id}')" class="px-2 py-1 bg-yellow-500 text-white text-xs rounded hover:bg-yellow-600">Edit</button>
                             ${category === 'finishedGoods' ? `<button onclick="openProductTrace('${item.id}')" class="px-2 py-1 bg-purple-500 text-white text-xs rounded hover:bg-purple-600">Trace</button>` : ''}
                        </div>
                    </td>
                </tr>`;
            }).join('');
        };



        // ----------------------------------------------------------------
        // 5. PDF TRACEABILITY REPORT (Simple Print)
        // ----------------------------------------------------------------

        window.generateTraceabilityPDF = function (itemId) {
            // Check if jsPDF exists
            if (typeof jspdf !== 'undefined') {
                const doc = new jspdf.jsPDF();
                doc.text("Traceability Report", 10, 10);
                // ... complex PDF generation ...
                doc.save("Trace_Report.pdf");
            } else {
                // Robust Fallback: Print View
                const originalContent = document.body.innerHTML;
                const traceContent = document.getElementById('product-trace-view').innerHTML;

                document.body.innerHTML = `
        <div style="padding: 40px;">
            <h1 style="text-align: center; border-bottom: 2px solid #333; padding-bottom: 20px;">Traceability Report</h1>
            <div style="margin-top: 20px;">
                ${traceContent}
            </div>
            <div style="margin-top: 50px; text-align: center; font-size: 12px; color: #666;">
                Generated by Inventory System - ${new Date().toLocaleString()}
            </div>
        </div>
        `;

                window.print();

                // Restore
                setTimeout(() => {
                    document.body.innerHTML = originalContent;
                    window.location.reload(); // Safer to reload to restore event listeners
                }, 500);
            }
        };


        // ----------------------------------------------------------------
        // INITIALIZATION
        // ----------------------------------------------------------------

        // Add Dispatch Alert Box if not exists
        const setupDispatchAlert = () => {
            const container = document.getElementById('dispatch-batch')?.parentNode;
            if (container && !document.getElementById('dispatch-batch-alert')) {
                const div = document.createElement('div');
                div.id = 'dispatch-batch-alert';
                div.className = 'hidden mt-2 p-2 bg-red-100 text-red-700 text-sm font-bold border border-red-300 rounded';
                div.innerText = "⛔ ATTENTION: This batch is expired!";
                container.appendChild(div);
            }
        };

        // Initialize All - REMOVED redundant call to prevent duplicate links
        // if (window.initializeInventoryImprovements) window.initializeInventoryImprovements();
        setTimeout(setupDispatchAlert, 2000); // Late init for DOM

        console.log("ANTIGRAVITY: Feature Pack V1 Loaded Successfully.");
    </script>

    <script>
        // ================================================================
        // FEATURE PACK V2: UI FIXES (FAB & ROBUST SEARCH)
        // ================================================================

        // 1. Redefine Initialization to be Robust
        // 1. Redefine Initialization to be Robust
        window.initializeInventoryImprovements = function () {
            console.log('Loading improvements (V2 - UI Fixed)...');
            try {
                // Use V3 Combined Fixes if available
                if (window.setupFeaturePackV3Fixes) {
                    window.setupFeaturePackV3Fixes();
                } else {
                    if (window.addCustomStyles) window.addCustomStyles();
                    if (window.addProductTraceSidebarLink) window.addProductTraceSidebarLink();
                    if (window.addProductTraceViewContainer) window.addProductTraceViewContainer();
                }

                addCustomStylesV2(); // Add new styles for FAB

                // Use Robust Search Bar
                addGlobalSearchBarRobust();

                if (window.addReturnModal) window.addReturnModal();

                // Add FAB
                addFloatingToolsButton();

                if (window.initializeGlobalSearch) window.initializeGlobalSearch();

                console.log('✅ Improvements loaded! Antigravity Tools Active.');
            } catch (error) {
                console.error('Error loading improvements:', error);
            }
        };

        // 2. New Styles
        function addCustomStylesV2() {
            const style = document.createElement('style');
            style.textContent = `
        #antigravity-tools-fab {transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        #antigravity-tools-fab:hover {transform: scale(1.1) rotate(5deg); box-shadow: 0 10px 25px -5px rgba(79, 70, 229, 0.5); }
        .animated {animation - duration: 0.3s; animation-fill-mode: both; }
        .fadeIn {animation - name: fadeIn; }
        @keyframes fadeIn {from {opacity: 0; transform: translateY(10px); } to {opacity: 1; transform: translateY(0); } }
        `;
            document.head.appendChild(style);
        }

        // 3. Floating Action Button (The "Fix" for missing UI)
        function addFloatingToolsButton() {
            if (document.getElementById('antigravity-tools-fab')) return;

            // FAB
            const fab = document.createElement('button');
            fab.id = 'antigravity-tools-fab';
            fab.className = 'fixed bottom-6 right-6 bg-indigo-600 text-white p-4 rounded-full shadow-2xl hover:bg-indigo-700 z-50 flex items-center justify-center border-4 border-white ring-2 ring-indigo-200';
            fab.innerHTML = `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg><span class="ml-2 font-bold hidden group-hover:block">Tools</span>`;
            fab.title = "Open Inventory Tools";
            fab.onclick = window.openToolsModal;
            document.body.appendChild(fab);

            // MODAL
            const modalHTML = `
        <div id="toolsModal" class="modal fixed inset-0 bg-black bg-opacity-50 justify-center items-center z-50 hidden backdrop-blur-sm">
            <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-lg animated fadeIn relative border border-gray-100">
                <button onclick="document.getElementById('toolsModal').classList.add('hidden'); document.getElementById('toolsModal').classList.remove('flex');" class="absolute top-4 right-4 text-gray-400 hover:text-gray-800 text-2xl font-bold">&times;</button>
                <div class="flex items-center gap-3 mb-6 border-b pb-4">
                    <div class="p-2 bg-indigo-100 rounded-lg text-indigo-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-800">Advanced Tools</h3>
                </div>

                <div class="space-y-6">
                    <div>
                        <h4 class="font-bold text-xs uppercase text-gray-400 tracking-wider mb-3">Data Exports (CSV)</h4>
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="exportCustomerWiseData()" class="flex items-center gap-2 px-3 py-2 bg-blue-50 text-blue-700 rounded-lg hover:bg-blue-100 font-semibold text-sm transition-colors border border-blue-100">
                                <span>👥</span> Customers
                            </button>
                            <button onclick="exportSupplierWiseData()" class="flex items-center gap-2 px-3 py-2 bg-green-50 text-green-700 rounded-lg hover:bg-green-100 font-semibold text-sm transition-colors border border-green-100">
                                <span>🚚</span> Suppliers
                            </button>
                            <button onclick="exportSalesDataCustomerWise()" class="flex items-center gap-2 px-3 py-2 bg-purple-50 text-purple-700 rounded-lg hover:bg-purple-100 font-semibold text-sm transition-colors border border-purple-100">
                                <span>📈</span> Sales (Cust)
                            </button>
                            <button onclick="exportSalesDataProductWise()" class="flex items-center gap-2 px-3 py-2 bg-orange-50 text-orange-700 rounded-lg hover:bg-orange-100 font-semibold text-sm transition-colors border border-orange-100">
                                <span>📦</span> Sales (Prod)
                            </button>
                            <button onclick="exportAllDataAtOnce()" class="col-span-2 flex justify-center items-center gap-2 px-3 py-3 bg-gray-800 text-white rounded-lg hover:bg-gray-900 font-bold text-sm shadow transition-transform hover:scale-[1.02]">
                                <span>💾</span> Export Full Transaction Database
                            </button>
                        </div>
                    </div>

                    <div>
                        <h4 class="font-bold text-xs uppercase text-gray-400 tracking-wider mb-3">Operations</h4>
                        <div class="grid grid-cols-1 gap-3">
                            <button onclick="if(window.openReturnModal) openReturnModal(); else alert('Return Modal not loaded');" class="px-4 py-3 bg-red-50 text-red-700 rounded-lg hover:bg-red-100 font-bold text-left border border-red-200 flex items-center justify-between transition-colors">
                                <span class="flex items-center gap-2"><span>↺</span> Process Return / Replacement</span>
                                <span class="text-red-400">→</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="mt-6 text-center text-xs text-gray-400">
                    Antigravity Feature Pack V1.2
                </div>
            </div>
        </div>
        `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        window.openToolsModal = function () {
            const m = document.getElementById('toolsModal');
            if (m) {
                m.classList.remove('hidden');
                m.classList.add('flex');
            }
        }

        // 4. Robust Search Bar (Fallback to body if main missing)
        function addGlobalSearchBarRobust() {
            // Try main first
            let parent = document.querySelector('main.flex-1');
            if (!parent) parent = document.querySelector('main');
            if (!parent) parent = document.body; // Fallback to body

            // Check if exists
            if (document.getElementById('global-search-container')) return;

            const searchBar = document.createElement('div');
            searchBar.className = 'bg-white border-b p-4 shadow-sm sticky top-0 z-40'; // Sticky
            searchBar.innerHTML = `<div id="global-search-container" class="relative w-full max-w-2xl mx-auto"><div class="relative"><input type="text" id="global-search-input" placeholder="🔍 Search: Items | Customers | Suppliers | Batches..." class="w-full px-4 py-3 pr-10 border-2 border-indigo-100 rounded-lg focus:border-indigo-500 focus:outline-none text-lg shadow-sm"><button onclick="document.getElementById('global-search-results').classList.add('hidden')" class="absolute right-3 top-3 text-gray-400 hover:text-gray-600 text-xl font-bold">✕</button></div><div id="global-search-results" class="hidden absolute top-full left-0 right-0 mt-2 bg-white border-2 border-indigo-100 rounded-lg shadow-2xl z-50 max-h-96 overflow-y-auto"></div></div>`;

            if (parent === document.body) {
                // If body, insert at top
                parent.insertBefore(searchBar, parent.firstChild);
            } else {
                parent.insertBefore(searchBar, parent.firstChild);
            }
        }

        // Auto-run init again to apply fixes immediately
        if (window.initializeInventoryImprovements) window.initializeInventoryImprovements();

        console.log("ANTIGRAVITY: UI Fixes V2 Applied (FAB & Robust Search).");
    </script>

    <script>
        // ================================================================
        // FEATURE PACK V3: SEARCH FIX, RETURNS RE-INJECT, TRACE BUTTON
        // Antigravity AI - V3.0
        // ================================================================

        console.log("ANTIGRAVITY: Loading Feature Pack V3 (Fixes)...");

        // 1. RE-INJECT RETURN MODAL (Explicitly)
        // The user reported "Return modal structure missing", so we force-inject it.
        window.addReturnModal = function () {
            if (document.getElementById('returnModal')) return; // Already exists

            const returnModalHTML = `
        <div id="returnModal" class="modal fixed inset-0 bg-black bg-opacity-50 justify-center items-center z-50 hidden backdrop-blur-sm">
            <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md max-h-[90vh] overflow-y-auto animated fadeIn">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h3 class="text-xl font-bold text-orange-700 flex items-center gap-2">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 15l-3-3m0 0l3-3m-3 3h8M3 12a9 9 0 1118 0 9 9 0 01-18 0z"></path></svg>
                        Process Return
                    </h3>
                    <button onclick="closeModal('returnModal')" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
                </div>
                <form id="return-form" onsubmit="processReturn(event)">
                    <input type="hidden" id="return-dispatch-id">
                        <input type="hidden" id="return-customer-id">
                            <input type="hidden" id="return-category">
                                <input type="hidden" id="return-item-id">
                                    <input type="hidden" id="return-max-qty-value">

                                        <div class="mb-3">
                                            <label class="block text-sm font-bold mb-1">Return Date</label>
                                            <input type="date" id="return-date" class="w-full p-2 border rounded-md focus:border-orange-500 outline-none" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="block text-sm font-bold mb-1">Customer Name</label>
                                            <input type="text" id="return-customer-name" class="w-full p-2 border rounded-md" placeholder="Who is returning this?" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="block text-sm font-bold mb-1">Item to Return</label>
                                            <select id="return-item-select" class="w-full p-2 border rounded-md" onchange="document.getElementById('return-item-id').value = this.value">
                                                <option value="">-- Select Product --</option>
                                                ${(appState.inventory.finishedGoods || []).map(i => `<option value="${i.id}">${i.name} (${i.unit})</option>`).join('')}
                                            </select>
                                        </div>
                                        <div class="mb-3 grid grid-cols-2 gap-2">
                                            <div>
                                                <label class="block text-sm font-bold mb-1">Quantity</label>
                                                <input type="number" id="return-quantity" step="0.001" class="w-full p-2 border rounded-md font-bold text-orange-700" placeholder="0.00" required>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="block text-sm font-bold mb-1">Reason</label>
                                            <select id="return-reason" class="w-full p-2 border rounded-md" required>
                                                <option value="">Select reason...</option>
                                                <option value="damage">Damage / Defect</option>
                                                <option value="expiry">Expired</option>
                                                <option value="wrong_delivery">Wrong Delivery</option>
                                                <option value="quality_issue">Quality Issue</option>
                                                <option value="excess_quantity">Excess / Unsold</option>
                                                <option value="other">Other</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label class="block text-sm font-bold mb-1">Batch Number</label>
                                            <input type="text" id="return-batch-no" class="w-full p-2 border rounded-md font-mono text-sm uppercase" placeholder="Batch No (if known)">
                                        </div>
                                        <div class="mb-4">
                                            <label class="block text-sm font-bold mb-1">Notes</label>
                                            <textarea id="return-notes" class="w-full p-2 border rounded-md" rows="2"></textarea>
                                        </div>
                                        <div class="flex justify-end gap-3 pt-2 border-t">
                                            <button type="button" onclick="closeModal('returnModal')" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-bold">Cancel</button>
                                            <button type="submit" class="px-6 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 font-bold shadow-md">Confirm Return</button>
                                        </div>
                                    </form>
                                </div>
                            </div>`;
            document.body.insertAdjacentHTML('beforeend', returnModalHTML);
            console.log("ANTIGRAVITY: Return Modal structure injected.");
        };

        window.openReturnModal = function () {
            if (!document.getElementById('returnModal')) addReturnModal(); // Just in case
            const modal = document.getElementById('returnModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.getElementById('return-date').value = new Date().toISOString().split('T')[0];

            // Refresh item select
            const sel = document.getElementById('return-item-select');
            if (sel) sel.innerHTML = `<option value="">-- Select Product --</option>` + (appState.inventory.finishedGoods || []).map(i => `<option value="${i.id}">${i.name} (${i.unit})</option>`).join('');
        };

        // ================================================================
        // FIX 4: MISSING PAUSE / RESUME LOGIC & COMPLETION MODAL OVERRIDE
        // ================================================================

        window.openPauseModal = function (batchId) {
            const batch = appState.activeProduction.find(b => b.id == batchId);
            if (!batch) return;

            const reason = prompt("Enter reason for pausing this production:", "Machine Maintenance");
            if (reason) {
                batch.status = 'paused';
                batch.pauseReason = reason;
                saveState();
                renderProductionWIPView();
                // Optional: Show alert
                // if(window.showAlert) showAlert("Batch Paused");
            }
        };

        window.resumeProduction = function (batchId) {
            const batch = appState.activeProduction.find(b => b.id == batchId);
            if (!batch) return;

            if (confirm("Resume production for this batch?")) {
                batch.status = 'started';
                delete batch.pauseReason;
                saveState();
                renderProductionWIPView();
            }
        };

        // FORCE OVERRIDE OLD MODAL CALLS
        // The user's HTML likely calls 'completeBatch(id)' which might be pointing to an old function.
        // We redirect it effectively to the new one.
        window.completeBatch = function (batchId) {
            window.openCompleteProductionModal(batchId);
        };

        // RE-INFORCE DECIMAL PRECISION & LABELS IN COMPLETION MODAL
        // We wrap the opener to adjust the DOM immediately after opening.
        const originalOpenComplete = window.openCompleteProductionModal;
        window.openCompleteProductionModal = function (batchId) {
            if (originalOpenComplete) originalOpenComplete(batchId);

            // 1. Update Header "Plan Qty" -> "Reserved"
            setTimeout(() => {
                const tableHeaders = document.querySelectorAll('#completeProductionModal th');
                tableHeaders.forEach(th => {
                    if (th.textContent.includes('Plan Qty')) {
                        th.textContent = 'Reserved'; // User preferred term
                    }
                });

                // 2. Ensure 3 Decimal Places in Inputs (Visual Check)
                const inputs = document.querySelectorAll('.cp-consumed-input');
                inputs.forEach(inp => {
                    // If value is like "4.4", make it "4.400"
                    const val = parseFloat(inp.value);
                    if (!isNaN(val)) inp.value = val.toFixed(3);
                    // Also enforce on change
                    inp.onblur = function () {
                        const v = parseFloat(this.value);
                        if (!isNaN(v)) this.value = v.toFixed(3);
                    };
                });
            }, 50);
        };

        window.navigateToResult = function (view, id, category) {
            try {
                const idStr = String(id);
                console.log(`Navigating to result: View=${view}, ID=${idStr}, Category=${category}`);

                // Hide Search UI
                const searchUI = document.getElementById('global-search-results');
                if (searchUI) searchUI.classList.add('hidden');
                const input = document.getElementById('global-search-input');
                if (input) input.value = '';

                if (view === 'batch-trace') {
                    if (window.openProductTrace) {
                        if (!idStr || idStr === 'undefined') { alert("Cannot trace: Item ID missing."); return; }
                        window.openProductTrace(idStr);
                    }
                } else if (view === 'product-trace') {
                    if (window.openProductTrace) window.openProductTrace(idStr);
                } else if (view === 'customer-history') {
                    if (window.viewCustomerHistory) window.viewCustomerHistory(idStr);
                    else if (window.showView) window.showView('customers');
                } else if (view === 'supplier-history') {
                    if (window.viewSupplierHistory) window.viewSupplierHistory(idStr);
                    else if (window.showView) window.showView('suppliers');
                } else {
                    // Standard View Navigation
                    let targetView = view;
                    // FIX 1: Mapping
                    if (targetView === 'finishedGoods') targetView = 'finished-goods';
                    if (targetView === 'rawMaterials') targetView = 'raw-materials';
                    if (targetView === 'packingMaterials') targetView = 'packing-materials';

                    if (window.showView) window.showView(targetView);

                    // FIX 3: Clear Local Search & Filters
                    // We must clear the specific search box for the target view to ensure the item isn't filtered out
                    const viewSearchMap = {
                        'finished-goods': 'finishedGoods-search-filter',
                        'raw-materials': 'rawMaterials-search-filter',
                        'packing-materials': 'packingMaterials-search-filter',
                        'labels': 'labels-search-filter'
                    };

                    const searchId = viewSearchMap[targetView];
                    if (searchId) {
                        const localInput = document.getElementById(searchId);
                        if (localInput) {
                            localInput.value = '';
                            // dispatch input event to trigger filtering (show all)
                            localInput.dispatchEvent(new Event('input', { bubbles: true }));
                        }
                    }

                    // FIX 2: Highlighting & Scrolling - Robust Wait
                    let attempts = 0;
                    const highlightInterval = setInterval(() => {
                        attempts++;

                        // Normalize category for ID construction
                        let idPrefix = category;
                        if (category === 'customer') idPrefix = 'customers';
                        if (category === 'supplier') idPrefix = 'suppliers';

                        // Try exact namespaced ID first (Best Practice)
                        let row = document.getElementById(`row-${idPrefix}-${idStr}`);

                        // Fallback: Search within the ACTIVE view container just in case ID is generic or duplicates exist
                        if (!row) {
                            const currentViewContainer = document.getElementById(targetView + '-view');
                            if (currentViewContainer) {
                                row = currentViewContainer.querySelector(`tr[data-item-id="${idStr}"]`);
                            }
                        }

                        // Strict Fallback (Backwards compat)
                        if (!row) row = document.getElementById(`item-${idStr}`);

                        if (row) {
                            clearInterval(highlightInterval);
                            console.log("Found row:", row);
                            // 1. Scroll
                            row.scrollIntoView({ behavior: 'auto', block: 'center', inline: 'center' });
                            // 2. Highlight
                            row.classList.add('bg-yellow-200');
                        }

                        if (attempts > 20 && !row) { // Stop trying after 20 attempts if row not found
                            clearInterval(highlightInterval);
                            console.warn(`Could not find row for ${idStr} after ${attempts} attempts.`);
                        }
                    }, 100); // Check every 100ms
                }

                // 3. ENHANCE PRODUCT TRACE VIEW (Explicit PDF Button)
                // We override renderProductTraceView to ensure the Print/PDF button is BIG and visible.
                // We'll wrap the existing one or redefine it if needed.
                // For safety, let's inject a "Print Report" button into the DOM of the trace view after it renders.

                const originalRenderTrace = window.renderProductTraceView;
                window.renderProductTraceView = function (item) {
                    if (originalRenderTrace) originalRenderTrace(item);

                    // Inject PDF Button into the header area
                    setTimeout(() => {
                        const container = document.getElementById('product-trace-view');
                        if (!container) return;

                        const headerH2 = container.querySelector('h2');
                        if (headerH2 && !document.getElementById('btn-trace-pdf')) {
                            const btn = document.createElement('button');
                            btn.id = 'btn-trace-pdf';
                            btn.className = 'ml-4 px-4 py-2 bg-red-600 text-white rounded shadow hover:bg-red-700 font-bold text-sm flex items-center gap-2';
                            btn.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 2H7a2 2 0 00-2 2v15a2 2 0 002 2z"></path></svg> Download PDF Report`;
                            btn.onclick = () => window.generateTraceabilityPDF(item.id);

                            // Insert next to title
                            headerH2.parentNode.insertBefore(btn, headerH2.nextSibling);
                        }
                    }, 100);
                };
            } catch (err) {
                console.error("Navigation Error:", err);
                alert("Error navigating: " + err.message);
            }
        };


        // 4. Force Re-run Inits
        if (window.addReturnModal) addReturnModal();
        console.log("ANTIGRAVITY: Feature Pack V3 (Fixes) Correctly Applied.");

        window.initializeGlobalSearch = function () {
            console.log("Initializing Global Search...");
            const input = document.getElementById('global-search-input');
            const resultsDiv = document.getElementById('global-search-results');

            if (!input || !resultsDiv) return;

            // Remove old listener if any (by cloning)
            const newHelper = input.cloneNode(true);
            input.parentNode.replaceChild(newHelper, input);
            const searchInput = newHelper;

            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase().trim();
                if (query.length < 2) {
                    resultsDiv.classList.add('hidden');
                    return;
                }

                let results = [];
                const MAX_RESULTS = 20;

                // 1. Customers
                if (appState.customers) {
                    appState.customers.forEach(c => {
                        if (c.name.toLowerCase().includes(query) || (c.phone && c.phone.includes(query))) {
                            results.push({ type: 'Customer', text: c.name, id: c.id, view: 'customers', category: 'customer' });
                        }
                    });
                }

                // 2. Suppliers
                if (appState.suppliers) {
                    appState.suppliers.forEach(s => {
                        if (s.name.toLowerCase().includes(query)) {
                            results.push({ type: 'Supplier', text: s.name, id: s.id, view: 'suppliers', category: 'supplier' });
                        }
                    });
                }

                // 3. Inventory Categories
                const categories = [
                    { key: 'finishedGoods', label: 'Finished Good', view: 'finished-goods' },
                    { key: 'rawMaterials', label: 'Raw Material', view: 'raw-materials' },
                    { key: 'packingMaterials', label: 'Packing Material', view: 'packing-materials' },
                    { key: 'labels', label: 'Label', view: 'labels' }
                ];

                categories.forEach(cat => {
                    if (appState.inventory[cat.key]) {
                        appState.inventory[cat.key].forEach(i => {
                            if (i.name.toLowerCase().includes(query)) {
                                results.push({ type: cat.label, text: i.name, id: i.id, view: cat.view, category: cat.key });
                            }
                        });
                    }
                });

                // 4. Batches
                appState.transactions.forEach(t => {
                    if (t.batchNo && t.batchNo.toLowerCase().includes(query)) {
                        if (!results.some(r => r.text === t.batchNo && r.type === 'Batch')) {
                            results.push({ type: 'Batch', text: t.batchNo, id: t.itemId, view: 'batch-trace', category: 'batch' });
                        }
                    }
                });

                results = results.slice(0, MAX_RESULTS);

                if (results.length > 0) {
                    resultsDiv.innerHTML = results.map(r => `
                    <div class="p-3 hover:bg-gray-100 cursor-pointer border-b border-gray-200" 
                         onclick="navigateToResult('${r.view}', ${r.id}, '${r.category}')">
                        <span class="text-xs font-semibold text-blue-600">${r.type}</span>
                        <p class="text-sm font-medium text-gray-900">${r.text}</p>
                    </div>
                `).join('');
                    resultsDiv.classList.remove('hidden');
                } else {
                    resultsDiv.innerHTML = `<div class="p-4 text-gray-500 text-center italic">No matching items found</div>`;
                    resultsDiv.classList.remove('hidden');
                }
            });

            document.addEventListener('click', (e) => {
                if (!searchInput.contains(e.target) && !resultsDiv.contains(e.target)) {
                    resultsDiv.classList.add('hidden');
                }
            });
        };

        // Auto-init
        if (window.initializeGlobalSearch) initializeGlobalSearch();

    </script>

    <script>
        // ================================================================
        // FEATURE PACK V4: PDF CONTENT FIX & RETURNS TRACKING
        // Antigravity AI - V4.0
        // ================================================================

        console.log("ANTIGRAVITY: Loading Feature Pack V4 (PDF & Returns Fix)...");

        // 1. UPDATED STOCK CALCULATION TO INCLUDE RETURNS
        // We need to override the core logic to treat 'sales-return' as an addition to stock.
        const originalCalculateStock = window.calculateStock;
        window.calculateStock = function (item, category, targetDateStr) {
            if (!originalCalculateStock) return { openingStock: 0, received: 0, consumed: 0, closingStock: 0 };

            // Get base calc
            const base = originalCalculateStock(item, category, targetDateStr);

            // Manual adjustment for 'sales-return' if not already handled by 'receive' logic
            // We check if 'sales-return' is already included in 'received'.
            // The original logic filters for: 'receive', 'stock-take-adj-in', 'production-add'.
            // It DOES NOT include 'sales-return'.

            // So we must add it manually to 'received' and 'closingStock'.
            const targetDate = window.getStartOfDay ? getStartOfDay(targetDateStr) : new Date();

            // Find returns for this item up to target date
            const returns = appState.transactions.filter(t =>
                t.type === 'sales-return' &&
                t.itemId == item.id &&
                (window.getStartOfDay ? getStartOfDay(t.date) <= targetDate : true)
            ).reduce((sum, t) => sum + parseFloat(t.quantity || 0), 0);

            if (returns > 0) {
                // console.log(`Found returns for ${item.name}: ${returns}`);
                base.received += returns;
                base.closingStock += returns;
            }

            return base;
        };


        // 2. VISUAL RETURNS HISTORY
        // We verify if we can append this to the Sales view, or just provide a quick "View Returns" modal.
        window.viewReturnsHistory = function () {
            const returns = appState.transactions.filter(t => t.type === 'sales-return');

            let html = `
        <div class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-[60]" id="returnsHistoryModal">
            <div class="bg-white p-6 rounded-lg w-full max-w-4xl max-h-[80vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-red-700">Returns History</h3>
                    <button onclick="document.getElementById('returnsHistoryModal').remove()" class="text-2xl">&times;</button>
                </div>
                
                <table class="w-full text-sm text-left">
                    <thead class="bg-gray-100 text-gray-700 uppercase">
                        <tr>
                            <th class="p-2">Date</th>
                            <th class="p-2">Item</th>
                            <th class="p-2">Qty</th>
                            <th class="p-2">Reason</th>
                            <th class="p-2">Notes</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y">
                        ${returns.length === 0 ? '<tr><td colspan="5" class="p-4 text-center text-gray-500">No returns recorded.</td></tr>' :
                    returns.map(t => {
                        const item = (appState.inventory.finishedGoods || []).find(i => i.id == t.itemId);
                        const itemName = item ? item.name : `ID: ${t.itemId}`;

                        // Handle notes safely
                        let pNote = '';
                        let fNote = '';
                        if (t.notes) {
                            pNote = t.notes.split('.')[0] || 'Return';
                            fNote = t.notes;
                        } else {
                            pNote = 'Return';
                        }

                        return `
                                <tr class="hover:bg-gray-50">
                                    <td class="p-2">${t.date.split('T')[0]}</td>
                                    <td class="p-2 font-bold">${itemName}</td>
                                    <td class="p-2 text-red-600 font-bold">+${t.quantity}</td>
                                    <td class="p-2"><span class="px-2 py-1 bg-gray-200 rounded text-xs">${pNote}</span></td>
                                    <td class="p-2 text-gray-500 truncate max-w-xs">${fNote}</td>
                                </tr>
                              `;
                    }).join('')
                }
                    </tbody>
                </table>
            </div>
        </div>
    `;
            document.body.insertAdjacentHTML('beforeend', html);
        };

        // Add "View History" button to Tools Modal
        setTimeout(() => {
            const toolsModal = document.getElementById('toolsModal');
            if (toolsModal) {
                // We look for the operations column or just append to the modal actions
                // The modal structure in V2 was:
                // div.space-y-6 -> div -> div.grid (Exports)
                //               -> div -> div.grid (Operations)

                const operatorDivs = toolsModal.querySelectorAll('.space-y-6 > div');
                if (operatorDivs.length >= 2) {
                    const opsGrid = operatorDivs[1].querySelector('.grid');
                    if (opsGrid && !document.getElementById('btn-view-returns')) {
                        const btn = document.createElement('button');
                        btn.id = 'btn-view-returns';
                        btn.className = "px-4 py-3 bg-gray-50 text-gray-700 rounded-lg hover:bg-gray-100 font-bold text-left border border-gray-200 flex items-center justify-between transition-colors";
                        btn.onclick = window.viewReturnsHistory;
                        btn.innerHTML = `<span class="flex items-center gap-2"><span>📜</span> View Returns Log</span><span class="text-gray-400">→</span>`;
                        opsGrid.appendChild(btn);
                    }
                }
            }
        }, 1000);


        // 3. FIX PDF CONTENT GENERATION
        // The previous simple fallback relied on window.print() of replaced body, but maybe styles were lost or timing was off.
        // We will inject a print-specific style and better content wrapper.
        window.generateTraceabilityPDF = function (itemId) {
            const originalContent = document.body.innerHTML;
            const traceView = document.getElementById('product-trace-view');

            if (!traceView || traceView.innerHTML.trim() === "") {
                alert("Please search for a batch first and ensure the Trace view is visible.");
                return;
            }

            const contentClone = traceView.cloneNode(true);
            // Remove the PDF button itself from the clone to avoid recursion in print
            const btn = contentClone.querySelector('#btn-trace-pdf');
            if (btn) btn.remove();

            // Create a print container
            const printContainer = document.createElement('div');
            printContainer.id = 'print-container';
            printContainer.style.cssText = `
        padding: 40px; 
        font-family: sans-serif; 
        background: white; 
        color: black;
    `;
            printContainer.innerHTML = `
        <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 15px;">
            <h1 style="font-size: 24px; font-weight: bold; margin: 0;">Traceability Report</h1>
            <p style="margin: 5px 0 0 0; color: #666;">Generated on ${new Date().toLocaleString()}</p>
        </div>
        <div class="trace-content">
            ${contentClone.innerHTML}
        </div>
        <div style="margin-top: 50px; text-align: center; border-top: 1px solid #ccc; padding-top: 10px; font-size: 11px; color: #888;">
            End of Report - Miklens Inventory System
        </div>
    `;

            // Swap Body
            document.body.innerHTML = "";
            document.body.appendChild(printContainer);

            // Force styles for print
            const style = document.createElement("style");
            style.innerHTML = `
        @media print {
            @page { margin: 20px; }
            body { -webkit-print-color-adjust: exact; margin: 0; padding: 0; background: white; }
            #print-container { width: 100%; }
            .trace-content { font-size: 12pt; }
            table { width: 100%; border-collapse: collapse; margin-top: 15px; }
            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
            th { background-color: #f3f4f6; font-weight: bold; }
        }
    `;
            document.head.appendChild(style);

            // Print and Restore
            setTimeout(() => {
                window.print();
                setTimeout(() => {
                    window.location.reload();
                }, 500); // Wait for print dialog to close/interact
            }, 500); // Wait for DOM render
        };

        console.log("ANTIGRAVITY: Feature Pack V4 (Fixes) Applied.");
    </script>

    <script>
        // ================================================================
        // FEATURE PACK V5: COMPREHENSIVE FIXES (Reports, Returns, Exports)
        // Antigravity AI - V5.0
        // ================================================================

        console.log("ANTIGRAVITY: Loading Feature Pack V5...");

        // ----------------------------------------------------------------
        // 1. SAFETY & INITIALIZATION FIXES
        // ----------------------------------------------------------------

        // Safe accessor for Inventory
        function getInventorySafe(category) {
            if (!appState || !appState.inventory) return [];
            return appState.inventory[category] || [];
        }

        // Fixed Return Modal Injection (Prevents undef crash)
        window.addReturnModal = function () {
            if (document.getElementById('returnModal')) return;

            // Safe items list generation
            const items = getInventorySafe('finishedGoods');
            const options = items.map(i => `<option value="${i.id}">${i.name} (${i.unit})</option>`).join('');

            const returnModalHTML = `
    <div id="returnModal" class="modal fixed inset-0 bg-black bg-opacity-50 justify-center items-center z-50 hidden backdrop-blur-sm">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md max-h-[90vh] overflow-y-auto animated fadeIn">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-xl font-bold text-orange-700 flex items-center gap-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 15l-3-3m0 0l3-3m-3 3h8M3 12a9 9 0 1118 0 9 9 0 01-18 0z"></path></svg>
                    Process Return
                </h3>
                <button onclick="closeModal('returnModal')" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <form id="return-form" onsubmit="processReturn(event)">
                <input type="hidden" id="return-dispatch-id">
                <input type="hidden" id="return-customer-id">
                <input type="hidden" id="return-category">
                <input type="hidden" id="return-item-id">

                <div class="mb-3">
                    <label class="block text-sm font-bold mb-1">Return Date</label>
                    <input type="date" id="return-date" class="w-full p-2 border rounded-md" required>
                </div>
                <div class="mb-3">
                    <label class="block text-sm font-bold mb-1">Customer Name</label>
                    <input type="text" id="return-customer-name" class="w-full p-2 border rounded-md" placeholder="Who is returning this?" required>
                </div>
                <div class="mb-3">
                    <label class="block text-sm font-bold mb-1">Item to Return</label>
                    <select id="return-item-select" class="w-full p-2 border rounded-md" onchange="document.getElementById('return-item-id').value = this.value">
                        <option value="">-- Select Product --</option>
                        ${options}
                    </select>
                </div>
                <div class="mb-3">
                    <label class="block text-sm font-bold mb-1">Quantity</label>
                    <input type="number" id="return-quantity" step="0.001" class="w-full p-2 border rounded-md font-bold text-orange-700" placeholder="0.00" required>
                </div>
                <div class="mb-3">
                    <label class="block text-sm font-bold mb-1">Reason</label>
                    <select id="return-reason" class="w-full p-2 border rounded-md" required>
                        <option value="">Select reason...</option>
                        <option value="damage">Damage / Defect</option>
                        <option value="expiry">Expired</option>
                        <option value="wrong_delivery">Wrong Delivery</option>
                        <option value="quality_issue">Quality Issue</option>
                        <option value="excess_quantity">Excess / Unsold</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="block text-sm font-bold mb-1">Batch Number</label>
                    <input type="text" id="return-batch-no" class="w-full p-2 border rounded-md font-mono text-sm uppercase" placeholder="Batch No (if known)">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-bold mb-1">Notes</label>
                    <textarea id="return-notes" class="w-full p-2 border rounded-md" rows="2"></textarea>
                </div>
                <div class="flex justify-end gap-3 pt-2 border-t">
                    <button type="button" onclick="closeModal('returnModal')" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-bold">Cancel</button>
                    <button type="submit" class="px-6 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 font-bold shadow-md">Confirm Return</button>
                </div>
            </form>
        </div>
    </div>`;
            document.body.insertAdjacentHTML('beforeend', returnModalHTML);
        };

        // ----------------------------------------------------------------
        // 2. STOCK LOGIC OVERRIDES (Fixing Reports)
        // ----------------------------------------------------------------

        // Override Calculate Stock to include 'sales-return'
        window.calculateStock = function (item, category, targetDateStr) {
            if (!item || !item.openingStockDate) return { openingStock: 0, received: 0, consumed: 0, closingStock: 0 };

            const targetDate = getStartOfDay(targetDateStr);
            const itemOpeningDate = getStartOfDay(item.openingStockDate);

            // Filter txs on the exact date
            const transactionsOnTargetDate = appState.transactions.filter(tx =>
                tx.category === category && tx.itemId == item.id && getStartOfDay(tx.date).getTime() === targetDate.getTime()
            );

            // ADDED 'sales-return' to RECEIVED list
            const received = transactionsOnTargetDate
                .filter(t => ['receive', 'stock-take-adj-in', 'production-add', 'sales-return'].includes(t.type))
                .reduce((sum, t) => sum + parseFloat(t.quantity || 0), 0);

            // Consumed list remains same
            const consumed = transactionsOnTargetDate
                .filter(t => ['consume', 'stock-take-adj-out', 'production-consume', 'dispatch'].includes(t.type))
                .reduce((sum, t) => sum + parseFloat(t.quantity || 0), 0);

            if (targetDate < itemOpeningDate) {
                return { openingStock: 0, received, consumed, closingStock: received - consumed };
            }

            let openingStock = parseFloat(item.openingStock || 0);
            const transactionsBeforeTarget = appState.transactions.filter(tx => {
                const txDate = getStartOfDay(tx.date);
                return tx.category === category && tx.itemId == item.id && txDate >= itemOpeningDate && txDate < targetDate;
            });

            transactionsBeforeTarget.forEach(tx => {
                const qty = parseFloat(tx.quantity || 0);
                // ADDED 'sales-return' here too
                if (['receive', 'stock-take-adj-in', 'production-add', 'sales-return'].includes(tx.type)) {
                    openingStock += qty;
                } else if (['consume', 'stock-take-adj-out', 'production-consume', 'dispatch'].includes(tx.type)) {
                    openingStock -= qty;
                }
            });

            const closingStock = openingStock + received - consumed;
            return { openingStock, received, consumed, closingStock };
        };

        // Override Item Ledger Generation to include 'sales-return'
        window.generateItemLedger = function (item, category, reportEndDateStr) {
            // Force refresh cache (simple way to ensure new logic applies)
            // const cacheKey = ... we skip cache for correctness now

            const ledger = new Map();
            if (!item || !item.openingStockDate) return ledger;

            const startDate = getStartOfDay(item.openingStockDate);
            const endDate = getStartOfDay(reportEndDateStr);

            let currentStock = parseFloat(item.openingStock || 0);

            // Pre-fetch all relevant transactions sorted by date
            const relevantTxs = appState.transactions
                .filter(t => t.category === category && t.itemId == item.id && getStartOfDay(t.date) >= startDate && getStartOfDay(t.date) <= endDate)
                .sort((a, b) => new Date(a.date) - new Date(b.date));

            // Iterate day by day (safest for ledger)
            for (let d = new Date(startDate); d <= endDate; d.setUTCDate(d.getUTCDate() + 1)) {
                const dateStr = d.toISOString().split('T')[0];

                const dayTxs = relevantTxs.filter(t => getStartOfDay(t.date).getTime() === d.getTime());

                // ADDED 'sales-return'
                const received = dayTxs
                    .filter(t => ['receive', 'stock-take-adj-in', 'production-add', 'sales-return'].includes(t.type))
                    .reduce((sum, t) => sum + parseFloat(t.quantity || 0), 0);

                const consumed = dayTxs
                    .filter(t => ['consume', 'stock-take-adj-out', 'production-consume', 'dispatch'].includes(t.type))
                    .reduce((sum, t) => sum + parseFloat(t.quantity || 0), 0);

                const opening = currentStock;
                const closing = opening + received - consumed;

                ledger.set(dateStr, {
                    opening: opening,
                    received: received,
                    consumed: consumed,
                    closing: closing,
                    transactions: dayTxs
                });

                currentStock = closing;
            }

            return ledger;
        };

        // ----------------------------------------------------------------
        // 3. EXPORTS & RETURNS HISTORY
        // ----------------------------------------------------------------

        window.exportReturnsHistoryCSV = function () {
            if (!window.XLSX) { alert("Excel Library loading... try again in 5 seconds."); return; }

            const returns = appState.transactions.filter(t => t.type === 'sales-return').sort((a, b) => new Date(b.date) - new Date(a.date));

            if (returns.length === 0) { alert("No returns data found to export."); return; }

            const data = returns.map(r => {
                const item = (appState.inventory.finishedGoods || []).find(i => i.id == r.itemId);
                return {
                    'Date': r.date.split('T')[0],
                    'Customer': r.customerName || 'Unknown',
                    'Item Name': item ? item.name : 'Unknown',
                    'Quantity': r.quantity,
                    'Reason': r.returnReason || r.subtype || 'Return',
                    'Batch No': r.batchNo || '-',
                    'Notes': r.notes || ''
                };
            });

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Returns History");
            XLSX.writeFile(wb, `Returns_History_${new Date().toISOString().split('T')[0]}.xlsx`);
        };

        // Inject Export Button into Modal
        function injectExportButtons() {
            const toolsModal = document.getElementById('toolsModal');
            if (!toolsModal) return;

            // Find Exports Section (First Grid)
            const exportGrid = toolsModal.querySelectorAll('.grid')[0];
            if (exportGrid && !document.getElementById('btn-export-returns')) {
                const btn = document.createElement('button');
                btn.id = 'btn-export-returns';
                btn.onclick = window.exportReturnsHistoryCSV;
                btn.className = "flex items-center gap-2 px-3 py-2 bg-red-50 text-red-700 rounded-lg hover:bg-red-100 font-semibold text-sm transition-colors border border-red-100";
                btn.innerHTML = `<span>↩️</span> Returns Log`;
                exportGrid.appendChild(btn);
            }
        }

        // ----------------------------------------------------------------
        // 4. TRACEABILITY PDF FIX (RE-APPLYING)
        // ----------------------------------------------------------------
        window.generateTraceabilityPDF = function (itemId) {
            const traceView = document.getElementById('product-trace-view');
            if (!traceView || traceView.offsetHeight === 0) {
                alert("Please open the Trace view first.");
                return;
            }

            // Clone content
            const content = traceView.cloneNode(true);
            const btn = content.querySelector('#btn-trace-pdf');
            if (btn) btn.remove();

            // Create print iframe/div
            const printDiv = document.createElement('div');
            printDiv.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999; padding:40px; overflow:auto;';
            printDiv.id = 'print-overlay';

            printDiv.innerHTML = `
        <div style="text-align:center; border-bottom:2px solid #333; margin-bottom:20px; padding-bottom:10px;">
            <h1 style="font-size:24px; font-weight:bold;">Traceability Report</h1>
            <p>Generated: ${new Date().toLocaleString()}</p>
        </div>
        <div style="font-family:sans-serif;">${content.innerHTML}</div>
        <div style="text-align:center; margin-top:50px; font-size:12px; color:#666;">Miklens Inventory System</div>
    `;

            document.body.appendChild(printDiv);

            // Add print styles
            const style = document.createElement('style');
            style.id = 'print-style';
            style.textContent = `@media print { body * { visibility: hidden; } #print-overlay, #print-overlay * { visibility: visible; } #print-overlay { position: absolute; left: 0; top: 0; } }`;
            document.head.appendChild(style);

            window.print();

            // Cleanup
            setTimeout(() => {
                document.body.removeChild(printDiv);
                document.head.removeChild(style);
            }, 1000);
        };


        // ----------------------------------------------------------------
        // 5. AUTO-RUN & CLEANUP
        // ----------------------------------------------------------------

        setTimeout(() => {
            // 1. Re-init Return Modal safely
            if (window.appState && window.appState.inventory) {
                window.addReturnModal();
            }

            // 2. Inject Buttons
            injectExportButtons();

            // 3. Fix Reports View Logic in background
            console.log("ANTIGRAVITY: Reports Logic Updated for Returns.");

        }, 1500); // Wait for app load

        console.log("ANTIGRAVITY: Feature Pack V5 Loaded.");
    </script>

    <script>
        // ================================================================
        // FEATURE PACK V6: VISUAL FIXES & STABILITY
        // Antigravity AI - V6.0
        // ================================================================

        console.log("ANTIGRAVITY: Loading Feature Pack V6...");

        // ----------------------------------------------------------------
        // 1. ROBUST ITEM FINDER (Fixes Missing Names)
        // ----------------------------------------------------------------
        // Helper to find an item across all categories if category is unknown or failed
        function findItemRobust(itemId) {
            if (!appState || !appState.inventory) return null;
            const allItems = [
                ...(appState.inventory.finishedGoods || []),
                ...(appState.inventory.rawMaterials || []),
                ...(appState.inventory.packingMaterials || []),
                ...(appState.inventory.labels || [])
            ];
            // Try exact match then loose match
            return allItems.find(i => i.id === itemId) || allItems.find(i => i.id == itemId);
        }

        // ----------------------------------------------------------------
        // 2. RETURNS HISTORY MODAL (Redefined with Export Button & Name Fix)
        // ----------------------------------------------------------------
        window.viewReturnsHistory = function () {
            const returns = (appState.transactions || []).filter(t => t.type === 'sales-return');

            // Sort by date desc
            returns.sort((a, b) => new Date(b.date) - new Date(a.date));

            let html = `
        <div class="fixed inset-0 bg-black bg-opacity-65 flex justify-center items-center z-[70] backdrop-blur-sm" id="returnsHistoryModal">
            <div class="bg-white p-6 rounded-lg w-full max-w-5xl max-h-[85vh] flex flex-col shadow-2xl animated fadeIn">
                <div class="flex justify-between items-center mb-6 border-b pb-4">
                    <div class="flex items-center gap-3">
                        <div class="p-2 bg-red-100 rounded-full text-red-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        </div>
                        <div>
                            <h3 class="text-2xl font-bold text-gray-800">Returns Log</h3>
                            <p class="text-sm text-gray-500">History of all processed sales returns</p>
                        </div>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="window.exportReturnsHistoryCSV()" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 font-bold flex items-center gap-2 shadow-sm transition-transform hover:scale-105">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                            Export Excel
                        </button>
                        <button onclick="document.getElementById('returnsHistoryModal').remove()" class="text-gray-400 hover:text-gray-700 transition-colors">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>
                </div>
                
                <div class="overflow-y-auto flex-1 pr-2">
                    <table class="w-full text-sm text-left border-collapse">
                        <thead class="bg-gray-50 text-gray-700 uppercase sticky top-0 z-10">
                            <tr>
                                <th class="p-3 border-b font-bold">Date</th>
                                <th class="p-3 border-b font-bold">Customer</th>
                                <th class="p-3 border-b font-bold">Item</th>
                                <th class="p-3 border-b font-bold text-right">Qty</th>
                                <th class="p-3 border-b font-bold">Reason</th>
                                <th class="p-3 border-b font-bold">Notes</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            ${returns.length === 0 ? '<tr><td colspan="6" class="p-8 text-center text-gray-400 italic">No returns recorded yet.</td></tr>' :
                    returns.map(t => {
                        // ROBUST NAME LOOKUP
                        let item = findItemRobust(t.itemId);
                        let itemName = item ? item.name : `<span class="text-red-400 font-mono text-xs" title="Item ID not found">ID: ${t.itemId}</span>`;

                        let dateStr = t.date ? t.date.split('T')[0] : 'N/A';

                        return `
                                    <tr class="hover:bg-blue-50 transition-colors">
                                        <td class="p-3 text-gray-600 font-mono">${dateStr}</td>
                                        <td class="p-3 font-medium text-gray-800">${t.customerName || '-'}</td>
                                        <td class="p-3 font-bold text-gray-800">${itemName}</td>
                                        <td class="p-3 text-red-600 font-bold text-right bg-red-50 rounded">+${t.quantity}</td>
                                        <td class="p-3"><span class="px-2 py-1 bg-gray-200 rounded text-xs text-gray-700 uppercase tracking-wide border border-gray-300">${t.returnReason || t.subtype || 'Return'}</span></td>
                                        <td class="p-3 text-gray-500 text-xs max-w-xs truncate" title="${t.notes || ''}">${t.notes || '-'}</td>
                                    </tr>
                                  `;
                    }).join('')
                }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;

            // Remove existing if any
            const existing = document.getElementById('returnsHistoryModal');
            if (existing) existing.remove();

            document.body.insertAdjacentHTML('beforeend', html);
        };

        // ----------------------------------------------------------------
        // 3. GLOBAL SEARCH BUG FIX (Prevents White Screen)
        // ----------------------------------------------------------------
        window.navigateToResult = function (view, idStr) {
            console.log(`Debug Search Nav: View=${view}, ID=${idStr}`);

            try {
                // Hide Search UI
                const searchUI = document.getElementById('global-search-results');
                if (searchUI) searchUI.classList.add('hidden');
                document.getElementById('global-search-input').value = '';

                if (view === 'batch-trace') {
                    if (window.openProductTrace && typeof window.openProductTrace === 'function') {
                        if (!idStr) throw new Error("Item ID is missing");

                        // IMPORTANT: Ensure ID is passed correctly (Trace expects ItemID, not BatchID sometimes depending on implementation)
                        // Assuming openProductTrace takes Item ID.
                        window.openProductTrace(idStr);
                    } else {
                        alert("Traceability feature is not ready. Please reload.");
                    }
                } else if (view === 'customer-history') {
                    if (window.viewCustomerHistory) window.viewCustomerHistory(idStr);
                } else if (view === 'supplier-history') {
                    // If function doesn't exist, ignore
                    if (window.viewSupplierHistory) window.viewSupplierHistory(idStr);
                } else {
                    // Default View Navigation
                    if (window.showView) {
                        window.showView(view);
                        // Try to highlight item if possible
                        // Not implementing scroll-to-item to avoid crashes
                    }
                }
            } catch (err) {
                console.error("Critical Search Navigation Error:", err);
                alert("Could not open selection. Please try manually navigating to the view.");
                // Do NOT crash the page
            }
        };

        // ----------------------------------------------------------------
        // 4. TRACEABILITY PDF FIX (Full Visibility)
        // ----------------------------------------------------------------
        window.generateTraceabilityPDF = function (itemId) {
            const traceView = document.getElementById('product-trace-view');
            if (!traceView || traceView.offsetHeight === 0) {
                alert("Please open the Trace view first.");
                return;
            }

            // 1. Prepare Print Content
            const content = traceView.cloneNode(true);
            // Remove buttons/interactive elements
            const ignoreSelectors = ['button', '.no-print', 'input', 'select'];
            ignoreSelectors.forEach(sel => content.querySelectorAll(sel).forEach(el => el.remove()));

            // 2. Create Overlay
            const printDiv = document.createElement('div');
            printDiv.id = 'print-overlay';
            // Use absolute positioning relative to a clean body to ensure full scroll capture
            printDiv.style.cssText = `
        position: absolute; 
        top: 0; 
        left: 0; 
        width: 100%; 
        min-height: 100vh; 
        background: white; 
        z-index: 10000; 
        padding: 40px;
    `;

            printDiv.innerHTML = `
        <div style="text-align:center; margin-bottom: 30px; border-bottom: 2px solid #000; padding-bottom: 20px;">
            <h1 style="font-size: 28px; margin: 0; color: #000;">Traceability Report</h1>
            <div style="font-size: 14px; color: #555; margin-top: 5px;">Generated on ${new Date().toLocaleString()}</div>
        </div>
        <div class="print-body" style="font-family: 'Arial', sans-serif; line-height: 1.5; color: #000;">
            ${content.innerHTML}
        </div>
        <div style="margin-top: 50px; text-align: center; font-size: 10px; color: #999; border-top: 1px solid #eee; padding-top: 10px;">
            Miklens Bio Inventory Management System
        </div>
    `;

            document.body.appendChild(printDiv);

            // 3. Add Print Styles (Use media print to hide everything ELSE)
            const style = document.createElement('style');
            style.id = 'print-style-sheet';
            style.innerHTML = `
        @media print {
            body > *:not(#print-overlay) { display: none !important; }
            #print-overlay { display: block !important; position: static !important; }
            body { overflow: visible !important; height: auto !important; background: white !important; }
            /* Ensure tables don't cut off */
            table { page-break-inside: auto; }
            tr { page-break-inside: avoid; page-break-after: auto; }
        }
    `;
            document.head.appendChild(style);

            // 4. Print
            window.print();

            // 5. Cleanup (Delayed to allow print dialog to process)
            setTimeout(() => {
                document.head.removeChild(style);
                document.body.removeChild(printDiv);
            }, 2000);
        };

        // ----------------------------------------------------------------
        // 5. APPLY FIXES
        // ----------------------------------------------------------------

        // Re-inject Export button to Main Tools Modal as well
        setTimeout(() => {
            if (document.getElementById('toolsModal')) {
                // Refresh handlers
            }
        }, 1000);

        console.log("ANTIGRAVITY: Feature Pack V6 Loaded (Search Fix, Returns Export, Traceability Print).");
    </script>

    <script>
        // ================================================================
        // FEATURE PACK V7: FINAL ROBUSTNESS FIXES
        // Antigravity AI - V7.0
        // ================================================================

        console.log("ANTIGRAVITY: Loading Feature Pack V7...");

        // ----------------------------------------------------------------
        // 1. EXPORT FIX (Uses Robust Finder)
        // ----------------------------------------------------------------
        window.exportReturnsHistoryCSV = function () {
            if (!window.XLSX) { alert("Excel Library is still loading... please wait 3 seconds and try again."); return; }

            // Safety check for transactions
            if (!appState || !appState.transactions) { alert("No transaction data available."); return; }

            const returns = appState.transactions.filter(t => t.type === 'sales-return').sort((a, b) => new Date(b.date) - new Date(a.date));

            if (returns.length === 0) { alert("No returns data found to export."); return; }

            const data = returns.map(r => {
                // USE ROBUST FINDER HERE
                const item = findItemRobust(r.itemId);

                // Handle Customer Name Fallback
                let customerName = r.customerName;
                if ((!customerName || customerName === 'Unknown') && r.customerId) {
                    const cust = (appState.customers || []).find(c => c.id == r.customerId);
                    if (cust) customerName = cust.name;
                }

                return {
                    'Date': r.date ? r.date.split('T')[0] : 'N/A',
                    'Customer': customerName || 'Unknown Customer',
                    'Item Name': item ? item.name : `Unknown (ID: ${r.itemId})`,
                    'Category': item ? (appState.inventory.finishedGoods.includes(item) ? 'Finished Good' : 'Material') : '-',
                    'Quantity': r.quantity,
                    'Reason': r.returnReason || r.subtype || 'Return',
                    'Batch No': r.batchNo || '-',
                    'Notes': r.notes || ''
                };
            });

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Returns History");
            XLSX.writeFile(wb, `Returns_History_Corrected_${new Date().toISOString().split('T')[0]}.xlsx`);
        };


        // ----------------------------------------------------------------
        // 2. SEARCH NAVIGATION FIX (Prevents White Screen)
        // ----------------------------------------------------------------
        // Re-overriding with even more safety checks
        window.navigateToResult = function (view, idStr) {
            console.log(`Debug Search Nav: View=${view}, ID=${idStr}`);

            // Hide Search UI immediately
            const searchUI = document.getElementById('global-search-results');
            if (searchUI) searchUI.classList.add('hidden');
            const searchInput = document.getElementById('global-search-input');
            if (searchInput) searchInput.value = '';

            try {
                if (!view) return;

                if (view === 'batch-trace') {
                    // Check if trace function exists
                    if (window.openProductTrace && typeof window.openProductTrace === 'function') {
                        // Validate ID
                        if (!idStr || idStr === 'undefined' || idStr === 'null') {
                            console.error("Trace navigation failed: Invalid ID");
                            return;
                        }
                        window.openProductTrace(idStr);
                    } else {
                        console.warn("Traceability function missing. Reload app.");
                    }
                }
                else if (view === 'customer-history') {
                    if (window.viewCustomerHistory) window.viewCustomerHistory(idStr);
                }
                else if (view === 'supplier-history') {
                    if (window.viewSupplierHistory) window.viewSupplierHistory(idStr);
                }
                else {
                    // Standard Views (Dashboard, Inventory Tabs)
                    if (window.showView) {
                        // Safety: Ensure view actually exists before switching
                        // For now, we trust showView handles headers, but we wrap it.
                        window.showView(view);
                    }
                }
            } catch (err) {
                console.error("Critical Search Navigation Error:", err);
                // Supress alert to avoid annoying user if it's minor, just log it.
                // Recovery: Go to dashboard if everything explodes
                if (window.showView) window.showView('dashboard');
            }
        };

        // ----------------------------------------------------------------
        // 3. UI REFRESH
        // ----------------------------------------------------------------
        // Ensure the Export button in the Modal also uses the NEW function
        setTimeout(() => {
            // If modal is open, we can try to refresh its button, but easier to just close/reopen or rely on next open
            // We'll trust the function override works for next click.
        }, 500);

        console.log("ANTIGRAVITY: Feature Pack V7 (Export Fixes) Loaded.");
    </script>

    <script>
        // ================================================================
        // FEATURE PACK V8: DIAGNOSTIC & DATA RECOVERY
        // Antigravity AI - V8.0
        // ================================================================

        console.log("ANTIGRAVITY: Loading Feature Pack V8...");

        // ----------------------------------------------------------------
        // 1. DATA RECOVERY: Super Robust Item Finder
        // ----------------------------------------------------------------
        window.findItemSuperRobust = function (searchId) {
            if (!searchId) return null;
            const idStr = String(searchId).trim();

            // Debug Access
            if (!appState || !appState.inventory) {
                console.warn("Inventory state missing during search for:", idStr);
                return null;
            }

            // 1. Scan All Inventory Lists
            const categories = ['finishedGoods', 'rawMaterials', 'packingMaterials', 'labels'];
            for (const cat of categories) {
                const list = appState.inventory[cat];
                if (Array.isArray(list)) {
                    // Try Exact String Match
                    let found = list.find(i => String(i.id).trim() === idStr);
                    if (found) return found;

                    // Try Loose Match
                    found = list.find(i => i.id == searchId);
                    if (found) return found;
                }
            }

            // 2. Scan Transactions for clues (Snapshot recovery)
            // Sometimes the item might be deleted but transactions exist.
            // We try to find a transaction that might have the name saved.
            const productTx = appState.transactions.find(t => t.itemId == searchId && t.itemName);
            if (productTx) {
                return { id: searchId, name: productTx.itemName + ' (Archived)' };
            }

            return null;
        };

        // ----------------------------------------------------------------
        // 2. EXPORT: Fixed Logic with Diagnostics
        // ----------------------------------------------------------------
        window.exportReturnsHistoryCSV = function () {
            console.log("Starting Returns Export...");

            if (!window.XLSX) { alert("Excel Engine Loading... Wait 5s."); return; }

            const returns = (appState.transactions || []).filter(t => t.type === 'sales-return');
            returns.sort((a, b) => new Date(b.date) - new Date(a.date));

            if (returns.length === 0) { alert("No returns found to export."); return; }

            console.log(`Found ${returns.length} return records. Processing...`);

            const data = returns.map(r => {
                // USE SUPER ROBUST FINDER
                const item = window.findItemSuperRobust(r.itemId);

                // Debug Log for "Unknown" failure
                if (!item) console.warn(`Item Lookup Failed for ID: ${r.itemId}`);

                // Customer Logic
                let custName = r.customerName;
                if (!custName || custName === 'Unknown') {
                    const c = (appState.customers || []).find(x => x.id == r.customerId);
                    if (c) custName = c.name;
                }

                return {
                    'Date': r.date ? r.date.split('T')[0] : '-',
                    'Customer': custName || 'Walk-in / Unknown',
                    'Item Name': item ? item.name : `Unknown (ID: ${r.itemId})`,
                    'Details': r.notes || r.returnReason || '-',
                    'Qty': r.quantity,
                    'Batch': r.batchNo || '-'
                };
            });

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Returns");
            XLSX.writeFile(wb, `Returns_Log_FINAL_${new Date().getTime()}.xlsx`);

            console.log("Export Complete.");
        };

        // ----------------------------------------------------------------
        // 3. SEARCH: Anti-Crash Navigation
        // ----------------------------------------------------------------
        window.navigateToResult = function (view, idStr) {
            // Prevent default form actions by clearing current execution stack
            setTimeout(() => {
                console.log(`Navigating safe to: ${view} ID: ${idStr}`);

                try {
                    // Hide Search Bar First
                    const searchUI = document.getElementById('global-search-results');
                    if (searchUI) searchUI.classList.add('hidden');

                    // Handle specific views
                    if (view === 'batch-trace') {
                        if (window.openProductTrace) window.openProductTrace(idStr);
                    }
                    else if (view === 'customer-history' || view === 'supplier-history') {
                        // Try dynamic call
                        const fnName = view === 'customer-history' ? 'viewCustomerHistory' : 'viewSupplierHistory';
                        if (window[fnName]) window[fnName](idStr);
                    }
                    else {
                        // Main Views (Tabs)
                        if (window.showView) {
                            try {
                                window.showView(view);
                            } catch (e) {
                                console.error("View Render Crash:", e);
                                alert("Could not load view: " + view + ". \nPossible data error.");
                            }
                        }
                    }
                } catch (err) {
                    console.error("Navigation Safety Catch:", err);
                }
            }, 10);
        };

        // ----------------------------------------------------------------
        // 4. UI RE-BINDING (Fixing any broken buttons)
        // ----------------------------------------------------------------
        setTimeout(() => {
            // Re-attach search input listener to properly set our robust navigator
            const searchInput = document.getElementById('global-search-input');
            // We don't need to do much if the HTML injection uses the global function name
            // because we just overwrote the global function `window.navigateToResult`.

            console.log("ANTIGRAVITY: Search & Export logic is now Robust.");
        }, 800);

        console.log("ANTIGRAVITY: Feature Pack V8 Loaded.");
    </script>

    <script>
        // ================================================================
        // FEATURE PACK V9: ADVANCED CALCULATOR & PDF
        // ================================================================
        console.log("ANTIGRAVITY: Loading Feature Pack V9 (Advanced Calculator)...");

        window.renderCalculatorView = function () {
            const container = document.getElementById('calculator-view');
            if (!container) return;

            // Initialize overrides if not present
            if (!window.calculatorOverrides) window.calculatorOverrides = {};

            container.innerHTML = `
        <div class="h-full flex flex-col p-6 overflow-y-auto bg-gray-50">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-gray-800 flex items-center gap-2">
                    <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                    Advanced Production Cost Calculator
                </h2>
                <div class="flex gap-2">
                     <button onclick="if(document.getElementById('calc-formulation-select')) document.getElementById('calc-formulation-select').focus()" class="px-4 py-2 bg-white border border-gray-300 rounded shadow-sm hover:bg-gray-50 font-medium">Load Saved Calculation...</button>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                
                <!-- LEFT PANEL: INPUTS & INGREDIENTS -->
                <div class="lg:col-span-2 space-y-6">
                    
                    <!-- Product Header -->
                    <div class="bg-white p-6 rounded-lg shadow border-t-4 border-blue-600">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-1">Product Name (for Report)</label>
                                <div class="flex gap-2">
                                    <select id="calc-formulation-select" class="flex-1 p-2 border-2 border-blue-100 rounded focus:border-blue-500 bg-blue-50 focus:bg-white font-bold text-gray-800" onchange="calculateCostEstimate()">
                                        <option value="">-- Select Product Formulation --</option>
                                        ${(appState.formulas || []).map(f => `<option value="${f.id}">${f.name}</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-1">Total Target Quantity</label>
                                <div class="flex">
                                    <input type="number" id="calc-qty" class="w-full p-2 border-2 border-blue-100 rounded-l focus:border-blue-500 font-bold text-lg" value="1000" oninput="calculateCostEstimate()">
                                    <span class="p-2 bg-gray-100 border border-l-0 rounded-r font-bold text-gray-500" id="calc-unit-display">Unit</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Ingredients Table -->
                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <div class="p-4 bg-gray-50 border-b flex justify-between items-center">
                            <h3 class="font-bold text-gray-700">Ingredients & Materials</h3>
                            <span class="text-xs text-gray-500 italic">* Edit rates using the pencil icon</span>
                        </div>
                        <table class="min-w-full text-sm" id="calc-table">
                            <thead class="bg-white text-gray-600 uppercase text-xs border-b">
                                <tr>
                                    <th class="p-3 text-left w-1/2">Item</th>
                                    <th class="p-3 text-right">Cost/Unit</th>
                                    <th class="p-3 text-right">Quantity</th>
                                    <th class="p-3 text-right">Total</th>
                                    <th class="p-3 text-center w-10"></th>
                                </tr>
                            </thead>
                            <tbody id="calc-details-body" class="divide-y divide-gray-100">
                                <tr><td colspan="5" class="p-8 text-center text-gray-400 italic">Select a product to view ingredients.</td></tr>
                            </tbody>
                        </table>
                        <div class="p-4 bg-gray-50 border-t text-center">
                             <!-- Placeholder for Add Ingredient -->
                             <button class="text-gray-400 text-sm hover:text-blue-600 font-medium dash-border p-2 rounded w-full border-2 border-dashed border-gray-200 hover:border-blue-300" onclick="alert('Manual ingredient addition is coming in v2. Please use formulations for now.')">
                                + Add Ingredient
                             </button>
                        </div>
                    </div>
                </div>

                <!-- RIGHT PANEL: SUMMARY & ACTIONS -->
                <div class="lg:col-span-1 space-y-6">
                    
                    <!-- Cost Breakdown Card -->
                    <div class="bg-gray-900 text-white p-6 rounded-lg shadow-xl" id="calc-result-area">
                        <h3 class="text-xl font-bold mb-6 border-b border-gray-700 pb-2">Cost Breakdown</h3>
                        
                        <div class="space-y-4 mb-6">
                            <div class="flex justify-between items-baseline">
                                <span class="text-gray-400">Raw Material Cost</span>
                                <span class="text-xl font-mono" id="calc-material-cost">₹0.00</span>
                            </div>
                            <div class="flex justify-between items-baseline">
                                <span class="text-gray-400">Total Production Cost</span>
                                <span class="text-xl font-mono text-yellow-400 font-bold" id="calc-total-cost">₹0.00</span>
                            </div>
                            <div class="flex justify-between items-baseline">
                                <span class="text-gray-400">Cost Per Unit</span>
                                <span class="text-xl font-mono text-blue-300" id="calc-unit-cost">₹0.00</span>
                            </div>
                        </div>

                        <!-- Pricing Section -->
                        <div class="bg-gray-800 p-4 rounded-lg mb-6 border border-gray-700">
                            <div class="flex justify-between items-center mb-2">
                                <label class="text-xs font-bold text-gray-400 uppercase">Margin %</label>
                                <input type="number" id="calc-margin" class="w-16 p-1 bg-gray-700 border border-gray-600 rounded text-right text-white font-bold" value="20" oninput="calculateCostEstimate()">
                            </div>
                            <div class="flex justify-between items-baseline mb-1">
                                <span class="text-green-400 text-sm">Margin Amount</span>
                                <span class="font-mono text-green-400" id="calc-margin-amt">₹0.00</span>
                            </div>
                            <div class="mt-3 pt-3 border-t border-gray-600">
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Recommended Selling Price</label>
                                <div class="text-3xl font-bold text-white" id="calc-sell-price">₹0.00</div>
                            </div>
                        </div>

                        <!-- Actions -->
                        <div class="space-y-3">
                            <button onclick="if(window.showToast) showToast('Configuration Saved locally!'); else alert('Configuration Saved locally.')" class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white rounded font-bold transition shadow-lg">Save</button>
                            <button onclick="generateCostSheetPDF()" class="w-full py-3 bg-gray-700 hover:bg-gray-600 text-white rounded font-bold transition flex justify-center items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                                Simple PDF
                            </button>
                            <button onclick="downloadCostCalculation()" class="w-full py-3 bg-green-600 hover:bg-green-700 text-white rounded font-bold transition flex justify-center items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                Detailed Excel
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
        };

        window.calculateCostEstimate = function () {
            const formId = document.getElementById('calc-formulation-select').value;
            const qty = parseFloat(document.getElementById('calc-qty').value) || 0;
            const margin = parseFloat(document.getElementById('calc-margin').value) || 0;

            // UI Helpers
            const setTxt = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };

            // Ensure overrides
            if (!window.calculatorOverrides) window.calculatorOverrides = {};
            if (!window.calculatorOverrides[formId]) window.calculatorOverrides[formId] = {};

            // Ensure quantity overrides
            if (!window.calculatorQtys) window.calculatorQtys = {};
            if (!window.calculatorQtys[formId]) window.calculatorQtys[formId] = {};

            if (!formId || qty <= 0) return;

            const formula = appState.formulas.find(f => f.id == formId);
            if (!formula) return;

            setTxt('calc-unit-display', formula.outputUnit);

            const baseQty = formula.baseQuantity || formula.outputQty || 1;
            const finalScale = qty / baseQty;

            let totalMaterialCost = 0;
            let rows = '';

            const findItemFn = window.findItem || ((cat, id) => appState.inventory[cat].find(i => i.id == id));

            // Helper to process list
            const processList = (list, catName) => {
                if (!list) return;
                list.forEach(itemEntry => {
                    const item = findItemFn(catName, itemEntry.itemId);
                    if (item) {

                        // Quantity Logic (Standard or Overridden)
                        let req = itemEntry.quantity * finalScale;
                        let isQtyOverridden = false;

                        if (window.calculatorQtys[formId][itemEntry.itemId] !== undefined) {
                            req = window.calculatorQtys[formId][itemEntry.itemId];
                            isQtyOverridden = true;
                        }

                        // Rate Logic
                        let rate = parseFloat(item.currentAverageCost) || parseFloat(item.price) || 0;
                        let isRateOverridden = false;
                        if (window.calculatorOverrides[formId][itemEntry.itemId] !== undefined) {
                            rate = window.calculatorOverrides[formId][itemEntry.itemId];
                            isRateOverridden = true;
                        }

                        const cost = req * rate;
                        totalMaterialCost += cost;

                        rows += `
                <tr class="hover:bg-blue-50 transition-colors group">
                    <td class="p-3">
                        <div class="font-bold text-gray-700">${item.name}</div>
                        <div class="text-xs text-gray-400">ID: ${item.id}</div>
                    </td>
                    <td class="p-3 text-right">
                        <div class="flex items-center justify-end gap-2">
                             <div class="${isRateOverridden ? 'bg-yellow-100 text-yellow-800 px-2 rounded font-bold' : 'text-gray-600'}">₹${rate.toFixed(2)}</div>
                             <button onclick="editCalcCost('${formId}', '${itemEntry.itemId}', ${rate})" class="p-1 rounded hover:bg-blue-100 text-blue-500 transition shadow-sm border border-gray-200 bg-white" title="Edit Rate">
                                 <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                              </button>
                        </div>
                    </td>
                    <td class="p-3 text-right font-mono">
                        <div class="flex items-center justify-end gap-2">
                             <div class="${isQtyOverridden ? 'bg-purple-100 text-purple-800 px-2 rounded font-bold' : ''}">${req.toFixed(3)}</div>
                             <button onclick="editCalcQty('${formId}', '${itemEntry.itemId}', ${req})" class="p-1 rounded hover:bg-purple-100 text-purple-500 transition shadow-sm border border-gray-200 bg-white" title="Edit Quantity">
                                 <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                              </button>
                        </div>
                    </td>
                    <td class="p-3 text-right font-bold text-gray-800">₹${cost.toFixed(2)}</td>
                    <td class="p-3 text-center">
                        ${isRateOverridden || isQtyOverridden ?
                                `<button onclick="resetCalcItem('${formId}', '${itemEntry.itemId}')" class="text-xs text-red-500 hover:text-red-700 underline">Reset</button>`
                                : ''}
                    </td>
                </tr>`;
                    }
                });
            };

            if (formula.ingredients) processList(formula.ingredients, 'rawMaterials');
            ['packingMaterials', 'labels'].forEach(cat => formula[cat] && processList(formula[cat], cat));

            document.getElementById('calc-details-body').innerHTML = rows;

            // Summary Calculations
            const unitCost = qty > 0 ? (totalMaterialCost / qty) : 0;
            const marginAmt = (totalMaterialCost * margin) / 100;
            const sellPrice = totalMaterialCost + marginAmt;
            const unitSellPrice = qty > 0 ? (sellPrice / qty) : 0;

            setTxt('calc-material-cost', '₹' + totalMaterialCost.toFixed(2));
            setTxt('calc-total-cost', '₹' + totalMaterialCost.toFixed(2));
            setTxt('calc-unit-cost', '₹' + unitCost.toFixed(2));

            setTxt('calc-margin-amt', '₹' + marginAmt.toFixed(2));
            setTxt('calc-sell-price', '₹' + sellPrice.toFixed(2) + ` (${unitSellPrice.toFixed(2)}/${formula.outputUnit})`);
        };

        window.editCalcQty = function (formId, itemId, currentQty) {
            const newQty = prompt("Enter manual Quantity Required:", currentQty);
            if (newQty !== null) {
                const parsed = parseFloat(newQty);
                if (!isNaN(parsed) && parsed >= 0) {
                    if (!window.calculatorQtys) window.calculatorQtys = {};
                    if (!window.calculatorQtys[formId]) window.calculatorQtys[formId] = {};
                    window.calculatorQtys[formId][itemId] = parsed;
                    calculateCostEstimate();
                } else {
                    alert("Invalid quantity!");
                }
            }
        };

        window.resetCalcItem = function (formId, itemId) {
            if (window.calculatorOverrides && window.calculatorOverrides[formId]) {
                delete window.calculatorOverrides[formId][itemId];
            }
            if (window.calculatorQtys && window.calculatorQtys[formId]) {
                delete window.calculatorQtys[formId][itemId];
            }
            calculateCostEstimate();
        };

        window.editCalcCost = function (formId, itemId, currentRate) {
            const newRate = prompt("Enter manual Cost Per Unit:", currentRate);
            if (newRate !== null) {
                const parsed = parseFloat(newRate);
                if (!isNaN(parsed) && parsed >= 0) {
                    if (!window.calculatorOverrides) window.calculatorOverrides = {};
                    if (!window.calculatorOverrides[formId]) window.calculatorOverrides[formId] = {};
                    window.calculatorOverrides[formId][itemId] = parsed;
                    calculateCostEstimate();
                } else {
                    alert("Invalid price!");
                }
            }
        };

        window.downloadCostCalculation = function () {
            if (typeof XLSX === 'undefined') {
                alert("Error: Excel library (XLSX) not found.\n\nPlease check your internet connection and refresh the page to load the required libraries.");
                return;
            }

            const formId = document.getElementById('calc-formulation-select').value;
            const qty = parseFloat(document.getElementById('calc-qty').value) || 0;
            const formula = appState.formulas.find(f => f.id == formId);
            if (!formula) { alert("Please select a product formulation first."); return; }

            const rows = document.querySelectorAll('#calc-details-body tr');
            const data = [];

            rows.forEach(r => {
                const cells = r.querySelectorAll('td');
                if (cells.length > 3) {
                    // Parse name strictly
                    let name = cells[0].innerText.split('\n')[0].trim();
                    let rate = cells[1].innerText.trim();
                    // Remove 'Edit' text if scraped

                    data.push({
                        'Item Name': name,
                        'Cost/Unit': parseFloat(rate.replace(/[^0-9.]/g, '')), // Clean currency
                        'Quantity': parseFloat(cells[2].innerText.split('\n')[0].replace(/[^0-9.]/g, '')),
                        'Total Cost': parseFloat(cells[3].innerText.replace(/[^0-9.]/g, ''))
                    });
                }
            });

            // Add Summary
            data.push({});
            const totalCostEl = document.getElementById('summ-total') || document.getElementById('calc-total-cost');
            const sellPriceEl = document.getElementById('summ-sell-price') || document.getElementById('calc-sell-price');

            data.push({
                'Item Name': 'TOTAL PRODUCTION COST',
                'Total Cost': totalCostEl ? totalCostEl.innerText : '0.00'
            });
            data.push({
                'Item Name': 'RECOMMENDED PRICE',
                'Total Cost': sellPriceEl ? sellPriceEl.innerText : '0.00'
            });

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, "Cost Sheet");
            XLSX.writeFile(wb, `${formula.name}_CostSheet.xlsx`);
        };

        window.generateCostSheetPDF = function () {
            const formId = document.getElementById('calc-formulation-select').value;
            if (!formId) return;
            const formula = appState.formulas.find(f => f.id == formId);

            // Create Clean Print Overlay
            const overlay = document.createElement('div');
            overlay.id = 'cost-print-overlay';
            // Use fixed position full screen force white
            overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:white;z-index:9999;padding:40px;overflow-y:auto; color:black; font-family: sans-serif;';

            const date = new Date().toLocaleDateString();

            overlay.innerHTML = `
        <div style="max-width: 800px; margin: 0 auto; border: 1px solid #ccc; padding: 40px;">
            <div style="text-align:center; border-bottom: 2px solid #000; padding-bottom: 20px; margin-bottom: 30px;">
                <h1 style="margin:0; font-size: 24px;">Production Cost Sheet</h1>
                <p style="margin:5px 0 0; color:#666;">Date: ${date}</p>
                <h2 style="margin:10px 0 0; color:#333;">${formula.name}</h2>
            </div>
            
            <div style="margin-bottom: 30px;">
                <table style="width:100%; border-collapse: collapse;">
                    <thead style="background:#f3f4f6; border-bottom: 2px solid #000;">
                        <tr>
                            <th style="padding:10px; text-align:left;">Item</th>
                            <th style="padding:10px; text-align:right;">Cost/Unit</th>
                            <th style="padding:10px; text-align:right;">Qty</th>
                            <th style="padding:10px; text-align:right;">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${document.getElementById('calc-details-body').innerHTML}
                    </tbody>
                </table>
            </div>
            
            <div style="display:flex; justify-content:flex-end;">
                <div style="width: 300px;">
                    <div style="display:flex; justify-content:space-between; padding: 5px 0; border-bottom: 1px solid #eee;">
                        <span>Total Material Cost:</span>
                        <b>${document.getElementById('calc-material-cost').textContent}</b>
                    </div>
                    <div style="display:flex; justify-content:space-between; padding: 10px 0; font-size: 18px; font-weight:bold; border-bottom: 2px solid #000;">
                        <span>Total Production Cost:</span>
                        <span>${document.getElementById('calc-total-cost').textContent}</span>
                    </div>
                    <div style="display:flex; justify-content:space-between; padding: 10px 0; color:#666;">
                         <span>Recommended Selling Price:</span>
                         <b>${document.getElementById('calc-sell-price').textContent}</b>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 50px; text-align:center; font-size: 12px; color:#aaa;">
                Generated by Miklens Inventory System
            </div>
        </div>
        <style>
            @media print {
                body > *:not(#cost-print-overlay) { display: none !important; }
                #cost-print-overlay { display: block !important; }
                button { display: none !important; } 
                td button { display: none; }
                svg { display: none; }
                .text-xs { font-size: 10px; color: #666; }
            }
        </style>
    `;

            document.body.appendChild(overlay);
            window.print();
            // Auto-remove after print dialog closes (approx 2s usually, but button needed for manual close if hang)
            // We add a close button just in case
            const closeBtn = document.createElement('button');
            closeBtn.textContent = "Close Preview";
            closeBtn.style.cssText = "position:fixed; top:10px; right:10px; padding:10px; background:red; color:white; z-index:10000; border:none; cursor:pointer;";
            closeBtn.onclick = () => document.body.removeChild(overlay);
            overlay.appendChild(closeBtn);
        };

        window.loadFormulaIntoCalc = function (formulaId) {
            const select = document.getElementById('calc-formulation-select');
            if (select) {
                select.value = formulaId;
                calculateCostEstimate();
            }
            // Also support external call
            const view = document.getElementById('calculator-view');
            if (view && (view.classList.contains('hidden') || view.style.display === 'none')) {
                if (window.showView) window.showView('calculator');
            }

            // Safety delay to ensure render
            setTimeout(() => {
                calculateCostEstimate();
            }, 200);
        };

        console.log("ANTIGRAVITY: Feature Pack V9 Loaded (Advanced Calculator).");
    </script>

    <script>
        // ================================================================
        // FEATURE PACK V10: CALCULATOR REFINEMENT (User Feedback)
        // ================================================================
        console.log("ANTIGRAVITY: Loading Feature Pack V10 (Final Refinements)...");

        // Global State for Calculator (Session only, unless saved)
        window.calcSession = {
            manualIngredients: [], // {itemId, qty, rate, name}
            additionalCosts: {
                labour: 0,
                other: 0,
                packaging: 0, // Extra packaging cost
                freight: 0,
                tariff: 0,
                margin: 20
            }
        };


        // Feature Pack V10 Helper: Handle Formulation Change (Resets Overrides)
        window.editCalcQty = function (formId, itemId, currentQty) {
            const newQty = prompt("Enter manual Quantity Required:", currentQty);
            if (newQty !== null) {
                const parsed = parseFloat(newQty);
                if (!isNaN(parsed) && parsed >= 0) {
                    if (!window.calculatorQtys) window.calculatorQtys = {};
                    if (!window.calculatorQtys[formId]) window.calculatorQtys[formId] = {};
                    window.calculatorQtys[formId][itemId] = parsed;
                    calculateCostEstimateStrict();
                } else {
                    alert("Invalid quantity!");
                }
            }
        };

        window.resetCalcItem = function (formId, itemId) {
            if (window.calculatorOverrides && window.calculatorOverrides[formId]) {
                delete window.calculatorOverrides[formId][itemId];
            }
            if (window.calculatorQtys && window.calculatorQtys[formId]) {
                delete window.calculatorQtys[formId][itemId];
            }
            calculateCostEstimateStrict();
        };

        window.handleFormulationSelect = function () {
            const formId = document.getElementById('calc-formulation-select').value;

            if (formId) {
                // 1. Clear Overrides for this specific formulation to ensure "Original" state
                if (window.calculatorOverrides && window.calculatorOverrides[formId]) {
                    delete window.calculatorOverrides[formId];
                }

                // 2. Clear Session Data (Manual Ingredients & Extra Costs)
                window.calcSession = {
                    manualIngredients: [],
                    additionalCosts: { labour: 0, other: 0, packaging: 0, freight: 0, tariff: 0, margin: 20 }
                };

                // 3. Reset Inputs (Optional: visually clear inputs if they exist)
                const inputs = ['cost-labour', 'cost-packaging', 'cost-freight', 'cost-other', 'cost-tariff'];
                inputs.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.value = 0;
                });
                const marginEl = document.getElementById('cost-margin');
                if (marginEl) marginEl.value = 20;
            }

            calculateCostEstimateStrict();
        };

        window.renderCalculatorView = function () {
            const container = document.getElementById('calculator-view');
            if (!container) return;

            // Ensure overrides
            if (!window.calculatorOverrides) window.calculatorOverrides = {};

            container.innerHTML = `
        <div class="h-full flex flex-col p-4 md:p-8 overflow-y-auto bg-gray-50 font-sans">
            <!-- Header -->
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                <h2 class="text-3xl font-bold text-gray-800 flex items-center gap-3">
                    <div class="p-2 bg-blue-600 rounded-lg text-white shadow-lg">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                    </div>
                    Advanced Production Costing
                </h2>
                <div class="flex gap-2 w-full md:w-auto">
                     <button onclick="loadSavedCalculationModal()" class="flex-1 md:flex-none px-4 py-2 bg-white border border-gray-300 rounded shadow-sm hover:bg-gray-50 font-bold text-gray-700 flex items-center gap-2 justify-center">
                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                        Load Saved
                     </button>
                     <button onclick="resetCalculator()" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded text-gray-600 font-bold" title="Reset">
                        Reset
                     </button>
                </div>
            </div>

            <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
                
                <!-- LEFT PANEL: INPUTS & BOM -->
                <div class="xl:col-span-2 space-y-6">
                    
                    <!-- 1. Product Configuration -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-4">Product Configuration</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-1">Select Formulation</label>
                                <select id="calc-formulation-select" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-bold text-gray-800 bg-gray-50" onchange="handleFormulationSelect()">
                                    <option value="">-- Choose Product --</option>
                                    ${(appState.formulas || []).map(f => `<option value="${f.id}">${f.name}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-1">Target Quantity</label>
                                <div class="flex rounded-lg shadow-sm">
                                    <input type="number" id="calc-qty" class="w-full p-3 border border-gray-300 rounded-l-lg focus:ring-2 focus:ring-blue-500 font-bold text-lg" value="1000" oninput="calculateCostEstimateStrict()">
                                    <span class="px-4 py-3 bg-gray-100 border border-l-0 border-gray-300 rounded-r-lg font-bold text-gray-500" id="calc-unit-display">Unit</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 2. Ingredients (BOM) -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                        <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                            <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider">Bill of Materials</h3>
                        </div>
                        <table class="min-w-full text-sm">
                            <thead class="bg-white text-gray-500 border-b border-gray-100">
                                <tr>
                                    <th class="p-4 text-left font-medium">Item Details</th>
                                    <th class="p-4 text-right font-medium">Rate/Unit</th>
                                    <th class="p-4 text-right font-medium">Qty Required</th>
                                    <th class="p-4 text-right font-medium">Subtotal</th>
                                    <th class="p-4 w-10"></th>
                                </tr>
                            </thead>
                            <tbody id="calc-details-body" class="divide-y divide-gray-50">
                                <tr><td colspan="5" class="p-8 text-center text-gray-400 italic">Select a formulation to load BOM.</td></tr>
                            </tbody>
                        </table>
                        
                        <!-- Manual Add Button -->
                        <div class="p-4 bg-gray-50 border-t border-gray-100">
                             <button onclick="openAddManualItemModal()" class="w-full py-3 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 font-bold hover:border-blue-500 hover:text-blue-600 transition flex justify-center items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                                Add Extra Ingredient / Material
                             </button>
                        </div>
                    </div>

                    <!-- 3. Additional Costs (New) -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-4">Additional Operational Costs</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-600 mb-1 uppercase">Labour Cost</label>
                                <div class="relative">
                                    <span class="absolute left-3 top-2 text-gray-400">₹</span>
                                    <input type="number" id="cost-labour" class="w-full pl-6 p-2 border rounded font-bold text-gray-700" value="0" oninput="updateAdditionalCosts()">
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-600 mb-1 uppercase">Pkg/Bottles</label>
                                <div class="relative">
                                    <span class="absolute left-3 top-2 text-gray-400">₹</span>
                                    <input type="number" id="cost-packaging" class="w-full pl-6 p-2 border rounded font-bold text-gray-700" value="0" oninput="updateAdditionalCosts()">
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-600 mb-1 uppercase">Freight/Transport</label>
                                <div class="relative">
                                    <span class="absolute left-3 top-2 text-gray-400">₹</span>
                                    <input type="number" id="cost-freight" class="w-full pl-6 p-2 border rounded font-bold text-gray-700" value="0" oninput="updateAdditionalCosts()">
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-600 mb-1 uppercase">Other / Ops</label>
                                <div class="relative">
                                    <span class="absolute left-3 top-2 text-gray-400">₹</span>
                                    <input type="number" id="cost-other" class="w-full pl-6 p-2 border rounded font-bold text-gray-700" value="0" oninput="updateAdditionalCosts()">
                                </div>
                            </div>
                             <div>
                                <label class="block text-xs font-bold text-gray-600 mb-1 uppercase">Export Tariff</label>
                                <div class="relative">
                                    <span class="absolute left-3 top-2 text-gray-400">₹</span>
                                    <input type="number" id="cost-tariff" class="w-full pl-6 p-2 border rounded font-bold text-gray-700" value="0" oninput="updateAdditionalCosts()">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- RIGHT PANEL: FINANCIAL SUMMARY -->
                <div class="xl:col-span-1 space-y-6">
                    <div class="bg-gray-900 text-white p-6 rounded-xl shadow-2xl sticky top-6">
                        <div class="flex justify-between items-center mb-6 border-b border-gray-700 pb-4">
                            <h3 class="text-xl font-bold">Cost Analysis</h3>
                            <span class="px-2 py-1 bg-blue-600 rounded text-xs font-bold tracking-wide">CONFIDENTIAL</span>
                        </div>
                        
                        <!-- Breakdown -->
                        <div class="space-y-3 mb-8 text-sm">
                            <div class="flex justify-between text-gray-400">
                                <span>Material Cost (BOM)</span>
                                <span class="font-mono text-white" id="summ-material">₹0.00</span>
                            </div>
                            <div class="flex justify-between text-gray-400">
                                <span>Operational Overheads</span>
                                <span class="font-mono text-white" id="summ-overhead">₹0.00</span>
                            </div>
                            <div class="h-px bg-gray-700 my-2"></div>
                             <div class="flex justify-between items-center">
                                <span class="text-lg font-bold text-gray-200">Total Production Cost</span>
                                <span class="text-2xl font-mono font-bold text-yellow-400" id="summ-total">₹0.00</span>
                            </div>
                             <div class="flex justify-between items-center">
                                <span class="text-gray-400 block mt-1">Cost Per Unit</span>
                                <span class="font-mono text-blue-300 text-lg block mt-1" id="summ-unit">₹0.00</span>
                            </div>
                        </div>

                        <!-- Margin Calculator -->
                        <div class="bg-gray-800 p-5 rounded-lg mb-8 border border-gray-700">
                            <h4 class="text-xs font-bold text-gray-500 uppercase mb-3">Pricing Strategy</h4>
                            
                            <div class="flex items-center justify-between mb-4">
                                <label class="text-sm text-gray-300">Target Margin (%)</label>
                                <input type="number" id="cost-margin" class="w-20 p-1 bg-gray-900 border border-gray-600 rounded text-right text-white font-bold focus:border-green-500 focus:ring-1 focus:ring-green-500" value="20" oninput="updateAdditionalCosts()">
                            </div>

                            <div class="flex justify-between items-baseline mb-2">
                                <span class="text-green-400 text-sm">Margin Value</span>
                                <span class="font-mono text-green-400" id="summ-margin-val">₹0.00</span>
                            </div>
                            
                            <div class="pt-4 border-t border-gray-600 mt-4">
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Recommended Selling Price</label>
                                <div class="flex items-end justify-between">
                                    <div class="text-3xl font-bold text-white" id="summ-sell-price">₹0.00</div>
                                    <div class="text-sm text-gray-400 mb-1" id="summ-sell-unit">/ Unit</div>
                                </div>
                            </div>
                        </div>

                        <!-- Actions -->
                        <div class="grid grid-cols-1 gap-3">
                            <button onclick="saveCurrentCalculation()" class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold transition shadow-lg flex justify-center items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg>
                                Save Calculation
                            </button>
                            
                            <div class="grid grid-cols-2 gap-3">
                                <button onclick="generateProCostSheetPDF()" class="py-3 bg-gray-700 hover:bg-gray-600 text-white rounded-lg font-bold transition flex justify-center items-center gap-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2.414-.586a1 1 0 01.707.586c.126.33.516.5.828.373a1 1 0 00.373-.828M15 11h3m-3 4h2"></path></svg>
                                    Pro PDF
                                </button>
                                <button onclick="downloadCostCalculation()" class="py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg font-bold transition flex justify-center items-center gap-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                    Excel
                                </button>
                            </div>
                        </div>
                        
                        <div class="mt-4 text-center">
                            <p class="text-xs text-gray-500">Estimates are for planning purposes. Actuals may vary.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;

            // Restore inputs if session exists
            if (window.calcSession.additionalCosts) {
                const c = window.calcSession.additionalCosts;
                const setVal = (id, v) => { const el = document.getElementById(id); if (el) el.value = v; };
                setVal('cost-labour', c.labour);
                setVal('cost-packaging', c.packaging);
                setVal('cost-freight', c.freight);
                setVal('cost-other', c.other);
                setVal('cost-tariff', c.tariff);
                setVal('cost-margin', c.margin || 20);
            }
        };

        // ---------------------------------------------------------
        // LOGIC: CALCULATION & UPDATES
        // ---------------------------------------------------------

        window.calculateCostEstimateStrict = function () {
            const formId = document.getElementById('calc-formulation-select').value;
            const qty = parseFloat(document.getElementById('calc-qty').value) || 0;

            if (!formId || qty <= 0) {
                document.getElementById('calc-details-body').innerHTML = '<tr><td colspan="5" class="p-8 text-center text-gray-400 italic">Select a formulation to load BOM.</td></tr>';
                resetSummary();
                return;
            }

            const formula = appState.formulas.find(f => f.id == formId);
            if (!formula) return;

            document.getElementById('calc-unit-display').textContent = formula.outputUnit;

            // Scaling
            const baseQty = formula.baseQuantity || formula.outputQty || 1;
            const finalScale = qty / baseQty;

            let totalMaterialCost = 0;
            let rows = '';

            // Helper to find item
            const findItemFn = window.findItem || ((cat, id) => appState.inventory[cat].find(i => i.id == id));

            // 1. Process Formula Ingredients
            // NOTE: This logic uses window.calculatorOverrides for temporary price changes.
            // It DOES NOT modify appState.formulas or appState.inventory.
            const processList = (list, catName) => {
                if (!list) return;
                list.forEach(itemEntry => {
                    const item = findItemFn(catName, itemEntry.itemId);
                    if (item) {
                        // Quantity Logic (Standard or Overridden)
                        let req = itemEntry.quantity * finalScale;
                        let isQtyOverridden = false;

                        // Helper to ensure structure
                        if (!window.calculatorQtys) window.calculatorQtys = {};
                        if (!window.calculatorQtys[formId]) window.calculatorQtys[formId] = {};

                        if (window.calculatorQtys[formId][itemEntry.itemId] !== undefined) {
                            req = window.calculatorQtys[formId][itemEntry.itemId];
                            isQtyOverridden = true;
                        }

                        // Rate Logic
                        let rate = parseFloat(item.currentAverageCost) || parseFloat(item.price) || 0;
                        let isOverridden = false;

                        // Check Overrides (Temporary Session Data Only)
                        if (window.calculatorOverrides && window.calculatorOverrides[formId] && window.calculatorOverrides[formId][itemEntry.itemId] !== undefined) {
                            rate = window.calculatorOverrides[formId][itemEntry.itemId];
                            isOverridden = true;
                        }

                        const cost = req * rate;
                        totalMaterialCost += cost;

                        rows += generateCalcRow(item.name, item.id, item.unit, req, rate, cost, isOverridden, formId, itemEntry.itemId, isQtyOverridden);
                    }
                });
            };

            if (formula.ingredients) processList(formula.ingredients, 'rawMaterials');
            ['packingMaterials', 'labels'].forEach(cat => formula[cat] && processList(formula[cat], cat));

            // 2. Process Manual Ingredients (From Session)
            if (window.calcSession.manualIngredients && window.calcSession.manualIngredients.length > 0) {
                rows += `<tr class="bg-blue-50"><td colspan="5" class="p-2 text-xs font-bold text-blue-600 uppercase tracking-widest pl-4">Manual Additions</td></tr>`;

                window.calcSession.manualIngredients.forEach((m, idx) => {
                    const cost = m.qty * m.rate;
                    totalMaterialCost += cost;

                    rows += `
                <tr class="hover:bg-gray-50 group">
                    <td class="p-4">
                        <div class="font-bold text-gray-700">${m.name}</div>
                        <div class="text-xs text-gray-400 italic">Manual Entry</div>
                    </td>
                    <td class="p-4 text-right align-top">
                        <div class="text-gray-600">₹${m.rate.toFixed(2)}</div>
                    </td>
                    <td class="p-4 text-right font-mono align-top">${m.qty.toFixed(3)}</td>
                    <td class="p-4 text-right font-bold text-gray-800 align-top">₹${cost.toFixed(2)}</td>
                    <td class="p-4 text-center">
                        <button onclick="removeManualIngredient(${idx})" class="text-red-300 hover:text-red-500 transition">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </td>
                </tr>
            `;
                });
            }

            document.getElementById('calc-details-body').innerHTML = rows;

            // Store Material Cost for Summary Update
            window.lastMaterialCost = totalMaterialCost;

            updateAdditionalCosts();
        };

        function generateCalcRow(name, id, unit, qty, rate, cost, isOverridden, formId, itemId, isQtyOverridden) {
            return `
    <tr class="hover:bg-gray-50 transition-colors group border-b border-gray-50 last:border-0">
        <td class="p-4">
            <div class="font-bold text-gray-700">${name}</div>
            <div class="flex items-center gap-2 mt-1">
                <span class="text-xs text-gray-400 bg-gray-100 px-1 rounded">ID: ${id}</span>
                ${isOverridden ? '<span class="text-xs text-yellow-600 bg-yellow-50 px-1 rounded font-bold border border-yellow-200">Custom Rate</span>' : ''}
                ${isQtyOverridden ? '<span class="text-xs text-purple-600 bg-purple-50 px-1 rounded font-bold border border-purple-200">Custom Qty</span>' : ''}
            </div>
        </td>
        <td class="p-4 text-right align-top">
            <div class="flex items-center justify-end gap-2">
                    <div class="${isOverridden ? 'text-gray-800 font-bold' : 'text-gray-600'}">₹${rate.toFixed(2)}</div>
                    <button onclick="editCalcCost('${formId}', '${itemId}', ${rate})" class="opacity-10 md:opacity-0 group-hover:opacity-100 p-1 rounded hover:bg-blue-100 text-blue-500 transition shadow-sm border border-gray-200 bg-white" title="Edit Rate">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                    </button>
            </div>
        </td>
        <td class="p-4 text-right font-mono text-gray-600 align-top">
             <div class="flex items-center justify-end gap-2">
                <span class="${isQtyOverridden ? 'font-bold text-purple-700' : ''}">${qty.toFixed(3)}</span> <span class="text-xs text-gray-400">${unit}</span>
                <button onclick="editCalcQty('${formId}', '${itemId}', ${qty})" class="opacity-10 md:opacity-0 group-hover:opacity-100 p-1 rounded hover:bg-purple-100 text-purple-500 transition shadow-sm border border-gray-200 bg-white" title="Edit Quantity">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                </button>
            </div>
        </td>
        <td class="p-4 text-right font-bold text-gray-800 align-top">₹${cost.toFixed(2)}</td>
        <td class="p-4 text-center">
             ${isOverridden || isQtyOverridden ?
                    `<button onclick="resetCalcItem('${formId}', '${itemId}')" class="text-xs text-red-500 hover:text-red-700 underline">Reset</button>`
                    : ''}
        </td>
    </tr>`;
        }

        window.updateAdditionalCosts = function () {
            const materialCost = window.lastMaterialCost || 0;

            // Reads Inputs
            const val = (id) => parseFloat(document.getElementById(id).value) || 0;
            const labour = val('cost-labour');
            const pkg = val('cost-packaging');
            const freight = val('cost-freight');
            const other = val('cost-other');
            const tariff = val('cost-tariff');
            const margin = val('cost-margin');

            // Save to Session
            window.calcSession.additionalCosts = { labour, packaging: pkg, freight, other, tariff, margin };

            const overheads = labour + pkg + freight + other + tariff;
            const totalCost = materialCost + overheads;
            const qty = parseFloat(document.getElementById('calc-qty').value) || 1;

            const marginAmt = (totalCost * margin) / 100;
            const sellPrice = totalCost + marginAmt;

            // UI Update
            const setTxt = (id, v) => document.getElementById(id).textContent = v;

            setTxt('summ-material', '₹' + materialCost.toFixed(2));
            setTxt('summ-overhead', '₹' + overheads.toFixed(2));
            setTxt('summ-total', '₹' + totalCost.toFixed(2));
            setTxt('summ-unit', '₹' + (totalCost / qty).toFixed(2));

            setTxt('summ-margin-val', '₹' + marginAmt.toFixed(2));
            setTxt('summ-sell-price', '₹' + sellPrice.toFixed(2));
            setTxt('summ-sell-unit', '/ ' + document.getElementById('calc-unit-display').textContent);
        };

        function resetSummary() {
            window.lastMaterialCost = 0;
            updateAdditionalCosts();
        }

        // ---------------------------------------------------------
        // FEATURES: ADD INGREDIENT & SAVE/LOAD
        // ---------------------------------------------------------

        window.openAddManualItemModal = function () {
            // Check if modal exists
            if (document.getElementById('manualItemModal')) {
                document.getElementById('manualItemModal').classList.remove('hidden');
                document.getElementById('manualItemModal').classList.add('flex');
                return;
            }

            const html = `
    <div id="manualItemModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Add Extra Material</h3>
            
            <div class="mb-4">
                <label class="block text-sm font-bold text-gray-700 mb-1">Item Name</label>
                <input type="text" id="manual-name" class="w-full p-2 border rounded" placeholder="e.g. Special Solvent">
            </div>
            <div class="grid grid-cols-2 gap-4 mb-4">
                 <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">Quantity</label>
                    <input type="number" id="manual-qty" class="w-full p-2 border rounded" placeholder="0">
                 </div>
                 <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">Rate / Unit</label>
                    <input type="number" id="manual-rate" class="w-full p-2 border rounded" placeholder="0.00">
                 </div>
            </div>
            
            <div class="flex justify-end gap-3 border-t pt-4">
                <button onclick="document.getElementById('manualItemModal').classList.add('hidden')" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">Cancel</button>
                <button onclick="confirmAddManualItem()" class="px-4 py-2 bg-blue-600 text-white font-bold rounded hover:bg-blue-700">Add Item</button>
            </div>
        </div>
    </div>`;
            document.body.insertAdjacentHTML('beforeend', html);
        };

        window.confirmAddManualItem = function () {
            const name = document.getElementById('manual-name').value;
            const qty = parseFloat(document.getElementById('manual-qty').value);
            const rate = parseFloat(document.getElementById('manual-rate').value);

            if (!name || !qty || isNaN(rate)) { alert("Please fill details"); return; }

            window.calcSession.manualIngredients.push({ name, qty, rate });

            document.getElementById('manualItemModal').classList.add('hidden');
            document.getElementById('manual-name').value = '';
            document.getElementById('manual-qty').value = '';
            document.getElementById('manual-rate').value = '';

            calculateCostEstimateStrict();
        };

        window.removeManualIngredient = function (index) {
            window.calcSession.manualIngredients.splice(index, 1);
            calculateCostEstimateStrict();
        };

        window.saveCurrentCalculation = function () {
            const formId = document.getElementById('calc-formulation-select').value;
            if (!formId) { alert("Please select a formulation first."); return; }

            const formula = appState.formulas.find(f => f.id == formId);
            const name = prompt("Name this saved calculation:", `${formula.name} - ${new Date().toLocaleDateString()}`);

            if (!name) return;

            if (!appState.savedCalculations) appState.savedCalculations = [];

            const saveState = {
                id: Date.now(),
                name: name,
                date: new Date().toISOString(),
                formId: formId,
                qty: document.getElementById('calc-qty').value,
                session: JSON.parse(JSON.stringify(window.calcSession)),
                overrides: window.calculatorOverrides ? JSON.parse(JSON.stringify(window.calculatorOverrides[formId] || {})) : {}
            };

            appState.savedCalculations.push(saveState);
            if (window.saveState) window.saveState();

            if (window.showToast) showToast("Calculation Saved Successfully");
            else alert("Saved!");
        };

        window.loadSavedCalculationModal = function () {
            if (!appState.savedCalculations || appState.savedCalculations.length === 0) {
                alert("No saved calculations found.");
                return;
            }

            // Simple Prompt for now, or cleaner modal... use cleaner modal
            const saves = appState.savedCalculations;
            let list = saves.map((s, i) => `${i + 1}. ${s.name} (${new Date(s.date).toLocaleDateString()})`).join('\n');
            let choice = prompt(`Enter number to load:\n${list}`);

            if (choice) {
                let idx = parseInt(choice) - 1;
                if (saves[idx]) {
                    loadCalculationState(saves[idx]);
                }
            }
        };

        window.loadCalculationState = function (state) {
            // restore
            document.getElementById('calc-formulation-select').value = state.formId;
            document.getElementById('calc-qty').value = state.qty;
            window.calcSession = state.session;

            if (!window.calculatorOverrides) window.calculatorOverrides = {};
            window.calculatorOverrides[state.formId] = state.overrides;

            calculateCostEstimateStrict();

            if (window.showToast) showToast(`Loaded: ${state.name}`);
        };

        window.resetCalculator = function () {
            if (confirm("Reset all manual entries and additional costs?")) {
                window.calculatorOverrides = {};
                window.calcSession = {
                    manualIngredients: [],
                    additionalCosts: { labour: 0, other: 0, packaging: 0, freight: 0, tariff: 0, margin: 20 }
                };
                document.getElementById('calc-formulation-select').value = "";
                document.getElementById('calc-details-body').innerHTML = "";
                resetSummary();
            }
        };


        // ---------------------------------------------------------
        // EXPORT: PRO PDF (Industry Standard)
        // ---------------------------------------------------------

        window.generateProCostSheetPDF = function () {
            const formId = document.getElementById('calc-formulation-select').value;
            if (!formId) return;

            const formula = appState.formulas.find(f => f.id == formId);
            const date = new Date().toLocaleDateString('en-IN', { day: 'numeric', month: 'long', year: 'numeric' });
            const targetQty = document.getElementById('calc-qty').value;
            const unit = document.getElementById('calc-unit-display').textContent;

            // Data from DOM
            const materialCost = document.getElementById('summ-material').textContent;
            const overheadCost = document.getElementById('summ-overhead').textContent;
            const totalCost = document.getElementById('summ-total').textContent;
            const unitCost = document.getElementById('summ-unit').textContent;
            const marginPC = document.getElementById('cost-margin').value;
            const sellPrice = document.getElementById('summ-sell-price').textContent;

            // Build Table
            let tableRows = '';
            document.querySelectorAll('#calc-details-body tr').forEach(tr => {
                // Clone TR content but strip buttons
                const tds = tr.querySelectorAll('td');
                if (tds.length > 3) {
                    tableRows += `
            <tr style="border-bottom: 1px solid #eee;">
                <td style="padding: 10px; color: #333;">${tds[0].querySelector('.font-bold').textContent}</td>
                <td style="padding: 10px; text-align:right;">${tds[1].innerText.split('₹')[1] || tds[1].innerText}</td> <!-- Rate -->
                <td style="padding: 10px; text-align:right;">${tds[2].innerText}</td> <!-- Qty -->
                <td style="padding: 10px; text-align:right; font-weight:bold;">${tds[3].innerText}</td> <!-- Cost -->
            </tr>
            `;
                }
            });

            const overlay = document.createElement('div');
            overlay.id = 'pro-print-overlay';
            // Inline CSS for foolproof printing
            overlay.innerHTML = `
    <div style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; max-width: 900px; margin: 0 auto; padding: 40px; color: #333;">
        
        <!-- Header -->
        <div style="border-bottom: 3px solid #1a56db; padding-bottom: 20px; margin-bottom: 40px; display:flex; justify-content:space-between; align-items:end;">
            <div>
                <h1 style="color: #1a56db; margin: 0; font-size: 28px; text-transform:uppercase; letter-spacing: 1px;">Costing Sheet</h1>
                <p style="margin: 5px 0 0; color: #666; font-size: 14px;">Internal Production Estimate</p>
            </div>
            <div style="text-align:right;">
                <div style="font-weight:bold; font-size: 18px;">${formula.name}</div>
                <div style="color: #666; font-size: 14px;">Date: ${date}</div>
            </div>
        </div>

        <!-- Summary Grid -->
        <div style="background: #f8fafc; padding: 20px; border-radius: 8px; margin-bottom: 40px; display: flex; justify-content: space-between; border: 1px solid #e2e8f0;">
             <div>
                <span style="display:block; font-size: 11px; text-transform:uppercase; color: #64748b; font-weight:bold;">Configuration</span>
                <strong style="display:block; font-size: 16px; margin-top:4px;">${targetQty} ${unit}</strong>
             </div>
             <div>
                <span style="display:block; font-size: 11px; text-transform:uppercase; color: #64748b; font-weight:bold;">Total Cost</span>
                <strong style="display:block; font-size: 16px; margin-top:4px; color: #0f172a;">${totalCost}</strong>
             </div>
             <div>
                <span style="display:block; font-size: 11px; text-transform:uppercase; color: #64748b; font-weight:bold;">Cost / Unit</span>
                <strong style="display:block; font-size: 16px; margin-top:4px; color: #0f172a;">${unitCost}</strong>
             </div>
             <div>
                <span style="display:block; font-size: 11px; text-transform:uppercase; color: #64748b; font-weight:bold;">Rec. Price (Avg)</span>
                <strong style="display:block; font-size: 16px; margin-top:4px; color: #16a34a;">${sellPrice}</strong>
             </div>
        </div>

        <!-- Detailed BOM -->
        <h3 style="font-size: 14px; text-transform: uppercase; border-bottom: 1px solid #ccc; padding-bottom: 10px; margin-bottom: 15px;">Bill of Materials & Cost Breakdown</h3>
        <table style="width: 100%; border-collapse: collapse; font-size: 13px; margin-bottom: 40px;">
            <thead>
                <tr style="background: #f1f5f9;">
                    <th style="text-align: left; padding: 10px; border-bottom: 2px solid #cbd5e1;">Item Description</th>
                    <th style="text-align: right; padding: 10px; border-bottom: 2px solid #cbd5e1;">Rate</th>
                    <th style="text-align: right; padding: 10px; border-bottom: 2px solid #cbd5e1;">Qty</th>
                    <th style="text-align: right; padding: 10px; border-bottom: 2px solid #cbd5e1;">Total</th>
                </tr>
            </thead>
            <tbody>
                ${tableRows}
            </tbody>
        </table>

        <!-- Overhead Summary Scope -->
        <div style="display:flex; justify-content: flex-end;">
            <div style="width: 350px;">
                <table style="width: 100%; font-size: 13px;">
                    <tr>
                        <td style="padding: 8px 0; color: #64748b;">Raw Material Total</td>
                        <td style="text-align: right; font-weight: bold;">${materialCost}</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px 0; color: #64748b;">Op. Overheads (Freight, Pkg, etc)</td>
                        <td style="text-align: right; font-weight: bold;">${overheadCost}</td>
                    </tr>
                     <tr>
                        <td style="padding: 8px 0; font-weight: bold; border-top: 1px solid #eee;">Net Production Cost</td>
                        <td style="text-align: right; font-weight: bold; border-top: 1px solid #eee;">${totalCost}</td>
                    </tr>
                     <tr>
                        <td style="padding: 15px 0 0; color: #64748b;">Profit Margin (${marginPC}%)</td>
                        <td style="text-align: right; padding-top: 15px; color: #16a34a;">+ ${document.getElementById('summ-margin-val').textContent}</td>
                    </tr>
                     <tr>
                        <td style="padding: 8px 0; font-size: 16px; font-weight: bold; border-top: 2px solid #000; color: #000;">Recc. Buying Rate</td>
                        <td style="text-align: right; font-size: 16px; font-weight: bold; border-top: 2px solid #000; color: #16a34a;">${sellPrice}</td>
                    </tr>
                </table>
            </div>
        </div>

        <!-- Footer -->
        <div style="margin-top: 60px; padding-top: 20px; border-top: 1px solid #eee; text-align: center; font-size: 11px; color: #94a3b8;">
            Generated by Miklens Bio Inventory System | Confidential Document
        </div>
    </div>
    
    <style>
         @media print {
            body > *:not(#pro-print-overlay) { display: none !important; }
            #pro-print-overlay { display: block !important; position: absolute; top: 0; left: 0; width: 100%; }
         }
    </style>
    `;

            document.body.appendChild(overlay);
            window.print();
            // Cleanup
            setTimeout(() => {
                // Confirm close if needed
                const btn = document.createElement('button');
                btn.textContent = "Close Preview (After Print)";
                btn.style.cssText = "position:fixed; top:20px; right:20px; background:red; color:white; padding:10px; z-index:10000; cursor:pointer;";
                btn.onclick = () => document.body.removeChild(overlay);
                overlay.appendChild(btn);
            }, 1000);
        };

        console.log("ANTIGRAVITY: Feature Pack V10 (Final) Loaded.");
    </script>

    <script>
        // ================================================================
        // FEATURE PACK V11: FIXES & POLISH (Dropdowns, Edit Logic, Modals)
        // ================================================================
        console.log("ANTIGRAVITY: Loading Feature Pack V11 (Fixes)...");

        // 1. FIX EDIT OVERRIDE LOGIC
        // The issue was it wasn't re-triggering the STRICT calculation that includes V10 additional costs.
        window.editCalcCost = function (formId, itemId, currentRate) {
            const newRate = prompt("Enter manual Cost Per Unit:", currentRate);
            if (newRate !== null) {
                const parsed = parseFloat(newRate);
                if (!isNaN(parsed) && parsed >= 0) {
                    if (!window.calculatorOverrides) window.calculatorOverrides = {};
                    if (!window.calculatorOverrides[formId]) window.calculatorOverrides[formId] = {};
                    window.calculatorOverrides[formId][itemId] = parsed;

                    // CRITICAL FIX: Call the V10 Strict Calculator
                    calculateCostEstimateStrict();

                    if (window.showToast) showToast('Rate updated locally');
                } else {
                    alert("Invalid price!");
                }
            }
        };

        // 2. IMPROVED ADD INGREDIENT (DROPDOWN)
        window.openAddManualItemModal = function () {
            // Remove old modal if it exists to ensure freshness
            const existing = document.getElementById('manualItemModal');
            if (existing) existing.remove();

            // Prepare Options
            let opts = '<option value="">-- Select Item --</option>';

            const addGroup = (label, list) => {
                if (!list || list.length === 0) return;
                opts += `<optgroup label="${label}">`;
                list.forEach(i => {
                    // Store price in data attribute for auto-fill
                    const p = i.currentAverageCost || i.price || 0;
                    opts += `<option value="${i.name}" data-price="${p}" data-id="${i.id}">${i.name} (Avg: ₹${p})</option>`;
                });
                opts += `</optgroup>`;
            };

            if (appState.inventory) {
                addGroup('Raw Materials', appState.inventory.rawMaterials || []);
                addGroup('Packing Materials', appState.inventory.packingMaterials || []);
                addGroup('Labels / Consumables', appState.inventory.labels || []);
            }

            const html = `
    <div id="manualItemModal" class="modal fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-50 backdrop-blur-sm" onclick="closeModalOnBack(event, 'manualItemModal')">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 transform transition-all scale-100 relative">
            
            <button onclick="document.getElementById('manualItemModal').remove()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>

            <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                <span class="p-1 bg-blue-100 rounded-lg text-blue-600">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </span>
                Add Additional Material
            </h3>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">Select Material / Ingredient</label>
                    <select id="manual-select" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-gray-50 text-gray-800 font-medium" onchange="autoFillManualRate(this)">
                        ${opts}
                    </select>
                </div>
                
                <div class="relative flex py-2 items-center">
                    <div class="flex-grow border-t border-gray-200"></div>
                    <span class="flex-shrink-0 mx-4 text-gray-400 text-xs uppercase font-bold">Or enter custom</span>
                    <div class="flex-grow border-t border-gray-200"></div>
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">Item Name (Custom)</label>
                    <input type="text" id="manual-name" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="e.g. Special Additive">
                </div>

                <div class="grid grid-cols-2 gap-4">
                     <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Quantity</label>
                        <input type="number" id="manual-qty" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 font-bold" placeholder="0">
                     </div>
                     <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Rate / Unit (₹)</label>
                        <input type="number" id="manual-rate" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 font-bold" placeholder="0.00">
                     </div>
                </div>
            </div>
            
            <div class="flex justify-end gap-3 mt-8 pt-4 border-t border-gray-100">
                <button onclick="document.getElementById('manualItemModal').remove()" class="px-5 py-2.5 text-gray-600 hover:bg-gray-100 rounded-lg font-medium">Cancel</button>
                <button onclick="confirmAddManualItem()" class="px-5 py-2.5 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 shadow-lg transform active:scale-95 transition-all">Add to Costing</button>
            </div>
        </div>
    </div>`;
            document.body.insertAdjacentHTML('beforeend', html);
        };

        window.autoFillManualRate = function (select) {
            const opt = select.options[select.selectedIndex];
            if (opt && opt.value) {
                document.getElementById('manual-name').value = opt.value; // Name to input
                const price = opt.getAttribute('data-price');
                document.getElementById('manual-rate').value = parseFloat(price).toFixed(2);
            }
        };

        window.closeModalOnBack = function (e, id) {
            if (e.target.id === id) {
                document.getElementById(id).remove();
            }
        };

        // 3. IMPROVED LOAD SAVED (MODAL)
        window.loadSavedCalculationModal = function () {
            // Ensure it's an array
            if (!Array.isArray(appState.savedCalculations)) {
                appState.savedCalculations = [];
            }

            if (appState.savedCalculations.length === 0) {
                alert("No saved calculations found. Save one first!");
                // Optional: show toast if available
                if (window.showToast) window.showToast("No saved calculations.");
                return;
            }

            // Remove old
            const existing = document.getElementById('loadSavedModal');
            if (existing) existing.remove();

            let listHtml = '';
            appState.savedCalculations.forEach((s, idx) => {
                listHtml += `
        <div class="flex justify-between items-center p-4 hover:bg-blue-50 border rounded-lg border-gray-200 transition-colors group cursor-pointer" onclick="loadSavedAndClose(${idx})">
            <div>
                <div class="font-bold text-gray-800 text-lg">${s.name}</div>
                <div class="text-xs text-gray-500 flex gap-3 mt-1">
                    <span>📅 ${new Date(s.date).toLocaleDateString()}</span>
                    <span>📦 Qty: ${s.qty}</span>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <button class="px-3 py-1 bg-blue-100 text-blue-700 rounded text-sm font-bold opacity-0 group-hover:opacity-100 transition-opacity">Load</button>
                <button onclick="event.stopPropagation(); deleteSavedCalc(${idx});" class="p-2 text-gray-300 hover:text-red-500 transition-colors" title="Delete">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                </button>
            </div>
        </div>
        `;
            });

            const html = `
    <div id="loadSavedModal" class="modal fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-50 backdrop-blur-sm" onclick="closeModalOnBack(event, 'loadSavedModal')">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl p-6 h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">Saved Estimates</h3>
                <button onclick="document.getElementById('loadSavedModal').remove()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto space-y-3 pr-2 custom-scrollbar">
                ${listHtml}
            </div>
        </div>
    </div>`;
            document.body.insertAdjacentHTML('beforeend', html);
        };

        window.loadSavedAndClose = function (idx) {
            const s = appState.savedCalculations[idx];
            if (s) {
                loadCalculationState(s);
                document.getElementById('loadSavedModal').remove();
            }
        };

        window.deleteSavedCalc = function (idx) {
            if (confirm("Are you sure you want to delete this save?")) {
                appState.savedCalculations.splice(idx, 1);
                if (window.saveState) window.saveState();
                // Refresh modal
                document.getElementById('loadSavedModal').remove();
                loadSavedCalculationModal();
            }
        };

        console.log("ANTIGRAVITY: Feature Pack V11 (Fixes) Loaded.");
    </script>

    <script>
        // ================================================================
        // FEATURE PACK V12: GLOBAL SEARCH NAVIGATION OVERRIDE
        // Antigravity AI - V12.1 - ENHANCED DEBUG
        // ================================================================
        console.log("ANTIGRAVITY: Loading Feature Pack V12 (Navigation Override)...");

        // THIS COMPLETELY OVERRIDES ANY BROKEN navigateToResult
        window.navigateToResult = function (view, id, category) {
            try {
                const idStr = String(id);
                console.log("V12 Navigate:", view, idStr, category);

                // Hide search UI
                const searchUI = document.getElementById('global-search-results');
                if (searchUI) searchUI.classList.add('hidden');
                const searchInput = document.getElementById('global-search-input');
                if (searchInput) searchInput.value = '';

                // SPECIAL VIEWS: Handle customer-history, supplier-history, batch-trace, product-trace
                if (view === 'customer-history') {
                    try {
                        if (window.viewCustomerHistory) {
                            // Convert to number - these functions expect numeric IDs
                            var numId = parseFloat(idStr);
                            console.log("V12: Calling viewCustomerHistory with ID:", numId);
                            window.viewCustomerHistory(numId);
                        } else if (window.showView) {
                            window.showView('customers');
                        }
                    } catch (err) {
                        console.error("V12: Error in viewCustomerHistory:", err);
                        if (window.showView) window.showView('customers');
                    }
                    return;
                }

                if (view === 'supplier-history') {
                    try {
                        if (window.viewSupplierHistory) {
                            var numId = parseFloat(idStr);
                            console.log("V12: Calling viewSupplierHistory with ID:", numId);
                            window.viewSupplierHistory(numId);
                        } else if (window.showView) {
                            window.showView('suppliers');
                        }
                    } catch (err) {
                        console.error("V12: Error in viewSupplierHistory:", err);
                        if (window.showView) window.showView('suppliers');
                    }
                    return;
                }

                if (view === 'batch-trace' || view === 'product-trace') {
                    try {
                        if (window.openProductTrace) {
                            console.log("V12: Calling openProductTrace with ID:", idStr);
                            window.openProductTrace(idStr);
                        }
                    } catch (err) {
                        console.error("V12: Error in openProductTrace:", err);
                    }
                    return;
                }

                // Map view names
                let targetView = view;
                if (view === 'finishedGoods') targetView = 'finished-goods';
                if (view === 'rawMaterials') targetView = 'raw-materials';
                if (view === 'packingMaterials') targetView = 'packing-materials';

                // Show the view
                if (window.showView) window.showView(targetView);

                // Clear local search filters after a brief delay
                setTimeout(function () {
                    var filterInputs = document.querySelectorAll('input[type="text"]');
                    filterInputs.forEach(function (inp) {
                        if (inp.id && inp.id.toLowerCase().includes('search') && inp.id !== 'global-search-input') {
                            inp.value = '';
                            inp.dispatchEvent(new Event('input', { bubbles: true }));
                        }
                    });
                }, 100);

                // HIGHLIGHT & SCROLL with retry
                var attempts = 0;
                var findAndHighlight = setInterval(function () {
                    attempts++;

                    // Build ID prefix
                    var idPrefix = category;
                    if (category === 'customer') idPrefix = 'customers';
                    if (category === 'supplier') idPrefix = 'suppliers';

                    // DEBUG: Log what we're looking for
                    console.log("V12 Attempt " + attempts + ": Looking for row with ID patterns...");
                    console.log("  - row-" + idPrefix + "-" + idStr);
                    console.log("  - row-" + category + "-" + idStr);
                    console.log("  - item-" + idStr);

                    // Try multiple ID patterns
                    var row = document.getElementById('row-' + idPrefix + '-' + idStr);
                    if (!row) row = document.getElementById('row-' + category + '-' + idStr);
                    if (!row) row = document.getElementById('item-' + idStr);
                    if (!row) row = document.querySelector('tr[data-item-id="' + idStr + '"]');

                    // Fallback: search in active view container
                    if (!row) {
                        var container = document.getElementById(targetView + '-view');
                        if (container) {
                            row = container.querySelector('tr[data-item-id="' + idStr + '"]');

                            // DEBUG: List all row IDs in container
                            if (attempts === 5) {
                                var allRows = container.querySelectorAll('tr[id]');
                                console.log("V12 DEBUG: Found " + allRows.length + " rows with IDs in container:");
                                for (var i = 0; i < Math.min(10, allRows.length); i++) {
                                    console.log("  Row ID: " + allRows[i].id);
                                }
                            }
                        }
                    }

                    // NEW: Try partial ID match
                    if (!row) {
                        row = document.querySelector('tr[id*="-' + idStr + '"]');
                    }

                    // NEW: Search ALL tables for data-item-id
                    if (!row) {
                        var allTables = document.querySelectorAll('table tbody');
                        for (var t = 0; t < allTables.length; t++) {
                            var foundRow = allTables[t].querySelector('tr[data-item-id="' + idStr + '"]');
                            if (foundRow) {
                                row = foundRow;
                                console.log("V12: Found row in table " + t);
                                break;
                            }
                        }
                    }

                    if (row) {
                        clearInterval(findAndHighlight);
                        console.log("V12 Success! Found row:", row.id || row);

                        // SCROLL
                        row.scrollIntoView({ behavior: 'smooth', block: 'center' });

                        // HIGHLIGHT - Multiple layers for visibility
                        var originalBg = row.style.backgroundColor;
                        row.style.backgroundColor = '#FFFF00';
                        row.style.setProperty('background-color', '#FFFF00', 'important');
                        row.style.boxShadow = '0 0 15px 5px rgba(255, 255, 0, 0.9)';
                        row.style.outline = '3px solid #FFA500';
                        row.style.transition = 'all 0.3s';

                        // Remove highlight after 5 seconds
                        setTimeout(function () {
                            row.style.backgroundColor = originalBg || '';
                            row.style.removeProperty('background-color');
                            row.style.boxShadow = '';
                            row.style.outline = '';
                        }, 5000);
                    }

                    if (attempts > 40) {
                        clearInterval(findAndHighlight);
                        console.warn("V12: Could not find row for ID:", idStr);
                        console.warn("V12: Tried view:", targetView + "-view");

                        // Last resort: alert the user
                        var viewContainer = document.getElementById(targetView + '-view');
                        if (viewContainer) {
                            var rowCount = viewContainer.querySelectorAll('tr').length;
                            console.warn("V12: Container has " + rowCount + " rows total");
                        }
                    }
                }, 100);

            } catch (err) {
                console.error("V12 Navigation Error:", err);
            }
        };

        console.log("ANTIGRAVITY: Feature Pack V12 Loaded. navigateToResult OVERRIDDEN.");
    </script>

    <!-- ANTIGRAVITY FEATURE PACK V13: SMART ALERTS & NOTIFICATIONS DASHBOARD -->
    <script>
        console.log("ANTIGRAVITY: Loading Feature Pack V13 (Smart Alerts)...");

        // ========== ALERT CALCULATION ==========
        window.calculateAlerts = function () {
            var alerts = [];
            var today = new Date();
            var categories = ['rawMaterials', 'packingMaterials', 'labels', 'finishedGoods'];

            categories.forEach(function (cat) {
                var items = appState.inventory[cat] || [];
                items.forEach(function (item) {
                    try {
                        var stock = calculateStock(item, cat, getToday());

                        // 1. CRITICAL: Negative stock
                        if (stock.closingStock < 0) {
                            alerts.push({
                                id: 'neg-' + cat + '-' + item.id,
                                type: 'negative',
                                severity: 'critical',
                                category: cat,
                                itemId: item.id,
                                itemName: item.name,
                                message: 'Negative stock: ' + stock.closingStock.toFixed(2) + ' ' + item.unit,
                                value: stock.closingStock,
                                timestamp: Date.now()
                            });
                        }

                        // 2. WARNING: Low stock
                        if (item.minStockLevel && stock.closingStock >= 0 && stock.closingStock < item.minStockLevel) {
                            alerts.push({
                                id: 'low-' + cat + '-' + item.id,
                                type: 'lowStock',
                                severity: 'warning',
                                category: cat,
                                itemId: item.id,
                                itemName: item.name,
                                message: 'Low stock: ' + stock.closingStock.toFixed(2) + ' / ' + item.minStockLevel + ' ' + item.unit,
                                value: stock.closingStock,
                                timestamp: Date.now()
                            });
                        }

                        // 3. WARNING: Expiring soon (from batches)
                        if (item.batches && item.batches.length > 0) {
                            item.batches.forEach(function (batch) {
                                if (batch.expiryDate && batch.quantity > 0) {
                                    var expDate = new Date(batch.expiryDate);
                                    var daysToExpiry = Math.floor((expDate - today) / (1000 * 60 * 60 * 24));
                                    if (daysToExpiry > 0 && daysToExpiry < 30) {
                                        alerts.push({
                                            id: 'exp-' + cat + '-' + item.id + '-' + batch.batchNumber,
                                            type: 'expiring',
                                            severity: 'warning',
                                            category: cat,
                                            itemId: item.id,
                                            itemName: item.name,
                                            message: 'Batch ' + batch.batchNumber + ' expires in ' + daysToExpiry + ' days',
                                            value: daysToExpiry,
                                            batchNumber: batch.batchNumber,
                                            timestamp: Date.now()
                                        });
                                    }
                                }
                            });
                        }

                        // 4. INFO: Inactive items (no transactions in 90+ days)
                        var itemTxs = appState.transactions.filter(function (t) {
                            return t.itemId == item.id && t.category == cat;
                        }).sort(function (a, b) {
                            return new Date(b.date) - new Date(a.date);
                        });

                        if (itemTxs.length > 0) {
                            var lastTx = itemTxs[0];
                            var daysSince = Math.floor((today - new Date(lastTx.date)) / (1000 * 60 * 60 * 24));
                            if (daysSince > 90) {
                                alerts.push({
                                    id: 'inactive-' + cat + '-' + item.id,
                                    type: 'inactive',
                                    severity: 'info',
                                    category: cat,
                                    itemId: item.id,
                                    itemName: item.name,
                                    message: 'No activity for ' + daysSince + ' days',
                                    value: daysSince,
                                    timestamp: Date.now()
                                });
                            }
                        }
                    } catch (err) {
                        console.error("Alert calculation error for item:", item.name, err);
                    }
                });
            });

            return alerts;
        };

        // ========== ALERT RENDERING ==========
        window.renderAlertsView = function () {
            var alerts = calculateAlerts();
            var container = document.getElementById('alerts-view');
            if (!container) return;

            // Update badge
            var badge = document.getElementById('alert-badge');
            if (badge) {
                var criticalCount = alerts.filter(function (a) { return a.severity === 'critical'; }).length;
                if (criticalCount > 0) {
                    badge.textContent = criticalCount;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            }

            // Group alerts by severity
            var critical = alerts.filter(function (a) { return a.severity === 'critical'; });
            var warnings = alerts.filter(function (a) { return a.severity === 'warning'; });
            var info = alerts.filter(function (a) { return a.severity === 'info'; });

            var html = '<div class="max-w-7xl mx-auto">';
            html += '<div class="flex justify-between items-center mb-6">';
            html += '<h2 class="text-3xl font-bold text-gray-800">🔔 Alerts & Notifications</h2>';
            html += '<div class="text-sm text-gray-600">';
            html += '<span class="font-bold text-red-600">' + critical.length + '</span> critical, ';
            html += '<span class="font-bold text-orange-600">' + warnings.length + '</span> warnings, ';
            html += '<span class="font-bold text-blue-600">' + info.length + '</span> info';
            html += '</div></div>';

            // Search bar
            html += '<div class="mb-4">';
            html += '<input type="text" id="alert-search-input" placeholder="🔍 Search alerts by item name or message..." ';
            html += 'oninput="window.alertSearchWasFocused=true; window.alertSearchCursorPos=this.selectionStart; window.currentAlertSearch=this.value; renderAlertsView()" ';
            html += 'class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none text-base" ';
            html += 'value="' + (window.currentAlertSearch || '') + '">';
            html += '</div>';

            // Filter buttons
            html += '<div class="flex gap-2 mb-6">';
            html += '<button onclick="window.currentAlertFilter=\'all\'; renderAlertsView()" class="px-4 py-2 bg-gray-800 text-white rounded hover:bg-gray-700 font-semibold">All (' + alerts.length + ')</button>';
            html += '<button onclick="window.currentAlertFilter=\'critical\'; renderAlertsView()" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 font-semibold">Critical (' + critical.length + ')</button>';
            html += '<button onclick="window.currentAlertFilter=\'warning\'; renderAlertsView()" class="px-4 py-2 bg-orange-600 text-white rounded hover:bg-orange-700 font-semibold">Warnings (' + warnings.length + ')</button>';
            html += '<button onclick="window.currentAlertFilter=\'info\'; renderAlertsView()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 font-semibold">Info (' + info.length + ')</button>';
            html += '</div>';

            // Apply filter
            var filter = window.currentAlertFilter || 'all';
            var filtered = alerts;
            if (filter === 'critical') filtered = critical;
            else if (filter === 'warning') filtered = warnings;
            else if (filter === 'info') filtered = info;

            // Apply search
            var searchTerm = (window.currentAlertSearch || '').toLowerCase();
            if (searchTerm) {
                filtered = filtered.filter(function (a) {
                    return a.itemName.toLowerCase().indexOf(searchTerm) !== -1 ||
                        a.message.toLowerCase().indexOf(searchTerm) !== -1;
                });
            }

            if (filtered.length === 0) {
                html += '<div class="bg-green-50 border-l-4 border-green-500 p-6 rounded-lg shadow text-center">';
                html += '<svg class="w-16 h-16 mx-auto text-green-500 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">';
                html += '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
                html += '<h3 class="text-xl font-bold text-green-800 mb-2">All Clear!</h3>';
                html += '<p class="text-green-700">No ' + (filter === 'all' ? '' : filter + ' ') + 'alerts at this time.</p>';
                html += '</div>';
            } else {
                html += '<div class="space-y-3">';
                filtered.forEach(function (alert) {
                    html += renderAlertCard(alert);
                });
                html += '</div>';
            }

            html += '</div>';
            container.innerHTML = html;

            // CRITICAL: Restore focus to search input if it was focused before
            if (window.alertSearchWasFocused) {
                var searchInput = document.getElementById('alert-search-input');
                if (searchInput) {
                    searchInput.focus();
                    // Restore cursor position
                    if (typeof window.alertSearchCursorPos === 'number') {
                        searchInput.setSelectionRange(window.alertSearchCursorPos, window.alertSearchCursorPos);
                    }
                }
                window.alertSearchWasFocused = false;
            }
        };

        // Helper: Render individual alert card
        function renderAlertCard(alert) {
            var severityColors = {
                critical: 'bg-red-100 border-red-600 border-l-8',
                warning: 'bg-orange-100 border-orange-600 border-l-8',
                info: 'bg-blue-100 border-blue-600 border-l-8'
            };

            var textColors = {
                critical: 'text-red-900',
                warning: 'text-orange-900',
                info: 'text-blue-900'
            };

            var icons = {
                negative: '⚠️',
                lowStock: '📉',
                expiring: '📅',
                inactive: '😴'
            };

            var html = '<div class="p-5 rounded-lg shadow-md ' + severityColors[alert.severity] + '">';
            html += '<div class="flex items-center justify-between">';
            html += '<div class="flex items-center gap-3 flex-1">';
            html += '<span class="text-4xl">' + icons[alert.type] + '</span>';
            html += '<div>';
            html += '<h4 class="font-bold ' + textColors[alert.severity] + ' text-lg">' + alert.itemName + '</h4>';
            html += '<p class="text-sm ' + textColors[alert.severity] + ' opacity-90 font-medium">' + alert.message + '</p>';
            html += '<span class="text-xs text-gray-500 uppercase font-semibold">' + getCategoryDisplayName(alert.category) + '</span>';
            html += '</div></div>';
            html += '<div class="flex gap-2">';
            html += '<button onclick="navigateToAlertItem(\'' + alert.category + '\', ' + alert.itemId + ')" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm font-semibold">View Item</button>';
            if (alert.type === 'lowStock') {
                html += '<button onclick="quickReceive(\'' + alert.category + '\', ' + alert.itemId + ')" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 text-sm font-semibold">Receive Stock</button>';
            }
            html += '</div></div></div>';
            return html;
        };

        // ========== ALERT ACTIONS ==========
        window.navigateToAlertItem = function (category, itemId) {
            var viewMap = {
                rawMaterials: 'raw-materials',
                packingMaterials: 'packing-materials',
                labels: 'labels',
                finishedGoods: 'finished-goods'
            };
            var view = viewMap[category];
            if (view && window.navigateToResult) {
                window.navigateToResult(view, itemId, category);
            }
        };

        window.quickReceive = function (category, itemId) {
            if (window.openStockTxModal) {
                window.openStockTxModal(category, itemId, 'receive');
            } else {
                alert('Stock receive function not found. Please receive stock manually.');
            }
        };

        function getCategoryDisplayName(cat) {
            var map = {
                rawMaterials: 'Raw Materials',
                packingMaterials: 'Packing Materials',
                labels: 'Labels',
                finishedGoods: 'Finished Goods'
            };
            return map[cat] || cat;
        }

        // ========== DASHBOARD ALERT BANNER ==========
        window.renderDashboardAlertBanner = function () {
            var dashboard = document.getElementById('dashboard-view');
            if (!dashboard) return;

            var alerts = calculateAlerts();
            var critical = alerts.filter(function (a) { return a.severity === 'critical'; });
            var warnings = alerts.filter(function (a) { return a.severity === 'warning'; });

            if (critical.length === 0 && warnings.length === 0) return; // No banner if all clear

            var borderColor = critical.length > 0 ? 'border-red-500' : 'border-orange-500';
            var iconColor = critical.length > 0 ? 'text-red-500' : 'text-orange-500';

            var banner = '<div class="bg-white border-l-4 ' + borderColor + ' p-4 mb-6 shadow-md rounded-r-lg">';
            banner += '<div class="flex items-center justify-between">';
            banner += '<div class="flex items-center gap-3">';
            banner += '<svg class="w-8 h-8 ' + iconColor + '" fill="none" stroke="currentColor" viewBox="0 0 24 24">';
            banner += '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>';
            banner += '<div>';
            banner += '<h3 class="font-bold text-gray-800 text-lg">Active Alerts</h3>';
            banner += '<p class="text-sm text-gray-600">';
            if (critical.length > 0) banner += '<span class="font-bold text-red-600">' + critical.length + '</span> critical &nbsp;';
            if (warnings.length > 0) banner += '<span class="font-bold text-orange-600">' + warnings.length + '</span> warnings';
            banner += '</p></div></div>';
            banner += '<button onclick="showView(\'alerts\')" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold shadow-md transition">View All Alerts</button>';
            banner += '</div></div>';

            // Insert at beginning of dashboard
            var existing = dashboard.innerHTML;
            dashboard.innerHTML = banner + existing;
        };

        // Hook into showView to render alerts when switching to alerts view
        var originalShowView = window.showView;
        window.showView = function (viewName) {
            originalShowView(viewName);
            if (viewName === 'alerts') {
                renderAlertsView();
            } else if (viewName === 'dashboard') {
                // Slight delay to let dashboard render first
                setTimeout(renderDashboardAlertBanner, 100);
            }
        };

        console.log("ANTIGRAVITY: Feature Pack V13 Loaded. Smart Alerts Active.");
    </script>

    <!-- ANTIGRAVITY FEATURE PACK V14: ENHANCED DASHBOARD WITH VISUAL ANALYTICS -->
    <script>
        console.log("ANTIGRAVITY: Loading Feature Pack V14 (Enhanced Dashboard)...");

        // ========== KPI CALCULATION FUNCTIONS ==========
        window.calculateDashboardKPIs = function () {
            var kpis = {
                totalValue: 0,
                outOfStock: 0,
                lowStock: 0,
                fastMoving: [],
                slowMovingValue: 0
            };

            var today = new Date();
            var thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
            var sixtyDaysAgo = new Date(today.getTime() - (60 * 24 * 60 * 60 * 1000));

            var allItems = [];
            var categories = ['rawMaterials', 'packingMaterials', 'labels', 'finishedGoods'];

            categories.forEach(function (cat) {
                var items = appState.inventory[cat] || [];
                items.forEach(function (item) {
                    try {
                        var stock = calculateStock(item, cat, getToday());
                        var value = stock.closingStock * (item.currentAverageCost || item.price || 0);

                        // Total inventory value
                        kpis.totalValue += value;

                        // Stock status counts
                        if (stock.closingStock <= 0) {
                            kpis.outOfStock++;
                        } else if (item.minStockLevel && stock.closingStock < item.minStockLevel) {
                            kpis.lowStock++;
                        }

                        // Get transactions for this item in last 30 days
                        var recentTxs = appState.transactions.filter(function (t) {
                            return t.itemId == item.id && t.category == cat &&
                                new Date(t.date) >= thirtyDaysAgo;
                        });

                        var consumedLast30 = recentTxs
                            .filter(function (t) { return t.type === 'consume' || t.type === 'dispatch'; })
                            .reduce(function (sum, t) { return sum + (t.quantity || 0); }, 0);

                        // Track for fast/slow moving
                        allItems.push({
                            name: item.name,
                            category: cat,
                            value: value,
                            consumed30Days: consumedLast30,
                            stock: stock.closingStock
                        });

                        // Slow moving (no transactions in 60+ days)
                        var txsSince60 = appState.transactions.filter(function (t) {
                            return t.itemId == item.id && t.category == cat &&
                                new Date(t.date) >= sixtyDaysAgo;
                        });

                        if (txsSince60.length === 0 && stock.closingStock > 0) {
                            kpis.slowMovingValue += value;
                        }
                    } catch (err) {
                        console.error("KPI calc error:", item.name, err);
                    }
                });
            });

            // Top 5 fast-moving items (by consumption in last 30 days)
            kpis.fastMoving = allItems
                .filter(function (i) { return i.consumed30Days > 0; })
                .sort(function (a, b) { return b.consumed30Days - a.consumed30Days; })
                .slice(0, 5);

            return kpis;
        };

        // ========== ENHANCED DASHBOARD RENDERING ==========
        window.renderEnhancedDashboard = function () {
            var dashboard = document.getElementById('dashboard-view');
            if (!dashboard) return;

            var kpis = calculateDashboardKPIs();

            var html = '<div class="max-w-7xl mx-auto">';
            html += '<h1 class="text-4xl font-bold text-gray-900 mb-6">Executive Dashboard</h1>';

            // CATEGORY BREAKDOWN ROW (ABOVE KPI CARDS)
            html += '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">';
            var categories = [
                { key: 'rawMaterials', label: 'RAW MATERIALS' },
                { key: 'packingMaterials', label: 'PACKING MATERIALS' },
                { key: 'labels', label: 'LABELS' },
                { key: 'finishedGoods', label: 'FINISHED GOODS' }
            ];

            categories.forEach(function (cat) {
                var items = appState.inventory[cat.key] || [];
                var categoryValue = items.reduce(function (sum, item) {
                    try {
                        var stock = calculateStock(item, cat.key, getToday());
                        return sum + (stock.closingStock * (item.currentAverageCost || item.price || 0));
                    } catch (e) {
                        return sum;
                    }
                }, 0);

                html += '<div class="bg-white p-4 rounded-lg border-l-4 border-blue-500 shadow">';
                html += '<p class="text-xs font-semibold text-gray-600 mb-1">' + cat.label + '</p>';
                html += '<h3 class="text-2xl font-bold text-gray-900">₹' + categoryValue.toLocaleString('en-IN', { maximumFractionDigits: 0 }) + '</h3>';
                html += '</div>';
            });
            html += '</div>';

            html += '<h2 class="text-2xl font-semibold text-gray-700 mb-6">📊 Dashboard Overview</h2>';

            // KPI CARDS ROW
            html += '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">';

            // Card 1: Total Inventory Value
            html += '<div class="bg-gradient-to-br from-blue-500 to-blue-700 p-6 rounded-xl shadow-lg text-white">';
            html += '<div class="flex items-center justify-between mb-2">';
            html += '<p class="text-sm font-semibold opacity-90">Total Inventory Value</p>';
            html += '<svg class="w-8 h-8 opacity-75" fill="currentColor" viewBox="0 0 20 20"><path d="M8.433 7.418c.155-.103.346-.196.567-.267v1.698a2.305 2.305 0 01-.567-.267C8.07 8.34 8 8.114 8 8c0-.114.07-.34.433-.582zM11 12.849v-1.698c.22.071.412.164.567.267.364.243.433.468.433.582 0 .114-.07.34-.433.582a2.305 2.305 0 01-.567.267z"/><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v.092a4.535 4.535 0 00-1.676.662C6.602 6.234 6 7.009 6 8c0 .99.602 1.765 1.324 2.246.48.32 1.054.545 1.676.662v1.941c-.391-.127-.68-.317-.843-.504a1 1 0 10-1.51 1.31c.562.649 1.413 1.076 2.353 1.253V15a1 1 0 102 0v-.092a4.535 4.535 0 001.676-.662C13.398 13.766 14 12.991 14 12c0-.99-.602-1.765-1.324-2.246A4.535 4.535 0 0011 9.092V7.151c.391.127.68.317.843.504a1 1 0 101.511-1.31c-.563-.649-1.413-1.076-2.354-1.253V5z" clip-rule="evenodd"/></svg>';
            html += '</div>';
            html += '<h3 class="text-3xl font-bold mb-1">₹' + kpis.totalValue.toLocaleString('en-IN', { maximumFractionDigits: 0 }) + '</h3>';
            html += '<p class="text-xs opacity-75">Updated: ' + new Date().toLocaleDateString() + '</p>';
            html += '</div>';

            // Card 2: Stock Status
            html += '<div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-orange-500">';
            html += '<p class="text-sm font-semibold text-gray-600 mb-3">Stock Status</p>';
            html += '<div class="flex justify-between items-center">';
            html += '<div class="text-center">';
            html += '<h4 class="text-2xl font-bold text-red-600">' + kpis.outOfStock + '</h4>';
            html += '<p class="text-xs text-gray-500">Out of Stock</p>';
            html += '</div>';
            html += '<div class="text-center">';
            html += '<h4 class="text-2xl font-bold text-orange-600">' + kpis.lowStock + '</h4>';
            html += '<p class="text-xs text-gray-500">Low Stock</p>';
            html += '</div>';
            html += '</div>';
            html += '</div>';

            // Card 3: Top 5 Fast-Moving Items
            html += '<div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-green-500">';
            html += '<p class="text-sm font-semibold text-gray-600 mb-3">🔥 Fast-Moving (30d)</p>';
            if (kpis.fastMoving.length > 0) {
                html += '<ul class="text-xs space-y-1">';
                kpis.fastMoving.forEach(function (item, idx) {
                    html += '<li class="truncate text-gray-700"><span class="font-bold text-gray-900">' + (idx + 1) + '.</span> ' + item.name + '</li>';
                });
                html += '</ul>';
            } else {
                html += '<p class="text-xs text-gray-400">No recent activity</p>';
            }
            html += '</div>';

            // Card 4: Slow-Moving Inventory Value
            html += '<div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-purple-500">';
            html += '<p class="text-sm font-semibold text-gray-600 mb-2">😴 Slow-Moving Value</p>';
            html += '<h3 class="text-3xl font-bold text-purple-600">₹' + kpis.slowMovingValue.toLocaleString('en-IN', { maximumFractionDigits: 0 }) + '</h3>';
            html += '<p class="text-xs text-gray-500 mt-1">No movement > 60 days</p>';
            html += '</div>';

            html += '</div>'; // End KPI cards

            // Placeholder for charts (will add in next iteration if needed)
            html += '<div class="bg-white p-6 rounded-xl shadow-lg mb-6">';
            html += '<h3 class="text-xl font-bold text-gray-800 mb-4">📈 Charts Coming Soon</h3>';
            html += '<p class="text-gray-600">Chart.js visualizations will be added in the next update:<br>';
            html += '• Stock levels by category (bar chart)<br>';
            html += '• Inventory value trend (line chart)<br>';
            html += '• Top 10 items by value (pie chart)<br>';
            html += '• Monthly consumption vs receiving (dual-axis)</p>';
            html += '</div>';

            html += '</div>'; // End container

            // Preserve existing dashboard content and prepend KPIs
            var existingContent = dashboard.innerHTML;
            // Remove alert banner temporarily if exists
            var cleanContent = existingContent.replace(/\<div class="bg-white border-l-4.*?View All Alerts<\/button>.*?<\/div><\/div>/s, '');
            dashboard.innerHTML = html + cleanContent;
        };

        // Hook into showView for dashboard
        var originalShowViewV14 = window.showView;
        window.showView = function (viewName) {
            originalShowViewV14(viewName);
            if (viewName === 'dashboard') {
                setTimeout(function () {
                    // TEMPORARILY DISABLED - will be replaced by V14.5
                    // renderEnhancedDashboard();
                    // Re-render alert banner on top
                    if (window.renderDashboardAlertBanner) {
                        renderDashboardAlertBanner();
                    }
                }, 100);
            }
        };

        console.log("ANTIGRAVITY: Feature Pack V14 Loaded. Enhanced Dashboard Active.");
    </script>

    <!-- ANTIGRAVITY FEATURE PACK V14.5: CLEAN DASHBOARD CATEGORY CARDS -->
    <script>
        console.log("ANTIGRAVITY: Loading Feature Pack V14.5 (Dashboard Category Cards Fix)...");

        // Simple, clean function to add category breakdown cards to dashboard
        window.addCategoryCardsToDashboard = function () {
            var dashboard = document.getElementById('dashboard-view');
            if (!dashboard) return;

            // Create or Select the Header Container to prevent duplication
            var headerId = 'dashboard-custom-header';
            var header = document.getElementById(headerId);

            // If it doesn't exist, create it and prepend
            if (!header) {
                header = document.createElement('div');
                header.id = headerId;
                if (dashboard.firstChild) {
                    dashboard.insertBefore(header, dashboard.firstChild);
                } else {
                    dashboard.appendChild(header);
                }
            }

            // Calculate category values
            var categories = [
                { key: 'rawMaterials', label: 'RAW MATERIALS' },
                { key: 'packingMaterials', label: 'PACKING MATERIALS' },
                { key: 'labels', label: 'LABELS' },
                { key: 'finishedGoods', label: 'FINISHED GOODS' }
            ];

            var cardsHtml = '<div class="category-breakdown-cards" style="margin-bottom: 1.5rem;">';
            cardsHtml += '<h1 style="font-size: 2.25rem; font-weight: bold; color: #111827; margin-bottom: 1.5rem;">Executive Dashboard</h1>';
            cardsHtml += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">';

            categories.forEach(function (cat) {
                var items = appState.inventory[cat.key] || [];
                var value = items.reduce(function (sum, item) {
                    try {
                        var stock = calculateStock(item, cat.key, getToday());
                        return sum + (stock.closingStock * (item.currentAverageCost || item.price || 0));
                    } catch (e) { return sum; }
                }, 0);

                cardsHtml += '<div style="background: white; padding: 1rem; border-radius: 0.5rem; border-left: 4px solid #3B82F6; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">';
                cardsHtml += '<p style="font-size: 0.75rem; font-weight: 600; color: #6B7280; margin-bottom: 0.25rem;">' + cat.label + '</p>';
                cardsHtml += '<h3 style="font-size: 1.5rem; font-weight: bold; color: #111827;">₹' + value.toLocaleString('en-IN', { maximumFractionDigits: 0 }) + '</h3>';
                cardsHtml += '</div>';
            });

            cardsHtml += '</div></div>';

            // Render into header (idempotent)
            header.innerHTML = cardsHtml;
        };

        // Hook into showView
        var originalShowViewV145 = window.showView;
        window.showView = function (viewName) {
            originalShowViewV145(viewName);
            if (viewName === 'dashboard') {
                setTimeout(function () {
                    addCategoryCardsToDashboard();
                    // Alert banner call removed to fix duplication
                }, 150);
            }
        };

        console.log("ANTIGRAVITY: Feature Pack V14.5 Loaded. Clean Category Cards Active.");
    </script>

    <!-- ANTIGRAVITY FEATURE PACK V15: ADVANCED SEARCH & FILTERS -->
    <script>
        console.log("ANTIGRAVITY: Loading Feature Pack V15 (Advanced Search & Filters)...");

        // Global filter state
        window.advancedFilters = {
            categories: [],
            stockStatus: 'all', // all, inStock, low, outOfStock, negative
            supplier: '',
            customer: '',
            dateFrom: '',
            dateTo: '',
            valueMin: '',
            valueMax: '',
            presets: JSON.parse(localStorage.getItem('filterPresets') || '[]')
        };

        // ========== FILTER PANEL RENDERING ==========
        window.renderAdvancedFilterPanel = function (containerSelector) {
            var container = document.querySelector(containerSelector);
            if (!container) return;

            var html = '<div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 mb-6">';
            html += '<div class="flex justify-between items-center mb-4">';
            html += '<h3 class="text-lg font-bold text-gray-800">🔍 Advanced Filters</h3>';
            html += '<div class="flex gap-2">';
            html += '<button onclick="window.clearAllFilters()" class="px-3 py-1 text-sm bg-gray-200 hover:bg-gray-300 rounded">Clear All</button>';
            html += '<button onclick="window.toggleFilterPanel()" class="px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700">Hide</button>';
            html += '</div></div>';

            // Filter Grid
            html += '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">';

            // Stock Status Filter
            html += '<div>';
            html += '<label class="block text-xs font-semibold text-gray-700 mb-1">Stock Status</label>';
            html += '<select id="filter-stock-status" onchange="window.updateFilter(\'stockStatus\', this.value)" class="w-full px-3 py-2 border border-gray-300 rounded text-sm">';
            html += '<option value="all">All Items</option>';
            html += '<option value="inStock">In Stock</option>';
            html += '<option value="low">Low Stock</option>';
            html += '<option value="outOfStock">Out of Stock</option>';
            html += '<option value="negative">Negative Stock</option>';
            html += '</select></div>';

            // Category Filter
            html += '<div>';
            html += '<label class="block text-xs font-semibold text-gray-700 mb-1">Category</label>';
            html += '<select id="filter-category" onchange="window.updateFilter(\'category\', this.value)" class="w-full px-3 py-2 border border-gray-300 rounded text-sm">';
            html += '<option value="">All Categories</option>';
            html += '<option value="rawMaterials">Raw Materials</option>';
            html += '<option value="packingMaterials">Packing Materials</option>';
            html += '<option value="labels">Labels</option>';
            html += '<option value="finishedGoods">Finished Goods</option>';
            html += '</select></div>';

            // Value Range
            html += '<div>';
            html += '<label class="block text-xs font-semibold text-gray-700 mb-1">Min Value (₹)</label>';
            html += '<input type="number" id="filter-value-min" oninput="window.updateFilter(\'valueMin\', this.value)" placeholder="0" class="w-full px-3 py-2 border border-gray-300 rounded text-sm">';
            html += '</div>';

            html += '<div>';
            html += '<label class="block text-xs font-semibold text-gray-700 mb-1">Max Value (₹)</label>';
            html += '<input type="number" id="filter-value-max" oninput="window.updateFilter(\'valueMax\', this.value)" placeholder="999999" class="w-full px-3 py-2 border border-gray-300 rounded text-sm">';
            html += '</div>';

            html += '</div>'; // End grid

            // Active Filter Chips
            html += '<div id="active-filter-chips" class="flex flex-wrap gap-2"></div>';

            html += '</div>'; // End filter panel

            container.innerHTML = html;
            updateFilterChips();
        };

        // ========== FILTER LOGIC ==========
        window.updateFilter = function (key, value) {
            if (key === 'category') {
                window.advancedFilters.categories = value ? [value] : [];
            } else {
                window.advancedFilters[key] = value;
            }
            updateFilterChips();
            applyAllFilters();
        };

        window.clearAllFilters = function () {
            window.advancedFilters = {
                categories: [],
                stockStatus: 'all',
                supplier: '',
                customer: '',
                dateFrom: '',
                dateTo: '',
                valueMin: '',
                valueMax: '',
                presets: window.advancedFilters.presets
            };

            // Reset UI
            var statusSelect = document.getElementById('filter-stock-status');
            var catSelect = document.getElementById('filter-category');
            var minInput = document.getElementById('filter-value-min');
            var maxInput = document.getElementById('filter-value-max');

            if (statusSelect) statusSelect.value = 'all';
            if (catSelect) catSelect.value = '';
            if (minInput) minInput.value = '';
            if (maxInput) maxInput.value = '';

            updateFilterChips();
            applyAllFilters();
        };

        window.updateFilterChips = function () {
            var container = document.getElementById('active-filter-chips');
            if (!container) return;

            var chips = [];
            var filters = window.advancedFilters;

            if (filters.stockStatus && filters.stockStatus !== 'all') {
                chips.push({ label: 'Status: ' + filters.stockStatus, key: 'stockStatus' });
            }
            if (filters.categories.length > 0) {
                chips.push({ label: 'Category: ' + filters.categories[0], key: 'category' });
            }
            if (filters.valueMin) {
                chips.push({ label: 'Min: ₹' + filters.valueMin, key: 'valueMin' });
            }
            if (filters.valueMax) {
                chips.push({ label: 'Max: ₹' + filters.valueMax, key: 'valueMax' });
            }

            if (chips.length === 0) {
                container.innerHTML = '<p class="text-xs text-gray-400 italic">No active filters</p>';
            } else {
                container.innerHTML = chips.map(function (chip) {
                    return '<span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-semibold">' +
                        chip.label + ' <button onclick="window.removeFilterChip(\'' + chip.key + '\')" class="ml-1 font-bold hover:text-blue-600">×</button></span>';
                }).join('');
            }
        };

        window.removeFilterChip = function (key) {
            if (key === 'stockStatus') window.advancedFilters.stockStatus = 'all';
            else if (key === 'category') window.advancedFilters.categories = [];
            else window.advancedFilters[key] = '';

            clearAllFilters(); // Re-sync UI
        };

        window.applyAllFilters = function () {
            // This would integrate with existing inventory rendering
            // For now, just log the active filters
            console.log('Active Filters:', window.advancedFilters);
            // Trigger re-render of current view if needed
            if (window.currentFilterCallback) {
                window.currentFilterCallback(window.advancedFilters);
            }
        };

        window.toggleFilterPanel = function () {
            var panel = document.querySelector('.bg-white.p-6.rounded-xl.shadow-lg.border');
            if (panel) {
                panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            }
        };

        console.log("ANTIGRAVITY: Feature Pack V15 Loaded. Advanced Filters Active.");
    </script>

    <!-- ANTIGRAVITY FEATURE PACK V16: AUDIT TRAIL REMOVED -->
    <script>
        console.log("ANTIGRAVITY: Feature Pack V16 (Audit Trail) REMOVED.");
        window.logAudit = function () { };
        window.renderAuditLogView = function () {
            var container = document.getElementById('audit-log-view') || document.getElementById('activity-log-view');
            if (container) container.innerHTML = '<div class="p-8 text-center text-gray-500">Activity log is disabled.</div>';
        };
    </script>

    <!-- ANTIGRAVITY FEATURE PACK V17: STOCK AGING REPORT -->
    <script>
        console.log("ANTIGRAVITY: Loading Feature Pack V17 (Stock Aging Report)...");

        // ========== STOCK AGING CALCULATION ==========
        window.calculateStockAging = function () {
            var today = new Date();
            var agingData = [];
            var categories = ['rawMaterials', 'packingMaterials', 'labels', 'finishedGoods'];

            categories.forEach(function (cat) {
                var items = appState.inventory[cat] || [];
                items.forEach(function (item) {
                    try {
                        var stock = calculateStock(item, cat, getToday());
                        if (stock.closingStock <= 0) return; // Skip out of stock

                        // Get all batches for this item
                        var batches = appState.batches.filter(function (b) {
                            return b.itemId == item.id && b.category == cat;
                        });

                        if (batches.length === 0) {
                            // No batch data, estimate based on last receive
                            var lastReceive = appState.transactions
                                .filter(function (t) { return t.itemId == item.id && t.category == cat && t.type === 'receive'; })
                                .sort(function (a, b) { return new Date(b.date) - new Date(a.date); })[0];

                            var daysInStock = lastReceive ?
                                Math.floor((today - new Date(lastReceive.date)) / (1000 * 60 * 60 * 24)) :
                                0;

                            agingData.push({
                                itemName: item.name,
                                category: cat,
                                quantity: stock.closingStock,
                                value: stock.closingStock * (item.currentAverageCost || item.price || 0),
                                daysInStock: daysInStock,
                                batchNo: '-',
                                ageCategory: getAgeCategory(daysInStock)
                            });
                        } else {
                            // Use oldest batch
                            batches.forEach(function (batch) {
                                var daysInStock = Math.floor((today - new Date(batch.date)) / (1000 * 60 * 60 * 24));
                                agingData.push({
                                    itemName: item.name,
                                    category: cat,
                                    quantity: batch.quantity || 0,
                                    value: (batch.quantity || 0) * (item.currentAverageCost || item.price || 0),
                                    daysInStock: daysInStock,
                                    batchNo: batch.batchNo || '-',
                                    ageCategory: getAgeCategory(daysInStock)
                                });
                            });
                        }
                    } catch (err) {
                        console.error('Aging calc error:', item.name, err);
                    }
                });
            });

            return agingData.sort(function (a, b) { return b.daysInStock - a.daysInStock; });
        };

        function getAgeCategory(days) {
            if (days <= 30) return '0-30 days';
            if (days <= 60) return '31-60 days';
            if (days <= 90) return '61-90 days';
            if (days <= 180) return '91-180 days';
            return '180+ days (Dead Stock)';
        }

        // ========== STOCK AGING VIEW ==========
        window.renderStockAgingView = function () {
            var container = document.getElementById('stock-aging-view');
            if (!container) {
                var viewsContainer = document.getElementById('views-container');
                if (!viewsContainer) return;

                var div = document.createElement('div');
                div.id = 'stock-aging-view';
                div.className = 'hidden p-6';
                viewsContainer.appendChild(div);
                container = div;
            }

            var agingData = calculateStockAging();

            // Group by age category
            var grouped = {};
            agingData.forEach(function (item) {
                if (!grouped[item.ageCategory]) grouped[item.ageCategory] = [];
                grouped[item.ageCategory].push(item);
            });

            var html = '<div class="max-w-7xl mx-auto">';
            html += '<div class="flex justify-between items-center mb-6">';
            html += '<h2 class="text-3xl font-bold text-gray-800">⏳ Stock Aging Report</h2>';
            html += '<button id="toggle-dead-stock" onclick="window.toggleDeadStockFilter()" class="px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 font-bold shadow-md transition">';
            html += '🔴 Show Dead Stock Only (>180 days)';
            html += '</button></div>';

            // Summary cards
            html += '<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">';
            var totalValue = agingData.reduce(function (sum, item) { return sum + item.value; }, 0);
            var deadStock = agingData.filter(function (item) { return item.daysInStock > 180; });
            var deadStockValue = deadStock.reduce(function (sum, item) { return sum + item.value; }, 0);

            html += '<div class="bg-blue-500 text-white p-6 rounded-xl shadow-lg">';
            html += '<p class="text-sm opacity-90 mb-1">Total Stock Value</p>';
            html += '<h3 class="text-3xl font-bold">₹' + totalValue.toLocaleString('en-IN', { maximumFractionDigits: 0 }) + '</h3>';
            html += '</div>';

            html += '<div class="bg-red-500 text-white p-6 rounded-xl shadow-lg">';
            html += '<p class="text-sm opacity-90 mb-1">Dead Stock (>180 days)</p>';
            html += '<h3 class="text-3xl font-bold">' + deadStock.length + ' items</h3>';
            html += '</div>';

            html += '<div class="bg-orange-500 text-white p-6 rounded-xl shadow-lg">';
            html += '<p class="text-sm opacity-90 mb-1">Dead Stock Value</p>';
            html += '<h3 class="text-3xl font-bold">₹' + deadStockValue.toLocaleString('en-IN', { maximumFractionDigits: 0 }) + '</h3>';
            html += '</div>';
            html += '</div>';

            // Aging table
            html += '<div class="bg-white rounded-lg shadow overflow-hidden">';
            html += '<div class="overflow-x-auto">';
            html += '<table class="w-full">';
            html += '<thead class="bg-gray-50 border-b border-gray-200">';
            html += '<tr>';
            html += '<th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Item Name</th>';
            html += '<th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Batch</th>';
            html += '<th class="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase">Quantity</th>';
            html += '<th class="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase">Value</th>';
            html += '<th class="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase">Days in Stock</th>';
            html += '<th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Age Category</th>';
            html += '</tr></thead><tbody>';

            agingData.slice(0, 50).forEach(function (item, idx) {
                var ageCategoryColors = {
                    '0-30 days': 'bg-green-100 text-green-800',
                    '31-60 days': 'bg-blue-100 text-blue-800',
                    '61-90 days': 'bg-yellow-100 text-yellow-800',
                    '91-180 days': 'bg-orange-100 text-orange-800',
                    '180+ days (Dead Stock)': 'bg-red-100 text-red-800'
                };

                var bgClass = idx % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                html += '<tr class="' + bgClass + ' border-b border-gray-100">';
                html += '<td class="px-4 py-3 text-sm font-medium text-gray-900">' + item.itemName + '</td>';
                html += '<td class="px-4 py-3 text-xs text-gray-600">' + item.batchNo + '</td>';
                html += '<td class="px-4 py-3 text-sm text-right text-gray-900">' + item.quantity.toLocaleString() + '</td>';
                html += '<td class="px-4 py-3 text-sm text-right font-semibold text-gray-900">₹' + item.value.toLocaleString('en-IN', { maximumFractionDigits: 0 }) + '</td>';
                html += '<td class="px-4 py-3 text-sm text-right font-bold text-gray-900">' + item.daysInStock + '</td>';
                html += '<td class="px-4 py-3"><span class="px-2 py-1 rounded text-xs font-semibold ' + ageCategoryColors[item.ageCategory] + '">' + item.ageCategory + '</span></td>';
                html += '</tr>';
            });

            html += '</tbody></table></div></div></div>';

            container.innerHTML = html;
        };

        console.log("ANTIGRAVITY: Feature Pack V17 Loaded. Stock Aging Report Active.");

        // ========== DEAD STOCK FILTER TOGGLE ==========
        window.deadStockFilterActive = false;

        window.toggleDeadStockFilter = function () {
            window.deadStockFilterActive = !window.deadStockFilterActive;
            var btn = document.getElementById('toggle-dead-stock');

            if (window.deadStockFilterActive) {
                btn.textContent = '✅ Showing Dead Stock Only - Click to Show All';
                btn.className = 'px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-bold shadow-md transition';
            } else {
                btn.textContent = '🔴 Show Dead Stock Only (>180 days)';
                btn.className = 'px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 font-bold shadow-md transition';
            }

            // Re-render with filter
            renderStockAgingView();
        };
    </script>

    <!-- ANTIGRAVITY FEATURE PACK V18: INTEGRITY FIXES & MAPPINGS -->
    <script>
        console.log("ANTIGRAVITY: Loading Feature Pack V18 (Fixes)...");

        // 1. Audit Log Removed
        window.renderAuditLogView = function () {
            var container = document.getElementById('activity-log-view');
            if (container) container.innerHTML = '<div class="p-8 text-center text-gray-500"><p>Activity log is disabled.</p></div>';
        };

        // 2. Add Hooks for View Switching
        var existingViewHook = window.showView;
        window.showView = function (viewName) {
            // Run original chain (V14.5 -> V14 -> ... -> Base)
            if (existingViewHook) existingViewHook(viewName);

            var stockView = document.getElementById('stock-aging-view');
            var auditView = document.getElementById('activity-log-view');

            if (stockView) {
                if (viewName === 'stock-aging') {
                    stockView.classList.remove('hidden');
                    stockView.style.display = 'block';
                    if (window.renderStockAgingView) window.renderStockAgingView();
                } else {
                    stockView.classList.add('hidden');
                    stockView.style.display = 'none';
                }
            }

            if (auditView) {
                auditView.classList.add('hidden');
                auditView.style.display = 'none';
            }
        };

        console.log("ANTIGRAVITY: Feature Pack V18 Loaded. Color Fixes & View Hooks Active.");
    </script>

    <!-- ANTIGRAVITY FEATURE PACK V19: QUICK BATCH ENTRY & VIEW FIXES -->
    <script>
        console.log("ANTIGRAVITY: Loading Feature Pack V19 (Quick Batch Entry)...");

        // 1. Implement Missing Batch Entry Handler
        window.handleBatchEntry = function (type, category) {
            var dateVal = document.getElementById('batch-entry-date').value;
            var text = document.getElementById('batch-entry-textarea').value;
            if (!text || !text.trim()) { alert("Please enter data in the textarea."); return; }

            if (!confirm("This will process " + (type === 'receive' ? 'RECEIVING' : 'CONSUMPTION') + " for the entered items. Continue?")) return;

            var lines = text.split('\n');
            var successCount = 0;
            var errors = [];

            lines.forEach(function (line) {
                line = line.trim();
                if (!line) return;

                // Expected Format: "Item Name Quantity"
                // We split by LAST space to separate quantity from name (which might have spaces)
                var lastSpaceIndex = line.lastIndexOf(' ');
                if (lastSpaceIndex === -1) {
                    errors.push("Invalid format (no quantity found): " + line);
                    return;
                }

                var namePart = line.substring(0, lastSpaceIndex).trim();
                var qtyPart = line.substring(lastSpaceIndex + 1).trim();
                var quantity = parseFloat(qtyPart);

                if (isNaN(quantity) || quantity <= 0) {
                    errors.push("Invalid quantity for: " + namePart);
                    return;
                }

                // Find Item (Case Insensitive Exact Match)
                var items = appState.inventory[category] || [];
                var item = items.find(function (i) { return i.name.toLowerCase() === namePart.toLowerCase(); });

                if (!item) {
                    errors.push("Item not found: " + namePart);
                    return;
                }

                // Create Transaction
                var tx = {
                    id: Date.now() + Math.random(),
                    date: dateVal ? new Date(dateVal).toISOString() : new Date().toISOString(),
                    type: type, // 'receive', 'consume'
                    category: category,
                    itemId: item.id,
                    quantity: quantity,
                    itemName: item.name, // Redundant but useful for logs
                    batchNo: 'BATCH-' + (dateVal || getToday().replace(/-/g, '')),
                    user: (appState.currentUser && appState.currentUser.username) || 'Admin',
                    details: 'Quick Batch Entry'
                };

                // Push to state
                if (!appState.transactions) appState.transactions = [];
                appState.transactions.push(tx);

                // Log to Audit if available
                if (window.logAudit) {
                    window.logAudit(type.toUpperCase(), item.name, "Batch " + type + ": " + quantity, (appState.currentUser && appState.currentUser.username) || 'System');
                }

                successCount++;
            });

            // Save and Refresh
            saveState();
            if (successCount > 0) {
                // Clear textarea if successful (or partial)
                document.getElementById('batch-entry-textarea').value = errors.length > 0 ? ("Processed " + successCount + " items.\nErrors:\n" + errors.join('\n')) : "";
                showAlert(`Successfully processed ${successCount} transactions.`);

                // Refresh View
                if (window.renderInventoryView) window.renderInventoryView(category);
            } else {
                alert("No transactions processed. Errors:\n" + errors.join('\n'));
            }
        };

        // 2. Redefine renderInventoryView to MOVE Batch Entry to Top
        window.renderInventoryView = function (category) {
            var viewId = (typeof currentView !== 'undefined' ? currentView : category.replace(/([A-Z])/g, '-$1').toLowerCase()) + '-view';
            // Fix for viewId mapping if needed
            if (category === 'rawMaterials') viewId = 'raw-materials-view';
            if (category === 'packingMaterials') viewId = 'packing-materials-view';
            if (category === 'labels') viewId = 'labels-view';
            if (category === 'finishedGoods') viewId = 'finished-goods-view';

            var container = document.getElementById(viewId);
            if (!container) return;

            var categoryName = category.replace(/([A-Z])/g, ' $1').replace(/^./, function (str) { return str.toUpperCase(); });

            // Batch Entry HTML
            var batchEntryHtml = '';
            if (category === 'rawMaterials' || category === 'packingMaterials' || category === 'labels') {
                batchEntryHtml = `
            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 mb-6 shadow-sm">
                <div class="flex justify-between items-center cursor-pointer" onclick="document.getElementById('quick-batch-content').classList.toggle('hidden')">
                     <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                        Quick Batch Entry
                     </h3>
                     <span class="text-sm text-blue-600 font-semibold hover:underline">Show/Hide</span>
                </div>
                <div id="quick-batch-content" class="mt-4">
                    <div class="flex items-center gap-4 mb-2">
                        <label for="batch-entry-date" class="text-sm font-medium">Date for All Entries:</label>
                        <input type="date" id="batch-entry-date" value="${getToday()}" class="p-2 border rounded-md">
                    </div>
                    <p class="text-xs text-gray-500 mb-2">Format: <strong>Item Name Quantity</strong> (e.g., "Acetic Acid 50") per line.</p>
                    <textarea id="batch-entry-textarea" class="w-full h-24 p-2 border rounded-md text-sm font-mono" placeholder="Item A 100\nItem B 50.5..."></textarea>
                    <div class="flex gap-4 mt-2">
                        <button onclick="handleBatchEntry('receive', '${category}')" class="flex-1 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-semibold text-sm">Record as Received</button>
                        <button onclick="handleBatchEntry('consume', '${category}')" class="flex-1 px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-semibold text-sm">Record as Consumed</button>
                    </div>
                </div>
            </div>`;
            }

            container.innerHTML = `
        <h2 class="text-3xl font-bold mb-6 text-gray-800">${categoryName} Stock Overview</h2>
        
        <!-- Quick Batch Entry (Top Placement) -->
        ${batchEntryHtml}

        <div class="bg-white p-6 rounded-lg shadow">
            <!-- Controls -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4 items-end">
                <div><label class="text-sm font-medium">Select Date:</label><input type="date" id="${category}-date-filter" value="${(typeof selectedDate !== 'undefined' ? selectedDate : getToday())}" class="w-full p-2 border rounded-md"></div>
                <div class="md:col-span-2"><label class="text-sm font-medium">Search Item:</label><input type="text" id="${category}-search-filter" placeholder="Search by name..." class="w-full p-2 border rounded-md"></div>
                <div class="flex gap-2">
                    <button onclick="openAddItemModal('${category}')" class="px-4 py-2 bg-green-600 text-white rounded-md w-full hover:bg-green-700 font-medium">Add New Item</button>
                    <button onclick="toggleReorderMode('${category}')" id="${category}-reorder-btn" class="px-4 py-2 bg-purple-600 text-white rounded-md w-full hover:bg-purple-700 font-medium">Reorder Items</button>
                </div>
            </div>
            
            <!-- Filters -->
            <div class="flex items-center space-x-4 mb-4 text-gray-600">
                <div class="flex items-center"><input type="checkbox" id="${category}-show-out-of-stock" class="h-4 w-4 rounded"><label for="${category}-show-out-of-stock" class="ml-2 text-sm">Show Out of Stock</label></div>
                <div class="flex items-center"><input type="checkbox" id="${category}-show-negative-stock" class="h-4 w-4 rounded"><label for="${category}-show-negative-stock" class="ml-2 text-sm">Show Negative</label></div>
                <div class="flex items-center"><input type="checkbox" id="${category}-show-below-min" class="h-4 w-4 rounded"><label for="${category}-show-below-min" class="ml-2 text-sm">Below Min</label></div>
            </div>
            
            <!-- Table -->
            <div class="overflow-x-auto max-h-[70vh] overflow-y-auto relative border rounded-lg">
                <table class="min-w-full bg-white">
                    <thead class="bg-gray-100 border-b sticky top-0 z-10">
                        <tr>
                            <th class="p-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">S.No</th>
                            <th class="p-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Item Name</th>
                            <th class="p-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Unit</th>
                            <th class="p-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Price</th>
                            <th class="p-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Avg Cost</th>
                            <th class="p-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Min Stock</th>
                            <th class="p-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Opening</th>
                            <th class="p-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Received</th>
                            <th class="p-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Consumed</th>
                            <th class="p-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Closing</th>
                            <th class="p-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Value</th>
                            <th class="p-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Notes</th>
                            <th class="p-3 text-center text-xs font-bold text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="${category}-table-body">
                        <!-- Content rendered by renderTableBody -->
                    </tbody>
                </table>
            </div>
        </div>`;

            // Listeners for Refreshing Table
            document.getElementById(`${category}-date-filter`).addEventListener('change', (e) => {
                if (window.selectedDate !== undefined) window.selectedDate = e.target.value;
                renderInventoryView(category);
            });
            document.getElementById(`${category}-search-filter`).addEventListener('input', () => window.renderTableBody(category));
            document.getElementById(`${category}-show-out-of-stock`).addEventListener('change', () => window.renderTableBody(category));
            document.getElementById(`${category}-show-negative-stock`).addEventListener('change', () => window.renderTableBody(category));
            document.getElementById(`${category}-show-below-min`).addEventListener('change', () => window.renderTableBody(category));

            // Initial Table Render
            if (window.renderTableBody) window.renderTableBody(category);
        };

        console.log("ANTIGRAVITY: Feature Pack V19 Loaded. Quick Batch Entry Moved & Handler Active.");
    </script>

    <!-- ANTIGRAVITY FEATURE PACK V20: RESTORATIONS & REFINEMENTS -->
    <script>
        console.log("ANTIGRAVITY: Loading Feature Pack V20 (History Restore & Fuzzy Batch)...");

        // 1. RESTORE MISSING HISTORY MODAL
        // This function was reported missing/broken. Re-implementing it to ensure Action buttons work.
        window.openItemHistoryModal = function (category, itemId) {
            var items = appState.inventory[category] || [];
            var item = items.find(i => i.id == itemId);
            if (!item) return;

            // Remove existing if any
            var existing = document.getElementById('historyModal');
            if (existing) existing.remove();

            var relatedTx = (appState.transactions || []).filter(t => t.itemId == itemId && t.category == category);
            relatedTx.sort((a, b) => new Date(b.date) - new Date(a.date));

            var html = `
        <div id="historyModal" class="modal fixed inset-0 bg-black bg-opacity-50 z-[70] flex justify-center items-center">
            <div class="bg-white p-6 rounded-lg w-full max-w-3xl max-h-[85vh] overflow-y-auto shadow-2xl">
                <div class="flex justify-between items-center mb-6 border-b pb-2">
                    <div>
                        <h2 class="text-xl font-bold text-gray-800">Stock History</h2>
                        <p class="text-sm text-gray-500">${item.name} (${item.unit})</p>
                    </div>
                    <button onclick="document.getElementById('historyModal').remove()" class="text-gray-500 hover:text-red-600 text-2xl font-bold">&times;</button>
                </div>
                
                ${relatedTx.length === 0 ? '<p class="text-center text-gray-400 py-8">No transaction history found.</p>' : `
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-100 text-gray-600 uppercase text-xs">
                            <tr>
                                <th class="p-3">Date</th>
                                <th class="p-3">Type</th>
                                <th class="p-3 text-right">Qty</th>
                                <th class="p-3">Batch No</th>
                                <th class="p-3">User</th>
                                <th class="p-3">Details</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            ${relatedTx.map(t => `
                            <tr class="hover:bg-gray-50">
                                <td class="p-3 whitespace-nowrap">${new Date(t.date).toLocaleString()}</td>
                                <td class="p-3 font-semibold uppercase ${t.type === 'receive' ? 'text-green-600' : t.type === 'consume' ? 'text-red-600' : 'text-blue-600'}">
                                    ${t.type}
                                </td>
                                <td class="p-3 text-right font-mono font-bold">${t.quantity.toFixed(3)}</td>
                                <td class="p-3 font-mono text-xs text-gray-500">${t.batchNo || '-'}</td>
                                <td class="p-3 text-xs">${t.user || 'System'}</td>
                                <td class="p-3 text-xs text-gray-500 max-w-xs truncate">${t.details || '-'}</td>
                            </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                `}
                <div class="mt-6 flex justify-end">
                    <button onclick="document.getElementById('historyModal').remove()" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded text-gray-800 font-medium">Close</button>
                </div>
            </div>
        </div>`;

            document.body.insertAdjacentHTML('beforeend', html);
        };

        // 2. UPGRADE HANDLE BATCH ENTRY (FUZZY MATCH)
        window.handleBatchEntry = function (type, category) {
            var dateVal = document.getElementById('batch-entry-date').value;
            var text = document.getElementById('batch-entry-textarea').value;
            if (!text || !text.trim()) { alert("Please enter data in the textarea."); return; }

            if (!confirm("Processing " + (type === 'receive' ? 'RECEIVE' : 'CONSUME') + " batch. Continue?")) return;

            var lines = text.split('\n');
            var successCount = 0;
            var errors = [];

            lines.forEach(function (line) {
                line = line.trim();
                if (!line) return;

                // Format: "Name Qty"
                var lastSpaceIndex = line.lastIndexOf(' ');
                if (lastSpaceIndex === -1) { errors.push("Invalid Format: " + line); return; }

                var namePart = line.substring(0, lastSpaceIndex).trim();
                var qtyPart = line.substring(lastSpaceIndex + 1).trim();
                var quantity = parseFloat(qtyPart);

                if (isNaN(quantity) || quantity <= 0) { errors.push("Invalid Qty: " + line); return; }

                // FUZZY MATCH LOGIC
                // Use existing getFuzzyMatch if available, or fallback to exact
                var item = null;
                if (window.getFuzzyMatch) {
                    var match = window.getFuzzyMatch(namePart, category);
                    if (match) item = match.item;
                } else {
                    // Fallback
                    var items = appState.inventory[category] || [];
                    item = items.find(function (i) { return i.name.toLowerCase() === namePart.toLowerCase(); });
                }

                if (!item) {
                    errors.push("Item not found (even with fuzzy match): " + namePart);
                    return;
                }

                // Transaction
                var tx = {
                    id: Date.now() + Math.random(),
                    date: dateVal ? new Date(dateVal).toISOString() : new Date().toISOString(),
                    type: type,
                    category: category,
                    itemId: item.id,
                    quantity: quantity,
                    itemName: item.name,
                    batchNo: 'BATCH-' + (dateVal || getToday().replace(/-/g, '')),
                    user: (appState.currentUser && appState.currentUser.username) || 'Admin',
                    details: 'Quick Batch: ' + namePart
                };

                if (!appState.transactions) appState.transactions = [];
                appState.transactions.push(tx);
                successCount++;
            });

            saveState();

            var msg = `Processed ${successCount} items.`;
            if (errors.length > 0) msg += `\n\nErrors:\n${errors.join('\n')}`;
            alert(msg);

            if (successCount > 0) {
                document.getElementById('batch-entry-textarea').value = errors.length > 0 ? errors.join('\n') : "";
                if (window.renderInventoryView) window.renderInventoryView(category);
            }
        };

        // 3. REDEFINE RENDER VIEW (HIDDEN DEFAULT)
        // We copy the previous V19 logic but add 'hidden' to the content div
        window.renderInventoryView = function (category) {
            var viewId = (typeof currentView !== 'undefined' ? currentView : category.replace(/([A-Z])/g, '-$1').toLowerCase()) + '-view';
            if (category === 'rawMaterials') viewId = 'raw-materials-view';
            if (category === 'packingMaterials') viewId = 'packing-materials-view';
            if (category === 'labels') viewId = 'labels-view';
            if (category === 'finishedGoods') viewId = 'finished-goods-view';

            var container = document.getElementById(viewId);
            if (!container) return;

            var categoryName = category.replace(/([A-Z])/g, ' $1').replace(/^./, function (str) { return str.toUpperCase(); });

            var batchEntryHtml = '';
            if (category === 'rawMaterials' || category === 'packingMaterials' || category === 'labels') {
                batchEntryHtml = `
            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 mb-6 shadow-sm">
                <div class="flex justify-between items-center cursor-pointer hover:bg-gray-100 p-2 rounded transition" onclick="document.getElementById('quick-batch-content').classList.toggle('hidden')">
                     <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                        Quick Batch Entry
                     </h3>
                     <span class="text-sm text-blue-600 font-semibold">Show/Hide</span>
                </div>
                <!-- ADDED HIDDEN HERE DEFAULT -->
                <div id="quick-batch-content" class="mt-4 hidden border-t pt-4"> 
                    <div class="bg-blue-50 p-3 rounded mb-3 text-xs text-blue-800">
                        <strong>Tip:</strong> You can type fuzzy names (e.g., "acetate" for "Sodium Acetate").
                    </div>
                    <div class="flex items-center gap-4 mb-2">
                        <label for="batch-entry-date" class="text-sm font-medium">Date:</label>
                        <input type="date" id="batch-entry-date" value="${getToday()}" class="p-2 border rounded-md shadow-sm">
                    </div>
                    <textarea id="batch-entry-textarea" class="w-full h-24 p-2 border rounded-md text-sm font-mono shadow-inner" placeholder="Acetic Acid 50&#10;Label 250ml 500"></textarea>
                    <div class="flex gap-4 mt-2">
                        <button onclick="handleBatchEntry('receive', '${category}')" class="flex-1 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-bold text-sm shadow">Receive Stock</button>
                        <button onclick="handleBatchEntry('consume', '${category}')" class="flex-1 px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-bold text-sm shadow">Consume Stock</button>
                    </div>
                </div>
            </div>`;
            }

            container.innerHTML = `
        <h2 class="text-3xl font-bold mb-6 text-gray-800">${categoryName} Stock Overview</h2>
        ${batchEntryHtml}
        <div class="bg-white p-6 rounded-lg shadow">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4 items-end">
                <div><label class="text-sm font-medium">Select Date:</label><input type="date" id="${category}-date-filter" value="${(typeof selectedDate !== 'undefined' ? selectedDate : getToday())}" class="w-full p-2 border rounded-md"></div>
                <div class="md:col-span-2"><label class="text-sm font-medium">Search Item:</label><input type="text" id="${category}-search-filter" placeholder="Search by name..." class="w-full p-2 border rounded-md"></div>
                <div class="flex gap-2">
                    <button onclick="openAddItemModal('${category}')" class="px-4 py-2 bg-green-600 text-white rounded-md w-full hover:bg-green-700 font-medium">Add New Item</button>
                    <button onclick="toggleReorderMode('${category}')" id="${category}-reorder-btn" class="px-4 py-2 bg-purple-600 text-white rounded-md w-full hover:bg-purple-700 font-medium">Reorder Items</button>
                </div>
            </div>
             <div class="flex items-center space-x-4 mb-4 text-gray-600">
                <div class="flex items-center"><input type="checkbox" id="${category}-show-out-of-stock" class="h-4 w-4 rounded"><label for="${category}-show-out-of-stock" class="ml-2 text-sm">Show Out of Stock</label></div>
                <div class="flex items-center"><input type="checkbox" id="${category}-show-negative-stock" class="h-4 w-4 rounded"><label for="${category}-show-negative-stock" class="ml-2 text-sm">Show Negative</label></div>
                <div class="flex items-center"><input type="checkbox" id="${category}-show-below-min" class="h-4 w-4 rounded"><label for="${category}-show-below-min" class="ml-2 text-sm">Below Min</label></div>
            </div>
            <div class="overflow-x-auto max-h-[70vh] overflow-y-auto relative border rounded-lg">
                <table class="min-w-full bg-white">
                    <thead class="bg-gray-100 border-b sticky top-0 z-10">
                        <tr>
                            <th class="p-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">S.No</th>
                            <th class="p-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Item Name</th>
                            <th class="p-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Unit</th>
                            <th class="p-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Price</th>
                            <th class="p-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Avg Cost</th>
                            <th class="p-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Min Stock</th>
                            <th class="p-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Opening</th>
                            <th class="p-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Received</th>
                            <th class="p-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Consumed</th>
                            <th class="p-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Closing (Phy)</th>
                            <th class="p-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Rsrvd (WIP)</th>
                            <th class="p-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Available</th>
                            <th class="p-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Value</th>
                            <th class="p-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Notes</th>
                            <th class="p-3 text-center text-xs font-bold text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="${category}-table-body"></tbody>
                </table>
            </div>
        </div>`;

            // Listeners
            document.getElementById(`${category}-date-filter`).addEventListener('change', (e) => { if (window.selectedDate !== undefined) window.selectedDate = e.target.value; renderInventoryView(category); });
            document.getElementById(`${category}-search-filter`).addEventListener('input', () => window.renderTableBody(category));
            document.getElementById(`${category}-show-out-of-stock`).addEventListener('change', () => window.renderTableBody(category));
            document.getElementById(`${category}-show-negative-stock`).addEventListener('change', () => window.renderTableBody(category));
            document.getElementById(`${category}-show-below-min`).addEventListener('change', () => window.renderTableBody(category));

            if (window.renderTableBody) window.renderTableBody(category);
        };

        // 4. FIX VIEW VISIBILITY (STOCK AGING WHITE SCREEN FIX)
        var existingViewHookV20 = window.showView;
        window.showView = function (viewName) {
            // Reset sorting state on view change to ensure default (insertion) order
            window.currentSortColumn = null;
            window.currentSortOrder = 'asc';

            // Run previous hooks
            if (existingViewHookV20) existingViewHookV20(viewName);

            // Explicitly fix visibility for custom views that might be hidden by default logic
            if (viewName === 'stock-aging') {
                setTimeout(function () {
                    var v = document.getElementById(viewName + '-view');
                    if (v) {
                        v.classList.remove('hidden');
                        v.style.display = 'block';
                    }
                }, 50);
            }
        };

        console.log("ANTIGRAVITY: Feature Pack V20 Loaded. All Requested Fixes Applied.");
    </script>

    <!-- ANTIGRAVITY FEATURE PACK V21: BATCH PREVIEW & FIXES -->
    <script>
        console.log("ANTIGRAVITY: Loading Feature Pack V21 (Batch Preview & Fixes)...");

        // 1. LEVENSHTEIN DISTANCE HELPER (For Robust Fuzzy Matching)
        window.levenshteinDistance = function (a, b) {
            if (!a || !b) return (a || b).length;
            const matrix = [];
            for (let i = 0; i <= b.length; i++) matrix[i] = [i];
            for (let j = 0; j <= a.length; j++) matrix[0][j] = j;
            for (let i = 1; i <= b.length; i++) {
                for (let j = 1; j <= a.length; j++) {
                    if (b.charAt(i - 1) === a.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(matrix[i - 1][j - 1] + 1, Math.min(matrix[i][j - 1] + 1, matrix[i - 1][j] + 1));
                    }
                }
            }
            return matrix[b.length][a.length];
        };

        window.findBestMatch = function (namePart, category) {
            var items = appState.inventory[category] || [];
            namePart = namePart.toLowerCase();

            // 1. Exact Match
            var exact = items.find(i => i.name.toLowerCase() === namePart);
            if (exact) return { item: exact, confidence: 'Exact', score: 100 };

            // 2. Starts With
            var start = items.find(i => i.name.toLowerCase().startsWith(namePart));
            if (start) return { item: start, confidence: 'High', score: 90 };

            // 3. Includes
            var inc = items.find(i => i.name.toLowerCase().includes(namePart));
            if (inc) return { item: inc, confidence: 'Medium', score: 70 };

            // 4. Levenshtein (Fuzzy)
            var bestItem = null;
            var minDist = Infinity;
            items.forEach(function (item) {
                var dist = window.levenshteinDistance(namePart, item.name.toLowerCase());
                if (dist < minDist) {
                    minDist = dist;
                    bestItem = item;
                }
            });

            // Threshold: Allow edits up to 50% of string length approx
            if (bestItem && minDist <= Math.max(3, namePart.length * 0.6)) {
                return { item: bestItem, confidence: minDist === 0 ? 'Exact' : 'Fuzzy', score: 100 - (minDist * 10) };
            }

            return null;
        };

        // 2. INTERACTIVE BATCH PREVIEW
        window.handleBatchEntry = function (type, category) {
            var text = document.getElementById('batch-entry-textarea').value;
            if (!text || !text.trim()) { alert("Please enter data."); return; }

            var dateVal = document.getElementById('batch-entry-date').value;
            var lines = text.split('\n').filter(l => l.trim());

            var previewData = lines.map(function (line) {
                line = line.trim();
                var lastSpace = line.lastIndexOf(' ');
                if (lastSpace === -1) return { line: line, status: 'Error', msg: 'Invalid Format', item: null };

                var namePart = line.substring(0, lastSpace).trim();
                var qtyPart = line.substring(lastSpace + 1).trim();
                var quantity = parseFloat(qtyPart);

                if (isNaN(quantity)) return { line: line, status: 'Error', msg: 'Invalid Qty', item: null };

                var match = window.findBestMatch(namePart, category);
                if (!match) return { line: line, status: 'Error', msg: 'Item Not Found', item: null };

                return {
                    line: line,
                    status: 'OK',
                    msg: match.confidence + ' Match',
                    item: match.item,
                    qty: quantity,
                    namePart: namePart
                };
            });

            // Show Modal
            window.showBatchPreviewModal(previewData, type, category, dateVal);
        };

        window.showBatchPreviewModal = function (data, type, category, dateVal) {
            var existing = document.getElementById('batchPreviewModal');
            if (existing) existing.remove();

            var html = `
        <div id="batchPreviewModal" class="modal fixed inset-0 bg-black bg-opacity-50 z-[80] flex justify-center items-center">
            <div class="bg-white p-6 rounded-lg w-full max-w-4xl max-h-[90vh] overflow-y-auto shadow-2xl">
                <h3 class="text-xl font-bold mb-4">Confirm Batch Entry (${type.toUpperCase()})</h3>
                <p class="mb-4 text-sm text-gray-600">Please review the matched items. Only "OK" rows will be processed.</p>
                
                <table class="w-full text-sm border-collapse border mb-4">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="border p-2">Original Input</th>
                            <th class="border p-2">Matched Item</th>
                            <th class="border p-2 text-right">Qty</th>
                            <th class="border p-2">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.map(d => `
                            <tr class="${d.status === 'OK' ? 'bg-green-50' : 'bg-red-50'}">
                                <td class="border p-2 font-mono text-xs">${d.line}</td>
                                <td class="border p-2 font-bold">${d.item ? d.item.name + ' (' + d.item.unit + ')' : '-'}</td>
                                <td class="border p-2 text-right">${d.qty || '-'}</td>
                                <td class="border p-2 ${d.status === 'OK' ? 'text-green-600' : 'text-red-600'} font-bold">${d.msg}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                
                <div class="flex justify-end gap-3">
                    <button onclick="document.getElementById('batchPreviewModal').remove()" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">Cancel</button>
                    <button onclick="window.executeBatchEntry()" class="px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 font-bold">Confirm & Process</button>
                </div>
            </div>
        </div>`;
            document.body.insertAdjacentHTML('beforeend', html);

            // Store data for execution
            window.pendingBatchData = { data, type, category, dateVal };
        };

        window.executeBatchEntry = function () {
            if (!window.pendingBatchData) return;
            var { data, type, category, dateVal } = window.pendingBatchData;

            var success = 0;
            data.forEach(function (d) {
                if (d.status !== 'OK') return;

                var tx = {
                    id: Date.now() + Math.random(),
                    date: dateVal ? new Date(dateVal).toISOString() : new Date().toISOString(),
                    type: type,
                    category: category,
                    itemId: d.item.id,
                    quantity: d.qty,
                    itemName: d.item.name,
                    batchNo: 'BATCH-' + (dateVal || getToday().replace(/-/g, '')),
                    user: (appState.currentUser && appState.currentUser.username) || 'Admin',
                    details: 'Batch Entry: ' + d.namePart
                };
                if (!appState.transactions) appState.transactions = [];
                appState.transactions.push(tx);
                success++;
            });

            saveState();
            document.getElementById('batchPreviewModal').remove();
            alert("Successfully processed " + success + " transactions.");
            document.getElementById('batch-entry-textarea').value = ''; // Clear
            if (window.renderInventoryView) window.renderInventoryView(category);
        };

        // 3. OVERRIDE RENDER TABLE BODY (FORCE HISTORY BUTTON)
        window.renderTableBody = function (category) {
            const tableBody = document.getElementById(`${category}-table-body`);
            if (!tableBody) return;

            const searchInput = document.getElementById(`${category}-search-filter`);
            const searchFilter = searchInput ? searchInput.value.toLowerCase() : '';
            const outOfStockCheckbox = document.getElementById(`${category}-show-out-of-stock`);
            const showOutOfStock = outOfStockCheckbox ? outOfStockCheckbox.checked : false;
            const negativeStockCheckbox = document.getElementById(`${category}-show-negative-stock`);
            const showNegativeStock = negativeStockCheckbox ? negativeStockCheckbox.checked : false;
            const belowMinCheckbox = document.getElementById(`${category}-show-below-min`);
            const showBelowMin = belowMinCheckbox ? belowMinCheckbox.checked : false;

            let items = appState.inventory[category] || [];
            let itemsWithStock = items.map(item => {
                try { return { item, ...calculateStock(item, category, window.getToday()) }; }
                catch (e) { return { item, closingStock: 0 }; }
            });

            let filtered = itemsWithStock.filter(({ item, closingStock }) => {
                if (searchFilter && !item.name.toLowerCase().includes(searchFilter)) return false;
                if (showNegativeStock && closingStock >= 0) return false;
                // Original logic from base file
                if (showOutOfStock && !showNegativeStock && closingStock !== 0) return false;
                if (showBelowMin && closingStock >= (item.minStockLevel || 0)) return false;
                return true;
            });

            if (filtered.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="13" class="text-center py-4 text-gray-500">No items found.</td></tr>`;
                return;
            }

            tableBody.innerHTML = filtered.map(({ item, openingStock, received, consumed, closingStock }, index) => {
                // Calculate Reserved & Available
                let reserved = 0;
                if (appState.activeProduction) {
                    appState.activeProduction.forEach(batch => {
                        // DEBUG: Log batch status to trace the issue
                        console.log('RESERVED DEBUG:', item.name, 'Batch:', batch.batchNo, 'Status:', batch.status, 'HasReservedData:', !!batch.reservedData);
                        // Include both 'started' AND 'paused' batches for reservation
                        if ((batch.status === 'started' || batch.status === 'paused') && batch.reservedData && batch.reservedData[category]) {
                            const resItem = batch.reservedData[category].find(i => i.itemId == item.id);
                            if (resItem) {
                                console.log('RESERVED MATCH:', item.name, 'Reserved Qty:', resItem.quantity);
                                reserved += (parseFloat(resItem.quantity) || 0);
                            }
                        }
                    });
                }
                let available = closingStock - reserved;
                const val = closingStock * (item.currentAverageCost || item.price);

                return `
            <tr id="row-${category}-${item.id}" data-item-id="${item.id}" class="hover:bg-gray-50 text-center text-sm border-b group">
                <td class="p-2 text-gray-500">${index + 1}</td>
                <td class="p-2 text-left font-medium text-gray-800">${item.name}</td>
                <td class="p-2">${item.unit}</td>
                <td class="p-2">${item.price.toFixed(2)}</td>
                <td class="p-2 font-semibold text-blue-600">₹${(item.currentAverageCost || item.price).toFixed(2)}</td>
                <td class="p-2">${(item.minStockLevel || 0).toFixed(3)}</td>
                <td class="p-2 font-bold text-gray-600 bg-gray-50">${openingStock.toFixed(3)}</td>
                <td class="p-2 text-green-600 font-medium">${received.toFixed(3)}</td>
                <td class="p-2 text-red-600 font-medium">${consumed.toFixed(3)}</td>
                <td class="p-2 font-bold text-gray-800 bg-gray-100">${closingStock.toFixed(3)}</td>
                <td class="p-2 font-bold text-orange-600 bg-orange-50">${reserved.toFixed(3)}</td>
                <td class="p-2 font-bold text-green-600 bg-green-50">${available.toFixed(3)}</td>
                <td class="p-2 text-gray-700">₹${val.toFixed(2)}</td>
                <td class="p-2">
                     <button onclick="openNotesModal('${category}', '${item.id}')" class="text-gray-400 hover:text-blue-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 8H2V6h16v2zm0 4H2v-2h16v2zm-2 4H4v-2h12v2z" clip-rule="evenodd" /></svg>
                     </button>
                </td>
                <td class="p-2 text-center">
                    <div class="flex justify-center gap-1">
                        <button onclick="openStockTxModal('${category}', '${item.id}', 'receive')" class="px-2 py-1 bg-green-600 text-white rounded hover:bg-green-700 text-xs font-bold" title="Receive">Recv</button>
                        <button onclick="openStockTxModal('${category}', '${item.id}', 'consume')" class="px-2 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-xs font-bold" title="Consume">Cons</button>
                        <!-- FORCE HISTORY BUTTON HERE -->
                        <button onclick="openItemHistoryModal('${category}', '${item.id}')" class="px-2 py-1 bg-gray-600 text-white rounded hover:bg-gray-700 text-xs font-bold shadow-sm" title="View History">History</button>
                        <button onclick="openEditItemModal('${category}', '${item.id}')" class="px-2 py-1 bg-yellow-500 text-white rounded hover:bg-yellow-600 text-xs font-bold" title="Edit">Edit</button>
                    </div>
                </td>
            </tr>`;
            }).join('');
        };

        // 4. OVERRIDE AUDIT LOG (JUMP TO ENTITY)
        window.jumpToEntity = function (ignoredCat, itemId) {
            // Search for item across categories
            var cats = ['rawMaterials', 'packingMaterials', 'labels', 'finishedGoods'];
            var foundCat = null, item = null;

            for (var c of cats) {
                var i = (appState.inventory[c] || []).find(x => x.id == itemId);
                if (i) { foundCat = c; item = i; break; }
            }

            if (foundCat) {
                // Switch View
                var viewName = foundCat === 'rawMaterials' ? 'raw-materials' :
                    foundCat === 'packingMaterials' ? 'packing-materials' :
                        foundCat === 'labels' ? 'labels' : 'finished-goods';
                window.showView(viewName);

                // Highlight Item
                setTimeout(() => {
                    var search = document.getElementById(foundCat + '-search-filter');
                    if (search) {
                        search.value = item.name;
                        if (window.renderTableBody) window.renderTableBody(foundCat);
                    }
                }, 300);
            } else {
                alert("Item not found (ID: " + itemId + "). It may have been deleted.");
            }
        };

        window.renderAuditLogView = function () {
            var container = document.getElementById('activity-log-view') || document.getElementById('audit-log-view');
            if (container) container.innerHTML = '<div class="p-8 text-center text-gray-500">Activity log is disabled.</div>';
            return; // EXIT EARLY
        };
        window.original_renderAuditLogView_V21 = function () {
            console.log("Audit log view is disabled.");
        };

        console.log("ANTIGRAVITY: Feature Pack V21 Loaded. All User Requests Implemented.");
    </script>
    <!-- ANTIGRAVITY FEATURE PACK V22: HISTORY MODAL DESIGN & ACTIONS -->
    <script>
        console.log("ANTIGRAVITY: Loading Feature Pack V22 (History Graphic Restoration)...");

        // 1. RE-IMPLEMENT HISTORY MODAL WITH REQUESTED DESIGN
        window.openItemHistoryModal = function (category, itemId) {
            var items = appState.inventory[category] || [];
            var item = items.find(i => i.id == itemId);
            if (!item) return;

            // Remove existing modal if open
            var existing = document.getElementById('historyModal');
            if (existing) existing.remove();

            var relatedTx = (appState.transactions || []).filter(t => t.itemId == itemId && t.category == category);

            // Inject WIP Reservations
            if (appState.activeProduction) {
                appState.activeProduction.forEach(batch => {
                    if ((batch.status === 'started' || batch.status === 'In Progress') && batch.reservedData && batch.reservedData[category]) {
                        const resItem = batch.reservedData[category].find(r => r.itemId == itemId);
                        if (resItem) {
                            relatedTx.push({
                                id: 'WIP-' + (batch.id || Date.now()),
                                date: batch.startDate || new Date().toISOString(),
                                type: 'wip-reservation',
                                quantity: resItem.quantity,
                                batchNo: batch.batchNumber || batch.batchNo,
                                details: `Reserved for ${batch.itemName || 'Production'} (WIP)`,
                                user: batch.user || 'System'
                            });
                        }
                    }
                });
            }

            relatedTx.sort((a, b) => new Date(b.date) - new Date(a.date));

            var html = `
        <div id="historyModal" class="modal fixed inset-0 bg-black bg-opacity-60 z-[70] flex justify-center items-center backdrop-blur-sm">
            <div class="bg-white rounded-lg w-full max-w-5xl max-h-[90vh] overflow-hidden shadow-2xl flex flex-col">
                <!-- Header -->
                <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center bg-gray-50">
                    <div>
                        <h2 class="text-xl font-bold text-gray-800">Item Transaction History</h2>
                        <p class="text-sm text-gray-500 font-medium mt-1">${item.name} <span class="text-gray-400">|</span> Unit: ${item.unit}</p>
                    </div>
                    <button onclick="document.getElementById('historyModal').remove()" class="text-gray-400 hover:text-red-500 transition text-3xl font-light">&times;</button>
                </div>
                
                <!-- Content -->
                <div class="flex-1 overflow-y-auto p-0">
                    ${relatedTx.length === 0 ?
                    '<div class="flex flex-col items-center justify-center h-64 text-gray-400"><svg class="w-12 h-12 mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><p>No valid transaction history found.</p></div>' :
                    `
                        <table class="w-full text-sm text-left border-collapse">
                            <thead class="bg-gray-100 text-gray-600 font-semibold uppercase text-xs sticky top-0 z-10 shadow-sm">
                                <tr>
                                    <th class="p-4 border-b">Date</th>
                                    <th class="p-4 border-b">Type</th>
                                    <th class="p-4 border-b text-right">Qty</th>
                                    <th class="p-4 border-b">Batch/Ref</th>
                                    <th class="p-4 border-b">Reason/Notes</th>
                                    <th class="p-4 border-b">User</th>
                                    <th class="p-4 border-b text-center">Action</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100 bg-white">
                                ${relatedTx.map(t => {
                        // Coloring logic matches user image style
                        var typeColor = t.type === 'receive' ? 'text-green-600' :
                            (t.type === 'consume' || t.type === 'production-consume') ? 'text-red-600' :
                                t.type === 'wip-reservation' ? 'text-orange-600' : 'text-blue-600';
                        var typeLabel = t.type.toUpperCase();

                        return `
                                    <tr class="hover:bg-blue-50 transition duration-150">
                                        <td class="p-4 whitespace-nowrap text-gray-700">${new Date(t.date).toLocaleDateString()}</td>
                                        <td class="p-4 font-bold text-xs ${typeColor}">${typeLabel}</td>
                                        <td class="p-4 text-right font-mono font-medium text-gray-800">${parseFloat(t.quantity).toFixed(3)}</td>
                                        <td class="p-4 font-mono text-xs text-gray-500">${t.batchNo || '-'}</td>
                                        <td class="p-4 text-gray-600 italic max-w-xs truncate" title="${t.details || t.notes || ''}">${t.details || t.notes || t.reason || '-'}</td>
                                        <td class="p-4 text-xs text-gray-500">${t.user || 'Unknown'}</td>
                                        <td class="p-4 text-center">
                                            <div class="flex justify-center gap-2">
                                                <button onclick="window.openEditTxModal('${t.id}')" 
                                                    class="px-3 py-1 border border-blue-200 text-blue-600 bg-blue-50 rounded text-xs font-semibold hover:bg-blue-100 hover:border-blue-300 transition">
                                                    Edit
                                                </button>
                                                <button onclick="window.undoTransaction('${t.id}', '${category}', '${itemId}')" 
                                                    class="px-3 py-1 border border-orange-200 text-orange-600 bg-orange-50 rounded text-xs font-semibold hover:bg-orange-100 hover:border-orange-300 transition">
                                                    Undo
                                                </button>
                                            </div>
                                        </td>
                                    </tr>`;
                    }).join('')}
                            </tbody>
                        </table>
                        `
                }
                </div>
                
                <!-- Footer -->
                <div class="px-6 py-4 bg-gray-50 border-t border-gray-200 flex justify-end">
                    <button onclick="document.getElementById('historyModal').remove()" class="px-6 py-2 bg-gray-800 text-white rounded hover:bg-gray-700 font-medium text-sm shadow">Close History</button>
                </div>
            </div>
        </div>`;

            document.body.insertAdjacentHTML('beforeend', html);
        };

        // 2. UNDO TRANSACTION LOGIC
        window.undoTransaction = function (txId, category, itemId) {
            if (!confirm("⚠️ Are you sure you want to UNDO this transaction?\n\nThis will permanently remove the record and revert the stock change.")) return;

            var idx = appState.transactions.findIndex(t => t.id == txId);
            if (idx === -1) { alert("Transaction not found. It may have already been deleted."); return; }

            // Remove
            appState.transactions.splice(idx, 1);
            saveState();

            // Refresh UI
            if (window.renderInventoryView) window.renderInventoryView(category);

            // Refresh Modal
            var modal = document.getElementById('historyModal');
            if (modal) modal.remove(); // Close old one
            setTimeout(function () {
                window.openItemHistoryModal(category, itemId); // Re-open with fresh data
            }, 50);

            window.logAudit('DELETE', 'Transaction', itemId, 'Undid transaction ' + txId);
        };

        // 3. EDIT TRANSACTION LOGIC
        window.openEditTxModal = function (txId) {
            var tx = appState.transactions.find(t => t.id == txId);
            if (!tx) return;

            // Auto-detect category if missing or incorrect
            var category = tx.category || 'rawMaterials';
            if (!appState.inventory[category]?.some(i => i.id == tx.itemId)) {
                // Try to find the correct category
                Object.keys(appState.inventory).forEach(c => {
                    if (appState.inventory[c].some(i => i.id == tx.itemId)) category = c;
                });
            }

            // Close history modal temporarily (optional, but cleaner)
            // document.getElementById('historyModal').classList.add('hidden'); 

            // Ensure Modal Exists (reuse existing HTML or inject if missing, assuming HTML exists from base file)
            var modal = document.getElementById('editTxModal');
            if (!modal) {
                // Determine if we need to inject it dynamically if missing
                alert("Edit Modal Template Missing in HTML"); return;
            }

            // FORCE HIGH Z-INDEX & CENTERING
            modal.classList.remove('hidden');
            modal.classList.add('flex'); // Ensure flex centering
            modal.style.zIndex = '9999'; // Force it above 'z-[70]' history modal
            modal.style.position = 'fixed'; // Ensure fixed positioning

            // Optional: Ensure text inputs are cleared/ready if needed, but values are set below

            document.getElementById('edit-tx-id').value = tx.id;
            document.getElementById('edit-tx-quantity').value = tx.quantity;
            document.getElementById('edit-tx-date').value = tx.date.split('T')[0];

            // Populate items (generic)
            var select = document.getElementById('edit-tx-item');
            select.innerHTML = '';
            var items = appState.inventory[category] || [];

            // Populate Select
            items.forEach(i => {
                var opt = document.createElement('option');
                opt.value = i.id;
                opt.textContent = i.name;
                if (i.id == tx.itemId) opt.selected = true;
                select.appendChild(opt);
            });

            // Show
            modal.classList.remove('hidden');
            modal.classList.add('flex'); // Centered flex

            // Attach Submit Handler safely (remove old first to avoid dupes if possible, or just overwrite onclick)
            // We will repurpose the form submit
            var form = document.getElementById('edit-tx-form');
            form.onsubmit = function (e) {
                e.preventDefault();

                var newQty = parseFloat(document.getElementById('edit-tx-quantity').value);
                var newDate = document.getElementById('edit-tx-date').value;
                var newItemId = parseFloat(document.getElementById('edit-tx-item').value); // FIX: Convert to number immediately

                // VALIDATION: Prevent saving if Item ID is invalid (NaN) - this causes the "Deletion" bug
                if (isNaN(newItemId)) {
                    alert("Please select a valid item from the list.");
                    return;
                }

                var newItem = items.find(i => i.id == newItemId);

                if (isNaN(newQty)) { alert("Invalid Quantity"); return; }

                // Store old values for logging
                var oldQty = tx.quantity;
                var oldDate = tx.date;
                var oldItemId = tx.itemId;

                // Update
                tx.quantity = newQty;
                tx.date = new Date(newDate).toISOString();
                tx.itemId = newItemId;  // Already a number now
                tx.category = category; // Ensure category is updated/set correctly
                tx.itemName = newItem ? newItem.name : tx.itemName;

                saveState();

                // Log with new context format
                logActivity('Edit Transaction', `Modified: ${tx.itemName || 'Item'}`, {
                    category: category,
                    itemId: newItemId,
                    itemName: tx.itemName,
                    oldValue: `Qty: ${oldQty}`,
                    newValue: `Qty: ${newQty}`
                });

                // Close & Refresh
                modal.classList.add('hidden');
                modal.classList.remove('flex');

                if (window.renderInventoryView) window.renderInventoryView(category);

                // Re-open history if it was open for this item
                var hist = document.getElementById('historyModal');
                if (hist) {
                    hist.remove();
                    setTimeout(() => window.openItemHistoryModal(category, newItemId), 100); // FIX: Pass numeric ID
                }
            };
        };

        // Alias for compatibility
        window.logAudit = function (action, type, id, details) {
            logActivity(action, details, { itemId: id });
        };

        console.log("ANTIGRAVITY: Feature Pack V22 Loaded. Graphic Design Updated.");
    </script>

    <!-- ANTIGRAVITY FEATURE PACK V24: PRODUCT TRACE & STOCK AGING SAFE FIX -->
    <script>
        console.log("ANTIGRAVITY: Loading Feature Pack V24...");

        // 1. SAFE UTILITIES
        window.getToday = window.getToday || function () { return new Date().toISOString().split('T')[0]; };

        window.calculateStock = window.calculateStock || function (item, category, dateLimit) {
            var opening = parseFloat(item.openingBalance) || 0;
            var totalRec = 0;
            var totalCon = 0;
            var txs = appState.transactions || [];

            var itemTxs = txs.filter(function (t) { return t.itemId == item.id && t.category == category; });
            if (dateLimit) {
                itemTxs = itemTxs.filter(function (t) { return new Date(t.date) <= new Date(dateLimit); });
            }
            itemTxs.forEach(function (t) {
                var q = parseFloat(t.quantity) || 0;
                if (t.type === 'receive') totalRec += q;
                if (t.type === 'consume' || t.type === 'dispatch') totalCon += q;
            });

            return {
                openingBalance: opening,
                totalReceived: totalRec,
                totalConsumed: totalCon,
                closingStock: opening + totalRec - totalCon
            };
        };

        // PATCH: Fix "Produced Items Not Showing" (Wrapper)
        (function () {
            var baseCalc = window.calculateStock;
            window.calculateStock = function (item, category, dateLimit) {
                var res = baseCalc(item, category, dateLimit);

                // Calculate Missing Production (production-add)
                var prodQty = 0;
                var txs = appState.transactions || [];
                if (txs.length > 0) {
                    var prodTxs = txs.filter(function (t) { return t.itemId == item.id && t.type === 'production-add'; });
                    if (dateLimit) {
                        // Ensure we match the date filtering logic (Cumulative <= Date)
                        prodTxs = prodTxs.filter(function (t) { return t.date.split('T')[0] <= dateLimit; });
                    }
                    prodTxs.forEach(function (t) { prodQty += (parseFloat(t.quantity) || 0); });
                }

                // Inject into Result
                // FIX: Double counting detected. Base function likely detects 'production-add' now.
                // if (res.totalReceived !== undefined) res.totalReceived += prodQty;
                // if (res.received !== undefined) res.received += prodQty;
                // if (res.closingStock !== undefined) res.closingStock += prodQty;

                // Dual Key Compat (Ensure Views don't break)
                if (res.openingStock === undefined) res.openingStock = (res.openingBalance !== undefined ? res.openingBalance : 0);
                if (res.received === undefined) res.received = (res.totalReceived !== undefined ? res.totalReceived : 0);
                if (res.consumed === undefined) res.consumed = (res.totalConsumed !== undefined ? res.totalConsumed : 0);

                return res;
            };
            console.log("ANTIGRAVITY: Stock Calculator Patched for Production.");
        })();

        // 2. PRODUCT TRACE LOGIC
        window.renderProductTraceView = function () {
            var container = document.getElementById('product-trace-view');
            if (container) container.innerHTML = '<div class="p-8 text-center text-gray-500">Product trace is disabled.</div>';
        };

        window.performTrace = function () {
            showAlert("Trace disabled.");
        };


        // 3. STOCK AGING LOGIC
        window.renderStockAgingView = function () {
            var container = document.getElementById('stock-aging-view');
            if (!container) return;

            var html = `
            <div class="bg-white p-6 rounded-lg shadow mb-6">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">Stock Aging Analysis</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div class="bg-green-50 p-4 rounded border border-green-200">
                        <h3 class="text-sm font-bold text-green-700">Fresh Stock (< 30 Days)</h3>
                        <p class="text-2xl font-bold" id="age-fresh-val">₹0</p>
                    </div>
                    <div class="bg-yellow-50 p-4 rounded border border-yellow-200">
                        <h3 class="text-sm font-bold text-yellow-700">Aging (30-90 Days)</h3>
                        <p class="text-2xl font-bold" id="age-aging-val">₹0</p>
                    </div>
                    <div class="bg-red-50 p-4 rounded border border-red-200">
                        <h3 class="text-sm font-bold text-red-700">Dead Stock (> 90 Days)</h3>
                        <p class="text-2xl font-bold" id="age-dead-val">₹0</p>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-100 text-gray-700 uppercase">
                            <tr>
                                <th class="p-3">Category</th>
                                <th class="p-3">Item Name</th>
                                <th class="p-3 text-right">Current Stock</th>
                                <th class="p-3 text-right">Value</th>
                                <th class="p-3 text-center">Avg Age (Days)</th>
                                <th class="p-3 text-center">Status</th>
                            </tr>
                        </thead>
                        <tbody id="aging-table-body"></tbody>
                    </table>
                </div>
            </div>
        `;
            container.innerHTML = html;

            var tbody = document.getElementById('aging-table-body');
            var totalFresh = 0, totalAging = 0, totalDead = 0;
            var rows = '';

            ['rawMaterials', 'packingMaterials', 'finishedGoods'].forEach(function (cat) {
                if (!appState.inventory[cat]) return;
                appState.inventory[cat].forEach(function (item) {
                    var stockData = window.calculateStock(item, cat);
                    if (stockData.closingStock <= 0) return;

                    // Estimate age based on last receive date or creation
                    var lastRx = new Date(); // Default to now if no history
                    var txs = appState.transactions || [];
                    var rxTxs = txs.filter(t => t.itemId == item.id && t.type === 'receive').sort((a, b) => new Date(b.date) - new Date(a.date));

                    if (rxTxs.length > 0) lastRx = new Date(rxTxs[0].date);

                    var ageDays = Math.floor((new Date() - lastRx) / (1000 * 60 * 60 * 24));
                    var valuation = stockData.closingStock * (parseFloat(item.currentAverageCost) || parseFloat(item.price) || 0);

                    var statusBadge = '';
                    if (ageDays < 30) {
                        statusBadge = '<span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs font-bold">Fresh</span>';
                        totalFresh += valuation;
                    } else if (ageDays < 90) {
                        statusBadge = '<span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded text-xs font-bold">Aging</span>';
                        totalAging += valuation;
                    } else {
                        statusBadge = '<span class="bg-red-100 text-red-800 px-2 py-1 rounded text-xs font-bold">Dead Stock</span>';
                        totalDead += valuation;
                    }

                    rows += `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="p-3 text-xs text-gray-500 uppercase">${cat}</td>
                        <td class="p-3 font-medium">${item.name}</td>
                        <td class="p-3 text-right font-mono">${stockData.closingStock.toFixed(2)} ${item.unit}</td>
                        <td class="p-3 text-right">₹${valuation.toFixed(2)}</td>
                        <td class="p-3 text-center text-gray-600">${ageDays}</td>
                        <td class="p-3 text-center">${statusBadge}</td>
                    </tr>
                `;
                });
            });

            tbody.innerHTML = rows || '<tr><td colspan="6" class="p-8 text-center text-gray-400">No stock found.</td></tr>';
            document.getElementById('age-fresh-val').textContent = '₹' + totalFresh.toFixed(0);
            document.getElementById('age-aging-val').textContent = '₹' + totalAging.toFixed(0);
            document.getElementById('age-dead-val').textContent = '₹' + totalDead.toFixed(0);
        };

        console.log("ANTIGRAVITY: Feature Pack V24 Loaded.");
    </script>



    <!-- ANTIGRAVITY FEATURE PACK V25: NAVIGATION & LOGIC PATCH -->
    <script>
        console.log("ANTIGRAVITY: Loading Feature Pack V25 (Patch)...");

        // 1. NAVIGATION HOOK (FIX FOR WHITE SCREENS)
        // We override showView to ensure our new views actually render when clicked


        // 2. REFINED STOCK AGING LOGIC (Using Last Activity)
        window.renderStockAgingView = function () {
            var container = document.getElementById('stock-aging-view');
            if (!container) return;

            var html = `
            <div class="bg-white p-6 rounded-lg shadow mb-6">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">Stock Aging Analysis</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div class="bg-green-50 p-4 rounded border border-green-200">
                        <h3 class="text-sm font-bold text-green-700">Active Stock (< 30 Days)</h3>
                        <p class="text-2xl font-bold" id="age-fresh-val">₹0</p>
                    </div>
                    <div class="bg-yellow-50 p-4 rounded border border-yellow-200">
                        <h3 class="text-sm font-bold text-yellow-700">Aging (30-90 Days)</h3>
                        <p class="text-2xl font-bold" id="age-aging-val">₹0</p>
                    </div>
                    <div class="bg-red-50 p-4 rounded border border-red-200">
                        <h3 class="text-sm font-bold text-red-700">Dead Stock (> 90 Days)</h3>
                        <p class="text-2xl font-bold" id="age-dead-val">₹0</p>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-100 text-gray-700 uppercase">
                            <tr>
                                <th class="p-3">Category</th>
                                <th class="p-3">Item Name</th>
                                <th class="p-3 text-right">Current Stock</th>
                                <th class="p-3 text-right">Activity</th>
                                <th class="p-3 text-center">Inactivity (Days)</th>
                                <th class="p-3 text-center">Status</th>
                            </tr>
                        </thead>
                        <tbody id="aging-table-body"></tbody>
                    </table>
                </div>
            </div>
        `;
            container.innerHTML = html;

            var tbody = document.getElementById('aging-table-body');
            var totalFresh = 0, totalAging = 0, totalDead = 0;
            var rows = '';

            ['rawMaterials', 'packingMaterials', 'finishedGoods'].forEach(function (cat) {
                if (!appState.inventory[cat]) return;
                appState.inventory[cat].forEach(function (item) {
                    var stockData = window.calculateStock(item, cat);
                    if (stockData.closingStock <= 0) return;

                    // LOGIC UPDATE: Use Last Activity (Receive OR Usage)
                    var lastActivity = new Date(item.openingStockDate || new Date());
                    var txs = appState.transactions || [];
                    // Find ANY transaction for this item (Receive, Consume, etc)
                    var itemTxs = txs.filter(t => t.itemId == item.id).sort((a, b) => new Date(b.date) - new Date(a.date));

                    if (itemTxs.length > 0) {
                        lastActivity = new Date(itemTxs[0].date);
                    }

                    var daysSinceActivity = Math.floor((new Date() - lastActivity) / (1000 * 60 * 60 * 24));
                    var valuation = stockData.closingStock * (parseFloat(item.currentAverageCost) || parseFloat(item.price) || 0);

                    var statusBadge = '';
                    if (daysSinceActivity < 30) {
                        statusBadge = '<span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs font-bold">Active</span>';
                        totalFresh += valuation;
                    } else if (daysSinceActivity < 90) {
                        statusBadge = '<span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded text-xs font-bold">Aging</span>';
                        totalAging += valuation;
                    } else {
                        statusBadge = '<span class="bg-red-100 text-red-800 px-2 py-1 rounded text-xs font-bold">Dead Stock</span>';
                        totalDead += valuation;
                    }

                    rows += `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="p-3 text-xs text-gray-500 uppercase">${cat}</td>
                        <td class="p-3 font-medium">${item.name}</td>
                        <td class="p-3 text-right font-mono">${stockData.closingStock.toFixed(2)} ${item.unit}</td>
                        <td class="p-3 text-right text-xs text-gray-500">${lastActivity.toISOString().split('T')[0]}</td>
                        <td class="p-3 text-center text-gray-600">${daysSinceActivity}</td>
                        <td class="p-3 text-center">${statusBadge}</td>
                    </tr>
                `;
                });
            });

            tbody.innerHTML = rows || '<tr><td colspan="6" class="p-8 text-center text-gray-400">No stock found.</td></tr>';
            document.getElementById('age-fresh-val').textContent = '₹' + totalFresh.toFixed(0);
            document.getElementById('age-aging-val').textContent = '₹' + totalAging.toFixed(0);
            document.getElementById('age-dead-val').textContent = '₹' + totalDead.toFixed(0);
        };

        console.log("ANTIGRAVITY: Feature Pack V25 Patch Applied.");
    </script>

    <!-- ANTIGRAVITY FEATURE PACK V27: SYNTAX FIX & TRACE REPAIR -->
    <script>
        console.log("ANTIGRAVITY: Loading Feature Pack V27 (Fixing V26 Collision)...");

        try {
            // 1. XSS FIX (Sanitize Helper)
            window.escapeHtml = function (text) {
                if (!text) return text;
                var map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
                return text.toString().replace(/[&<>"']/g, function (m) { return map[m]; });
            };

            // Override Batch Preview Modal (V21) with XSS Protection
            if (window.showBatchPreviewModal) {
                window.showBatchPreviewModal = function (data, type, category, dateVal) {
                    var existing = document.getElementById('batchPreviewModal');
                    if (existing) existing.remove();

                    var html = `
                <div id="batchPreviewModal" class="modal fixed inset-0 bg-black bg-opacity-50 z-[80] flex justify-center items-center">
                    <div class="bg-white p-6 rounded-lg w-full max-w-4xl max-h-[90vh] overflow-y-auto shadow-2xl">
                        <h3 class="text-xl font-bold mb-4">Confirm Batch Entry (${type.toUpperCase()})</h3>
                        <p class="mb-4 text-sm text-gray-600">Please review the matched items. Only "OK" rows will be processed.</p>
                        
                        <table class="w-full text-sm border-collapse border mb-4">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="border p-2">Original Input</th>
                                    <th class="border p-2">Matched Item</th>
                                    <th class="border p-2 text-right">Qty</th>
                                    <th class="border p-2">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.map(d => `
                                    <tr class="${d.status === 'OK' ? 'bg-green-50' : 'bg-red-50'}">
                                        <td class="border p-2 font-mono text-xs">${window.escapeHtml(d.line)}</td>
                                        <td class="border p-2 font-bold">${d.item ? window.escapeHtml(d.item.name) + ' (' + window.escapeHtml(d.item.unit) + ')' : '-'}</td>
                                        <td class="border p-2 text-right">${d.qty || '-'}</td>
                                        <td class="border p-2 ${d.status === 'OK' ? 'text-green-600' : 'text-red-600'} font-bold">${d.msg}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        
                        <div class="flex justify-end gap-3">
                            <button onclick="document.getElementById('batchPreviewModal').remove()" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">Cancel</button>
                            <button onclick="window.executeBatchEntry()" class="px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 font-bold">Confirm & Process</button>
                        </div>
                    </div>
                </div>`;
                    document.body.insertAdjacentHTML('beforeend', html);
                    window.pendingBatchData = { data, type, category, dateVal };
                };
            }

            // 2. PERFORMANCE FIX (Stock Cache)
            window.stockCache = new Map();
            window.isCacheValid = false;

            // Use a unique name to avoid 'Identifier already declared' SyntaxError
            window.realCalcStockFn = window.calculateStock;

            if (window.realCalcStockFn) {
                window.calculateStock = function (item, category, dateLimit) {
                    // Dynamic dates bypass cache
                    if (dateLimit) return window.realCalcStockFn(item, category, dateLimit);

                    var key = item.id + '|' + category;
                    if (window.isCacheValid && window.stockCache.has(key)) {
                        return window.stockCache.get(key);
                    }

                    var result = window.realCalcStockFn(item, category, null);
                    // Update cache
                    window.stockCache.set(key, result);
                    return result;
                };
            }

            // Hook Cache Invalidation
            window.realSaveStateFn = window.saveState;
            window.saveState = function () {
                window.stockCache.clear();
                window.isCacheValid = false;
                if (window.realSaveStateFn) window.realSaveStateFn();
            };

            // Cache Validation Hook
            window.realExecBatchFn = window.executeBatchEntry;
            if (window.realExecBatchFn) {
                window.executeBatchEntry = function () {
                    window.stockCache.clear();
                    window.realExecBatchFn();
                };
            }

            // 3. PRODUCT TRACE FIX (Ensure it reads fresh data)
            window.performTrace = function (optQuery) {
                var input = document.getElementById('trace-search-input');
                if (optQuery && input) {
                    input.value = optQuery;
                }

                var query = input ? input.value.toLowerCase().trim() : '';
                var resultsDiv = document.getElementById('trace-results');

                // Force cache clear before trace to ensure we see latest moves
                window.stockCache.clear();

                if (!query) { if (resultsDiv) resultsDiv.innerHTML = '<p class="text-gray-500 text-center">Please enter a search term.</p>'; return; }

                var txs = appState.transactions || [];

                // IMPROVED SEARCH: Check details field too
                var matches = txs.filter(function (t) {
                    return (t.itemId && t.itemId.toLowerCase().includes(query)) ||
                        (t.itemName && t.itemName.toLowerCase().includes(query)) ||
                        (t.batchNo && t.batchNo.toLowerCase().includes(query)) ||
                        (t.id && t.id.toString().toLowerCase().includes(query)) ||
                        (t.details && t.details.toLowerCase().includes(query));
                });

                if (matches.length === 0) {
                    resultsDiv.innerHTML = '<div class="p-8 text-center text-gray-400 bg-white rounded shadow">No transactions found matching "' + window.escapeHtml(query) + '".</div>';
                    return;
                }

                var sortedMatches = matches.slice().sort(function (a, b) {
                    return new Date(b.date) - new Date(a.date);
                });

                var html = '<div class="bg-white rounded-lg shadow overflow-hidden"><table class="w-full text-sm text-left">';
                html += '<thead class="bg-gray-50 text-gray-700"><tr><th class="p-3">Date</th><th class="p-3">Type</th><th class="p-3">Item</th><th class="p-3">Batch/Details</th><th class="p-3 text-right">Qty</th><th class="p-3">User</th></tr></thead><tbody>';

                sortedMatches.forEach(function (t) {
                    var color = t.type === 'receive' ? 'text-green-600' :
                        t.type === 'consume' ? 'text-red-600' :
                            t.type === 'dispatch' ? 'text-purple-600' : 'text-blue-600';

                    html += '<tr class="border-b hover:bg-gray-50">';
                    html += '<td class="p-3">' + t.date.split('T')[0] + '</td>';
                    html += '<td class="p-3 uppercase font-bold ' + color + '">' + t.type + '</td>';
                    html += '<td class="p-3 font-medium">' + window.escapeHtml(t.itemName || 'N/A') + '</td>';
                    html += '<td class="p-3 font-mono text-xs text-gray-600">' + window.escapeHtml(t.batchNo || t.details || '-') + '</td>';
                    html += '<td class="p-3 text-right font-bold">' + parseFloat(t.quantity).toFixed(3) + '</td>';
                    html += '<td class="p-3 text-gray-500">' + window.escapeHtml(t.user || 'System') + '</td>';
                    html += '</tr>';
                });

                html += '</tbody></table></div>';
                resultsDiv.innerHTML = html;
            };

            // ALIAS FOR SEARCH NAVIGATION
            window.openProductTrace = window.performTrace;

            // Enable cache after first clear
            setTimeout(() => { window.isCacheValid = true; }, 1000);

            console.log("ANTIGRAVITY: Feature Pack V27 Loaded. Variable Collision & Trace Repaired.");

        } catch (e) {
            console.error("ANTIGRAVITY V27 CRITICAL FAILURE:", e);
        }
    </script>
    <!-- ANTIGRAVITY FEATURE PACK V29: FULL PRODUCT TRACEABILITY DASHBOARD -->
    <script>
        console.log("ANTIGRAVITY: Loading Feature Pack V29 (Restoring Dashboard Trace)...");

        // 1. UTILITY: SAFE HTML (Keep V26 fix)
        window.escapeHtml = function (text) {
            if (!text) return text;
            var map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
            return text.toString().replace(/[&<>"']/g, function (m) { return map[m]; });
        };

        // 2. RESTORE: OPEN PRODUCT TRACE (DISABLED)
        window.openProductTrace = function (productId) {
            showAlert("Traceability is disabled.");
        };

        // 3. RESTORE: RENDER TRACE DASHBOARD (DISABLED)
        window.renderProductTraceView = function (item) {
            const container = document.getElementById('product-trace-view');
            if (container) container.innerHTML = '<div class="p-8 text-center text-gray-500">Traceability dashboard is disabled.</div>';
        };

        console.log("ANTIGRAVITY: Feature Pack V29 Loaded. Traceability logic removed.");
    </script>
    <!-- ANTIGRAVITY FEATURE PACK V30: EXACT UI RESTORATION (PDF, INGREDIENTS, LABELS) -->
    <script>
        console.log("ANTIGRAVITY: Loading Feature Pack V30 (Exact UI Restoration)...");

        // 1. UTILITY: SAFE HTML
        window.escapeHtml = function (text) {
            if (!text) return text;
            var map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
            return text.toString().replace(/[&<>"']/g, function (m) { return map[m]; });
        };

        // 2. OPEN PRODUCT TRACE
        window.openProductTrace = function (productId) {
            if (!window.checkPermission || !checkPermission()) return;
            const id = parseFloat(productId);
            const item = findItem('finishedGoods', id);
            if (!item) {
                showAlert("Product not found or not a Finished Good.");
                return;
            }
            showView('product-trace');
            window.renderProductTraceView(item);
        };

        // 3. RENDER TRACE DASHBOARD
        window.renderProductTraceView = function (item) {
            if (window.original_renderProductTraceView_V30) {
                window.original_renderProductTraceView_V30(item);
            } else {
                const container = document.getElementById('product-trace-view');
                if (container) container.innerHTML = '<div class="p-8 text-center text-gray-500">Traceability dashboard loading...</div>';
            }
        };

        window.original_renderProductTraceView_V30 = function (item) {
            const container = document.getElementById('product-trace-view');
            if (!container) return;

            if (window.stockCache) window.stockCache.clear();

            const stockFn = window.realCalcStockFn || window.calculateStock;
            const stock = stockFn ? stockFn(item, 'finishedGoods') : { closingStock: 0 };

            const txs = appState.transactions || [];

            // Match Image 1 Labels: "Total Produced", "Total Dispatched"
            const totalProduced = txs
                .filter(t => t.itemId == item.id && ['production-add', 'receive'].includes(t.type))
                .reduce((acc, t) => acc + (parseFloat(t.quantity) || 0), 0);

            const totalDispatched = txs
                .filter(t => t.itemId == item.id && ['dispatch', 'consume'].includes(t.type))
                .reduce((acc, t) => acc + (parseFloat(t.quantity) || 0), 0);

            const batchMap = new Map();

            txs.filter(t => t.itemId == item.id)
                .forEach(t => {
                    const batchKey = t.batchNo || 'OPENING_STOCK';

                    if (!batchMap.has(batchKey)) {
                        batchMap.set(batchKey, {
                            id: batchKey,
                            mfg: batchKey === 'OPENING_STOCK' ? 'N/A' : 'N/A',
                            exp: 'N/A',
                            produced: batchKey === 'OPENING_STOCK' ? (parseFloat(item.openingStock) || 0) : 0,
                            balance: batchKey === 'OPENING_STOCK' ? (parseFloat(item.openingStock) || 0) : 0,
                            firstDate: batchKey === 'OPENING_STOCK' ? (item.openingStockDate || t.date) : t.date
                        });
                    }
                    const batch = batchMap.get(batchKey);

                    if (['production-add', 'receive', 'stock-take-adj-in'].includes(t.type)) {
                        if (batchKey !== 'OPENING_STOCK') batch.produced += (parseFloat(t.quantity) || 0);
                        batch.balance += (parseFloat(t.quantity) || 0);
                        if (t.mfgDate) batch.mfg = t.mfgDate;
                        if (t.expDate || t.expiryDate) batch.exp = t.expDate || t.expiryDate;
                    } else if (['dispatch', 'consume', 'stock-take-adj-out', 'production-consume'].includes(t.type)) {
                        batch.balance -= (parseFloat(t.quantity) || 0);
                    }
                });

            const batches = Array.from(batchMap.values()).sort((a, b) => new Date(b.firstDate || new Date()) - new Date(a.firstDate || new Date()));

            container.innerHTML = `
            <div class="h-full flex flex-col">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center gap-4">
                        <button onclick="window.showView('finishedGoods')" class="text-gray-500 hover:text-gray-800 flex items-center font-medium">
                            <span class="text-xl mr-1">←</span> Back to List
                        </button>
                        <h2 class="text-3xl font-bold flex items-center gap-2">
                            Traceability: <span class="text-blue-600">${item.name}</span>
                        </h2>
                        <button id="btn-trace-pdf" onclick="window.generateTraceabilityPDF ? window.generateTraceabilityPDF('${item.id}') : alert('PDF feature loading...')" class="ml-4 px-4 py-2 bg-red-600 hover:bg-red-700 text-white text-sm font-bold rounded shadow flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                            Download PDF Report
                        </button>
                    </div>
                    <div class="text-sm font-mono text-gray-500">Product ID: ${item.id}</div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-blue-50 p-6 rounded color-fix-blue text-center">
                        <h3 class="font-bold text-blue-800 mb-1">Current Stock</h3>
                        <p class="text-3xl font-bold text-blue-900">${(stock.closingStock || 0).toFixed(3)} <span class="text-sm text-blue-600">${item.unit}</span></p>
                    </div>
                     <div class="bg-green-50 p-6 rounded color-fix-green text-center">
                        <h3 class="font-bold text-green-800 mb-1">Total Produced</h3>
                        <p class="text-3xl font-bold text-green-900">${totalProduced.toFixed(3)}</p>
                    </div>
                    <div class="bg-purple-50 p-6 rounded color-fix-purple text-center">
                        <h3 class="font-bold text-purple-800 mb-1">Total Dispatched</h3>
                        <p class="text-3xl font-bold text-purple-900">${totalDispatched.toFixed(3)}</p>
                    </div>
                </div>

                <div class="flex flex-col md:flex-row gap-6">
                    <div class="w-full md:w-1/3 bg-white rounded-lg shadow overflow-hidden flex flex-col max-h-[600px]">
                        <div class="p-4 bg-gray-50 border-b">
                            <h3 class="font-bold text-lg">Batch Timeline</h3>
                        </div>
                        <div class="overflow-y-auto flex-1">
                            <table class="min-w-full text-sm">
                                <thead class="bg-white sticky top-0 z-10 shadow-sm">
                                    <tr>
                                        <th class="p-3 text-left">Batch ID</th>
                                        <th class="p-3 text-right">Balance</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${batches.map(b => `
                                        <tr class="hover:bg-blue-50 cursor-pointer border-b transition-colors" onclick="window.renderBatchTraceDetails('${item.id}', '${b.id}')">
                                            <td class="p-3">
                                                <div class="font-bold font-mono text-blue-600">${b.id}</div>
                                            </td>
                                            <td class="p-3 text-right font-bold ${b.balance > 0 ? 'text-green-600' : 'text-gray-400'}">${b.balance.toFixed(3)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="w-full md:w-2/3 bg-white rounded-lg shadow overflow-hidden flex flex-col min-h-[400px]" id="batch-trace-detail-container">
                        <div class="flex flex-col items-center justify-center h-full text-gray-400 p-10">
                            <p class="text-lg font-medium">Select a batch from the timeline to view details.</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
        };

        window.renderBatchTraceDetails = function (itemIdStr, batchId) {
            const container = document.getElementById('batch-trace-detail-container');
            const txs = appState.transactions || [];

            const batchTxs = txs.filter(t => t.itemId == itemIdStr && (t.batchNo === batchId || (batchId === 'OPENING_STOCK' && !t.batchNo)));

            const productionTxs = batchTxs.filter(t => ['production-add', 'receive', 'stock-take-adj-in'].includes(t.type));
            const dispatchTxs = batchTxs.filter(t => ['dispatch', 'consume', 'stock-take-adj-out'].includes(t.type));

            const consumptionTxs = txs.filter(t =>
                (t.type === 'production-consume' || t.type === 'consume') &&
                (t.relatedBatchId === batchId || t.fgBatchId === batchId)
            );

            container.innerHTML = `
            <div class="h-full flex flex-col bg-gray-50">
                <div class="p-4 bg-white border-b shadow-sm flex justify-between items-center">
                    <h3 class="font-bold text-xl text-gray-800">Batch Details: <span class="text-blue-600 font-mono">${batchId}</span></h3>
                </div>
                
                <div class="flex-1 overflow-y-auto p-6 space-y-6">
                    <div class="bg-white rounded-lg shadow p-4 border-l-4 border-green-500">
                         <h4 class="font-bold text-gray-700 mb-3">Production / Receipt</h4>
                         <table class="min-w-full text-sm">
                            <thead class="bg-gray-50"><tr><th class="p-2 text-left">Date</th><th class="p-2 text-right">Qty</th></tr></thead>
                            <tbody>
                                ${productionTxs.length ? productionTxs.map(t => `
                                    <tr class="border-b">
                                        <td class="p-2">${t.date.split('T')[0]}</td>
                                        <td class="p-2 text-right font-bold text-green-600">+${parseFloat(t.quantity).toFixed(3)}</td>
                                    </tr>
                                `).join('') : '<tr><td colspan="2" class="p-2 text-gray-400 italic">No record.</td></tr>'}
                            </tbody>
                         </table>
                    </div>

                    <div class="bg-white rounded-lg shadow p-4 border-l-4 border-yellow-500">
                         <h4 class="font-bold text-gray-700 mb-3">Material Used</h4>
                         ${consumptionTxs.length === 0 ?
                    `<div class="p-2 text-gray-400">No linked materials.</div>` :
                    `<table class="min-w-full text-sm">
                                <thead class="bg-gray-50"><tr><th class="p-2 text-left">Item</th><th class="p-2 text-right">Qty</th></tr></thead>
                                <tbody>
                                    ${consumptionTxs.map(t => {
                        const item = findItem(t.category, t.itemId) || { name: 'Unknown' };
                        return `<tr class="border-b"><td class="p-2">${item.name}</td><td class="p-2 text-right font-bold">${t.quantity}</td></tr>`;
                    }).join('')}
                                </tbody>
                            </table>`
                }
                    </div>

                    <div class="bg-white rounded-lg shadow p-4 border-l-4 border-purple-500">
                         <h4 class="font-bold text-gray-700 mb-3">Dispatched To</h4>
                         <table class="min-w-full text-sm">
                            <thead class="bg-gray-100"><tr><th class="p-2 text-left">Date</th><th class="p-2 text-left">Customer</th><th class="p-2 text-right">Qty</th></tr></thead>
                            <tbody>
                                ${dispatchTxs.length ? dispatchTxs.map(t => `<tr class="border-b"><td class="p-2">${t.date.split('T')[0]}</td><td class="p-2">${t.customerName || 'Internal'}</td><td class="p-2 text-right">-${t.quantity}</td></tr>`).join('') : '<tr><td colspan="3" class="p-2 text-gray-400 italic">No usage.</td></tr>'}
                            </tbody>
                         </table>
                    </div>
                </div>
            </div>
        `;
        };

        console.log("ANTIGRAVITY: Feature Pack V30 Loaded. Exact UI Restored.");
    </script>

    <script>
        // ================================================================
        // FEATURE PACK V31: FETCH COST & TABLE ALIGNMENT FIX
        // ================================================================
        console.log("ANTIGRAVITY: Loading Feature Pack V31 (Fixes)...");

        // 1. Logic for Calculating Cost from Formula
        window.calculateItemCost = function (itemId) {
            const finishedGood = appState.inventory.finishedGoods.find(i => i.id == itemId);
            if (!finishedGood) return;

            const formula = (appState.formulas || []).find(f => f.name === finishedGood.name);

            if (!formula) {
                if (confirm(`Formula for "${finishedGood.name}" not found in Formulation section.\n\nDo you want to create a new formula now?`)) {
                    showView('formulas');
                }
                return;
            }

            let totalCost = 0;
            const calculateComponentCost = (list, cat) => {
                (list || []).forEach(comp => {
                    const item = appState.inventory[cat].find(i => i.id == comp.itemId);
                    if (item) {
                        const cost = (parseFloat(item.currentAverageCost) || parseFloat(item.price) || 0) * comp.quantity;
                        totalCost += cost;
                    }
                });
            };

            calculateComponentCost(formula.ingredients, 'rawMaterials');
            calculateComponentCost(formula.packingMaterials, 'packingMaterials');
            calculateComponentCost(formula.labels, 'labels');

            const perUnitCost = totalCost / (formula.outputQty || 1);

            const message = `Calculated Cost Breakdown for ${formula.outputQty} ${formula.outputUnit}:\n` +
                `Total Batch Cost: ₹${totalCost.toFixed(2)}\n` +
                `COST PER UNIT: ₹${perUnitCost.toFixed(2)}\n\n` +
                `Current System Cost: ₹${(finishedGood.currentAverageCost || 0).toFixed(2)}\n` +
                `Update item cost?`;

            if (confirm(message)) {
                finishedGood.currentAverageCost = parseFloat(perUnitCost);
                if (!finishedGood.price || finishedGood.price == 0) {
                    finishedGood.price = parseFloat((perUnitCost * 1.2).toFixed(2));
                }
                saveState();
                renderInventoryView('finishedGoods');
                if (window.showAlert) showAlert("Item Cost Updated!"); else alert("Item Cost Updated!");
            }
        };

        // 2. Helper: Get Reserved Stock (Needed for correct table view)
        window.getReservedStock = function (item, category) {
            if (!appState.activeProduction) return 0;
            let reserved = 0;
            appState.activeProduction.forEach(batch => {
                const status = (batch.status || '').toLowerCase();
                if ((status === 'started' || status === 'in progress' || status === 'paused') && batch.reservedData && batch.reservedData[category]) {
                    const resItem = batch.reservedData[category].find(r => r.itemId == item.id);
                    if (resItem) reserved += resItem.quantity;
                }
            });
            return reserved;
        };

        // 3. Override Render View (Correct Header with 15 Columns)
        window.renderInventoryView = function (category) {
            const viewId = currentView + '-view';
            const container = document.getElementById(viewId);
            const categoryName = category.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());

            let batchEntryHtml = '';
            if (category === 'rawMaterials' || category === 'packingMaterials' || category === 'labels') {
                batchEntryHtml = `
    <div class="mt-8 pt-6 border-t">
        <h3 class="text-xl font-bold mb-4">Quick Batch Entry</h3>
        <div class="flex items-center gap-4 mb-2">
            <label class="text-sm font-medium">Date:</label>
            <input type="date" id="batch-entry-date" value="${selectedDate}" class="p-2 border rounded-md">
        </div>
        <textarea id="batch-entry-textarea" class="w-full h-32 p-2 border rounded-md" placeholder="Format: ItemName Quantity"></textarea>
        <div class="flex gap-4 mt-2">
            <button onclick="handleBatchEntry('receive', '${category}')" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg">Record Received</button>
            <button onclick="handleBatchEntry('consume', '${category}')" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg">Record Consumed</button>
        </div>
    </div>`;
            }

            container.innerHTML = `
    <h2 class="text-3xl font-bold mb-6">${categoryName} Stock Overview</h2>
    <div class="bg-white p-6 rounded-lg shadow">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4 items-end">
            <div><label class="text-sm font-medium">Select Date:</label><input type="date" id="${category}-date-filter" value="${selectedDate}" class="w-full p-2 border rounded-md"></div>
            <div class="md:col-span-2"><label class="text-sm font-medium">Search Item:</label><input type="text" id="${category}-search-filter" placeholder="Search by name..." class="w-full p-2 border rounded-md"></div>
            <div class="flex gap-2">
                <button onclick="openAddItemModal('${category}')" class="px-4 py-2 bg-green-600 text-white rounded-md w-full">Add New Item</button>
                <button onclick="toggleReorderMode('${category}')" id="${category}-reorder-btn" class="px-4 py-2 ${isReorderMode ? 'bg-green-600' : 'bg-purple-600'} text-white rounded-md w-full">${isReorderMode ? 'Done Reordering' : 'Reorder Items'}</button>
            </div>
        </div>
        <div class="flex items-center space-x-4 mb-4">
            <div class="flex items-center"><input type="checkbox" id="${category}-show-out-of-stock" class="h-4 w-4"><label class="ml-2 text-sm">Show Out of Stock</label></div>
            <div class="flex items-center"><input type="checkbox" id="${category}-show-negative-stock" class="h-4 w-4"><label class="ml-2 text-sm">Show Negative Stock</label></div>
            <div class="flex items-center"><input type="checkbox" id="${category}-show-below-min" class="h-4 w-4"><label class="ml-2 text-sm">Show Below Min</label></div>
        </div>
        <div class="overflow-x-auto max-h-[70vh] overflow-y-auto relative">
            <table class="min-w-full bg-white border">
                <thead class="bg-gray-200 sticky top-0 z-10 shadow-sm">
                    <tr>
                        <th class="p-2 border-b">S.No</th>
                        <th class="p-2 border-b text-left">Item Name</th>
                        <th class="p-2 border-b">Unit</th>
                        <th class="p-2 border-b">Price</th>
                        <th class="p-2 border-b">Avg Cost</th>
                        <th class="p-2 border-b">Min Stock</th>
                        <th class="p-2 border-b">Opening</th>
                        <th class="p-2 border-b">Received</th>
                        <th class="p-2 border-b">Consumed</th>
                        <th class="p-2 border-b">Closing (Phy)</th>
                        <th class="p-2 border-b text-center text-xs w-16">Rsrvd (WIP)</th>
                        <th class="p-2 border-b">Available</th>
                        <th class="p-2 border-b">Value</th>
                        <th class="p-2 border-b">Notes</th>
                        <th class="p-2 border-b">Actions</th>
                    </tr>
                </thead>
                <tbody id="${category}-table-body"></tbody>
            </table>
        </div>
        ${batchEntryHtml}
    </div>`;

            // Check if handlers exist to avoid duplicates or re-attach safely
            const attach = (id, evt, fn) => { const el = document.getElementById(id); if (el) el.addEventListener(evt, fn); };
            attach(`${category}-date-filter`, 'change', (e) => { selectedDate = e.target.value; renderInventoryView(category); });
            attach(`${category}-search-filter`, 'input', () => renderTableBody(category));
            attach(`${category}-show-out-of-stock`, 'change', () => renderTableBody(category));
            attach(`${category}-show-negative-stock`, 'change', () => renderTableBody(category));
            attach(`${category}-show-below-min`, 'change', () => renderTableBody(category));

            renderTableBody(category);
        };

        // 4. Override Render Table Body (Correct Rows with 15 Columns)
        window.renderTableBody = function (category) {
            const tableBody = document.getElementById(`${category}-table-body`);
            if (!tableBody) return;
            const searchInput = document.getElementById(`${category}-search-filter`);
            const searchFilter = searchInput ? searchInput.value.toLowerCase() : '';

            const outOfStockCheckbox = document.getElementById(`${category}-show-out-of-stock`);
            const showOutOfStock = outOfStockCheckbox ? outOfStockCheckbox.checked : false;
            const negativeStockCheckbox = document.getElementById(`${category}-show-negative-stock`);
            const showNegativeStock = negativeStockCheckbox ? negativeStockCheckbox.checked : false;
            const belowMinCheckbox = document.getElementById(`${category}-show-below-min`);
            const showBelowMin = belowMinCheckbox ? belowMinCheckbox.checked : false;

            let items = appState.inventory[category] || [];
            let itemCalculations = [];

            try {
                itemCalculations = items.map(item => {
                    try {
                        return { item, ...calculateStock(item, category, selectedDate) };
                    } catch (e) {
                        return { item, openingStock: 0, received: 0, consumed: 0, closingStock: 0 };
                    }
                });
            } catch (err) {
                tableBody.innerHTML = `<tr><td colspan="15" class="text-center py-4 text-red-500">Error loading data.</td></tr>`;
                return;
            }

            let filteredItems = itemCalculations.filter(({ item, closingStock }) => {
                if (window.isReorderMode) return true;
                try {
                    const name = item.name ? item.name.toLowerCase() : '';
                    if (searchFilter && !name.includes(searchFilter)) return false;
                    if (showNegativeStock && closingStock >= 0) return false;
                    if (showOutOfStock && !showNegativeStock && closingStock !== 0) return false;
                    if (showBelowMin && closingStock >= (item.minStockLevel || 0)) return false;
                    return true;
                } catch (e) { return false; }
            });

            // Sorting
            if (!window.isReorderMode && window.currentSortColumn) {
                filteredItems.sort((a, b) => {
                    let valA, valB;
                    if (window.currentSortColumn === 'name') {
                        valA = (a.item.name || "").toLowerCase(); valB = (b.item.name || "").toLowerCase();
                    } else if (window.currentSortColumn === 'closing') {
                        valA = a.closingStock; valB = b.closingStock;
                    } else {
                        return 0;
                    }
                    if (valA < valB) return window.currentSortOrder === 'asc' ? -1 : 1;
                    if (valA > valB) return window.currentSortOrder === 'asc' ? 1 : -1;
                    return 0;
                });
            }

            if (filteredItems.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="15" class="text-center py-4">No items found.</td></tr>`;
                return;
            }

            tableBody.innerHTML = filteredItems.map(({ item, openingStock, received, consumed, closingStock }, index) => {
                const cost = (item.currentAverageCost || item.price);
                const closingValue = (closingStock > 0 ? closingStock : 0) * cost;
                const noteIconClass = item.notes && item.notes.length > 0 ? 'has-notes' : '';
                const draggingAttrs = window.isReorderMode ?
                    `draggable="true" style="cursor: move; border: 2px dashed #a855f7;" ondragstart="handleDragStart(event, ${appState.inventory[category].findIndex(i => i.id === item.id)})" ondragover="handleDragOver(event)" ondrop="handleDrop(event, ${appState.inventory[category].findIndex(i => i.id === item.id)}, '${category}')"` : '';

                // Calculate Reserved & Available
                const reserved = window.getReservedStock ? window.getReservedStock(item, category) : 0;
                const available = closingStock - reserved;

                return `
        <tr id="row-${category}-${item.id}" data-item-id="${item.id}" ${draggingAttrs} class="hover:bg-gray-50 text-center text-sm ${window.isReorderMode ? 'bg-purple-50' : ''}">

            <td class="p-2 border-b text-gray-500">${appState.inventory[category].findIndex(i => i.id === item.id) + 1}</td>
            <td class="p-2 border-b text-left">${item.name}</td>
            <td class="p-2 border-b">${item.unit}</td>
            <td class="p-2 border-b">${(parseFloat(item.price) || 0).toFixed(2)}</td>
            <td class="p-2 border-b font-semibold text-blue-600">
                ₹${(parseFloat(cost) || 0).toFixed(2)}
                ${category === 'finishedGoods' ? `<button onclick="safeFetchCostV2('${item.id}')" class="ml-1 text-xs text-blue-400 hover:text-blue-700 bg-blue-100 hover:bg-blue-200 px-2 py-1 rounded border border-blue-300">Fetch Cost</button>` : ''}
            </td>
            <td class="p-2 border-b">
                 ${(item.minStockLevel || 0).toFixed(3)}
                 <button onclick="showBatchDetails('${item.id}', '${category}')" class="block text-xs text-purple-600 hover:text-purple-800 underline mt-1">View Batches</button>
            </td>
            <td class="p-2 border-b font-extrabold text-blue-900 bg-blue-50/50">${openingStock.toFixed(3)}</td>
            <td class="p-2 border-b ${received > 0 ? 'font-bold' : ''}">${received.toFixed(3)}</td>
            <td class="p-2 border-b ${consumed > 0 ? 'font-bold' : ''}">${consumed.toFixed(3)}</td>
            
            <!-- Closing (Phy) -->
            <td class="p-2 border-b font-bold bg-gray-50">${closingStock.toFixed(3)}</td>
            
            <!-- Reserved -->
            <td class="p-2 border-b text-center font-mono text-gray-500 bg-yellow-50">${reserved.toFixed(3)}</td>
            
            <!-- Available -->
            <td class="p-2 border-b font-bold text-green-700 bg-green-50">${available.toFixed(3)}</td>
            
            <!-- Value -->
            <td class="p-2 border-b font-mono text-xs">₹${closingValue.toFixed(2)}</td>
            
            <!-- Notes -->
            <td class="p-2 border-b">
                <span class="note-icon ${noteIconClass}" onclick="openNotesModal('${category}', '${item.id}')">📝</span>
            </td>
            
            <!-- Actions -->
            <td class="p-3 border text-center">
                <div class="flex gap-1 justify-center items-center flex-wrap">
                    <button onclick="openStockTxModal('${category}', '${item.id}', 'receive')" class="px-2 py-1 bg-green-500 text-white text-xs rounded hover:bg-green-600 font-bold">Recv</button>
                    <button onclick="openStockTxModal('${category}', '${item.id}', 'consume')" class="px-2 py-1 bg-red-500 text-white text-xs rounded hover:bg-red-600 font-bold">Cons</button>
                    <button onclick="openItemHistoryModal('${category}', '${item.id}')" class="px-2 py-1 bg-gray-600 text-white text-xs rounded hover:bg-gray-700 font-bold">History</button>
                    <button onclick="openEditItemModal('${category}', '${item.id}')" class="px-2 py-1 bg-yellow-500 text-white text-xs rounded hover:bg-yellow-600 font-bold">Edit</button>
                    ${category === 'finishedGoods' ? `
                        <button onclick="openProductTrace('${item.id}')" class="px-2 py-1 bg-purple-500 text-white text-xs rounded hover:bg-purple-600 font-bold">Track</button>
                    ` : ''}
                </div>
            </td>
        </tr>`;
            }).join('');
        };

        console.log("ANTIGRAVITY: Feature Pack V31 (Fixes) Logic Applied.");

        // ================================================================
        // FEATURE PACK V33: SAFE FETCH COST V2 (Different Approach)
        // ================================================================
        window.safeFetchCostV2 = function (itemId) {
            try {
                // 1. Safe ID Parsing
                let id = itemId;
                if (typeof itemId === 'string') {
                    id = parseFloat(itemId);
                    if (isNaN(id)) { alert("Invalid Item ID"); return; }
                }

                // 2. Find Item safely
                if (!appState || !appState.inventory || !appState.inventory.finishedGoods) {
                    alert("Inventory data not loaded.");
                    return;
                }
                const item = appState.inventory.finishedGoods.find(i => i.id == id);
                if (!item) { alert("Item not found in database."); return; }

                // 3. Find Formula (Strict Name Match)
                if (!appState.formulas) appState.formulas = [];
                const cleanName = (item.name || "").trim().toLowerCase();
                const formula = appState.formulas.find(f => (f.name || "").trim().toLowerCase() === cleanName);

                // 4. MISSING FORMULA -> MANUAL PROMPT ONLY (No Redirection)
                if (!formula) {
                    const msg = "Formula not found for: " + item.name + "\n\n" +
                        "To fix this:\n" +
                        "1. Go to 'Formulations' section manually.\n" +
                        "2. Create a new formula with the EXACT name: '" + item.name + "'\n" +
                        "3. Come back here and click Fetch Cost again.\n\n" +
                        "(Automatic redirection is disabled to prevent crashes)";
                    alert(msg);
                    return;
                }

                // 5. Calculate Cost (Strict Float Math)
                let totalCost = 0;
                let breakdown = "Cost Breakdown:\n";
                let missing = [];

                if (Array.isArray(formula.ingredients)) {
                    formula.ingredients.forEach(ing => {
                        const iItem = findItem(ing.category, ing.itemId);
                        if (iItem) {
                            const cost = parseFloat(iItem.currentAverageCost) || parseFloat(iItem.price) || 0;
                            const qty = parseFloat(ing.quantity) || 0;
                            const lineTotal = cost * qty;
                            totalCost += lineTotal;
                            breakdown += iItem.name + ": " + qty + " x " + cost.toFixed(2) + " = " + lineTotal.toFixed(2) + "\n";
                        } else {
                            missing.push("ID: " + ing.itemId);
                        }
                    });
                }

                // Packing
                if (Array.isArray(formula.packingMaterials)) {
                    formula.packingMaterials.forEach(pm => {
                        const pItem = findItem('packingMaterials', pm.itemId);
                        if (pItem) {
                            const cost = parseFloat(pItem.currentAverageCost) || parseFloat(pItem.price) || 0;
                            const qty = parseFloat(pm.quantity) || 0;
                            const lineTotal = cost * qty;
                            totalCost += lineTotal;
                            breakdown += pItem.name + " (Pkg): " + qty + " x " + cost.toFixed(2) + " = " + lineTotal.toFixed(2) + "\n";
                        }
                    });
                }

                if (missing.length > 0) {
                    alert("Cannot calculate. Missing ingredients IDs on formula:\n" + missing.join(", "));
                    return;
                }

                const outputQty = parseFloat(formula.outputQty) || 1;
                const unitCost = totalCost / outputQty;

                breakdown += "\nTotal Batch Cost: " + totalCost.toFixed(2);
                breakdown += "\nOutput Qty: " + outputQty + " " + (formula.outputUnit || "units");
                breakdown += "\n\nCALCULATED UNIT COST: " + unitCost.toFixed(2);

                // 6. Update Confirmation
                if (confirm(breakdown + "\n\nUpdate this item's cost?")) {
                    item.currentAverageCost = parseFloat(unitCost.toFixed(2));
                    // Update standard price if zero
                    if (!item.price || parseFloat(item.price) === 0) {
                        item.price = parseFloat((unitCost * 1.2).toFixed(2));
                    } else {
                        // Safe cast existing price too
                        item.price = parseFloat(item.price);
                    }

                    saveState();

                    // Safe Refresh
                    if (window.renderInventoryView && typeof window.renderInventoryView === 'function') {
                        renderInventoryView('finishedGoods');
                    }

                    alert("Cost updated successfully.");
                }

            } catch (e) {
                alert("SafeFetch Error: " + e.message);
                console.error(e);
            }
        };
        console.log("ANTIGRAVITY: Safe Fetch V2 Ready.");
    </script>



    <!-- ANTIGRAVITY FEATURE PACK V23: ENHANCED REQUISITION SYSTEM -->
    <script>
        console.log("ANTIGRAVITY: Loading Feature Pack V23 (Enhanced Requisition)...");

        // 0. Polyfill: Fuzzy Match (If missing)
        if (!window.findBestMatch) {
            window.findBestMatch = function (query, category) {
                if (!query || !appState.inventory[category]) return null;
                var items = appState.inventory[category];
                var bestItem = null;
                var bestScore = 0;

                // Simple Levenshtein-like or Token overlap
                var qTokens = query.toLowerCase().split(/\s+/);

                items.forEach(item => {
                    var score = 0;
                    var name = item.name.toLowerCase();
                    qTokens.forEach(t => {
                        if (name.includes(t)) score += (t.length * 10);
                        if (name === t) score += 50;
                    });
                    // Bonus for exact start
                    if (name.startsWith(qTokens[0])) score += 20;

                    if (score > bestScore) {
                        bestScore = score;
                        bestItem = item;
                    }
                });

                return { item: bestItem, score: bestScore };
            };
        }

        // 1. Initialize State (Wait for appState to be defined)
        if (window.appState) {
            if (!appState.requisitions) appState.requisitions = [];
            if (!appState.indenters) appState.indenters = ["Production Team", "R&D Team", "Quality Control", "Packaging Team"]; // Defaults
        }

        // 2. Render Requisition View
        window.renderRequisitionView = function () {
            try {
                var container = document.getElementById('requisition-view');
                if (!container) return;

                // Safety: Ensure State
                if (!appState.indenters) appState.indenters = ["Production Team", "R&D Team", "Quality Control", "Packaging Team"];
                if (!appState.requisitions) appState.requisitions = [];

                // Populate Indenters Dropdown
                var indenterOptions = (appState.indenters || []).map(name => `<option value="${name}">${name}</option>`).join('');

                container.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-3xl font-bold text-gray-800">Material Requisition Slip</h2>
                        <p class="text-sm text-gray-500">Issue materials to departments</p>
                    </div>
                    <div class="flex gap-2">
                         <button onclick="openBatchReqModal()" class="px-4 py-2 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded shadow hover:shadow-lg font-bold flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/></svg>
                            Quick Batch Paste
                        </button>
                        <button onclick="openReportsModal()" class="px-4 py-2 bg-gray-700 text-white rounded hover:bg-gray-800 font-bold flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                            Reports
                        </button>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-lg border-t-4 border-blue-600 mb-8">
                    <!-- Header Info -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6 bg-gray-50 p-4 rounded-lg border">
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">Indenter Name</label>
                            <div class="flex gap-2">
                                <select id="req-indenter" class="flex-1 p-2 border rounded shadow-sm font-medium">
                                    <option value="">Select Employee...</option>
                                    ${indenterOptions}
                                </select>
                                <button onclick="manageIndenters()" class="p-2 bg-gray-200 rounded hover:bg-gray-300 text-gray-600" title="Manage Employees">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                                </button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">Department</label>
                            <select id="req-department" class="w-full p-2 border rounded shadow-sm">
                                <option value="Production">Production</option>
                                <option value="R&D">R&D</option>
                                <option value="Quality Control">Quality Control</option>
                                <option value="Packaging">Packaging</option>
                                <option value="Store">Store</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">Purpose</label>
                            <input type="text" id="req-purpose" class="w-full p-2 border rounded shadow-sm" placeholder="e.g. Batch B-101">
                        </div>
                    </div>

                    <!-- Section 1: Raw Materials -->
                    ${renderReqTableSection('Raw Materials', 'rawMaterials', 'bg-red-50')}

                    <!-- Section 2: Packing Materials -->
                    ${renderReqTableSection('Packing Materials', 'packingMaterials', 'bg-yellow-50')}

                    <!-- Section 3: Labels -->
                    ${renderReqTableSection('Labels', 'labels', 'bg-green-50')}

                    <!-- Section 4: Finished Goods (Optional) -->
                    <div class="mb-6">
                         <button onclick="document.getElementById('sec-finishedGoods').classList.toggle('hidden')" class="text-sm font-bold text-purple-600 hover:underline flex items-center">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>
                            Show/Hide Finished Goods Section
                         </button>
                         <div id="sec-finishedGoods" class="hidden mt-2">
                            ${renderReqTableSection('Finished Goods', 'finishedGoods', 'bg-purple-50')}
                         </div>
                    </div>
                    
                    <div class="flex justify-end pt-4 border-t">
                        <button onclick="handleRequisitionSubmit()" class="px-8 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg shadow-lg font-bold text-lg flex items-center transform transition hover:scale-105">
                            <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                            ISSUE MATERIALS
                        </button>
                    </div>
                </div>
            `;

                // Initialize rows (6 per section)
                ['rawMaterials', 'packingMaterials', 'labels', 'finishedGoods'].forEach(cat => {
                    for (let i = 0; i < 6; i++) addReqRow(cat);
                });
            } catch (e) {
                console.error("Requisition Render Error:", e);
                document.getElementById('requisition-view').innerHTML = `<div class="p-4 text-red-600">Error loading Requisition View: ${e.message}</div>`;
            }
        };

        window.renderReqTableSection = function (title, category, headerBg) {
            return `
        <div class="mb-6 border rounded-lg overflow-hidden">
            <div class="${headerBg} px-4 py-2 border-b flex justify-between items-center">
                <h3 class="font-bold text-gray-800">${title}</h3>
                <button onclick="addReqRow('${category}')" class="text-xs bg-white border px-2 py-1 rounded hover:bg-gray-100 font-bold text-gray-600">+ Add Row</button>
            </div>
            <table class="w-full text-sm">
                <thead class="bg-gray-50 text-gray-500 text-xs uppercase">
                    <tr>
                        <th class="p-2 w-10 text-center">#</th>
                        <th class="p-2 text-left">Item Name</th>
                        <th class="p-2 text-right w-24">Stock</th>
                        <th class="p-2 w-24">Quantity</th>
                        <th class="p-2 w-16">Unit</th>
                        <th class="p-2">Remarks</th>
                        <th class="p-2 w-8"></th>
                    </tr>
                </thead>
                <tbody id="req-tbody-${category}"></tbody>
            </table>
        </div>`;
        };

        window.addReqRow = function (category, itemData = null) {
            try {
                var tbody = document.getElementById(`req-tbody-${category}`);
                if (!tbody) return;
                var rowId = Date.now() + Math.random().toString(36).substr(2, 5);

                // Safety: Ensure inventory structure
                if (!appState.inventory) appState.inventory = {};
                var items = appState.inventory[category] || [];

                // Sort alpha (Safe)
                var sortedItems = [...items].sort((a, b) => (a.name || "").localeCompare(b.name || ""));

                var options = `<option value="">Select Item...</option>` + sortedItems.map(i => `<option value="${i.id}" ${itemData && itemData.id === i.id ? 'selected' : ''}>${i.name}</option>`).join('');

                var tr = document.createElement('tr');
                tr.className = "border-t border-gray-100 hover:bg-gray-50 group";
                tr.id = `req-row-${rowId}`;

                // Auto-fill values if item provided (Batch mode)
                let stockVal = '-', unitVal = '-', qtyVal = '';
                if (itemData) {
                    const calc = (window.calculateStock && window.calculateStock(itemData, category, getToday())) || {};
                    stockVal = (calc.closingStock !== undefined ? calc.closingStock : itemData.closingStock || 0).toFixed(3);
                    unitVal = itemData.unit;
                    qtyVal = itemData.reqQty || '';
                }

                tr.innerHTML = `
                <td class="p-2 text-center text-gray-400 text-xs rowIndex"></td>
                <td class="p-2">
                    <select id="sel-${rowId}" class="w-full p-1 border rounded focus:ring-1 focus:ring-blue-500 text-sm" onchange="updateReqRowDetails('${rowId}', '${category}', this.value)">
                        ${options}
                    </select>
                </td>
                <td class="p-2 text-right font-mono text-xs text-gray-500" id="stock-${rowId}">${stockVal}</td>
                <td class="p-2">
                    <input type="number" step="any" id="qty-${rowId}" value="${qtyVal}" class="w-full p-1 border rounded font-bold text-blue-800 text-center focus:bg-blue-50" placeholder="0">
                </td>
                <td class="p-2 text-xs text-gray-500 text-center" id="unit-${rowId}">${unitVal}</td>
                <td class="p-2">
                    <input type="text" id="note-${rowId}" class="w-full p-1 border-b bg-transparent text-xs focus:border-blue-500 focus:outline-none" placeholder="Notes...">
                </td>
                <td class="p-2 text-center">
                    <button onclick="document.getElementById('req-row-${rowId}').remove()" class="text-gray-300 hover:text-red-500 group-hover:text-gray-400">&times;</button>
                </td>
            `;
                tbody.appendChild(tr);
                reindexRows(category);
            } catch (e) {
                console.error("Add Row Error:", e);
            }
        };

        window.reindexRows = function (category) {
            var tbody = document.getElementById(`req-tbody-${category}`);
            if (!tbody) return;
            tbody.querySelectorAll('.rowIndex').forEach((el, idx) => el.innerText = idx + 1);
        };

        window.updateReqRowDetails = function (rowId, category, itemId) {
            if (!itemId) {
                document.getElementById(`stock-${rowId}`).innerText = '-';
                document.getElementById(`unit-${rowId}`).innerText = '-';
                return;
            }
            var item = appState.inventory[category].find(i => i.id == itemId);
            if (item) {
                var stock = item.openingStock + (item.receivedQuantity || 0) - (item.consumedQuantity || 0);
                if (window.calculateStock) {
                    stock = window.calculateStock(item, category, getToday()).closingStock;
                }
                document.getElementById(`stock-${rowId}`).innerText = stock.toFixed(3);
                document.getElementById(`unit-${rowId}`).innerText = item.unit;
            }
        };

        // 3. Employee Management
        window.manageIndenters = function () {
            var names = prompt("Manage Employees/Indenters (Comma separated):", appState.indenters.join(", "));
            if (names !== null) {
                appState.indenters = names.split(",").map(s => s.trim()).filter(s => s);
                saveState();
                renderRequisitionView(); // Refresh dropdown
            }
        };

        // 4. Batch Entry Logic
        window.openBatchReqModal = function () {
            var html = `
        <div id="batchReqModal" class="modal fixed inset-0 bg-black bg-opacity-50 z-[90] flex justify-center items-center">
             <div class="bg-white p-6 rounded-lg w-full max-w-2xl shadow-xl">
                <h3 class="text-lg font-bold mb-2">Detailed Batch Paste</h3>
                <p class="text-xs text-gray-500 mb-2">Paste your list (e.g., "Acetic Acid 50"). System will auto-categorize.</p>
                <textarea id="batch-paste-area" class="w-full h-64 p-3 border rounded font-mono text-sm bg-gray-50" placeholder="Paste data here..."></textarea>
                <div class="flex justify-end gap-2 mt-4">
                    <button onclick="document.getElementById('batchReqModal').remove()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">Cancel</button>
                    <button onclick="processBatchReqPaste()" class="px-6 py-2 bg-blue-600 text-white rounded font-bold hover:bg-blue-700">Process & Fill Form</button>
                </div>
             </div>
        </div>`;
            document.body.insertAdjacentHTML('beforeend', html);
        };

        window.processBatchReqPaste = function () {
            var text = document.getElementById('batch-paste-area').value;
            if (!text.trim()) return;

            var lines = text.split('\n');
            var foundCount = 0;

            // Clear existing empty rows to be clean? Or just append?
            // Let's clear default empty rows if we find matches

            lines.forEach(line => {
                line = line.trim();
                if (!line) return;

                // Extract Qty (Last number)
                var lastSpace = line.lastIndexOf(' ');
                if (lastSpace === -1) return;
                var namePart = line.substring(0, lastSpace).trim();
                var infoPart = line.substring(lastSpace + 1).trim();
                var qty = parseFloat(infoPart);
                if (isNaN(qty)) return;

                // Find Item across ALL categories
                var match = null;
                var matchCat = '';

                ['rawMaterials', 'packingMaterials', 'labels', 'finishedGoods'].forEach(cat => {
                    var m = window.findBestMatch(namePart, cat); // Use V21 fuzzy
                    if (m && m.score > 60 && (!match || m.score > match.score)) {
                        match = m;
                        matchCat = cat;
                    }
                });

                if (match) {
                    // Add to specific table
                    match.item.reqQty = qty;
                    addReqRow(matchCat, match.item);
                    foundCount++;
                }
            });

            document.getElementById('batchReqModal').remove();
            if (foundCount > 0) showAlert(`Filled ${foundCount} items into the form. Please review.`);
            else alert("No matching items found.");
        };

        // 5. Submit Logic
        window.handleRequisitionSubmit = function () {
            var indenter = document.getElementById('req-indenter').value;
            var dept = document.getElementById('req-department').value;
            var purpose = document.getElementById('req-purpose').value;

            if (!indenter || !dept) { alert("Please select Indenter and Department."); return; }

            var itemsToProcess = [];

            ['rawMaterials', 'packingMaterials', 'labels', 'finishedGoods'].forEach(cat => {
                var tbody = document.getElementById(`req-tbody-${cat}`);
                if (!tbody) return;
                tbody.querySelectorAll('tr').forEach(tr => {
                    var sel = tr.querySelector('select');
                    var qtyIn = tr.querySelector('input[type="number"]');
                    var noteIn = tr.querySelector('input[type="text"]');

                    if (sel && sel.value && qtyIn && parseFloat(qtyIn.value) > 0) {
                        var item = appState.inventory[cat].find(i => i.id == sel.value);
                        itemsToProcess.push({
                            category: cat,
                            itemId: item.id,
                            itemName: item.name,
                            qty: parseFloat(qtyIn.value),
                            unit: item.unit,
                            note: noteIn.value
                        });
                    }
                });
            });

            if (itemsToProcess.length === 0) { alert("No items to issue."); return; }

            if (!confirm(`Issue ${itemsToProcess.length} items to ${indenter}?`)) return;

            var reqId = 'REQ-' + Date.now().toString().substr(-6);
            var reqDate = new Date().toISOString();

            itemsToProcess.forEach(i => {
                var tx = {
                    id: Date.now() + Math.random(),
                    date: reqDate,
                    type: 'consume',
                    category: i.category,
                    itemId: i.itemId,
                    quantity: i.qty,
                    itemName: i.itemName,
                    user: (appState.currentUser && appState.currentUser.username) || 'Store',
                    details: `Issued to ${indenter} (${dept}) for ${purpose}. ${i.note}`,
                    requisitionId: reqId,
                    indenter: indenter // Detailed tracking
                };
                if (!appState.transactions) appState.transactions = [];
                appState.transactions.push(tx);
            });

            appState.requisitions.push({
                id: reqId, date: reqDate, indenter, department: dept, purpose, items: itemsToProcess
            });
            saveState();
            alert("Requisition Successful!");
            renderRequisitionView(); // Reset
        };

        // 6. Reports Modal
        window.openReportsModal = function () {
            var html = `
        <div id="repModal" class="modal fixed inset-0 bg-black bg-opacity-50 z-[95] flex justify-center items-center">
            <div class="bg-white p-6 rounded-lg w-96 shadow-xl">
                <h3 class="font-bold text-lg mb-4">Download Reports</h3>
                
                <label class="block text-sm mb-1">Filter by Indenter:</label>
                <select id="rep-indenter" class="w-full p-2 border rounded mb-4">
                    <option value="ALL">All Employees</option>
                    ${appState.indenters.map(n => `<option value="${n}">${n}</option>`).join('')}
                </select>

                <div class="flex gap-2">
                    <button onclick="downloadReqReport()" class="flex-1 bg-green-600 text-white py-2 rounded font-bold hover:bg-green-700">Download CSV</button>
                    <button onclick="document.getElementById('repModal').remove()" class="bg-gray-200 text-gray-700 px-4 rounded hover:bg-gray-300">Close</button>
                </div>
            </div>
        </div>`;
            document.body.insertAdjacentHTML('beforeend', html);
        };

        window.downloadReqReport = function () {
            var filterIndenter = document.getElementById('rep-indenter').value;
            var csv = ["Date,Requisition ID,Indenter,Department,Purpose,Category,Item Name,Quantity,Unit,Remarks"];

            var reqs = appState.requisitions || [];
            // Flatten
            reqs.forEach(r => {
                if (filterIndenter !== "ALL" && r.indenter !== filterIndenter) return;

                r.items.forEach(i => {
                    csv.push([
                        new Date(r.date).toLocaleString().replace(',', ''),
                        r.id,
                        r.indenter,
                        r.department,
                        r.purpose,
                        i.category,
                        i.itemName,
                        i.qty,
                        i.unit,
                        i.note || ''
                    ].join(","));
                });
            });

            var blob = new Blob([csv.join("\n")], { type: 'text/csv' });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = `Requisition_Report_${filterIndenter}_${getToday()}.csv`;
            a.click();
            document.getElementById('repModal').remove();
        };

        // 7. Visibility Hook (CRITICAL RESTORATION)
        var existingViewHookV24 = window.showView;
        window.showView = function (viewName) {
            if (existingViewHookV24) existingViewHookV24(viewName);

            var reqView = document.getElementById('requisition-view');
            if (reqView) {
                if (viewName === 'requisition') {
                    reqView.classList.remove('hidden');
                    reqView.style.display = 'block';
                    // Trigger Render (Safely)
                    if (window.renderRequisitionView) window.renderRequisitionView();
                } else {
                    reqView.classList.add('hidden');
                    reqView.style.display = 'none';
                }
            }
        };

        console.log("ANTIGRAVITY: Feature Pack V24 Base Loaded.");

        // --- V24 COMPLETE LOGIC APPEND ---
        // 1. Override Render for Requisition (GAS INTEGRATED - PENDING LIST VERSION)
        window.renderRequisitionView = function () {
            try {
                var container = document.getElementById('requisition-view');
                if (!container) return;

                // Safety: Ensure State
                if (!appState.indenters) appState.indenters = ["Production Team", "R&D Team", "Quality Control", "Packaging Team"];
                if (!appState.requisitions) appState.requisitions = [];

                // Populate Indenters Dropdown
                var indenterOptions = (appState.indenters || []).map(name => `<option value="${name}">${name}</option>`).join('');

                var gasUrl = localStorage.getItem('GAS_REQ_URL') || '';

                container.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-3xl font-bold text-gray-800">Material Requisition Slip</h2>
                        <p class="text-sm text-gray-500">Issue materials based on Production Incharge ID</p>
                    </div>
                    <div class="flex gap-2">
                         <button onclick="configureGasUrl()" class="px-3 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 font-bold flex items-center text-xs">
                            ⚙️ Config Link
                        </button>
                         <button onclick="window.openBatchReqModal()" class="px-4 py-2 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded shadow hover:shadow-lg font-bold flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/></svg>
                            Quick Batch Paste
                        </button>
                        <button onclick="window.openReportsModal()" class="px-4 py-2 bg-gray-700 text-white rounded hover:bg-gray-800 font-bold flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                            Reports
                        </button>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-lg border-t-4 border-blue-600 mb-8">
                    <!-- REQUISITION SELECTION SECTION -->
                    <div class="mb-6 bg-blue-50 p-4 rounded-lg border border-blue-100 flex items-center gap-4">
                        <div class="flex-1">
                            <label class="block text-sm font-bold text-blue-900 mb-1">Select Pending Requisition</label>
                            <select id="pending-req-select" onchange="selectPendingRequisition(this.value)" class="w-full p-2 border-2 border-blue-300 rounded font-medium text-lg text-blue-900 focus:ring-2 focus:ring-blue-500">
                                <option value="">Compiling Pending Requests...</option>
                            </select>
                        </div>
                        <button onclick="refreshPendingRequisitions()" class="mt-5 text-blue-600 hover:text-blue-800" title="Refresh List">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                        </button>
                    </div>

                    <!-- Header Info -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6 bg-gray-50 p-4 rounded-lg border">
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">Indenter Name</label>
                            <div class="flex gap-2">
                                <select id="req-indenter" class="flex-1 p-2 border rounded shadow-sm font-medium">
                                    <option value="">Select Employee...</option>
                                    ${indenterOptions}
                                </select>
                                <button onclick="manageIndenters()" class="p-2 bg-gray-200 rounded hover:bg-gray-300 text-gray-600" title="Manage Employees">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                                </button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">Department</label>
                            <select id="req-department" class="w-full p-2 border rounded shadow-sm">
                                <option value="Production">Production</option>
                                <option value="R&D">R&D</option>
                                <option value="Quality Control">Quality Control</option>
                                <option value="Packaging">Packaging</option>
                                <option value="Store">Store</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">Approver</label>
                            <input type="text" id="req-approver" class="w-full p-2 border rounded shadow-sm bg-gray-100 text-gray-600" readonly placeholder="(None)">
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">Purpose</label>
                            <input type="text" id="req-purpose" class="w-full p-2 border rounded shadow-sm" placeholder="e.g. Batch B-101">
                        </div>
                    </div>

                    <!-- Section 1: Raw Materials (Always Visible) -->
                    ${window.renderReqTableSection('Raw Materials', 'rawMaterials', 'bg-red-50', true)}

                    <!-- Section 2: Packing Materials (Collapsible) -->
                     <button onclick="document.getElementById('sec-packingMaterials').classList.toggle('hidden')" class="w-full mb-2 text-left px-4 py-2 bg-yellow-50 hover:bg-yellow-100 rounded border border-yellow-200 font-bold text-yellow-800 flex justify-between items-center group">
                        <span>📦 Packing Materials</span>
                        <span class="text-xs text-yellow-500 group-hover:text-yellow-700 transform transition-transform group-hover:rotate-180">▼</span>
                     </button>
                     <div id="sec-packingMaterials" class="hidden mb-4">
                        ${window.renderReqTableSection('Packing Materials', 'packingMaterials', 'bg-yellow-50', false)}
                     </div>

                    <!-- Section 3: Labels (Collapsible) -->
                    <button onclick="document.getElementById('sec-labels').classList.toggle('hidden')" class="w-full mb-2 text-left px-4 py-2 bg-green-50 hover:bg-green-100 rounded border border-green-200 font-bold text-green-800 flex justify-between items-center group">
                        <span>🏷️ Labels</span>
                        <span class="text-xs text-green-500 group-hover:text-green-700 transform transition-transform group-hover:rotate-180">▼</span>
                     </button>
                     <div id="sec-labels" class="hidden mb-4">
                        ${window.renderReqTableSection('Labels', 'labels', 'bg-green-50', false)}
                     </div>

                    <!-- Section 4: Finished Goods (Collapsible) -->
                    <button onclick="document.getElementById('sec-finishedGoods').classList.toggle('hidden')" class="w-full mb-2 text-left px-4 py-2 bg-purple-50 hover:bg-purple-100 rounded border border-purple-200 font-bold text-purple-800 flex justify-between items-center group">
                        <span>✨ Finished Goods</span>
                        <span class="text-xs text-purple-500 group-hover:text-purple-700 transform transition-transform group-hover:rotate-180">▼</span>
                     </button>
                     <div id="sec-finishedGoods" class="hidden mb-4">
                        ${window.renderReqTableSection('Finished Goods', 'finishedGoods', 'bg-purple-50', false)}
                     </div>
                    
                    <div class="flex justify-end pt-4 border-t mt-6">
                        <button onclick="window.handleRequisitionSubmit()" class="px-8 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg shadow-lg font-bold text-lg flex items-center transform transition hover:scale-105">
                            <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                            ISSUE MATERIALS
                        </button>
                    </div>
                </div>
            `;

                // Initialize rows (6 per section)
                ['rawMaterials', 'packingMaterials', 'labels', 'finishedGoods'].forEach(cat => {
                    for (let i = 0; i < 6; i++) addReqRow(cat);
                });

                // Auto-Fetch Pending if URL exists
                if (gasUrl) {
                    refreshPendingRequisitions();
                    fetchDynamicLists(gasUrl); // <--- ADDED THIS LINE
                } else {
                    document.getElementById('pending-req-select').innerHTML = '<option>⚠️ Configure Link First!</option>';
                }

            } catch (e) {
                console.error("Requisition Render Error:", e);
                document.getElementById('requisition-view').innerHTML = `<div class="p-4 text-red-600">Error loading Requisition View: ${e.message}</div>`;
            }
        };

        window.configureGasUrl = function () {
            var current = localStorage.getItem('GAS_REQ_URL') || '';
            var url = prompt("Enter Google Apps Script Web App URL:", current);
            if (url !== null) {
                localStorage.setItem('GAS_REQ_URL', url.trim());
                alert("URL Saved.");
                renderRequisitionView(); // Refresh
            }
        };

        window.refreshPendingRequisitions = async function () {
            var sel = document.getElementById('pending-req-select');
            if (!sel) return;
            var gasUrl = localStorage.getItem('GAS_REQ_URL');
            if (!gasUrl) return;

            sel.innerHTML = '<option>Loading...</option>';
            sel.disabled = true;

            try {
                const res = await fetch(`${gasUrl}?action=get_pending`);
                const data = await res.json();

                if (data.result === 'success') {
                    // FILTER LOCALLY PROCESSED
                    var processed = JSON.parse(localStorage.getItem('LOCAL_PROCESSED_REQS') || '[]');
                    var validPending = data.pending.filter(p => !processed.includes(p.id.toString()));

                    if (validPending.length === 0) {
                        sel.innerHTML = '<option value="">(No Pending Requisitions)</option>';
                    } else {
                        sel.innerHTML = '<option value="">-- Select a Requisition --</option>';
                        validPending.forEach(p => {
                            const dateStr = new Date(p.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                            const opt = document.createElement('option');
                            opt.value = JSON.stringify(p);
                            const apprStr = p.approver ? ` (Appr: ${p.approver})` : '';
                            opt.text = `#${p.id} - ${p.employee}${apprStr} (${dateStr})`;
                            sel.appendChild(opt);
                        });
                    }
                } else {
                    sel.innerHTML = '<option>Error fetching data</option>';
                }
            } catch (e) {
                console.error(e);
                sel.innerHTML = '<option>Connection Error</option>';
            } finally {
                sel.disabled = false;
            }
        };

        window.selectPendingRequisition = function (val) {
            if (!val) return;
            try {
                var data = JSON.parse(val);
                // Auto fill Name (Robust)
                var sel = document.getElementById('req-indenter');
                var empName = data.employee || data.indenterName;

                if (empName) {
                    var exists = false;
                    for (var i = 0; i < sel.options.length; i++) {
                        if (sel.options[i].value === empName) {
                            sel.selectedIndex = i;
                            exists = true;
                            break;
                        }
                    }
                    if (!exists) {
                        var opt = document.createElement('option');
                        opt.value = empName;
                        opt.text = empName;
                        opt.selected = true;
                        sel.appendChild(opt);
                        if (appState.indenters.indexOf(empName) === -1) {
                            appState.indenters.push(empName);
                            saveState();
                        }
                    }
                    // Force triggering change event if needed
                    sel.value = empName;
                }

                // Auto-Select Department via Mapping
                var deptSel = document.getElementById('req-department');
                if (appState.employeeMap && empName) {
                    const entry = appState.employeeMap.find(m => m.name === empName);
                    if (entry && entry.dept) {
                        deptSel.value = entry.dept;
                    } else {
                        // Try to match from pending data if available
                        if (data.department || data.employeeDepartment) {
                            deptSel.value = data.department || data.employeeDepartment;
                        }
                    }
                } else if (data.department) {
                    deptSel.value = data.department;
                }

                // Populate Approver
                if (document.getElementById('req-approver')) {
                    document.getElementById('req-approver').value = data.approver || '';
                }

                // Store selected ID in a dataset attr for Submit
                document.getElementById('pending-req-select').dataset.selectedId = data.id;

            } catch (e) {
                console.error(e);
            }
        };

        window.fetchDynamicLists = async function (url) {
            try {
                const res = await fetch(`${url}?action=get_lists`);
                const data = await res.json();
                if (data.result === 'success') {
                    // Save Mapping for Auto-Select
                    if (data.data.mapping) {
                        appState.employeeMap = data.data.mapping;
                    }

                    // Populate Employees
                    if (data.data.employees && data.data.employees.length > 0) {
                        const sel = document.getElementById('req-indenter');
                        if (sel) {
                            sel.innerHTML = '<option value="">Select Employee...</option>' +
                                data.data.employees.map(e => `<option value="${e}">${e}</option>`).join('');

                            // Add Change Listener for Auto-Dept
                            sel.onchange = function () {
                                if (!appState.employeeMap) return;
                                const v = this.value;
                                const entry = appState.employeeMap.find(m => m.name === v);
                                const deptSel = document.getElementById('req-department');
                                if (entry && entry.dept && deptSel) {
                                    deptSel.value = entry.dept;
                                }
                            };
                        }
                    }
                    // Populate Departments
                    if (data.data.departments && data.data.departments.length > 0) {
                        const sel = document.getElementById('req-department');
                        if (sel) {
                            sel.innerHTML = '<option value="">Select Department...</option>' +
                                data.data.departments.map(d => `<option value="${d}">${d}</option>`).join('');
                        }
                    } else {
                        // Fallback defaults
                        const sel = document.getElementById('req-department');
                        if (sel) {
                            sel.innerHTML = `
                        <option value="Production">Production</option>
                        <option value="R&D">R&D</option>
                        <option value="Quality Control">Quality Control</option>
                        <option value="Packaging">Packaging</option>
                        <option value="Store">Store</option>`;
                        }
                    }
                }
            } catch (e) { console.error("List fetch error", e); }
        };

        // Override Submit: Sequential IDs
        window.handleRequisitionSubmit = async function () {
            var indenter = document.getElementById('req-indenter').value;
            var dept = document.getElementById('req-department').value;
            var purpose = document.getElementById('req-purpose').value;

            var pendingSel = document.getElementById('pending-req-select');
            var extReqId = pendingSel && pendingSel.dataset.selectedId ? pendingSel.dataset.selectedId : '';

            if (!indenter || !dept) { alert("Please select Indenter and Department."); return; }

            var itemsToProcess = [];

            ['rawMaterials', 'packingMaterials', 'labels', 'finishedGoods'].forEach(cat => {
                var tbody = document.getElementById(`req-tbody-${cat}`);
                if (!tbody) return;
                tbody.querySelectorAll('tr').forEach(tr => {
                    var sel = tr.querySelector('select');
                    var qtyIn = tr.querySelector('input[type="number"]');
                    var noteIn = tr.querySelector('input[type="text"]');

                    if (sel && sel.value && qtyIn && parseFloat(qtyIn.value) > 0) {
                        var item = appState.inventory[cat].find(i => i.id == sel.value);
                        itemsToProcess.push({
                            category: cat,
                            itemId: item.id,
                            itemName: item.name,
                            qty: parseFloat(qtyIn.value),
                            unit: item.unit,
                            note: noteIn.value,
                            // Add Context for Export
                            department: dept,
                            purpose: purpose
                        });
                    }
                });
            });

            if (itemsToProcess.length === 0) { alert("No items to issue."); return; }

            if (!confirm(`Issue ${itemsToProcess.length} items to ${indenter}?`)) return;

            // Use External ID if provided, else generate Local
            var reqId = extReqId ? 'EXT-' + extReqId : 'REQ-' + Date.now().toString().substr(-6);
            var reqDate = new Date().toISOString();

            // 1. Mark as Used in GAS (if applicable)
            var gasUrl = localStorage.getItem('GAS_REQ_URL');
            if (extReqId) {
                // LOCAL DEDUPLICATION: Vanish from UI immediately
                var processed = JSON.parse(localStorage.getItem('LOCAL_PROCESSED_REQS') || '[]');
                if (!processed.includes(extReqId.toString())) {
                    processed.push(extReqId.toString());
                    localStorage.setItem('LOCAL_PROCESSED_REQS', JSON.stringify(processed));
                }
                if (gasUrl) {
                    try {
                        // Generate Item Summary String (Keep for safety or use JSON?)
                        // User wants Export. We must save JSON.
                        // But previously we sent summary which was human readable in sheet.
                        // If we send JSON, the sheet cell will look ugly " [{...}] ".
                        // But for Export we need it.
                        // Let's send JSON. The Requisition App will parse it.
                        // The Sheet user might complain. 
                        // Compromise: We can send both? No, single column.
                        // Let's send JSON. The user specifically asked for detailed export.

                        var itemsJson = JSON.stringify(itemsToProcess);

                        const res = await fetch(`${gasUrl}?action=mark_used&id=${encodeURIComponent(extReqId)}&items=${encodeURIComponent(itemsJson)}`);
                        const data = await res.json();
                        if (data.result !== 'success') {
                            alert("Warning: Could not mark ID as used in Cloud. Please check manually.");
                        }
                    } catch (e) {
                        alert("Warning: Cloud Connection Failed. Transaction will be saved locally ONLY.");
                    }
                }
            }

            itemsToProcess.forEach(i => {
                var tx = {
                    id: Date.now() + Math.random(),
                    date: reqDate,
                    type: 'consume',
                    category: i.category,
                    itemId: i.itemId,
                    quantity: i.qty,
                    itemName: i.itemName,
                    user: (appState.currentUser && appState.currentUser.username) || 'Store',
                    details: `Issued to ${indenter} (${dept}) for ${purpose}. ${i.note}`,
                    requisitionId: reqId,
                    indenter: indenter
                };
                if (!appState.transactions) appState.transactions = [];
                appState.transactions.push(tx);
            });

            appState.requisitions.push({
                id: reqId, date: reqDate, indenter, department: dept, purpose, items: itemsToProcess
            });
            saveState();
            alert(`Requisition Successful! ID: ${reqId}`);
            renderRequisitionView(); // Reset
        };


        // --- FIX: OVERRIDE BROKEN SHOWALERT (REMOVES ROGUE ACETIC ACID POPUP) ---
        window.showAlert = function (message, title) {
            title = title || "Alert";
            var modal = document.getElementById('genericMessageModal');
            if (modal) {
                document.getElementById('generic-message-title').textContent = title;
                // Ensure message is treated as HTML only if intended, but for safety treat as text/br
                // Actually, we want to allow newlines
                var contentDiv = document.getElementById('generic-message-content');
                if (message.includes('<')) {
                    // Assume safe HTML if contains tags (rare for alerts)
                    contentDiv.innerHTML = message;
                } else {
                    contentDiv.innerHTML = message.replace(/\n/g, '<br>');
                }
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            } else {
                alert(message);
            }
        };
        console.log("ANTIGRAVITY: Critical Fix - showAlert Restored (Popup Cleared).");

        console.log("ANTIGRAVITY: Feature Pack V24 (Full Logic) Loaded.");

    </script>

    <!-- ANTIGRAVITY FEATURE PACK V30: FIFO, ALERTS, BACKUP -->
    <script>
        console.log("ANTIGRAVITY: Loading Feature Pack V30 (Pro Upgrade)...");

        // 1. BACKUP & RESTORE UTILITIES
        window.downloadBackup = function () {
            const data = JSON.stringify(appState, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `INVENTORY_BACKUP_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            window.showAlert("Backup Downloaded Successfully!", "Data Safe");
        };

        window.restoreBackup = function () {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'application/json';
            input.onchange = e => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = event => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (data && data.inventory) { // Basic validation
                            if (confirm("WARNING: This will overwrite ALL current data with the backup. Continue?")) {
                                appState = data;
                                window.saveState();
                                location.reload(); // Reload to apply
                            }
                        } else {
                            alert("Invalid Backup File");
                        }
                    } catch (err) { alert("Error parsing file"); }
                };
                reader.readAsText(file);
            };
            input.click();
        };


        // 2. FIFO ALLOCATION HELPER
        window.getFifoAllocation = function (itemId, qtyNeeded) {
            // Logic adapted from V29 Trace View
            const txs = appState.transactions || [];
            const batchMap = new Map();

            // 1. Build Batch Balances
            txs.filter(t => t.itemId == itemId)
                .forEach(t => {
                    const batchKey = t.batchNo || 'OPENING_STOCK'; // Treat missing batch as generic pile
                    if (!batchMap.has(batchKey)) {
                        batchMap.set(batchKey, {
                            id: batchKey,
                            firstDate: t.date, // Approx creation date
                            in: 0,
                            out: 0
                        });
                    }
                    const b = batchMap.get(batchKey);
                    // Inflow
                    if (['production-add', 'receive', 'stock-take-adj-in'].includes(t.type)) {
                        b.in += (parseFloat(t.quantity) || 0);
                        // Update First Date if this is the creation event
                        if (t.type !== 'stock-take-adj-in') b.firstDate = t.date;
                    }
                    // Outflow
                    else if (['dispatch', 'consume', 'stock-take-adj-out', 'production-consume'].includes(t.type)) {
                        b.out += (parseFloat(t.quantity) || 0);
                    }
                });

            // 2. Filter & Sort (Oldest First)
            let batches = Array.from(batchMap.values())
                .map(b => ({ ...b, balance: b.in - b.out }))
                .filter(b => b.balance > 0)
                .sort((a, b) => new Date(a.firstDate) - new Date(b.firstDate));

            // 3. Allocate
            let remaining = qtyNeeded;
            const allocation = [];

            for (const b of batches) {
                if (remaining <= 0) break;

                const take = Math.min(remaining, b.balance);
                allocation.push({
                    batchNo: b.id === 'OPENING_STOCK' ? null : b.id, // If generic, consume generic
                    qty: take
                });
                remaining -= take;
            }

            // If still remaining (more needed than available in batches), take from generic/null
            if (remaining > 0) {
                allocation.push({ batchNo: null, qty: remaining });
            }

            return allocation;
        };


        // 3. REQUISITION SUBMIT OVERRIDE (FIFO + DEDUPLICATION)
        window.handleRequisitionSubmit = async function () {
            var indenter = document.getElementById('req-indenter').value;
            var dept = document.getElementById('req-department').value;
            var purpose = document.getElementById('req-purpose').value;

            var pendingSel = document.getElementById('pending-req-select');
            var extReqId = pendingSel && pendingSel.dataset.selectedId ? pendingSel.dataset.selectedId : '';

            if (!indenter || !dept) { alert("Please select Indenter and Department."); return; }

            var itemsToProcess = [];

            ['rawMaterials', 'packingMaterials', 'labels', 'finishedGoods'].forEach(cat => {
                var tbody = document.getElementById(`req-tbody-${cat}`);
                if (!tbody) return;
                tbody.querySelectorAll('tr').forEach(tr => {
                    var sel = tr.querySelector('select');
                    var qtyIn = tr.querySelector('input[type="number"]');
                    var noteIn = tr.querySelector('input[type="text"]');

                    if (sel && sel.value && qtyIn && parseFloat(qtyIn.value) > 0) {
                        var item = appState.inventory[cat].find(i => i.id == sel.value);
                        itemsToProcess.push({
                            category: cat,
                            item: item,
                            qty: parseFloat(qtyIn.value),
                            note: noteIn.value
                        });
                    }
                });
            });

            if (itemsToProcess.length === 0) { alert("No items to issue."); return; }

            // CHECK NEGATIVE STOCK
            var negativeWarnings = [];
            if (window.stockCache) window.stockCache.clear(); // Ensure fresh data

            itemsToProcess.forEach(task => {
                const stockData = window.calculateStock(task.item, task.category);
                if ((stockData.closingStock - task.qty) < 0) {
                    negativeWarnings.push(`- ${task.item.name}: Stock ${stockData.closingStock} -> Req ${task.qty}`);
                }
            });

            if (negativeWarnings.length > 0) {
                const msg = "⚠️ CRITICAL WARNING: NEGATIVE STOCK ALERT ⚠️\n\nThe following items will go below zero:\n" +
                    negativeWarnings.join("\n") +
                    "\n\nDo you want to FORCE ISSUE these items?";
                if (!confirm(msg)) return;
            } else {
                if (!confirm(`Issue ${itemsToProcess.length} items to ${indenter}?`)) return;
            }

            // --- ID GENERATION & DEDUPLICATION ---
            var reqId = extReqId ? 'EXT-' + extReqId : 'REQ-' + Date.now().toString().substr(-6);

            if (extReqId) {
                var processed = JSON.parse(localStorage.getItem('LOCAL_PROCESSED_REQS') || '[]');
                if (!processed.includes(extReqId.toString())) {
                    processed.push(extReqId.toString());
                    localStorage.setItem('LOCAL_PROCESSED_REQS', JSON.stringify(processed));
                }
                var gasUrl = localStorage.getItem('GAS_REQ_URL');
                if (gasUrl) {
                    // Send simplified JSON to Sheet (no batch details needed there specifically, or maybe they do? 
                    // For now keep it simple to match previous schema)
                    // We send the TOTAL qty per item.
                    var simpleItems = itemsToProcess.map(i => ({ category: i.category, itemId: i.item.id, itemName: i.item.name, qty: i.qty }));
                    fetch(`${gasUrl}?action=mark_used&id=${encodeURIComponent(extReqId)}&items=${encodeURIComponent(JSON.stringify(simpleItems))}`)
                        .catch(e => console.warn("Cloud offline"));
                }
            }

            // --- FIFO TRANSACTION & ALERTS ---
            var reqDate = new Date().toISOString();
            var alertMessages = [];

            itemsToProcess.forEach(task => {
                // Apply FIFO
                const allocation = window.getFifoAllocation(task.item.id, task.qty);

                allocation.forEach(alloc => {
                    var tx = {
                        id: Date.now() + Math.random(),
                        date: reqDate,
                        type: 'consume',
                        category: task.category,
                        itemId: task.item.id,
                        quantity: alloc.qty,
                        itemName: task.item.name,
                        batchNo: alloc.batchNo, // V30 FEATURE: Track specific batch
                        user: (appState.currentUser && appState.currentUser.username) || 'Store',
                        details: `Issued to ${indenter} (${dept}) for ${purpose}. ${task.note}`,
                        requisitionId: reqId,
                        indenter: indenter
                    };
                    if (!appState.transactions) appState.transactions = [];
                    appState.transactions.push(tx);
                });

                // CHECK LOW STOCK
                // Recalculate stock after issue
                // We use setTimeout to ensure transaction is processed? No, we just pushed it.
                // But cache might be valid? We should invalidate cache immediately.
                if (window.stockCache) window.stockCache.clear();

                const stockData = window.calculateStock(task.item, task.category);
                const minLevel = parseFloat(task.item.minLevel) || 10; // Default 10 if not set
                if (stockData.closingStock < minLevel) {
                    alertMessages.push(`⚠️ LOW STOCK: ${task.item.name} is down to ${stockData.closingStock} ${task.item.unit}`);
                }
            });

            appState.requisitions.push({
                id: reqId, date: reqDate, indenter, department: dept, purpose, items: itemsToProcess.map(i => ({
                    category: i.category, itemId: i.item.id, itemName: i.item.name, qty: i.qty, unit: i.item.unit, note: i.note
                }))
            });

            saveState();

            // Show Success + Alerts
            window.showAlert(`Requisition Successful! ID: ${reqId}<br><br>${alertMessages.join('<br>')}`, "Processed");
            renderRequisitionView(); // Reset
        };

        // 4. INJECT BACKUP BUTTONS (Lazy Inject)
        setInterval(() => {
            const header = document.querySelector('#requisition-view .flex.gap-2');
            if (header && !document.getElementById('backup-btn-group')) {
                const div = document.createElement('div');
                div.id = 'backup-btn-group';
                div.className = 'flex gap-2 ml-2 border-l pl-2';
                div.innerHTML = `
                <button onclick="window.downloadBackup()" class="px-2 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 text-xs font-bold" title="Backup Database">💾</button>
                <button onclick="window.restoreBackup()" class="px-2 py-2 bg-red-600 text-white rounded hover:bg-red-700 text-xs font-bold" title="Restore Database">♻️</button>
             `;
                header.appendChild(div);
            }
        }, 1000);

        console.log("ANTIGRAVITY: Pro Features Active.");
    </script>


    <!-- ANTIGRAVITY FEATURE PACK V34: PRODUCTION TRACEABILITY -->
    <script>
        console.log("ANTIGRAVITY: Loading Feature Pack V34 (Production Traceability)...");

        // ---------------------------------------------------------
        // RENDER: PRODUCTION / WIP VIEW (UPDATED FOR TRACEABILITY)
        // ---------------------------------------------------------
        window.renderProductionWIPView_OLD = function () {
            const container = document.getElementById('production-wip-view');
            if (!container) return;

            // Ensure state
            if (!appState.productionQueue) appState.productionQueue = [];

            let html = `
        <div class="flex justify-between items-center mb-6">
            <div>
                 <h2 class="text-3xl font-bold text-gray-800">Orders & Production (WIP)</h2>
                 <p class="text-sm text-gray-500">Manage ongoing production batches and track consumption.</p>
            </div>
            <button onclick="openNewBatchModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold shadow hover:bg-blue-700 flex items-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>
                New Production Batch
            </button>
        </div>

        <!-- ACTIVE BATCHES GRID -->
        <div class="grid grid-cols-1 gap-6">
    `;

            if (appState.productionQueue.length === 0) {
                html += `<div class="p-8 text-center bg-gray-50 rounded-lg border-2 border-dashed border-gray-300 text-gray-400">
                    <p class="text-xl font-bold mb-2">No Active Batches</p>
                    <p>Start a new production batch to track materials and output.</p>
                </div>`;
            } else {
                appState.productionQueue.forEach((batch, idx) => {
                    // Calculate Progress (Stub)
                    const statusColor = batch.status === 'Completed' ? 'green' : (batch.status === 'In Progress' ? 'blue' : 'gray');

                    // Traceability Info to Display
                    let traceInfo = '';
                    if (batch.productionSlipId) {
                        traceInfo = `
                    <div class="mt-3 flex items-center gap-2 text-xs bg-purple-50 p-2 rounded border border-purple-100">
                        <span class="font-bold text-purple-700">Slip ID: ${batch.productionSlipId}</span>
                        ${batch.slipEmployee ? `<span class="text-purple-600">(${batch.slipEmployee})</span>` : ''}
                        <span class="text-green-600 font-bold ml-auto">Verified</span>
                    </div>`;
                    } else {
                        traceInfo = `
                    <div class="mt-3 text-xs bg-red-50 p-2 rounded border border-red-100 text-red-600 flex items-center justify-between">
                        <span>⚠️ No Production Slip Linked</span>
                        <button onclick="linkProductionSlip('${idx}')" class="underline font-bold hover:text-red-800">Link Now</button>
                    </div>`;
                    }

                    html += `
            <div class="bg-white rounded-xl shadow-md border border-gray-100 overflow-hidden hover:shadow-lg transition-shadow">
                <!-- Header -->
                <div class="p-4 bg-gradient-to-r from-gray-50 to-white border-b flex justify-between items-start">
                    <div>
                        <div class="flex items-center gap-2">
                             <h3 class="text-lg font-bold text-gray-800">${batch.batchNumber}</h3>
                             <span class="px-2 py-0.5 rounded-full text-xs font-bold bg-${statusColor}-100 text-${statusColor}-700 border border-${statusColor}-200">${batch.status}</span>
                        </div>
                        <p class="text-sm font-medium text-gray-600 mt-1">${batch.itemName} <span class="text-gray-400 mx-1">•</span> ${batch.targetQty} ${batch.unit}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-xs text-gray-400 font-mono">Started: ${new Date(batch.startDate).toLocaleDateString()}</p>
                    </div>
                </div>
                
                <!-- Body -->
                <div class="p-4">
                    <div class="flex justify-between text-sm mb-2">
                         <span class="text-gray-500">Output Target</span>
                         <span class="font-bold">${batch.targetQty} ${batch.unit}</span>
                    </div>
                    
                    ${traceInfo}

                    <div class="mt-4 flex gap-2">
                        <button onclick="openBatchConsumptionModal('${idx}')" class="flex-1 py-2 bg-indigo-50 text-indigo-700 hover:bg-indigo-100 rounded font-bold text-sm border border-indigo-200">
                            View / Add Consumption
                        </button>
                        <button onclick="completeBatchProduction('${idx}')" class="flex-1 py-2 bg-green-600 text-white hover:bg-green-700 rounded font-bold text-sm shadow-sm relative overflow-hidden group">
                            <span class="relative z-10">Complete Batch</span>
                        </button>
                    </div>
                </div>
            </div>`;
                });
            }

            html += `</div>`;

            // Add Modal for Linking if not exists
            if (!document.getElementById('linkSlipModal')) {
                const modalHtml = `
             <div id="linkSlipModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[100] flex justify-center items-center">
                <div class="bg-white rounded-xl shadow-2xl p-6 w-96">
                    <h3 class="text-lg font-bold mb-4">Link Production Slip</h3>
                    <p class="text-sm text-gray-500 mb-4">Enter the Slip ID generated from the Requisition App (e.g., PROD-1234) to track ownership.</p>
                    
                    <div class="mb-4">
                        <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Production Slip ID</label>
                        <div class="flex gap-2">
                            <input type="text" id="link-slip-id" class="flex-1 p-2 border rounded font-bold uppercase" placeholder="PROD-...">
                            <button onclick="verifySlipId()" class="bg-blue-600 text-white px-3 rounded font-bold hover:bg-blue-700 text-sm">Verify</button>
                        </div>
                        <div id="link-slip-result" class="mt-2 text-xs h-4"></div>
                    </div>

                    <div class="flex justify-end gap-2 pt-4 border-t">
                        <button onclick="closeLinkSlipModal()" class="text-gray-500 hover:bg-gray-100 px-4 py-2 rounded">Cancel</button>
                        <button onclick="confirmLinkSlip()" id="btn-confirm-link" disabled class="bg-green-600 text-white px-4 py-2 rounded font-bold opacity-50 cursor-not-allowed">Link Batch</button>
                    </div>
                </div>
             </div>`;
                document.body.insertAdjacentHTML('beforeend', modalHtml);
            }

            container.innerHTML = html;
        };

        // ---------------------------------------------------------
        // V30: TRACEABILITY LOGIC
        // ---------------------------------------------------------
        window.currentLinkingBatchIdx = null;
        window.tempVerifiedSlip = null;

        window.linkProductionSlip = function (idx) {
            window.currentLinkingBatchIdx = idx;
            document.getElementById('linkSlipModal').classList.remove('hidden');
            document.getElementById('link-slip-id').value = '';
            document.getElementById('link-slip-result').innerHTML = '';
            document.getElementById('btn-confirm-link').disabled = true;
            document.getElementById('btn-confirm-link').classList.add('opacity-50', 'cursor-not-allowed');
            window.tempVerifiedSlip = null;
        };

        window.closeLinkSlipModal = function () {
            document.getElementById('linkSlipModal').classList.add('hidden');
        };

        window.verifySlipId = async function () {
            const id = document.getElementById('link-slip-id').value.trim();
            const resDiv = document.getElementById('link-slip-result');

            if (!id) {
                resDiv.innerHTML = '<span class="text-red-500">Please enter an ID</span>';
                return;
            }

            resDiv.innerHTML = '<span class="text-blue-500 animate-pulse">Checking database...</span>';

            // Call Google Script
            const url = localStorage.getItem('GAS_URL');
            if (!url) {
                resDiv.innerHTML = '<span class="text-red-500">Backend System Not Configured!</span>';
                return;
            }

            try {
                // Use "Requisition Script URL" or "Main Script URL"? 
                // IMPORTANT: The user likely shares the same script for both apps as they share the DB.
                // We will assume localStorage.getItem('GAS_URL') is the main one.

                const finalUrl = `${url}?action=get_req_details&id=${encodeURIComponent(id)}`;
                const resp = await fetch(finalUrl);
                const json = await resp.json();

                if (json.result === 'success') {
                    const data = json.data;
                    resDiv.innerHTML = `<span class="text-green-600 font-bold">✅ Verified: ${data.employee} (${data.type})</span>`;

                    // Enable Confirm
                    window.tempVerifiedSlip = data;
                    const btn = document.getElementById('btn-confirm-link');
                    btn.disabled = false;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    btn.classList.add('hover:bg-green-700');
                } else {
                    resDiv.innerHTML = `<span class="text-red-500">❌ ID Not Found or Invalid</span>`;
                    window.tempVerifiedSlip = null;
                }
            } catch (e) {
                resDiv.innerHTML = `<span class="text-red-500">Connection Error</span>`;
                console.error(e);
            }
        };

        window.confirmLinkSlip = function () {
            if (window.currentLinkingBatchIdx === null || !window.tempVerifiedSlip) return;

            const batch = appState.productionQueue[window.currentLinkingBatchIdx];
            batch.productionSlipId = window.tempVerifiedSlip.id;
            batch.slipEmployee = window.tempVerifiedSlip.employee;

            saveState();
            renderProductionWIPView();
            closeLinkSlipModal();

            if (window.showToast) showToast(`Linked to ${batch.productionSlipId}`);
        };
    </script>

    <script>
        // ---------------------------------------------------------
        // COMPLETE BATCH PRODUCTION (UPDATED FOR TRACEABILITY)
        // ---------------------------------------------------------
        window.completeBatchProduction = function (idx) {
            if (!confirm("Are you sure you want to COMPLETE this production batch? This will add Finished Goods to stock.")) return;

            const batch = appState.productionQueue[idx];
            const today = new Date().toISOString();

            // 1. ADD TO FINISHED GOODS STOCK
            const fgItem = appState.inventory.finishedGoods.find(i => i.name === batch.itemName);
            if (fgItem) {
                // Fallback for simple
                fgItem.closingStock = (fgItem.closingStock || 0) + parseFloat(batch.targetQty);

                // Record "Receive" Transaction
                const tx = {
                    id: Date.now(),
                    date: today,
                    type: 'receive',
                    category: 'finishedGoods',
                    itemId: fgItem.id,
                    quantity: parseFloat(batch.targetQty),
                    itemName: fgItem.name,
                    batchNo: batch.batchNumber,
                    user: (appState.currentUser && appState.currentUser.username) || 'Production',
                    details: `Production Complete. ${batch.productionSlipId ? 'Ref: ' + batch.productionSlipId : ''}`
                };
                if (!appState.transactions) appState.transactions = [];
                appState.transactions.push(tx);

            } else {
                alert("Warning: Item name '" + batch.itemName + "' not found in Finished Goods. Stock not updated automatically.");
            }

            // 2. CLOSE MARK USED ON BACKEND (If Slip ID exists)
            if (batch.productionSlipId) {
                markSlipAsUsed(batch.productionSlipId, batch.batchNumber);
            }

            // 3. ARCHIVE BATCH
            batch.status = 'Completed';
            batch.completedDate = today;

            saveState();
            renderProductionWIPView();

            if (window.showToast) showToast("Batch Completed & Stock Updated");
        };

        window.markSlipAsUsed = function (slipId, batchNo) {
            const url = localStorage.getItem('GAS_URL');
            if (url) {
                const finalUrl = `${url}?action=mark_used&id=${encodeURIComponent(slipId)}&context=${encodeURIComponent(batchNo)}`;
                fetch(finalUrl).then(r => r.json()).then(d => console.log("Slip Marked:", d)).catch(e => console.error(e));
            }
        };

        // ---------------------------------------------------------
        // NEW BATCH MODAL (MISSING FUNCTION FIX)
        // ---------------------------------------------------------
        window.openNewBatchModal = function () {
            if (!appState.inventory || !appState.inventory.finishedGoods) { alert("Inventory not loaded"); return; }

            const html = `
        <div id="newBatchModal" class="fixed inset-0 bg-black bg-opacity-50 z-[100] flex justify-center items-center">
            <div class="bg-white p-6 rounded-lg w-96 shadow-xl">
                <h3 class="font-bold text-lg mb-4">Start New Batch</h3>
                
                <div class="mb-3">
                    <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Batch Number</label>
                    <input type="text" id="nb-batch" value="B-${Date.now().toString().substr(-6)}" class="w-full p-2 border rounded">
                </div>
                
                <div class="mb-3">
                    <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Product</label>
                    <select id="nb-product" class="w-full p-2 border rounded">
                        ${appState.inventory.finishedGoods.map(i => `<option value="${i.name}">${i.name}</option>`).join('')}
                    </select>
                </div>
                
                <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Target Quantity</label>
                    <input type="number" id="nb-qty" class="w-full p-2 border rounded" placeholder="e.g. 100">
                </div>

                <div class="flex justify-end gap-2">
                    <button onclick="document.getElementById('newBatchModal').remove()" class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded">Cancel</button>
                    <button onclick="confirmNewBatch()" class="px-4 py-2 bg-blue-600 text-white font-bold rounded hover:bg-blue-700">Start Batch</button>
                </div>
            </div>
        </div>`;
            document.body.insertAdjacentHTML('beforeend', html);
        };

        window.confirmNewBatch = function () {
            const batchNo = document.getElementById('nb-batch').value;
            const prod = document.getElementById('nb-product').value;
            const qty = document.getElementById('nb-qty').value;

            if (!batchNo || !prod || !qty) { alert("Please fill all fields"); return; }

            const item = appState.inventory.finishedGoods.find(i => i.name === prod);

            const newBatch = {
                id: Date.now(), // ESSENTIAL FOR COMPLEX MODALS
                batchNumber: batchNo,
                itemName: prod,
                itemId: item ? item.id : Date.now(),
                targetQty: qty,
                unit: item ? item.unit : 'Units',
                startDate: new Date().toISOString(),
                status: 'In Progress',
                productionSlipId: null
            };

            if (!appState.productionQueue) appState.productionQueue = [];
            appState.productionQueue.push(newBatch);
            saveState();
            renderProductionWIPView();
            document.getElementById('newBatchModal').remove();
        };

        // ---------------------------------------------------------
        // RENDER: PRODUCTION / WIP VIEW (NEW 2-COLUMN LAYOUT)
        // FIXED: Now uses activeProduction like the button handlers
        // ---------------------------------------------------------
        window.renderProductionWIPView = function () {
            const container = document.getElementById('production-wip-view');
            if (!container) return;

            // Ensure state
            if (!appState.activeProduction) appState.activeProduction = [];

            // CRITICAL FIX: Ensure all batches have IDs for complex modals
            let stateChanged = false;
            appState.activeProduction.forEach((b, i) => {
                if (!b.id) {
                    b.id = Date.now() + i;
                    stateChanged = true;
                }
            });
            if (stateChanged) saveState();

            const todayStr = new Date().toISOString().split('T')[0];

            let html = `
        <div class="flex flex-col md:flex-row gap-6 h-full pb-20">
            <!-- LEFT: START NEW PRODUCTION -->
            <div class="w-full md:w-1/3 bg-white p-6 rounded-xl shadow-sm border border-gray-200 h-fit">
                <h3 class="text-xl font-bold text-blue-700 mb-6 flex items-center gap-2">
                    Start New Production
                </h3>
                
                <div class="space-y-4">
                    <!-- DEBUG TOOLS -->
                    <div class="bg-red-50 p-2 border border-red-200 rounded text-xs">
                        <span class="font-bold text-red-600">DEBUG:</span>
                        <button onclick="alert('JS Alive! Funct is: ' + (typeof window.openBatchBOMModal)); console.log(window.openBatchBOMModal);" class="underline ml-2">
                            Check Buttons
                        </button>
                    </div>
                    <!-- NEW: AUTOMATED WORKFLOW -->
                    <div class="p-3 bg-indigo-50 border border-indigo-100 rounded-lg">
                        <label class="block text-xs font-bold text-indigo-800 uppercase mb-1 flex justify-between">
                            <span>Select Pending Slip</span>
                            <span class="text-[10px] font-normal cursor-pointer hover:underline" onclick="loadPendingProductionSlips()">Refresh List</span>
                        </label>
                        <div class="flex gap-2">
                            <select id="np-pending-slip" class="w-full p-2 border border-indigo-200 rounded text-sm font-bold text-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-500" onchange="onSelectPendingSlip(this)">
                                <option value="">-- Click Refresh to Load --</option>
                            </select>
                            <button onclick="loadPendingProductionSlips()" class="bg-indigo-600 text-white px-3 rounded hover:bg-indigo-700 shadow-sm" title="Refresh Pending Slips">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                            </button>
                            <button onclick="configureBackendURL()" class="bg-gray-200 text-gray-600 px-3 rounded hover:bg-gray-300 shadow-sm" title="Configure Backend URL">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                            </button>
                        </div>
                        <p class="text-[10px] text-indigo-500 mt-1 italic">Selecting a slip auto-fills the form below.</p>
                    </div>

                    <div class="relative py-2">
                         <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-200"></div></div>
                         <div class="relative flex justify-center"><span class="bg-white px-2 text-xs text-gray-400 font-bold uppercase">Or Manual Entry</span></div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Batch ID / Order Ref</label>
                        <input type="text" id="np-batch" value="B-${new Date().getFullYear()}-${Math.floor(Math.random() * 1000)}" class="w-full p-3 border rounded-lg font-mono text-gray-700 focus:ring-2 focus:ring-blue-500 outline-none">
                        <!-- HIDDEN SLIP ID STORAGE -->
                        <input type="hidden" id="np-slip-id" value="">
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Product Formula</label>
                        <select id="np-product" class="w-full p-3 border rounded-lg bg-gray-50 focus:bg-white transition-colors outline-none cursor-pointer">
                            <option value="">-- Select Product --</option>
                            ${appState.inventory.finishedGoods.map(i => `<option value="${i.name}">${i.name}</option>`).join('')}
                        </select>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Manufacturing Date</label>
                        <input type="date" id="np-date" value="${todayStr}" class="w-full p-3 border rounded-lg text-gray-700 outline-none">
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Target Quantity</label>
                        <input type="number" id="np-qty" class="w-full p-3 border rounded-lg text-gray-700 outline-none" placeholder="Qty to produce">
                    </div>

                    <div id="np-auth-display" class="hidden p-2 bg-green-50 text-green-700 text-xs rounded border border-green-200 mt-2 font-bold">
                        Authorized By: <span id="np-auth-name"></span>
                    </div>

                    <button onclick="createOrder()" class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg shadow-md transition-transform active:scale-95 mt-4">
                        Create Order
                    </button>
                </div>
            </div>

            <!-- RIGHT: ACTIVE PRODUCTION -->
            <div class="w-full md:w-2/3 space-y-4">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-sm font-bold text-gray-500 uppercase">Active Production</h3>
                    <div class="flex gap-2">
                         <button onclick="exportProductionHistory()" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded text-xs font-bold flex items-center gap-1">
                            ⬇ History
                         </button>
                              <span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full font-bold">Active: ${appState.activeProduction.filter(b => !['completed', 'cancelled'].includes((b.status || '').toLowerCase())).length}</span>
                    </div>
                </div>

                ${appState.activeProduction.length === 0 ?
                    `<div class="text-center py-10 text-gray-400 bg-gray-50 rounded-xl border-2 border-dashed">No active production batches.</div>` :
                    appState.activeProduction.slice().reverse().map((batch, idx) => {
                        // Original index correction since we reversed
                        const realIdx = appState.activeProduction.length - 1 - idx;

                        // PATCH ID IF MISSING
                        if (!batch.id) { batch.id = Date.now() + realIdx; }

                        // Style based on Status
                        const s = (batch.status || '').toLowerCase();
                        let statusColor = 'blue';
                        if (s === 'completed') statusColor = 'green';
                        if (s === 'paused') statusColor = 'yellow';
                        if (s === 'cancelled') statusColor = 'red';

                        const isReserved = batch.reservedData && (batch.reservedData.rawMaterials?.length || batch.reservedData.packingMaterials?.length);
                        // Logic check: "reservedData" presence implies reservation. The V34 'isReserved' flag was simple boolean.
                        // We'll trust 'isReserved' OR reservedData presence.
                        const hasReservation = isReserved || batch.isReserved;
                        const reservedBadge = hasReservation ? `<span class="bg-purple-600 text-white text-[10px] px-2 py-0.5 rounded uppercase font-bold tracking-wider">Reserved</span>` : '';

                        return `
                        <div class="bg-white rounded-xl shadow-sm border ${hasReservation ? 'border-purple-200' : 'border-gray-200'} p-0 overflow-hidden relative">
                            <!-- Top Bar -->
                            <div class="p-4 flex justify-between items-start bg-gray-50 border-b">
                                <div>
                                    <div class="flex items-center gap-2">
                                         <h4 class="font-bold text-lg text-gray-800">${batch.itemName || batch.product || batch.name || 'Unknown Item'}</h4>
                                         <span class="px-2 py-0.5 rounded-full text-xs font-bold bg-${statusColor}-100 text-${statusColor}-700 border border-${statusColor}-200">${batch.status || 'In Progress'}</span>
                                    </div>
                                    <div class="flex items-center gap-2 text-xs text-gray-400 mt-1">
                                        <span class="font-mono bg-gray-200 px-1.5 rounded text-gray-700">Ref: ${batch.batchNumber || batch.batchNo || 'N/A'}</span>
                                        <span>${new Date(batch.startDate).toLocaleDateString()}</span>
                                        ${reservedBadge}
                                    </div>
                                </div>
                                <div class="text-right">
                                     <!-- Status Indicator -->
                                </div>
                            </div>

                            <!-- Metrics -->
                            <div class="p-4 grid grid-cols-3 gap-4 text-center border-b border-gray-50">
                                <div>
                                    <div class="text-[10px] font-bold text-gray-400 uppercase">Target Qty</div>
                                    <div class="font-bold text-gray-800 text-lg">${batch.targetQty}</div>
                                </div>
                                <div>
                                    <div class="text-[10px] font-bold text-gray-400 uppercase">Produced</div>
                                    <div class="font-bold text-green-600 text-lg">${batch.producedQty || 0}</div>
                                </div>
                                <div>
                                    <div class="text-[10px] font-bold text-gray-400 uppercase">Slips</div>
                                    <div class="font-bold text-blue-600 text-lg">${(batch.consumptionSlips || []).length}</div>
                                </div>
                            </div>

                            <!-- Actions Toolbar (FIXED: Complex Modals) -->
                            <div class="p-2 bg-gray-50 flex flex-wrap gap-2 justify-end">
                                
                                <button onclick="openConsumptionSlipModal(${batch.id})" class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold rounded shadow-sm flex items-center gap-1">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                                    Log Slip
                                </button>
 
                                <button onclick="${s === 'paused' ? 'resumeProduction' : 'openPauseModal'}(${batch.id})" class="px-3 py-1.5 ${s === 'paused' ? 'bg-green-500 hover:bg-green-600' : 'bg-yellow-500 hover:bg-yellow-600'} text-white text-xs font-bold rounded shadow-sm">
                                    ${s === 'paused' ? '▶️ Resume' : '⏸️ Pause'}
                                </button>

                                <button onclick="completeBatch(${batch.id})" class="px-3 py-1.5 bg-green-600 hover:bg-green-700 text-white text-xs font-bold rounded shadow-sm">
                                    ✅ Complete
                                </button>
                                
                                <button onclick="openBatchBOMModal(${batch.id})" class="px-3 py-1.5 bg-purple-600 hover:bg-purple-700 text-white text-xs font-bold rounded shadow-sm">
                                    Reserved
                                </button>

                                <button onclick="cancelBatch(${batch.id})" class="px-3 py-1.5 bg-red-100 hover:bg-red-200 text-red-600 text-xs font-bold rounded border border-red-200">
                                    Cancel
                                </button>
                            </div>
                        </div>`;
                    }).join('')
                }
            </div>
        </div>

        <!-- STUB FOR HISTORY TABLE (User didn't explicitly ask for it but image had it. We focus on Active first) -->

        <!-- Link Slip Modal (Preserved) -->
        `;

            // Modal for Link Slip (Ensure it's there)
            if (!document.getElementById('linkSlipModal')) {
                const modalHtml = `
             <div id="linkSlipModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[100] flex justify-center items-center">
                <div class="bg-white rounded-xl shadow-2xl p-6 w-96">
                    <h3 class="text-lg font-bold mb-4">Link Production Slip</h3>
                    <p class="text-sm text-gray-500 mb-4">Enter Slip ID (e.g. PROD-1234)</p>
                    <div class="mb-4">
                        <input type="text" id="link-slip-id" class="w-full p-2 border rounded font-bold uppercase mb-2" placeholder="PROD-...">
                        <button onclick="verifySlipId()" class="w-full bg-blue-600 text-white py-2 rounded font-bold hover:bg-blue-700 text-sm">Verify ID</button>
                        <div id="link-slip-result" class="mt-2 text-xs h-4 text-center"></div>
                    </div>
                    <div class="flex justify-end gap-2 border-t pt-4">
                        <button onclick="closeLinkSlipModal()" class="text-gray-500 hover:bg-gray-100 px-4 py-2 rounded">Cancel</button>
                        <button onclick="confirmLinkSlip()" id="btn-confirm-link" disabled class="bg-green-600 text-white px-4 py-2 rounded font-bold opacity-50 cursor-not-allowed">Link</button>
                    </div>
                </div>
             </div>`;
                document.body.insertAdjacentHTML('beforeend', modalHtml);
            }

            container.innerHTML = html;
        };

        // ---------------------------------------------------------
        // PRODUCTION LOGIC HELPERS
        // ---------------------------------------------------------

        // ADDED: Missing togglePauseBatch function for V34 UI
        window.togglePauseBatch = function (batchId) {
            const batch = appState.activeProduction?.find(b => b.id == batchId);
            if (!batch) {
                console.error("Batch not found:", batchId);
                if (window.showAlert) showAlert("Batch not found!");
                return;
            }

            if (batch.status === 'paused' || batch.status === 'Paused') {
                // Resume - set back to started
                batch.status = 'started';
                if (!batch.statusHistory) batch.statusHistory = [];
                batch.statusHistory.push({ date: new Date().toISOString(), status: 'started', reason: 'Resumed production' });
                if (window.showAlert) showAlert("Production Resumed!");
            } else {
                // Pause
                batch.status = 'paused';
                batch.pausedDate = new Date().toISOString();
                if (!batch.statusHistory) batch.statusHistory = [];
                batch.statusHistory.push({ date: new Date().toISOString(), status: 'paused', reason: 'Production paused' });
                if (window.showAlert) showAlert("Production Paused!");
            }

            saveState();
            renderProductionWIPView();
        };

        // --- PARTIAL / SMART COMPLETION ---
        let currentCompletingBatchId = null;

        window.completeBatch = function (batchId) {
            // Opens completion modal for a batch
            const batch = appState.activeProduction.find(b => b.id == batchId);
            if (!batch) return;
            currentCompletingBatchId = batchId;

            // Populate Modal
            const formula = appState.formulas.find(f => f.id == batch.formulaId);
            const formulaName = formula ? formula.name : "Unknown Product";

            document.getElementById('comp-batch-title').textContent = `Complete Production: ${batch.batchNumber || batch.batchNo}`;
            document.getElementById('comp-prod-name').textContent = formulaName;

            // Target vs Actual Produce
            document.getElementById('comp-target-qty').value = batch.targetQty;
            document.getElementById('comp-actual-qty').value = batch.targetQty; // Default to target

            // Ingredients Table
            const tbody = document.getElementById('comp-ing-rows');
            tbody.innerHTML = '';

            const addRow = (itemData, cat) => {
                const item = findItem(cat, itemData.itemId);
                if (!item) return;
                tbody.innerHTML += `
            <tr class="border-b" data-cat="${cat}" data-id="${item.id}">
                <td class="p-2 text-sm">${item.name} <span class="text-xs text-gray-400">(${cat === 'rawMaterials' ? 'RM' : cat === 'packingMaterials' ? 'PM' : 'LB'})</span></td>
                <td class="p-2 text-right text-sm text-gray-500">${itemData.quantity.toFixed(3)}</td>
                <td class="p-2"><input type="number" step="any" value="${itemData.quantity}" class="comp-consume-input w-full p-1 border rounded text-right bg-blue-50"></td>
                <td class="p-2"><input type="number" step="any" value="0" class="comp-waste-input w-full p-1 border rounded text-right text-gray-400 placeholder-gray-300" placeholder="0"></td>
            </tr>
            `;
            };

            if (batch.reservedData) {
                (batch.reservedData.rawMaterials || []).forEach(i => addRow(i, 'rawMaterials'));
                (batch.reservedData.packingMaterials || []).forEach(i => addRow(i, 'packingMaterials'));
                (batch.reservedData.labels || []).forEach(i => addRow(i, 'labels'));
            }

            openModal('completeBatchModal');
        };

        window.confirmCompleteBatch = function () {
            if (!currentCompletingBatchId) return;
            const batch = appState.activeProduction.find(b => b.id == currentCompletingBatchId);
            if (!batch) return;

            const actualProduceQty = parseFloat(document.getElementById('comp-actual-qty').value) || 0;
            const expiryDate = document.getElementById('comp-expiry-date')?.value || '';

            if (actualProduceQty <= 0) { showAlert("Produced Quantity must be greater than 0"); return; }

            // Collect Consumed Data
            const rows = document.querySelectorAll('#comp-ing-rows tr');
            const actualConsumptions = [];

            rows.forEach(row => {
                const cat = row.dataset.cat;
                const itemId = parseFloat(row.dataset.id);
                const consumedQty = parseFloat(row.querySelector('.comp-consume-input').value) || 0;
                const wasteQty = parseFloat(row.querySelector('.comp-waste-input').value) || 0;

                if (consumedQty > 0 || wasteQty > 0) {
                    actualConsumptions.push({ cat, itemId, qty: consumedQty, waste: wasteQty });
                }
            });

            // Execute Transactions
            const date = new Date().toISOString();

            // 1. Release Reservations (Close Audit Loop)
            const logRelease = (list, cat) => {
                (list || []).forEach(item => {
                    appState.transactions.push({
                        id: Date.now() + Math.random(),
                        itemId: item.itemId,
                        category: cat,
                        type: 'production-release',
                        quantity: item.quantity,
                        date: date,
                        batchNo: batch.batchNumber || batch.batchNo,
                        notes: "Reservation Converted to Consumption"
                    });
                });
            };
            if ((batch.status === 'started' || batch.status === 'In Progress') && batch.reservedData) {
                logRelease(batch.reservedData.rawMaterials, 'rawMaterials');
                logRelease(batch.reservedData.packingMaterials, 'packingMaterials');
                logRelease(batch.reservedData.labels, 'labels');
            }

            // 2. Consumptions (Actuals)
            actualConsumptions.forEach(c => {
                appState.transactions.push({
                    id: Date.now() + Math.random(),
                    itemId: c.itemId,
                    category: c.cat,
                    type: 'production-consume',
                    quantity: c.qty,
                    date: date,
                    batchNo: batch.batchNumber || batch.batchNo,
                    fgBatchId: batch.batchNumber || batch.batchNo, // CRITICAL: Link for Traceability Dashboard
                    subtype: c.waste > 0 ? 'includes-wastage' : 'standard',
                    notes: `Used for ${batch.itemName || 'Production'} (Batch ${batch.batchNumber || batch.batchNo})${c.waste > 0 ? ' [Waste: ' + c.waste + ']' : ''}`
                });
            });

            // 3. Production Add (Finished Good)
            const formula = appState.formulas.find(f => f.id == batch.formulaId);

            // Smart Fallback: If formula logic is broken/unlinked, try to find FG by Name
            let fgItem = null;
            if (formula) {
                fgItem = appState.inventory.finishedGoods.find(i => i.name === formula.name);
            }

            // Manual/Fallback Match
            if (!fgItem) {
                const manualName = batch.itemName || batch.productName || (formula ? formula.name : '');
                if (manualName) {
                    fgItem = appState.inventory.finishedGoods.find(i => i.name === manualName);
                }
            }

            // If still missing, check if "Unknown Product" needs handling, but alerting user is better if we really can't find it.

            if (fgItem) {
                appState.transactions.push({
                    id: Date.now() + Math.random(),
                    itemId: fgItem.id,
                    category: 'finishedGoods',
                    type: 'production-add',
                    quantity: actualProduceQty,
                    date: date,
                    batchNo: batch.batchNumber || batch.batchNo,
                    mfgDate: date,
                    expiryDate: expiryDate
                });
            } else {
                console.warn("Warning: FG Item not found for " + (formula ? formula.name : 'Unknown'));
            }

            // 3.5 CLOSE MARK USED ON BACKEND (Sync with Requisition App)
            if (batch.productionSlipId && window.markSlipAsUsed) {
                window.markSlipAsUsed(batch.productionSlipId, batch.batchNumber || batch.batchNo);
            }

            // 4. Archive to Production History
            if (!appState.productionHistory) appState.productionHistory = [];
            const completedBatch = { ...batch };
            completedBatch.status = 'completed';
            completedBatch.completedDate = date;
            completedBatch.actualProducedQty = actualProduceQty;
            completedBatch.actualConsumptions = actualConsumptions;
            appState.productionHistory.push(completedBatch);

            // 5. Remove from Active Production
            appState.activeProduction = appState.activeProduction.filter(b => b.id != currentCompletingBatchId);

            saveState();
            closeModal('completeBatchModal');
            renderProductionWIPView();
            showAlert(`Batch ${batch.batchNumber || batch.batchNo} Completed!\nProduced: ${actualProduceQty}\nStock Consumed, Reservation Released & FG Added.`);

            currentCompletingBatchId = null;
        };

        // Show Production History (completed batches)
        window.exportProductionHistory = function () {
            const history = appState.productionHistory || [];

            if (history.length === 0) {
                showAlert("No completed production history available related to the newly implemented system. (Old completed batches may not be tracked yet).");
                return;
            }

            // Build HTML for history display
            let html = '<div class="max-h-96 overflow-y-auto">';
            html += '<table class="w-full text-sm border">';
            html += '<thead class="bg-gray-100 sticky top-0"><tr>';
            html += '<th class="p-2 text-left border">Batch No</th>';
            html += '<th class="p-2 text-left border">Product</th>';
            html += '<th class="p-2 text-right border">Produced</th>';
            html += '<th class="p-2 text-left border">Completed</th>';
            html += '</tr></thead><tbody>';

            history.slice().reverse().forEach(batch => {
                const formula = appState.formulas.find(f => f.id == batch.formulaId);
                const productName = formula ? formula.name : (batch.itemName || 'Unknown');
                html += `<tr class="border-b hover:bg-gray-50">
                <td class="p-2 border font-mono font-bold">${batch.batchNumber || batch.batchNo || '-'}</td>
                <td class="p-2 border">${productName}</td>
                <td class="p-2 border text-right text-green-600 font-bold">${batch.actualProducedQty || batch.producedQty || '-'}</td>
                <td class="p-2 border text-xs text-gray-500">${batch.completedDate ? new Date(batch.completedDate).toLocaleDateString() : '-'}</td>
            </tr>`;
            });

            html += '</tbody></table></div>';

            // Show in generic modal
            document.getElementById('generic-modal-title').textContent = '📜 Completed Production History';
            document.getElementById('generic-modal-message').textContent = `Showing ${history.length} completed production batch(es)`;
            document.getElementById('generic-message-content').innerHTML = html;
            document.getElementById('generic-modal-cancel').classList.add('hidden');
            openModal('genericMessageModal');
        };

        window.loadPendingProductionSlips = async function () {
            const sel = document.getElementById('np-pending-slip');
            if (!sel) return;

            sel.innerHTML = '<option>Loading...</option>';

            const url = localStorage.getItem('GAS_URL');
            if (!url) {
                sel.innerHTML = '<option>No Backend URL - Click Settings ⚙️</option>';
                return;
            }

            try {
                const resp = await fetch(`${url}?action=get_pending_production&_t=${Date.now()}`);
                const json = await resp.json();

                if (json.result === 'success') {
                    appState.pendingSlips = json.pending || [];
                    if (appState.pendingSlips.length === 0) {
                        sel.innerHTML = '<option value="">No Pending Slip</option>';
                        return;
                    }

                    sel.innerHTML = '<option value="">-- Select Pending Slip --</option>';
                    appState.pendingSlips.forEach((slip, idx) => {
                        // Create label: "PROD-123 - Item Name" OR "PROD-123 - Employee Name"
                        let nameDisplay = (slip.itemName && slip.itemName !== 'Unknown') ? slip.itemName : (slip.employee || 'Unknown');

                        let label = `${slip.id} - ${nameDisplay}`;

                        // Try to parse qty
                        try {
                            let items = JSON.parse(slip.items);
                            if (items[0] && items[0].qty) label += ` (${items[0].qty})`;
                        } catch (e) { }

                        const opt = document.createElement('option');
                        opt.value = idx; // Store index to retrieve object
                        opt.text = label;
                        sel.appendChild(opt);
                    });
                } else {
                    sel.innerHTML = '<option>Error loading list</option>';
                }
            } catch (e) {
                console.error(e);
                sel.innerHTML = '<option>Connection Error</option>';
            }
        };

        window.onSelectPendingSlip = function (sel) {
            const idx = sel.value;
            if (idx === "") return;

            const slip = appState.pendingSlips[idx];
            if (!slip) return;

            // Auto-Fill Form
            // 1. Batch ID -> Suggest something linked? Or keep random? 
            // Let's append slip ID to batch for traceability: "B-2024-PROD-123"
            document.getElementById('np-batch').value = `B-${new Date().getFullYear()}-${slip.id}`;

            // 2. Product
            const prodSelect = document.getElementById('np-product');
            // Try to match name
            if (slip.itemName) {
                // Find closest match or exact
                for (let i = 0; i < prodSelect.options.length; i++) {
                    if (prodSelect.options[i].text === slip.itemName) {
                        prodSelect.selectedIndex = i;
                        break;
                    }
                }
            }

            // 3. Qty
            try {
                const items = JSON.parse(slip.items);
                if (items && items.length > 0) {
                    document.getElementById('np-qty').value = items[0].qty;
                }
            } catch (e) { }

            // 4. Hidden Slip ID
            document.getElementById('np-slip-id').value = slip.id;

            // 5. Auth Display
            document.getElementById('np-auth-display').classList.remove('hidden');
            document.getElementById('np-auth-name').textContent = slip.employee + (slip.approver ? ` (Appr: ${slip.approver})` : '');
        };

        // --- CONFIGURATION ---
        window.configureBackendURL = function () {
            const current = localStorage.getItem('GAS_URL') || localStorage.getItem('inventoryCloudUrl') || '';
            const url = prompt("Enter Google Apps Script Web App URL:", current);
            if (url && url.startsWith('http')) {
                localStorage.setItem('GAS_URL', url.trim());
                localStorage.setItem('inventoryCloudUrl', url.trim()); // Sync both keys

                alert("URL Saved! Refreshing list...");
                loadPendingProductionSlips();
            } else if (url !== null) {
                alert("Invalid URL. Please enter a valid web app URL.");
            }
        };

        window.createOrder = function () {
            const batchNo = document.getElementById('np-batch').value;
            const prod = document.getElementById('np-product').value;
            const date = document.getElementById('np-date').value;
            const qty = document.getElementById('np-qty').value;
            // NEW:
            const slipId = document.getElementById('np-slip-id').value;
            const authName = document.getElementById('np-auth-name').textContent;

            if (!batchNo || !prod || !qty) { alert("Please fill all fields."); return; }

            const item = appState.inventory.finishedGoods.find(i => i.name === prod);

            const newBatch = {
                id: Date.now(), // ESSENTIAL
                batchNumber: batchNo,
                itemName: prod,
                itemId: item ? item.id : Date.now(),
                targetQty: qty,
                unit: item ? item.unit : 'Units',
                startDate: date || new Date().toISOString(),
                status: 'In Progress',
                productionSlipId: slipId || null, // USE HIDDEN ID
                slipEmployee: slipId ? authName : null, // Store Auth Name mainly
                isReserved: false
            };

            // NEW: Link Formula & Calculate Reservations
            // DEBUG: Alert to show what we are looking for
            // console.log("Searching for formula matching:", prod);

            const formula = appState.formulas.find(f => f.name === prod || f.productName === prod);

            if (formula) {
                newBatch.formulaId = formula.id;
                newBatch.isReserved = true;

                // Calculate Requirements - ROBUST METHOD FROM BACKUP
                const baseQty = parseFloat(formula.outputQty || formula.baseQuantity || 1);
                const target = parseFloat(qty);
                const ratio = target / baseQty;

                // Helper to map ingredients safely
                const mapIng = (list) => (list || []).map(i => ({
                    itemId: i.itemId,
                    quantity: (parseFloat(i.quantity) || 0) * ratio
                }));

                newBatch.reservedData = {
                    rawMaterials: mapIng(formula.ingredients),
                    packingMaterials: mapIng(formula.packingMaterials),
                    labels: mapIng(formula.labels)
                };

                // alert(`DEBUG: Batch created with ${newBatch.reservedData.rawMaterials.length} raw materials reserved.`); 
            } else {
                const available = appState.formulas.map(f => f.name).join(", ");
                alert(`DEBUG: Formula NOT Found for '${prod}'.\nAvailable Formulas: ${available}\n\nPlease check exact spelling.`);

                // Fallback: Empty structures to prevent crashes
                newBatch.reservedData = { rawMaterials: [], packingMaterials: [], labels: [] };
                newBatch.isReserved = false;
            }

            if (!appState.activeProduction) appState.activeProduction = [];
            appState.activeProduction.push(newBatch);
            saveState();
            renderProductionWIPView();

            // Reset Form
            document.getElementById('np-batch').value = `B-${new Date().getFullYear()}-${Math.floor(Math.random() * 1000)}`;
            document.getElementById('np-qty').value = '';
            document.getElementById('np-slip-id').value = ''; // Clear hidden
            document.getElementById('np-auth-display').classList.add('hidden'); // Hide auth

            if (window.showToast) showToast("Order Created with Slip Linked");
        };

        // [DELETED] Legacy duplicates of togglePauseBatch, toggleReserved, cancelBatch, completeBatchProduction
        // These were conflicting with the updated logic at the top of the file.

        window.markSlipAsUsed = function (slipId, batchNo) {
            const url = localStorage.getItem('GAS_URL');
            if (url) {
                const finalUrl = `${url}?action=mark_used&id=${encodeURIComponent(slipId)}&context=${encodeURIComponent(batchNo)}`;
                fetch(finalUrl).then(r => r.json()).then(d => console.log("Slip Marked:", d)).catch(e => console.error(e));
            }
        };

        // TRACEABILITY OVERRIDES
        window.currentLinkingBatchIdx = null;
        window.tempVerifiedSlip = null;

        window.linkProductionSlip = function (idx) {
            window.currentLinkingBatchIdx = idx;
            document.getElementById('linkSlipModal').classList.remove('hidden');
            document.getElementById('link-slip-id').value = '';
            document.getElementById('link-slip-result').innerHTML = '';
            document.getElementById('btn-confirm-link').disabled = true;
            document.getElementById('btn-confirm-link').classList.add('opacity-50', 'cursor-not-allowed');
            window.tempVerifiedSlip = null;
        };

        window.closeLinkSlipModal = function () {
            document.getElementById('linkSlipModal').classList.add('hidden');
        };

        window.verifySlipId = async function () {
            const id = document.getElementById('link-slip-id').value.trim();
            const resDiv = document.getElementById('link-slip-result');
            if (!id) { resDiv.innerHTML = '<span class="text-red-500">Please enter an ID</span>'; return; }
            resDiv.innerHTML = '<span class="text-blue-500 animate-pulse">Checking database...</span>';
            const url = localStorage.getItem('GAS_URL');
            if (!url) { resDiv.innerHTML = '<span class="text-red-500">Backend System Not Configured!</span>'; return; }
            try {
                const finalUrl = `${url}?action=get_req_details&id=${encodeURIComponent(id)}`;
                const resp = await fetch(finalUrl);
                const json = await resp.json();
                if (json.result === 'success') {
                    const data = json.data;
                    resDiv.innerHTML = `<span class="text-green-600 font-bold">✅ Verified: ${data.employee} (${data.type})</span>`;
                    window.tempVerifiedSlip = data;
                    const btn = document.getElementById('btn-confirm-link');
                    btn.disabled = false;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    btn.classList.add('hover:bg-green-700');
                } else {
                    resDiv.innerHTML = `<span class="text-red-500">❌ ID Not Found</span>`;
                    window.tempVerifiedSlip = null;
                }
            } catch (e) {
                resDiv.innerHTML = `<span class="text-red-500">Connection Error</span>`;
            }
        };

        window.confirmLinkSlip = function () {
            if (window.currentLinkingBatchIdx === null || !window.tempVerifiedSlip) return;
            const batch = appState.activeProduction[window.currentLinkingBatchIdx];
            batch.productionSlipId = window.tempVerifiedSlip.id;
            batch.slipEmployee = window.tempVerifiedSlip.employee;
            saveState();
            renderProductionWIPView();
            closeLinkSlipModal();
            if (window.showToast) showToast(`Linked to ${batch.productionSlipId}`);
        };
    </script>


    <script>
        // ================================================================
        // FEATURE PACK V13: CONSOLIDATED FORMULA TOOLS (Namespace Fix)
        // Antigravity AI - V13.0
        // ================================================================
        console.log("ANTIGRAVITY: Loading Feature Pack V13 (Namespace Fix)...");

        // ----------------------------------------------------------------
        // 1. IMPORT MODAL (Unique ID V13)
        // ----------------------------------------------------------------
        window.injectImportFormulaModal_v13 = function () {
            // Remove ANY old modals to prevent confusion
            const old1 = document.getElementById('importFormulaModal');
            if (old1) old1.remove();
            const old2 = document.getElementById('importFormulaModal_v13');
            if (old2) old2.remove();

            const modalHTML = `
        <div id="importFormulaModal_v13" class="modal fixed inset-0 bg-black bg-opacity-50 justify-center items-center z-50 hidden backdrop-blur-sm">
            <div class="bg-white p-6 md:p-8 rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto animated fadeIn">
                <div class="flex justify-between items-center mb-6 border-b pb-4">
                    <h3 class="text-2xl font-bold text-indigo-700 flex items-center gap-2">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                        Import Formulas
                    </h3>
                    <button onclick="closeModal('importFormulaModal_v13')" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
                </div>

                <div class="mb-6 bg-blue-50 p-4 rounded-lg border border-blue-100 text-sm text-blue-800">
                    <p class="font-bold mb-2">Instructions:</p>
                    <ul class="list-disc pl-5 space-y-1">
                        <li>Paste CSV data below. Header row is optional but skipped if detected.</li>
                        <li><b>Columns:</b> Formula Name, Output Qty, Output Unit, Item Type, Item Name, Item Qty</li>
                        <li><b>Item Types:</b> Raw, Packing, Label (Case Insensitive)</li>
                    </ul>
                    <code class="block bg-white p-2 rounded border border-blue-200 mt-2 text-xs font-mono select-all">
                        My Cleaner, 1000, L, Raw, SLES 70%, 150.5<br>
                        My Cleaner, 1000, L, Raw, Water, 800<br>
                        My Cleaner, 1000, L, Packing, Bottle 1L, 1000
                    </code>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-bold mb-2">Paste CSV Data</label>
                    <textarea id="import-csv-data_v13" class="w-full h-64 p-4 border-2 border-indigo-100 rounded-lg focus:border-indigo-500 outline-none font-mono text-sm" placeholder="Paste data here..."></textarea>
                </div>

                <div class="flex justify-between items-center pt-4 border-t">
                    <button type="button" onclick="closeModal('importFormulaModal_v13')" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-bold transition-colors">Cancel</button>
                    <button type="button" onclick="parseAndImportFormulas_v13()" class="px-8 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-bold shadow-lg transform active:scale-95 transition-all">Start Import</button>
                </div>
            </div>
        </div>`;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        };

        // ----------------------------------------------------------------
        // 2. IMPORT LOGIC (Namespaced V13)
        // ----------------------------------------------------------------
        window.parseAndImportFormulas_v13 = function () {
            try {
                // UNIQUE ID LOOKUP
                const rawEl = document.getElementById('import-csv-data_v13');
                if (!rawEl) { alert("Error: Text box 'import-csv-data_v13' not found."); return; }

                const raw = rawEl.value.trim();
                if (!raw) { alert("Please paste data into the text box first."); return; }

                const lines = raw.split(/\r?\n/);
                const formulasMap = {};
                let successCount = 0;
                let skipCount = 0;

                const findID = (name, type) => {
                    let cat = '';
                    const t = type.toLowerCase();
                    if (t.includes('raw')) cat = 'rawMaterials';
                    else if (t.includes('pack')) cat = 'packingMaterials';
                    else if (t.includes('label')) cat = 'labels';
                    else return null;

                    const list = appState.inventory[cat] || [];
                    const search = name.trim().toLowerCase();
                    let item = list.find(i => i.name.trim().toLowerCase() === search);
                    return item ? item.id : null;
                };

                lines.forEach((line, idx) => {
                    if (idx === 0 && line.toLowerCase().includes('formula name')) return;
                    if (!line.trim()) return;

                    const cols = line.split(',').map(s => s.trim());
                    if (cols.length < 6) return;

                    const [fName, outQty, outUnit, iType, iName, iQty] = cols;

                    if (!formulasMap[fName]) {
                        formulasMap[fName] = {
                            id: Date.now() + Math.floor(Math.random() * 1000000),
                            name: fName,
                            outputQty: parseFloat(outQty) || 1,
                            outputUnit: outUnit || 'Unit',
                            ingredients: [],
                            packingMaterials: [],
                            labels: []
                        };
                    }

                    const formula = formulasMap[fName];
                    const itemId = findID(iName, iType);
                    const qtyVal = parseFloat(iQty);

                    if (itemId && !isNaN(qtyVal) && qtyVal > 0) {
                        const entry = { itemId: itemId, quantity: qtyVal };
                        const t = iType.toLowerCase();
                        if (t.includes('raw')) formula.ingredients.push(entry);
                        else if (t.includes('pack')) formula.packingMaterials.push(entry);
                        else if (t.includes('label')) formula.labels.push(entry);
                    } else {
                        console.warn(`Skipping item '${iName}' in '${fName}': Not found or invalid qty.`);
                        skipCount++;
                    }
                });

                const finalFormulas = Object.values(formulasMap);
                if (finalFormulas.length === 0) { alert("No valid formulas found to import."); return; }

                if (!appState.formulas) appState.formulas = [];

                finalFormulas.forEach(f => {
                    f.id = Date.now() + Math.random().toString(36).substr(2, 9);
                    appState.formulas.push(f);
                    successCount++;
                });

                saveState();
                closeModal('importFormulaModal_v13');
                if (window.renderFormulationsView) renderFormulationsView();

                alert(`Succesfully Imported ${successCount} Formulas!\nNote: ${skipCount} items were skipped.`);

            } catch (e) {
                console.error(e);
                alert("Import Error: " + e.message);
            }
        };

        // ----------------------------------------------------------------
        // 3. EDIT & SAVE LOGIC (Re-implemented)
        // ----------------------------------------------------------------
        window.openFormulaModal = function (formulaId = null) {
            // Ensure Modal Exists
            const modal = document.getElementById('formulaModal');
            if (!modal) { alert("Critical Error: 'formulaModal' structure missing from HTML."); return; }

            // Clean Reset
            document.getElementById('formula-form').reset();
            document.getElementById('ingredients-container').innerHTML = '<h4 class="font-medium text-gray-800 mt-4">Raw Materials</h4>';
            document.getElementById('packing-container').innerHTML = '<h4 class="font-medium text-gray-800 mt-4">Packing Materials</h4>';
            document.getElementById('labels-container').innerHTML = '<h4 class="font-medium text-gray-800 mt-4">Labels</h4>';
            document.getElementById('edit-formula-id').value = '';

            document.getElementById('formula-modal-title').textContent = formulaId ? "Edit Formula" : "Add New Product Formula";

            if (formulaId) {
                const formula = appState.formulas.find(f => f.id == formulaId);
                if (!formula) { alert("Formula not found!"); return; }

                document.getElementById('edit-formula-id').value = formula.id;
                document.getElementById('formula-name').value = formula.name;
                document.getElementById('formula-output-qty').value = formula.outputQty || 1;
                document.getElementById('formula-output-unit').value = formula.outputUnit || 'Unit';

                // Helpers
                const add = (item, cont, type) => addIngredientInputRaw(item, cont, type);
                if (formula.ingredients) formula.ingredients.forEach(i => add(i, 'ingredients-container', 'Raw'));
                if (formula.packingMaterials) formula.packingMaterials.forEach(i => add(i, 'packing-container', 'Packing'));
                if (formula.labels) formula.labels.forEach(i => add(i, 'labels-container', 'Label'));
            }

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        };

        window.editFormula = function (id) {
            window.openFormulaModal(id);
        };

        // Helper to generate rows safely
        window.addIngredientInputRaw = function (data = null, containerId, typeLabel) {
            const container = document.getElementById(containerId);
            if (!container) return;

            const div = document.createElement('div');
            div.className = "flex gap-2 mt-2 items-center";

            let category = 'rawMaterials';
            if (typeLabel === 'Packing') category = 'packingMaterials';
            if (typeLabel === 'Label') category = 'labels';

            const items = appState.inventory[category] || [];
            const sortedItems = [...items].sort((a, b) => a.name.localeCompare(b.name));

            const options = sortedItems.map(i => `<option value="${i.id}" ${data && data.itemId == i.id ? 'selected' : ''}>${i.name}</option>`).join('');

            div.innerHTML = `
            <select class="p-2 border rounded-md flex-1 text-sm font-mono bg-gray-50 focus:bg-white formula-item-select" data-category="${category}">
                <option value="">-- Select ${typeLabel} --</option>
                ${options}
            </select>
            <input type="number" step="any" class="w-24 p-2 border rounded-md text-right font-bold formula-item-qty" placeholder="Qty" value="${data ? data.quantity : ''}">
            <button type="button" onclick="this.parentElement.remove()" class="text-red-500 hover:text-red-700 font-bold px-2">&times;</button>
        `;
            container.appendChild(div);
        };

        // Override global adders
        window.addIngredientInput = () => addIngredientInputRaw(null, 'ingredients-container', 'Raw');
        window.addPackingInput = () => addIngredientInputRaw(null, 'packing-container', 'Packing');
        window.addLabelInput = () => addIngredientInputRaw(null, 'labels-container', 'Label');

        // ----------------------------------------------------------------
        // 4. DUPLICATE & DELETE & RENDER
        // ----------------------------------------------------------------
        window.duplicateFormula = function (id) {
            const source = appState.formulas.find(f => f.id == id);
            if (!source) return;
            if (!confirm(`Duplicate formula '${source.name}'?`)) return;

            const copy = JSON.parse(JSON.stringify(source));
            copy.id = Date.now() + Math.random().toString(36).substr(2, 5);
            copy.name = `${source.name} (Copy)`;
            appState.formulas.push(copy);
            saveState();
            if (window.renderFormulationsView) renderFormulationsView();
            if (window.showToast) showToast("Formula Duplicated!");
        };

        window.deleteFormula = function (id) {
            if (!confirm("Are you sure you want to delete this formula?")) return;
            const idx = appState.formulas.findIndex(f => f.id == id);
            if (idx > -1) {
                appState.formulas.splice(idx, 1);
                saveState();
                if (window.renderFormulationsView) renderFormulationsView();
                if (window.showToast) showToast("Formula Deleted.");
            }
        };

        window.renderFormulationsView = function () {
            const container = document.getElementById('formulations-view');
            if (!container) return;

            container.innerHTML = `
        <div class="h-full flex flex-col p-6 overflow-y-auto bg-gray-50">
            <div class="flex justify-between items-center mb-6">
                <div>
                     <h2 class="text-3xl font-bold text-gray-800 flex items-center gap-2">
                        <svg class="w-8 h-8 text-teal-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547a2 2 0 00-.547 1.806l.477 2.387a6 6 0 00.517 3.86l.158.318a6 6 0 003.86.517l2.387.477a2 2 0 001.806-.547a2 2 0 00.547-1.806l-.477-2.387a6 6 0 00-.517-3.86l-.158-.318a6 6 0 01-.517-3.86l2.387-.477a2 2 0 001.022-.547z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8a2.5 2.5 0 110-5 2.5 2.5 0 010 5z"></path></svg>
                        Formulations
                    </h2>
                    <p class="text-sm text-gray-500 mt-1">${(appState.formulas || []).length} formulas available</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="window.injectImportFormulaModal_v13(); openModal('importFormulaModal_v13')" class="px-4 py-2 bg-indigo-600 text-white rounded-lg shadow hover:bg-indigo-700 font-bold flex items-center gap-2 transition-transform hover:scale-105">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4 4m0 0L8 8m4-4v12"></path></svg>
                        Import CSV
                    </button>
                    <button onclick="if(window.openFormulaModal) openFormulaModal()" class="px-4 py-2 bg-teal-600 text-white rounded-lg shadow hover:bg-teal-700 font-bold flex items-center gap-2 transition-transform hover:scale-105">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                        New Formula
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                ${(appState.formulas || []).map(f => `
                <div class="bg-white p-6 rounded-xl shadow border border-gray-100 hover:shadow-lg transition-shadow relative group">
                    <div class="absolute top-4 right-4 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button onclick="duplicateFormula('${f.id}')" class="p-2 bg-blue-100 text-blue-600 rounded hover:bg-blue-200" title="Duplicate">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                        </button>
                        <button onclick="editFormula('${f.id}')" class="p-2 bg-gray-100 text-gray-600 rounded hover:bg-gray-200" title="Edit">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                        </button>
                        <button onclick="deleteFormula('${f.id}')" class="p-2 bg-red-100 text-red-600 rounded hover:bg-red-200" title="Delete">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>

                    <h3 class="font-bold text-xl text-gray-800 mb-1">${f.name}</h3>
                    <p class="text-sm text-gray-500 mb-4">Output: ${f.outputQty || '-'} ${f.outputUnit || ''}</p>
                    
                    <div class="space-y-3">
                        <div class="text-sm">
                            <p class="font-bold text-gray-400 text-xs uppercase">Summary</p>
                            <p class="text-gray-600">${(f.ingredients || []).length} Raw Materials</p>
                            <p class="text-gray-600">${(f.packingMaterials || []).length} Packing Materials</p>
                        </div>
                    </div>
                </div>
                `).join('')}

                ${(!appState.formulas || appState.formulas.length === 0) ? `
                <div class="col-span-full border-2 border-dashed border-gray-300 rounded-xl p-10 flex flex-col items-center justify-center text-gray-400">
                    <svg class="w-16 h-16 mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547a2 2 0 00-.547 1.806l.477 2.387a6 6 0 00.517 3.86l.158.318a6 6 0 003.86.517l2.387.477a2 2 0 001.806-.547a2 2 0 00.547-1.806l-.477-2.387a6 6 0 00-.517-3.86l-.158-.318a6 6 0 01-.517-3.86l2.387-.477a2 2 0 001.022-.547z"></path></svg>
                    <p class="text-lg font-medium">No formulas yet.</p>
                    <button onclick="window.injectImportFormulaModal_v13(); openModal('importFormulaModal_v13')" class="mt-4 text-indigo-600 hover:underline">Import from CSV</button>
                </div>
                ` : ''}
            </div>
        </div>`;
        };

        // Replace Form Listener
        setTimeout(() => {
            const fForm = document.getElementById('formula-form');
            if (fForm) {
                const newForm = fForm.cloneNode(true);
                fForm.parentNode.replaceChild(newForm, fForm);

                newForm.addEventListener('submit', function (e) {
                    e.preventDefault();
                    const id = document.getElementById('edit-formula-id').value;
                    const name = document.getElementById('formula-name').value;
                    const outQty = parseFloat(document.getElementById('formula-output-qty').value);
                    const outUnit = document.getElementById('formula-output-unit').value;

                    if (!name || isNaN(outQty)) { alert("Please enter valid name and output quantity"); return; }

                    const harvest = (containerId) => {
                        const list = [];
                        const rows = document.getElementById(containerId).querySelectorAll('.flex');
                        rows.forEach(r => {
                            const sel = r.querySelector('select');
                            const inp = r.querySelector('input');
                            if (sel && inp && sel.value && inp.value) {
                                list.push({ itemId: parseFloat(sel.value) || sel.value, quantity: parseFloat(inp.value) });
                            }
                        });
                        return list;
                    };

                    const ingredients = harvest('ingredients-container');
                    const packing = harvest('packing-container');
                    const labels = harvest('labels-container');

                    if (id) {
                        const f = appState.formulas.find(x => x.id == id);
                        if (f) {
                            f.name = name;
                            f.outputQty = outQty;
                            f.outputUnit = outUnit;
                            f.ingredients = ingredients;
                            f.packingMaterials = packing;
                            f.labels = labels;
                        }
                    } else {
                        const newF = {
                            id: Date.now() + Math.random().toString(36).substr(2, 5),
                            name: name,
                            outputQty: outQty,
                            outputUnit: outUnit,
                            ingredients: ingredients,
                            packingMaterials: packing,
                            labels: labels
                        };
                        if (!appState.formulas) appState.formulas = [];
                        appState.formulas.push(newF);
                    }

                    saveState();
                    closeModal('formulaModal');
                    if (window.renderFormulationsView) renderFormulationsView();
                    if (window.showToast) showToast("Formula Saved!");
                });
                console.log("ANTIGRAVITY: Formula Form Handler attached.");
            }
        }, 1000);

        // Auto-Init
        window.injectImportFormulaModal_v13();

        console.log("ANTIGRAVITY: Feature Pack V13 (Namespace Fix) Applied.");
    </script>
    <!-- ANTIGRAVITY: FINAL FEATURE LOCKDOWN (NEUTRALIZE REMOVED FEATURES) -->
    <script>
        (function () {
            const disabledMsg = "This feature is no longer available.";

            // 1. Disable Activity Log / Audit Log
            window.logActivity = function () { console.log("Audit log disabled."); };
            window.logAudit = function () { console.log("Audit log disabled."); };
            window.renderAuditLogView = function () {
                const containers = ['activity-log-view', 'audit-log-view'];
                containers.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.innerHTML = `<div class="p-8 text-center text-gray-500">${disabledMsg}</div>`;
                });
            };
            window.clearActivityLog = function () { console.log("Audit log disabled."); };
            window.exportActivityLogCSV = function () { alert(disabledMsg); };

            // 2. Disable Product Traceability (REMOVED - Restored by user request)
            // We keep this block commented out or removed so V30 functions work.

            // 3. Clean up sidebar (Safety Check)
            function cleanupSidebar() {
                const links = document.querySelectorAll('.sidebar-link, a');
                links.forEach(link => {
                    const text = link.textContent.trim().toLowerCase();
                    // Only hide Activity Log, keep Traceability hooks visible
                    if (text === "activity log" || text.includes("activity log")) {
                        link.style.display = 'none';
                    }
                });
            }

            // Run cleanup on load and periodically
            if (document.readyState === 'complete') {
                cleanupSidebar();
            } else {
                window.addEventListener('load', cleanupSidebar);
            }
            setInterval(cleanupSidebar, 2000);

            console.log("ANTIGRAVITY: Removed features (Activity Log, Product Trace) have been fully neutralized.");
        })();
    </script>
</body>

</html>
